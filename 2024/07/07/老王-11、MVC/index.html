<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Kilgour Notes | Kilgour Notes</title><meta name="author" content="kilgour"><meta name="copyright" content="kilgour"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="一、Web应用工作方式1、名词解释  什么是客户端？   什么是服务器？（IIS） Asp.net Core中的Web服务器实现: 123https:&#x2F;&#x2F;learn.microsoft.com&#x2F;zh-CN&#x2F;aspnet&#x2F;core&#x2F;fundamentals&#x2F;servers&#x2F;?view&#x3D;aspnetcore-7.0&amp;tabs&#x3D;windows#kestrel-vs-httpsyshttps:&#x2F;&#x2F;">
<meta property="og:type" content="article">
<meta property="og:title" content="Kilgour Notes">
<meta property="og:url" content="http://www.kilgour.top/2024/07/07/%E8%80%81%E7%8E%8B-11%E3%80%81MVC/index.html">
<meta property="og:site_name" content="Kilgour Notes">
<meta property="og:description" content="一、Web应用工作方式1、名词解释  什么是客户端？   什么是服务器？（IIS） Asp.net Core中的Web服务器实现: 123https:&#x2F;&#x2F;learn.microsoft.com&#x2F;zh-CN&#x2F;aspnet&#x2F;core&#x2F;fundamentals&#x2F;servers&#x2F;?view&#x3D;aspnetcore-7.0&amp;tabs&#x3D;windows#kestrel-vs-httpsyshttps:&#x2F;&#x2F;">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/kilg0ur/picture/master/picture/cover6.jpg">
<meta property="article:published_time" content="2024-07-07T14:48:53.352Z">
<meta property="article:modified_time" content="2024-08-13T12:46:33.551Z">
<meta property="article:author" content="kilgour">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/kilg0ur/picture/master/picture/cover6.jpg"><link rel="shortcut icon" href="https://raw.githubusercontent.com/kilg0ur/picture/master/picture/logo.png"><link rel="canonical" href="http://www.kilgour.top/2024/07/07/%E8%80%81%E7%8E%8B-11%E3%80%81MVC/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":230},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"top-right"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Kilgour Notes',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-08-13 20:46:33'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/panarama.css" media="defer" onload="this.media='all'"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-footer-beautify@1.0.0/lib/runtime.css" media="print" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/5.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">35</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 列表</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> 图库</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://raw.githubusercontent.com/kilg0ur/picture/master/picture/cover6.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="Kilgour Notes"><img class="site-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/kilg0ur/picture/master/picture/logo.png"/><span class="site-name">Kilgour Notes</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 列表</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> 图库</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">无题</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-07-07T14:48:53.352Z" title="发表于 2024-07-07 22:48:53">2024-07-07</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-08-13T12:46:33.551Z" title="更新于 2024-08-13 20:46:33">2024-08-13</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">55.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>226分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="一、Web应用工作方式"><a href="#一、Web应用工作方式" class="headerlink" title="一、Web应用工作方式"></a>一、<code>Web</code>应用工作方式</h1><h2 id="1、名词解释"><a href="#1、名词解释" class="headerlink" title="1、名词解释"></a>1、名词解释</h2><p>  什么是客户端？</p>
<p>  什么是服务器？（<code>IIS</code>）</p>
<p><code>Asp.net Core</code>中的<code>Web</code>服务器实现:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https://learn.microsoft.com/zh-CN/aspnet/core/fundamentals/servers/?view=aspnetcore-7.0&amp;tabs=windows#kestrel-vs-httpsys</span><br><span class="line"></span><br><span class="line">https://learn.microsoft.com/zh-cn/aspnet/core/fundamentals/servers/?view=aspnetcore-7.0&amp;source=recommendations&amp;tabs=windows</span><br></pre></td></tr></table></figure>

<p><code>B/S</code>  Browser   Server  IIS </p>
<p><code>c/s</code></p>
<p>画图解释浏览器与服务器工作基本流程</p>
<p>浏览器向服务器发送数据，叫做请求</p>
<p>服务器向浏览器返回处理的结果，叫做响应</p>
<p><code>MVC</code>不是三层</p>
<h1 id="二、MVC环境搭建"><a href="#二、MVC环境搭建" class="headerlink" title="二、MVC环境搭建"></a>二、<code>MVC</code>环境搭建</h1><h2 id="1、什么是MVC"><a href="#1、什么是MVC" class="headerlink" title="1、什么是MVC"></a>1、什么是<code>MVC</code></h2><p>Model   <code>ViewModel</code>   </p>
<p>View   视图 页面</p>
<p>Controller ：控制器 定义方法  接收用户请求，对请求的数据做判断处理。</p>
<h2 id="2、项目创建"><a href="#2、项目创建" class="headerlink" title="2、项目创建"></a>2、项目创建</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Microsoft.NetCore.App: .net Core的基础框架，包含了对代码编译运行的处理</span><br><span class="line">Microsoft.AspNetCore.App:基于上面的基础框架，包含了认证，授权服务，http的请求处理，文件访问，日志记录，依赖注入</span><br></pre></td></tr></table></figure>



<h3 id="2-1-控制器访问"><a href="#2-1-控制器访问" class="headerlink" title="2.1  控制器访问"></a>2.1  控制器访问</h3><p>在<code>Visual Studio</code>中创建项目的时候，我们选择的是<code>Asp.net core 空</code>这个项目，我们自己来搭建整个<code>MVC</code>环境。在创建项目的时候可以先不选择任何的选项。</p>
<p>后面可以选择<code>Asp.net Core Web应用(模型-控制器-视图)</code>，如果选择了该项目，<code>MVC</code>的环境已经创建好了。</p>
<p>创建好一个空的项目后，先来看一下<code>Properties</code>目录下的<code>launchSettings.json</code>文件，该文件中配置的是在开发环境中启动项目的方式，为应用的启动做一些准备工作。</p>
<p>我们可以看出该配置文件默认添加了两个节点，其中<code>iisSettings</code>用于设置<code>IIS</code>相关的选项，而“<code>profiles</code>”节点定义了一系列用于表示应用启动场景的（包括了应用程序启动的方式，<code>URL</code>等）。初始的<code>launchSettings.json</code>文件会默认创建两个<code>Profile</code>，一个被命名为<code>IIS Express</code>，另一个则使用<code>http</code>来命名。这两个节点分别对应<code>Visual Stuido</code>的开始调试按钮的下拉选项，您可以选择对应的选项来启动应用程序。</p>
<p><strong><code>iisSettings是IIS的配置</code></strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> `windowsAuthentication`:  `IIS是否启用 Windows 身份验证`</span><br><span class="line"> anonymousAuthentication：IIS是否启用匿名身份验证</span><br><span class="line">applicationUrl：指定 IIS 服务器的地址</span><br><span class="line">sslPort：指定IIS 服务器的https端口 </span><br></pre></td></tr></table></figure>

<p><strong><code>profiles</code>中的<code>IIS Express</code>配置和<code>http</code>配置</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">launchBrowser： 一个布尔类型的开关，表示应用程序的时候是否自动启动浏览器</span><br><span class="line">applicationUrl：如果launchBrowser被设置为true，浏览器采用的初始化路径通过该属性进行设置。</span><br><span class="line">environmentVariables：该属性用来设置环境变量。ASP.NET Core应用中正是利用这样一个环境变量来表示当前的部署环境。多环境的配置可以通过ASPNETCORE_ENVIRONMENT切换。</span><br><span class="line">commandName：启动当前应用程序的命令类型，有效的选项包括IIS、IISExpress和Project，前三个选项分别表示采用IIS、IISExpress和指定的可执行文件（.exe）来启动应用程序（内置的 Kestrel 服务器来运行，Kestrel是ASP.NET Core的跨平台Web服务器）</span><br><span class="line">dotnetRunMessages:它是一个布尔值，是否在运行时给予反馈信息</span><br></pre></td></tr></table></figure>

<p>下面创建<code>Controllers</code>目录，控制器都放在该下面，同时控制器的名字以<code>Controller</code>结尾。这是微软提出的约定大于配置。</p>
<p>这里我们创建了<code>HomeController</code>控制器，该控制器就是一个类，继承了<code>Controller</code></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">HomeController</span> : <span class="title">Controller</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Index</span>()</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="comment">/* return View();*/</span></span><br><span class="line">           <span class="keyword">return</span> <span class="string">&quot;ni hao&quot;</span>;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>这里我们对<code>Index</code>方法做了简单的修改，让其返回一个字符串</p>
<p>问题：怎样访问呢？</p>
<p><code>HomeController</code>是一个类，而<code>Index</code>是其内部的方法。要想访问<code>Index</code>这个方法，需要创建<code>HomeController</code>类的对象。</p>
<p>这里需要配置一个服务，让<code>MVC</code>框架帮助我们创建控制器对象。</p>
<p>同时，还需要根据用户在浏览器中输入的地址，映射到特定的控制器和方法中。这就是路由。</p>
<p>修改<code>Program.cs</code></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> builder = WebApplication.CreateBuilder(args);</span><br><span class="line">builder.Services.AddControllers(); <span class="comment">// 这里需要配置一个服务，让`MVC`框架帮助我们创建控制器对象。</span></span><br><span class="line"><span class="keyword">var</span> app = builder.Build();</span><br><span class="line"></span><br><span class="line"><span class="comment">/*app.MapGet(&quot;/&quot;, () =&gt; &quot;Hello World!&quot;);*/</span></span><br><span class="line">app.UseRouting(); <span class="comment">// 使用路由（路由中间件，后面讲解中间件）</span></span><br><span class="line"><span class="comment">// 配置路由规则</span></span><br><span class="line">app.MapControllerRoute(</span><br><span class="line">    name: <span class="string">&quot;default&quot;</span>, <span class="comment">// 名称</span></span><br><span class="line">    pattern: <span class="string">&quot;&#123;controller=Home&#125;/&#123;action=Index&#125;/&#123;id?&#125;&quot;</span>); <span class="comment">// 默认访问Home控制器下的`Index`方法，id参数可以不用添加。</span></span><br><span class="line">app.Run();</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>定义的路由规则：<code>controller(控制器名)/action(方法名)</code></p>
<p><code>http://localhost:5099/</code> 访问的就是<code>Home</code>控制器下的<code>Index</code>方法。也可以在地址栏中输入完整的地址。</p>
<p><code>http://localhost:5099/home/index</code></p>
<p>在<code>Home</code>控制器再创建一个方法<code>About</code></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">About</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;About&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>怎样访问呢？<code>http://localhost:5099/home/about</code></p>
<p>因为这里的地址符合路由规则。</p>
<h3 id="2-2-视图创建"><a href="#2-2-视图创建" class="headerlink" title="2.2  视图创建"></a>2.2  视图创建</h3><p>视图就是用来展示具体的内容的页面。</p>
<p>视图的创建要求：视图文件必须放在名称是<code>Views</code>文件夹下的名称为控制器名称的文件夹中。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">HomeController</span> : <span class="title">Controller</span></span><br><span class="line">    &#123;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Index</span>()</span></span><br><span class="line">        &#123; </span><br><span class="line">            <span class="keyword">return</span> View();</span><br><span class="line">        &#125;  </span><br><span class="line">       <span class="comment">/* public string Index()</span></span><br><span class="line"><span class="comment">        &#123;</span></span><br><span class="line"><span class="comment">            */</span><span class="comment">/* return View();*/</span><span class="comment">/*</span></span><br><span class="line"><span class="comment">            return &quot;nihao&quot;;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        public string About()</span></span><br><span class="line"><span class="comment">        &#123;</span></span><br><span class="line"><span class="comment">            return &quot;About&quot;;</span></span><br><span class="line"><span class="comment">        &#125;*/</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这里我们修改了代码，让<code>Index</code>返回的是一个<code>View</code>方法的结果，表示就是返回的是一个视图。</p>
<p><code>View</code>方法转到定义，看到定义方式如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> ViewResult <span class="title">View</span>()</span>;</span><br></pre></td></tr></table></figure>

<p>该方法，返回类是<code>ViewResult</code>,而<code>ViewResult</code>继承了<code>ActionResult</code>,而<code>ActionResult</code>实现了<code>IActionResult</code>。</p>
<p>所以<code>Index</code>方法的类型就是<code>IActionResult</code>.</p>
<p>接下来创建<code>Index</code>方法对应的视图文件。</p>
<p>在项目中创建<code>Views</code>文件夹（名称一定要叫做<code>Views</code>）,在该文件夹下创建与控制器名称相同的文件夹也就是<code>Home</code>文件夹，在<code>Home</code>文件夹下面<code>Index.cshtml</code>视图文件，该视图文件的名称要与<code>Index</code>方法的名称保持一致(这也是一种约定大于配置)、</p>
<p>在<code>Index.cshtml</code>视图文件中创建基本的<code>html</code>结构，如下所示：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">title</span>&gt;</span>首页<span class="tag">&lt;/<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        这是首页</span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>下面运行一下程序，发现出错了。原因是，我们现在只是让<code>MVC</code>框架帮我们创建了控制器对象，而没有创建视图对象。</p>
<p>现在<code>Index</code>方法返回的就是一个视图，视图也是一个对象，也需要创建。</p>
<p>所以修改<code>Program.cs</code>文件中的代码，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> builder = WebApplication.CreateBuilder(args);</span><br><span class="line">builder.Services.AddControllers();</span><br><span class="line">builder.Services.AddRazorPages(); <span class="comment">// 配置视图服务，让MVC框架帮我们创建视图对象</span></span><br><span class="line"><span class="keyword">var</span> app = builder.Build();</span><br><span class="line"></span><br><span class="line"><span class="comment">/*app.MapGet(&quot;/&quot;, () =&gt; &quot;Hello World!&quot;);*/</span></span><br><span class="line">app.UseRouting();</span><br><span class="line">app.MapControllerRoute(</span><br><span class="line">    name: <span class="string">&quot;default&quot;</span>,</span><br><span class="line">    pattern: <span class="string">&quot;&#123;controller=Home&#125;/&#123;action=Index&#125;/&#123;id?&#125;&quot;</span>);</span><br><span class="line">app.Run();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在上面的配置中，完成了视图对象的创建，下面运行程序，发现没有问题了。</p>
<p>或者采用如下配置</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> builder = WebApplication.CreateBuilder(args);</span><br><span class="line"><span class="comment">/*builder.Services.AddControllers();</span></span><br><span class="line"><span class="comment">builder.Services.AddRazorPages();*/</span></span><br><span class="line">builder.Services.AddControllersWithViews();  <span class="comment">// 配置了控制器与视图服务</span></span><br></pre></td></tr></table></figure>

<p>在上面的代码中，我们直接调用了<code>AddControllersWithViews</code> 方法，同时完成了控制器对象与视图对象的创建。</p>
<p>下面，我们在<code>Home</code>控制器中再创建一个<code>About</code>方法,然后再创建对应的视图</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">Index</span>()</span></span><br><span class="line">       &#123; </span><br><span class="line">           <span class="keyword">return</span> View();</span><br><span class="line">       &#125;  </span><br><span class="line">       <span class="function"><span class="keyword">public</span> IActionResult <span class="title">About</span>()</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">return</span> View();</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>在<code>Views/Home</code>文件夹下面创建<code>About.cshtml</code>视图文件，该文件中的<code>html</code>代码，如下所示：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span></span><br><span class="line">    About页面</span><br><span class="line"><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>运行程序，在浏览器的地址栏中输入<code>http://localhost:5099/home/about</code></p>
<p>在浏览器中会展示出<code>About</code>视图中的内容。</p>
<p>下面，我们再来创建一个新的控制器</p>
<p>在<code>Controllers</code>文件夹下面创建<code>UserInfoController.cs</code>这个控制器</p>
<p>针对该控制器中的<code>Index</code>方法创建视图。</p>
<p>在<code>Views</code>目录下面创建<code>UserInfo</code>文件夹，该该文件夹下面创建<code>Index.cshtml</code>视图文件，该文件中的<code>html</code>代码</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>用户管理页面<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>下面运行程序</p>
<p>输入地址<code>http://localhost:5099/UserInfo</code>来进行访问，这里只输入了控制器的名字，没有输入所要访问的方法名字，但是在路由规则的配置中，我们指定的默认方法名是<code>Index</code>，所以这里会默认访问<code>UserInfo</code>控制器下的<code>Index</code>方法。</p>
<h3 id="2-3-公共视图"><a href="#2-3-公共视图" class="headerlink" title="2.3  公共视图"></a>2.3  公共视图</h3><p>我们在开发网页的时候，会遇到在任何一个页面中都需要的公共内容，这块内容可以放在<code>_ViewStart.cshtml</code>这个视图文件中</p>
<p>我们可以在<code>Views</code>目录下面创建一个<code>_ViewStart.cshtml</code>文件(注意：该文件的名称是固定的)。</p>
<p>当访问其它视图文件的时候，都会加载<code>_ViewStart.cshtml</code>文件。</p>
<p>在<code>_ViewStart.cshtml</code>文件中添加如下内容：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>ViewStart页面<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>当在浏览器的地址栏中，输入任何的地址访问控制器下的某个方法对应的视图的时候，都会加载<code>_ViewStart.cshtml</code>这个视图文件中的内容。所以<code>_ViewStart.cshtml</code>这个文件它的作用范围是对整个<code>Views</code>文件夹下的视图起作用的。</p>
<p><strong>同时，<code>_ViewStart.cshtml</code>文件会在所有其它视图文件被执行之前执行</strong></p>
<h3 id="2-4-布局视图"><a href="#2-4-布局视图" class="headerlink" title="2.4 布局视图"></a>2.4 布局视图</h3><p>我们在做网站的时候，有些页面中的布局是一样的，例如顶部的导航栏，底部的版权信息等。</p>
<p>这些内容布局都是一样的，所以可以放在<code>布局视图</code>中。</p>
<p>注意：这里体会一下与<code>_ViewStart.cshtml</code>文件应用场景的不同，<code>_ViewStart.cshtml</code>文件中的内容会被所有视图文件加载。</p>
<p>但是布局视图，只是需要到一些公共布局的视图文件才加载，如果你创建的一个文件不需要公共布局，例如不需要导航栏，不需要版权信息等，就可以不用加载布局视图。</p>
<p>我们在<code>Views</code>目录下面创建一个<code>Shared</code>文件夹，在该文件夹下右击，选择【添加–新建项】，选择<code>Razor布局</code>,文件名称叫做<code>_Layout.cshtml</code>，不要修改。</p>
<p>该文件中的默认代码，如下所示：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>@ViewBag.Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        @RenderBody()</span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们可以看到，在<code>html</code>文档中可以写<code>c#</code>代码，这就是<code>Razor</code>视图引擎，也就是借助于该引擎，可以实现在<code>html</code>文件中写<code>C#</code>代码</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>导航页面<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">        @RenderBody()</span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里我们添加了一个标题，相当于导航页面。</p>
<p>现在想在<code>Home</code>控制器下的<code>Index</code>方法中对应的<code>Index</code>视图中使用该布局视图。</p>
<p><code>Views/Home/Index.cshtml</code>文件中添加如下代码：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@&#123;</span><br><span class="line">    Layout = &quot;~/Views/Shared/_Layout.cshtml&quot;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">title</span>&gt;</span>首页<span class="tag">&lt;/<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">   </span><br><span class="line">        这是首页</span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>通过<code>Layout</code>这个属性指定了所使用的布局页面的路径。</p>
<p>问题：假如我们网站中所有页面都需要使用上面定义的布局页面，如果采用上面的使用方式，需要再每个视图文件中进行添加比较麻烦。</p>
<p>我们可以在<code>_ViewStart.cshtml</code>中使用<code>Layout</code>，因为<code>_ViewStart.cshtml</code>文件在我们访问任何视图的时候，都会加载。</p>
<p><code>_ViewStart.cshtml</code>文件中的代码修改如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@&#123;</span><br><span class="line">    Layout = &quot;~/Views/Shared/_Layout.cshtml&quot;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>ViewStart页面<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以看到任何一个视图页面都添加了布局页面。</p>
<p>问题：如果<code>UserInfo</code>控制器中的<code>Index</code>方法对应的<code>Index.cshtml</code>视图文件不需要布局视图了，应该怎样处理呢?</p>
<p>修改<code>Views/UserInfo/Index.cshtml</code>文件中的代码：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@&#123;</span><br><span class="line">    Layout = null;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>用户管理页面<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>将<code>Layout</code>赋值为<code>null</code>.</p>
<p><code>http://localhost:5099/userInfo</code></p>
<p>展示的内容中没有布局视图中的内容了。</p>
<h3 id="2-5-视图导入"><a href="#2-5-视图导入" class="headerlink" title="2.5 视图导入"></a>2.5 视图导入</h3><p>我们在<code>Razor</code>视图中可以写<code>c#</code>代码，在使用一些类创建对象的时候，我们需要导入类所在的命名空间。</p>
<p>如果有一些类是经常使用的，这样在每个视图文件中都导入命名空间，这种写法就比较复杂了。</p>
<p>所以，我们可以将公共的命名空间写到<code>_ViewImports.cshtml</code>文件中，这个文件就是视图导入文件。</p>
<p>该文件也是要放在<code>Views</code>目录下面的，并且文件名是不能修改的。</p>
<p>选中<code>Views</code>目录，右击，在弹出的快捷菜单中选择<code>添加--新建项</code>，在弹出的窗口中搜索<code>导入</code>，就可以搜索到<code>Razor视图导入</code>这一项。</p>
<p>这时候，就会在<code>Views</code>目录下面创建<code>_ViewImports.cshtml</code>这个文件。</p>
<p>下面进行测试</p>
<p>新创建一个类库项目<code>Common</code>,在该类库项目中创建一个类<code>Until</code>类。在该类下面创建一个<code>Test</code>方法。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Until</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Test</span>()</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="string">&quot;Test&quot;</span>;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>在创建的<code>MVC</code>项目中引入上面创建的<code>Common</code>类库。</p>
<p>在<code>Views/UserInfo/Index.cshtml</code>文件中可以调用<code>Test</code>方法，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@&#123;</span><br><span class="line">    Layout = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line">@using Common</span><br><span class="line">@&#123;</span><br><span class="line">    Until u = <span class="keyword">new</span> Until();</span><br><span class="line">   </span><br><span class="line">&#125;</span><br><span class="line">&lt;h1&gt;用户管理页面:@u.Test()&lt;/h1&gt;</span><br></pre></td></tr></table></figure>

<p>这里导入了<code>Common</code>这个命名空间，然后创建了<code>Until</code>对象，下面调用该对象中的<code>Test</code>方法，打印该方法的返回值。</p>
<p><code>@&#123; &#125;</code>表示的是一个代码段。</p>
<p><code>@</code>：表示的是直接输出对应的内容。</p>
<p><code>Razor</code>语法:<code>https://learn.microsoft.com/zh-cn/aspnet/web-pages/overview/getting-started/introducing-razor-syntax-c</code></p>
<p><code>后面还会介绍Razor</code>语法。</p>
<p>运行程序发现没有问题。如果在其他视图中调用<code>Test</code>方法，也需要导入命名空间，比较麻烦。</p>
<p>这里，我们把导入命名空间的代码写到<code>_ViewImports.cshtml</code>文件中。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@using Common</span><br></pre></td></tr></table></figure>

<p><code>Views/UserInfo/Index.cshtml</code>文件中,不需要导入命名空间了，程序并没有出错。</p>
<p>在其他视图中也不需要导入<code>Common</code>命名空间，直接创建<code>Until</code>对象，调用<code>Test</code>方法。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@&#123;</span><br><span class="line">    Until u = <span class="keyword">new</span> Until();</span><br><span class="line">&#125;</span><br><span class="line">&lt;h1&gt;</span><br><span class="line">    About页面 @u.Test()</span><br><span class="line">&lt;/h1&gt;</span><br></pre></td></tr></table></figure>

<h3 id="2-6-模型创建"><a href="#2-6-模型创建" class="headerlink" title="2.6 模型创建"></a>2.6 模型创建</h3><p>在<code>MVC</code>中<code>Model</code>模型表示的就是视图要展示的数据，所以我们一般也叫做<code>ViewModel</code>.</p>
<p>在<code>MVC</code>中创建<code>Models</code>文件夹，在该文件夹下面创建一个<code>UserInfo.cs</code>类</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserInfo</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">int</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">string</span>? Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">string</span>? Email &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>在控制器对应的方法中，就可以使用使用上面定义的<code>UserInfo</code>类了。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserInfoController</span> : <span class="title">Controller</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Index</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            UserInfo userInfo = <span class="keyword">new</span> UserInfo &#123; Id = <span class="number">1</span>, Name = <span class="string">&quot;张三&quot;</span>, Email = <span class="string">&quot;zhangsan@126.com&quot;</span> &#125;;</span><br><span class="line">            <span class="keyword">return</span> View();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>问题：怎样将数据返回给视图进行展示呢？</p>
<p>我们后面进行讲解。</p>
<h3 id="2-7-Action方法"><a href="#2-7-Action方法" class="headerlink" title="2.7 Action方法"></a>2.7 <code>Action</code>方法</h3><p>控制器中的方法返回的类型是<code>IActionResult</code>，是一个接口。对应的有很多的类实现了该接口。</p>
<p>默认的<code>View方法</code>对应的类型是<code>ViewResult</code>，它最终实现了<code>IActionResult</code>接口。</p>
<p><code>ViewResult</code>表示返回的是一个视图。除了返回视图，还可以返回什么类型的内容。	</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/kilg0ur/picture/master/picture/202407131617066.png"></p>
<p>以上是最常用的，其实<code>Asp.net core MVC</code>中支持的有十几中返回的类型。</p>
<p>下面看一下<code>RedirectToActionResult</code></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">Details</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="comment">//  return RedirectToAction(&quot;Index&quot;); // 跳转到当前控制器下的Index方法</span></span><br><span class="line">       	 <span class="keyword">return</span> RedirectToAction(<span class="string">&quot;Index&quot;</span>,<span class="string">&quot;Home&quot;</span>); <span class="comment">// 跳转到Home控制器下的`Index`方法</span></span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>输入地址<code>http://localhost:5099/userInfo/details</code>进行测试。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">Details</span>()</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="comment">/* return RedirectToAction(&quot;Index&quot;,&quot;Home&quot;);*/</span></span><br><span class="line">           <span class="keyword">return</span> Redirect(<span class="string">&quot;/home/index&quot;</span>);</span><br><span class="line"></span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>上面通过<code>Redirect</code>方法进行跳转，指定跳转到的路径。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">Details</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/* return RedirectToAction(&quot;Index&quot;,&quot;Home&quot;);*/</span></span><br><span class="line">            <span class="comment">/*return Redirect(&quot;/home/index&quot;);*/</span></span><br><span class="line">            List&lt;UserInfo&gt; users = <span class="keyword">new</span> List&lt;UserInfo&gt; </span><br><span class="line">            &#123;</span><br><span class="line">               <span class="keyword">new</span> UserInfo()&#123;</span><br><span class="line">                   Id = <span class="number">1</span>,</span><br><span class="line">                Name = <span class="string">&quot;张三&quot;</span>,</span><br><span class="line">                Email = <span class="string">&quot;zhangsan@126.com&quot;</span>&#125;,</span><br><span class="line">               <span class="keyword">new</span> UserInfo()</span><br><span class="line">               &#123;</span><br><span class="line">                    Id = <span class="number">2</span>,</span><br><span class="line">                Name = <span class="string">&quot;李四&quot;</span>,</span><br><span class="line">                Email = <span class="string">&quot;lisi@126.com&quot;</span></span><br><span class="line">               &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">return</span> Json(users);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>输入地址<code>http://localhost:5099/userInfo/details</code>进行测试。</p>
<p>这里可以安装一个浏览器的插件<code>jsonview插件</code>，方便在浏览器中查看<code>json</code>格式。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">Details</span>()</span></span><br><span class="line">      &#123;</span><br><span class="line">          <span class="comment">/* return RedirectToAction(&quot;Index&quot;,&quot;Home&quot;);*/</span></span><br><span class="line">          <span class="comment">/*return Redirect(&quot;/home/index&quot;);*/</span></span><br><span class="line">          <span class="comment">/* List&lt;UserInfo&gt; users = new List&lt;UserInfo&gt; </span></span><br><span class="line"><span class="comment">           &#123;</span></span><br><span class="line"><span class="comment">              new UserInfo()&#123;</span></span><br><span class="line"><span class="comment">                  Id = 1,</span></span><br><span class="line"><span class="comment">               Name = &quot;张三&quot;,</span></span><br><span class="line"><span class="comment">               Email = &quot;zhangsan@126.com&quot;&#125;,</span></span><br><span class="line"><span class="comment">              new UserInfo()</span></span><br><span class="line"><span class="comment">              &#123;</span></span><br><span class="line"><span class="comment">                   Id = 2,</span></span><br><span class="line"><span class="comment">               Name = &quot;李四&quot;,</span></span><br><span class="line"><span class="comment">               Email = &quot;lisi@126.com&quot;</span></span><br><span class="line"><span class="comment">              &#125;</span></span><br><span class="line"><span class="comment">           &#125;;</span></span><br><span class="line"><span class="comment">           return Json(users);*/</span></span><br><span class="line">          <span class="keyword">return</span> Content(<span class="string">&quot;hello world&quot;</span>); <span class="comment">// 返回一个字符串</span></span><br><span class="line"></span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">Details</span>()</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="comment">/* return RedirectToAction(&quot;Index&quot;,&quot;Home&quot;);*/</span></span><br><span class="line">           <span class="comment">/*return Redirect(&quot;/home/index&quot;);*/</span></span><br><span class="line">           <span class="comment">/* List&lt;UserInfo&gt; users = new List&lt;UserInfo&gt; </span></span><br><span class="line"><span class="comment">            &#123;</span></span><br><span class="line"><span class="comment">               new UserInfo()&#123;</span></span><br><span class="line"><span class="comment">                   Id = 1,</span></span><br><span class="line"><span class="comment">                Name = &quot;张三&quot;,</span></span><br><span class="line"><span class="comment">                Email = &quot;zhangsan@126.com&quot;&#125;,</span></span><br><span class="line"><span class="comment">               new UserInfo()</span></span><br><span class="line"><span class="comment">               &#123;</span></span><br><span class="line"><span class="comment">                    Id = 2,</span></span><br><span class="line"><span class="comment">                Name = &quot;李四&quot;,</span></span><br><span class="line"><span class="comment">                Email = &quot;lisi@126.com&quot;</span></span><br><span class="line"><span class="comment">               &#125;</span></span><br><span class="line"><span class="comment">            &#125;;</span></span><br><span class="line"><span class="comment">            return Json(users);*/</span></span><br><span class="line">           <span class="comment">/*  return Content(&quot;hello world&quot;);*/</span></span><br><span class="line">           <span class="keyword">var</span> stream = <span class="keyword">new</span> MemoryStream(Encoding.ASCII.GetBytes(<span class="string">&quot;Hello World&quot;</span>));</span><br><span class="line">    <span class="comment">// 通过文件流下载</span></span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">new</span> FileStreamResult(stream, <span class="keyword">new</span> MediaTypeHeaderValue(<span class="string">&quot;text/plain&quot;</span>))</span><br><span class="line">           &#123;</span><br><span class="line">               FileDownloadName = <span class="string">&quot;test.txt&quot;</span> <span class="comment">// 下载后文件的名称</span></span><br><span class="line">           &#125;;</span><br><span class="line"></span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p><code>MediaTypeHeaderValue</code>指定下载文件的类型。注意该类的命名空间：<code>using Microsoft.Net.Http.Headers;</code></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> FileResult <span class="title">DownloadFile</span>()</span>  </span><br><span class="line">&#123;  </span><br><span class="line">     <span class="keyword">return</span> File(<span class="string">&quot;/Files/File Result.pdf&quot;</span>, <span class="string">&quot;text/plain&quot;</span>, <span class="string">&quot;File Result.pdf&quot;</span>);  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> FileContentResult <span class="title">DownloadContent</span>()</span>  </span><br><span class="line">&#123;  </span><br><span class="line">            <span class="keyword">var</span> myfile = System.IO.File.ReadAllBytes(<span class="string">&quot;wwwroot/Files/FileContentResult.pdf&quot;</span>);  </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> FileContentResult(myfile, <span class="string">&quot;application/pdf&quot;</span>);  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<h3 id="2-8-Razor视图"><a href="#2-8-Razor视图" class="headerlink" title="2.8 Razor视图"></a>2.8 <code>Razor</code>视图</h3><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;h1&gt;</span><br><span class="line">    @&#123;</span><br><span class="line">        <span class="keyword">var</span> i = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">var</span> j = <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">var</span> sum = i + j;</span><br><span class="line">        @sum</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/h1&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@&#123;</span><br><span class="line">       List&lt;<span class="built_in">string</span>&gt; list = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line">       list.Add(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">       list.Add(<span class="string">&quot;abc&quot;</span>);</span><br><span class="line">       list.Add(<span class="string">&quot;ddd&quot;</span>);</span><br><span class="line">      </span><br><span class="line">   &#125;</span><br><span class="line">   &lt;ul&gt;</span><br><span class="line">           </span><br><span class="line">       @foreach(<span class="built_in">string</span> s <span class="keyword">in</span> list)</span><br><span class="line">       &#123;</span><br><span class="line">           &lt;li&gt;@s&lt;/li&gt;</span><br><span class="line">       &#125;</span><br><span class="line">     </span><br><span class="line">   &lt;/ul&gt;</span><br></pre></td></tr></table></figure>

<p>以上是循环的写法</p>
<p>判断的写法：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;ul&gt;</span><br><span class="line">           </span><br><span class="line">       @foreach(<span class="built_in">string</span> s <span class="keyword">in</span> list)</span><br><span class="line">       &#123;</span><br><span class="line">           @if (s.Contains(<span class="string">&quot;a&quot;</span>))</span><br><span class="line">           &#123;</span><br><span class="line">               &lt;li&gt;@s&lt;/li&gt;</span><br><span class="line">           &#125;</span><br><span class="line">       </span><br><span class="line">       &#125;</span><br><span class="line">     </span><br><span class="line">   &lt;/ul&gt;</span><br></pre></td></tr></table></figure>

<p><code>@Razor</code>视图使用不多。</p>
<h3 id="2-9-视图传值"><a href="#2-9-视图传值" class="headerlink" title="2.9 视图传值"></a>2.9 视图传值</h3><p> 可以将控制器中的数据，传递给视图中进行展示。</p>
<p> <strong>(1) <code>ViewData</code>方式传值</strong></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">ShowUserList</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    List&lt;UserInfo&gt; users = <span class="keyword">new</span> List&lt;UserInfo&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">new</span> UserInfo &#123; Id = <span class="number">1</span>,Name=<span class="string">&quot;zhangsan&quot;</span>,Email=<span class="string">&quot;zhangsan@126.com&quot;</span>&#125;,</span><br><span class="line">        <span class="keyword">new</span> UserInfo &#123; Id = <span class="number">2</span>,Name=<span class="string">&quot;lisi&quot;</span>,Email=<span class="string">&quot;lisi@126.com&quot;</span>&#125;,</span><br><span class="line">        <span class="keyword">new</span> UserInfo &#123; Id = <span class="number">3</span>,Name=<span class="string">&quot;wangwu&quot;</span>,Email=<span class="string">&quot;wangwu@126.com&quot;</span>&#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    ViewData[<span class="string">&quot;UserList&quot;</span>] = users; <span class="comment">// </span></span><br><span class="line">    <span class="keyword">return</span> View();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>针对<code>ShowUserList</code>方法创建视图</p>
<p>在视图中的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">@using WebApplication1.Models; <span class="comment">// 导入了命名空间</span></span><br><span class="line"></span><br><span class="line">&lt;table&gt;</span><br><span class="line">    &lt;tr&gt;</span><br><span class="line">       </span><br><span class="line">            &lt;th&gt;编号&lt;/th&gt;</span><br><span class="line">            &lt;th&gt;姓名&lt;/th&gt;</span><br><span class="line">            &lt;th&gt;邮箱&lt;/th&gt;</span><br><span class="line">     </span><br><span class="line">    &lt;/tr&gt;</span><br><span class="line">    @foreach (<span class="function"><span class="keyword">var</span> student <span class="title">in</span> (<span class="params">List&lt;UserInfo&gt;</span>)ViewData[&quot;UserList&quot;]!) <span class="comment">// 将ViewData中的数据类型转换成List</span></span></span><br><span class="line">    &#123;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">            &lt;td&gt;</span><br><span class="line">                @student.Id</span><br><span class="line">            &lt;/td&gt;</span><br><span class="line">            &lt;td&gt;</span><br><span class="line">                @student.Name</span><br><span class="line">            &lt;/td&gt;</span><br><span class="line">            &lt;td&gt;</span><br><span class="line">                @student.Email</span><br><span class="line">            &lt;/td&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&lt;/table&gt;</span><br></pre></td></tr></table></figure>

<p><strong>(2)<code>ViewBag</code></strong> </p>
<p><code>ViewBag</code>本质上就是<code>ViewData</code>，只是多了层<code>Dynamic</code>,个人根据自己的习惯选择<code>ViewBag,ViewData</code>.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">了解什么是Dynamic动态类型首先我们了解静态类型，在我们平时定义一个int i=1就是静态类型，静态类型就是我们在没有编译的时候已经明确的知道他是一个int类型，动态语言是我们在运行时才会知道的类型。所以我们在编写动态类型的时候是无法使用vs的智能提示，因为编译器也不知道他是一个什么类型。该类型的作用是绕过编译时类型检查</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">ShowUserList</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    List&lt;UserInfo&gt; users = <span class="keyword">new</span> List&lt;UserInfo&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">new</span> UserInfo &#123; Id = <span class="number">1</span>,Name=<span class="string">&quot;zhangsan&quot;</span>,Email=<span class="string">&quot;zhangsan@126.com&quot;</span>&#125;,</span><br><span class="line">        <span class="keyword">new</span> UserInfo &#123; Id = <span class="number">2</span>,Name=<span class="string">&quot;lisi&quot;</span>,Email=<span class="string">&quot;lisi@126.com&quot;</span>&#125;,</span><br><span class="line">        <span class="keyword">new</span> UserInfo &#123; Id = <span class="number">3</span>,Name=<span class="string">&quot;wangwu&quot;</span>,Email=<span class="string">&quot;wangwu@126.com&quot;</span>&#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    ViewBag.UserList = users; <span class="comment">// 这里的UserList是任意指定的</span></span><br><span class="line">    <span class="keyword">return</span> View();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>视图中数据的展示</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@foreach (<span class="keyword">var</span> student <span class="keyword">in</span> ViewBag.UserList!) <span class="comment">// 这里不需要进行类型的转换。</span></span><br><span class="line">  &#123;</span><br><span class="line">      &lt;tr&gt;</span><br><span class="line">          &lt;td&gt;</span><br><span class="line">              @student.Id</span><br><span class="line">          &lt;/td&gt;</span><br><span class="line">          &lt;td&gt;</span><br><span class="line">              @student.Name</span><br><span class="line">          &lt;/td&gt;</span><br><span class="line">          &lt;td&gt;</span><br><span class="line">              @student.Email</span><br><span class="line">          &lt;/td&gt;</span><br><span class="line">      &lt;/tr&gt;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p><strong>(3) <code>ViewModel</code>传值</strong></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">ShowUserList</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            List&lt;UserInfo&gt; users = <span class="keyword">new</span> List&lt;UserInfo&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">new</span> UserInfo &#123; Id = <span class="number">1</span>,Name=<span class="string">&quot;zhangsan&quot;</span>,Email=<span class="string">&quot;zhangsan@126.com&quot;</span>&#125;,</span><br><span class="line">                <span class="keyword">new</span> UserInfo &#123; Id = <span class="number">2</span>,Name=<span class="string">&quot;lisi&quot;</span>,Email=<span class="string">&quot;lisi@126.com&quot;</span>&#125;,</span><br><span class="line">                <span class="keyword">new</span> UserInfo &#123; Id = <span class="number">3</span>,Name=<span class="string">&quot;wangwu&quot;</span>,Email=<span class="string">&quot;wangwu@126.com&quot;</span>&#125;</span><br><span class="line">            &#125;;</span><br><span class="line">           <span class="comment">/* ViewBag.UserList = users;*/</span></span><br><span class="line">            <span class="keyword">return</span> View(users); <span class="comment">// 这里将数据做我了View`方法的参数`</span></span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>视图进行介绍</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">@using WebApplication1.Models;</span><br><span class="line">@model List&lt;UserInfo&gt; <span class="comment">// 指定了数据类型，一定要与控制器中View方法的参数类型保持一致,注意model是小写</span></span><br><span class="line">&lt;table&gt;</span><br><span class="line">    &lt;tr&gt;</span><br><span class="line">       </span><br><span class="line">            &lt;th&gt;编号&lt;/th&gt;</span><br><span class="line">            &lt;th&gt;姓名&lt;/th&gt;</span><br><span class="line">            &lt;th&gt;邮箱&lt;/th&gt;</span><br><span class="line">     </span><br><span class="line">    &lt;/tr&gt;</span><br><span class="line">    @foreach (<span class="keyword">var</span> student <span class="keyword">in</span> Model) <span class="comment">// Model的类型就是 List&lt;UserInfo&gt;,注意：这里的Model的首字母是大写的。</span></span><br><span class="line">    &#123;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">            &lt;td&gt;</span><br><span class="line">                @student.Id</span><br><span class="line">            &lt;/td&gt;</span><br><span class="line">            &lt;td&gt;</span><br><span class="line">                @student.Name</span><br><span class="line">            &lt;/td&gt;</span><br><span class="line">            &lt;td&gt;</span><br><span class="line">                @student.Email</span><br><span class="line">            &lt;/td&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&lt;/table&gt;</span><br></pre></td></tr></table></figure>

<p><code>ViewModel</code>就是视图要展示的数据，视图展示什么数据，我们就给其传递相应的数据。</p>
<p>使用<code>ViewModel</code>的时候，在输出数据的时候是智能提示的（<code>@student.Id</code>，这里有智能提示）,而<code>ViewBag</code>是没有的。</p>
<p>关于<code>View</code>这个方法，我们在这里再稍微强调一下：</p>
<p><code>View</code>方法是有不同的重载，如果不给改方法传递参数,表示呈现当然<code>方法</code>对应的视图页面。</p>
<p>下面看一下<code>View</code>方法的另外一种重载的写法：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">ShowUserList</span>()</span></span><br><span class="line">       &#123;</span><br><span class="line">         <span class="comment">/*  List&lt;UserInfo&gt; users = new List&lt;UserInfo&gt;</span></span><br><span class="line"><span class="comment">           &#123;</span></span><br><span class="line"><span class="comment">               new UserInfo &#123; Id = 1,Name=&quot;zhangsan&quot;,Email=&quot;zhangsan@126.com&quot;&#125;,</span></span><br><span class="line"><span class="comment">               new UserInfo &#123; Id = 2,Name=&quot;lisi&quot;,Email=&quot;lisi@126.com&quot;&#125;,</span></span><br><span class="line"><span class="comment">               new UserInfo &#123; Id = 3,Name=&quot;wangwu&quot;,Email=&quot;wangwu@126.com&quot;&#125;</span></span><br><span class="line"><span class="comment">           &#125;;*/</span></span><br><span class="line">          <span class="comment">/* ViewBag.UserList = users;*/</span></span><br><span class="line">           <span class="keyword">return</span> View();</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Test</span>()</span></span><br><span class="line">       &#123;</span><br><span class="line">           List&lt;UserInfo&gt; users = <span class="keyword">new</span> List&lt;UserInfo&gt;</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">new</span> UserInfo &#123; Id = <span class="number">1</span>,Name=<span class="string">&quot;zhangsan&quot;</span>,Email=<span class="string">&quot;zhangsan@126.com&quot;</span>&#125;,</span><br><span class="line">               <span class="keyword">new</span> UserInfo &#123; Id = <span class="number">2</span>,Name=<span class="string">&quot;lisi&quot;</span>,Email=<span class="string">&quot;lisi@126.com&quot;</span>&#125;,</span><br><span class="line">               <span class="keyword">new</span> UserInfo &#123; Id = <span class="number">3</span>,Name=<span class="string">&quot;wangwu&quot;</span>,Email=<span class="string">&quot;wangwu@126.com&quot;</span>&#125;</span><br><span class="line">           &#125;;</span><br><span class="line">           <span class="keyword">return</span> View(<span class="string">&quot;ShowUserList&quot;</span>,users);</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>这里我们在<code>UserInfo</code>这个控制器中，又创建了一个<code>Test</code>方法，在该方法中创建了<code>List</code>集合。</p>
<p>然后<code>View</code>方法中第一个参数是字符串<code>ShowUserList</code>,表示展示的是<code>ShowUserList</code>这个方法对应的视图，并且给改视图中传递了<code>List</code>集合中的数据。</p>
<p>这样在<code>ShowUserList</code>这个方法中就没有必要创建<code>List</code>集合了。</p>
<p>在浏览器的地址栏中输入:<code>http://localhost:5099/userInfo/test</code></p>
<p>会访问<code>UserInfo</code>控制器中的<code>test</code>方法，但是最终在页面中展示的是<code>ShowUserList</code>方法对应的视图。这里我们并没有创建<code>Test</code>视图。</p>
<p>这种方式简单了解一下</p>
<h2 id="3、http请求"><a href="#3、http请求" class="headerlink" title="3、http请求"></a>3、<code>http</code>请求</h2><h3 id="3-1-表单提交方式"><a href="#3-1-表单提交方式" class="headerlink" title="3.1  表单提交方式"></a>3.1  表单提交方式</h3><p>在这一小节中，我们来看一下表单提交。</p>
<p>在<code>UserInfoController.cs</code>中创建一个<code>ShowForm</code>方法</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">ShowForm</span>()</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">return</span> View();</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>对应的视图</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">action</span>=<span class="string">&quot;/UserInfo/AddForm&quot;</span>&gt;</span></span><br><span class="line">   用户名： <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">autocomplete</span>=<span class="string">&quot;off&quot;</span>/&gt;</span></span><br><span class="line">   密码：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;userpwd&quot;</span>/&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;登录&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里采用<code>post</code>请，请求的地址是<code>/UserInfo/AddForm</code>,注意：表单元素一定要添加<code>name</code>属性，服务端通过该属性接收用户在表单中输入的数据。</p>
<p>下面在<code>UserInfo</code>控制器中创建<code>AddForm</code>这个方法来接收表单提交过滤的数据。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">AddForm</span>()</span></span><br><span class="line">      &#123;</span><br><span class="line">          <span class="keyword">var</span> userName = Request.Form[<span class="string">&quot;username&quot;</span>];</span><br><span class="line">          <span class="keyword">var</span> password = Request.Form[<span class="string">&quot;userPwd&quot;</span>];</span><br><span class="line">          <span class="keyword">if</span>(userName==<span class="string">&quot;admin&quot;</span> &amp;&amp; password == <span class="string">&quot;123&quot;</span>)</span><br><span class="line">          &#123;</span><br><span class="line">              <span class="keyword">return</span> Content(<span class="string">&quot;登录成功&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">              <span class="keyword">return</span> Content(<span class="string">&quot;用户名密码错误&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>这里通过<code>Request.Form</code>进行接收，方括号中的内容是表单元素<code>name</code>属性的值。</p>
<p>如果表单以<code>get</code>方式进行提交，应该怎样进行接收呢？</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;form method=<span class="string">&quot;get&quot;</span> action=<span class="string">&quot;/UserInfo/AddForm&quot;</span>&gt;</span><br><span class="line">   用户名： &lt;input type=<span class="string">&quot;text&quot;</span> name=<span class="string">&quot;username&quot;</span> autocomplete=<span class="string">&quot;off&quot;</span>/&gt;</span><br><span class="line">   密码：&lt;input type=<span class="string">&quot;password&quot;</span> name=<span class="string">&quot;userpwd&quot;</span>/&gt;</span><br><span class="line">   &lt;input type=<span class="string">&quot;submit&quot;</span> <span class="keyword">value</span>=<span class="string">&quot;登录&quot;</span>/&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">AddForm</span>()</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">var</span> userName = Request.Query[<span class="string">&quot;username&quot;</span>];</span><br><span class="line">           <span class="keyword">var</span> password = Request.Query[<span class="string">&quot;userPwd&quot;</span>];</span><br><span class="line">           <span class="keyword">if</span>(userName==<span class="string">&quot;admin&quot;</span> &amp;&amp; password == <span class="string">&quot;123&quot;</span>)</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">return</span> Content(<span class="string">&quot;登录成功&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">else</span></span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">return</span> Content(<span class="string">&quot;用户名密码错误&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>这里通过<code>Request.Query</code>来进行接收。</p>
<p><code>Get</code>请求与<code>Post</code>请求的区别？</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">get请求发送数据的时候，数据会挂在URL的后面，并且在URI后面添加一个“?”，&quot;?&quot;后面是数据。这样会导致发送的数据回显在浏览器的地址栏上。（get请求在“请求行”上发送数据）所以，需要向服务器发送安全性要求比较高的数据的时候，例如登录，不能使用get请求。</span><br><span class="line"></span><br><span class="line"> post请求发送数据的时候，在请求体当中发送。不会回显到浏览器的地址栏上。也就是说post发送的数据，在浏览器地址栏上看不到。（post在“请求体”当中发送数据）</span><br><span class="line"> </span><br><span class="line">     get请求只能发送普通的字符串。并且发送的字符串长度有限制，不同的浏览器限制不同。这个没有明确的规范。</span><br><span class="line">    get请求无法发送大数据量。</span><br><span class="line">    post请求可以发送任何类型的数据，包括普通字符串，流媒体等信息：视频、声音、图片。</span><br><span class="line">    post请求可以发送大数据量，理论上没有长度限制。</span><br><span class="line">    </span><br><span class="line"> get请求比较适合从服务器端获取数据。</span><br><span class="line"> post请求比较适合向服务器端传送数据。</span><br><span class="line"> </span><br><span class="line">  get请求支持缓存。</span><br><span class="line">   任何一个get请求最终的“响应结果”都会被浏览器缓存起来。</span><br><span class="line">   实际上，你只要发送get请求，浏览器做的第一件事都是先从本地浏览器缓存中找，找不到的时候才会去服务器上获取。这种缓存机制目的是为了提高用户的体验。</span><br><span class="line">   </span><br><span class="line">      post请求不支持缓存</span><br><span class="line">        post请求之后，服务器“响应的结果”不会被浏览器缓存起来。因为这个缓存没有意义。</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">     GET请求和POST请求如何选择，什么时候使用GET请求，什么时候使用POST请求？</span><br><span class="line">    怎么选择GET请求和POST请求呢？衡量标准是什么呢？你这个请求是想获取服务器端的数据，还是想向服务器发送数据。如果你是想从服务器上获取资源，建议使用GET请求，如果你这个请求是为了向服务器提交数据，建议使用POST请求。</span><br><span class="line">    大部分的form表单提交，都是post方式，因为form表单中要填写大量的数据，这些数据是收集用户的信息，一般是需要传给服务器，服务器将这些数据保存/修改等。</span><br><span class="line">    如果表单中有敏感信息，还是建议适用post请求，因为get请求会回显敏感信息到浏览器地址栏上。（例如：密码信息），`post`只是相对安全</span><br><span class="line">    做文件上传，一定是post请求。要传的数据不是普通文本。</span><br><span class="line">    其他情况都可以使用get请求。</span><br><span class="line">    不管你是get请求还是post请求，发送的请求数据格式是完全相同的，只不过位置不同，格式都是统一的：</span><br><span class="line">        name=value&amp;name=value&amp;name=value&amp;name=value     </span><br></pre></td></tr></table></figure>

<p>不光有<code>GET,Post</code>请求，还有<code>delete,put</code>请求等，后面在进行讲解。</p>
<h3 id="3-2-http协议"><a href="#3-2-http协议" class="headerlink" title="3.2 http协议"></a>3.2 <code>http</code>协议</h3><p>不管是浏览器器向服务器发送数据，还是服务器向浏览器返回数据，走的协议是<code>http</code>无状态协议(是应用层协议)。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">  什么是协议？</span><br><span class="line">协议实际上是某些人，或者某些组织提前制定好的一套规范，大家都按照这个规范来，这样可以做到沟通无障碍。</span><br><span class="line"></span><br><span class="line">协议就是一套规范，就是一套标准。由其他人或其他组织来负责制定的。</span><br><span class="line"></span><br><span class="line">我说的话你能听懂，你说的话，我也能听懂，这说明我们之间是有一套规范的，一套协议的，这套协议就是：中国普通话协议。我们都遵守这套协议，我们之间就可以沟通无障碍。</span><br><span class="line"></span><br><span class="line">在网络中，数据的相互传递也要遵循相应的协议。</span><br><span class="line">简单理解：数据的组织形式就是协议。</span><br></pre></td></tr></table></figure>

<p><strong><code>什么是Http协议</code>？</strong></p>
<p> HTTP协议：是<code>W3C</code>制定的一种<strong>超文本传</strong>输协议，规定了浏览器和服务器之间数据传输的规则</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">（通信协议：发送消息的模板提前被制定好。）</span><br><span class="line"> W3C：</span><br><span class="line"></span><br><span class="line">        万维网联盟组织</span><br><span class="line">        负责制定标准的：HTTP HTML4.0 HTML5 XML DOM等规范都是W3C制定的。</span><br><span class="line">       </span><br><span class="line"> 什么是超文本？</span><br><span class="line"></span><br><span class="line">        超文本说的就是：不是普通文本，比如流媒体：声音、视频、图片等。</span><br><span class="line">        HTTP协议支持：不但可以传送普通字符串，同样支持传递声音、视频、图片等流媒体信息。</span><br><span class="line">  Http协议特点：</span><br><span class="line">       第一： 基于TCP协议：面向链接，安全</span><br><span class="line">       第二： 基于请求-响应模型的：一次请求对应一次响应</span><br><span class="line">       第三：http协议是无状态协议.</span><br><span class="line">    </span><br><span class="line">        </span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"> http协议一大特点就是无状态性： 每当有新的请求发送时,就会有对应的新响应产 生。协议本身并不保留之前一切的请求或响应报文的信息。这是为了更快地处理大量事务,确保协议的可伸缩性,而特意把HTTP协议设计成 如此简单的。可是,随着Web的不断发展,因无状态而导致业务处理变得棘手 的情况增多了。比如,用户登录到一家购物网站,即使他跳转到该站的 其他页面后,也需要能继续保持登录状态。针对这个实例,网站为了能 够掌握是谁送出的请求,需要保存用户的状态</span><br></pre></td></tr></table></figure>

<p><strong><code>HTTP</code>协议包括的内容</strong></p>
<p>总体上包括<code>请求协议</code>和<code>响应协议</code>（所以说<code>http</code>协议是一个请求响应的协议）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> 请求协议</span><br><span class="line"></span><br><span class="line">     浏览器 向 WEB服务器发送数据的时候，这个发送的数据需要遵循一套标准，这套标准中规定了发送的数据具体格式（发送的数据我们也叫 做请求报文）。</span><br><span class="line">响应协议</span><br><span class="line">     WEB服务器 向 浏览器发送数据的时候，这个发送的数据需要遵循一套标准，这套标准中规定了（服务器返回给浏览器的数据也叫响应报 文）</span><br></pre></td></tr></table></figure>

<p><strong>请求协议的组成</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C://Users/86159/Desktop/images/%E5%9B%BE%E7%89%871.jpg"></p>
<p><strong>请求报文</strong></p>
<p>通过<code>谷歌</code>浏览器中的<code>network</code>中的<code>Headers</code>来进行查看。</p>
<p>下面我们来看一下请求头（在<code>get</code>请求中没有请求体，在<code>post</code>请求中会有请求体）</p>
<p><strong><code>General</code>:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">通用头即可以包含在HTTP请求中，也可以包含在HTTP响应中。通用头的作用是描述HTTP协议本身。</span><br><span class="line"></span><br><span class="line">Request URL：请求地址</span><br><span class="line">Request Method:请求方法</span><br><span class="line">Status Code：状态码</span><br><span class="line">Remote Address:Remote Address 来自 TCP 连接，表示与服务端建立 TCP 连接的设备 IP</span><br><span class="line">Referrer-Policy：控制请求头中referrer的内容</span><br></pre></td></tr></table></figure>

<p><strong><code>Request Headers</code></strong>(请求头)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Accept： 表明客户同端可接受的请求回应的媒体类型范围列表</span><br><span class="line">Accept-Encoding：客户端所能识别的编码压缩格式</span><br><span class="line">Accept-Language：客户端所能识别的语言</span><br><span class="line">User-Agent：表明用户所使用的浏览器标识，主要用于统计的目的；</span><br><span class="line">Connection：keep-alive 长连接</span><br></pre></td></tr></table></figure>

<p><strong>将登录表单，修改成<code>post</code>请求，查看请求体。</strong>(通过<code>Payload</code>选项查看)</p>
<p><strong>响应报文</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C://Users/86159/Desktop/images/%E5%9B%BE%E7%89%872.jpg"></p>
<p><strong><code>Response Headers</code></strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Content-Type：服务端所返回的数据体的内容类型，如：“Content-Type: text/html; charset=gb2312</span><br><span class="line">Date: Fri, 24 Mar 2023 03:47:08 GMT</span><br><span class="line">Server: Kestrel //服务端 务端返回的用于标识自己的一些信息</span><br><span class="line">Transfer-Encoding: chunked //服务端向客户端传输数据所采用的传输模式(仅在HTTP1.1中出现)</span><br><span class="line">// 分块传输编码（Chunked transfer encoding）是超文本传输协议（HTTP）中的一种数据传输机制，允许HTTP由网页服务器发送给客户端应用（ 通常是网页浏览器）的数据可以分成多个部分。分块传输编码只在HTTP协议1.1版本（HTTP/1.1）中提供。</span><br></pre></td></tr></table></figure>

<p><strong><code>Response</code></strong></p>
<p>​    响应体，通过<code>Resopnse</code>选项查看</p>
<p><strong>Status Code</strong>（状态码）</p>
<p>前面我么看到了状态码是200，表示服务端成功了处理了这次浏览器的请求</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C://Users/86159/Desktop/images/3_r.jpg"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">403(Forbidden) 对请求资源的访问被服务器拒绝了，一般是未获得文件系统的访问授权，问权限出现某些问题。</span><br><span class="line">404(Not Found) 浏览器地址错误。服务器找不到对应资源。</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C://Users/86159/Desktop/images/19.png"></p>
<h3 id="3-3-https简介"><a href="#3-3-https简介" class="headerlink" title="3.3 https简介"></a>3.3 <code>https</code>简介</h3><p>  <code>http</code>协议传输的数据都是没有加密的，为了保证数据能够加密传输，网景公司涉及了<code>SSL(Secure Sockets Layer)协议</code>用于对<code>HTTP</code>协议传输的数据进行加密。从而诞生了<code>HTTPS</code>。现在的<code>HTTPS</code>都是用的<code>TLS</code>（<code>Transport Layer Security·</code>）协议。</p>
<p><code>HTTPS</code>默认端口号是<code>443</code>,<code>http</code>协议默认端口号是80.</p>
<p>为什么要使用<code>https</code>协议：</p>
<p><code>HTTP</code>请求过程中，客户端与服务器之间没有任何身份确认的过程，数据全部明文传输，“裸奔”在互联网上，所以很容易遭到黑客的攻击</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C://Users/86159/Desktop/images/21.jpg"></p>
<p>可以看到，客户端发出的请求很容易被黑客截获，如果此时黑客冒充服务器，则其可返回任意信息给客户端，而不被客户端察觉，所以我们经常会听到一词“劫持”.</p>
<p>而且黑客还可以劫持用户通过浏览器发送给服务器的一些敏感数据，例如：用户名和密码等。这样就非常的危险了。</p>
<p>所以说,<code>http</code>协议是不安全的，没有加密。</p>
<p><code>https</code>协议：安全，对请求报文和响应报文做了加密。</p>
<p>为了防止上述现象的发生，我们想到的一个办法就是对传输的信息加密。（即使黑客截获，也无法破解）</p>
<p>我们可以使用:”对称加密”的方式来对传输的信息进行加密。</p>
<p><strong>所谓对称加密</strong>：使用同一个密钥来对信息进行加密和解密。（从字面上解释，密钥是秘密信息的钥匙。掌握了密钥就可以获得保密的信息。具体来说，密钥是一组信息编码，它参与密码的“运算”，并对密码的“运算”起特定的控制作用）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C://Users/86159/Desktop/images/4.png"></p>
<p>在上图中，把明文数据通过密钥1结合加密算法进行加密以后，生成的密文，如果需要进行解密，也 需要通过密钥1结合对应的加密算法进行解密。</p>
<p><strong>对称加密的特点：</strong></p>
<p>​      加密解密使用相同密钥</p>
<pre><code> 高效，适用于大量数据的加密场景，例如对视频文件进行加密，相比较于非对称加密来讲，效率要高。
</code></pre>
<p>​    算法公开，安全性取决于密钥大小，但密钥越大效率越低，需要在安全和效率中做权衡。</p>
<p><strong>对称加密的缺点</strong></p>
<p>算法本身是安全的，但是使用场景不够安全，因为加密和解密都是使用了同一个密钥。</p>
<p>   例如：客户端使用了对称加密以后，把请求报文加密以后，发送给服务端，服务端要进行解密，必须使用同一个密钥，所以说客户端必须要把密钥也要发送给服务端。在网络进行传输的过程中，黑客完全可以获取到秘钥，从而进行解密。</p>
<p>所以说，对称加密的使用场景不够安全。</p>
<p><strong>非对称加密</strong></p>
<p>使用能够<strong>匹配的一对密钥</strong>来<strong>分别</strong>对数据进行加密和解密。这两个密钥是公开密钥(<code>public key</code>,简称公钥)和私有密钥(<code>private key</code>简称私钥)。公钥可以分享给其它人，而私钥只能自己知道</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">公钥加密的数据，只有私钥可以解密</span><br><span class="line">私钥加密的数据，只有公钥可以解密</span><br><span class="line">如果是公钥可以解密的数据，那一定是私钥加密的</span><br><span class="line">如果是私钥可以解密的数据，那一定是公钥加密的</span><br></pre></td></tr></table></figure>

<p>算法：<code>RSA</code>,<code>ECC</code>,<code>Rabin</code>,<code>D-H</code>等。</p>
<p>特点：安全性高</p>
<p>缺点：加密复杂，效率低，耗时较长</p>
<p>使用场景：</p>
<p>​         (1) 加密：对数据进行加密<br>​         (2) 签名：证明数据是谁发的。</p>
<p>下面我们看一下：非对称加密用法</p>
<p>​    <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/86159/Desktop/images/8.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/86159/Desktop/images/522.png"></p>
<p>以上就是非对称加密来实现对数据加密传递。</p>
<p>公钥是通过网络传输的，即使黑客知道也没有问题，因为通过公钥加密的内容，只能通过我的私钥进行解密。确保了数据的安全性。</p>
<p>关于非对称加密的第二个应用场景就是：私钥签名</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/86159/Desktop/images/812.png"></p>
<p>注意：<code>明文的hash</code>值作为明文的唯一标识。（<code>hash介绍：https://zhuanlan.zhihu.com/p/79978978</code>）</p>
<h3 id="3-5-https原理"><a href="#3-5-https原理" class="headerlink" title="3.5 https原理"></a>3.5 <code>https</code>原理</h3><p>（1）下面来看一下<code>请求报文</code>与<code>响应报文</code>是怎样来进行数据的加密来保证 传输的安全性的。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/86159/Desktop/images/20.png"></p>
<p>这里我们首先想到的就是使用对称加密算法：</p>
<p>浏览器使用自己的私钥把请求报文加密后，通过网络发送给服务器，服务器为了能够进行解密，浏览器需要把私钥也要传递给服务器。</p>
<p>这样就存在安全隐患，黑客完全可以截取私钥，进行数据的解密，完成数据的篡改。</p>
<p>（2）下面我们再来考虑使用非对称加密算法：</p>
<p>浏览器想把请求报文加密后发给服务器，就需要使用到服务器的公钥，所以在服务器端会生成公钥和私钥。</p>
<p>当服务器生成公钥以后，可以通过网络传递客户端，客户端接收到以后通过服务端发送过滤的公钥进行加密，加密后传递给服务端，服务端在通过自己的私钥进行解密。</p>
<p>但是这样做也有问题：服务器将公钥通过网络传递浏览器，那么黑客就可以截取服务器传递给浏览器的公钥，然后黑客在将自己的公钥发送给浏览器，那么这时候浏览器使用了黑客的公钥对请求包文进行了加密，然后向服务器进行发送，在通过网络进行发送的过程中，黑客可以截取到，截取到以后，黑客就可以使用自己的私钥来对加密后的请求包文件进行解密了。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/86159/Desktop/images/618.png"></p>
<p>(3)</p>
<p>为了解决上面出现的这个问题，我们就需要让浏览器接受到服务端发送过来的公钥以后做一个判断，判断浏览器接受到公钥就是服务器发送的，而不是被黑客篡改的。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/86159/Desktop/images/917.png"></p>
<p>这里需要一个认证机构，当浏览器接受到公钥以后，要去这个认证机构去验证一下是不是服务器发送的。</p>
<p>这个认证机构必须要有公信力才可以，当然，有很多大公司都认可的认证机构。当然，认证机构是比较多的，有一级也有二级，组织结构类似一颗树。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/86159/Desktop/images/950.png"></p>
<p>服务器需要将生成的<code>公钥</code>以及服务器域名，认证时长等等服务器相关的信息，交给认证机构。</p>
<p>认证机构为了进行校验，它自己也会生成一个公钥和私钥。咱们自己使用的<code>windows</code>系统中其实默认已经保留了一级认证机构(跟节点)生成的公钥</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/86159/Desktop/images/555.png"></p>
<p>认证机构将公钥交给了用户的电脑以后，会使用自己的私钥对<code>服务器的公钥，服务器域名</code>等信息进行加密，生成服务器的证书。</p>
<p>把生成的证书交给服务器，服务器会存储该证书</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C://Users/86159/Desktop/images/949.png"></p>
<p>通过上图，我们可以看到认证机构生成的服务器证书，又交给了服务器，服务器将证书进行了保存。</p>
<p>当浏览器真正向服务器发送请求报文之前，会先向服务器要证书，服务器会将证书发送给浏览器，浏览器就获取到了服务器的证书。</p>
<p>我们知道服务器证书中包含了服务器公钥和服务器的域名。</p>
<p>浏览器既然已经获取到了服务器的证书（加密的），就可以进行解密了，怎样进行解密呢？</p>
<p>我们知道这里是通过认证机构的私钥加密生成服务器证书的，那浏览器就需要使用认证机构的公钥来解密服务器的证书。而机构的公钥已经存在用户的电脑中了。</p>
<p>这样，浏览器通过认证机构的公钥对接受到的服务器证书进行解密，得到了服务器公钥和服务器域名等信息，如下图所示：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C://Users/86159/Desktop/images/011.png"></p>
<p><strong>浏览器能够通过机构公钥来对服务器证书进行解密，就说明服务器的证书就是通过认证机构通过私钥加密的。就说明服务器证书就是服务器发送的</strong>。这样浏览器完成对服务器证书解密以后，获取到服务器公钥，这样浏览器就可以使用服务器公钥来对请求报文进行加密了。</p>
<p>但是，在前面我们说过非对称加密的缺点是:效率低，耗时较长.</p>
<p>如果请求报文比较大，那么在进行加密的时候，耗费的时间就会比较长。 这样会浏览器请求服务器以及得到服务器响应的时间变长，而导致用户长时间等待，但是关键问题是用户不愿意等待。</p>
<p>所以说，浏览器并不会直接使用服务器公钥对请求报文进行加密，就是担心请求 报文中数据太大。导致用户体验差。</p>
<p>问题是：怎样对比较大的数据进行加密，还要让其效率比较高呢？</p>
<p>使用对称加密。</p>
<p>这时候浏览器自己也会生成一个对称加密的密钥，我们也可以叫做会话密钥。</p>
<p>所谓的会话密钥的意思是：只要浏览器与服务器所建立的请求响应链接的通道断掉了，这个会话密钥也就会丢弃。</p>
<p>这样带来的一个问题就是：如果浏览器端使用会话密钥来对请求报文进行加密，就必须要将会话密钥发送给服务端，服务端才能够进行解密。这样又回到了以前所提出的问题：将会话密钥通过网络发送给服务器，也会被黑客所截获。</p>
<p>所以说这里，浏览器不能直接将会话密钥发送给服务器，而是通过浏览器所获取到的<strong>服务器公钥</strong>来对会话密钥来进行加密，然后发送给服务器，服务器接受到以后，可以使用服务器的私钥来进行解密，这样服务器就可以获取到浏览器的会话密钥了。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C://Users/86159/Desktop/images/022.png"></p>
<p>如上图所示：在浏览器中会生成对称加密的密钥（会话密钥），然后与服务器公钥进行加密，加密后的会话密钥通过网络发送给服务器，</p>
<p>服务器就会接受到浏览器发送过滤的加密后的会话密钥（实际就是对称加密的密钥）。由于会话密钥是通过服务器公钥进行加密的，所以在服务器接受到加密后的会话密钥以后，就可以使用服务器自己的私钥来进行解密。这样服务器就会得到会话密钥了。</p>
<p>如下图所示：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C://Users/86159/Desktop/images/548.png"></p>
<p>现在浏览器端有对称加密的密钥（会话密钥），服务器端也有浏览器所生成的对称加密的密钥。</p>
<p>所以下面浏览器端就可以使用对称加密的方式来对请求报文进行加密了，这样提升了速度。然后在将加密后的内容发送服务器，服务器使用浏览器发送过来的会话密钥（称加密的密钥）来对请求报文进行解密。</p>
<p>同样，服务器也会使用浏览器的会话密钥来对响应报文进行加密，加密完以后，返回给浏览器，浏览器会使用自己的会话密钥对响应报文进行解密。</p>
<p>这样浏览器与服务器整个请求响应的过程传递的报文数据都是加密后的了。</p>
<h3 id="3-6：HttpContext上下文"><a href="#3-6：HttpContext上下文" class="headerlink" title="3.6：HttpContext上下文"></a>3.6：<code>HttpContext</code>上下文</h3><p>所谓<code>HttpContext</code>上下文：其实就是交待了当前请求的环境信息，当前上下文中包含了你的请求信息(<code>request</code>)与响应信息<code>Response</code>,也就是当前请求的来龙去脉。</p>
<p>通过前面的学习，我们知道，接收表单中发送过来的数据，可以通过<code>Request</code>来进行接收，将响应报文返回到客户端的时候，可以使用<code>Response</code>.</p>
<p><code>Request</code>与<code>Response</code>都是来自于<code>HttpContext</code>这个对象中。</p>
<p>在这一小节中，我们来讨论一下关于<code>HttpContext</code>对象的创建。</p>
<p>在<code>控制器</code>中可以直接获取<code>HttpContext</code>。为什么还要创建呢？</p>
<p>因为在<code>ControllerBase</code>这个父类中定义了一个<code>HttpContext</code>类型的属性叫做<code>HttpContext</code>.</p>
<p>所以在控制器中可以使用<code>HttpContext</code>.</p>
<p>但是在其他的一些类中也需要使用<code>HttpContext</code>来获取请求的报文数据，就需要创建了。</p>
<p>例如：在项目中创建一个<code>Services</code>文件夹，假设该文件夹中存放的都是业务类。</p>
<p>在该文件夹中创建接口<code>IUserInfoService.cs</code>，代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IUserInfoService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;UserInfo&gt; <span class="title">GetUserList</span>()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建<code>UserInfoService.cs</code>类</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserInfoService</span> : <span class="title">IUserInfoService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;UserInfo&gt; <span class="title">GetUserList</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        HttpContext httpContext = <span class="keyword">new</span> DefaultHttpContext();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>假如在<code>GetUserList</code>方法中，需要使用<code>HttContext</code>，这里我们可以将其创建出来。</p>
<p>但是问题是，这里我们这里创建出来的<code>HttpContext</code>对象，能否获取到浏览器发送的请求报文数据吗？</p>
<p>获取不到。因为这里所创建的<code>HttpContext</code>对象与发送请求的时候所创建的<code>HttpContext</code>对象没有任何的关系。</p>
<p>怎样解决这个问题呢？</p>
<p>第一种方式：既然在控制器对应的方法中可以获取到带有请求报文信息的<code>HttpContext</code>对象，那么我们将其作为参数传递到<code>GetUserList</code>方法中就可以了。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IUserInfoService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;UserInfo&gt; <span class="title">GetUserList</span>(<span class="params">HttpContext context</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接口中声明的方法<code>GetUserList</code>中添加了参数。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserInfoService</span> : <span class="title">IUserInfoService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;UserInfo&gt; <span class="title">GetUserList</span>(<span class="params">HttpContext context</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> str = context.Request.Query[<span class="string">&quot;msg&quot;</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>具体实现中，我们通过<code>Request.Query</code>方式接收通过地址栏中传递过来的参数<code>msg</code></p>
<p>下面修改<code>UserInfoController.cs</code>控制中的代码：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">GetMsg</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    IUserInfoService userInfoService = <span class="keyword">new</span> UserInfoService();</span><br><span class="line">    userInfoService.GetUserList(HttpContext);</span><br><span class="line">    <span class="keyword">return</span> Content(<span class="string">&quot;ok&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在业务对应的<code>GetUserList</code>方法中打上断点，测试看一下能否接收到数据。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:5099/userInfo/getmsg?msg=abc</span><br></pre></td></tr></table></figure>

<p>输入以上的地址进行测试，发现可以。</p>
<p>但是这种处理方式就是，如果很多类中都需要使用<code>HttpContext</code>对象，采用参数传递的方式来实现，比较麻烦一些。</p>
<p>第二种方式：</p>
<p>使用<code>依赖注入</code>的方式来创建<code>HttpContext</code></p>
<p>先修改<code>IUserInfoService</code>接口中 的代码</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IUserInfoService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;UserInfo&gt; <span class="title">GetUserList</span>()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里定义的方法中不需要参数。</p>
<p>这里我们指定的的接口是<code>IHttpContextAccessor</code>,该接口提供了对当前<code>HttpContext</code>访问的的权限。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserInfoService</span> : <span class="title">IUserInfoService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> IHttpContextAccessor _httpContextAccessor;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserInfoService</span>(<span class="params">IHttpContextAccessor _httpContextAccessor</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">this</span>._httpContextAccessor = _httpContextAccessor;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;UserInfo&gt; <span class="title">GetUserList</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> str = _httpContextAccessor.HttpContext?.Request.Query[<span class="string">&quot;msg&quot;</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里我们需要完成对<code>IHttpContextAccessor</code>接口的注入。</p>
<p>下面修改<code>Program.cs</code>文件中的代码：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">builder.Services.AddControllersWithViews();</span><br><span class="line"></span><br><span class="line"><span class="comment">/*builder.Services.AddSingleton&lt;IHttpContextAccessor,HttpContextAccessor&gt;();*/</span></span><br><span class="line"></span><br><span class="line">builder.Services.AddHttpContextAccessor(); <span class="comment">// 这里将IHttpContextAccessor的添加到了容器中</span></span><br><span class="line">builder.Services.AddScoped&lt;IUserInfoService, UserInfoService&gt;(); <span class="comment">//这里将业务类也添加到容器中，这里生命周期是Scoped，也就是每一次Web请求都会创建一个UserInfoService对象。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = builder.Build();</span><br></pre></td></tr></table></figure>

<p>下面返回到<code>UserInfoController.cs</code></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserInfoController</span> : <span class="title">Controller</span></span><br><span class="line"> &#123;</span><br><span class="line">     <span class="keyword">private</span> <span class="keyword">readonly</span> IUserInfoService userInfoService;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="title">UserInfoController</span>(<span class="params">IUserInfoService userInfoService</span>)</span> &#123; </span><br><span class="line">       <span class="keyword">this</span>.userInfoService = userInfoService;</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br></pre></td></tr></table></figure>

<p>完成了<code>UserInfoService</code>的注入</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">GetMsg</span>()</span></span><br><span class="line">      &#123;</span><br><span class="line">          <span class="comment">/*  </span></span><br><span class="line"><span class="comment">            IUserInfoService userInfoService = new UserInfoService();*/</span></span><br><span class="line">          <span class="comment">/*  userInfoService.GetUserList(HttpContext);*/</span></span><br><span class="line">          userInfoService.GetUserList();</span><br><span class="line">          <span class="keyword">return</span> Content(<span class="string">&quot;ok&quot;</span>);</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>在<code>GetMsg</code>方法中调用<code>GetUserList</code>方法。</p>
<p>打上断点，输入地址进行测试。</p>
<h2 id="4、模型绑定"><a href="#4、模型绑定" class="headerlink" title="4、模型绑定"></a>4、模型绑定</h2><p><code>KIlgourNote:</code></p>
<blockquote>
<p>2024.07.08</p>
<ul>
<li>今天讲了：</li>
<li>1、使用绑定方式接收值：也就是说避免了模型属性过多导致Request.Form过于冗余</li>
<li>2、绑定来源：主要使用场景在WebAPI，目的是准确绑定要传的数据模型</li>
<li>3、上传文件：</li>
<li>3.1、基本上传、</li>
<li>3.2、如何限制文件大小</li>
<li>3.3、如何上传多个文件</li>
<li>3.4、如何与表单其他元素联用</li>
<li>3.5、如何展示图片</li>
<li>3.6、如何下载文件</li>
<li>4、客户端和服务端校验</li>
<li>5、AutoMapper映射操作</li>
</ul>
</blockquote>
<p>我们知道，不管是<code>get</code>请求还是<code>post</code>请求，在控制器的方法中，我们需要通过<code>Request</code>方式来进行接收。</p>
<p>当然，我们可以通过模型绑定的方式来简化接收的过程。</p>
<p>如下代码所示：</p>
<p>在<code>About.cshtml</code>视图中添加如下链接：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a href=<span class="string">&quot;/userInfo/detail/2&quot;</span>&gt;详情&lt;/a&gt;</span><br></pre></td></tr></table></figure>

<p>我们可以看到这链接是符合路由规则的。</p>
<p>在<code>UserInfoController.cs</code>控制器中创建<code>detail</code>方法，来接收参数2.</p>
<p>代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">Detail</span>(<span class="params"><span class="built_in">int</span> id</span>)</span></span><br><span class="line">     &#123;</span><br><span class="line">        </span><br><span class="line">         <span class="keyword">return</span> Content(<span class="string">&quot;hello&quot;</span>+id);</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>

<p>这里会自动将数字2，传递给参数<code>id</code>.（这里参数的名字一定要与路由规则中定义的表示参数的名字保持一致）</p>
<p>这是最简单的一种模型绑定的方式。</p>
<h3 id="4-1-Model自动绑定"><a href="#4-1-Model自动绑定" class="headerlink" title="4.1 Model自动绑定"></a>4.1 <code>Model</code>自动绑定</h3><p>视图中表单标签的<code>name</code>属性与<code>Model</code>对象中的属性如果名称一样，则会自动绑定(<code>Model-Binding</code>).</p>
<p>自动绑定底层原理使用的是反射的技术。</p>
<p>在<code>Models</code>中添加两个实体类，如下所示</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">WebApplication1.Models</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Product</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? ProductName &#123; <span class="keyword">get</span>;<span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">decimal</span> Price &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> Category? ProudctCategory &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>以上是<code>Product</code>商品实体类</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Category</span></span><br><span class="line">  &#123;</span><br><span class="line">      <span class="keyword">public</span> <span class="built_in">int</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; </span><br><span class="line">      <span class="keyword">public</span> <span class="built_in">string</span>? CategoryName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>上面创建的是<code>Category</code>这个实体类</p>
<p>创建<code>ProductController.cs</code>这个控制器</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ProductController</span> : <span class="title">Controller</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Index</span>()</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">return</span> View();</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Create</span>()</span></span><br><span class="line">       &#123;</span><br><span class="line">           List&lt;Category&gt; categories = <span class="keyword">new</span> List&lt;Category&gt;();</span><br><span class="line">           categories.Add(<span class="keyword">new</span> Category() &#123; Id = <span class="number">1</span>, CategoryName = <span class="string">&quot;大家电&quot;</span> &#125;);</span><br><span class="line">           categories.Add(<span class="keyword">new</span> Category() &#123; Id = <span class="number">2</span>, CategoryName = <span class="string">&quot;小家电&quot;</span> &#125;);</span><br><span class="line">           <span class="keyword">return</span> View(categories);  </span><br><span class="line">       &#125;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Submit</span>(<span class="params">Product product</span>) <span class="comment">// 注意product参数的类型</span></span></span><br><span class="line">       &#123;</span><br><span class="line">         <span class="keyword">var</span> pId = Request.Form[<span class="string">&quot;ProudctCategory&quot;</span>];</span><br><span class="line">           <span class="keyword">var</span> productName = product.ProductName;</span><br><span class="line">           <span class="keyword">return</span> Content(<span class="string">&quot;添加商品成功&quot;</span>+pId);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p><code>create</code>方法中创建商品类别信息。并且交给对应的视图进行展示。</p>
<p>在<code>Submit</code>方法中接收<code>create</code>视图中表单提交过滤的数据。我们可以看到<code>Submit</code>方法的参数类型是<code>Product</code>.</p>
<p>这样在表单中输入的商品信息会自动填充到<code>product</code>这个参数中。</p>
<p>当商品类别编号，无法自动填充过来的时候，我们可以通过&#96;&#96;Request.Form&#96;来进行接收。</p>
<p><code>create</code>方法对应的视图代码如下所示：（注意：表单元素中的<code>name</code>属性的值和实体类中的属性名字要保持一致）</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">@using WebApplication1.Models;</span><br><span class="line">@model List<span class="tag">&lt;<span class="name">Category</span>&gt;</span>;</span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">action</span>=<span class="string">&quot;/product/submit&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                商品名称：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;ProductName&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                商品价格:<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;number&quot;</span> <span class="attr">name</span>=<span class="string">&quot;Price&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                商品分类：<span class="tag">&lt;<span class="name">select</span> <span class="attr">name</span>=<span class="string">&quot;ProudctCategory&quot;</span>&gt;</span></span><br><span class="line">                    @foreach (var category in Model)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;@category.Id&quot;</span>&gt;</span>@category.CategoryName<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;添加商品&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<code>Submit</code>方法中打上断点进行测试。</p>
<h3 id="4-2-特性绑定"><a href="#4-2-特性绑定" class="headerlink" title="4.2 特性绑定"></a>4.2 特性绑定</h3><p><strong><code>BindAttribute</code></strong></p>
<p>表示有选择性的绑定</p>
<p>绑定所有的属性(默认行为，所以这里可以不用添加<code>Bind</code>这个特性)</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">Submit</span>(<span class="params">[Bind]Product product</span>)</span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> Content(<span class="string">&quot;ok&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也可以指定，只绑定哪些属性</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">Submit</span>(<span class="params">[Bind(<span class="string">&quot;Price&quot;</span></span>)]Product product)</span></span><br><span class="line">      &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><code>BindNeverAttribute</code></strong></p>
<p>该属性作用在<code>Model</code>的属性上，表示此属性不应该被绑定。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Product</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">BindNever</span>] <span class="comment">// 表示Id永远不会被绑定</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span>? ProductName &#123; <span class="keyword">get</span>;<span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">decimal</span> Price &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">  <span class="keyword">public</span> Category? ProudctCategory &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><code>BindRequiredAttribute</code></strong></p>
<p>作用在<code>Model</code>的属性上，与<code>BindNever</code>刚好相反，表示某个属性必须要绑定。</p>
<p>当然，默认情况下，<code>Model</code>中的属性会进行绑定，所以一般不用添加<code>BindRequired</code>.</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Product</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">BindNever</span>] <span class="comment">// 表示Id永远不会被绑定</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? ProductName &#123; <span class="keyword">get</span>;<span class="keyword">set</span>; &#125;</span><br><span class="line">        [<span class="meta">BindRequired</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">decimal</span> Price &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">     <span class="keyword">public</span> Category? ProudctCategory &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-绑定来源"><a href="#4-3-绑定来源" class="headerlink" title="4.3  绑定来源"></a>4.3  绑定来源</h3><p>绑定来源最多的应用场景是后面所讲的<code>WebApi</code></p>
<p>常用的绑定来源：表单域，请求正文(这个在<code>webapi</code>中应用)，路由参数，查询字符串参数，上传的文件</p>
<p>我们可以通过如下的属性来指定来源</p>
<p><code>FromQuery</code>:从查询字符串中获取： <code>Request.Query</code></p>
<p><code>FromRoute</code>:从路由中获取数据: 	<code>Request.RouteValues</code></p>
<p><code>FromForm</code>:从表单域中获取值： <code>Request.Form</code></p>
<p><code>FromBody</code>–从请求正文中获取值：<code>Request.Body</code> (前端开发人员将数据封装到<code>body</code>)</p>
<p><code>FromHeader</code>-从<code>Http</code>请求头中获取值：<code>Request.Headers</code></p>
<p>注意：使用以上的方式的时候，一定要注意的一点就是不要将他们应用于每个操作方法的多个参数。如果有多个参数，请求多个参数封装到一个对象中(例如:<code>Product</code>就是封装的一个对象)。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">Submit</span>(<span class="params">[FromQuery]Product,<span class="built_in">string</span> productName,<span class="built_in">double</span> price</span>)</span></span><br></pre></td></tr></table></figure>

<p>以上的写法中，<code>productName,price</code>有可能接收不到数据。</p>
<p>但是可以采用如下的写法：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">Submit</span>(<span class="params">[FromQuery]Product,[FromHeaer]<span class="built_in">string</span> productName</span>)</span></span><br></pre></td></tr></table></figure>

<p><strong>下面看一下<code>FromQuery</code></strong></p>
<p>这里，我们先创建一个模型类<code>BindTest.cs</code></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">WebApplication1.Models</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BindTest</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在重新创建一个控制器来进行测试<code>BindController.cs</code></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"><span class="keyword">using</span> WebApplication1.Models;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">WebApplication1.Controllers</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BindController</span> : <span class="title">Controller</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Index</span>(<span class="params">[FromQuery]BindTest test</span>) <span class="comment">// 指定了FromQuery，从浏览器中获取参数</span></span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> Content(test.Name +<span class="string">&quot;,&quot;</span>+test.Id);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>浏览器中输入<code>http://localhost:5099/bind?id=1&amp;name=zhangsan</code></p>
<p>可以看到这里获取到了地址栏中传递过来的<code>id,name</code>参数的值。</p>
<p><strong><code>FromBody</code>的使用</strong></p>
<p><code>FromBody</code>一般应用在<code>WebApi</code>中。客户端如果是提交<code>json</code>数据的时候建议都加上<code>[FromBody]</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">如果客户端提交的数据`Content-Type`不是`application/json`，会出错，如果要解决该错误，需要再接口上添加`[FromFrom]`</span><br></pre></td></tr></table></figure>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">BindBodyTest</span>(<span class="params">[FromBody] BindTest test</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">return</span> Json(test); <span class="comment">// 这里我们返回的是JSON数据。</span></span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>下面通过<code>apifox</code>工具来进行测试</p>
<p>新创建一个接口测试。</p>
<p>这里输入服务端接口的地址，注意请求的方式是<code>post</code>请求。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;id&quot;</span>:<span class="string">&quot;2&quot;</span>,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>:<span class="string">&quot;wangwu&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发送到服务端的数据是以上的<code>json</code>数据。</p>
<p><strong><code>FromForm</code> 的使用</strong></p>
<p>使用表单数据绑定参数或者是属性。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BindController</span> : <span class="title">Controller</span></span><br><span class="line">   &#123;</span><br><span class="line">      <span class="comment">/* public IActionResult Index([FromQuery]BindTest test)</span></span><br><span class="line"><span class="comment">       &#123;</span></span><br><span class="line"><span class="comment">           return Content(test.Name +&quot;,&quot;+test.Id);</span></span><br><span class="line"><span class="comment">       &#125;*/</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> IActionResult <span class="title">BindBodyTest</span>(<span class="params">[FromBody] BindTest test</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">return</span> Json(test);</span><br><span class="line">       &#125;</span><br><span class="line">    <span class="comment">// 这里指定了[FromForm]</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> IActionResult <span class="title">BindFormTest</span>(<span class="params">[FromForm] BindTest test</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">return</span> Json(test);</span><br><span class="line"></span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>在<code>apifox</code>工具中进行测试（<code>apifox</code>工具官方文档：<code>https://apifox.com/help/</code>）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C://Users/86159/Desktop/images/212.png"></p>
<p>注意：这里选择了<code>form-data</code></p>
<p>同时还要注意的一点就是：<code>FromForm</code>与<code>FromBody</code>不同点：</p>
<p><code>FromForm</code>接收的是表单中的数据，所以类型是<code>application/x-www-form-urlencoded</code>或者是<code>form-data</code>(不仅发送表单中的文本数据，还可以进行上传),这里其实也是表单默认提交数据的类型。</p>
<p><code>FromBody</code>表示客户端发送的是<code>json</code>数据。</p>
<p><strong><code>FromRoute</code>使用</strong></p>
<p>这种方式是从路由中来获取数据。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">BindRouteTest</span>(<span class="params">[FromRoute] BindTest test</span>)</span></span><br><span class="line">      &#123;</span><br><span class="line">          <span class="keyword">return</span> Json(test);</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>在浏览器 中输入<code>http://localhost:5099/bind/bindroutetest/8</code>来进行 测试。</p>
<p>注意：这里输入的地址符合我们定义的路由规则，所以只能匹配到<code>id</code></p>
<p><strong><code>FromHeader</code>使用</strong></p>
<p>可以实现从请求头中获取数据。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">BinHeaderTest</span>(<span class="params">[FromHeader] BindTest test</span>)</span></span><br><span class="line">     &#123;</span><br><span class="line">         <span class="keyword">return</span> Json(test);</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BindTest</span></span><br><span class="line">   &#123;</span><br><span class="line">       [<span class="meta">FromHeader</span>]</span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">int</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       [<span class="meta">FromHeader</span>]</span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">string</span>? Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>这里为了能够接收到数据，需要给实体中的属性添加<code>[FromHeader]</code>特性</p>
<p>下面返回到<code>apifox</code>工具中进行测试</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C://Users/86159/Desktop/images/128.png"></p>
<p>注意这里不能传递中文，如果要传递中文需要通过<code>js</code>进行编码</p>
<h2 id="5、文件上传与下载"><a href="#5、文件上传与下载" class="headerlink" title="5、文件上传与下载"></a>5、文件上传与下载</h2><h3 id="5-1-单文件上传"><a href="#5-1-单文件上传" class="headerlink" title="5.1 单文件上传"></a>5.1 单文件上传</h3><p>官方文档:<code>https://learn.microsoft.com/zh-cn/aspnet/core/mvc/models/file-uploads?view=aspnetcore-2.2#upload-large-files-with-streaming</code></p>
<p><code>https://learn.microsoft.com/zh-cn/aspnet/core/mvc/models/file-uploads?view=aspnetcore-7.0</code></p>
<p>在文件上传的时候，我们需要使用到<code>IFormFile</code>这个接口。</p>
<p>在项目中创建控制<code>UploadFileController.cs</code>，为<code>Index</code>方法创建对应的视图，在该视图中创建上传文件的表单。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">Index</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> View();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span> <span class="attr">action</span>=<span class="string">&quot;/UploadFile/SingleFileUp&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;file&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;文件上传&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里上传文件的方式是<code>post</code>,同时上传文件的编码方式是<code>multipart/form-data</code></p>
<p>在<code>UploadFile</code>这个控制器中创建<code>SingleFileUp</code>这个方法。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">SingleFileUp</span>(<span class="params">IFormFile file</span>)</span> &#123; </span><br><span class="line">    <span class="comment">// 构建上传的文件名称</span></span><br><span class="line">    <span class="built_in">string</span> fileName = Guid.NewGuid().ToString()+<span class="string">&quot;.&quot;</span>+Path.GetExtension(file.FileName);</span><br><span class="line">    <span class="comment">// 构建文件存储的路径</span></span><br><span class="line">    <span class="keyword">var</span> filePath = Path.Combine(webHostEnvironment.ContentRootPath, <span class="string">&quot;upload&quot;</span>, fileName);</span><br><span class="line">    Console.WriteLine(<span class="string">&quot;contentRootPaht = &quot;</span>+ webHostEnvironment.ContentRootPath);</span><br><span class="line">    <span class="keyword">using</span> (FileStream fileStream = <span class="keyword">new</span> FileStream(filePath,FileMode.Create,FileAccess.Write))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">await</span> file.CopyToAsync(fileStream);</span><br><span class="line">        <span class="keyword">return</span> Content(<span class="string">&quot;上传成功&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>SingleFileUp</code>方法的参数类型是<code>SingleFileUp</code>这个接口类型。同时参数的名称是<code>file</code>.注意：这里的参数名称要与表单中文件上传域的<code>name</code>属性值保持一致</p>
<p>在构建上传的文件名称的时候，为了保证上传文件名称的唯一性，这里使用了<code>Guid</code>，当然也可以使用其他的方式。</p>
<p>下面构建存储的路径，这里进行了路径的拼接使用了<code>Path.Combine</code>方法。</p>
<p>这里需要获取物理路径</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">readonly</span> IWebHostEnvironment webHostEnvironment;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">UploadFileController</span>(<span class="params">IWebHostEnvironment webHostEnvironment</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">this</span>.webHostEnvironment = webHostEnvironment;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里注入了<code>IWebHostEnvironment</code>接口服务，该接口中包含了服务器的信息，例如：目录，网站名称的。</p>
<p>下面通过<code>FileStream</code>对象中的<code>CopyToAsync</code>方法完成了文件的上传操作。</p>
<p>当然，这里我们可以做一个判断，如果用户没有选择上传的文件，而是直接单击了上传按钮，这时候给出相应的错误提示。</p>
<p>当然，这种判断可以通过<code>js</code>来判断，但是服务端也要进行判断。这样更严谨。因为浏览器端可以禁用<code>js</code>.</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">SingleFileUp</span>(<span class="params">IFormFile file</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 这里添加了判断，如果`file`为null,表示表单中没有选择上传的文件。</span></span><br><span class="line">    <span class="keyword">if</span> (file !=<span class="literal">null</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 构建上传的文件名称</span></span><br><span class="line">        <span class="built_in">string</span> fileName = Guid.NewGuid().ToString() + <span class="string">&quot;.&quot;</span> + Path.GetExtension(file.FileName);</span><br><span class="line">        <span class="comment">// 构建文件存储的路径</span></span><br><span class="line">        <span class="keyword">var</span> filePath = Path.Combine(webHostEnvironment.ContentRootPath, <span class="string">&quot;upload&quot;</span>, fileName);</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;contentRootPaht = &quot;</span> + webHostEnvironment.ContentRootPath);</span><br><span class="line">        <span class="keyword">using</span> (FileStream fileStream = <span class="keyword">new</span> FileStream(filePath, FileMode.Create, FileAccess.Write))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">await</span> file.CopyToAsync(fileStream);</span><br><span class="line">            <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123; StatusCode = <span class="number">200</span>, Content = <span class="string">&quot;上传成功&quot;</span> &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123; StausCode = <span class="number">505</span>, Content = <span class="string">&quot;请选择上传的文件&quot;</span> &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在上面的代码中，返回到浏览器的信息，我们修改了<code>Json</code>方法，目的就是返回<code>json</code>格式的数据。</p>
<p>但是，发现中文会出现乱码的形式。</p>
<p>针对这种情况，我们需要修改一下配置：</p>
<p>在<code>Program.cs</code>文件中，添加如下的配置：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在AddControllersWithViews()方法后面调用了AddJsonOptions方法，在该方法中完成了，`JSON`序列化的配置，使用的编码是`Unicode`，然后指定的范围是All,包含所有的编码方式。</span></span><br><span class="line">builder.Services.AddControllersWithViews().AddJsonOptions(options =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    options.JsonSerializerOptions.Encoder = JavaScriptEncoder.Create(UnicodeRanges.All);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>同<strong>时还要注意的一点就是一定要对上传的文件类型进行判断</strong>，防止上传<code>.exe</code>等文件给服务器造成安全隐患。</p>
<h3 id="5-2-文件上传大小限制"><a href="#5-2-文件上传大小限制" class="headerlink" title="5.2 文件上传大小限制"></a>5.2 文件上传大小限制</h3><p>如果上传的文件过大，对服务器资源的消耗也会变大，所以在项目中一般会上传的文件大小做一定的限制。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">对于 Kestrel 托管的应用，默认的最大请求正文大小为 30,000,000 个字节，约为 28.6 MB。 使用 MaxRequestBodySizeKestrel 服务器选项自定义此限制：</span><br><span class="line">public static IWebHostBuilder CreateWebHostBuilder(string[] args) =&gt;</span><br><span class="line">    WebHost.CreateDefaultBuilder(args)</span><br><span class="line">        .UseStartup&lt;Startup&gt;()</span><br><span class="line">        .ConfigureKestrel((context, options) =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            // Handle requests up to 50 MB</span><br><span class="line">            options.Limits.MaxRequestBodySize = 52428800;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">IIS 服务器的请求报文的限制</span><br><span class="line">默认的请求限制 (maxAllowedContentLength) 为 30,000,000 个字节，约为 28.6 MB。 在 web.config 文件中自定义此限制。 在下面的示例中，此限制设置为 50 MB（52,428,800 个字节）：</span><br><span class="line">通过在 Startup.ConfigureServices 中设置 IISServerOptions.MaxRequestBodySize 来提高 HTTP 请求的最大请求正文大小。 在下面的示例中，此限制设置为 50 MB（52,428,800 个字节）：</span><br><span class="line">services.Configure&lt;IISServerOptions&gt;(options =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    options.MaxRequestBodySize = 52428800;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>在<code>appsettings.json</code>配置文件中，指定上传文件的大小，例如:<code>2M</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;Logging&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;LogLevel&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Default&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Information&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Microsoft.AspNetCore&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Warning&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;AllowedHosts&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;FileSizeLimit&quot;</span><span class="punctuation">:</span> <span class="number">2097152</span> <span class="comment">// 指定了文件上传的大小限制为2M</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">private</span> <span class="keyword">readonly</span> IWebHostEnvironment webHostEnvironment;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">readonly</span> <span class="built_in">long</span> fileSizeLimit; <span class="comment">// 保存从配置文件中获取的文件大小限制</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">UploadFileController</span>(<span class="params">IWebHostEnvironment webHostEnvironment,IConfiguration config</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">this</span>.webHostEnvironment = webHostEnvironment;</span><br><span class="line">    <span class="comment">// 获取从配置文件中指定文件的大小限制</span></span><br><span class="line">    <span class="keyword">this</span>.fileSizeLimit = config.GetValue&lt;<span class="built_in">long</span>&gt;(<span class="string">&quot;FileSizeLimit&quot;</span>);</span><br><span class="line">    <span class="comment">// Console.WriteLine(&quot;fileSizeLimit=&quot; + fileSizeLimit);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>UploadFile</code>这个控制器中注入<code>ICofiguration</code>来获取配置文件中的信息</p>
<p>下面进行文件大小的判断</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">SingleFileUp</span>(<span class="params">IFormFile file</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (file !=<span class="literal">null</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(file.Length &gt; fileSizeLimit)&#123; <span class="comment">// 进行文件大小的判断</span></span><br><span class="line">            <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123; StatusCode = <span class="number">507</span>, Content = <span class="string">&quot;上传的文件最大只能是2M&quot;</span> &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重启项目进行测试</p>
<h3 id="5-3-多文件上传"><a href="#5-3-多文件上传" class="headerlink" title="5.3  多文件上传"></a>5.3  多文件上传</h3><p>在<code>UploadFileController</code>控制器中，创建<code>MoreUpload</code>方法，用于创建多文件上传的视图</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">MoreUpload</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> View();    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>MoreUpload.cshtml</code>视图文件中的代码如下所示：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span> <span class="attr">action</span>=<span class="string">&quot;/UploadFile/MoreUpload&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;file&quot;</span>  <span class="attr">multiple</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;文件上传&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里修改了<code>action</code>属性的取值，让其指向了<code>/UploadFile/MoreUpload</code></p>
<p>并且给文件上传域添加了<code>multiple</code>属性，表示在弹出的文件选择框中，按住<code>ctrl</code>键，可以选择多个文件。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">HttpPost</span>] <span class="comment">// 添加了HttpPost</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">MoreUpload</span>(<span class="params">IFormFile[] file</span>)   <span class="comment">// file参数的名字一定要与文件上传域的名称保持一致，并且类型是`IFormFile`数组</span></span></span><br><span class="line">       &#123; </span><br><span class="line">           <span class="keyword">foreach</span>(<span class="keyword">var</span> photoFile <span class="keyword">in</span> file)</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="built_in">string</span> fileName = Guid.NewGuid().ToString() + <span class="string">&quot;.&quot;</span> + Path.GetExtension(photoFile.FileName);</span><br><span class="line">               <span class="keyword">var</span> filePath = Path.Combine(webHostEnvironment.ContentRootPath, <span class="string">&quot;upload&quot;</span>, fileName);</span><br><span class="line">               <span class="keyword">using</span> (FileStream fileStream = <span class="keyword">new</span> FileStream(filePath, FileMode.Create, FileAccess.Write))</span><br><span class="line">               &#123;</span><br><span class="line">                   <span class="keyword">await</span> photoFile.CopyToAsync(fileStream);</span><br><span class="line"></span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123; StatusCode = <span class="number">200</span>, Content = file.Length+<span class="string">&quot;个文件上传成功&quot;</span> &#125;); </span><br><span class="line"></span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>由于这里我们接收文件的方法也叫做<code>MoreUpload</code>，与呈现视图的方法重名了，所以我们这里添加了<code>[HttpPost]</code>这个特性，表示只能接收<code>post</code>请求。</p>
<p>对应的参数<code>file</code>一定要文件上传域的<code>name</code>属性的值保持一致，并且它的类型是<code>IFormFile</code>这个数组。</p>
<p>下面遍历<code>数组</code>，每循环一次就上传一个文件。</p>
<p>重新生成项目进行测试。</p>
<h3 id="5-4-文件上传与其他表单元素连用"><a href="#5-4-文件上传与其他表单元素连用" class="headerlink" title="5.4  文件上传与其他表单元素连用"></a>5.4  文件上传与其他表单元素连用</h3><p>文件上传并不是单独的使用，也是与其他的表单元素一块联用的,例如在添加商品的时候，顺便上传商品的图片</p>
<p>这里我们修改一下<code>Models/Product.cs</code>这个实体类</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Product</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">BindNever</span>] <span class="comment">// 表示Id永远不会被绑定</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? ProductName &#123; <span class="keyword">get</span>;<span class="keyword">set</span>; &#125;</span><br><span class="line">        [<span class="meta">BindRequired</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">decimal</span> Price &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">         <span class="keyword">public</span> Category? ProudctCategory &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> IFormFile? ProductImage &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; <span class="comment">// 这里我们添加了一个ProductImage属性，类型是IFormFile接口</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><code>ProductImage</code>这个属性中存储的就是用户上传的图片文件。</p>
<p>下面修改<code>Views/Product/create.html</code>视图</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">@using WebApplication1.Models;</span><br><span class="line">@model List&lt;Category&gt;;</span><br><span class="line">&lt;form method=<span class="string">&quot;post&quot;</span> action=<span class="string">&quot;/product/submit&quot;</span> enctype=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span><br><span class="line">    &lt;table&gt;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">            &lt;td&gt;</span><br><span class="line">                商品名称：&lt;input type=<span class="string">&quot;text&quot;</span> name=<span class="string">&quot;ProductName&quot;</span>/&gt;</span><br><span class="line">            &lt;/td&gt;</span><br><span class="line"></span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">            &lt;td&gt;</span><br><span class="line">                商品价格:&lt;input type=<span class="string">&quot;number&quot;</span> name=<span class="string">&quot;Price&quot;</span> /&gt;</span><br><span class="line">            &lt;/td&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">            &lt;td&gt;</span><br><span class="line">                商品分类：&lt;<span class="keyword">select</span> name=<span class="string">&quot;ProudctCategory&quot;</span>&gt;</span><br><span class="line">                    @foreach (<span class="keyword">var</span> category <span class="keyword">in</span> Model)</span><br><span class="line">                    &#123;</span><br><span class="line">                        &lt;option <span class="keyword">value</span>=<span class="string">&quot;@category.Id&quot;</span>&gt;@category.CategoryName&lt;/option&gt;</span><br><span class="line">                    &#125;</span><br><span class="line">                &lt;/<span class="keyword">select</span>&gt;</span><br><span class="line">            &lt;/td&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">            &lt;td&gt;</span><br><span class="line">                &lt;input type=<span class="string">&quot;file&quot;</span> name=<span class="string">&quot;ProductImage&quot;</span> /&gt;</span><br><span class="line">            &lt;/td&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">            &lt;td&gt;</span><br><span class="line">                &lt;input type=<span class="string">&quot;submit&quot;</span> <span class="keyword">value</span>=<span class="string">&quot;添加商品&quot;</span>/&gt;</span><br><span class="line">            &lt;/td&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">    &lt;/table&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure>

<p>在上面的代码中添加了<code>enctype=&quot;multipart/form-data&quot;</code></p>
<p>同时添加了文件上传域</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;ProductImage&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>注意：这个文件上传域的<code>name</code>属性一定要与<code>Product.cs</code>这个实体类中的<code>ProductImage</code>属性名字保持一致。</p>
<p>下面修改<code>ProductController.cs</code>这个控制器中的<code>submit</code>方法中的内容</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">Submit</span>(<span class="params">Product product</span>) <span class="comment">// 这里参数的类型是Product类型，会进行模型的绑定</span></span></span><br><span class="line">       &#123;</span><br><span class="line">         <span class="keyword">var</span> pId = Request.Form[<span class="string">&quot;ProudctCategory&quot;</span>];</span><br><span class="line">           <span class="keyword">var</span> productName = product.ProductName;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// 构建上传的文件名称</span></span><br><span class="line">           <span class="comment">// 注意：product.ProductImage属性中存储的是用户上传的文件信息</span></span><br><span class="line">           <span class="built_in">string</span> fileName = Guid.NewGuid().ToString() + <span class="string">&quot;.&quot;</span> + Path.GetExtension(product.ProductImage!.FileName);</span><br><span class="line">           <span class="comment">// 构建文件存储的路径</span></span><br><span class="line">           <span class="keyword">var</span> filePath = Path.Combine(webHostEnvironment.ContentRootPath, <span class="string">&quot;upload&quot;</span>, fileName);</span><br><span class="line">           <span class="keyword">using</span> (FileStream fileStream = <span class="keyword">new</span> FileStream(filePath, FileMode.Create, FileAccess.Write))</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="comment">// 注意：product.ProductImage属性中存储的是用户上传的文件信息</span></span><br><span class="line">               <span class="keyword">await</span> product.ProductImage.CopyToAsync(fileStream);</span><br><span class="line"></span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> Content(<span class="string">&quot;添加商品成功&quot;</span>+pId);</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>不要忘记进行注入：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ProductController</span> : <span class="title">Controller</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IWebHostEnvironment webHostEnvironment;</span><br><span class="line">       </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ProductController</span>(<span class="params">IWebHostEnvironment webHostEnvironment, IConfiguration config</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.webHostEnvironment = webHostEnvironment;</span><br><span class="line">           </span><br><span class="line">            </span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>最后进行测试。</p>
<h3 id="5-5-展示图片文件"><a href="#5-5-展示图片文件" class="headerlink" title="5.5  展示图片文件"></a>5.5  展示图片文件</h3><p>在这小节中，我们看一下文件下载</p>
<p>在<code>UploadFileController.cs</code>控制器中添加一个方法，该方法呈现一个展示的视图页面。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 文件下载</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> IActionResult <span class="title">ShowDownFile</span>()</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">return</span> View();</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>对应的<code>ShowDownFile</code>方法对应的视图代码，如下所示：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/UploadFile/DownloadFile?filename=20a16e21-c89c-4250-8948-84b736139044.jpg&quot;</span>&gt;</span>下载<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里就是添加了一个下载的链接，指定了下载的文件名。</p>
<p>下面看一下<code>DownloadFile</code>方法的具体实现。在<code>UploadFile</code>控制器中创建该方法</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">DownloadFile</span>(<span class="params"><span class="built_in">string</span> filename</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">var</span> filePath = Path.Combine(webHostEnvironment.ContentRootPath, <span class="string">&quot;upload&quot;</span>, filename);</span><br><span class="line">           <span class="keyword">var</span> memoryStream = <span class="keyword">new</span> MemoryStream();</span><br><span class="line">           <span class="keyword">using</span> (<span class="keyword">var</span> stream = <span class="keyword">new</span> FileStream(filePath, FileMode.Open))</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">await</span> stream.CopyToAsync(memoryStream);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           memoryStream.Position = <span class="number">0</span>;</span><br><span class="line">           <span class="built_in">string</span> fileExt =Path.GetExtension(filename);</span><br><span class="line">           <span class="comment">//获取文件的ContentType</span></span><br><span class="line">           <span class="keyword">var</span> provider = <span class="keyword">new</span> FileExtensionContentTypeProvider();</span><br><span class="line">           <span class="keyword">var</span> type = provider.Mappings[fileExt];</span><br><span class="line">           Console.WriteLine(<span class="string">&quot;type=&quot;</span> + type);</span><br><span class="line">           <span class="keyword">return</span> File(memoryStream,type,Path.GetFileName(filePath) );</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>在上面的代码中，接收传递过来的要下载的文件名，然后拼接对应的路径。</p>
<p>读取下载的文件，将其读取到<code>memoryStream</code>内存流中。</p>
<p>读取完以后，让流的位置回到最开始。</p>
<p>下面获取上传的文件扩展名、然后创建<code>FileExtensionContentTypeProvider</code>对象，通过该对象中的<code>Mapping</code>方法结合下载文件的扩展名，可以获取要下载的文件的<code>Content-type</code>,也就是文件的类型。</p>
<p>然后通过<code>File</code>对内存流中的文件进行展示操作。</p>
<p>如果想要进行下载，修改如下代码：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">DownloadFile</span>(<span class="params"><span class="built_in">string</span> filename</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="comment">// 找到文件，打开文件，将文件写到内存流中</span></span><br><span class="line">           <span class="built_in">string</span> filePath = Path.Combine(_environment.ContentRootPath, <span class="string">&quot;wwwroot&quot;</span>, <span class="string">&quot;upload&quot;</span>, filename);</span><br><span class="line">           <span class="keyword">var</span> stream = <span class="keyword">new</span> MemoryStream();</span><br><span class="line">           <span class="keyword">using</span> (FileStream fileStream = <span class="keyword">new</span> FileStream(filePath, FileMode.Open))</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">await</span> fileStream.CopyToAsync(stream);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           stream.Position = <span class="number">0</span>;</span><br><span class="line">           <span class="comment">/*string ext = Path.GetExtension(filename); // .jpg</span></span><br><span class="line"><span class="comment">           // 指定类型</span></span><br><span class="line"><span class="comment">           var provider = new FileExtensionContentTypeProvider();</span></span><br><span class="line"><span class="comment">           var type = provider.Mappings[ext]; // image/jpeg</span></span><br><span class="line"><span class="comment">           Console.WriteLine(&quot;type=&quot; + type);*/</span></span><br><span class="line">           <span class="comment">// return File(stream, type);</span></span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">new</span> FileStreamResult(stream, <span class="keyword">new</span> MediaTypeHeaderValue(<span class="string">&quot;image/jpeg&quot;</span>))</span><br><span class="line">           &#123;</span><br><span class="line">               FileDownloadName = filename <span class="comment">// 下载后文件的名称</span></span><br><span class="line">           &#125;;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>注意:<code> MediaTypeHeaderValue</code>需要 导入<code>using Microsoft.Net.Http.Headers;</code>命名空间</p>
<h2 id="6、模型校验（了解）"><a href="#6、模型校验（了解）" class="headerlink" title="6、模型校验（了解）"></a>6、模型校验（了解）</h2><h3 id="6-1-客户端校验"><a href="#6-1-客户端校验" class="headerlink" title="6.1 客户端校验"></a>6.1 客户端校验</h3><p>为了保证数据的正确性与严谨性，客户端与服务端都需要提供数据的校验</p>
<p><code>.net core</code>中提供了一套自己的数据校验模式。(在实际开发中应用相对来讲比较少)</p>
<p>重新创建一个<code>MVC</code>项目进行演示，这里创建的是已经有<code>MVC</code>结构的项目</p>
<p>在<code>Models</code>文件夹中创建一个模型类</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.ComponentModel.DataAnnotations;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">WebApplication2.Models</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserInfoDTO</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        [<span class="meta">Required(ErrorMessage =<span class="string">&quot;请输入账号&quot;</span>)</span>]</span><br><span class="line">        [<span class="meta">StringLength(16,MinimumLength =3,ErrorMessage =<span class="string">&quot;账号是3-16位&quot;</span>)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? Account &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        [<span class="meta">Required(ErrorMessage =<span class="string">&quot;请输入密码&quot;</span>)</span>]</span><br><span class="line">        [<span class="meta">StringLength(16,MinimumLength =6,ErrorMessage =<span class="string">&quot;密码长度是6-16位&quot;</span>)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? Pwd &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        [<span class="meta">Required(ErrorMessage =<span class="string">&quot;请输入确认密码&quot;</span>),Compare(<span class="string">&quot;Pwd&quot;</span>,ErrorMessage =<span class="string">&quot;密码与确认密码不一致&quot;</span>)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? ConfirmPwd &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        [<span class="meta">Required(ErrorMessage =<span class="string">&quot;请输入昵称&quot;</span>)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? NickName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        [<span class="meta">Required(ErrorMessage =<span class="string">&quot;请输入邮箱&quot;</span>)</span>]</span><br><span class="line">        [<span class="meta">RegularExpression(<span class="string">&quot;^[A-Za-z0-9\u4e00-\u9fa5]+@[a-zA-Z0-9_-]+(.[a-zA-Z0-9_-]+)+$&quot;</span>,ErrorMessage =<span class="string">&quot;邮箱格式错误&quot;</span>)</span>]</span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">string</span>? Email &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>创建一个控制器器<code>UserInfo</code>，在该控制器中创建一个<code>create</code>方法，针对该方法创建一个视图</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">Create</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> View();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建的视图如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">@model UserInfoDTO <span class="comment">// 引入实体类</span></span><br><span class="line">@using (Html.BeginForm(<span class="string">&quot;CreateUser&quot;</span>,<span class="string">&quot;UserInfo&quot;</span>,FormMethod.Post,<span class="keyword">new</span> &#123;id=<span class="string">&quot;form1&quot;</span>&#125;))</span><br><span class="line">&#123;</span><br><span class="line">    &lt;table&gt;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">            &lt;td&gt;</span><br><span class="line">                @Html.Label(<span class="string">&quot;Account&quot;</span>,<span class="string">&quot;账号&quot;</span>)</span><br><span class="line">            &lt;/td&gt;</span><br><span class="line">            &lt;td&gt;</span><br><span class="line">                @Html.TextBoxFor(p=&gt;p.Account,<span class="keyword">new</span>&#123; autocomplete=<span class="string">&quot;off&quot;</span>&#125;)</span><br><span class="line">            &lt;/td&gt;</span><br><span class="line">            &lt;td&gt;</span><br><span class="line">                @Html.ValidationMessageFor(p=&gt;p.Account) <span class="comment">//展示错误信息</span></span><br><span class="line">            &lt;/td&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">            &lt;td&gt;</span><br><span class="line">                @Html.Label(<span class="string">&quot;Pwd&quot;</span>,<span class="string">&quot;密码&quot;</span>)</span><br><span class="line">            &lt;/td&gt;</span><br><span class="line">            &lt;td&gt;</span><br><span class="line">                @Html.PasswordFor(p=&gt;p.Pwd)</span><br><span class="line">            &lt;/td&gt;</span><br><span class="line">            &lt;td&gt;</span><br><span class="line">                @Html.ValidationMessageFor(p=&gt;p.Pwd)</span><br><span class="line">            &lt;/td&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line"></span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">            &lt;td&gt;</span><br><span class="line">                @Html.Label(<span class="string">&quot;ConfirmPwd&quot;</span>,<span class="string">&quot;重复密码&quot;</span>)</span><br><span class="line">            &lt;/td&gt;</span><br><span class="line">            &lt;td&gt;</span><br><span class="line">                @Html.PasswordFor(p=&gt;p.ConfirmPwd)</span><br><span class="line">            &lt;/td&gt;</span><br><span class="line">            &lt;td&gt;</span><br><span class="line">                @Html.ValidationMessageFor(p=&gt;p.ConfirmPwd) </span><br><span class="line">            &lt;/td&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">            &lt;td&gt;</span><br><span class="line">                @Html.Label(<span class="string">&quot;NickName&quot;</span>,<span class="string">&quot;昵称&quot;</span>)</span><br><span class="line">            &lt;/td&gt;</span><br><span class="line">            &lt;td&gt;</span><br><span class="line">                @Html.TextBoxFor(p=&gt;p.NickName,<span class="keyword">new</span>&#123; autocomplete=<span class="string">&quot;off&quot;</span>&#125;)</span><br><span class="line">            &lt;/td&gt;</span><br><span class="line">            &lt;td&gt;</span><br><span class="line">                @Html.ValidationMessageFor(p=&gt;p.NickName)</span><br><span class="line">            &lt;/td&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">            &lt;td&gt;</span><br><span class="line">                @Html.Label(<span class="string">&quot;Email&quot;</span>,<span class="string">&quot;邮箱&quot;</span>)</span><br><span class="line">            &lt;/td&gt;</span><br><span class="line">            &lt;td&gt;</span><br><span class="line">                @Html.TextBoxFor(p=&gt;p.Email,<span class="keyword">new</span>&#123; autocomplete=<span class="string">&quot;off&quot;</span>&#125;)</span><br><span class="line">            &lt;/td&gt;</span><br><span class="line">            &lt;td&gt;</span><br><span class="line">                @Html.ValidationMessageFor(p=&gt;p.Email)</span><br><span class="line">            &lt;/td&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">            &lt;td&gt;</span><br><span class="line">                &lt;input type=<span class="string">&quot;submit&quot;</span> <span class="keyword">value</span>=<span class="string">&quot;添加&quot;</span>/&gt;</span><br><span class="line">            &lt;/td&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">    &lt;/table&gt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    @section Scripts</span><br><span class="line">    &#123;</span><br><span class="line">    &lt;script src=<span class="string">&quot;~/lib/jquery-validation/dist/jquery.validate.min.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script src=<span class="string">&quot;~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在上面的代码中视图代码中，我们需要使用<code>HTML</code>的辅助标签。<code>TextBoxFor</code>会生成一个文本框，并且是强类型，关联实体类中某个具体的属性。</p>
<p>注意：这里还需要引入负责校验的<code>js</code>文件，并且一定要放在<code>@section Scripts</code>中。</p>
<p>启动项目进行测试(注意：这里一定要选择新创建的项目)</p>
<p>通过查看生成的<code>html</code>代码，我们就明白了以上校验的实现原理，就是给表单中的标签，添加了相应的属性，然后在<code>js</code>文件中会读取这些属性进行校验。</p>
<h3 id="6-2-服务端校验"><a href="#6-2-服务端校验" class="headerlink" title="6.2 服务端校验"></a>6.2 服务端校验</h3><p>在上一小节中，我们实现的校验是客户端校验，这一小节我们来看一下服务端校验。</p>
<p>在讲解服务端校验以前，我们还需要对客户端校验做一下完善。</p>
<p>例如：校验错误信息，一般会展示为红色。</p>
<p>通过查看返回的<code>HTML</code>代码，我们知道了错误信息都是放在了<code>span</code>标签中的。</p>
<p>所以在<code>Create.cshtml</code>这个视图中添加对应的<code>css</code>样式就可以了，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@model UserInfoDTO</span><br><span class="line">&lt;style&gt; <span class="comment">// 添加了样式</span></span><br><span class="line">    table span&#123;</span><br><span class="line">        color:red;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">@using (Html.BeginForm(<span class="string">&quot;CreateUser&quot;</span>,<span class="string">&quot;UserInfo&quot;</span>,FormMethod.Post,<span class="keyword">new</span> &#123;id=<span class="string">&quot;form1&quot;</span>&#125;))</span><br><span class="line">&#123;</span><br></pre></td></tr></table></figure>

<p>下面看一下服务端校验</p>
<p>在<code>UserInfoController.cs</code>文件中创建<code>CreateUser</code>这个方法。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">CreateUser</span>(<span class="params">UserInfoDTO userInfo</span>)</span></span><br><span class="line">      &#123;</span><br><span class="line">          <span class="comment">// 只有当UserInfoDTO中属性全部通过了校验，IsValid属性才会为true</span></span><br><span class="line">          <span class="keyword">if</span> (ModelState.IsValid)</span><br><span class="line">          &#123;</span><br><span class="line">              <span class="keyword">return</span> Content(<span class="string">&quot;ok&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          ModelState.AddModelError(<span class="string">&quot;&quot;</span>,<span class="string">&quot;数据输入错误!!&quot;</span>);<span class="comment">//第一个参数是key,可以不用填写</span></span><br><span class="line">          <span class="keyword">return</span> View(<span class="string">&quot;Create&quot;</span>,userInfo); <span class="comment">// 如果服务端没有通过校验，重新展示`create`视图，同时把数据在传递到该视图中，这样不需要用户重新填写表单，用户体验性好。</span></span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p><code>AddModelError</code>方法中指定的是服务端的错误信息，怎样展示呢？</p>
<p>返回到<code>Create.cshtml</code>这个视图中，添加如下代码：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@using (Html.BeginForm(<span class="string">&quot;CreateUser&quot;</span>,<span class="string">&quot;UserInfo&quot;</span>,FormMethod.Post,<span class="keyword">new</span> &#123;id=<span class="string">&quot;form1&quot;</span>&#125;))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 如果传递false,客户端校验的错误信息也会展示在这个位置,默认值是false/</span></span><br><span class="line">    @Html.ValidationSummary(<span class="literal">true</span>)</span><br></pre></td></tr></table></figure>

<p>这里可以添加<code>false</code>来进行演示一下。</p>
<p>这里打上断点，进行演示。</p>
<p>在输入正确的情况下，发现<code>IsValid</code>属性确实为<code>true</code>.</p>
<p>这里怎样演示<code>AddModelError</code>方法返回的服务端的错误信息呢？</p>
<p>这里，我们可以在添加一个业务，判断用户名是否重名。</p>
<p>修改后的<code>CreateUser</code>方法的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">CreateUser</span>(<span class="params">UserInfoDTO userInfo</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 只有当UserInfoDTO中属性全部通过了校验，IsValid属性才会为true</span></span><br><span class="line">            <span class="keyword">if</span> (ModelState.IsValid)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (userInfo.Account == <span class="string">&quot;admin&quot;</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    ModelState.AddModelError(<span class="string">&quot;&quot;</span>, <span class="string">&quot;用户名已经存在!!&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> View(<span class="string">&quot;Create&quot;</span>, userInfo);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> Content(<span class="string">&quot;ok&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            ModelState.AddModelError(<span class="string">&quot;&quot;</span>,<span class="string">&quot;数据输入错误!!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> View(<span class="string">&quot;Create&quot;</span>,userInfo);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>如果接收到的账号名是<code>admin</code>，这里给出一个“用户名已经存在的错误提示信息”。</p>
<h2 id="7、Asp-net-Core中依赖注入的使用"><a href="#7、Asp-net-Core中依赖注入的使用" class="headerlink" title="7、Asp.net Core中依赖注入的使用"></a>7、<code>Asp.net Core</code>中依赖注入的使用</h2><p>在前面的课程中，我们主要是在控制台中演示了怎样使用依赖注入，在这一小节中，我们看一下怎样在<code>.net core mvc</code>中怎样使用依赖注入。</p>
<p>当然，我们也可以在<code>WinForm</code>中使用。也就是依赖注入可以应用到<code>.net core</code>的任何项目中。</p>
<p>在这一小节中，我们看一下在<code>Asp.net core mvc</code>项目中实现依赖注入与控制台中的区别。</p>
<p>第一：在<code>Asp.net core</code>项目中一般不需要自己创建<code>ServiceCollection,IServiceProvider</code>.在<code>Program.cs</code>的<code>builder.Build()</code>方法之前向<code>builder.Services</code>中注入。</p>
<p>第二：在<code>Controller</code>中可以通过构造方法注入服务。</p>
<p>在项目的跟目录下面创建<code>Test</code>目录</p>
<p>在该目录下面创建<code>TestAdd.cs</code>类。该类中的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TestAdd</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">Add</span>(<span class="params"><span class="built_in">int</span> num1, <span class="built_in">int</span> num2</span>)</span> &#123; <span class="keyword">return</span> num1 + num2; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>Program.cs</code>中添加到容器中</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">builder.Services.AddScoped&lt;TestAdd&gt;();</span><br></pre></td></tr></table></figure>

<p>在控制器的构造方法中注入服务</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TestController</span> : <span class="title">Controller</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> TestAdd testAdd;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TestController</span>(<span class="params">TestAdd testAdd</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.testAdd = testAdd; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在对应的方法中进行测试，调用<code>testAdd</code>中的<code>Add</code>方法</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">Test3</span>()</span> &#123;</span><br><span class="line">    <span class="built_in">int</span> sum = testAdd.Add(<span class="number">3</span>, <span class="number">6</span>);</span><br><span class="line">    <span class="keyword">return</span> Content(sum.ToString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动项目进行测试</p>
<h2 id="8、AutoMapper应用"><a href="#8、AutoMapper应用" class="headerlink" title="8、AutoMapper应用"></a>8、<code>AutoMapper</code>应用</h2><p><code>KilgourNote:</code></p>
<blockquote>
<p>用于传递一个Model中的部分属性（有一些属性用不到，这样可以避免资源浪费）</p>
</blockquote>
<h3 id="8-1-AutoMapper使用1"><a href="#8-1-AutoMapper使用1" class="headerlink" title="8.1 AutoMapper使用1"></a>8.1 <code>AutoMapper</code>使用1</h3><p><code>AutoMapper</code>是一个库，可以实现的功能就是将一个对象映射到另外一个对象中,实现了一种自动映射的功能。</p>
<p>例如：如果<code>EF Core</code>中某个模型类中有10个属性，但是页面中只会展示5个属性对应的值，这时候，我们可以将<code>EF Core</code>中对应的模型类，映射成另外一个只需要5个属性的类。（如果自己实现映射，一般都是使用到了反射技术）</p>
<p>官方文档：<code>http://automapper.org/</code></p>
<p>案例文档：<code>https://docs.automapper.org/en/latest/</code></p>
<p>安装：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Install-Package AutoMapper.Extensions.Microsoft.DependencyInjection</span><br></pre></td></tr></table></figure>

<p>在安装以上包的时候，一定要注意选择新创建的项目。</p>
<p>下面看一下具体的实现。</p>
<p>在<code>Models</code>目录下面创建<code>UserInfoEditDTO.cs</code>这个实体类，该类中的代码，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserInfoEditDTO</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        [<span class="meta">Required(ErrorMessage = <span class="string">&quot;请输入账号&quot;</span>)</span>]</span><br><span class="line">        [<span class="meta">StringLength(16, MinimumLength = 3, ErrorMessage = <span class="string">&quot;账号是3-16位&quot;</span>)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? Account &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;       </span><br><span class="line"></span><br><span class="line">        [<span class="meta">Required(ErrorMessage = <span class="string">&quot;请输入昵称&quot;</span>)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? NickName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        [<span class="meta">Required(ErrorMessage = <span class="string">&quot;请输入邮箱&quot;</span>)</span>]</span><br><span class="line">        [<span class="meta">RegularExpression(<span class="string">&quot;^[A-Za-z0-9\u4e00-\u9fa5]+@[a-zA-Z0-9_-]+(.[a-zA-Z0-9_-]+)+$&quot;</span>, ErrorMessage = <span class="string">&quot;邮箱格式错误&quot;</span>)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? Email &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>在上面的代码中，没有包含密码与重复密码的属性。</p>
<p>也就是说，这里在进行编辑用户信息的时候，不需要用户名密码，也就是不对密码进行修改。</p>
<p>在上一小节中，我们创建了一个表单，是用来添加用户信息的，并且完成了校验操作。</p>
<p>先在如果我们要进行用户信息的编辑操作，并且不对用户的密码进行编辑。像这种情况，还是使用<code>UserInfoDTO.cs</code>这个类就会有问题，</p>
<p>因为，这个类中包含了对<code>用户密码</code>的校验，如果我们还是使用<code>UserInfoDTO.cs</code>这个实体类，在编辑的时候，表单在服务端无法校验通过。</p>
<p><strong>但是，这里我们最终数据完成修改保存的时候，使用的还是<code>UserInfoDTO.cs</code>这个实体类</strong>。所以这里我们需要将<code>UserInfoEditDTO</code></p>
<p>这个类映射成<code>UserInfoDTO.CS</code>这个类。</p>
<p>在项目的中创建目录：</p>
<p><code>Profiles</code>，在该目录下面创建一个文件叫做<code>UserInfoProfile.cs</code></p>
<p>该文件中完成相应的映射配置</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserInfoProfile</span>:<span class="title">Profile</span> <span class="comment">// 这里需要继承Profile</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserInfoProfile</span>()</span> &#123;</span><br><span class="line">        <span class="comment">// 创建映射关系(将`UserInfoEditDTO`映射成UserInfoDTO)</span></span><br><span class="line">        CreateMap&lt;UserInfoEditDTO,UserInfoDTO&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将<code>UserInfoProfile</code>注入到容器中。修改<code>Program.cs</code>文件中的代码</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Add services to the container.</span></span><br><span class="line">builder.Services.AddControllersWithViews();</span><br><span class="line"><span class="comment">/*builder.Services.AddAutoMapper(g =&gt;</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">    g.AddProfile&lt;UserInfoProfile&gt;();</span></span><br><span class="line"><span class="comment">&#125;);</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">builder.Services.AddAutoMapper(<span class="keyword">typeof</span>(UserInfoProfile));</span><br></pre></td></tr></table></figure>

<p>这里有两种写法，上面一种可以添加更多的配置，下面一种是简单的写法，使用的是默认的配置。</p>
<p>下面修改<code>UserInfo</code>控制器中的代码</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserInfoController</span> : <span class="title">Controller</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> IMapper mapper;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserInfoController</span>(<span class="params">IMapper mapper</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">this</span>.mapper = mapper;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里完成了对<code>IMpper</code>的注入操作。</p>
<p>同时创建<code>Eidt</code>方法，用来呈现修改用户信息的表单，这里假设修改的用户编号是1。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">Edit</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    UserInfoEditDTO user = <span class="keyword">new</span> UserInfoEditDTO&#123;</span><br><span class="line">        Id = <span class="number">1</span>,</span><br><span class="line">        Account = <span class="string">&quot;admin&quot;</span>,</span><br><span class="line">        Email = <span class="string">&quot;admin@126.com&quot;</span>,</span><br><span class="line">        NickName = <span class="string">&quot;aaa&quot;</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> View(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对应的视图代码：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">@model UserInfoEditDTO <span class="comment">// 注意这里导入的是UserInfoEditDTO</span></span><br><span class="line">&lt;style&gt;</span><br><span class="line">    table span &#123;</span><br><span class="line">        color: red;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">    <span class="comment">// 这里的方法名换成了EditUser</span></span><br><span class="line">@using (Html.BeginForm(<span class="string">&quot;EditUser&quot;</span>, <span class="string">&quot;UserInfo&quot;</span>, FormMethod.Post, <span class="keyword">new</span> &#123; id = <span class="string">&quot;form1&quot;</span> &#125;))</span><br><span class="line">&#123;</span><br><span class="line">               </span><br><span class="line">    @Html.ValidationSummary(<span class="literal">true</span>)</span><br><span class="line">    @Html.HiddenFor(p=&gt;p.Id); <span class="comment">// 这里创建了一个隐藏域来保存用户的编号</span></span><br><span class="line">    &lt;table&gt;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">            &lt;td&gt;</span><br><span class="line">                @Html.Label(<span class="string">&quot;Account&quot;</span>,<span class="string">&quot;账号&quot;</span>)</span><br><span class="line">            &lt;/td&gt;</span><br><span class="line">            &lt;td&gt;</span><br><span class="line">                @Html.TextBoxFor(p=&gt;p.Account,<span class="keyword">new</span>&#123; autocomplete=<span class="string">&quot;off&quot;</span>&#125;)</span><br><span class="line">            &lt;/td&gt;</span><br><span class="line">            &lt;td&gt;</span><br><span class="line">                @Html.ValidationMessageFor(p=&gt;p.Account)</span><br><span class="line">            &lt;/td&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">            &lt;td&gt;</span><br><span class="line">                @Html.Label(<span class="string">&quot;NickName&quot;</span>,<span class="string">&quot;昵称&quot;</span>)</span><br><span class="line">            &lt;/td&gt;</span><br><span class="line">            &lt;td&gt;</span><br><span class="line">                @Html.TextBoxFor(p=&gt;p.NickName,<span class="keyword">new</span>&#123; autocomplete=<span class="string">&quot;off&quot;</span>&#125;)</span><br><span class="line">            &lt;/td&gt;</span><br><span class="line">            &lt;td&gt;</span><br><span class="line">                @Html.ValidationMessageFor(p=&gt;p.NickName)</span><br><span class="line">            &lt;/td&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">            &lt;td&gt;</span><br><span class="line">                @Html.Label(<span class="string">&quot;Email&quot;</span>,<span class="string">&quot;邮箱&quot;</span>)</span><br><span class="line">            &lt;/td&gt;</span><br><span class="line">            &lt;td&gt;</span><br><span class="line">                @Html.TextBoxFor(p=&gt;p.Email,<span class="keyword">new</span>&#123; autocomplete=<span class="string">&quot;off&quot;</span>&#125;)</span><br><span class="line">            &lt;/td&gt;</span><br><span class="line">            &lt;td&gt;</span><br><span class="line">                @Html.ValidationMessageFor(p=&gt;p.Email)</span><br><span class="line">            &lt;/td&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">            &lt;td&gt;</span><br><span class="line">                &lt;input type=<span class="string">&quot;submit&quot;</span> <span class="keyword">value</span>=<span class="string">&quot;修改&quot;</span> /&gt;</span><br><span class="line">            &lt;/td&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">    &lt;/table&gt;</span><br><span class="line">&#125;</span><br><span class="line">@section Scripts</span><br><span class="line">    &#123;</span><br><span class="line">    &lt;script src=<span class="string">&quot;~/lib/jquery-validation/dist/jquery.validate.min.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script src=<span class="string">&quot;~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>EditUser</code>方法的实现，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">EditUser</span>(<span class="params">UserInfoEditDTO userInfo</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> user =mapper.Map&lt;UserInfoEditDTO,UserInfoDTO&gt;(userInfo);</span><br><span class="line">    <span class="keyword">if</span> (ModelState.IsValid)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//这里需要将user传递到数据层（在修改之前进行判断）</span></span><br><span class="line">        <span class="keyword">return</span> Json(user);  <span class="comment">// 可以看到user中包含了密码，但是值是null,所以在把user传递到数据层进行更新的时候，需要进行判断。</span></span><br><span class="line">    &#125;</span><br><span class="line">    ModelState.AddModelError(<span class="string">&quot;&quot;</span>, <span class="string">&quot;数据输入错误!!&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> View(<span class="string">&quot;Edit&quot;</span>, userInfo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里我们接收到编辑表单提交过滤的数据后，通过<code>Map</code>方法，映射到了<code>UserInfoDTO</code>中。</p>
<h3 id="8-2-AutoMapper应用2"><a href="#8-2-AutoMapper应用2" class="headerlink" title="8.2  AutoMapper应用2"></a>8.2  <code>AutoMapper</code>应用2</h3><p><strong>(1) <code>Profile</code>的配置</strong></p>
<p>处理手动添加<code>profile</code>，我们还可以自动扫描<code>profile</code> 程序集。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">builder.Services.AddAutoMapper(g =&gt;</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">/*g.AddProfile&lt;UserInfoProfile&gt;();*/</span></span><br><span class="line">g.AddMaps(<span class="keyword">new</span> [] &#123; <span class="string">&quot;WebApplication2&quot;</span> &#125;); <span class="comment">// 自动扫描WebApplication2这个程序集下面继承了Profile的类。</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*builder.Services.AddAutoMapper(typeof(UserInfoProfile));*/</span></span><br></pre></td></tr></table></figure>

<p><strong>（2） 前缀命名方式</strong></p>
<p>如果<code>Model</code>中实体类中的属性名含有一定的前缀(原有的项目不规范)。</p>
<p>我们自己定义的<code>ViewModel</code>中的属性名没有前缀，那么两者之间能够进行映射码？</p>
<p>为了进行测试，在项目中再次创建一个目录 :<code>AutomapModels</code></p>
<p>在该目录中创建一个<code>Product.cs</code>类文件，该文件中的测试代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">WebApplication2.AutomapModels</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Product</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? ShopProductName &#123; <span class="keyword">get</span>;<span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? ShopProductInfo &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ProductTwo</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? ProductName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>;&#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? ProductInfo &#123; <span class="keyword">get</span>; <span class="keyword">set</span>;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以看到<code>Product</code>这个类中的属性名称都是有前缀<code>Shop</code>的，那么能否映射到<code>ProductTwo</code>这个类中相应的属性上呢？</p>
<p>下面修改<code>Profiles/UserInfoProfile.cs</code>中的映射关系，如下：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserInfoProfile</span>:<span class="title">Profile</span> <span class="comment">// 注意：一个数据库对应一个profile</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">UserInfoProfile</span>()</span> &#123;</span><br><span class="line">            <span class="comment">// 创建映射关系</span></span><br><span class="line">            CreateMap&lt;UserInfoEditDTO,UserInfoDTO&gt;();</span><br><span class="line">            RecognizePrefixes(<span class="string">&quot;Shop&quot;</span>); <span class="comment">// 去掉前缀</span></span><br><span class="line">            CreateMap&lt;Product, ProductTwo&gt;(); <span class="comment">// 配置映射关系</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>在上面的配置中，我们通过<code>RecognizePrefixes</code>方法去掉了前缀，同时完成了相应的映射关系。</p>
<p>下面进行测试。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TestController</span> : <span class="title">Controller</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IMapper mapper;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">TestController</span>(<span class="params">IMapper mapper</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.mapper = mapper;</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Index</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> View();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Test1</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> product = <span class="keyword">new</span> Product</span><br><span class="line">            &#123;</span><br><span class="line">                ShopProductInfo = <span class="string">&quot;好的商品&quot;</span>,</span><br><span class="line">                ShopProductName = <span class="string">&quot;电脑&quot;</span>,</span><br><span class="line">            &#125;;</span><br><span class="line">           <span class="keyword">var</span> p = mapper.Map&lt;Product, ProductTwo&gt;(product);</span><br><span class="line">            <span class="keyword">return</span> Json(p);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这里创建了一个<code>Test</code>控制器。</p>
<p>创建了<code>Test1</code>这个方法，然后将<code>Product</code>映射成<code>ProductTwo</code>，发现是可以的。</p>
<p>去掉后缀的方式是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RecognizePostfixes(&quot;后缀&quot;)</span><br></pre></td></tr></table></figure>

<p><strong>(3) 集合映射</strong></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">Test2</span>()</span> &#123;</span><br><span class="line">         List&lt;Product&gt; products = <span class="keyword">new</span> List&lt;Product&gt;();</span><br><span class="line">          products.Add(<span class="keyword">new</span> Product</span><br><span class="line">          &#123;</span><br><span class="line">              ShopProductInfo = <span class="string">&quot;abc&quot;</span>,</span><br><span class="line">              ShopProductName = <span class="string">&quot;ddd&quot;</span>,</span><br><span class="line">          &#125;);</span><br><span class="line">          products.Add(<span class="keyword">new</span> Product</span><br><span class="line">          &#123;</span><br><span class="line">              ShopProductName = <span class="string">&quot;fff&quot;</span>,</span><br><span class="line">              ShopProductInfo = <span class="string">&quot;wwww&quot;</span>,</span><br><span class="line">          &#125;);</span><br><span class="line">          <span class="keyword">var</span> toList = mapper.Map&lt;List&lt;Product&gt;,List&lt;ProductTwo&gt;&gt;(products);</span><br><span class="line">          <span class="keyword">return</span> Json(toList);</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>在上面的代码中，我们创建了<code>products</code>这个<code>List</code>集合。</p>
<p>然后通过<code>Map</code>方法，实现了<code>List&lt;Product&gt;</code>到<code>List&lt;ProductTwo&gt;</code>的映射。</p>
<p><strong>(4) 手动控制成员的映射</strong></p>
<p>我们在<code>AutomapModels</code>这个目录下面创建<code>Student.cs</code>这个类文件，该文件中的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">WebApplication2.AutomapModels</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Student</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? Sex &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">StudentTwo</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> StuId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? StuName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? Gender &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里的<code>Student</code>类与<code>StudentTwo</code>类，发现所有的属性名字不一样，而且没有规律可循。</p>
<p>应该采用如下的映射方式。</p>
<p>修改<code>Profiles/UserInfoProfile.cs</code>文件中的代码，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">UserInfoProfile</span>()</span> &#123;</span><br><span class="line">           <span class="comment">// 创建映射关系</span></span><br><span class="line">           CreateMap&lt;UserInfoEditDTO,UserInfoDTO&gt;();</span><br><span class="line">           RecognizePrefixes(<span class="string">&quot;Shop&quot;</span>);            </span><br><span class="line">           CreateMap&lt;Product, ProductTwo&gt;();</span><br><span class="line">       <span class="comment">// 配置没有规律可言，而且名字又不一样的属性配置，如果有规律，并且属性名一样，则不需要这样配置。</span></span><br><span class="line">    <span class="comment">// 当然假如有10个属性，只有3个属性名不一样，其他都一样，只需要配置3个就可以了。</span></span><br><span class="line">           CreateMap&lt;Student, StudentTwo&gt;().ForMember(dest=&gt;dest.StuId,opt=&gt;opt.MapFrom(source=&gt;source.Id)).ForMember(dest=&gt;dest.StuName,opt=&gt;opt.MapFrom(source=&gt;source.Name)).ForMember(dest=&gt;dest.Gender,opt=&gt;opt.MapFrom(source=&gt;source.Name));   </span><br><span class="line">       &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里就是将<code>Student</code>映射到<code>StudentTwo</code>.<code>dest</code>表示目标对象，也就是<code>StudentTwo</code>,<code>source</code>表示来源对象，也就是<code>Student</code></p>
<p>这里是分别对每个属性进行映射的操作。</p>
<p>下面测试一下：</p>
<p>创建一个<code>Test3</code>方法，如下代码：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">Test3</span>()</span></span><br><span class="line">       &#123;</span><br><span class="line">           Student stu = <span class="keyword">new</span> Student() &#123; </span><br><span class="line">              Id = <span class="number">1</span>,</span><br><span class="line">              Name = <span class="string">&quot;Test&quot;</span>,</span><br><span class="line">              Sex = <span class="string">&quot;男&quot;</span></span><br><span class="line">           &#125;;</span><br><span class="line">           <span class="keyword">var</span> userTo = mapper.Map&lt;Student,StudentTwo&gt;(stu);</span><br><span class="line">           <span class="keyword">return</span> Json(userTo);</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>通过输出的结果，可以看到<code>Student</code>类中的属性的值都映射到了<code>StudentTwo</code>中各个属性上。</p>
<p><strong>（5）嵌套类映射</strong></p>
<p>某些成员可能是一个类，那么这个类也要配置映射。</p>
<p>下面修改<code>AutomapModels</code>目录下的<code>Product.cs</code>文件中的代码，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Product</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? ShopProductName &#123; <span class="keyword">get</span>;<span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? ShopProductInfo &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> Student? student &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; <span class="comment">// 这里添加了student属性，类型是Student类</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ProductTwo</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? ProductName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>;&#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? ProductInfo &#123; <span class="keyword">get</span>; <span class="keyword">set</span>;&#125;</span><br><span class="line">        <span class="keyword">public</span> StudentTwo? student &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; <span class="comment">// 这里添加了student属性，类型是StudentTwo</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>注意：在<code>Profiles/UserInfoProfile.cs</code>文件中，需要对<code>Prodct与ProductTwo</code>之间的映射进行配置，也需要对<code>Student</code>与<code>StudentTwo</code>之间的映射也要进行配置，当然，在前面我们已经完成了这些内容的配置，下面直接返回到控制器中创建方法进行测试。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">Test4</span>()</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">var</span> product = <span class="keyword">new</span> Product()</span><br><span class="line">           &#123;</span><br><span class="line">               ShopProductName = <span class="string">&quot;abc&quot;</span>,</span><br><span class="line">               ShopProductInfo = <span class="string">&quot;ddd&quot;</span>,</span><br><span class="line">               student = <span class="keyword">new</span> Student() <span class="comment">// 这里给student属性之间赋值了一个对象</span></span><br><span class="line">               &#123;</span><br><span class="line">                   Id = <span class="number">1</span>,</span><br><span class="line">                   Name = <span class="string">&quot;Test&quot;</span>,</span><br><span class="line">                   Sex = <span class="string">&quot;男&quot;</span></span><br><span class="line">               &#125;</span><br><span class="line">           &#125;;</span><br><span class="line">           <span class="keyword">var</span> two = mapper.Map&lt;Product, ProductTwo&gt;(product); <span class="comment">// 完成了映射</span></span><br><span class="line">           <span class="keyword">return</span> Json(two);</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>返回到浏览器中进行测试。</p>
<p><strong>（6）相互映射</strong></p>
<p>在<code>AutomapModels</code>文件夹下面在创建一个类文件<code>UserEntity.cs</code>,该文件中的代码，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserEntity</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">public</span> Guid UserId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">string</span>? UserName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">int</span> Age &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">int</span> Sex &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">int</span> IsActive &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="keyword">public</span> DateTime CreateDate &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserCreateInput</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">string</span>? UserName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">int</span> Age &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">int</span> Sex &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserCreateOutput</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">public</span> Guid UserId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">string</span>? UserName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">int</span> IsActive &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>修改<code>UserInfoProfile.cs</code>中的配置</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">UserInfoProfile</span>()</span> &#123;</span><br><span class="line">           <span class="comment">// 创建映射关系</span></span><br><span class="line">           CreateMap&lt;UserInfoEditDTO,UserInfoDTO&gt;();</span><br><span class="line">           RecognizePrefixes(<span class="string">&quot;Shop&quot;</span>);            </span><br><span class="line">           CreateMap&lt;Product, ProductTwo&gt;();</span><br><span class="line">           CreateMap&lt;Student, StudentTwo&gt;().ForMember(dest=&gt;dest.StuId,opt=&gt;opt.MapFrom(source=&gt;source.Id)).ForMember(dest=&gt;dest.StuName,opt=&gt;opt.MapFrom(source=&gt;source.Name)).ForMember(dest=&gt;dest.Gender,opt=&gt;opt.MapFrom(source=&gt;source.Sex));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 完成双向映射，需要使用ReverseMap方法</span></span><br><span class="line">           CreateMap&lt;UserCreateInput, UserEntity&gt;().ReverseMap();</span><br><span class="line"></span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>返回到控制器中进行测试，如下代码所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">Test5</span>()</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="comment">//输入参数UserCreateInput模拟</span></span><br><span class="line">           UserCreateInput input = <span class="keyword">new</span> UserCreateInput</span><br><span class="line">           &#123;</span><br><span class="line">               UserName = <span class="string">&quot;小张&quot;</span>,</span><br><span class="line">               Age = <span class="number">20</span>,</span><br><span class="line">               Sex = <span class="number">1</span></span><br><span class="line">           &#125;;</span><br><span class="line">           <span class="comment">//对输入参数UserCreateInput进行映射，映射成实体UserEntity</span></span><br><span class="line">           UserEntity user = mapper.Map&lt;UserCreateInput, UserEntity &gt;(input);</span><br><span class="line"></span><br><span class="line">           user.UserId = Guid.NewGuid();</span><br><span class="line">           user.IsActive = <span class="number">1</span>;</span><br><span class="line">           user.CreateDate = DateTime.Now;</span><br><span class="line">         <span class="comment">/*  user.UserName = &quot;小李&quot;;*/</span></span><br><span class="line">           <span class="comment">//对实体UserEntity进行映射，映射成输出参数UserCreateInput</span></span><br><span class="line">           <span class="keyword">var</span> output = mapper.Map&lt;UserCreateInput&gt;(user);</span><br><span class="line">           <span class="keyword">return</span> Json( <span class="keyword">new</span> &#123; output, user &#125;);</span><br><span class="line"></span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>在上面的代码中，我们创建了<code>UserCreateInput</code>对象，给该对象中的属性赋值，这里就相当于，获取用户的输入。</p>
<p>下面我们要将<code>UserCreateInput</code>映射到<code>UserEntity</code>，将其传递到数据层，进行数据的插入，在插入之前，将<code>UserEntity</code>中的其他属性</p>
<p>确定好值就可以了。</p>
<p>下面我们又将<code>UserEntity</code>映射到了<code>UserCreateInput</code>,这就相当于视图只展示<code>UserCreateInput</code>中的内容。</p>
<p><strong>（7）映射继承</strong></p>
<p>需要采用如下的方式进行映射：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> configuration = <span class="keyword">new</span> MapperConfiguration( c=&gt;&#123;</span><br><span class="line">    c.CreateMap&lt;ParentSource,ParentDestination&gt;().Include&lt;ChildSource,ChildDestination&gt;();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>这里需要先进行父类的映射，同时需要通过<code>Include</code>方法，包含子类的映射</p>
<p>这里不演示，关于其他的配置可以参考文档。</p>
<h2 id="9、缓存Cache"><a href="#9、缓存Cache" class="headerlink" title="9、缓存Cache"></a>9、缓存<code>Cache</code></h2><p>缓存（caching）是系统优化中简单又有效的工具，只要简单几行代码或者几个简单的配置，我们就可以利用缓存让系统的性能得到极大的提升</p>
<p><code>KilgourNote:</code></p>
<blockquote>
<ol>
<li>什么是缓存？（缓存有什么用？&#x2F;  缓存是用来干嘛的）<ul>
<li>缓存是用于解决用户频繁向数据库请求数据时的工具，具体体现在：当某一个数据频繁被用户请求访问时，在第一次被请求访问的时候将该数据存储在缓存中。这样下一次该数据被请求的时候可以直接从缓存中调出该数据而不再数据库中查找，不仅可以缓解数据库的压力，还可以提升访问速度。</li>
</ul>
</li>
<li>使用缓存有哪些问题？你该怎样解决？<ul>
<li>缓存主要有三大问题：缓存过期时间策略、缓存穿透问题、缓存雪崩问题</li>
<li>缓存过期时间策略：缓存是不会过期的，因此如何正确管理缓存以实现效率最大化是一大问题。并且当数据库中的数据发生了变化，而缓存中的保存的还是旧数据，这就会出现缓存中的数据与数据库中的数据不一致的情况。<ul>
<li>更新缓存有两种方法：第一种是绝对过期时间，也就是说给缓存数据设定一个生命周期，在该生命周期结束时无论该数据是否频繁被访问，时间一到立马清楚该缓存数据。第二种是滑动过期时间，滑动过期时间是在从数据库读取该数据，写入缓存时设定一个生命周期，缓存在该生命周期内没被访问则生命周期结束时清楚该缓存，如果在该生命周期内被访问则以被访问时间作为一个新的时间节点再设立一个生命周期，以此往复。</li>
<li>在策略选择方面，不存在优劣，需要根据具体情况选择适合的策略。比如在各个数据库数据访问频率相差不大的情况下优先选择绝对过期时间，如果在部分数据频繁被访问且数据库数据更新频率低的情况下优先选择滑动过期策略。</li>
</ul>
</li>
<li>缓存穿透问题：定义 + 解决办法</li>
<li>缓存雪崩问题：</li>
</ul>
</li>
</ol>
</blockquote>
<h3 id="9-1-什么是缓存"><a href="#9-1-什么是缓存" class="headerlink" title="9.1 什么是缓存"></a>9.1 什么是缓存</h3><p>缓存是一个用来保存数据的区域，从缓存区域中读取数据的速度比从数据源读取数据的速度快很多。在从数据源（如数据库）获取数据之后，我们可以把数据保存到缓存中，如下图所示：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C://Users/86159/Desktop/images/016.png"></p>
<p>下次再需要获取同样数据的时候，我们可以直接从缓存中获取之前保存的数据，而不需要再去数据源获取数据。</p>
<p>如下图所示：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C://Users/86159/Desktop/images/109.png"></p>
<p>由于从缓存中读取数据的速度比从数据源中读取数据的速度更快，因此使用缓存能提高系统数据的获取速度。如果从缓存中获取了要获取的数据，就叫作“缓存命中”；多次请求中，命中的请求占全部请求的百分比叫作“命中率”；如果数据源中的数据保存到缓存后，发生了变化，就会导致“缓存数据不一致”。</p>
<p>在<code>Web</code>开发中，存在着多级缓存，比如在浏览器端存在“浏览器端缓存”，在网关节点服务器中也可能存在“节点缓存”，在<code>Web</code>服务器上也可能存在“服务器端缓存”。对于用户发出的请求，只要在任何一个节点上命中缓存，请求就会直接返回，而不会继续向后传递。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C://Users/86159/Desktop/images/340.png"></p>
<p>问题：什么样式的数据适合使用缓存？</p>
<h3 id="9-2-客户端响应缓存"><a href="#9-2-客户端响应缓存" class="headerlink" title="9.2  客户端响应缓存"></a>9.2  客户端响应缓存</h3><p>假如浏览器向服务器请求<code>/Person/1</code>这个路径，如果服务器端给浏览器端的响应报文头中<code>cache-control</code>的值为<code>max-age=60</code>，则表示服务器指示浏览器端“可以缓存这个响应内容60s”。在60s内，如果用户要求浏览器再次向<code>/Person/1</code>发送请求的话，浏览器就可以直接使用保存的缓存内容，而不是向服务器再次发出请求。</p>
<p>在<code>ASP.NET Core</code>中，我们一般不需要手动控制响应报文头中的<code>cache-control</code>，只要给需要进行缓存控制的控制器的操作方法添加<code>ResponseCacheAttribute</code>这个<code>Attribute</code>即可，<code>ASP.NET Core</code>会根据<code>ResponseCacheAttribute</code>的设置来生成合适的&#96;cache-control	响应报文头。</p>
<p>下面进行演示</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">HttpGet</span>]</span><br><span class="line">       [<span class="meta">ResponseCache(Duration =20)</span>]</span><br><span class="line">       <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Test4</span>()</span> &#123;</span><br><span class="line">           <span class="keyword">return</span> Content(DateTime.Now.ToString()+<span class="string">&quot;abc&quot;</span>);</span><br><span class="line">       </span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>当我们第1次访问这个路径的时候，服务器端返回了当前的时间，从响应报文头中，我们看到了<code>cache-control</code>响应报文头，其中的<code>max-age</code>的值就是20，浏览器看到这个报文头之后，就会把响应内容缓存20s。</p>
<p>我们短时间内第2次向这个路径发送请求。我们发现，这次响应的【大小】中显示的是【磁盘缓存】，这表明这次响应是直接从浏览器缓存中获取的。因此这次的响应内容和第1次请求获得的响应内容一样。</p>
<p>稍等片刻，等20s的缓存时间过期之后，我们第3次向发送请求，。可以看到，这一次响应中的【大小】显示的是【<code>75B</code>】，而非【磁盘缓存】，这表明这次的响应内容不是直接从浏览器缓存中获取的。</p>
<p>默认情况下，<code>[ResponseCache]</code>设置只通过生成<code>cache-control</code>响应报文头来控制客户端缓存。如果客户端不支持客户端缓存，这个设置也是不生效的，毕竟是否使用缓存、如何使用缓存都是由客户端决定的，<code>cache-control</code>响应报文头只是一个“<strong>建议</strong>”而已。</p>
<h3 id="9-3-内存缓存"><a href="#9-3-内存缓存" class="headerlink" title="9.3 内存缓存"></a>9.3 内存缓存</h3><p>内存缓存就是一种把缓存的数据放到了应用程序内存中的机制。</p>
<p>内存缓存中保存的是一系列的键值对，就像<code>Dictionary</code>类型一样，每个不同的缓存内容具有不同的“缓存键”，每个缓存键对应一个“缓存值”。我们可以设置缓存的键值对，也可以根据缓存键取出缓存中保存的缓存值。</p>
<p>内存缓存的数据保存在当前运行的网站程序的内存中，是和进程相关的。因为在<code>Web</code>服务器中，多个不同网站是运行在不同的进程中的，所以不同网站的内存缓存是不会互相干扰的，而且网站重启后，内存缓存中的所有数据也就都被清空了。</p>
<p>在使用内存缓存的时候，我们主要使用<code>IMemoryCache接口</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C://Users/86159/Desktop/images/756.png"></p>
<p>在进行开发的时候，经常用到的就是“尝试获取缓存值，如果获取不到缓存值，则从数据源获取数据，然后将其保存到缓存中”这样的操作，而且一般从数据源获取数据都是比较消耗资源的，因此获取数据的方法通常都是异步方法。所以这里我们主要看一下<code>GetOrCreateAsync</code>方法的使用</p>
<p>下面看一下这些方法的应用（这里可以新创建一个项目进行演示）</p>
<p>在<code>Models</code>目录下面创建一个<code>Book.cs</code>类，代码如下：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">WebApplication4.Models</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Book</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? Title &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>同时在<code>Models</code>目录下面创建一个<code>DbContext.cs</code>，代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DbContext</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> Book? GetById(<span class="built_in">int</span> id)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">switch</span> (id)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> Book() &#123;Id=<span class="number">0</span>,Title=<span class="string">&quot;C#入门&quot;</span> &#125;;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> Book() &#123; Id = <span class="number">1</span>, Title = <span class="string">&quot;C#高级&quot;</span> &#125;;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> Book() &#123; Id = <span class="number">2</span>, Title = <span class="string">&quot;.net core&quot;</span> &#125;;</span><br><span class="line">                <span class="literal">default</span>:</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>说明：这里的<code>DbContext</code>并没有真正的链接数据库，为了简单，这里只是进行了模拟的操作。</p>
<p>在<code>Program.cs</code>文件中将缓存服务填充的容器中。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">builder.Services.AddControllersWithViews();</span><br><span class="line">builder.Services.AddMemoryCache(); <span class="comment">// 添加服务。</span></span><br></pre></td></tr></table></figure>

<p>下面在<code>TestController</code>控制器中注入服务，进行测试。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TestController</span> : <span class="title">Controller</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IMemoryCache memoryCache; <span class="comment">// 这里先将IMemoryCache注入进来</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">TestController</span>(<span class="params">IMemoryCache memoryCache</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.memoryCache = memoryCache;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Index</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> View();</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">// 该方法还没有使用缓存，每次请求，都是从数据库中进行查询</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Test</span>(<span class="params"><span class="built_in">int</span> id</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Book? book = DbContext.GetById(id);</span><br><span class="line">            <span class="keyword">if</span>(book == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">               <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123;StatusCode = <span class="number">404</span>,Msg = <span class="string">$&quot;找不到编号<span class="subst">&#123;id&#125;</span>的书&quot;</span> &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123; StatusCode = <span class="number">200</span>, book &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>输入地址<code>http://localhost:5122/test/test/10</code>没有找到，</p>
<p>输入<code>http://localhost:5122/test/test/1</code>可以找到对应的书</p>
<p>为了演示<code>GetOrCreateAsync</code>这个异步的方法，我们需要把<code>DbContext.cs</code>这个类中再来添加一个异步的方法。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DbContext</span></span><br><span class="line">   &#123;</span><br><span class="line">    <span class="comment">// 这里的GetByIdAsync方法只是模拟了异步的操作</span></span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">static</span> Task&lt;Book?&gt; GetByIdAsync(<span class="built_in">int</span> id)</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">var</span> result = GetById(id);</span><br><span class="line">           <span class="keyword">return</span> Task.FromResult(result);</span><br><span class="line">       &#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">static</span> Book? GetById(<span class="built_in">int</span> id)</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">switch</span> (id)</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                   <span class="keyword">return</span> <span class="keyword">new</span> Book() &#123;Id = <span class="number">0</span>,Title=<span class="string">&quot;C#入门&quot;</span> &#125;;</span><br><span class="line">               <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                   <span class="keyword">return</span> <span class="keyword">new</span> Book() &#123; Id = <span class="number">1</span>, Title = <span class="string">&quot;C#高级&quot;</span> &#125;;</span><br><span class="line">               <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                   <span class="keyword">return</span> <span class="keyword">new</span> Book() &#123; Id = <span class="number">2</span>, Title = <span class="string">&quot;.net core&quot;</span> &#125;;</span><br><span class="line">               <span class="literal">default</span>:</span><br><span class="line">                   <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>下面返回到控制器中修改<code>Test</code>方法中的代码</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">Test</span>(<span class="params"><span class="built_in">int</span> id</span>) <span class="comment">// 修改成Task</span></span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="comment">/* Book? book = DbContext.GetById(id);</span></span><br><span class="line"><span class="comment">            if(book == null)</span></span><br><span class="line"><span class="comment">            &#123;</span></span><br><span class="line"><span class="comment">                return Json(new &#123;StatusCode = 404,Msg = $&quot;找不到编号&#123;id&#125;的书&quot; &#125;);</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">            else</span></span><br><span class="line"><span class="comment">            &#123;</span></span><br><span class="line"><span class="comment">                return Json(new &#123; StatusCode = 200, book &#125;);</span></span><br><span class="line"><span class="comment">            &#125;*/</span></span><br><span class="line">    </span><br><span class="line">           <span class="comment">// GetOrCreateAsync方法：从缓存中获取数据，如果获取到了直接返回，如果没有从缓存中获取，执行后面的回调方法，从数据库中查询数据。</span></span><br><span class="line">           <span class="comment">// 将查询到的数据返回并且将数据保存到缓存中。</span></span><br><span class="line">          <span class="comment">// 注意：这里的key，这里是让每一本书都有一个单独的缓存的key. 如果换成了book，会出现什么情况呢？可以演示一下</span></span><br><span class="line">         <span class="comment">// 当然，这个key的取值，根据自己的实际情况来确定。</span></span><br><span class="line">           Book? book = <span class="keyword">await</span> memoryCache.GetOrCreateAsync(<span class="string">&quot;book&quot;</span> + id, <span class="keyword">async</span> (e) =&gt;</span><br><span class="line">           &#123;              </span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">await</span> DbContext.GetByIdAsync(id);</span><br><span class="line">           &#125;);</span><br><span class="line">           <span class="keyword">if</span>(book == <span class="literal">null</span>)</span><br><span class="line">           &#123;</span><br><span class="line">              </span><br><span class="line">               <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123; StatusCode = <span class="number">404</span>, Msg = <span class="string">$&quot;找不到编号<span class="subst">&#123;id&#125;</span>的书&quot;</span> &#125;);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">else</span></span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123; StatusCode = <span class="number">200</span>, book &#125;);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>在<code>DbContext</code>中的<code>GetById</code>方法中打上断点进行测试。</p>
<h3 id="9-4-缓存过期时间策略"><a href="#9-4-缓存过期时间策略" class="headerlink" title="9.4 缓存过期时间策略"></a>9.4 缓存过期时间策略</h3><p>在上一小节中，我们将数据放在了缓存中，缓存中的数据是不会过期的，除非应用程序重新启动或者是调用了<code>Remove</code>方法进行了删除,或者是调用<code>Set</code>方法修改缓存。（例如，向数据库中添加了一条记录或者是删除了一条记录，对应的完成缓存的修改，这也是比较常用的方式）</p>
<p>但是有一个问题：当数据库中的数据发生了变化，而缓存中的保存的还是旧数据，这就会出现缓存中的数据与数据库中的数据不一致的情况。</p>
<p>我们可以通过设置缓存的过期时间来解决缓存数据不一致的问题，当过期时间到来的时候，对应的缓存数据会从缓存中被清除。过期策略有“绝对过期时间”和“滑动过期时间”两种。绝对过期时间指的是自设置缓存之后的指定时间后，缓存项被清除；滑动过期时间指的是自设置缓存之后的指定时间后，如果对应的缓存数据没有被访问，则缓存项被清除，而如果在指定的时间内，对应的缓存数据被访问了一次，则缓存项的过期时间会自动续期。</p>
<p>我么先来看一下<strong>绝对过期时间的</strong>用法。</p>
<p>在<code>GetOrCreateAsync</code>方法的回调方法中有一个<code>ICacheEntry</code>类型的参数<code>e</code>，通过该参数，我们可以对当前的缓存进行更加详细的设置。在该该参数中有一个属性<code>AbsoluteExpirationRelativeToNow</code>,该属性的类型是<code>TimeSpan</code>类型。通过该属性可以用来设置缓存的绝对过期时间。</p>
<p>代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Book? book = <span class="keyword">await</span> memoryCache.GetOrCreateAsync(<span class="string">&quot;book&quot;</span> + id, <span class="keyword">async</span> (e) =&gt;</span><br><span class="line">          &#123;</span><br><span class="line">              e.AbsoluteExpirationRelativeToNow = TimeSpan.FromSeconds(<span class="number">10</span>); <span class="comment">// 指定了绝对过期时间，10秒钟以内都是有效的。</span></span><br><span class="line">            </span><br><span class="line">              <span class="keyword">return</span> <span class="keyword">await</span> DbContext.GetByIdAsync(id);</span><br><span class="line">          &#125;);</span><br></pre></td></tr></table></figure>

<p>在<code>DbContext</code>中的<code>GetById</code>方法中打上断点进行测试。</p>
<p><strong><code>滑动过期时间</code></strong></p>
<p>滑动过期时间指的是自设置缓存之后的指定时间后，如果对应的缓存数据没有被访问，则缓存项被清除，而如果在指定的时间内，对应的缓存数据被访问了一次，则缓存项的过期时间会自动延续。</p>
<p>我们可以通过<code>ICacheEntry</code>的<code>SlidingExpiration</code>属性来设置。如下代码所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Book? book = <span class="keyword">await</span> memoryCache.GetOrCreateAsync(<span class="string">&quot;book&quot;</span> + id, <span class="keyword">async</span> (e) =&gt;</span><br><span class="line">           &#123;</span><br><span class="line">               e.SlidingExpiration = TimeSpan.FromSeconds(<span class="number">10</span>);<span class="comment">// 设置滑动过期时间</span></span><br><span class="line">             </span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">await</span> DbContext.GetByIdAsync(id);</span><br><span class="line">           &#125;);</span><br></pre></td></tr></table></figure>

<p>综上所述，我们在选择内存缓存的过期时间策略的时候，如果缓存项的条数不多或者大部分缓存数据被访问的频率都差不多的话，我们可以使用绝对过期时间策略；如果只有部分数据访问频率比较高并且数据库中的数据不会被更新的话，我们可以使用滑动过期时间策略；</p>
<p>当然，无论用哪种过期时间策略，程序中都会存在缓存数据不一致的情况。对于有的系统，这种数据不一致的情况是可以接受的，比如我们把文章的点击量放到缓存中，就会存在文章被访问后没有立即显示新的点击量，而是几秒后等对应缓存项过期之后才更新显示，这个一般来讲是可以接受的。但是在有的系统中，这种延时是无法接受的，比如银行系统中用户的余额如果在用户转账后没有立即更新，则会有非常大的影响。对于这种无法接受缓存延时的系统，如果对应的从数据源获取数据的频率不高的话，可以不用缓存；如果我们需要用缓存提升性能的话，可以通过其他机制获取数据源改变的消息，再通过代码调用<code>IMemoryCache</code>的<code>Set</code>方法更新缓存。比如，在数据库系统中，我们可以通过触发器等机制来实现当数据库中的数据发生更新的时候，触发我们编写的程序来更新缓存中的代码。</p>
<h3 id="9-5-缓存穿透问题"><a href="#9-5-缓存穿透问题" class="headerlink" title="9.5 缓存穿透问题"></a>9.5 缓存穿透问题</h3><p>在使用内存缓存的时候，如果处理不当，我们容易遇到“缓存穿透”的问题。我们注意到，<code>IMemoryCache</code>接口中有一个<code>Get(object key)</code>方法，它用来根据缓存键<code>key</code>查找缓存值，如果找不到缓存项，则方法会返回null等默认值。了解到这点，有的开发人员就用如代码如下所示的方法来使用缓存。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;ActionResult&lt;Book?&gt;&gt; Demo5(Guid id) <span class="comment">// 1000  </span></span><br><span class="line"> &#123;</span><br><span class="line">   <span class="built_in">string</span> cacheKey = <span class="string">&quot;Book&quot;</span> + id;             <span class="comment">//缓存键</span></span><br><span class="line">   Book? b = memCache.Get&lt;Book?&gt;(cacheKey);</span><br><span class="line">    <span class="keyword">if</span>(b==<span class="literal">null</span>)                                <span class="comment">//如果缓存中没有数据</span></span><br><span class="line">   &#123;</span><br><span class="line">                                               <span class="comment">//查询数据库，然后写入缓存</span></span><br><span class="line">       b = <span class="keyword">await</span> dbCtx.Books.FindAsync(id);</span><br><span class="line">     </span><br><span class="line">             memCache.Set(cacheKey, b);</span><br><span class="line">     </span><br><span class="line">       </span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span>(b==<span class="literal">null</span>)                                <span class="comment">//如果仍然没找到数据</span></span><br><span class="line">      <span class="keyword">return</span> NotFound(<span class="string">&quot;找不到这本书&quot;</span>);</span><br><span class="line">   <span class="keyword">else</span></span><br><span class="line">      <span class="keyword">return</span> b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的程序的逻辑很简单：首先从缓存中查询是否有图书ID对应的缓存内容，如果<code>Get</code>方法返回<code>null</code>，则说明缓存中没有对应的数据，需要我们去数据库中查询，并且把查询的结果写入缓存。如果<code>b</code>仍然为<code>null</code>，说明缓存和数据库中都没有这条数据，程序就向客户端报告“这条数据找不到”。</p>
<p>这个程序能够正常执行，但是存在一个缺陷。对于大部分正常请求，客户端发送的<code>ID</code>都是存在的图书<code>ID</code>，因此这些图书的信息都会保存到缓存中，之后无论有多少次针对这个<code>ID</code>的访问，程序都不再需要查询数据库，因此数据库的压力非常小。但是针对在数据库中不存在的图书<code>ID</code>，在缓存中是不会保存任何信息的,所以从缓存中查询的结果赋值给变量b的时候，<code>b</code>的是<code>null</code>，这样又查询数据库了。</p>
<p>如果有恶意的用户使用不存在的图书<code>ID</code>发送大量的请求，这样的请求就会一致执行数据库查询的代码，因此数据库就会承受非常大的压力，甚至可能会导致数据库服务器的崩溃，这种问题就叫做缓存穿透。</p>
<p>缓存穿透是由于“查询不到的数据用null表示”导致的，因此解决的思路也很简单，就是我们把“查不到”也当成数据放入缓存</p>
<p>在日常开发中只要使用<code>GetOrCreateAsync</code>方法即可，因为这个方法会把<code>null</code>也当成合法的缓存值.这样就可以避免缓存穿透的问题了。</p>
<h3 id="9-6-缓存雪崩问题"><a href="#9-6-缓存雪崩问题" class="headerlink" title="9.6 缓存雪崩问题"></a>9.6 缓存雪崩问题</h3><p>在使用缓存的时候，有时会有在很短时间内，程序把一大批数据从数据源加入缓存的情况。比如为了提升网站的运行速度，我们会对数据进行“预热”，也就是在网站启动的时候把一部分数据从数据库中读取出来并加入缓存。如果这些数据设置的过期时间都相同，到了过期时间的时候，缓存项会集中过期，因此又会导致大量的数据库请求，这样数据库服务器就会出现周期性的压力，这种陡增的压力甚至会把数据库服务器“压垮”（崩溃），当数据库服务器从崩溃中恢复后，这些压力又压了过来，从而造成数据库服务器反复崩溃、恢复，这就是数据库服务器的“雪崩”。</p>
<p>解决这个问题的思路也很简单，那就是写缓存时，在基础过期时间之上，再加一个随机的过期时间，这样缓存项的过期时间就会均匀地分布在一个时间段内，就不会出现缓存集中一个时间点全部过期的情况了。</p>
<p>例如：每条数据存到缓存中的时候，时间是随机，例如5到10秒之间。有可能100条是5秒过期，50条是6秒过期，300条是8秒过期。</p>
<p>也就是存储到缓存中的数据过期时间分布到了一个时间段内。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Book? book = <span class="keyword">await</span> memoryCache.GetOrCreateAsync(<span class="string">&quot;book&quot;</span> + id, <span class="keyword">async</span> (e) =&gt;</span><br><span class="line">          &#123;</span><br><span class="line">             <span class="comment">// 过期时间，分布到了10,20</span></span><br><span class="line">              e.AbsoluteExpirationRelativeToNow = TimeSpan.FromSeconds(Random.Shared.Next(<span class="number">10</span>,<span class="number">20</span>));</span><br><span class="line">            </span><br><span class="line">              <span class="keyword">return</span> <span class="keyword">await</span> DbContext.GetByIdAsync(id);</span><br><span class="line">          &#125;);</span><br></pre></td></tr></table></figure>

<p>在使用内存缓存的时候，我们除了要规避缓存雪崩等问题，还有其他一些问题需要注意。内存缓存中保存的是被缓存对象的引用，因此我们可以把任意.NET对象保存到内存缓存中，不过在实际使用的时候，有一些问题需要注意。比如<code>IQueryable、IEnumerable</code>等类型可能存在延迟加载的问题，如果把这两种类型的变量指向的对象保存到内存缓存中，在把它们取出来再去执行的时候，如果它们延迟加载时需要的对象已经被释放，就会执行失败。因此，这两种类型的变量指向的对象在保存到内存缓存之前，最好将其转换为数组或者List<T>类型，从而强制数据立即加载。</p>
<h2 id="10、Filter"><a href="#10、Filter" class="headerlink" title="10、Filter"></a>10、<code>Filter</code></h2><p><code>Filter</code>（筛选器，也可以称作过滤器），是<code>Asp.net Core</code>中提供的一种面向切面编程的机制(<code>AOP</code>)。</p>
<p>可以实现在<code>.net core</code>特定的位置执行我们自己定义的代码，比如在控制器中方法执行之前进行数据校验等。</p>
<p>在<code>Asp.net core</code>中的<code>Filter</code>分为5种类型，分别是<code>Authorization filter(授权筛选器),Resource filter（资源筛选器）,Action filter（操作筛选器）,Exception filter（异常筛选器）,Result filter（结果筛选器）</code></p>
<p>在进行项目开发的时候，我们一般配置授权策略或编写自定义授权策略，而不是编写自定义授权筛选器，只有在需要自定义授权框架时才会用到自定义授权筛选器。类似的道理也适用于资源筛选器和结果筛选器</p>
<p>所以这里，我们重点看一下<code>异常筛选器</code>和<code>操作筛选器</code></p>
<p>所有筛选器一般有同步和异步两个版本，比如同步操作筛选器实现<code>IActionFilter</code>接口，而异步操作筛选器实现<code>IAsyncActionFilter</code>接口。在大部分场景下，异步筛选器的性能更好，而且可以支持在实现类中编写异步调用的代码,所以建议大家使用异步方式。</p>
<h3 id="10-1-异常筛选器"><a href="#10-1-异常筛选器" class="headerlink" title="10.1  异常筛选器"></a>10.1  异常筛选器</h3><p>当系统中出现未经处理的异常的时候，异常筛选器就会执行，我们可以在异常筛选器中对异常进行处理。（如果不这样处理，按照传统的处理方式，需要再控制器的方法中，通过<code>try...catch</code>来进行处理，这样后期难以维护，同时写大量重复代码）</p>
<p>我们先来看一下<code>.net core mvc</code>怎样展示异常信息的。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">Test6</span>()</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="built_in">int</span> i = <span class="number">10</span>;</span><br><span class="line">           <span class="built_in">int</span> j = <span class="number">0</span>;</span><br><span class="line">           <span class="built_in">double</span> n = i / j;</span><br><span class="line">           <span class="keyword">return</span> Content(n.ToString());</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>执行上面的代码，会出现异常，整个页面中会出现堆栈的错误信息。这是不行的，会暴露我们服务器的信息。</p>
<p>我们希望能够呈现出我们自己定义的错误提示信息，并且能够将错误的堆栈信息保存到日志文件中，方便后续的调试维护。</p>
<p>在项目中创建<code>Filters</code>文件夹，在该文件夹中创建<code>MyExceptionFilter.cs</code>,该类中的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyExceptionFilter</span> : <span class="title">IAsyncExceptionFilter</span> <span class="comment">// 这里实现了IAsyncExceptionFilter接口</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> IWebHostEnvironment webHostEnvironment;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyExceptionFilter</span>(<span class="params">IWebHostEnvironment webHostEnvironment</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">this</span>.webHostEnvironment = webHostEnvironment;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Task <span class="title">OnExceptionAsync</span>(<span class="params">ExceptionContext context</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// ExceptionContext:中有三个属性</span></span><br><span class="line">        <span class="comment">// Exception :代表异常信息对象</span></span><br><span class="line">        <span class="comment">// ExceptionHandled:该属性值为true,表示当前的异常已经处理了，则其他的ExceptionFilter不会在进行处理.但是当前我们创建的MyExceptionFilter只是处理异常，不记录到日志中，你想通过另外一个Filter来完成日志的记录，就不能设置改属性的值为true</span></span><br><span class="line">        <span class="comment">// Result:该属性的类型是IActionResult接口，表示该属性的值可以返回给客户端,生成的是json格式</span></span><br><span class="line">        <span class="built_in">string</span> msg = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (webHostEnvironment.IsDevelopment()) <span class="comment">// 开发环境</span></span><br><span class="line">        &#123;</span><br><span class="line">            msg=context.Exception.ToString(); <span class="comment">// 记录完整的错误堆栈信息</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            msg = <span class="string">&quot;服务端发生了未处理的异常&quot;</span>; <span class="comment">// 在生产环境返回的信息</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ObjectResult是.net core中内置的类，实现了IActionResult接口</span></span><br><span class="line">        ObjectResult objectResult = <span class="keyword">new</span> ObjectResult(<span class="keyword">new</span> &#123; code = <span class="number">500</span>, message = msg &#125;);</span><br><span class="line">        context.Result = objectResult;</span><br><span class="line">        context.ExceptionHandled = <span class="literal">true</span>;    </span><br><span class="line">        <span class="keyword">return</span> Task.CompletedTask;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将<code>MyExceptionFilter</code>注入到容器中。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">builder.Services.Configure&lt;MvcOptions&gt;(opt =&gt; &#123;</span><br><span class="line"></span><br><span class="line">    opt.Filters.Add&lt;MyExceptionFilter&gt;();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>当我们启动项目的时候，这时候是开发环境，访问前面的<code>Test6</code>方法，出现异常，对应的异常堆栈信息展示到浏览器中。</p>
<p>下面测试生产环境。在项目名称上右击，选择–“属性”，在弹出的窗口中选择“调试–常规”，单击“打开调试启动配置文件<code>UI</code>”,去掉<code>环境变量中</code>的配置。</p>
<p>再次启动项目，这时候是生产环境，对应的浏览器中，展示的就是<code>服务端发生了未处理的异常</code></p>
<p><strong>下面添加日志功能，将异常信息记录到日志中（<code>NLog</code>）。</strong></p>
<p>在项目中安装日志所需要的包：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Install-Package Microsoft.Extensions.Logging // 这是日志系统的核心包，不管是将日志输出到控制台还是文件等，都需要安装</span><br><span class="line">Install-Package NLog.Extensions.Logging </span><br></pre></td></tr></table></figure>

<p>在项目的跟目录下面创建<code>nlog.config</code>配置文件，并且“选择较新则复制”。</p>
<p>该文件中的配置信息：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span> ?&gt;</span><br><span class="line">&lt;!-- XSD manual extracted <span class="keyword">from</span> package NLog.Schema: https:<span class="comment">//www.nuget.org/packages/NLog.Schema--&gt;</span></span><br><span class="line">&lt;nlog xmlns=<span class="string">&quot;http://www.nlog-project.org/schemas/NLog.xsd&quot;</span> xsi:schemaLocation=<span class="string">&quot;NLog NLog.xsd&quot;</span></span><br><span class="line">      xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">      autoReload=<span class="string">&quot;true&quot;</span></span><br><span class="line">      internalLogFile=<span class="string">&quot;console-example-internal.log&quot;</span></span><br><span class="line">      internalLogLevel=<span class="string">&quot;off&quot;</span> &gt;</span><br><span class="line"></span><br><span class="line">	&lt;!-- the targets to write to --&gt;</span><br><span class="line">	&lt;targets&gt;</span><br><span class="line">		&lt;!-- write logs to file --&gt;</span><br><span class="line">		&lt;!--这里修改了fileName属性的值，日志文件都放在了logs目录下面，同时文件名称以log-为前缀，假设日期作为日志文件的名称--&gt;</span><br><span class="line">		&lt;target xsi:type=<span class="string">&quot;File&quot;</span> name=<span class="string">&quot;logfile&quot;</span> fileName=<span class="string">&quot;logs/log-$&#123;shortdate&#125;.log&quot;</span></span><br><span class="line">				layout=<span class="string">&quot;$&#123;longdate&#125;|$&#123;level&#125;|$&#123;message&#125; |$&#123;all-event-properties&#125; $&#123;exception:format=tostring&#125;&quot;</span> /&gt;</span><br><span class="line">		</span><br><span class="line">		</span><br><span class="line">	&lt;/targets&gt;</span><br><span class="line"></span><br><span class="line">	&lt;!-- rules to map <span class="keyword">from</span> logger name to target --&gt;</span><br><span class="line">	&lt;!--这里修改了rules规则--&gt;</span><br><span class="line">	&lt;!--SystemFile:表示命名空间--&gt;</span><br><span class="line">	&lt;rules&gt;</span><br><span class="line">		&lt;logger name=<span class="string">&quot;*&quot;</span> minlevel=<span class="string">&quot;Warn&quot;</span> writeTo=<span class="string">&quot;logfile&quot;</span>/&gt;</span><br><span class="line">		</span><br><span class="line">		</span><br><span class="line">	&lt;/rules&gt;</span><br><span class="line">&lt;/nlog&gt;</span><br></pre></td></tr></table></figure>

<p>注入服务(<code>Program</code>)：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">builder.Services.Configure&lt;MvcOptions&gt;(opt =&gt; &#123;</span><br><span class="line"></span><br><span class="line">    opt.Filters.Add&lt;MyExceptionFilter&gt;();</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 将日志注入到容器中</span></span><br><span class="line">builder.Services.AddLogging(log =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    log.AddNLog();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyExceptionFilter</span> : <span class="title">IAsyncExceptionFilter</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> IWebHostEnvironment webHostEnvironment;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> ILogger&lt;MyExceptionFilter&gt; logger;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyExceptionFilter</span>(<span class="params">IWebHostEnvironment webHostEnvironment, ILogger&lt;MyExceptionFilter&gt; logger</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">this</span>.webHostEnvironment = webHostEnvironment;</span><br><span class="line">        <span class="keyword">this</span>.logger = logger;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>在上面的代码中，注入了<code>ILogger</code></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Task <span class="title">OnExceptionAsync</span>(<span class="params">ExceptionContext context</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">          </span><br><span class="line">      <span class="comment">// 将获取到异常信息写到日志中</span></span><br><span class="line">           Exception exception = context.Exception;</span><br><span class="line">           logger.LogError(exception.ToString());</span><br><span class="line">    </span><br><span class="line">           <span class="built_in">string</span> msg = <span class="string">&quot;&quot;</span>;</span><br><span class="line">           <span class="keyword">if</span> (webHostEnvironment.IsDevelopment())</span><br><span class="line">           &#123;</span><br><span class="line">               msg=context.Exception.ToString();</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">else</span></span><br><span class="line">           &#123;</span><br><span class="line">               msg = <span class="string">&quot;服务端发生了未处理的异常&quot;</span>;</span><br><span class="line">               </span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">// ObjectResult是.net core中内置的类，实现了IActionResult接口</span></span><br><span class="line">           ObjectResult objectResult = <span class="keyword">new</span> ObjectResult(<span class="keyword">new</span> &#123; code = <span class="number">500</span>, message = msg &#125;);</span><br><span class="line">           context.Result = objectResult;</span><br><span class="line">           context.ExceptionHandled = <span class="literal">true</span>;    </span><br><span class="line">           <span class="keyword">return</span> Task.CompletedTask;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>启动项目进行测试。日志文件在<code>.bin/debug</code>目录下面。</p>
<h3 id="10-2-ActionFilter基本使用"><a href="#10-2-ActionFilter基本使用" class="headerlink" title="10.2 ActionFilter基本使用"></a>10.2 <code>ActionFilter</code>基本使用</h3><p><code>ActionFilter</code>(操作筛选器)，可以在控制器的方法执行的时候，都会被执行，我们可以在<code>ActionFilter</code>中完成控制器中方法执行之前与执行之后的一些操作。</p>
<p>操作筛选器一般实现<code>IAsyncActionFilter</code>接口,，这个接口中定义了<code>OnActionExecutionAsync</code>方法</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Task <span class="title">OnActionExecutionAsync</span>(<span class="params">ActionExecutingContext context, ActionExecutionDelegate next</span>)</span></span><br></pre></td></tr></table></figure>

<p>其中，context参数代表<code>Action</code>执行的上下文对象，从<code>contex</code>t中我们可以获取请求的路径、参数值等信息；<code>next</code>参数代表下一个要执行的操作筛选器。一个项目中可以注册多个操作筛选器，这些操作筛选器组成一个链，上一个筛选器执行完了再执行下一个。<code>nex</code>t就是一个用来指向下一个操作筛选器的委托，如果当前的操作筛选器是最后一个筛选器的话，<code>next</code>就会执行要执行的控制器方法.</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C://Users/86159/Desktop/images/533.png"></p>
<p>当控制器中的方法执行完毕以后，又会执行最后一个筛选器3，然后在执行筛选器2，筛选器1.</p>
<p>在<code>Filters</code>目录中创建<code>MyActionFilter1.cs</code>，该文件中的代码，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyActionFilter1</span> : <span class="title">IAsyncActionFilter</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">OnActionExecutionAsync</span>(<span class="params">ActionExecutingContext context, ActionExecutionDelegate next</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;MyActionFilter1--开始执行之前&quot;</span>);</span><br><span class="line">            <span class="comment">// next 方法用来执行下一个ActionFilter,如果这是最后一个ActionFilter,它就会执行控制器中实际的方法。</span></span><br><span class="line">            <span class="comment">// next 方法之前的代码是在执行控制器中方法执行之前要执行的代码，而next方法之后的代码是在控制器中方法执行之后要执行的代码。</span></span><br><span class="line">            ActionExecutedContext r = <span class="keyword">await</span> next();</span><br><span class="line">            <span class="keyword">if</span>(r.Exception != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;MyActionFilter1--执行失败&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;MyActionFilter1--执行成功&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><code>next</code>方法的返回值是控制器中方法的执行结果，返回值类型是<code>ActionExecutedContext</code>,如果控制器中的方法执行的时候出现了未处理的异常，那么<code>ActionExecutedContext</code>的<code>Exception</code>属性就是异常对象。</p>
<p><code>ActionExecutedContext</code>的<code>Result</code>属性就是操作方法的执行结果。</p>
<p>下面将其添加到容器中。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">builder.Services.Configure&lt;MvcOptions&gt;(opt =&gt; &#123;</span><br><span class="line"></span><br><span class="line">    opt.Filters.Add&lt;MyExceptionFilter1&gt;();</span><br><span class="line">    opt.Filters.Add&lt;MyActionFilter1&gt;();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>下面在<code>Test</code>控制器中在创建一个测试的方法<code>Test7</code>,代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">Test7</span>()</span></span><br><span class="line">     &#123;</span><br><span class="line">         Console.WriteLine(<span class="string">&quot;Test7&quot;</span>);</span><br><span class="line">         <span class="keyword">return</span> Content(<span class="string">&quot;hello world&quot;</span>);</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>

<p>下面在控制台中查看结果，因为这里为了方便查看执行的过程，使用了<code>Console.WriteLine</code>方法来打印结果。（注意：由于我们启动项目的时候，首页控制器中对应的方法会被执行，也会执行上面我们定义的<code>ActionFilter</code>）</p>
<p>在<code>Filters</code>目录下面在创建一个<code>MyActionFilter2.cs</code>,该类中的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyActionFilter2</span>: <span class="title">IAsyncActionFilter</span></span><br><span class="line">  &#123;</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">OnActionExecutionAsync</span>(<span class="params">ActionExecutingContext context, ActionExecutionDelegate next</span>)</span></span><br><span class="line">      &#123;</span><br><span class="line">          Console.WriteLine(<span class="string">&quot;MyActionFilter2--开始执行之前&quot;</span>);</span><br><span class="line">          <span class="comment">// next 方法用来执行下一个ActionFilter,如果这是最后一个ActionFilter,它就会执行控制器中实际的方法。</span></span><br><span class="line">          <span class="comment">// next 方法之前的代码是在执行控制器中方法执行之前要执行的代码，而next方法之后的代码是在控制器中方法执行之后要执行的代码。</span></span><br><span class="line">          ActionExecutedContext r = <span class="keyword">await</span> next();</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (r.Exception != <span class="literal">null</span>)</span><br><span class="line">          &#123;</span><br><span class="line">              Console.WriteLine(<span class="string">&quot;MyActionFilter2--执行失败&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">              Console.WriteLine(<span class="string">&quot;MyActionFilter2--执行成功&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>下面将其添加到容器中完成注册</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">builder.Services.Configure&lt;MvcOptions&gt;(opt =&gt; &#123;</span><br><span class="line"></span><br><span class="line">    opt.Filters.Add&lt;MyExceptionFilter1&gt;();</span><br><span class="line">    opt.Filters.Add&lt;MyActionFilter1&gt;();</span><br><span class="line">    opt.Filters.Add&lt;MyActionFilter2&gt;();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>重新访问<code>Test</code>控制器中的<code>test7</code>方法，来查看<code>ActionFilter</code>的执行链情况。</p>
<h3 id="10-3-ActionFilter案例"><a href="#10-3-ActionFilter案例" class="headerlink" title="10.3 ActionFilter案例"></a>10.3 <code>ActionFilter</code>案例</h3><h4 id="10-3-1-TransactionScope事务"><a href="#10-3-1-TransactionScope事务" class="headerlink" title="10.3.1 TransactionScope事务"></a>10.3.1 <code>TransactionScope</code>事务</h4><p>我们知道，控制器中的方法，最终会调用数据层中的方法，完成数据库的操作。</p>
<p>例如：有一个回款的业务场景，我们需要用户<code>A</code>的钱数减去对应的值，然后在给<code>B</code>用户添加对应的钱数。这个操作就需要使用到事务。</p>
<p>我们知道，数据库事务有一个非常重要的特性，那就是“原子性”，它保证了我们对数据库的多个操作要么全部成功、要么全部失败，进而帮助我们保证业务数据的正确性。但是，事务的使用是比较麻烦的，需要我们手工启用、提交及回滚事务，<strong>我们的业务代码中会充斥着事务管理的代码</strong>。本小节将实现一个对于数据库操作自动启用事务的操作筛选器。</p>
<p>我们可以使用<code>TransactionScope</code>简化事务代码的编写。<code>TransactionScope</code>是<code>.NET</code>中用来标记一段支持事务的代码的类。<code>EF Core</code>对<code>TransactionScope</code>提供了天然的支持，当一段使用<code>EF Core</code>进行数据库操作的代码放到<code>TransactionScope</code>声明的范围中的时候，这段代码就会自动被标记为“支持事务”。</p>
<p><code>TransactionScope</code>实现了<code>IDisposable</code>接口，如果一个<code>TransactionScope</code>的对象没有调用<code>Complete</code>就执行了<code>Dispose</code>方法，则事务会被回滚，否则事务就会被提交。<code>TransactionScope</code>还支持嵌套式事务，也就是多个<code>TransactionScope</code>嵌套，只有最外层的<code>TransactionScope</code>提交了事务，所有的操作才生效；如果最外层的<code>TransactionScope</code>回滚了事务，那么即使内层的<code>TransactionScope</code>提交了事务，最终所有的操作仍然会被回滚。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">关于嵌套的理解；</span><br><span class="line">A() 方法有数据库操作</span><br><span class="line">B()  有数据库操作</span><br><span class="line">C() 有数据库操作</span><br><span class="line"></span><br><span class="line">D()&#123;</span><br><span class="line">  A()</span><br><span class="line">  C()</span><br><span class="line">&#125;</span><br><span class="line">E()&#123;</span><br><span class="line">  D()</span><br><span class="line">  A()</span><br><span class="line">&#125;</span><br><span class="line">Main()&#123;</span><br><span class="line">// 开启事务</span><br><span class="line">  TransactionScope&#123;</span><br><span class="line">   D()</span><br><span class="line">   E();  ----假如C方法中的数据库操作出现了异常，整个会进行回滚。假如A方法中也开始事务（属于内层事务），并且提交了，但是Main函数中的事务（属于外层事务）回滚了，则整个事务回滚，也就是A方法中的事务最终也会回滚，即使提交了也无效</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里新创建一个<code>MVC</code>项目进行测试。</p>
<p>在新创建的<code>MVC</code>项目中安装<code>EF Core</code>的包</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Install-Package Microsoft.EntityFrameworkCore.SqlServer</span><br><span class="line">Install-Package Microsoft.EntityFrameworkCore.Tools</span><br></pre></td></tr></table></figure>

<p>在<code>Models</code>目录下面创建一个实体类<code>Book.cs</code></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Book</span></span><br><span class="line">  &#123;</span><br><span class="line">      <span class="keyword">public</span> <span class="built_in">int</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">      <span class="keyword">public</span> <span class="built_in">string</span>? Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">      <span class="keyword">public</span> <span class="built_in">double</span>? Price &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>在创建一个<code>Person.cs</code>实体类</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Person</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">int</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">string</span>? Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">int</span> Age &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>同时创建一个<code>MyDbContext.cs</code>类，代码如下所示：（这里使用默认的配置）</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyDbContext</span>:<span class="title">DbContext</span></span><br><span class="line">  &#123;</span><br><span class="line">      <span class="keyword">public</span> DbSet&lt;Book&gt; Books &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">      <span class="keyword">public</span> DbSet&lt;Person&gt; Persons &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="title">MyDbContext</span>(<span class="params">DbContextOptions&lt;MyDbContext&gt;opt</span>):<span class="title">base</span>(<span class="params">opt</span>)</span></span><br><span class="line">      &#123;</span><br><span class="line">          </span><br><span class="line">      &#125;</span><br><span class="line">    </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>将其注入到容器中</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">builder.Services.AddControllersWithViews();</span><br><span class="line">builder.Services.AddDbContext&lt;MyDbContext&gt;(opt =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    opt.UseSqlServer(<span class="string">&quot;server=.;database=Test1;uid=sa;password=123456;TrustServerCertificate=true&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>将<code>DbContext</code>添加到容器中，这里暂时不将数据库链接字符串，写到配置文件中，为了简单。</p>
<p>创建<code>Test</code>控制器，在<code>Test</code>控制器中添加测试的方法：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TestController</span> : <span class="title">Controller</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">readonly</span> MyDbContext ctx;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="title">TestController</span>(<span class="params">MyDbContext ctx</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">this</span>.ctx = ctx;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Index</span>()</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">return</span> View();</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Test</span>()</span></span><br><span class="line">       &#123;</span><br><span class="line">           ctx.Books.Add(<span class="keyword">new</span> Book &#123; Name = <span class="string">&quot;.net core&quot;</span>, Price = <span class="number">89</span> &#125;);</span><br><span class="line">           ctx.Persons.Add(<span class="keyword">new</span> Person &#123; Name = <span class="string">&quot;zhangsan&quot;</span>, Age = <span class="number">18</span> &#125;);</span><br><span class="line">           ctx.SaveChanges();</span><br><span class="line">           <span class="keyword">return</span> Content(<span class="string">&quot;ok&quot;</span>);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>在上面的代码中，我们先将<code>MyDbContext</code>注入进来。</p>
<p>然后在<code>Test</code>方法中添加对应的信息。注意：当执行<code>SaveChanges</code>方法的时候，会默认的开启事务，保证两条记录要么都插入成功，要么都不插入。</p>
<p>一会我们在修改业务需求。</p>
<p>下面先进行数据库的迁移操作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Add-Migration Int</span><br><span class="line">Update-database</span><br></pre></td></tr></table></figure>

<p>为了能够演示错误，我们打开数据库，修改表<code>Books,Persons</code>中的字段的长度。</p>
<p>把<code>Books</code>表中的<code>Name</code>字段的数据类型修改为<code>nvarchar(3)</code>，这样输入比较长的内容会出现错误。</p>
<p>同样把<code>Persons</code>表中的<code>Name</code>字段的类型也修改为<code>nvarchar(3)</code></p>
<p>下面执行<code>Test</code>这个方法</p>
<p>发现程序出错了，没有插入数据</p>
<p>然后把<code>Test</code>方法中的代码，修改成如下的形式：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">Test</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    ctx.Books.Add(<span class="keyword">new</span> Book &#123; Name = <span class="string">&quot;ff&quot;</span>, Price = <span class="number">89</span> &#125;);</span><br><span class="line">    ctx.Persons.Add(<span class="keyword">new</span> Person &#123; Name = <span class="string">&quot;zhangsan&quot;</span>, Age = <span class="number">18</span> &#125;);</span><br><span class="line">    ctx.SaveChanges();</span><br><span class="line">    <span class="keyword">return</span> Content(<span class="string">&quot;ok&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里<code>Book</code>的<code>Name</code>属性修改成了<code>ff</code>，符合字段类型的长度 ，但是<code>person</code>的<code>Name</code>不符合，再次执行该方法。</p>
<p>程序出错了，没有插入成功，表示以上操作是在一个事务中。</p>
<p>把上面的代码再修改成如下的形式：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">Test</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    ctx.Books.Add(<span class="keyword">new</span> Book &#123; Name = <span class="string">&quot;ff&quot;</span>, Price = <span class="number">89</span> &#125;);</span><br><span class="line">    ctx.SaveChanges();</span><br><span class="line">    ctx.Persons.Add(<span class="keyword">new</span> Person &#123; Name = <span class="string">&quot;zhangsan&quot;</span>, Age = <span class="number">18</span> &#125;);</span><br><span class="line">    ctx.SaveChanges();</span><br><span class="line">    <span class="keyword">return</span> Content(<span class="string">&quot;ok&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>由于业务场景的需求，需要执行两次<code>SaveChanges</code>方法来进行保存。</strong></p>
<p>第一个<code>SaveChanges</code>方法没有出现错误，信息成功插入。</p>
<p>第二个<code>SaveChanges</code>方法出现了错误，信息没有插入、</p>
<p>说明以上两个操作没有在同一个事务中。</p>
<p>现在继续修改上面的代码，把以上的操作放在一个<code>TransactionScope</code>中。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">Test</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">using</span> (TransactionScope tx = <span class="keyword">new</span> TransactionScope())</span><br><span class="line">            &#123;</span><br><span class="line">                ctx.Books.Add(<span class="keyword">new</span> Book &#123; Name = <span class="string">&quot;ff&quot;</span>, Price = <span class="number">89</span> &#125;);</span><br><span class="line">                ctx.SaveChanges();</span><br><span class="line">                ctx.Persons.Add(<span class="keyword">new</span> Person &#123; Name = <span class="string">&quot;zhangsan&quot;</span>, Age = <span class="number">18</span> &#125;);</span><br><span class="line">                ctx.SaveChanges();</span><br><span class="line">                  tx.Complete(); <span class="comment">// 提交事务</span></span><br><span class="line">                <span class="keyword">return</span> Content(<span class="string">&quot;ok&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>执行上面的代码，发现没有数据插入(在测试之前，先将数据表中上次插入的记录删除)</p>
<p>上面的代码执行的时候，第二个<code>SaveChanges</code>方法还是会抛出异常，但是两个数据表中都没有插入数据，说明以上操作是在一个事务中。</p>
<p>也就说明了只要有一个错误，整个事务都会进行回滚操作。</p>
<p>下面把<code>Person</code>中的<code>Name</code>属性修改正确看一下两条记录能否插入到数据库中。</p>
<p>这时候发现没有问题。</p>
<p><strong>当然，这里还需要注意一个问题，就是在异步模式下关于<code>TransactionScope</code>的使用问题</strong></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">Test</span>() <span class="comment">// 异步</span></span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 需要添加TransactionScopeAsyncFlowOption.Enabled</span></span><br><span class="line">    <span class="keyword">using</span> (TransactionScope tx = <span class="keyword">new</span> TransactionScope(TransactionScopeAsyncFlowOption.Enabled))</span><br><span class="line">    &#123;</span><br><span class="line">        ctx.Books.Add(<span class="keyword">new</span> Book &#123; Name = <span class="string">&quot;ff&quot;</span>, Price = <span class="number">89</span> &#125;);</span><br><span class="line">        <span class="keyword">await</span> ctx.SaveChangesAsync(); <span class="comment">// 异步</span></span><br><span class="line">        ctx.Persons.Add(<span class="keyword">new</span> Person &#123; Name = <span class="string">&quot;zh&quot;</span>, Age = <span class="number">18</span> &#125;);</span><br><span class="line">        <span class="keyword">await</span>  ctx.SaveChangesAsync(); <span class="comment">// 异步</span></span><br><span class="line">        tx.Complete();</span><br><span class="line">        <span class="keyword">return</span> Content(<span class="string">&quot;ok&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在异步的模式下需要给<code>TransactionScope</code>构造方法传递<code>TransactionScopeAsyncFlowOption.Enabled</code></p>
<p>为什么呢？</p>
<p>原因：前面我们写的同步的代码都是运行在同一个线程中的，而当异步模式的时候，会产生多线程的情况。</p>
<p>所以这里会通过<code>TransactionScopeAsyncFlowOption</code>这个枚举类型中的的<code>Enabled</code>属性，启用跨线程连续任务的事务流。</p>
<p>该枚举的文档:<code>https://learn.microsoft.com/zh-cn/dotnet/api/system.transactions.transactionscopeasyncflowoption?view=net-7.0</code></p>
<p>现在的问题：如果使用事务的时候，每次都在控制器的方法中添加<code>TransactionScope</code>的代码就比较麻烦了。</p>
<p>为了解决这个问题，我们可以使用<code>ActionFilter</code>来进行解决。</p>
<h4 id="10-3-2-Action-Filter封装TransactionScope"><a href="#10-3-2-Action-Filter封装TransactionScope" class="headerlink" title="10.3.2 Action Filter封装TransactionScope"></a>10.3.2 <code>Action Filter</code>封装<code>TransactionScope</code></h4><p>在我们所创建的控制器方法中，有可能有些方法不使用事务，这时候，我们可以给这些方法添加一个自定义的<code>NoTransactionalAttribute</code>(标识)</p>
<p>在项目中添加一个<code>Attributes</code>目录，在该目录下面创建<code>NoTransactionalAttribute.cs</code>，该类中的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">WebApplication3.Attributes</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">AttributeUsage(AttributeTargets.Method)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NoTransactionalAttribute</span>:<span class="title">Attribute</span></span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>下面在项目中创建<code>filters</code>目录，在该目录下面创建<code>TransactionScopeFilter.cs</code>类，该类中的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TransactionScopeFilter</span> : <span class="title">IAsyncActionFilter</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">OnActionExecutionAsync</span>(<span class="params">ActionExecutingContext context, ActionExecutionDelegate next</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* context.ActionDescriptor: 该属性中定义的是当前被执行的Action方法的描述信息*/</span></span><br><span class="line">        <span class="comment">/* context.ActionArguments: 该属性中定义的是当前被执行的Action方法的参数信息 */</span></span><br><span class="line">        <span class="comment">/* ControllerActionDescriptor :中定义了当前执行的方法名，控制器名 ，继承了ActionDescriptor*/</span></span><br><span class="line">        ControllerActionDescriptor controllerActionDescriptor = context.ActionDescriptor <span class="keyword">as</span> ControllerActionDescriptor;</span><br><span class="line">        <span class="built_in">bool</span> isTransactionScope = <span class="literal">false</span>; <span class="comment">// 是否进行事务控制</span></span><br><span class="line">        <span class="keyword">if</span> (controllerActionDescriptor != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 判断当前执行的控制器的方法上是否标注了NoTransactionalAttribute,如果标注了这里是true</span></span><br><span class="line">            <span class="comment">// 反射</span></span><br><span class="line">            <span class="comment">//GetCustomAttributes(要搜索的特性类型，是否搜索该成员的继承链以查找这些特性)</span></span><br><span class="line">            <span class="built_in">bool</span> hasNoTransactionalAttribute = controllerActionDescriptor.MethodInfo.GetCustomAttributes(<span class="keyword">typeof</span>(NoTransactionalAttribute), <span class="literal">false</span>).Any();<span class="comment">// Any:表示方法上至少标注一个NoTransactionalAttribute,如果标注了为true</span></span><br><span class="line">            isTransactionScope = !hasNoTransactionalAttribute; <span class="comment">// 如果方法上标注了NoTransactionalAttribute，不会进行事务的控制。</span></span><br><span class="line">            <span class="keyword">if</span> (isTransactionScope)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 进行事务控制</span></span><br><span class="line">                <span class="keyword">using</span> (TransactionScope ts = <span class="keyword">new</span> TransactionScope(TransactionScopeAsyncFlowOption.Enabled))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 执行控制器中具体的方法</span></span><br><span class="line">                    <span class="keyword">var</span> result = <span class="keyword">await</span> next();</span><br><span class="line">                    <span class="keyword">if</span>(result == <span class="literal">null</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        ts.Complete();<span class="comment">// 控制器中的方法执行没有错误，则提交事务</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 不进行事务的管理控制，则直接执行控制器中的方法</span></span><br><span class="line">                <span class="keyword">await</span> next();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对上面所创建的<code>filter</code>进行注册</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">builder.Services.AddDbContext&lt;MyDbContext&gt;(opt =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    opt.UseSqlServer(<span class="string">&quot;server=.;database=Test1;uid=sa;password=123456;TrustServerCertificate=true&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 注册TransactionScopeFilter</span></span><br><span class="line">builder.Services.Configure&lt;MvcOptions&gt;(opt =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    opt.Filters.Add&lt;TransactionScopeFilter&gt;();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>返回到控制器的<code>Test</code>方法中进行测试。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">NoTransactional</span>]</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">Test</span>()</span></span><br><span class="line">       &#123;</span><br><span class="line">          </span><br><span class="line">               ctx.Books.Add(<span class="keyword">new</span> Book &#123; Name = <span class="string">&quot;ff&quot;</span>, Price = <span class="number">89</span> &#125;);</span><br><span class="line">              <span class="keyword">await</span> ctx.SaveChangesAsync();</span><br><span class="line">               ctx.Persons.Add(<span class="keyword">new</span> Person &#123; Name = <span class="string">&quot;zhaaa&quot;</span>, Age = <span class="number">18</span> &#125;);</span><br><span class="line">             <span class="keyword">await</span>  ctx.SaveChangesAsync();</span><br><span class="line">               </span><br><span class="line">               <span class="keyword">return</span> Content(<span class="string">&quot;ok&quot;</span>);</span><br><span class="line">           </span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>上面添加了特性<code>NoTransactional</code>,这时候没有启用事务的管理，所以<code>ff</code>这本书会插入到数据库中。但是在执行插入<code>zhaaa</code>用户的时候会出错，不会插入到数据库中。</p>
<p>去掉该特性后，会启用事务管理，所以以上两条记录都不会插入到数据库中。</p>
<p>可以在<code>TransactionScopeFilter.cs</code>文件中打上断点进行调试。</p>
<h3 id="10-4-ActionFilter案例2"><a href="#10-4-ActionFilter案例2" class="headerlink" title="10.4 ActionFilter案例2"></a>10.4 <code>ActionFilter</code>案例2</h3><p>我们在<code>ActionFilter</code>中添加的代码不仅可以在控制器中的方法之前或者是之后执行，还可以在满足条件的时候终止控制器中方法的执行。</p>
<p>我们知道，在<code>ActionFilter</code>中，我们通过<code>await next()</code>来执行下一个<code>ActionFilter</code>，如果没有下一个<code>ActionFilter</code>，程序就会执行控制器中的方法。如果我们不调用<code>await next()</code>方法，就可以终止控制器中方法的执行了。</p>
<p>在本小节中，我们将会通过开发一个实现请求限流器功能的<code>ActionFilter</code>来演示一下怎样终止控制器中方法的执行。</p>
<p>为了避免恶意客户端频繁发送大量请求而消耗服务器资源，我们要实现<code>1秒</code>钟之内最多有一个来自同一个<code>IP</code>地址的请求。</p>
<p>当然实际情况不会1秒钟，这里只是为了做测试。</p>
<p>在<code>filters</code>目录下面创建<code>RateLimitActionFilter.cs</code>文件，该文件中的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc.Filters;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Caching.Memory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">WebApplication3.filters</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RateLimitActionFilter</span> : <span class="title">IAsyncActionFilter</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IMemoryCache _memoryCache;<span class="comment">//注入缓存</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">RateLimitActionFilter</span>(<span class="params">IMemoryCache memoryCache</span>)</span> &#123;</span><br><span class="line">          <span class="keyword">this</span>._memoryCache = memoryCache;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">OnActionExecutionAsync</span>(<span class="params">ActionExecutingContext context, ActionExecutionDelegate next</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 获取用户的ip地址</span></span><br><span class="line">            <span class="built_in">string</span> ip = context.HttpContext.Connection.RemoteIpAddress!.ToString();</span><br><span class="line">            <span class="comment">// 指定缓存的key</span></span><br><span class="line">            <span class="built_in">string</span> cacheKey = <span class="string">$&quot;lastVist_<span class="subst">&#123;ip&#125;</span>&quot;</span>;</span><br><span class="line">            <span class="comment">// 从缓存中获取用户上次访问服务器的时间</span></span><br><span class="line"></span><br><span class="line">            <span class="built_in">long</span>? lastTick = _memoryCache.Get&lt;<span class="built_in">long</span>&gt;(cacheKey);</span><br><span class="line">            <span class="comment">// 如果缓存中不存在上一次访问的时间或者是上次访问的时间距离现在已经超过了1秒钟，那么会 让用户访问控制器中的方法</span></span><br><span class="line">            <span class="comment">// 所以这里调用了next方法。</span></span><br><span class="line">            <span class="comment">// 如果我们能够从缓存中获取时间，说明用户是在1秒钟内又访问了，这时候cache中有时间，这时候返回状态码429，表示访问太频繁，这里没有执行next方法，从而不会执行控制器中的方法。</span></span><br><span class="line">            <span class="comment">//  Environment.TickCount64:当前的时间的毫秒数</span></span><br><span class="line">            <span class="keyword">if</span> (lastTick == <span class="literal">null</span> || Environment.TickCount64 - lastTick &gt; <span class="number">1000</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 这里设置缓存的绝对过期时间是10毫秒，原因是：有可能用户访问了一个方法后，没有在访问其他的方法，这时候10秒以后清空缓存。避免长期不访问的用户，占用缓存的内存，造成资源的浪费。</span></span><br><span class="line">                _memoryCache.Set(cacheKey, Environment.TickCount64, TimeSpan.FromSeconds(<span class="number">10</span>));</span><br><span class="line">                 <span class="keyword">await</span> next();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                context.Result = <span class="keyword">new</span> ObjectResult(<span class="string">&quot;访问太频繁！！&quot;</span>) &#123; StatusCode = <span class="number">429</span> &#125;;</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>完成容器的添加</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">builder.Services.Configure&lt;MvcOptions&gt;(opt =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    opt.Filters.Add&lt;RateLimitActionFilter&gt;(); <span class="comment">// 这里建议放在最前面，当限流了以后 就不会执行后面的Filter了，节省资源</span></span><br><span class="line">    opt.Filters.Add&lt;TransactionScopeFilter&gt;();</span><br><span class="line">&#125;);</span><br><span class="line">builder.Services.AddMemoryCache(); <span class="comment">// 添加缓存服务</span></span><br><span class="line"><span class="keyword">var</span> app = builder.Build();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>下面进行测试。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">Test2</span>()</span> &#123;</span><br><span class="line">           <span class="keyword">return</span> Content(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<h2 id="11、中间件"><a href="#11、中间件" class="headerlink" title="11、中间件"></a>11、中间件</h2><h3 id="11-1-什么是中间件"><a href="#11-1-什么是中间件" class="headerlink" title="11.1 什么是中间件"></a>11.1 什么是中间件</h3><p>我们知道，在浏览网站或者使用手机<code>App</code>加载内容的时候，浏览器或者手机<code>App</code>其实在向<code>Web服务器发送</code>HTTP<code>请求。服务器在收到</code>HTTP<code>请求后会对用户的请求进行一系列的处理，比如检查请求的身份验证信息、处理请求报文头、检查是否存在对应的服务器端响应缓存、找到和请求对应的控制器类中的操作方法等，当控制器类中的操作方法执行完成后，服务器也会对响应进行一系列的处理，比如保存响应缓存、设置缓存报文头、设置CORS</code>报文头、压缩响应内容等。这一系列操作如果全部硬编码到<code>Asp.net core</code> 中，会使得代码的耦合度太高，无法做到按需组装处理逻辑。因此<code>Asp.net core</code>基础框架，只是完成了报文解析等一些必要的工作，其他的工作都是由不同的中间件来完成。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C://Users/86159/Desktop/images/657.png"></p>
<p><code>ASP.NET Core</code>中的中间件则指<code>ASP.NET Core</code>中的一个组件。每个中间件由前逻辑、<code>next</code>、后逻辑3部分组成，前逻辑为第一段要执行的逻辑代码，<code>next</code>为指向下一个中间件的调用，后逻辑为从下一个中间件返回所执行的逻辑代码。每个<code>HTTP</code>请求都要经历一系列中间件的处理，每个中间件对请求进行特定的处理后，再将其转到下一个中间件，最终的业务逻辑代码执行完成后，响应的内容也会按照请求处理的相反顺序进行处理，然后形成<code>HTTP</code>响应报文返回给客户端。</p>
<p>这些中间件组成一个<code>管道（pipeline）</code>，整个<code>ASP.NET Core</code>的执行过程就是<code>HTTP</code>请求和响应按照中间件组装的顺序在中间件之间流转的过程。开发人员可以对组成管道的中间件按照需要进行自由组合，比如调整中间件的顺序、添加或者删除中间件、自定义中间件等。</p>
<p>说完以上内容，感觉管道与<code>Filter</code>是非常相似的，那么它们之间到底有什么不同的呢?</p>
<p>其实在这里我们也可以总结出一点：就是中间件相比于<code>Filter</code>是更底层的应用。</p>
<p>具体的区别我们后面再进行分析。</p>
<h3 id="11-2-中间件常见概念"><a href="#11-2-中间件常见概念" class="headerlink" title="11.2 中间件常见概念"></a>11.2 中间件常见概念</h3><p>要进行中间件的开发，我们需要先了解3个重要的概念：<code>Map</code>、<code>Use</code>和<code>Run</code>。<code>Map</code>用来定义一个管道可以处理哪些请求，<code>Use</code>和<code>Run</code>用来定义管道，一个管道由若干个<code>Use</code>和一个<code>Run</code>组成，每个<code>Use</code>引入一个中间件，而<code>Run</code>用来执行最终的核心应用逻辑。<code>Map、Use</code>和<code>Run</code>的关系如下图所示。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C://Users/86159/Desktop/images/413.png"></p>
<p>当用户请求<code>/test1</code>这个路径的时候，请求就被放到“管道1”进行处理，经过两个<code>Use</code>引入的中间件，最后在<code>Run</code>中执行完请求。一个管道中可以包含多个<code>Use</code>，一般只包含一个<code>Run</code>，而且<code>Run</code>被放到最后，因为一个<code>Use</code>引入的中间件可以把请求转给下一个中间件，但是一旦执行<code>Run</code>，处理就终止了。也就是说，<code>Map</code>是用来引入请求的，请求来到管道之后，由组成管道的多个<code>Use</code>负责对请求进行预处理及请求处理完成后的扫尾工作，<code>Run</code>负责主要的业务规则.</p>
<h3 id="11-3-中间件执行流程"><a href="#11-3-中间件执行流程" class="headerlink" title="11.3 中间件执行流程"></a>11.3 中间件执行流程</h3><p>本小节中，我们将通过简单的案例了解<code>Map、Use</code>和<code>Run</code>在<code>ASP.NET Core</code>中的不同作用。</p>
<p>如果我们创建一个<code>ASP.NET Core MVC</code>或者<code>ASP.NET Core Web AP</code>I项目，向导会自动帮我们创建模板代码，这些模板代码中会自动帮我们引入一些中间件。为了能够更清晰地了解中间件，我们创建一个空的<code>ASP.NET Core</code>项目，然后手动添加中间件。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">var</span> builder = WebApplication.CreateBuilder(args);</span><br><span class="line">  <span class="keyword">var</span> app = builder.Build();</span><br><span class="line">  app.Map(<span class="string">&quot;/test&quot;</span>, <span class="keyword">async</span> appbuilder =&gt; &#123; <span class="comment">//在8.0已经不可以使用</span></span><br><span class="line">        appbuilder.UseMiddleware&lt;TestMiddleWare&gt;(); <span class="comment">// 这样就可以 </span></span><br><span class="line">        appbuilder.Use(<span class="keyword">async</span> (context, next) =&gt; &#123;  <span class="comment">// 这种不行</span></span><br><span class="line">               context.Response.ContentType = <span class="string">&quot;text/html&quot;</span>;</span><br><span class="line">               <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;1  Start&lt;br/&gt;&quot;</span>);</span><br><span class="line">               <span class="keyword">await</span> next.Invoke();</span><br><span class="line">               <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;1  End&lt;br/&gt;&quot;</span>);</span><br><span class="line">           &#125;);</span><br><span class="line">       appbuilder.Use(<span class="keyword">async</span> (context, next) =&gt; &#123;</span><br><span class="line">               <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;2  Start&lt;br/&gt;&quot;</span>);</span><br><span class="line">               <span class="keyword">await</span> next.Invoke();</span><br><span class="line">               <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;2  End&lt;br/&gt;&quot;</span>);</span><br><span class="line">           &#125;);</span><br><span class="line">       appbuilder.Run(<span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">               <span class="keyword">await</span> ctx.Response.WriteAsync(<span class="string">&quot;hello middleware &lt;br/&gt;&quot;</span>);</span><br><span class="line">           &#125;);</span><br><span class="line">     &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//该Map没有中间件</span></span><br><span class="line">app.MapGet(<span class="string">&quot;/&quot;</span>, () =&gt; <span class="string">&quot;Hello World!&quot;</span>);</span><br><span class="line"></span><br><span class="line">app.Run();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>演示上面的程序</p>
<p>在上面的代码中，使用<code>Map</code>方法定义了所有对<code>/test</code>请求都是有内部定义的管道来进行处理。</p>
<p>在管道的内部，请求会有两个通过<code>Use</code>引入的两个中间件来处理。</p>
<p>管道中<code>Use</code>的声明顺序就是中间件执行的顺序，一个请求过来的时候，会先执行第一个<code>Use</code>声明的中间件，然后再执行第二个<code>Use</code>声明的中间件。最后执行<code>Run</code>函数。</p>
<p>在中间件中，我们可以使用<code>await next.Invoke()</code>来执行下一个中间件；由于<code>Run</code>方法不会再把请求向后传递，因此<code>Run</code>方法中不需要也不能够再执行<code>next.Invoke</code>.</p>
<p>当然<code>Run</code>方法执行完毕以后，响应会按照请求<strong>的相反顺序执</strong>行<code>Use</code>的<code>await next.Invoke()</code>之后的代码，</p>
<p>所以这时候，当<code>Run</code>执行结束以后，会依次执行<code> await context.Response.WriteAsync(&quot;2  End&lt;br/&gt;&quot;);</code>和<code> await context.Response.WriteAsync(&quot;1  End&lt;br/&gt;&quot;);</code></p>
<p>需要注意的是，按照微软的建议，如果我们在一个中间件中使用<code>ctx.Response.WriteAsync</code>等方式向客户端发送响应，我们就不能再执行<code>next.Invoke</code>把请求转到其他中间件了。因为其他中间件中有可能对<code>Response</code>进行了更改，比如修改响应状态码、修改报文头或者向响应报文中写入其他数据，这样就会造成响应报文体被损坏的问题.</p>
<p>所以说，在上面的示例代码中，我们在向报文体中写入内容后，又执行<code>next.Invoke</code>方法是不推荐的做法，这里我们只是为了做一个演示，让大家能够更好的理解中间件的执行流程</p>
<h3 id="11-4-中间件封装"><a href="#11-4-中间件封装" class="headerlink" title="11.4  中间件封装"></a>11.4  中间件封装</h3><p>如果在<code>Use</code>方法中定义的中间件代码比较简单，我们可以直接将其写到<code>Use</code>方法内部。但是如果中间件的代码比较复杂，或者是需要重复的使用一个中间件的话，最好把中间件的代码封装到一个单独的类中，这样的类我们称之为”中间件类”。</p>
<p>下面看一下构建中间件类的基本要求：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">中间件类是一个普通的.Net 类，它不需要继承任何父类或者实现任何的接口，但是这个类需要有一个构造方法，构造方法中至少要有一个RequestDelegate类型的参数，这个参数用来指向下一个中间件。这个类还需要定义一个名字为`Invoke`或者是`InvokeAsync`的方法，该方法中至少有一个`HttpContext`类型的参数，方法的返回值必须是`Task`类型，中间类的构造方法和`Invoke或者是InvokeAsync`方法还可以定义其他的参数，其他参数会通过依赖注入自动赋值。</span><br></pre></td></tr></table></figure>

<p>在项目中创建一个<code>MiddleWares</code>文件夹，在该文件夹中创建<code>TestMiddleWare.cs</code>文件，该文件中代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">WebApplication5.MiddleWares</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TestMiddleWare</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> RequestDelegate next;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">TestMiddleWare</span>(<span class="params">RequestDelegate next</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.next = next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">InvokeAsync</span>(<span class="params">HttpContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            context.Response.WriteAsync(<span class="string">&quot;TestMiddleWare start &lt;br/&gt;&quot;</span>);</span><br><span class="line">            <span class="keyword">await</span> next.Invoke(context); <span class="comment">// 执行下一个中间件</span></span><br><span class="line">            context.Response.WriteAsync(<span class="string">&quot;TestMiddleWare end &lt;br/&gt;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里我们按照要求，封装了一个中间件类。</p>
<p>怎样使用呢？</p>
<p><code>Program.cs</code>文件中修改代码：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">appbuilder.Use(<span class="keyword">async</span> (context, next) =&gt; &#123;</span><br><span class="line">             <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;2  Start&lt;br/&gt;&quot;</span>);</span><br><span class="line">             <span class="keyword">await</span> next.Invoke();</span><br><span class="line">             <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;2  End&lt;br/&gt;&quot;</span>);</span><br><span class="line">         &#125;);</span><br><span class="line">    appbuilder.UseMiddleware&lt;TestMiddleWare&gt;(); <span class="comment">// 这里使用了我们自已定义的`TestMiddleWare`这个中间件。</span></span><br><span class="line">     appbuilder.Run(<span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">             <span class="keyword">await</span> ctx.Response.WriteAsync(<span class="string">&quot;hello middleware &lt;br/&gt;&quot;</span>);</span><br><span class="line">         &#125;);</span><br></pre></td></tr></table></figure>

<p>启动项目，可以看到，我们所创建的中间件起作用了。</p>
<p>以上就是中间件类的基本实现方式。</p>
<p>下面，我们再来做一个简单的案例，校验访问网站的用户的年龄</p>
<p>在<code>MiddleWares</code>文件夹下面创建<code>CheckMiddleWare.cs</code>这个类，该类中的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CheckMiddleWare</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">readonly</span> RequestDelegate next;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="title">CheckMiddleWare</span>(<span class="params">RequestDelegate next</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">this</span>.next = next;</span><br><span class="line">       &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">InvokeAsync</span>(<span class="params">HttpContext context</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">if</span> (context.Request.Query[<span class="string">&quot;age&quot;</span>].Count&gt;<span class="number">0</span>)</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="built_in">int</span> age = Convert.ToInt32(context.Request.Query[<span class="string">&quot;age&quot;</span>]);</span><br><span class="line">               <span class="keyword">if</span> (age &gt;= <span class="number">18</span>)</span><br><span class="line">               &#123;</span><br><span class="line">                   context.Items[<span class="string">&quot;age&quot;</span>] = age;</span><br><span class="line">                   <span class="keyword">await</span> next(context); <span class="comment">// 执行下一个中间件 </span></span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">else</span></span><br><span class="line">               &#123;</span><br><span class="line">                   context.Response.StatusCode = <span class="number">401</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">else</span></span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">await</span> next(context);</span><br><span class="line">           &#125;     </span><br><span class="line"></span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>下面使用该中间件</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> builder = WebApplication.CreateBuilder(args);</span><br><span class="line">  <span class="keyword">var</span> app = builder.Build();</span><br><span class="line">  app.Map(<span class="string">&quot;/test&quot;</span>, <span class="keyword">async</span> appbuilder =&gt; &#123;</span><br><span class="line">      appbuilder.UseMiddleware&lt;CheckMiddleWare&gt;(); <span class="comment">// 这里使用CheckMiddleWare这个中间件</span></span><br><span class="line">      <span class="comment">/*  appbuilder.Use(async (context, next) =&gt; &#123;</span></span><br><span class="line"><span class="comment">               context.Response.ContentType = &quot;text/html&quot;;</span></span><br><span class="line"><span class="comment">               await context.Response.WriteAsync(&quot;1  Start&lt;br/&gt;&quot;);</span></span><br><span class="line"><span class="comment">               await next.Invoke();</span></span><br><span class="line"><span class="comment">               await context.Response.WriteAsync(&quot;1  End&lt;br/&gt;&quot;);</span></span><br><span class="line"><span class="comment">           &#125;);</span></span><br><span class="line"><span class="comment">       appbuilder.Use(async (context, next) =&gt; &#123;</span></span><br><span class="line"><span class="comment">               await context.Response.WriteAsync(&quot;2  Start&lt;br/&gt;&quot;);</span></span><br><span class="line"><span class="comment">               await next.Invoke();</span></span><br><span class="line"><span class="comment">               await context.Response.WriteAsync(&quot;2  End&lt;br/&gt;&quot;);</span></span><br><span class="line"><span class="comment">           &#125;);</span></span><br><span class="line"><span class="comment">      appbuilder.UseMiddleware&lt;TestMiddleWare&gt;();*/</span></span><br><span class="line">       appbuilder.Run(<span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">           ctx.Response.ContentType = <span class="string">&quot;text/plain; charset=utf-8&quot;</span>; <span class="comment">// 指定返回到客户端信息的编码方式</span></span><br><span class="line">           <span class="keyword">if</span> (ctx.Items[<span class="string">&quot;age&quot;</span>]!=<span class="literal">null</span>)</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="built_in">int</span> age = Convert.ToInt32(ctx.Items[<span class="string">&quot;age&quot;</span>]);               </span><br><span class="line"></span><br><span class="line">               <span class="keyword">await</span> ctx.Response.WriteAsync(<span class="string">$&quot;您的年龄是<span class="subst">&#123;age&#125;</span>,可以访问本网站&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">else</span></span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">await</span> ctx.Response.WriteAsync(<span class="string">&quot;请输入您的年龄！！&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">        </span><br><span class="line">           &#125;);</span><br><span class="line">     &#125;);</span><br></pre></td></tr></table></figure>

<p>在上面的代码中，如果我们发送请求<code>/test</code>，就会执行我们创建的<code>CheckMiddleWare</code>中间件，然后进行校验用户的年龄。</p>
<p>但是这时候，没有传递<code>age</code>参数，中间件中<code>InvokeAsync</code>方法中的如下判断就不成立了：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (context.Request.Query[<span class="string">&quot;age&quot;</span>].Count&gt;<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p>这时候直接执行<code>else</code>中的代码，<code> await next(context);</code>，进入下一个中间件执行，但是这里也没有下一个中间件了，就直接进入了<code>Run</code>方法中。这时候<code>ctx.Items[&quot;age&quot;]</code>中没有值，从而在页面中看到的信息是:<code>请输入您的年龄！！</code></p>
<p>，但是输入<code>http://localhost:5246/test?age=19</code>就可以看到页面中展示的信息了。</p>
<p>如果输入<code>http://localhost:5246/test?age=17</code> ，执行的是中间件类中的<code> context.Response.StatusCode = 401;</code></p>
<p>返回的状态码就是<code>401</code>,表示“未授权”.同时该语句后面没有执行<code>await next(context)</code>，请求就不会被传递到其他的中间件中，因此也不会执行<code>Run</code>方法中的代码，这个请求就被终止了。</p>
<p><strong>当我们把数据放入到<code>context.Items</code>中的时候，在<code>Run</code>方法中也可以从<code>context.Items</code>中获取数据，说明<code>HttpContext.Items</code>在同一个请求中是共享的，所以可以用它来实现在多个中间件之间传递数据</strong></p>
<p>除了常用的根据路径进行请求匹配的<code>Map</code>方法，<code>ASP.NET Core</code>中还提供了其他的Map方法，比如匹配<code>GET</code>请求的<code>MapGet</code>方法、匹配POST请求的<code>MapPost</code>方法。通过<code>MapWhen</code>方法中的类型为<code>Func&lt;HttpContext,bool&gt;</code>的参数还可以使用自定义的过滤条件来进行请求的匹配</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> app.MapWhen(ctx=&gt;ctx.Request.Headers[<span class="string">&quot;AAA&quot;</span>]==<span class="string">&quot;123&quot;</span>, <span class="keyword">async</span> appbuilder =&gt; &#123; &#125;);</span><br><span class="line"> app.MapWhen(ctx =&gt; ctx.Request.Path.StartsWithSegments(<span class="string">&quot;/api&quot;</span>), <span class="keyword">async</span> appbuilder =&gt;</span><br><span class="line">&#123; &#125;);</span><br></pre></td></tr></table></figure>

<p>上面的第1行代码定义了一个所有“报文头中<code>AAA</code>的值为123”的请求对应的管道，而第2行代码定义了一个所有请求路径以<code>“/api”</code>开头的请求对应的管道。</p>
<h3 id="11-5-模拟MVC框架"><a href="#11-5-模拟MVC框架" class="headerlink" title="11.5 模拟MVC框架"></a>11.5 模拟<code>MVC</code>框架</h3><p>通过前面的学习，我们知道<code>.net core</code>就是一个平台，而<code>MVC</code>是有一个个的中间件组合而成，用来处理<code>http</code>请求。</p>
<p>这里我们自己模拟一个简单的<code>MVC</code>框架，继续体会<code>中间件的</code>应用。</p>
<p>注意：这里的代码能够看懂就可以了。</p>
<p>这里包含了对静态文件处理的中间件，对控制器中方法处理的中间件，以及404中间件。</p>
<h4 id="11-5-1-静态文件处理"><a href="#11-5-1-静态文件处理" class="headerlink" title="11.5.1  静态文件处理"></a>11.5.1  静态文件处理</h4><p>我们知道，<code>MVC</code>框架在处理<code>wwwroot</code>文件夹（该文件夹存放的都是静态文件）下的文件的时候，是通过中间件来完成的，下面看一下具体的处理过程。</p>
<p>新创建一个类库项目（<code>MiniMVC</code>，保证该项目是一个类库项目，右击选择属性—应用程序–常规–输出类型是类库项目），该该类库项目中创建一个<code>MyStaticFilesMiddleware.cs</code>，这个就是用来处理静态文件的中间件。</p>
<p>该中间件的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Http;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MiniMVC</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyStaticFileMiddleware</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 对网站中的静态文件进行处理的中间件</span></span><br><span class="line">       </span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">readonly</span> RequestDelegate next;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">readonly</span> IWebHostEnvironment hostEnv;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="title">MyStaticFileMiddleware</span>(<span class="params">RequestDelegate next, IWebHostEnvironment hostEnv</span>)</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">this</span>.next = next;</span><br><span class="line">                <span class="keyword">this</span>.hostEnv = hostEnv;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">InvokeAsync</span>(<span class="params">HttpContext context</span>)</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">string</span> path = context.Request.Path.Value ?? <span class="string">&quot;&quot;</span>;</span><br><span class="line">                <span class="comment">//根据路径获取wwwroot文件夹下的静态文件</span></span><br><span class="line">                <span class="keyword">var</span> file = hostEnv.WebRootFileProvider.GetFileInfo(path);</span><br><span class="line">                <span class="keyword">if</span> (!file.Exists || !ContentTypeHelper.IsValid(file))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">await</span> next.Invoke(context); <span class="comment">// 如果找不到文件，或者是不是一个合法的静态文件，就执行下一个中间，也就是NotFound中间件</span></span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                context.Response.ContentType = ContentTypeHelper.GetContentType(file);</span><br><span class="line">                context.Response.StatusCode = <span class="number">200</span>;</span><br><span class="line">                <span class="keyword">using</span> <span class="keyword">var</span> stream = file.CreateReadStream();</span><br><span class="line">                <span class="built_in">byte</span>[] bytes = <span class="keyword">await</span> ToArrayAsync(stream);</span><br><span class="line">                <span class="keyword">await</span> context.Response.Body.WriteAsync(bytes); <span class="comment">// 如果找到了静态文件，直接返回给客户端，不需要在执行其他的中间件，所以这里就不需要再调用next方法了</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">async</span> Task&lt;<span class="built_in">byte</span>[]&gt; ToArrayAsync(Stream stream)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">using</span> MemoryStream memStream = <span class="keyword">new</span> MemoryStream();</span><br><span class="line">                <span class="keyword">await</span> stream.CopyToAsync(memStream);</span><br><span class="line">                memStream.Position = <span class="number">0</span>;</span><br><span class="line">                <span class="built_in">byte</span>[] bytes = memStream.ToArray();</span><br><span class="line">                <span class="keyword">return</span> bytes;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意：在新创建的类库项目<code>MiniMVC</code>中，无法使用<code>IWebHostEnvironment</code>，这时候需要单击该类库项目的名称，在打开的页面中，将</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Project Sdk=&quot;Microsoft.NET.Sdk&quot;&gt;</span><br></pre></td></tr></table></figure>

<p>修改为:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Project Sdk=&quot;Microsoft.NET.Sdk.Web&quot;&gt;</span><br></pre></td></tr></table></figure>

<p>保存，重新加载项目就可以了。</p>
<p>以下是<code>ContentTypeHelper.cs</code>类中的代码。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.Extensions.FileProviders;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MiniMVC</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ContentTypeHelper</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt; data</span><br><span class="line">            = <span class="keyword">new</span>(StringComparer.OrdinalIgnoreCase);</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="title">ContentTypeHelper</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            data[<span class="string">&quot;.html&quot;</span>] = <span class="string">&quot;text/html; charset=utf-8&quot;</span>;</span><br><span class="line">            data[<span class="string">&quot;.htm&quot;</span>] = <span class="string">&quot;text/html; charset=utf-8&quot;</span>;</span><br><span class="line">            data[<span class="string">&quot;.txt&quot;</span>] = <span class="string">&quot;text/plain; charset=utf-8&quot;</span>;</span><br><span class="line">            data[<span class="string">&quot;.jpg&quot;</span>] = <span class="string">&quot;image/jpeg&quot;</span>;</span><br><span class="line">            data[<span class="string">&quot;.jpeg&quot;</span>] = <span class="string">&quot;image/jpeg&quot;</span>;</span><br><span class="line">            data[<span class="string">&quot;.png&quot;</span>] = <span class="string">&quot;image/png&quot;</span>;</span><br><span class="line">            data[<span class="string">&quot;.js&quot;</span>] = <span class="string">&quot;application/x-javascript; charset=utf-8&quot;</span>;</span><br><span class="line">            data[<span class="string">&quot;.css&quot;</span>] = <span class="string">&quot;text/css&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 判断一个文件是否是合法的静态文件</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;file&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">IsValid</span>(<span class="params">IFileInfo file</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (file.IsDirectory)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">string</span> extension = Path.GetExtension(file.Name);</span><br><span class="line">            <span class="keyword">return</span> data.ContainsKey(extension);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 获取一个文件对应的ContentType</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;file&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">GetContentType</span>(<span class="params">IFileInfo file</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">string</span> extension = Path.GetExtension(file.Name);</span><br><span class="line">            <span class="keyword">return</span> data[extension];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>下面，我们自己再重新创建一个新的<code>Asp.net core</code>项目，注意：这里不使用微软提供好的<code>MVC</code>模版。因为这里我们需要再<code>.net core</code>中使用我们自己搭建的<code>MVC</code>，来处理浏览器的请求。</p>
<p>这里我们引入类库项目,然后进行配置，看一下能否处理静态文件。</p>
<p>在<code>wwwroot</code>目录下面添加一个<code>html</code>网页，叫做<code>show.html</code></p>
<p>在该网页中插入图片，写入文字。然后启动项目，输入该网页文件的名称就可以访问了。</p>
<h4 id="11-5-2-未找到资源处理"><a href="#11-5-2-未找到资源处理" class="headerlink" title="11.5.2  未找到资源处理"></a>11.5.2  未找到资源处理</h4><p>如果所请求的资源不存在，也是单独的交给一个中间件进行处理。</p>
<p>在<code>MiniMVC</code>这个类库项目中创建<code>NotFoundMiddleware.cs</code>文件，该文件中的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Http;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MiniMVC</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NotFoundMiddleware</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 如果一个请求不能被管道中任何一个中间件处理，也就是请求的地址不存在，</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 则ASP.NET Core会向客户端写入状态码为404的响应。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 为了能够显示自定义的报错信息，开发了这个中间件类。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 我们一般把其他中间件放到前面，而把NotFoundMiddleware放到管道中的最后。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 这样，如果任何一个中间件能够处理这个请求，这个请求都会被处理，</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 然后短路请求，而如果没有任何一个中间件能够处理这个请求，</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 这个请求就会最终由NotFoundMiddleware处理。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> RequestDelegate next;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">NotFoundMiddleware</span>(<span class="params">RequestDelegate next</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.next = next;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">InvokeAsync</span>(<span class="params">HttpContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            context.Response.StatusCode = <span class="number">404</span>;</span><br><span class="line">            context.Response.ContentType = <span class="string">&quot;text/html;charset=utf-8&quot;</span>;</span><br><span class="line">            <span class="keyword">await</span> context.Response.WriteAsync(<span class="string">&quot;没有找到你所访问的页面&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>进行注册：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> MiniMVC;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> builder = WebApplication.CreateBuilder(args);</span><br><span class="line"><span class="keyword">var</span> app = builder.Build();</span><br><span class="line">app.UseMiddleware&lt;MyStaticFileMiddleware&gt;(); </span><br><span class="line">app.UseMiddleware&lt;NotFoundMiddleware&gt;(); <span class="comment">// 添加了NotFoundMiddleware中间件。</span></span><br></pre></td></tr></table></figure>

<p>启动项目进行测试</p>
<h4 id="11-5-3-处理控制器和方法"><a href="#11-5-3-处理控制器和方法" class="headerlink" title="11.5.3 处理控制器和方法"></a>11.5.3 处理控制器和方法</h4><p>创建一个<code>MVC</code>空项目，然后修改<code>Prgram.cs</code>文件中的代码</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> WebApplication11.Middlewares;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> builder = WebApplication.CreateBuilder(args);</span><br><span class="line"><span class="keyword">var</span> app = builder.Build();</span><br><span class="line">app.UseMiddleware&lt;MyStaticFileMiddleware&gt;();</span><br><span class="line">app.UseMiddleware&lt;NotFoundMiddleware&gt;();</span><br><span class="line">app.MapGet(<span class="string">&quot;/&quot;</span>, () =&gt;</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Hello World&quot;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.Run();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>同时在项目中创建一个<code>wwwroot</code>文件夹，在该文件夹中创建一个记事本文件，通过浏览器进行访问。</p>
<p>通过这个例子，可以看到<code>MVC</code>就是一个中间件。</p>
<h3 id="11-6-调整内置中间件的顺序"><a href="#11-6-调整内置中间件的顺序" class="headerlink" title="11.6 调整内置中间件的顺序"></a>11.6 调整内置中间件的顺序</h3><p>中间件的组装顺序是非常重要的。本节看一下<code>Asp.net Core MVC</code>项目默认生成的代码（这里重新创建一个新的<code>MVC</code>项目）</p>
<p>项目代码中默认启用了<code>StaticFiles</code>中间件(处理静态文件)，因此如果我们请求的路径能够匹配<code>wwwroot</code>文件夹中的静态文件，就会返回这个文件的内容。我们在<code>wwwroot</code>文件夹下创建<code>Home</code>文件夹，在<code>Home</code>文件夹下再创建<code>Index</code>文件夹，最后，在<code>Index</code>文件夹下再创建<code>index.html</code>文件，文件中写入显示“这是静态文件<code>index.html</code>”字符串的网页内容。</p>
<p>我们知道默认生成的<code>ASP.NET Core MVC</code> 项目还存在一个<code>HomeController</code>控制器，该控制器中有<code>Index</code>方法。如果生成的项目中没有这个控制器，请创建一个这样的控制器。</p>
<p>然后启动项目，分别访问<code>/home/index</code>和<code>/home/index/index.html</code></p>
<p>可以看到，当我们访问<code>/Home/Index/</code>的时候，请求被<code>MVC</code>的中间件处理，因此执行了<code>HomeController</code>中的<code>Index</code>方法；当我们访问<code>/Home/Index/index.html</code>的时候，由于这个请求在<code>wwwroot</code>文件夹下有对应的静态文件，因此这个请求被<code>StaticFiles中</code>间件处理，程序输出了<code>index.html</code>文件的内容。</p>
<p><code>ASP.NET Core</code>中内置了一个<code>DefaultFiles</code>中间件，当执行这个中间件的时候，如果<strong>客户端访问一个文件夹的路径</strong>，程序会尝试检查<code>wwwroot</code>对应的路径下是否有默认的文件（比如<code>default.htm、default.html、index.htm、index.html</code>）等，如果存在这样的文件的话，请求也会被终止，并且输出默认文件的内容。</p>
<p>接下来，我们在<code>Program.cs</code>中的<code>app.UseStaticFiles</code>之前加上<code>app.UseDefaultFiles</code>，然后执行程序并且分别访问<code>/Home/Index/</code>和<code>/Home/Index/index.html</code>，访问结果都是输出<code>“这是静态文件index.html”</code>。因为<code>UseDefaultFiles</code>、<code>UseStaticFiles</code>这两个中间件被放在<code>ASP.NET Core MVC</code>的核心中间件<code>UseRouting</code>之前，所以<code>/Home/Index</code>&#x2F;也被<code>DefaultFiles和StaticFiles</code>这两个中间件处理了。</p>
<p>如果我们把<code>UseDefaultFiles、UseStaticFiles</code>这两个中间件移动到<code>UseRouting</code>中间件之后，再执行程序并且分别访问<code>/Home/Index/</code>和<code>/Home/Index/index.html</code>这两个路径，访问结果都是输出<code>HomeController</code>的<code>Index</code>方法的内容。因为<code>UseRoutin</code>g中间件放到了<code>UseDefaultFiles、UseStaticFiles</code>之前，而这两个请求都被<code>MVC</code>中间件处理了。通过这个案例，我们再次认识到，中间件的组装顺序非常重要，在使用它们的时候一定要注意仔细阅读文档中关于中间件组装顺序的说明。</p>
<h3 id="11-7-中间件与Filter的区别"><a href="#11-7-中间件与Filter的区别" class="headerlink" title="11.7 中间件与Filter的区别"></a>11.7 中间件与<code>Filter</code>的区别</h3><p>我们在学习中间件的过程中，可能会感觉中间件和我们前面所学习的<code>Filter</code>非常相似，它们都是通过<code>next</code>串起来的一系列组合，并且都可以在请求处理的前后执行代码，都可以通过不执行<code>next</code>来进行请求的终止。</p>
<p>问题是：它们两者之间有什么区别？</p>
<p>我们知道，中间件是<code>Asp.net core</code>中提供的功能柜，而<code>Filter</code>是<code>Asp.net Core Mvc</code>提供的功能。</p>
<p>我们知道<code>MVC</code>是一个中间件，所以说<code>Filter</code>属于<code>MVC</code>中间件提供的功能。</p>
<p>因此，中间件和<code>Filter</code>的关系如下图所示：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/kilg0ur/picture/master/picture/202407141732785.png"></p>
<p>因此，中间件和筛选器所处的层级是不同的，中间件是一个基础的概念，而筛选器是<code>MVC</code>中间件中的机制。所以，中间件可以处理所有的请求，无论是针对控制器的请求还是针对静态文件等的请求，而筛选器只能处理对控制器的请求；由于中间件运行在一个更底层、更抽象的级别，因此在中间件中无法处理<code>IActionResult</code>、<code>ActionDescriptor</code>等<code>MVC</code>中间件特有的概念。</p>
<p>中间件和筛选器可以完成很多相似的功能，比如我们既可以编写“未处理异常中间件”，也可以编写“未处理异常筛选器”，但是未处理异常中间件可以处理所有管道中的异常，而未处理异常筛选器只能处理<code>ASP.NET Core MVC</code>中的异常；同样地，我们既可以编写“请求限流中间件”，也可以编写“请求限流筛选器”，但是请求限流中间件可以对所有请求进行限流，而请求限流筛选器只能对控制器的访问进行限流。</p>
<p>由于中间件工作在比筛选器更低的层级中，因此在实现同样的功能的时候，中间件的运行效率更高。比如，我们要实现“请求限流”，如果通过中间件实现，对于超限的请求，我们可以在中间件中对其进行截断；如果通过筛选器的话，超限的请求也会被管道中的多个中间件处理，其中包括<code>MVC</code>中间件的处理，从而浪费更多的服务器处理资源。</p>
<p>总之，在开发一个对请求进行前后逻辑编程的组件的时候，优先选择使用中间件；但是如果这个组件只针对<code>MVC</code>或者需要调用一些与<code>MVC</code>相关的类的时候，就只能选择筛选器。</p>
<h3 id="11-8异常处理中间件"><a href="#11-8异常处理中间件" class="headerlink" title="11.8异常处理中间件"></a>11.8异常处理中间件</h3><p>这里创建一个具有<code>MVC</code>模版的项目进行演示</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C://Users/86159/Desktop/images/656.png"></p>
<p>为了进行测试。修改<code>Program.cs</code>文件中的代码</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!app.Environment.IsDevelopment())</span><br><span class="line">&#123;</span><br><span class="line">    app.UseExceptionHandler(<span class="string">&quot;/Home/Error&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    app.UseExceptionHandler(<span class="string">&quot;/Product/Error&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在开发环境中，所访问的控制器中的方法如果出现了错误，会跳转到<code>/Product/Error</code></p>
<p>处理异常如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Configure the HTTP request pipeline.</span></span><br><span class="line"><span class="keyword">if</span> (!app.Environment.IsDevelopment())</span><br><span class="line">&#123;</span><br><span class="line">    app.UseExceptionHandler(<span class="string">&quot;/Home/Error&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    app.UseExceptionHandler((configuration) =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        configuration.Run(<span class="keyword">async</span> context =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> exHandler = context.Features.Get&lt;IExceptionHandlerPathFeature&gt;()!;</span><br><span class="line">            <span class="keyword">var</span> ex = exHandler.Error;</span><br><span class="line">            <span class="keyword">if</span> (ex != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">await</span> context.Response.WriteAsJsonAsync(<span class="keyword">new</span> &#123; code = <span class="number">500</span>, errPath = exHandler.Path, msg = <span class="string">$&quot;服务器内部错误&quot;</span> &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="12、路由"><a href="#12、路由" class="headerlink" title="12、路由"></a>12、路由</h2><p>当浏览器端发送了请求以后，找到对应的控制器和方法，是通过路由完成的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// 匹配到合适的路由</span><br><span class="line">app.UseRouting();</span><br><span class="line"></span><br><span class="line">// 定义路由的规则</span><br><span class="line">app.MapControllerRoute(</span><br><span class="line">    name: &quot;default&quot;, </span><br><span class="line">    pattern: &quot;&#123;controller=Home&#125;/&#123;action=Index&#125;/&#123;id?&#125;&quot;);</span><br></pre></td></tr></table></figure>

<p><strong>属性路由</strong></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 匹配到合适的路由</span></span><br><span class="line"><span class="comment">/*app.UseRouting();*/</span></span><br><span class="line"></span><br><span class="line">app.UseAuthorization();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义路由的规则</span></span><br><span class="line"><span class="comment">/*app.MapControllerRoute(</span></span><br><span class="line"><span class="comment">    name: &quot;default&quot;, </span></span><br><span class="line"><span class="comment">    pattern: &quot;&#123;controller=Home&#125;/&#123;action=Index&#125;/&#123;id?&#125;&quot;);*/</span></span><br><span class="line">app.MapControllers();</span><br></pre></td></tr></table></figure>

<p>在<code>Program.cs</code>文件中我们使用了<code>MapControllers</code>,用来实现属性路由。</p>
<p><code>TestController.cs</code>中的代码如下所示</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">WebApplication7.Controllers</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">Route(<span class="string">&quot;/Test&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TestController</span> : <span class="title">Controller</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">Route(<span class="string">&quot;Index&quot;</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Index</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="comment">/*  return View();*/</span></span><br><span class="line">          <span class="keyword">return</span> Content(<span class="string">&quot;Index&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        [<span class="meta">Route(<span class="string">&quot;Test/&#123;id&#125;&quot;</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Test</span>(<span class="params"><span class="built_in">int</span> id</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> Content(<span class="string">&quot;Test&quot;</span>+id);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>以上写法比较麻烦</p>
<p>可以采用如下的写法：	</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">WebApplication7.Controllers</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">Route(<span class="string">&quot;[controller]/[action]/&#123;id?&#125;&quot;</span>)</span>] </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TestController</span> : <span class="title">Controller</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Index</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="comment">/*  return View();*/</span></span><br><span class="line">          <span class="keyword">return</span> Content(<span class="string">&quot;Index&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">       </span><br><span class="line">        <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Test</span>(<span class="params"><span class="built_in">int</span> id</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> Content(<span class="string">&quot;Test&quot;</span>+id);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>http://localhost:5160/test/index</code></p>
<p>输入<code>index</code>方法名以后才能访问该方法。</p>
<h2 id="13、状态保持"><a href="#13、状态保持" class="headerlink" title="13、状态保持"></a>13、状态保持</h2><h3 id="13-1-Cookie"><a href="#13-1-Cookie" class="headerlink" title="13.1  Cookie"></a>13.1  <code>Cookie</code></h3><h4 id="13-1-1-Cookie基本使用"><a href="#13-1-1-Cookie基本使用" class="headerlink" title="13.1.1 Cookie基本使用"></a>13.1.1 <code>Cookie</code>基本使用</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C://Users/86159/Desktop/images/348.png"></p>
<p><code>cookie:</code>一小段文本，明文。存储在客户端的浏览器内存里面或者磁盘。<code>cookie</code>是跟网站相关，百度可以往客户端写<code>cookie</code>，<code>sina</code>也可写<code>cookie</code>，但是百度只能读取跟百度网站相关的<code>cookie</code>。<br><code>cookie</code>会随着请求网站一块发送到服务端【如果请求百度的时候，那么就把百度的cookie放到请求报文里面去，然后发送到服务端。】</p>
<p><code>cookie可</code>以设置一个Path来限制某个路径下面的页面才会把<code>cookie</code>发送到后台。<br>比如：请求图片，请求一个<code>css、js</code>，为了提高性能，可以通过 <code>path</code>设置页面的所在路径，来控制<code>cookie</code>的发送。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> CookieOptions options = <span class="keyword">new</span> CookieOptions();</span><br><span class="line">options.Expires = DateTime.Now.AddMinutes(<span class="number">3</span>);</span><br><span class="line">options.Path = <span class="string">&quot;product&quot;</span>;</span><br></pre></td></tr></table></figure>

<p><code> Cookie</code>的域：浏览器往后台发送数据时候，要把<code>cookie</code>放到请求报文里面去，发送到后台。<br>那么有个问题：请求是子域的网页，那么主域的<code>cookie</code>会不会发送到服务器呢？<br>答案：是的。一块发送。如果请求时主域页面，子域的<code>cooki</code>e是不会发送到后台的。<br>如果子域想让请求主域页面的时候也一块发送到后台，设置当前<code>Cookie</code>的域为主域可以了。</p>
<p><code>cookie</code>是通过响应报文的方式写到前台。最终写入<code>Cookie</code>是通过响应报文头来的</p>
<p>在<code>TestController.cs</code>文件中创建<code>ShowForm</code>方法，代码如下所示：（实现记录用户的操作）</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">ShowForm</span>()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (Request.Cookies[<span class="string">&quot;userName&quot;</span>]!=<span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ViewBag.userName = Request.Cookies[<span class="string">&quot;userName&quot;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> View();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对应的视图</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">action</span>=<span class="string">&quot;/Test/SetCookie&quot;</span>&gt;</span></span><br><span class="line">    用户名 <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;userName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;@ViewBag.userName&quot;</span> /&gt;</span></span><br><span class="line">   密码 <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;userPwd&quot;</span>/&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;登录&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>SetCookie</code>方法的实现，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">SetCookie</span>()</span> &#123;</span><br><span class="line">    <span class="built_in">string</span>? userName =  Request.Form[<span class="string">&quot;userName&quot;</span>];</span><br><span class="line">    <span class="built_in">string</span>? userPwd = Request.Form[<span class="string">&quot;userPwd&quot;</span>];</span><br><span class="line">    <span class="keyword">if</span>(userName == <span class="string">&quot;admin&quot;</span> &amp;&amp; userPwd == <span class="string">&quot;123&quot;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        CookieOptions option = <span class="keyword">new</span> CookieOptions();</span><br><span class="line">        option.Expires = DateTime.Now.AddMinutes(<span class="number">3</span>);</span><br><span class="line">        Response.Cookies.Append(<span class="string">&quot;userName&quot;</span>, userName, option);</span><br><span class="line">        <span class="keyword">return</span> Content(<span class="string">&quot;ok&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> Content(<span class="string">&quot;用户名密码错误&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动项目进行测试，查看报文（请求报文头）。</p>
<p>在<code>Application</code>中查看<code>Cookie</code>信息的存储。</p>
<p>在生命周期内，访问其他方法，也会带上这个<code>cookie</code>信息。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">Test2</span>()</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">if</span> (Request.Cookies[<span class="string">&quot;userName&quot;</span>] != <span class="literal">null</span>)</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">return</span> Content(Request.Cookies[<span class="string">&quot;userName&quot;</span>]!.ToString());</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">else</span></span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">return</span> View();</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">               </span><br><span class="line">       &#125; <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Test2</span>()</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">return</span> View();  </span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>在<code>Test2</code>中可以获取到<code>Cookie</code>.</p>
<h4 id="13-1-2-封装处理"><a href="#13-1-2-封装处理" class="headerlink" title="13.1.2 封装处理"></a>13.1.2 封装处理</h4><p>创建<code>CookieHelper.cs</code>文件(在<code>MVC</code>项目中创建一个<code>Untils</code>文件夹)，该文件中的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">WebApplication7</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CookieHelper</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 获取Cookie信息</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;context&quot;&gt;</span>请求上下文<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;key&quot;&gt;</span>键<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">Get</span>(<span class="params">HttpContext context,<span class="built_in">string</span> key</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> context.Request.Cookies[key]!;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 设置cookie的信息</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;key&quot;&gt;</span>键<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;value&quot;&gt;</span>值<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;expireTime&quot;&gt;</span>过期时间<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Set</span>(<span class="params">HttpContext context,<span class="built_in">string</span> key, <span class="built_in">string</span> <span class="keyword">value</span>,<span class="built_in">int</span>? expireTime</span>)</span> &#123; </span><br><span class="line">            CookieOptions options = <span class="keyword">new</span> CookieOptions();</span><br><span class="line">            <span class="keyword">if</span> (expireTime.HasValue)</span><br><span class="line">            &#123;</span><br><span class="line">                 options.Expires = DateTime.Now.AddMinutes(expireTime.Value);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            context.Response.Cookies.Append(key, <span class="keyword">value</span>, options);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 删除cookie数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;key&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Remove</span>(<span class="params">HttpContext context,<span class="built_in">string</span> key</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            context.Response.Cookies.Delete(key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>进行测试：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">ShowForm</span>()</span> &#123;</span><br><span class="line">            <span class="comment">/*  if (Request.Cookies[&quot;userName&quot;]!=null)</span></span><br><span class="line"><span class="comment">              &#123;</span></span><br><span class="line"><span class="comment">                  ViewBag.userName = Request.Cookies[&quot;userName&quot;];</span></span><br><span class="line"><span class="comment">              &#125;*/</span></span><br><span class="line">            <span class="keyword">if</span> (CookieHelper.Get(HttpContext, <span class="string">&quot;userName&quot;</span>) != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ViewBag.userName = CookieHelper.Get(HttpContext, <span class="string">&quot;userName&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> View();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> IActionResult <span class="title">SetCookie</span>()</span> &#123;</span><br><span class="line">          <span class="built_in">string</span>? userName =  Request.Form[<span class="string">&quot;userName&quot;</span>];</span><br><span class="line">            <span class="built_in">string</span>? userPwd = Request.Form[<span class="string">&quot;userPwd&quot;</span>];</span><br><span class="line">            <span class="keyword">if</span>(userName == <span class="string">&quot;admin&quot;</span> &amp;&amp; userPwd == <span class="string">&quot;123&quot;</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">/*  CookieOptions option = new CookieOptions();</span></span><br><span class="line"><span class="comment">                  option.Expires = DateTime.Now.AddMinutes(30);</span></span><br><span class="line"><span class="comment">                */</span><span class="comment">/*  option.Path = &quot;/Test/ShowForm&quot;;*/</span><span class="comment">/*</span></span><br><span class="line"><span class="comment">                  Response.Cookies.Append(&quot;userName&quot;, userName, option);*/</span></span><br><span class="line">                CookieHelper.Set(HttpContext, <span class="string">&quot;userName&quot;</span>, userName, <span class="number">20</span>);</span><br><span class="line">               </span><br><span class="line">                <span class="keyword">return</span> Content(<span class="string">&quot;ok&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> Content(<span class="string">&quot;用户名密码错误&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">         </span><br><span class="line"></span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h3 id="13-2-Session"><a href="#13-2-Session" class="headerlink" title="13.2 Session"></a>13.2 <code>Session</code></h3><h4 id="13-2-1-Session基本使用"><a href="#13-2-1-Session基本使用" class="headerlink" title="13.2.1 Session基本使用"></a>13.2.1 <code>Session</code>基本使用</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/86159/Desktop/images/817.png"></p>
<p>启用<code>Session</code></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">builder.Services.AddControllersWithViews();</span><br><span class="line">builder.Services.AddSession(); <span class="comment">// 添加Session到容器中</span></span><br><span class="line"><span class="keyword">var</span> app = builder.Build();</span><br><span class="line"></span><br><span class="line">app.UseSession();<span class="comment">// 使用Session中间件</span></span><br><span class="line">app.MapControllers();</span><br></pre></td></tr></table></figure>

<p>在控制器中进行测试</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult  <span class="title">Login</span>()</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">return</span> View();</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>以上方法对应的视图</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">action</span>=<span class="string">&quot;/Test/CheckLogin&quot;</span>&gt;</span></span><br><span class="line">    用户名:<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;userName&quot;</span> /&gt;</span></span><br><span class="line">    密码:<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;userPwd&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;登录&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">CheckLogin</span>()</span> &#123;</span><br><span class="line">           <span class="keyword">var</span> userName = Request.Form[<span class="string">&quot;userName&quot;</span>];</span><br><span class="line">           <span class="keyword">var</span> userPwd = Request.Form[<span class="string">&quot;userPwd&quot;</span>];</span><br><span class="line">           <span class="keyword">if</span>(userName == <span class="string">&quot;admin&quot;</span> &amp;&amp; userPwd == <span class="string">&quot;123&quot;</span>)</span><br><span class="line">           &#123;</span><br><span class="line">               HttpContext.Session.SetString(<span class="string">&quot;username&quot;</span>, userName!);</span><br><span class="line">               <span class="keyword">return</span> Redirect(<span class="string">&quot;/test/ShowSession&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">else</span></span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">return</span> Content(<span class="string">&quot;OK&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           </span><br><span class="line">       &#125;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> IActionResult <span class="title">ShowSession</span>()</span> &#123;</span><br><span class="line">         <span class="built_in">string</span> name = HttpContext.Session.GetString(<span class="string">&quot;username&quot;</span>)!;</span><br><span class="line">           <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrEmpty(name))</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">return</span> Content(name);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="keyword">return</span> Content(<span class="string">&quot;请登录才能够访问!&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<h4 id="13-2-2-Session-相关的配置"><a href="#13-2-2-Session-相关的配置" class="headerlink" title="13.2.2 Session 相关的配置"></a>13.2.2 <code>Session</code> 相关的配置</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C://Users/86159/Desktop/images/155.png"></p>
<h4 id="13-2-3-存储序列化对象"><a href="#13-2-3-存储序列化对象" class="headerlink" title="13.2.3   存储序列化对象"></a>13.2.3   存储序列化对象</h4><p><code>Session</code>在实际应用中大部分情况下存储的还是对象，就像上一小节中，我们一般都是将登录成功的用户信息存储到<code>session</code>中。</p>
<p>问题是怎样将对象存储到<code>session</code>对象中呢？</p>
<p>安装包：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Install-Package Newtonsoft.JSON</span><br></pre></td></tr></table></figure>

<p>在<code>Models</code>文件夹下面创建<code>UserInfo.cs</code>这个实体类，该类中的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserInfo</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">int</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; </span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">string</span>? Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;    </span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">string</span>? Email &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;       </span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>修改控制器中的代码</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">CheckLogin</span>()</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> userName = Request.Form[<span class="string">&quot;userName&quot;</span>];</span><br><span class="line">    <span class="keyword">var</span> userPwd = Request.Form[<span class="string">&quot;userPwd&quot;</span>];</span><br><span class="line">    <span class="keyword">if</span>(userName == <span class="string">&quot;admin&quot;</span> &amp;&amp; userPwd == <span class="string">&quot;123&quot;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/*    HttpContext.Session.SetString(&quot;username&quot;, userName!);*/</span></span><br><span class="line">        UserInfo userInfo = <span class="keyword">new</span> UserInfo() &#123; Id = <span class="number">1</span>,Name = <span class="string">&quot;zhangsan&quot;</span>,Email = <span class="string">&quot;zhangsan@126.com&quot;</span> &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> userJSON = JsonConvert.SerializeObject(userInfo);</span><br><span class="line">        HttpContext.Session.SetString(<span class="string">&quot;userInfo&quot;</span>, userJSON);</span><br><span class="line">        <span class="keyword">return</span> Redirect(<span class="string">&quot;/test/ShowSession&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> Content(<span class="string">&quot;OK&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在上面的代码中，通过<code>JsonConvert.SerializeObject</code>方法，将对象序列化为<code>JSON</code>格式的字符串，然后存储到<code>Session</code>中。</p>
<p>下面看一下怎样进行获取？</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">ShowSession</span>()</span> &#123;</span><br><span class="line">           <span class="comment">/*string name = HttpContext.Session.GetString(&quot;username&quot;)!;*/</span></span><br><span class="line">           <span class="keyword">var</span> userJson = HttpContext.Session.GetString(<span class="string">&quot;userInfo&quot;</span>);</span><br><span class="line">           <span class="keyword">var</span> userInfo = JsonConvert.DeserializeObject&lt;UserInfo&gt;(userJson!);</span><br><span class="line">           <span class="keyword">if</span> (userInfo!=<span class="literal">null</span>)</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">return</span> Json(userInfo);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="keyword">return</span> Content(<span class="string">&quot;请登录才能够访问!&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>在上面的代码中是通过<code> JsonConvert.DeserializeObjec</code>把<code>json</code>格式的字符串转换成对应的对象。</p>
<p>启动项目进行测试。</p>
<h4 id="13-2-4-封装处理"><a href="#13-2-4-封装处理" class="headerlink" title="13.2.4  封装处理"></a>13.2.4  封装处理</h4><p>如果在向<code>Session</code>中存储对象和去数据的时候，都进行序列化和反序列化，写起来比较麻烦。</p>
<p>可以进行封装的处理。</p>
<p>创建一个<code>SessionHelper.cs</code>类（在<code>Untils</code>文件夹中创建该类），该类中的代码：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SessionHelper</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Set</span>&lt;<span class="title">T</span>&gt;(<span class="params">HttpContext context,<span class="built_in">string</span> key,T obj</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           context.Session.SetString(key,JsonConvert.SerializeObject(obj));</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> T <span class="title">GET</span>&lt;<span class="title">T</span>&gt;(<span class="params">HttpContext context,<span class="built_in">string</span> key</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">return</span> JsonConvert.DeserializeObject&lt;T&gt;(context.Session.GetString(key)!)!;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>控制器中的代码的修改：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">CheckLogin</span>()</span> &#123;</span><br><span class="line">          <span class="keyword">var</span> userName = Request.Form[<span class="string">&quot;userName&quot;</span>];</span><br><span class="line">          <span class="keyword">var</span> userPwd = Request.Form[<span class="string">&quot;userPwd&quot;</span>];</span><br><span class="line">          <span class="keyword">if</span>(userName == <span class="string">&quot;admin&quot;</span> &amp;&amp; userPwd == <span class="string">&quot;123&quot;</span>)</span><br><span class="line">          &#123;</span><br><span class="line">          <span class="comment">/*    HttpContext.Session.SetString(&quot;username&quot;, userName!);*/</span></span><br><span class="line">             UserInfo userInfo = <span class="keyword">new</span> UserInfo() &#123; Id = <span class="number">1</span>,Name = <span class="string">&quot;zhangsan&quot;</span>,Email = <span class="string">&quot;zhangsan@126.com&quot;</span> &#125;;</span><br><span class="line"></span><br><span class="line">              <span class="comment">/* var userJSON = JsonConvert.SerializeObject(userInfo);</span></span><br><span class="line"><span class="comment">                HttpContext.Session.SetString(&quot;userInfo&quot;, userJSON);*/</span></span><br><span class="line">              SessionHelper.Set(HttpContext,<span class="string">&quot;userInfo&quot;</span>,userInfo);</span><br><span class="line">              <span class="keyword">return</span> Redirect(<span class="string">&quot;/test/ShowSession&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">              <span class="keyword">return</span> Content(<span class="string">&quot;OK&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          </span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">ShowSession</span>()</span> &#123;</span><br><span class="line">           <span class="comment">/*string name = HttpContext.Session.GetString(&quot;username&quot;)!;*/</span></span><br><span class="line">           <span class="comment">/*var userJson = HttpContext.Session.GetString(&quot;userInfo&quot;);</span></span><br><span class="line"><span class="comment">           var userInfo = JsonConvert.DeserializeObject&lt;UserInfo&gt;(userJson!);*/</span></span><br><span class="line">         <span class="keyword">var</span> userInfo =  SessionHelper.GET&lt;UserInfo&gt;(HttpContext, <span class="string">&quot;userInfo&quot;</span>);</span><br><span class="line">           <span class="keyword">if</span> (userInfo!=<span class="literal">null</span>)</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">return</span> Json(userInfo);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="keyword">return</span> Content(<span class="string">&quot;请登录才能够访问!&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>下面启动项目进行测试</p>
<h4 id="13-2-5-Protobuf序列化"><a href="#13-2-5-Protobuf序列化" class="headerlink" title="13.2.5  Protobuf序列化"></a>13.2.5  <code>Protobuf</code>序列化</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C://Users/86159/Desktop/images/637.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">XML、JSON是目前常用的数据交换格式，它们可读性较好。但序列化后的数据字节很大，序列化和反序列化的时间较长，数据传输效率不高。</span><br><span class="line"></span><br><span class="line">   Protobuf和Xml、Json序列化的方式不同，采用了二进制字节的序列化方式，用字段索引和字段类型通过算法计算得到字段之前的关系映射，从而达到更高的时间效率和空间效率，特别适合对数据大小和传输速率比较敏感的场合使用。</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>第一步：给<code>Models/UserInfo.cs</code>实体类添加标识，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> ProtoBuf;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">WebApplication7.Models</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">ProtoContract</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserInfo</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">ProtoMember(1)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        [<span class="meta">ProtoMember(2)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        [<span class="meta">ProtoMember(3)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? Email &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;       </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>序列化的类需要通过 <code>[ProtoContract]</code> 进行标识，里面的属性&#x2F;字段则需要使用<code>[ProtoMember(x)]</code>标识，因为在序列化的时候，将使用整数x替换字段名称，这样能够节省大量内存</p>
<p>对于字段标识符，有以下几点需要注意：</p>
<ul>
<li>它们必须是正整数（为了更好的可移植性，x应该 &lt;&#x3D; 536870911 并且不在 19000-19999 范围内）</li>
<li><strong>在单个类中，它们必须是唯一的</strong></li>
<li>标识符不能与任何继承标识符冲突</li>
<li>数字越小占用的内存也越小，因此不要从100000 这种很大的值开始</li>
<li>标识符十分重要，修改成员名称没有关系，但修改标识符就相当于修改了数据</li>
</ul>
<p>第二步：对所封装的<code>SessionHelper.cs</code>类中的代码进行修改：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Newtonsoft.Json;</span><br><span class="line"><span class="keyword">using</span> ProtoBuf;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">WebApplication7</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SessionHelper</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/*  public static void Set&lt;T&gt;(HttpContext context,string key,T obj)</span></span><br><span class="line"><span class="comment">          &#123;</span></span><br><span class="line"><span class="comment">              context.Session.SetString(key,JsonConvert.SerializeObject(obj));</span></span><br><span class="line"><span class="comment">          &#125;</span></span><br><span class="line"><span class="comment">          public static T GET&lt;T&gt;(HttpContext context,string key)</span></span><br><span class="line"><span class="comment">          &#123;</span></span><br><span class="line"><span class="comment">              return JsonConvert.DeserializeObject&lt;T&gt;(context.Session.GetString(key)!)!;</span></span><br><span class="line"><span class="comment">          &#125;*/</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Set</span>&lt;<span class="title">T</span>&gt;(<span class="params">HttpContext context, <span class="built_in">string</span> key, T obj</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(obj == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> ;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 流的本质就是二进制数据</span></span><br><span class="line">            <span class="keyword">using</span> (<span class="keyword">var</span> ms = <span class="keyword">new</span> MemoryStream())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 将obj对象序列到ms内存流中。</span></span><br><span class="line">                Serializer.Serialize(ms, obj);</span><br><span class="line">                context.Session.Set(key,ms.ToArray()); <span class="comment">// 这里的Set方法的第二个参数就是byte数组</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> T? GET&lt;T&gt;(HttpContext context, <span class="built_in">string</span> key)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> buffer = context.Session.Get(key);</span><br><span class="line">            <span class="keyword">if</span>(buffer != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">using</span> (<span class="keyword">var</span> ms = <span class="keyword">new</span> MemoryStream(buffer))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> Serializer.Deserialize&lt;T&gt;(ms);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">default</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>控制器中方法的代码不需要修改，启动项目进行测试。</p>
<p>思考题：假设有三个控制器，每个控制器中有10个方法，都需要登录以后才能够访问，也就是<code>Session</code>中必须有值，应该怎样进行处理。</p>
<h2 id="14、验证码"><a href="#14、验证码" class="headerlink" title="14、验证码"></a>14、验证码</h2><p>控制器中的代码：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">CreateImageCode</span>()</span> &#123;</span><br><span class="line"></span><br><span class="line">           <span class="built_in">string</span> code = CreateRandomCode(<span class="number">5</span>);</span><br><span class="line">           HttpContext.Session.SetString(<span class="string">&quot;imgCode&quot;</span>,code);</span><br><span class="line">       </span><br><span class="line">           <span class="keyword">return</span> File(CreateValidateGraphic(code), <span class="string">&quot;image/Jpeg&quot;</span>);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">private</span> <span class="built_in">string</span> <span class="title">CreateRandomCode</span>(<span class="params"><span class="built_in">int</span> codeCount</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="built_in">string</span> allChar = <span class="string">&quot;0,1,2,3,4,5,6,7,8,9,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,W,X,Y,Z&quot;</span>;</span><br><span class="line">           <span class="built_in">string</span>[] allCharArray = allChar.Split(<span class="string">&#x27;,&#x27;</span>);</span><br><span class="line">           <span class="built_in">string</span> randomCode = <span class="string">&quot;&quot;</span>;</span><br><span class="line">           <span class="built_in">int</span> temp = <span class="number">-1</span>;</span><br><span class="line">           Random rand = <span class="keyword">new</span> Random();</span><br><span class="line">           <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; codeCount; i++)</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">if</span> (temp != <span class="number">-1</span>)</span><br><span class="line">               &#123;</span><br><span class="line">                   rand = <span class="keyword">new</span> Random(i * temp * ((<span class="built_in">int</span>)DateTime.Now.Ticks));</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="built_in">int</span> t = rand.Next(<span class="number">35</span>);</span><br><span class="line">               <span class="keyword">if</span> (temp == t)</span><br><span class="line">               &#123;</span><br><span class="line">                   <span class="keyword">return</span> CreateRandomCode(codeCount);</span><br><span class="line">               &#125;</span><br><span class="line">               temp = t;</span><br><span class="line">               randomCode += allCharArray[t];</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> randomCode;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 创建验证码的图片</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="built_in">byte</span>[] <span class="title">CreateValidateGraphic</span>(<span class="params"><span class="built_in">string</span> validateCode</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">using</span> (Bitmap image = <span class="keyword">new</span> Bitmap((<span class="built_in">int</span>)Math.Ceiling(validateCode.Length * <span class="number">16.0</span>), <span class="number">27</span>))</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">using</span> (Graphics g = Graphics.FromImage(image))</span><br><span class="line">               &#123;</span><br><span class="line">                   <span class="keyword">try</span></span><br><span class="line">                   &#123;</span><br><span class="line">                       <span class="comment">//生成随机生成器</span></span><br><span class="line">                       Random random = <span class="keyword">new</span> Random();</span><br><span class="line">                       <span class="comment">//清空图片背景色</span></span><br><span class="line">                       g.Clear(Color.White);</span><br><span class="line">                       <span class="comment">//画图片的干扰线</span></span><br><span class="line">                       <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">25</span>; i++)</span><br><span class="line">                       &#123;</span><br><span class="line">                           <span class="built_in">int</span> x1 = random.Next(image.Width);</span><br><span class="line">                           <span class="built_in">int</span> x2 = random.Next(image.Width);</span><br><span class="line">                           <span class="built_in">int</span> y1 = random.Next(image.Height);</span><br><span class="line">                           <span class="built_in">int</span> y2 = random.Next(image.Height);</span><br><span class="line">                           g.DrawLine(<span class="keyword">new</span> Pen(Color.Silver), x1, y1, x2, y2);</span><br><span class="line">                       &#125;</span><br><span class="line">                       Font font = <span class="keyword">new</span> Font(<span class="string">&quot;Arial&quot;</span>, <span class="number">13</span>, (FontStyle.Bold | FontStyle.Italic));</span><br><span class="line">                       <span class="comment">// 线性渐变画刷</span></span><br><span class="line">                       LinearGradientBrush brush = <span class="keyword">new</span> LinearGradientBrush(<span class="keyword">new</span> Rectangle(<span class="number">0</span>, <span class="number">0</span>, image.Width, image.Height),</span><br><span class="line">                        Color.Blue, Color.DarkRed, <span class="number">1.2f</span>, <span class="literal">true</span>);</span><br><span class="line">                       g.DrawString(validateCode, font, brush, <span class="number">3</span>, <span class="number">2</span>);</span><br><span class="line">                       <span class="comment">//画图片的前景干扰点</span></span><br><span class="line">                       <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++)</span><br><span class="line">                       &#123;</span><br><span class="line">                           <span class="built_in">int</span> x = random.Next(image.Width);</span><br><span class="line">                           <span class="built_in">int</span> y = random.Next(image.Height);</span><br><span class="line">                           image.SetPixel(x, y, Color.FromArgb(random.Next()));</span><br><span class="line">                       &#125;</span><br><span class="line">                       <span class="comment">//画图片的边框线</span></span><br><span class="line">                       g.DrawRectangle(<span class="keyword">new</span> Pen(Color.Silver), <span class="number">0</span>, <span class="number">0</span>, image.Width - <span class="number">1</span>, image.Height - <span class="number">1</span>);</span><br><span class="line">                       <span class="comment">//保存图片数据</span></span><br><span class="line">                       MemoryStream stream = <span class="keyword">new</span> MemoryStream();</span><br><span class="line">                       image.Save(stream, ImageFormat.Jpeg);</span><br><span class="line">                       <span class="comment">//输出图片流</span></span><br><span class="line">                       <span class="keyword">return</span> stream.ToArray();</span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="keyword">finally</span></span><br><span class="line">                   &#123;</span><br><span class="line">                       g.Dispose();</span><br><span class="line">                       image.Dispose();</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">                 </span><br><span class="line">           &#125;</span><br><span class="line">             </span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p><code>views/Test/Login.cshtml</code>登录表单中的代码：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">action</span>=<span class="string">&quot;/Test/CheckLogin&quot;</span>&gt;</span></span><br><span class="line">    用户名:<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;userName&quot;</span> /&gt;</span> <span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">    密码:<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;userPwd&quot;</span> /&gt;</span> <span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">    验证码:<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;userCode&quot;</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;/test/CreateImageCode&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;this.src=&#x27;/test/CreateImageCode?d=&#x27;+new Date()&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;登录&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>下面继续修改<code>CheckLogin</code>方法中的代码需要判断验证码是否正确。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">CheckLogin</span>()</span> &#123;</span><br><span class="line">           <span class="keyword">var</span> userName = Request.Form[<span class="string">&quot;userName&quot;</span>];</span><br><span class="line">           <span class="keyword">var</span> userPwd = Request.Form[<span class="string">&quot;userPwd&quot;</span>];</span><br><span class="line">           <span class="keyword">var</span> userCode = Request.Form[<span class="string">&quot;userCode&quot;</span>]; <span class="comment">// 接收验证码</span></span><br><span class="line">           <span class="keyword">if</span>(HttpContext.Session.GetString(<span class="string">&quot;imgCode&quot;</span>) == <span class="string">&quot;&quot;</span>)</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">return</span> Content(<span class="string">&quot;验证码不能为空!!&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">    <span class="comment">// 在验证码的比较中需要忽略大小写</span></span><br><span class="line">           <span class="keyword">if</span>(!<span class="built_in">string</span>.Equals(HttpContext.Session.GetString(<span class="string">&quot;imgCode&quot;</span>),userCode,StringComparison.CurrentCultureIgnoreCase))</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">return</span> Content(<span class="string">&quot;验证码输入错误!!&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">if</span>(userName == <span class="string">&quot;admin&quot;</span> &amp;&amp; userPwd == <span class="string">&quot;123&quot;</span>)</span><br><span class="line">           &#123;</span><br><span class="line">           <span class="comment">/*    HttpContext.Session.SetString(&quot;username&quot;, userName!);*/</span></span><br><span class="line">              UserInfo userInfo = <span class="keyword">new</span> UserInfo() &#123; Id = <span class="number">1</span>,Name = <span class="string">&quot;zhangsan&quot;</span>,Email = <span class="string">&quot;zhangsan@126.com&quot;</span> &#125;;</span><br><span class="line"></span><br><span class="line">               <span class="comment">/* var userJSON = JsonConvert.SerializeObject(userInfo);</span></span><br><span class="line"><span class="comment">                 HttpContext.Session.SetString(&quot;userInfo&quot;, userJSON);*/</span></span><br><span class="line">               SessionHelper.Set(HttpContext,<span class="string">&quot;userInfo&quot;</span>,userInfo);</span><br><span class="line">               <span class="keyword">return</span> Redirect(<span class="string">&quot;/test/ShowSession&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">else</span></span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">return</span> Content(<span class="string">&quot;OK&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           </span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<h2 id="15、AJAX应用"><a href="#15、AJAX应用" class="headerlink" title="15、AJAX应用"></a>15、<code>AJAX</code>应用</h2><h3 id="15-1-什么是Ajax"><a href="#15-1-什么是Ajax" class="headerlink" title="15.1   什么是Ajax"></a>15.1   什么是<code>Ajax</code></h3><p>什么是<code>AJAX</code>?</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Ajax 是浏览器中的技术：用来实现客户端网页请求服务器的数据。</span><br><span class="line">它的英文全称是 Asynchronous Javascript And  XML</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C://Users/86159/Desktop/images/505.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C://Users/86159/Desktop/images/557.png"></p>
<h3 id="15-2-使用axios发送get请求"><a href="#15-2-使用axios发送get请求" class="headerlink" title="15.2 使用axios发送get请求"></a>15.2 使用<code>axios</code>发送<code>get</code>请求</h3><p>新建一个<code>MVC</code>项目(<code>WebApplication8</code>)，创建一个<code>UserInfoController.cs</code>,为所对应的<code>Index</code>方法创建视图。</p>
<p>视图中的代码如下所示：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 必须先导入 axios 的库文件，然后就可以调用 axios() 函数了 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/js/axios.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// =================================== 目标 ===================================</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 发起 GET 请求，获取图书列表的数据</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// </span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">axios</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 请求的url地址</span></span></span><br><span class="line"><span class="language-javascript">            <span class="attr">url</span>: <span class="string">&#x27;/UserInfo/GetBooks&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 请求方式： get post delete put patch</span></span></span><br><span class="line"><span class="language-javascript">            <span class="attr">method</span>: <span class="string">&#x27;get&#x27;</span></span></span><br><span class="line"><span class="language-javascript">        &#125;).<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params">result</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 该回调函数会在请求成功的时候会来执行</span></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 形参 result（对象） 里面包含有 服务器响应回来的结果（data属性中）</span></span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;该回调函数会在请求成功的时候会来执行&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(result)</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(result.<span class="property">data</span>) <span class="comment">// 服务器响应回来的结果</span></span></span><br><span class="line"><span class="language-javascript">        &#125;)</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里需要把<code>axios.js</code>这个文件添加到<code>wwwroot</code>目录下的<code>js</code>目录中。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">GetBooks</span>()</span></span><br><span class="line">       &#123;</span><br><span class="line">           List&lt;Book&gt;list = <span class="keyword">new</span> List&lt;Book&gt;()</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">new</span> Book()&#123;Id = <span class="number">1</span>, Title =<span class="string">&quot;C#高级&quot;</span>, Author = <span class="string">&quot;张三&quot;</span>,Description = <span class="string">&quot;包含c#高级知识点&quot;</span>,Price = <span class="number">80</span> &#125;,</span><br><span class="line">               <span class="keyword">new</span> Book()&#123;Id = <span class="number">2</span>, Title =<span class="string">&quot;Vue高级&quot;</span>, Author = <span class="string">&quot;李四&quot;</span>,Description = <span class="string">&quot;包含Vue高级知识点&quot;</span>,Price = <span class="number">70</span> &#125;,</span><br><span class="line">               <span class="keyword">new</span> Book()&#123;Id = <span class="number">3</span>, Title =<span class="string">&quot;.Net Core高级&quot;</span>, Author = <span class="string">&quot;王五&quot;</span>,Description = <span class="string">&quot;包含.Net Core高级知识点&quot;</span>,Price = <span class="number">90</span> &#125;</span><br><span class="line">              </span><br><span class="line">           &#125;;</span><br><span class="line">           <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123; code = <span class="number">200</span>, data = list &#125;);</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p><code>Models/Book.cs</code>实体类的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Book</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? Title &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? Description &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? Author &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">double</span> Price &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动项目进行测试。</p>
<p>15.3 </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// =================================== 目标 ===================================</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 发起 GET 请求，获取图书列表的数据</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// </span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">axios</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 请求的url地址</span></span></span><br><span class="line"><span class="language-javascript">            <span class="attr">url</span>: <span class="string">&#x27;/UserInfo/GetBook&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 请求方式： get post delete put patch</span></span></span><br><span class="line"><span class="language-javascript">            <span class="attr">method</span>: <span class="string">&#x27;get&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">           <span class="comment">// params 参数是用来指定查询条件</span></span></span><br><span class="line"><span class="language-javascript">            <span class="attr">params</span>:&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">id</span>:<span class="number">12</span>,</span></span><br><span class="line"><span class="language-javascript">                  <span class="comment">// bookname: &#x27;红楼梦&#x27;</span></span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;).<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params">result</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            </span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(result.<span class="property">data</span>) <span class="comment">// 服务器响应回来的结果</span></span></span><br><span class="line"><span class="language-javascript">        &#125;)</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>GetBook</code>方法的实现如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">GetBook</span>(<span class="params"><span class="built_in">int</span> id</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    List&lt;Book&gt; list = <span class="keyword">new</span> List&lt;Book&gt;()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">new</span> Book()&#123;Id = <span class="number">1</span>, Title =<span class="string">&quot;C#高级&quot;</span>, Author = <span class="string">&quot;张三&quot;</span>,Description = <span class="string">&quot;包含c#高级知识点&quot;</span>,Price = <span class="number">80</span> &#125;,</span><br><span class="line">        <span class="keyword">new</span> Book()&#123;Id = <span class="number">2</span>, Title =<span class="string">&quot;Vue高级&quot;</span>, Author = <span class="string">&quot;李四&quot;</span>,Description = <span class="string">&quot;包含Vue高级知识点&quot;</span>,Price = <span class="number">70</span> &#125;,</span><br><span class="line">        <span class="keyword">new</span> Book()&#123;Id = <span class="number">3</span>, Title =<span class="string">&quot;.Net Core高级&quot;</span>, Author = <span class="string">&quot;王五&quot;</span>,Description = <span class="string">&quot;包含.Net Core高级知识点&quot;</span>,Price = <span class="number">90</span> &#125;</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line">   <span class="keyword">var</span> book = list.Where(b=&gt;b.Id == id).FirstOrDefault();</span><br><span class="line">    <span class="keyword">if</span>(book != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123;code = <span class="number">200</span>, data = book&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123;code = <span class="number">404</span> ,msg = <span class="string">&quot;没有找到对应的书籍!!&quot;</span>&#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动项目进行测试。</p>
<h3 id="15-3-查询参数的本质"><a href="#15-3-查询参数的本质" class="headerlink" title="15.3  查询参数的本质"></a>15.3  查询参数的本质</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// =================================== 查询参数的本质 =================================== </span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 1. 查询参数会拼接到url地址后面，使用  ?  符号隔开</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 2. 查询参数的键和值之间使用  =    进行分隔</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 3. 并且多个查询参数之间使用  &amp;   符号进行分隔</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">axios</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="attr">url</span>: <span class="string">&#x27;/UserInfo/GetBook&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">      <span class="attr">method</span>: <span class="string">&#x27;get&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      <span class="comment">// params的查询参数，也可以直接这样书写url地址</span></span></span><br><span class="line"><span class="language-javascript">      <span class="comment">// url: &#x27;/UserInfo/GetBook?id=2&amp;age=19&#x27;,</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      <span class="comment">// params 参数是用来指定查询条件</span></span></span><br><span class="line"><span class="language-javascript">      <span class="attr">params</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 查询id为2的那一本书</span></span></span><br><span class="line"><span class="language-javascript">        <span class="attr">id</span>: <span class="number">2</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">age</span>: <span class="number">19</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">bookname</span>: <span class="string">&#x27;红楼梦&#x27;</span></span></span><br><span class="line"><span class="language-javascript">      &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">console</span>.<span class="title function_">log</span>(res)</span></span><br><span class="line"><span class="language-javascript">    &#125;)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// =================================== URL 编码处理 ===================================</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//  了解即可 （axios 会自动帮我们处理好编码）</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// encodeURI()  编码</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// decodeURI()  解码</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">encodeURI</span>(<span class="string">&#x27;西游记&#x27;</span>)) <span class="comment">// %E8%A5%BF%E6%B8%B8%E8%AE%B0</span></span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">decodeURI</span>(<span class="string">&#x27;%E8%A5%BF%E6%B8%B8%E8%AE%B0&#x27;</span>))</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="15-4-使用axios发起POST请求"><a href="#15-4-使用axios发起POST请求" class="headerlink" title="15.4 使用axios发起POST请求"></a>15.4 <code>使用axios发起POST请求</code></h3><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;button id=<span class="string">&quot;btnPOST&quot;</span>&gt;新增数据&lt;/button&gt;</span><br><span class="line">    &lt;!-- 必须先导入 axios 的库文件，然后就可以调用 axios() 函数了 --&gt;</span><br><span class="line">    &lt;script src=<span class="string">&quot;/js/axios.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">    &lt;script&gt;</span><br><span class="line">        document.querySelector(<span class="string">&#x27;#btnPOST&#x27;</span>).addEventListener(<span class="string">&#x27;click&#x27;</span>, function () &#123;</span><br><span class="line">            axios(&#123;</span><br><span class="line">                method: <span class="string">&#x27;post&#x27;</span>,</span><br><span class="line">                url: <span class="string">&#x27;/userInfo/addbook&#x27;</span>,               </span><br><span class="line">                data: &#123;</span><br><span class="line">                    <span class="comment">// 发送给服务器的数据</span></span><br><span class="line">                    Title: <span class="string">&#x27;React&#x27;</span>,</span><br><span class="line">                    Author: <span class="string">&#x27;马六&#x27;</span>,</span><br><span class="line">                    Description: <span class="string">&#x27;React 高级编程&#x27;</span>,</span><br><span class="line">                    Price:<span class="number">79</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).then((&#123; data: res &#125;) =&gt; &#123;</span><br><span class="line">                console.log(res) <span class="comment">// 对应的是啥？服务器响应回来的数据</span></span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>以上是视图中的代码</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">AddBook</span>(<span class="params">[FromBody] Book book</span>) <span class="comment">// 注意：这里必须添加FromBody 才可以进行模型的绑定</span></span></span><br><span class="line">      &#123;</span><br><span class="line">         <span class="built_in">int</span> maxId = list.Max(b=&gt;b.Id);</span><br><span class="line">          book.Id = maxId+<span class="number">1</span>;</span><br><span class="line">          list.Add(book);</span><br><span class="line">          <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123; code = <span class="number">200</span>, book &#125;);</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>以上是控制器中<code>AddBook</code>方法中的代码</p>
<p>同时上面<code>list</code>数据源也定义在最上面</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserInfoController</span> : <span class="title">Controller</span></span><br><span class="line">   &#123;</span><br><span class="line">       List&lt;Book&gt; list = <span class="keyword">new</span> List&lt;Book&gt;()</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">new</span> Book()&#123;Id = <span class="number">1</span>, Title =<span class="string">&quot;C#高级&quot;</span>, Author = <span class="string">&quot;张三&quot;</span>,Description = <span class="string">&quot;包含c#高级知识点&quot;</span>,Price = <span class="number">80</span> &#125;,</span><br><span class="line">               <span class="keyword">new</span> Book()&#123;Id = <span class="number">2</span>, Title =<span class="string">&quot;Vue高级&quot;</span>, Author = <span class="string">&quot;李四&quot;</span>,Description = <span class="string">&quot;包含Vue高级知识点&quot;</span>,Price = <span class="number">70</span> &#125;,</span><br><span class="line">               <span class="keyword">new</span> Book()&#123;Id = <span class="number">3</span>, Title =<span class="string">&quot;.Net Core高级&quot;</span>, Author = <span class="string">&quot;王五&quot;</span>,Description = <span class="string">&quot;包含.Net Core高级知识点&quot;</span>,Price = <span class="number">90</span> &#125;</span><br><span class="line"></span><br><span class="line">           &#125;;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Index</span>()</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">return</span> View();</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<h3 id="15-5-测试POST的请求体和查询参数"><a href="#15-5-测试POST的请求体和查询参数" class="headerlink" title="15.5  测试POST的请求体和查询参数"></a>15.5  测试POST的请求体和查询参数</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"> </span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">   <span class="comment">// 注意：在浏览器中，GET 请求比较特殊：它只有查询参数，没有请求体</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">   <span class="comment">// get请求方式：数据写在 params（查询参数，数据放到了url地址后面）</span></span></span><br><span class="line"><span class="language-javascript">   <span class="comment">// post请求方式：数据写在data（数据在请求体）</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">   <span class="title function_">axios</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">     <span class="attr">method</span>: <span class="string">&#x27;get&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">     <span class="attr">url</span>: <span class="string">&#x27;http://www.xxx.top:3009/api/get&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">     <span class="attr">params</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">       <span class="attr">a</span>: <span class="number">1</span>,</span></span><br><span class="line"><span class="language-javascript">       <span class="attr">b</span>: <span class="number">2</span></span></span><br><span class="line"><span class="language-javascript">     &#125;,</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">     <span class="comment">// 发送get请求，在data中传递数据，写了白写</span></span></span><br><span class="line"><span class="language-javascript">     <span class="attr">data</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">       <span class="attr">c</span>: <span class="number">3</span>,</span></span><br><span class="line"><span class="language-javascript">       <span class="attr">d</span>: <span class="number">4</span></span></span><br><span class="line"><span class="language-javascript">     &#125;</span></span><br><span class="line"><span class="language-javascript">   &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">&#123; data: res &#125;</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">     <span class="variable language_">console</span>.<span class="title function_">log</span>(res)</span></span><br><span class="line"><span class="language-javascript">   &#125;)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">   <span class="comment">// 注意点：</span></span></span><br><span class="line"><span class="language-javascript">   <span class="comment">//  对于 axios 在使用的时候，method url data params 这些都是固定的配置，单词不能写错</span></span></span><br><span class="line"><span class="language-javascript">   <span class="comment">//  对于params data里面写啥，具体看后面学习的接口文档</span></span></span><br><span class="line"><span class="language-javascript">   <span class="comment">/* axios(&#123;</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">     method: &#x27;post&#x27;,</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">     url: &#x27;http://www.xxxx.top:3009/api/post&#x27;,</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript"></span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">     // 查询参数</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">     params: &#123;</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">       a: 1,</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">       b: 2</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">     &#125;,</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript"></span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">     // 1. 当请求方式为post的时候，既可以带params查询参数，也可以带data请求体数据</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">     // 2. 当请求方式为get的时候，可以写params查询参数，不可以写data</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">     data: &#123;</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">       c: 3,</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">       d: 4</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">     &#125;</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">   &#125;).then((&#123; data: res &#125;) =&gt; &#123;</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">     console.log(res)</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">   &#125;) */</span></span></span><br><span class="line"><span class="language-javascript"> </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="15-6-用户登录"><a href="#15-6-用户登录" class="headerlink" title="15.6  用户登录"></a>15.6  用户登录</h3><p>在控制器中创建一个<code>Login</code>方法，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">Login</span>()</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">return</span> View();</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>以上方法对应的视图中的代码，如下所示：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/lib/bootstrap/dist/css/bootstrap.css&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/css/login.css&quot;</span>&gt;</span> <span class="comment">&lt;!--引入了样式--&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;login-box&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-group&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;username&quot;</span>&gt;</span>Account<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 账号 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span> <span class="attr">id</span>=<span class="string">&quot;username&quot;</span> <span class="attr">autocomplete</span>=<span class="string">&quot;off&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">small</span> <span class="attr">id</span>=<span class="string">&quot;emailHelp&quot;</span> <span class="attr">class</span>=<span class="string">&quot;form-text text-muted&quot;</span>&gt;</span>The available account is <span class="tag">&lt;<span class="name">strong</span>&gt;</span>admin<span class="tag">&lt;/<span class="name">strong</span>&gt;</span><span class="tag">&lt;/<span class="name">small</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-group&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 密码 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;password&quot;</span>&gt;</span>Password<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span> <span class="attr">id</span>=<span class="string">&quot;password&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">small</span> <span class="attr">id</span>=<span class="string">&quot;emailHelp&quot;</span> <span class="attr">class</span>=<span class="string">&quot;form-text text-muted&quot;</span>&gt;</span>The available password is <span class="tag">&lt;<span class="name">strong</span>&gt;</span>123456<span class="tag">&lt;/<span class="name">strong</span>&gt;</span><span class="tag">&lt;/<span class="name">small</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-primary&quot;</span> <span class="attr">id</span>=<span class="string">&quot;btnLogin&quot;</span>&gt;</span>Submit<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/js/axios.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 请求方式 POST</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 参数:  username 用户名     password  密码  ==&gt; 请求体参数，写在data中</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 步骤</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//  1. 给按钮注册click</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//  2. 获取输入框的值 ==&gt; value属性</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//  3. 使用axios发送请求，之后根据响应结果，做提示</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 1.</span></span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#btnLogin&#x27;</span>).<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 2.</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">let</span> username = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#username&#x27;</span>).<span class="property">value</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">let</span> password = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#password&#x27;</span>).<span class="property">value</span></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// console.log(username, password)</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 3.</span></span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">axios</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">method</span>: <span class="string">&#x27;post&#x27;</span>, <span class="comment">// post 无论大小写都是可以的</span></span></span><br><span class="line"><span class="language-javascript">                <span class="attr">url</span>: <span class="string">&#x27;/userInfo/UserLogin&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">data</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">// 对象属性简写</span></span></span><br><span class="line"><span class="language-javascript">                    username,</span></span><br><span class="line"><span class="language-javascript">                    password</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">            &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">&#123; data: res &#125;</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// 请求成功</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(res) <span class="comment">// res 服务器响应回来的数据</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// 200 是业务状态码（不是写死的，从响应体数据里面去看）</span></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">if</span> (res.<span class="property">code</span> === <span class="number">200</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">// 登录成功</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="title function_">alert</span>(<span class="string">&#x27;恭喜你，登录成功了，稍后跳转去首页&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">// location.href = &#x27;http://www.jd.com&#x27;</span></span></span><br><span class="line"><span class="language-javascript">                &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">// 登录失败</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="title function_">alert</span>(res.<span class="property">msg</span>)</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">            &#125;)</span></span><br><span class="line"><span class="language-javascript">        &#125;)</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>UserLogin</code>这个方法中的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">UserLogin</span>(<span class="params">[FromBody] JsonObject <span class="keyword">value</span></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">var</span> list = <span class="keyword">value</span>.ToList();</span><br><span class="line">       <span class="keyword">if</span> (list.Count == <span class="number">0</span>) <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123;code = <span class="number">500</span>,msg = <span class="string">&quot;请输入用户名和密码&quot;</span> &#125; );</span><br><span class="line">      <span class="keyword">var</span> username = list[<span class="number">0</span>].Value!.ToString();</span><br><span class="line">      <span class="keyword">var</span> password = list[<span class="number">1</span>].Value!.ToString();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (username == <span class="string">&quot;admin&quot;</span> &amp;&amp; password == <span class="string">&quot;123456&quot;</span>)</span><br><span class="line">      &#123;</span><br><span class="line">          <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123; code = <span class="number">200</span> &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">          <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123; code = <span class="number">403</span>, msg = <span class="string">&quot;用户名密码错误!!&quot;</span> &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p><code>JsonObject</code>:表示可变 <code>JSON </code>对象。实现了<code>[IEnumerable]</code></p>
<p>启动项目进行测试</p>
<h3 id="15-7-form-serialize插件应用"><a href="#15-7-form-serialize插件应用" class="headerlink" title="15.7 form-serialize插件应用"></a>15.7 <code>form-serialize</code>插件应用</h3><p>当表单的元素非常多的情况下，我们如果还是通过<code>document</code>的方式一个一个的获取，就比较麻烦了，这里可以使用<code>form-serialize</code>这个插件来快速的获取表单元素，非常的方便。</p>
<p>这一小节，我们来看一下该插件的使用。</p>
<p>在控制器中创建一个方法</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">ShowFow</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> View();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对应的视图中的代码如下所示：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/lib/bootstrap/dist/css/bootstrap.css&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/css/login.css&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;login-box&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">form</span>&gt;</span><span class="comment">&lt;!---注意：这里添加了form标签--------------------------------------&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-group mb-3&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;username&quot;</span>&gt;</span>Account<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!---------------- 账号:这里添加了name属性-----------------&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">id</span>=<span class="string">&quot;username&quot;</span> <span class="attr">autocomplete</span>=<span class="string">&quot;off&quot;</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">small</span> <span class="attr">id</span>=<span class="string">&quot;emailHelp&quot;</span> <span class="attr">class</span>=<span class="string">&quot;form-text text-muted&quot;</span>&gt;</span>The available account is <span class="tag">&lt;<span class="name">strong</span>&gt;</span>admin<span class="tag">&lt;/<span class="name">strong</span>&gt;</span><span class="tag">&lt;/<span class="name">small</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-group mb-3&quot;</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- ------------------密码这里添加了name属性 --------------------------&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;password&quot;</span>&gt;</span>Password<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">id</span>=<span class="string">&quot;password&quot;</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">small</span> <span class="attr">id</span>=<span class="string">&quot;emailHelp&quot;</span> <span class="attr">class</span>=<span class="string">&quot;form-text text-muted&quot;</span>&gt;</span>The available password is <span class="tag">&lt;<span class="name">strong</span>&gt;</span>123456<span class="tag">&lt;/<span class="name">strong</span>&gt;</span><span class="tag">&lt;/<span class="name">small</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!----------------------这里修改成了submit----------------------------&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-primary&quot;</span> <span class="attr">id</span>=<span class="string">&quot;btnLogin&quot;</span>&gt;</span>Submit<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/js/axios.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/js/form-serialize.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="comment">&lt;!------------------引入了form-serialize插件-------------------------&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">             <span class="comment">// 引入form-serialize插件，提供 serialize 函数，从而获取表单数据</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// serialize(form表单的DOM对象)</span></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 都可以获取到表单数据</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// serialize(form)  // &#x27;username=admin&amp;password=123456&#x27;</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// serialize(form, &#123; hash: true &#125;)  // js对象 &#123;username: &#x27;admin&#x27;, password: &#x27;123456&#x27;&#125;</span></span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;form&#x27;</span>).<span class="title function_">addEventListener</span>(<span class="string">&#x27;submit&#x27;</span>, <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 2.</span></span></span><br><span class="line"><span class="language-javascript">            e.<span class="title function_">preventDefault</span>() <span class="comment">//------------------------------------阻止默认行为</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 提交的时候，serialize插件来获取表单数据</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">let</span> data = <span class="title function_">serialize</span>(<span class="variable language_">this</span>, &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// &#123;&#125; 配置对象 hash 配置，可以将 收集到的表单数据是个js对象格式</span></span></span><br><span class="line"><span class="language-javascript">                <span class="attr">hash</span>: <span class="literal">true</span></span></span><br><span class="line"><span class="language-javascript">            &#125;)</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;data =&quot;</span>, data)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 3.</span></span></span><br><span class="line"><span class="language-javascript">           </span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">axios</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">method</span>: <span class="string">&#x27;post&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">url</span>: <span class="string">&#x27;/userInfo/UserLogin&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// 这个data不能省，否则没有提交数据给服务器</span></span></span><br><span class="line"><span class="language-javascript">                data  <span class="comment">// 完整的写法 data:data,由于同名，所以可以省略</span></span></span><br><span class="line"><span class="language-javascript">            &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">&#123; data: res &#125;</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(res)</span></span><br><span class="line"><span class="language-javascript">            &#125;)</span></span><br><span class="line"><span class="language-javascript">           </span></span><br><span class="line"><span class="language-javascript">        &#125;)</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="15-8-FormData-基本使用"><a href="#15-8-FormData-基本使用" class="headerlink" title="15.8  FormData 基本使用"></a>15.8  <code>FormData</code> 基本使用</h3><p>概念：<code>FormData</code> 是浏览器提供的一个 <code>WebAPI</code>，它以键值对的方式存储数据(二进制数据)</p>
<p>应用场景：<code>FormData + Ajax</code> 技术实现文件上传的功能</p>
<p>文档:<code>https://developer.mozilla.org/zh-CN/docs/Web/API/FormData/Using_FormData_Objects</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">FormData 是一个构造函数，new FormData() 即可得到 FormData 对象：</span><br><span class="line">const fd = new FormData() // 创建一个空白的 FormData 对象，里面没有包含任何数据。</span><br><span class="line">调用 FormData 对象的 append(键, 值) 方法，可以向空白的 FormData 中追加键值对数据，其中：</span><br><span class="line"> 键表示数据项的名字，必须是字符串</span><br><span class="line"> 值表示数据项的值，可以是任意类型的数据</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">fd.append(&#x27;username&#x27;, &#x27;张三&#x27;) // 键是 username，值是字符串类型</span><br><span class="line">fd.append(&#x27;age&#x27;, 20) // 键是 age， 值是数字类型</span><br><span class="line">fd.append(&#x27;avatar&#x27;, 图片文件) // 键是 avatar， 值是文件类型</span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<p>在控制中创建一个方法，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">ShowFormData</span>()</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> View();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该方法对应的视图代码如下所示：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">id</span>=<span class="string">&quot;iptFile&quot;</span> <span class="attr">accept</span>=<span class="string">&quot;image/*&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> iptFile = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#iptFile&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// =========================== FormData的基本使用 ===========================</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// FormData 是构造函数，new FormData得到其实例对象</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> fd = <span class="keyword">new</span> <span class="title class_">FormData</span>() <span class="comment">// 空的</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// fd.append(键, 值) // 键 必须是字符串类型</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        fd.<span class="title function_">append</span>(<span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;zs&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">        fd.<span class="title function_">append</span>(<span class="string">&#x27;age&#x27;</span>, <span class="number">19</span>)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// fd存选择好的文件数据</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 文件域有change事件（监听文件域的change事件），当选择的文件发生了改变就会触发change事件</span></span></span><br><span class="line"><span class="language-javascript">        iptFile.<span class="title function_">addEventListener</span>(<span class="string">&#x27;change&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// console.log(&#x27;change事件触发了，文件改变了&#x27;)</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 如何去获取选择的文件 ==&gt; FormData存文件</span></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 需要借助于文件域的files属性，这存在用户选择的文件</span></span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">files</span>)</span></span><br><span class="line"><span class="language-javascript">           fd.<span class="title function_">append</span>(<span class="string">&#x27;photo&#x27;</span>, <span class="variable language_">this</span>.<span class="property">files</span>[<span class="number">0</span>])</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">             fd.<span class="title function_">forEach</span>(<span class="function">(<span class="params">value, key</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">               <span class="variable language_">console</span>.<span class="title function_">log</span>(key, value)</span></span><br><span class="line"><span class="language-javascript">             &#125;)</span></span><br><span class="line"><span class="language-javascript">        &#125;)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 可以配合 forEach方法来遍历输出</span></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//  第一个形参value 值，第二个形参key 键</span></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// fd.forEach((value, key) =&gt; &#123;</span></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//   console.log(key, value)</span></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// &#125;)</span></span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="15-9-FormData实现文件上传"><a href="#15-9-FormData实现文件上传" class="headerlink" title="15.9  FormData实现文件上传"></a>15.9  <code>FormData</code>实现文件上传</h3><p>在控制器中创建一个方法</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">ShowFileUp</span>()</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">return</span> View();</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>对应的视图中的代码如下所示：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>案例-头像上传<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/lib//bootstrap/dist/css/bootstrap.css&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.thumb-box</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">text-align</span>: center;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">margin-top</span>: <span class="number">50px</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.thumb</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">width</span>: <span class="number">250px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">height</span>: <span class="number">250px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">object-fit</span>: cover;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-radius</span>: <span class="number">50%</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;thumb-box&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 头像 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;img-thumbnail thumb&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;mt-2&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 文件选择框 --&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- accept 属性表示可选择的文件类型 --&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- image/* 表示只允许选择图片类型的文件 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">id</span>=<span class="string">&quot;iptFile&quot;</span> <span class="attr">accept</span>=<span class="string">&quot;image/*&quot;</span> <span class="attr">style</span>=<span class="string">&quot;display: block;&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 选择头像图片的按钮 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-primary&quot;</span> <span class="attr">id</span>=<span class="string">&quot;btnChoose&quot;</span>&gt;</span>选择 &amp; 上传图片<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/js/axios.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      </span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> btnChoose = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#btnChoose&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> iptFile = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#iptFile&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> img = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;.thumb&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 功能</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//  1. 点击按钮，弹出文件选择框  ==&gt; 模拟点击文件选择器，从而实现弹框来选择文件</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//  2. 实现文件的上传功能</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        btnChoose.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            iptFile.<span class="title function_">click</span>()</span></span><br><span class="line"><span class="language-javascript">        &#125;)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// FormData 存文件  ==&gt; axios 发请求 (看接口文档)</span></span></span><br><span class="line"><span class="language-javascript">        iptFile.<span class="title function_">addEventListener</span>(<span class="string">&#x27;change&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 用户选择的文件，该如何拿到？</span></span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">files</span>[<span class="number">0</span>])</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 当this.files[0] 是undefined的时候，表示用户未选中文件，以下代码不用执行</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">files</span>[<span class="number">0</span>]) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">return</span> <span class="comment">// 阻止后续代码的执行</span></span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// FormData 构造函数 new一起使用</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">let</span> fd = <span class="keyword">new</span> <span class="title class_">FormData</span>()</span></span><br><span class="line"><span class="language-javascript">            fd.<span class="title function_">append</span>(<span class="string">&#x27;avatar&#x27;</span>, <span class="variable language_">this</span>.<span class="property">files</span>[<span class="number">0</span>])</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// axios 发请求代码</span></span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">axios</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">method</span>: <span class="string">&#x27;post&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// 请求的url地址一定要从接口文档中去复制</span></span></span><br><span class="line"><span class="language-javascript">                <span class="attr">url</span>: <span class="string">&#x27;/userInfo/fileupload&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// data的值是fd（把FormData存的数据给发送到服务器上）</span></span></span><br><span class="line"><span class="language-javascript">                <span class="attr">data</span>: fd</span></span><br><span class="line"><span class="language-javascript">            &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">&#123; data: res &#125;</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(res)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// 更换图片（以下写法有问题，res.url 缺少根路径）</span></span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// img.src = res.url // error</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                img.<span class="property">src</span> = <span class="string">`http://localhost:5050/<span class="subst">$&#123;res.url&#125;</span>`</span></span></span><br><span class="line"><span class="language-javascript">            &#125;)</span></span><br><span class="line"><span class="language-javascript">        &#125;)</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>FileUpload</code>方法中的代码，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">private</span> <span class="keyword">readonly</span> IWebHostEnvironment webHostEnvironment;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">UserInfoController</span>(<span class="params">IWebHostEnvironment webHostEnvironment</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.webHostEnvironment = webHostEnvironment;</span><br><span class="line">        &#125;</span><br><span class="line">   <span class="comment"><span class="doctag">///</span>注意需要在构造函数中注入IWebHostEnvironment</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">FileUpload</span>()</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> file = Request.Form.Files[<span class="string">&quot;avatar&quot;</span>]; <span class="comment">// 接收上传的图片文件</span></span><br><span class="line">            <span class="keyword">if</span> (file == <span class="literal">null</span>) <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123; code = <span class="number">500</span>, msg = <span class="string">&quot;请选择上传文件&quot;</span> &#125;);</span><br><span class="line">            <span class="built_in">string</span> fileName = Guid.NewGuid().ToString()  + Path.GetExtension(file.FileName);</span><br><span class="line">            <span class="comment">// 构建文件存储的路径（一定要放在wwwroot目录下面）</span></span><br><span class="line">            <span class="keyword">var</span> filePath = Path.Combine(webHostEnvironment.ContentRootPath, <span class="string">&quot;wwwroot/upload&quot;</span>, fileName);</span><br><span class="line">          </span><br><span class="line">            <span class="keyword">using</span> (FileStream fileStream = <span class="keyword">new</span> FileStream(filePath, FileMode.Create, FileAccess.Write))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">await</span> file.CopyToAsync(fileStream);</span><br><span class="line">                <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123; code=<span class="number">200</span>, url=<span class="string">&quot;upload/&quot;</span>+fileName &#125;); <span class="comment">// 将上传成功的图片路径进行返回</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>注意：由于这时候的<code>IFormFile </code>无法获取到<code>FormData</code>中的数据，所以不能写成<code>FileUpload(IFormFile file)</code>的形式，所以这里通过<code>Request.Form.Files</code>来进行接收。</p>
<p>同时，还要注意，我们需要把上传成功的图片的路径返回，然后视图中进行展示，所以上传成功的图片文件需要放到<code>wwwroot</code>目录下面。</p>
<p>因为中间件<code>app.UseStaticFiles();</code>处理的就是<code>wwwroot</code>中的静态文件</p>
<p>启动项目进行测试。</p>
<h3 id="15-10-AJAX案例–图书管理"><a href="#15-10-AJAX案例–图书管理" class="headerlink" title="15.10  AJAX案例–图书管理"></a>15.10  <code>AJAX</code>案例–图书管理</h3><h4 id="15-10-1-图书列表展示"><a href="#15-10-1-图书列表展示" class="headerlink" title="15.10.1  图书列表展示"></a>15.10.1  图书列表展示</h4><p>在控制器中创建方法</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ActionResult <span class="title">BookList</span>()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> View();</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>视图中的代码，如下所示：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 引入 lib 目录下的 bootstrap 样式表 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/lib/bootstrap/dist/css/bootstrap.css&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="selector-pseudo">:root</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">font-size</span>: <span class="number">15px</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">body</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding-top</span>: <span class="number">15px</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 栅格系统 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container-fluid&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 栅格系统中的一行 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;row&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 左侧的表格，占了 8 列 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-sm-8&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">table</span> <span class="attr">class</span>=<span class="string">&quot;table table-bordered table-striped table-dark table-hover text-center&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">thead</span>&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!-- 表头行 --&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">th</span> <span class="attr">scope</span>=<span class="string">&quot;col&quot;</span>&gt;</span>Id<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">th</span> <span class="attr">scope</span>=<span class="string">&quot;col&quot;</span>&gt;</span>书名<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">th</span> <span class="attr">scope</span>=<span class="string">&quot;col&quot;</span>&gt;</span>作者<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">th</span> <span class="attr">scope</span>=<span class="string">&quot;col&quot;</span>&gt;</span>价格<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">th</span> <span class="attr">scope</span>=<span class="string">&quot;col&quot;</span>&gt;</span>简介<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">th</span> <span class="attr">scope</span>=<span class="string">&quot;col&quot;</span>&gt;</span>操作<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">thead</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">tbody</span>&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!-- 表格中的每一行 --&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!-- &lt;tr&gt;</span></span><br><span class="line"><span class="comment">                          &lt;th scope=&quot;row&quot;&gt;xxx&lt;/th&gt;</span></span><br><span class="line"><span class="comment">                          &lt;td&gt;xxx&lt;/td&gt;</span></span><br><span class="line"><span class="comment">                          &lt;td&gt;xxx&lt;/td&gt;</span></span><br><span class="line"><span class="comment">                          &lt;td&gt;xxx&lt;/td&gt;</span></span><br><span class="line"><span class="comment">                          &lt;td&gt;</span></span><br><span class="line"><span class="comment">                            &lt;button type=&quot;button&quot; class=&quot;btn btn-link btn-sm btn-del&quot;&gt;删除&lt;/button&gt;</span></span><br><span class="line"><span class="comment">                          &lt;/td&gt;</span></span><br><span class="line"><span class="comment">                        &lt;/tr&gt; --&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">tbody</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!-- 右侧的添加区域，占了 4 列 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-sm-4&quot;</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- 添加图书的卡片 --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;card text-white bg-secondary sticky-top&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;card-header&quot;</span>&gt;</span>添加新图书<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">form</span> <span class="attr">class</span>=<span class="string">&quot;card-body bg-light&quot;</span> <span class="attr">id</span>=<span class="string">&quot;addForm&quot;</span>&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!-- 书名 --&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;input-group mb-3&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;input-group-prepend&quot;</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;input-group-text&quot;</span>&gt;</span>书名<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;请输入图书名称&quot;</span> <span class="attr">name</span>=<span class="string">&quot;title&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!-- 作者 --&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;input-group mb-3&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;input-group-prepend&quot;</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;input-group-text&quot;</span>&gt;</span>作者<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;请输入作者名字&quot;</span> <span class="attr">name</span>=<span class="string">&quot;author&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!-- 出版社 --&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;input-group mb-3&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;input-group-prepend&quot;</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;input-group-text&quot;</span>&gt;</span>简介<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;请输入图书简介&quot;</span> <span class="attr">name</span>=<span class="string">&quot;description&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;input-group mb-3&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;input-group-prepend&quot;</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;input-group-text&quot;</span>&gt;</span>价格<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;请输入图书价格&quot;</span> <span class="attr">name</span>=<span class="string">&quot;price&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!-- 添加按钮 --&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-dark&quot;</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span>添加<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/js/form-serialize.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/js//axios.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 功能</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 1. 渲染数据</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 2. 添加数据</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 3. 删除数据</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> tbody = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;tbody&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> addForm = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#addForm&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 功能1. 渲染数据 ==&gt; 发送ajax请求，获取图书数据，展示到 tbody</span></span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">axios</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">method</span>: <span class="string">&#x27;get&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">url</span>: <span class="string">&#x27;/userInfo/getbooks&#x27;</span></span></span><br><span class="line"><span class="language-javascript">        &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">&#123; data: res &#125;</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(res)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span> (res.<span class="property">status</span> !== <span class="number">200</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// 获取失败了</span></span></span><br><span class="line"><span class="language-javascript">                <span class="title function_">alert</span>(res.<span class="property">msg</span>)</span></span><br><span class="line"><span class="language-javascript">            &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// 获取成功了 ==&gt; 遍历res.data数组（forEach + map）</span></span></span><br><span class="line"><span class="language-javascript">                tbody.<span class="property">innerHTML</span> = res.<span class="property">data</span>.<span class="title function_">map</span>(<span class="function"><span class="params">item</span> =&gt;</span> <span class="string">`</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                  &lt;tr&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                    &lt;th scope=&quot;row&quot;&gt;<span class="subst">$&#123;item.id&#125;</span>&lt;/th&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                    &lt;td&gt;<span class="subst">$&#123;item.title&#125;</span>&lt;/td&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                    &lt;td&gt;<span class="subst">$&#123;item.author&#125;</span>&lt;/td&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                    &lt;td&gt;<span class="subst">$&#123;item.price&#125;</span>&lt;/td&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                       &lt;td&gt;<span class="subst">$&#123;item.description&#125;</span>&lt;/td&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                    &lt;td&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                      &lt;button type=&quot;button&quot; class=&quot;btn btn-link btn-sm btn-del&quot;&gt;删除&lt;/button&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                    &lt;/td&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                  &lt;/tr&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                `</span>).<span class="title function_">join</span>(<span class="string">&#x27;&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;)</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>下面定义<code>GetBooks</code>方法来获取图书</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">GetBooks</span>()</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">if</span> (list.Count &gt; <span class="number">0</span>)</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123; status = <span class="number">200</span>, data = list &#125;);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">else</span></span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123; status = <span class="number">404</span>, msg = <span class="string">&quot;没有图书数据&quot;</span> &#125;);</span><br><span class="line">           &#125;</span><br><span class="line">           </span><br><span class="line">           </span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<h4 id="15-10-2-添加图书"><a href="#15-10-2-添加图书" class="headerlink" title="15.10.2  添加图书"></a>15.10.2  添加图书</h4><p>先修改视图中的代码</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 引入 lib 目录下的 bootstrap 样式表 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/lib/bootstrap/dist/css/bootstrap.css&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="selector-pseudo">:root</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">font-size</span>: <span class="number">15px</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">body</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding-top</span>: <span class="number">15px</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 栅格系统 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container-fluid&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 栅格系统中的一行 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;row&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 左侧的表格，占了 8 列 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-sm-8&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">table</span> <span class="attr">class</span>=<span class="string">&quot;table table-bordered table-striped table-dark table-hover text-center&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">thead</span>&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!-- 表头行 --&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">th</span> <span class="attr">scope</span>=<span class="string">&quot;col&quot;</span>&gt;</span>Id<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">th</span> <span class="attr">scope</span>=<span class="string">&quot;col&quot;</span>&gt;</span>书名<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">th</span> <span class="attr">scope</span>=<span class="string">&quot;col&quot;</span>&gt;</span>作者<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">th</span> <span class="attr">scope</span>=<span class="string">&quot;col&quot;</span>&gt;</span>价格<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">th</span> <span class="attr">scope</span>=<span class="string">&quot;col&quot;</span>&gt;</span>简介<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">th</span> <span class="attr">scope</span>=<span class="string">&quot;col&quot;</span>&gt;</span>操作<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">thead</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">tbody</span>&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!-- 表格中的每一行 --&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!-- &lt;tr&gt;</span></span><br><span class="line"><span class="comment">                          &lt;th scope=&quot;row&quot;&gt;xxx&lt;/th&gt;</span></span><br><span class="line"><span class="comment">                          &lt;td&gt;xxx&lt;/td&gt;</span></span><br><span class="line"><span class="comment">                          &lt;td&gt;xxx&lt;/td&gt;</span></span><br><span class="line"><span class="comment">                          &lt;td&gt;xxx&lt;/td&gt;</span></span><br><span class="line"><span class="comment">                          &lt;td&gt;</span></span><br><span class="line"><span class="comment">                            &lt;button type=&quot;button&quot; class=&quot;btn btn-link btn-sm btn-del&quot;&gt;删除&lt;/button&gt;</span></span><br><span class="line"><span class="comment">                          &lt;/td&gt;</span></span><br><span class="line"><span class="comment">                        &lt;/tr&gt; --&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">tbody</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!-- 右侧的添加区域，占了 4 列 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-sm-4&quot;</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- 添加图书的卡片 --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;card text-white bg-secondary sticky-top&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;card-header&quot;</span>&gt;</span>添加新图书<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">form</span> <span class="attr">class</span>=<span class="string">&quot;card-body bg-light&quot;</span> <span class="attr">id</span>=<span class="string">&quot;addForm&quot;</span>&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!-- 书名 --&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;input-group mb-3&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;input-group-prepend&quot;</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;input-group-text&quot;</span>&gt;</span>书名<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;请输入图书名称&quot;</span> <span class="attr">name</span>=<span class="string">&quot;title&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!-- 作者 --&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;input-group mb-3&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;input-group-prepend&quot;</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;input-group-text&quot;</span>&gt;</span>作者<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;请输入作者名字&quot;</span> <span class="attr">name</span>=<span class="string">&quot;author&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!-- 出版社 --&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;input-group mb-3&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;input-group-prepend&quot;</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;input-group-text&quot;</span>&gt;</span>简介<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;请输入图书简介&quot;</span> <span class="attr">name</span>=<span class="string">&quot;description&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;input-group mb-3&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;input-group-prepend&quot;</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;input-group-text&quot;</span>&gt;</span>价格<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;请输入图书价格&quot;</span> <span class="attr">name</span>=<span class="string">&quot;price&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!-- 添加按钮 --&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-dark&quot;</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span>添加<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/js/form-serialize.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/js//axios.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 功能</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 1. 渲染数据</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 2. 添加数据</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 3. 删除数据</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> tbody = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;tbody&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> addForm = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#addForm&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">     </span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 功能1. 渲染数据 ==&gt; 发送ajax请求，获取图书数据，展示到 tbody</span></span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">axios</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">method</span>: <span class="string">&#x27;get&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">url</span>: <span class="string">&#x27;/userInfo/getbooks&#x27;</span></span></span><br><span class="line"><span class="language-javascript">            &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">&#123; data: res &#125;</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(res)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">if</span> (res.<span class="property">status</span> !== <span class="number">200</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">// 获取失败了</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="title function_">alert</span>(res.<span class="property">msg</span>)</span></span><br><span class="line"><span class="language-javascript">                &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">// 获取成功了 ==&gt; 遍历res.data数组（forEach + map）</span></span></span><br><span class="line"><span class="language-javascript">                   <span class="title function_">render</span>(res);</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">            &#125;)</span></span><br><span class="line"><span class="language-javascript">       </span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//------------------------------------封装了向表格中追加数据的操作。</span></span></span><br><span class="line"><span class="language-javascript">       <span class="keyword">function</span>  <span class="title function_">render</span>(<span class="params">res</span>)&#123;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            tbody.<span class="property">innerHTML</span> = res.<span class="property">data</span>.<span class="title function_">map</span>(<span class="function"><span class="params">item</span> =&gt;</span> <span class="string">`</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                                          &lt;tr&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                                            &lt;th scope=&quot;row&quot;&gt;<span class="subst">$&#123;item.id&#125;</span>&lt;/th&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                                            &lt;td&gt;<span class="subst">$&#123;item.title&#125;</span>&lt;/td&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                                            &lt;td&gt;<span class="subst">$&#123;item.author&#125;</span>&lt;/td&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                                            &lt;td&gt;<span class="subst">$&#123;item.price&#125;</span>&lt;/td&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                                               &lt;td&gt;<span class="subst">$&#123;item.description&#125;</span>&lt;/td&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                                            &lt;td&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                                              &lt;button type=&quot;button&quot; class=&quot;btn btn-link btn-sm btn-del&quot;&gt;删除&lt;/button&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                                            &lt;/td&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                                          &lt;/tr&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                                        `</span>).<span class="title function_">join</span>(<span class="string">&#x27;&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// ---------------------------------------------------------------------功能2. 添加数据</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//  步骤</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//  1. 监听form的submit事件--</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//  2. 阻止其默认行为</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//  3. 表单数据收集到 ==&gt; serialize()</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//  4. axios 发送请求</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 1.</span></span></span><br><span class="line"><span class="language-javascript">        addForm.<span class="title function_">addEventListener</span>(<span class="string">&#x27;submit&#x27;</span>, <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 2.</span></span></span><br><span class="line"><span class="language-javascript">            e.<span class="title function_">preventDefault</span>()</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 3.</span></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// let data = serialize(this, &#123; hash: true &#125;) // js对象</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">let</span> data = <span class="title function_">serialize</span>(<span class="variable language_">this</span>) <span class="comment">// 键值对的字符串</span></span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;data=&quot;</span>,data)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 4.</span></span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">axios</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">method</span>: <span class="string">&#x27;post&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">url</span>: <span class="string">&#x27;/userInfo/addbookinfo&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                data</span></span><br><span class="line"><span class="language-javascript">            &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">&#123;data:res&#125;</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;res = &quot;</span>, res)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">if</span> (res.<span class="property">status</span> !== <span class="number">201</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">// 添加失败了</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="title function_">alert</span>(data.<span class="property">msg</span>)</span></span><br><span class="line"><span class="language-javascript">                &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">// 添加成功</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">// 做啥</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">//  1. 重新渲染所有图书展示到tbody中</span></span></span><br><span class="line"><span class="language-javascript">                   <span class="title function_">render</span>(res)</span></span><br><span class="line"><span class="language-javascript">                    </span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">//  2. 清空表单   表单form有reset方法实现重置效果</span></span></span><br><span class="line"><span class="language-javascript">                    addForm.<span class="title function_">reset</span>()</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">            &#125;)</span></span><br><span class="line"><span class="language-javascript">        &#125;)</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>注意：</p>
<p>1、添加成功后，需要也要展示到表格中，所以上面的代码中，我们把向表格中追加数据的操作都封装到一个<code>render</code>方法中了。</p>
<p>2、在上面发送到服务端的数据是<code>  let data = serialize(this) // 键值对的字符串</code>并不是<code>js</code>对象，所以在对应的控制器中的<code>AddBookInfo</code>方法中，就不需要添加<code>[FromBody] </code>。现在前端发送的数据格式是<code>键值对的字符串</code>，也就是传统的<code>Form</code>格式。</p>
<p>下面实现<code>AddBookInfo</code>这个方法。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 添加图书[FromBody] </span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> IActionResult <span class="title">AddBookInfo</span>(<span class="params">Book book</span>)</span> </span><br><span class="line">       &#123;</span><br><span class="line">           <span class="built_in">int</span> maxId = list.Max(b =&gt; b.Id);</span><br><span class="line">           book.Id = maxId+<span class="number">1</span>;</span><br><span class="line">           list.Add(book);</span><br><span class="line">           <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123; status = <span class="number">201</span>, data =  list &#125;);</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>启动项目进行测试。</p>
<p>如果，前端发送的数据是<code>js</code>对象。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">addForm.<span class="title function_">addEventListener</span>(<span class="string">&#x27;submit&#x27;</span>, <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span><br><span class="line">            <span class="comment">// 2.</span></span><br><span class="line">            e.<span class="title function_">preventDefault</span>()</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3.</span></span><br><span class="line">            <span class="keyword">let</span> data = <span class="title function_">serialize</span>(<span class="variable language_">this</span>, &#123; <span class="attr">hash</span>: <span class="literal">true</span> &#125;) <span class="comment">// -----------------------------------js对象</span></span><br><span class="line">           <span class="comment">// let data = serialize(this) // 键值对的字符串</span></span><br></pre></td></tr></table></figure>

<p>以上向服务端发送的数据是<code>js</code>对象的形式。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> 添加图书</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> IActionResult <span class="title">AddBookInfo</span>(<span class="params">[FromBody] Book book</span>)</span> </span><br><span class="line">      &#123;</span><br><span class="line">          <span class="built_in">int</span> maxId = list.Max(b =&gt; b.Id);</span><br><span class="line">          book.Id = maxId+<span class="number">1</span>;</span><br><span class="line">          list.Add(book);</span><br><span class="line">          <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123; status = <span class="number">201</span>, data =  list &#125;);</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>这里在接收传递过来的<code>js</code>对象的时候，需要添加<code>[FromBody]</code></p>
<h4 id="15-10-3-删除图书"><a href="#15-10-3-删除图书" class="headerlink" title="15.10.3  删除图书"></a>15.10.3  删除图书</h4><p>下面先修改视图中的代码，如下所示：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 引入 lib 目录下的 bootstrap 样式表 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/lib/bootstrap/dist/css/bootstrap.css&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="selector-pseudo">:root</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">font-size</span>: <span class="number">15px</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">body</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding-top</span>: <span class="number">15px</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 栅格系统 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container-fluid&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 栅格系统中的一行 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;row&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 左侧的表格，占了 8 列 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-sm-8&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">table</span> <span class="attr">class</span>=<span class="string">&quot;table table-bordered table-striped table-dark table-hover text-center&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">thead</span>&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!-- 表头行 --&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">th</span> <span class="attr">scope</span>=<span class="string">&quot;col&quot;</span>&gt;</span>Id<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">th</span> <span class="attr">scope</span>=<span class="string">&quot;col&quot;</span>&gt;</span>书名<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">th</span> <span class="attr">scope</span>=<span class="string">&quot;col&quot;</span>&gt;</span>作者<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">th</span> <span class="attr">scope</span>=<span class="string">&quot;col&quot;</span>&gt;</span>价格<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">th</span> <span class="attr">scope</span>=<span class="string">&quot;col&quot;</span>&gt;</span>简介<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">th</span> <span class="attr">scope</span>=<span class="string">&quot;col&quot;</span>&gt;</span>操作<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">thead</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">tbody</span>&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!-- 表格中的每一行 --&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!-- &lt;tr&gt;</span></span><br><span class="line"><span class="comment">                          &lt;th scope=&quot;row&quot;&gt;xxx&lt;/th&gt;</span></span><br><span class="line"><span class="comment">                          &lt;td&gt;xxx&lt;/td&gt;</span></span><br><span class="line"><span class="comment">                          &lt;td&gt;xxx&lt;/td&gt;</span></span><br><span class="line"><span class="comment">                          &lt;td&gt;xxx&lt;/td&gt;</span></span><br><span class="line"><span class="comment">                          &lt;td&gt;</span></span><br><span class="line"><span class="comment">                            &lt;button type=&quot;button&quot; class=&quot;btn btn-link btn-sm btn-del&quot;&gt;删除&lt;/button&gt;</span></span><br><span class="line"><span class="comment">                          &lt;/td&gt;</span></span><br><span class="line"><span class="comment">                        &lt;/tr&gt; --&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">tbody</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!-- 右侧的添加区域，占了 4 列 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-sm-4&quot;</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- 添加图书的卡片 --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;card text-white bg-secondary sticky-top&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;card-header&quot;</span>&gt;</span>添加新图书<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">form</span> <span class="attr">class</span>=<span class="string">&quot;card-body bg-light&quot;</span> <span class="attr">id</span>=<span class="string">&quot;addForm&quot;</span>&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!-- 书名 --&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;input-group mb-3&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;input-group-prepend&quot;</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;input-group-text&quot;</span>&gt;</span>书名<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;请输入图书名称&quot;</span> <span class="attr">name</span>=<span class="string">&quot;title&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!-- 作者 --&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;input-group mb-3&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;input-group-prepend&quot;</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;input-group-text&quot;</span>&gt;</span>作者<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;请输入作者名字&quot;</span> <span class="attr">name</span>=<span class="string">&quot;author&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!-- 出版社 --&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;input-group mb-3&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;input-group-prepend&quot;</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;input-group-text&quot;</span>&gt;</span>简介<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;请输入图书简介&quot;</span> <span class="attr">name</span>=<span class="string">&quot;description&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;input-group mb-3&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;input-group-prepend&quot;</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;input-group-text&quot;</span>&gt;</span>价格<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;请输入图书价格&quot;</span> <span class="attr">name</span>=<span class="string">&quot;price&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!-- 添加按钮 --&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-dark&quot;</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span>添加<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/js/form-serialize.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/js//axios.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 功能</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 1. 渲染数据</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 2. 添加数据</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 3. 删除数据</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> tbody = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;tbody&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> addForm = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#addForm&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">     </span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 功能1. 渲染数据 ==&gt; 发送ajax请求，获取图书数据，展示到 tbody</span></span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">axios</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">method</span>: <span class="string">&#x27;get&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">url</span>: <span class="string">&#x27;/userInfo/getbooks&#x27;</span></span></span><br><span class="line"><span class="language-javascript">            &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">&#123; data: res &#125;</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(res)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">if</span> (res.<span class="property">status</span> !== <span class="number">200</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">// 获取失败了</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="title function_">alert</span>(res.<span class="property">msg</span>)</span></span><br><span class="line"><span class="language-javascript">                &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">// 获取成功了 ==&gt; 遍历res.data数组（forEach + map）</span></span></span><br><span class="line"><span class="language-javascript">                   <span class="title function_">render</span>(res);</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">            &#125;)</span></span><br><span class="line"><span class="language-javascript">       </span></span><br><span class="line"><span class="language-javascript">       <span class="keyword">function</span>  <span class="title function_">render</span>(<span class="params">res</span>)&#123;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            tbody.<span class="property">innerHTML</span> = res.<span class="property">data</span>.<span class="title function_">map</span>(<span class="function"><span class="params">item</span> =&gt;</span> <span class="string">`</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                                          &lt;tr&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                                            &lt;th scope=&quot;row&quot;&gt;<span class="subst">$&#123;item.id&#125;</span>&lt;/th&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                                            &lt;td&gt;<span class="subst">$&#123;item.title&#125;</span>&lt;/td&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                                            &lt;td&gt;<span class="subst">$&#123;item.author&#125;</span>&lt;/td&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                                            &lt;td&gt;<span class="subst">$&#123;item.price&#125;</span>&lt;/td&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                                               &lt;td&gt;<span class="subst">$&#123;item.description&#125;</span>&lt;/td&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                                            &lt;td&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                                                      &lt;button type=&quot;button&quot; class=&quot;btn btn-link btn-sm btn-del&quot; data-id=&quot;<span class="subst">$&#123;item.id&#125;</span>&quot; &gt;删除&lt;/button&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                                            &lt;/td&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                                          &lt;/tr&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                                        `</span>).<span class="title function_">join</span>(<span class="string">&#x27;&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 功能2. 添加数据</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//  步骤</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//  1. 监听form的submit事件</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//  2. 阻止其默认行为</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//  3. 表单数据收集到 ==&gt; serialize()</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//  4. axios 发送请求</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 1.</span></span></span><br><span class="line"><span class="language-javascript">        addForm.<span class="title function_">addEventListener</span>(<span class="string">&#x27;submit&#x27;</span>, <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 2.</span></span></span><br><span class="line"><span class="language-javascript">            e.<span class="title function_">preventDefault</span>()</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 3.</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">let</span> data = <span class="title function_">serialize</span>(<span class="variable language_">this</span>, &#123; <span class="attr">hash</span>: <span class="literal">true</span> &#125;) <span class="comment">// js对象</span></span></span><br><span class="line"><span class="language-javascript">           <span class="comment">// let data = serialize(this) // 键值对的字符串</span></span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;data=&quot;</span>,data)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 4.</span></span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">axios</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">method</span>: <span class="string">&#x27;post&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">url</span>: <span class="string">&#x27;/userInfo/addbookinfo&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                data</span></span><br><span class="line"><span class="language-javascript">            &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">&#123;data:res&#125;</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;res = &quot;</span>, res)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">if</span> (res.<span class="property">status</span> !== <span class="number">201</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">// 添加失败了</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="title function_">alert</span>(data.<span class="property">msg</span>)</span></span><br><span class="line"><span class="language-javascript">                &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">// 添加成功</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">// 做啥</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">//  1. 重新渲染所有图书展示到tbody中</span></span></span><br><span class="line"><span class="language-javascript">                   <span class="title function_">render</span>(res)</span></span><br><span class="line"><span class="language-javascript">                    </span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">//  2. 清空表单   表单form有reset方法实现重置效果</span></span></span><br><span class="line"><span class="language-javascript">                    addForm.<span class="title function_">reset</span>()</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">            &#125;)</span></span><br><span class="line"><span class="language-javascript">        &#125;)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// -----------------------------------------------功能3： 删除图书</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 给删除按钮注册click ==&gt; 采取事件委托做法（删除按钮动态创建）</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 做法： 把事件委托给父元素或祖先元素</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 原理：事件冒泡</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 触发事件的具体元素是谁：e.target</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 自定义属性（规范做法）</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//    标签上使用data- 自定义属性</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//    js中使用dataset属性操作</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        tbody.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(e.<span class="property">target</span>)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 判断</span></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// if(e.target.tagName === &#x27;BUTTON&#x27;)&#123;&#125;</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 更加具体些</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span> (e.<span class="property">target</span>.<span class="property">classList</span>.<span class="title function_">contains</span>(<span class="string">&#x27;btn-del&#x27;</span>)) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// if成立，说明拥有 btn-del 类名，点击的是删除按钮</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// 点击删除按钮的时候，需要将自定义属性的值取出来</span></span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// console.log(e.target.dataset) // &#123;id: 1&#125;</span></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">if</span>(<span class="title function_">confirm</span>(<span class="string">&quot;确定要删除&quot;</span>))&#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">let</span> id = e.<span class="property">target</span>.<span class="property">dataset</span>.<span class="property">id</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(id)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                    <span class="comment">// 发送ajax请求，告诉服务器，需要删除哪一本书</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="title function_">axios</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">                        <span class="attr">method</span>: <span class="string">&#x27;delete&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                        <span class="attr">url</span>: <span class="string">&#x27;/userInfo/delbook&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                        <span class="attr">params</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                            <span class="comment">// 需要删除的图书id ==&gt; 在删除按钮上使用自定义属性存图书的id</span></span></span><br><span class="line"><span class="language-javascript">                            id</span></span><br><span class="line"><span class="language-javascript">                        &#125;</span></span><br><span class="line"><span class="language-javascript">                    &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">&#123; data: res &#125;</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                        <span class="keyword">if</span> (res.<span class="property">status</span> !== <span class="number">200</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                            <span class="comment">// 删除失败</span></span></span><br><span class="line"><span class="language-javascript">                            <span class="title function_">alert</span>(res.<span class="property">msg</span>)</span></span><br><span class="line"><span class="language-javascript">                        &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                            <span class="comment">// 删除成功</span></span></span><br><span class="line"><span class="language-javascript">                            <span class="title function_">render</span>(res)</span></span><br><span class="line"><span class="language-javascript">                        &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                    &#125;)</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">                </span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;)</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>注意：在进行删除的时候，需要将要删除的图书的编号传递到服务端，所以这里添加了自定义属性</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                                                     <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-link btn-sm btn-del&quot;</span> <span class="attr">data-id</span>=<span class="string">&quot;$&#123;item.id&#125;&quot;</span> &gt;</span>删除<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                                           <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>以上代码中添加了自定义属性<code>data-id</code></p>
<p>控制器中的代码：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">DelBook</span>(<span class="params"><span class="built_in">int</span> id</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">          <span class="keyword">var</span> book = list.Where(b=&gt;b.Id==id).FirstOrDefault();</span><br><span class="line">           <span class="keyword">if</span>(book == <span class="literal">null</span>)</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123; status = <span class="number">201</span>, msg = <span class="string">&quot;删除失败&quot;</span> &#125;);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">else</span></span><br><span class="line">           &#123;</span><br><span class="line">               list.Remove(book);</span><br><span class="line">               <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123; status = <span class="number">200</span>,data = list &#125;);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>启动项目进行测试</p>
<h3 id="15-11-XMLHttpRequest对象"><a href="#15-11-XMLHttpRequest对象" class="headerlink" title="15.11  XMLHttpRequest对象"></a>15.11  <code>XMLHttpRequest</code>对象</h3><p><code>jquery</code></p>
<h4 id="15-11-1-发送get请求"><a href="#15-11-1-发送get请求" class="headerlink" title="15.11.1  发送get请求"></a>15.11.1  发送<code>get</code>请求</h4><p>创建一个方法</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">GetView</span>()</span> &#123; <span class="keyword">return</span> View(); &#125;</span><br></pre></td></tr></table></figure>

<p>对应的<code>GetView</code>视图中的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;en&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">    &lt;meta http-equiv=<span class="string">&quot;X-UA-Compatible&quot;</span> content=<span class="string">&quot;IE=edge&quot;</span>&gt;</span><br><span class="line">    &lt;meta name=<span class="string">&quot;viewport&quot;</span> content=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span><br><span class="line">    &lt;title&gt;Document&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;script&gt;</span><br><span class="line">        <span class="comment">// =========================== 目标: 使用xhr发起GET请求 ===========================</span></span><br><span class="line">        <span class="comment">// 接口地址:/UserInfo/ApiGet</span></span><br><span class="line">        <span class="comment">// 请求方式： get</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 步骤：</span></span><br><span class="line">        <span class="comment">// 1.创建一个xhr对象</span></span><br><span class="line">        <span class="keyword">let</span> xhr = <span class="keyword">new</span> XMLHttpRequest()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.设置请求方式和请求地址 xhr.open(&quot;请求方式&quot;, &quot;请求地址&quot;)</span></span><br><span class="line">        xhr.open(<span class="string">&#x27;get&#x27;</span>, <span class="string">&#x27;/userInfo/apiget?a=1&amp;b=2&amp;c=3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.发送请求</span></span><br><span class="line">        <span class="comment">// xhr.send(请求体的数据)</span></span><br><span class="line">        <span class="comment">// 因为get请求方式是没有请求体的，所以send的参数不写</span></span><br><span class="line">        xhr.send()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.监听load(请求成功)事件 ==&gt; 可以获取响应数据</span></span><br><span class="line">        xhr.addEventListener(<span class="string">&#x27;load&#x27;</span>, function () &#123;</span><br><span class="line">            console.log(xhr.response) <span class="comment">// json字符串</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// JSON.parse()</span></span><br><span class="line">            console.log(JSON.parse(xhr.response)) <span class="comment">// js对象</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line"></span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>启动项目进行测试，查看浏览器控制台中的打印结果</p>
<h4 id="15-11-2-发送post请求"><a href="#15-11-2-发送post请求" class="headerlink" title="15.11.2 发送post请求"></a>15.11.2 发送<code>post</code>请求</h4><p>在控制器中定义方法</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">PostView</span>()</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">return</span> View();</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>展示的<code>PostView</code>视图中的代码</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;en&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">    &lt;meta http-equiv=<span class="string">&quot;X-UA-Compatible&quot;</span> content=<span class="string">&quot;IE=edge&quot;</span>&gt;</span><br><span class="line">    &lt;meta name=<span class="string">&quot;viewport&quot;</span> content=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span><br><span class="line">    &lt;title&gt;Document&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;script&gt;</span><br><span class="line">        <span class="comment">// =========================== 目标: 使用xhr发起POST请求 ===========================</span></span><br><span class="line">        <span class="comment">//  接口地址: /userinfo/ApiPost</span></span><br><span class="line">        <span class="comment">//  请求方式：post</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 步骤：</span></span><br><span class="line">        <span class="comment">// 1.创建一个xhr对象</span></span><br><span class="line">        <span class="keyword">let</span> xhr = <span class="keyword">new</span> XMLHttpRequest()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.设置请求方式和请求地址 xhr.open(&quot;请求方式&quot;, &quot;请求地址&quot;)</span></span><br><span class="line">        xhr.open(<span class="string">&#x27;post&#x27;</span>, <span class="string">&#x27;/userInfo/ApiPost&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.设置请求体对应的编码格式 对应的是key=value&amp;key=value</span></span><br><span class="line">        xhr.setRequestHeader(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;application/x-www-form-urlencoded&#x27;</span>)</span><br><span class="line">        <span class="comment">// xhr.setRequestHeader(&#x27;Content-Type&#x27;, &#x27;application/json&#x27;)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.发送请求  send(请求体数据)</span></span><br><span class="line">        xhr.send(<span class="string">&#x27;a=1&amp;b=2&#x27;</span>) <span class="comment">// 键值对字符串格式</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// xhr.send(&#x27;&#123;&quot;name&quot;: &quot;lw&quot;, &quot;age&quot;: 19&#125;&#x27;) // json数据</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5.监听load(请求成功)事件</span></span><br><span class="line">        xhr.addEventListener(<span class="string">&#x27;load&#x27;</span>, function () &#123;</span><br><span class="line">            console.log(JSON.parse(xhr.response))</span><br><span class="line">        &#125;)</span><br><span class="line">    &lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line"></span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>在控制器中创建<code>ApiPost</code>方法</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">ApiPost</span>()</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">var</span> a = Request.Form[<span class="string">&quot;a&quot;</span>];</span><br><span class="line">           <span class="keyword">var</span> b = Request.Form[<span class="string">&quot;b&quot;</span>];</span><br><span class="line">           <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123; a, b &#125;);</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>启动项目进行测试，在浏览器的控制台中查看结果。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">       <span class="comment">// =========================== 目标: 使用xhr发起POST请求 ===========================</span></span></span><br><span class="line"><span class="language-javascript">       <span class="comment">//  接口地址: /userinfo/ApiPost</span></span></span><br><span class="line"><span class="language-javascript">       <span class="comment">//  请求方式：post</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">       <span class="comment">// 步骤：</span></span></span><br><span class="line"><span class="language-javascript">       <span class="comment">// 1.创建一个xhr对象</span></span></span><br><span class="line"><span class="language-javascript">       <span class="keyword">let</span> xhr = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>()</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">       <span class="comment">// 2.设置请求方式和请求地址 xhr.open(&quot;请求方式&quot;, &quot;请求地址&quot;)</span></span></span><br><span class="line"><span class="language-javascript">       xhr.<span class="title function_">open</span>(<span class="string">&#x27;post&#x27;</span>, <span class="string">&#x27;/userInfo/ApiPost&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">       <span class="comment">// 3.设置请求体对应的编码格式 对应的是key=value&amp;key=value</span></span></span><br><span class="line"><span class="language-javascript">     <span class="comment">//  -----------------------------------xhr.setRequestHeader(&#x27;Content-Type&#x27;, &#x27;application/x-www-form-urlencoded&#x27;)</span></span></span><br><span class="line"><span class="language-javascript">       xhr.<span class="title function_">setRequestHeader</span>(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;application/json&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">       <span class="comment">// 4.发送请求  send(请求体数据)</span></span></span><br><span class="line"><span class="language-javascript">      <span class="comment">// ----------------------xhr.send(&#x27;a=1&amp;b=2&#x27;) // 键值对字符串格式</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">       xhr.<span class="title function_">send</span>(<span class="string">&#x27;&#123;&quot;a&quot;: &quot;abc&quot;, &quot;b&quot;: 19&#125;&#x27;</span>) <span class="comment">// json数据</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">       <span class="comment">// 5.监听load(请求成功)事件</span></span></span><br><span class="line"><span class="language-javascript">       xhr.<span class="title function_">addEventListener</span>(<span class="string">&#x27;load&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">           <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">parse</span>(xhr.<span class="property">response</span>))</span></span><br><span class="line"><span class="language-javascript">       &#125;)</span></span><br><span class="line"><span class="language-javascript">   </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在上面的代码中，我们将请求的编码格式修改成了<code>  xhr.setRequestHeader(&#39;Content-Type&#39;, &#39;application/json&#39;)</code></p>
<p>发送的就是<code>json</code>数据:<code> xhr.send(&#39;&#123;&quot;a&quot;: &quot;abc&quot;, &quot;b&quot;: 19&#125;&#39;)</code></p>
<p>这时候控制器中的<code>ApiPost</code>方法的代码，修改成如下的形式：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">ApiPost</span>(<span class="params">[FromBody] JsonObject <span class="keyword">value</span></span>)</span></span><br><span class="line">     &#123;</span><br><span class="line">         <span class="comment">/* var a = Request.Form[&quot;a&quot;];</span></span><br><span class="line"><span class="comment">          var b = Request.Form[&quot;b&quot;];*/</span></span><br><span class="line">         <span class="keyword">var</span> list = <span class="keyword">value</span>.ToList();</span><br><span class="line">         <span class="keyword">if</span> (list.Count == <span class="number">0</span>) <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123; code = <span class="number">500</span>, msg = <span class="string">&quot;请输入正确的数据&quot;</span> &#125;);</span><br><span class="line">         <span class="keyword">var</span> a = list[<span class="number">0</span>].Value!.ToString();</span><br><span class="line">         <span class="keyword">var</span> b = list[<span class="number">1</span>].Value!.ToString();</span><br><span class="line">         <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123; a, b &#125;);</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>

<p>启动项目，进行测试，在浏览器的控制台中查看结果。</p>
<h3 id="15-12-请求体的数据编码格式说明"><a href="#15-12-请求体的数据编码格式说明" class="headerlink" title="15.12  请求体的数据编码格式说明"></a>15.12  请求体的数据编码格式说明</h3><p>这里只是说明总结，不用演示</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- 用户名 --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">span</span>&gt;</span>用户名：<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- 密码： --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">span</span>&gt;</span>登录密码：<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- 提交按钮 --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">button</span>&gt;</span>提交<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/js/form-serialize.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/js/axios.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 请求体的数据编码格式不同，后端接收到的数据格式也会不同。</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 1. application/x-www-form-urlencoded     表单中不包含文件上传的场景，适用于普通数据的提交</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 2. application/json                      json数据传输</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 3. multipart/form-data                   在于能实现异步上传文件</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 接口地址: /userInfo/form</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 请求方式: POST</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;form&#x27;</span>).<span class="title function_">addEventListener</span>(<span class="string">&#x27;submit&#x27;</span>, <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">      e.<span class="title function_">preventDefault</span>()</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      <span class="comment">// 在提交的时候，来获取表单数据</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      <span class="comment">// let data = serialize(this, &#123; hash: true &#125;)</span></span></span><br><span class="line"><span class="language-javascript">      <span class="comment">// hash: true 的配置的作用：表单数据是个js对象格式</span></span></span><br><span class="line"><span class="language-javascript">      <span class="comment">// console.log(data) // &#123;username: &#x27;admo&#x27;, password: &#x27;qwddqwqwd&#x27;&#125;</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">let</span> data2 = <span class="title function_">serialize</span>(<span class="variable language_">this</span>)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">console</span>.<span class="title function_">log</span>(data2) <span class="comment">// 表单数据是个字符串格式   </span></span></span><br><span class="line"><span class="language-javascript">      <span class="comment">// username=qwdw&amp;password=wqdwqdqwd   键值对的字符串 格式 键=值&amp;键=值&amp;键=值</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">axios</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">method</span>: <span class="string">&#x27;post&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">url</span>: <span class="string">&#x27;/userInfo/form&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// data 请求体数据</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 以下写法，给服务器发送的数据是个json格式数据</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//  对应的Content-type: application/json</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// data: &#123;</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//   username: &#x27;admo&#x27;,</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//   password: &#x27;qwddqwqwd&#x27;</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// &#125;</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 以下写法，给服务器发送的数据是个键值对字符串格式的数据</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//  对应的Content-type: application/x-www-form-urlencoded</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// data: &#x27;username=qwdw&amp;password=wqdwqdqwd&#x27;</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="attr">data</span>: data2</span></span><br><span class="line"><span class="language-javascript">      &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">&#123; data: res &#125;</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">console</span>.<span class="title function_">log</span>(res)</span></span><br><span class="line"><span class="language-javascript">      &#125;)</span></span><br><span class="line"><span class="language-javascript">    &#125;)</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="15-13-axios简化用法"><a href="#15-13-axios简化用法" class="headerlink" title="15.13 axios简化用法"></a>15.13 <code>axios</code>简化用法</h3><p>这里也是说明，不用演示</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;btnGET_1&quot;</span>&gt;</span>GET不带参数<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;btnGET_2&quot;</span>&gt;</span>GET带参数<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;btnPOST_1&quot;</span>&gt;</span>POST不带请求体<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;btnPOST_2&quot;</span>&gt;</span>POST带请求体<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/js/common.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/js/axios.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// GET请求接口地址: http://www.xxx.top:3006/api/get</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// POST请求接口地址: http://www.xxx.top:3006/api/post</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// ======================== 配置全局请求的根路径 ======================== </span></span></span><br><span class="line"><span class="language-javascript">    axios.<span class="property">defaults</span>.<span class="property">baseURL</span> = <span class="string">&#x27;http://localhost:5050/&#x27;</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// axios的简写形式</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// axios(&#123;</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//   // 配置对象 method  url params data</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// &#125;)</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// axios.get(url, config) // config 配置对象 是可选的</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//   axios.delete()  同 axios.get()</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// axios.post(url, data, config) // data config 都是可选的    data 请求体数据</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//    axios.put()  axios.patch()  同 axios.post()</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// ======================== 发送get请求，不带参数 ======================== </span></span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">qs</span>(<span class="string">&#x27;#btnGET_1&#x27;</span>).<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">      axios.<span class="title function_">get</span>(<span class="string">&#x27;/api/get&#x27;</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">&#123; data: res &#125;</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">console</span>.<span class="title function_">log</span>(res)</span></span><br><span class="line"><span class="language-javascript">      &#125;)</span></span><br><span class="line"><span class="language-javascript">    &#125;)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// ======================== 发送get请求，带参数 ======================== </span></span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">qs</span>(<span class="string">&#x27;#btnGET_2&#x27;</span>).<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">      axios.<span class="title function_">get</span>(<span class="string">&#x27;/api/get&#x27;</span>, &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 配置对象</span></span></span><br><span class="line"><span class="language-javascript">        <span class="attr">params</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">          <span class="comment">// 查询参数</span></span></span><br><span class="line"><span class="language-javascript">          <span class="attr">a</span>: <span class="number">1</span>,</span></span><br><span class="line"><span class="language-javascript">          <span class="attr">b</span>: <span class="number">2</span></span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">      &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">&#123; data: res &#125;</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">console</span>.<span class="title function_">log</span>(res)</span></span><br><span class="line"><span class="language-javascript">      &#125;)</span></span><br><span class="line"><span class="language-javascript">    &#125;)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// ======================== 发送post请求，不带参数 ======================== </span></span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">qs</span>(<span class="string">&#x27;#btnPOST_1&#x27;</span>).<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">      axios.<span class="title function_">post</span>(<span class="string">&#x27;/api/post&#x27;</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">&#123; data: res &#125;</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">console</span>.<span class="title function_">log</span>(res)</span></span><br><span class="line"><span class="language-javascript">      &#125;)</span></span><br><span class="line"><span class="language-javascript">    &#125;)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// ======================== 发送post请求，带参数 ======================== </span></span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">qs</span>(<span class="string">&#x27;#btnPOST_2&#x27;</span>).<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">      axios.<span class="title function_">post</span>(<span class="string">&#x27;/api/post&#x27;</span>, &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 这个对象是data，放请求体数据</span></span></span><br><span class="line"><span class="language-javascript">        <span class="attr">username</span>: <span class="string">&#x27;lw&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">age</span>: <span class="number">19</span></span></span><br><span class="line"><span class="language-javascript">      &#125;, &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 配置对象</span></span></span><br><span class="line"><span class="language-javascript">        <span class="attr">timeout</span>: <span class="number">10000</span>, <span class="comment">// 超时时间</span></span></span><br><span class="line"><span class="language-javascript">        <span class="attr">params</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">          <span class="comment">// 带查询参数</span></span></span><br><span class="line"><span class="language-javascript">          <span class="attr">a</span>: <span class="number">1</span>,</span></span><br><span class="line"><span class="language-javascript">          <span class="attr">b</span>: <span class="number">2</span></span></span><br><span class="line"><span class="language-javascript">        &#125;,</span></span><br><span class="line"><span class="language-javascript">      &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">&#123; data: res &#125;</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">console</span>.<span class="title function_">log</span>(res)</span></span><br><span class="line"><span class="language-javascript">      &#125;)</span></span><br><span class="line"><span class="language-javascript">    &#125;)</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="15-14-JSON数据说明"><a href="#15-14-JSON数据说明" class="headerlink" title="15.14 JSON数据说明"></a>15.14 <code>JSON</code>数据说明</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">/*</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">      目标: 把json数据转为js数据</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">            把js数据转为json数据</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">    */</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// ================== JSON的本质 ================== </span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//  1. JSON 本质是字符串，字符串里面可以有对象、数组</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//  2. 键名必须使用双引号包裹（不能没有双引号、不能去使用单引号、反引号）</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//  3. 值如果是字符串类型，也必须使用双引号</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//  4. JSON数据里面不能出现 undefined 、函数</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// ================== JS数据，转成JSON字符串 ================== </span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// JS对象</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> obj = &#123; <span class="attr">name</span>: <span class="string">&#x27;zs&#x27;</span>, <span class="attr">age</span>: <span class="number">19</span> &#125;</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// console.log(obj)</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// console.log(JSON.stringify(obj)) // &#x27;&#123;&quot;name&quot;:&quot;zs&quot;,&quot;age&quot;:19&#125;&#x27;</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// JS数组</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> arr = [<span class="string">&#x27;zs&#x27;</span>, <span class="string">&#x27;ls&#x27;</span>, <span class="string">&#x27;ww&#x27;</span>]</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// console.log(JSON.stringify(arr)) // &#x27;[&quot;zs&quot;,&quot;ls&quot;,&quot;ww&quot;]&#x27;</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// ================== JSON数据，转成JS对象或数组  ================== </span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// JSON(对象格式)  ==&gt; 转成JS对象</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> jsonStr1 = <span class="string">&#x27;&#123;&quot;name&quot;:&quot;zs&quot;,&quot;age&quot;:19&#125;&#x27;</span></span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">parse</span>(jsonStr1)) <span class="comment">// &#123;name: &#x27;zs&#x27;, age: 19&#125;</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// JSON(数组格式)  ==&gt; 转成JS数组</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> jsonStr2 = <span class="string">&#x27;[&quot;zs&quot;,&quot;ls&quot;,&quot;ww&quot;]&#x27;</span></span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">parse</span>(jsonStr2))</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// ================== 序列化与反序列化 ==================</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//  序列化:   是js数据 转成 json字符串数据    方法： JSON.stringify()</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//  反序列化: 是json字符串数据 转成 js数据    方法： JSON.parse()</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 演示错误</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// let jsonStr3 = &#x27;&#123;&quot;name&quot;:&quot;zs&quot;, age:19&#125;&#x27; // 该字符串的age属性没有使用双引号，不是json字符串，无法使用parse方法</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// console.log(JSON.parse(jsonStr3))  // error</span></span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="15-5-XMLHttpRequest对象发起Post请求–发送JSON"><a href="#15-5-XMLHttpRequest对象发起Post请求–发送JSON" class="headerlink" title="15.5  XMLHttpRequest对象发起Post请求–发送JSON"></a>15.5  <code>XMLHttpRequest</code>对象发起<code>Post</code>请求–发送<code>JSON</code></h3><p>在控制器中，添加方法<code>ShowPostJson</code></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">ShowPostJson</span>()</span></span><br><span class="line">      &#123;</span><br><span class="line">          <span class="keyword">return</span> View();</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>以上方法对应的视图中的代码如下所示：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">/*</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">           目标: 使用xhr发起POST请求</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">                 接口地址: /userInfo/postjson</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">                 请求体数据格式为JSON数据</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">        */</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// js对象  ==&gt; json数据 ==&gt; 发给服务器</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> obj = &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">name</span>: <span class="string">&#x27;zs&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">age</span>: <span class="number">20</span></span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 1. 创建一个xhr对象</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> xhr = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>()</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 2. 设置请求方式和请求地址</span></span></span><br><span class="line"><span class="language-javascript">        xhr.<span class="title function_">open</span>(<span class="string">&#x27;post&#x27;</span>, <span class="string">&#x27;/userInfo/postjson&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 3. 设置请求头 中 请求体数据的编码格式</span></span></span><br><span class="line"><span class="language-javascript">        xhr.<span class="title function_">setRequestHeader</span>(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;application/json&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 4. 发送请求</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//  需要自己来处理（把js对象处理成json数据，在发给服务器）</span></span></span><br><span class="line"><span class="language-javascript">        xhr.<span class="title function_">send</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(obj))</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 5. 监听load(请求成功)事件</span></span></span><br><span class="line"><span class="language-javascript">        xhr.<span class="title function_">addEventListener</span>(<span class="string">&#x27;load&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(xhr.<span class="property">response</span>) <span class="comment">// json数据 字符串    </span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 反序列化( 转成  js数据)</span></span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">parse</span>(xhr.<span class="property">response</span>))</span></span><br><span class="line"><span class="language-javascript">        &#125;)</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>下面在控制器中创建<code>PostJson</code>方法，该方法中的代码，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">PostJson</span>(<span class="params">[FromBody] JsonObject <span class="keyword">value</span></span>)</span></span><br><span class="line">      &#123;</span><br><span class="line">          <span class="keyword">var</span> result =<span class="keyword">value</span>.ToList();</span><br><span class="line">          <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123;code = <span class="number">200</span>,data = result &#125;);</span><br><span class="line"></span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>启动项目进行测试，在浏览器的控制台中查看服务端返回的结果。</p>
<h3 id="15-6-梳理常见疑惑点"><a href="#15-6-梳理常见疑惑点" class="headerlink" title="15.6  梳理常见疑惑点"></a>15.6  梳理常见疑惑点</h3><p>先在控制器中创建一个方法，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">ShowResult</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> View();</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>以上<code>ShowResult</code>方法对应的视图代码如下所示：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;./css/bootstrap.min.css&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;./css/login.css&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;login-box&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">form</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-group mb-3&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;username&quot;</span>&gt;</span>Account<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- 账号 --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">id</span>=<span class="string">&quot;username&quot;</span> <span class="attr">autocomplete</span>=<span class="string">&quot;off&quot;</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">small</span> <span class="attr">id</span>=<span class="string">&quot;emailHelp&quot;</span> <span class="attr">class</span>=<span class="string">&quot;form-text text-muted&quot;</span>&gt;</span></span><br><span class="line">                    The available account is</span><br><span class="line">                    <span class="tag">&lt;<span class="name">strong</span>&gt;</span>admin<span class="tag">&lt;/<span class="name">strong</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">small</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-group mb-3&quot;</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- 密码 --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;password&quot;</span>&gt;</span>Password<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">id</span>=<span class="string">&quot;password&quot;</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">small</span> <span class="attr">id</span>=<span class="string">&quot;emailHelp&quot;</span> <span class="attr">class</span>=<span class="string">&quot;form-text text-muted&quot;</span>&gt;</span></span><br><span class="line">                    The available password is</span><br><span class="line">                    <span class="tag">&lt;<span class="name">strong</span>&gt;</span>123456<span class="tag">&lt;/<span class="name">strong</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">small</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-primary&quot;</span> <span class="attr">id</span>=<span class="string">&quot;btnLogin&quot;</span>&gt;</span>Submit<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/js/axios.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/js/form-serialize.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 请求体的数据编码格式不同，后端接收到的数据格式也会不同。</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 1. application/x-www-form-urlencoded     表单中不包含文件上传的场景，适用于普通数据的提交</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 2. application/json                      json数据传输</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 3. multipart/form-data                   在于能实现异步上传文件</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 接口地址: /userInfo/apiform</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 请求方式: POST</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;form&#x27;</span>).<span class="title function_">addEventListener</span>(<span class="string">&#x27;submit&#x27;</span>, <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            e.<span class="title function_">preventDefault</span>()</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// let data = serialize(this)</span></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// console.log(data) // 键值对字符串  username=admin&amp;password=123456</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">let</span> data = <span class="title function_">serialize</span>(<span class="variable language_">this</span>, &#123; <span class="attr">hash</span>: <span class="literal">true</span> &#125;)</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(data)   <span class="comment">// js对象     &#123;username: &#x27;admin&#x27;, password: &#x27;123456&#x27;&#125;</span></span></span><br><span class="line"><span class="language-javascript">        &#125;)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> fd = <span class="keyword">new</span> <span class="title class_">FormData</span>()</span></span><br><span class="line"><span class="language-javascript">        fd.<span class="title function_">append</span>(<span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;lw&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// axios 发送请求</span></span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">axios</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">method</span>: <span class="string">&#x27;post&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">url</span>: <span class="string">&#x27;/userInfo/apiform&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// params 查询参数</span></span></span><br><span class="line"><span class="language-javascript">            <span class="attr">params</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">a</span>: <span class="number">1</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">b</span>: <span class="number">2</span></span></span><br><span class="line"><span class="language-javascript">            &#125;,</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 请求体数据</span></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 注意： data的值必须是有&#123;&#125;，这是错误的认知</span></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//  data的值是js对象，axios 发送请求体数据的时候，发送的是json格式数据</span></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//  看请求报文里面的Content-Type的值  application/json</span></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// data: &#123;</span></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//     c: 3,</span></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//     d: 4</span></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// &#125;</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 键值对字符串格式   键=值&amp;键=值</span></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// data的值是键值对字符串格式，对应的Content-Type的值 application/x-www-form-urlencoded</span></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// data: &#x27;c=3&amp;d=4&#x27;</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// data请求体数据是FormData格式数据, 对应的Content-Type的值 multipart/form-data</span></span></span><br><span class="line"><span class="language-javascript">            <span class="attr">data</span>: fd</span></span><br><span class="line"><span class="language-javascript">        &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">&#123; data: res &#125;</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(res)</span></span><br><span class="line"><span class="language-javascript">        &#125;)</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>总结出，不同的数据格式发送到服务端以后，对应的应该怎样进行接收。</p>
<h3 id="15-7-async与await基本使用"><a href="#15-7-async与await基本使用" class="headerlink" title="15.7  async与await基本使用"></a>15.7  <code>async与await</code>基本使用</h3><p>首先在控制器中创建一个方法,代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">ShowAsync</span>()</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">return</span> View();</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>以上方法对应的视图代码如下所示：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/js/axios.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// async await基本使用</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//  异步终极解决方案：async  await</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//  是一对关键字，需要配合使用</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// ============================== 核心 ==============================</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 1. async用于修饰一个函数, 表示一个函数是异步的</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//     如果async函数内没有await, 那么async没有意义的, 全是同步的内容</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//     只有遇到了await开始往下, 才是异步的开始</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 2. await 要用在 async 函数中</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 3. await 后面一般会跟一个promise对象,  await会阻塞async函数的执行,</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//     直到等到 promise成功的结果(resolve的结果)</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 4. await 只会等待 promise 成功的结果, 如果失败了会报错, 需要 try catch</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// ============================== 核心1 ==============================</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 1. async用于修饰一个函数, 表示一个函数是异步的</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//     如果async函数内没有await, 那么async没有意义的, 全是同步的内容</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//     只有遇到了await开始往下, 才是异步的开始</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// async function fn() &#123;</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//     let num = await 1 + 10 // await 后面如果是表达式 ，await的结果就是该表达式的值</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//     console.log(num)  // 11</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// &#125;</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// fn()</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// console.log(2)</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// ============================== 核心2 ==============================</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// await 要用在 async 函数中</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// function fn() &#123;</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//     // error: await is only valid in async functions</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//     let num = await 1 + 10</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//     console.log(num)  // 11</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// &#125;</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// fn()</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// console.log(2)</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// ============================== 核心3 ==============================</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// await 后面一般会跟一个promise对象,  await会阻塞async函数的执行,</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//     直到等到 promise成功的结果(resolve的结果)</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// axios.get(&#x27;/userInfo/getbooks&#x27;)</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// axios.get(&#x27;/userInfo/getbooks&#x27;).then((&#123;data: res&#125;) =&gt; &#123;&#125;)</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// async function fn() &#123;</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//     let &#123; data: res &#125; = await axios.get(&#x27;/userInfo/getbooks&#x27;)</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//     console.log(res) // axios请求成功的结果（图书）</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//     // 获取新闻列表数据</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//     let &#123; data: resNews &#125; = await axios.get(&#x27;/userInfo/news&#x27;)</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//     console.log(resNews) // axios请求成功的结果（新闻）</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// &#125;</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// fn()</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// ============================== 核心4 ==============================</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//   await 只会等待 promise 成功的结果, 如果失败了会报错, 需要 try catch</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// try catch 语法</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// try&#123;</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//     // 放可以会出错的代码</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// &#125;catch(e)&#123;</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//     // 一旦try中的代码报错了，会被catch捕获到，其中参数e就是错误消息</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// &#125;</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fn</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">try</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">let</span> res = <span class="keyword">await</span> axios.<span class="title function_">get</span>(<span class="string">&#x27;/userInfo /getbooks&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(res) <span class="comment">// axios请求成功的结果（图书）</span></span></span><br><span class="line"><span class="language-javascript">            &#125; <span class="keyword">catch</span> (e) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(e) <span class="comment">// 错误消息</span></span></span><br><span class="line"><span class="language-javascript">                <span class="title function_">alert</span>(<span class="string">&#x27;获取失败，请稍后重试~~~&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">fn</span>()</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://www.kilgour.top">kilgour</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://www.kilgour.top/2024/07/07/%E8%80%81%E7%8E%8B-11%E3%80%81MVC/">http://www.kilgour.top/2024/07/07/%E8%80%81%E7%8E%8B-11%E3%80%81MVC/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://www.kilgour.top" target="_blank">Kilgour Notes</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://raw.githubusercontent.com/kilg0ur/picture/master/picture/cover6.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/07/18/%E8%80%81%E7%8E%8B-12%E3%80%81CMS%E9%A1%B9%E7%9B%AE/" title=""><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/kilg0ur/picture/master/picture/cover3.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info"></div></div></a></div><div class="next-post pull-right"><a href="/2024/07/03/%E8%80%81%E7%8E%8B-10%E3%80%81JavaScript%E9%AB%98%E7%BA%A7/" title="JavaScript高级"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/kilg0ur/picture/master/picture/cover2.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">JavaScript高级</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/5.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">kilgour</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">35</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/kilg0ur"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">欢迎来到我的博客！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81Web%E5%BA%94%E7%94%A8%E5%B7%A5%E4%BD%9C%E6%96%B9%E5%BC%8F"><span class="toc-number">1.</span> <span class="toc-text">一、Web应用工作方式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E5%90%8D%E8%AF%8D%E8%A7%A3%E9%87%8A"><span class="toc-number">1.1.</span> <span class="toc-text">1、名词解释</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81MVC%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">2.</span> <span class="toc-text">二、MVC环境搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E4%BB%80%E4%B9%88%E6%98%AFMVC"><span class="toc-number">2.1.</span> <span class="toc-text">1、什么是MVC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E9%A1%B9%E7%9B%AE%E5%88%9B%E5%BB%BA"><span class="toc-number">2.2.</span> <span class="toc-text">2、项目创建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E6%8E%A7%E5%88%B6%E5%99%A8%E8%AE%BF%E9%97%AE"><span class="toc-number">2.2.1.</span> <span class="toc-text">2.1  控制器访问</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E8%A7%86%E5%9B%BE%E5%88%9B%E5%BB%BA"><span class="toc-number">2.2.2.</span> <span class="toc-text">2.2  视图创建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E5%85%AC%E5%85%B1%E8%A7%86%E5%9B%BE"><span class="toc-number">2.2.3.</span> <span class="toc-text">2.3  公共视图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-%E5%B8%83%E5%B1%80%E8%A7%86%E5%9B%BE"><span class="toc-number">2.2.4.</span> <span class="toc-text">2.4 布局视图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-%E8%A7%86%E5%9B%BE%E5%AF%BC%E5%85%A5"><span class="toc-number">2.2.5.</span> <span class="toc-text">2.5 视图导入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-%E6%A8%A1%E5%9E%8B%E5%88%9B%E5%BB%BA"><span class="toc-number">2.2.6.</span> <span class="toc-text">2.6 模型创建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-7-Action%E6%96%B9%E6%B3%95"><span class="toc-number">2.2.7.</span> <span class="toc-text">2.7 Action方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-8-Razor%E8%A7%86%E5%9B%BE"><span class="toc-number">2.2.8.</span> <span class="toc-text">2.8 Razor视图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-9-%E8%A7%86%E5%9B%BE%E4%BC%A0%E5%80%BC"><span class="toc-number">2.2.9.</span> <span class="toc-text">2.9 视图传值</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81http%E8%AF%B7%E6%B1%82"><span class="toc-number">2.3.</span> <span class="toc-text">3、http请求</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E8%A1%A8%E5%8D%95%E6%8F%90%E4%BA%A4%E6%96%B9%E5%BC%8F"><span class="toc-number">2.3.1.</span> <span class="toc-text">3.1  表单提交方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-http%E5%8D%8F%E8%AE%AE"><span class="toc-number">2.3.2.</span> <span class="toc-text">3.2 http协议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-https%E7%AE%80%E4%BB%8B"><span class="toc-number">2.3.3.</span> <span class="toc-text">3.3 https简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-https%E5%8E%9F%E7%90%86"><span class="toc-number">2.3.4.</span> <span class="toc-text">3.5 https原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6%EF%BC%9AHttpContext%E4%B8%8A%E4%B8%8B%E6%96%87"><span class="toc-number">2.3.5.</span> <span class="toc-text">3.6：HttpContext上下文</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E6%A8%A1%E5%9E%8B%E7%BB%91%E5%AE%9A"><span class="toc-number">2.4.</span> <span class="toc-text">4、模型绑定</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-Model%E8%87%AA%E5%8A%A8%E7%BB%91%E5%AE%9A"><span class="toc-number">2.4.1.</span> <span class="toc-text">4.1 Model自动绑定</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E7%89%B9%E6%80%A7%E7%BB%91%E5%AE%9A"><span class="toc-number">2.4.2.</span> <span class="toc-text">4.2 特性绑定</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E7%BB%91%E5%AE%9A%E6%9D%A5%E6%BA%90"><span class="toc-number">2.4.3.</span> <span class="toc-text">4.3  绑定来源</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%E3%80%81%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E4%B8%8E%E4%B8%8B%E8%BD%BD"><span class="toc-number">2.5.</span> <span class="toc-text">5、文件上传与下载</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E5%8D%95%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-number">2.5.1.</span> <span class="toc-text">5.1 单文件上传</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%A4%A7%E5%B0%8F%E9%99%90%E5%88%B6"><span class="toc-number">2.5.2.</span> <span class="toc-text">5.2 文件上传大小限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-%E5%A4%9A%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-number">2.5.3.</span> <span class="toc-text">5.3  多文件上传</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E4%B8%8E%E5%85%B6%E4%BB%96%E8%A1%A8%E5%8D%95%E5%85%83%E7%B4%A0%E8%BF%9E%E7%94%A8"><span class="toc-number">2.5.4.</span> <span class="toc-text">5.4  文件上传与其他表单元素连用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-%E5%B1%95%E7%A4%BA%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6"><span class="toc-number">2.5.5.</span> <span class="toc-text">5.5  展示图片文件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6%E3%80%81%E6%A8%A1%E5%9E%8B%E6%A0%A1%E9%AA%8C%EF%BC%88%E4%BA%86%E8%A7%A3%EF%BC%89"><span class="toc-number">2.6.</span> <span class="toc-text">6、模型校验（了解）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%A0%A1%E9%AA%8C"><span class="toc-number">2.6.1.</span> <span class="toc-text">6.1 客户端校验</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%A0%A1%E9%AA%8C"><span class="toc-number">2.6.2.</span> <span class="toc-text">6.2 服务端校验</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7%E3%80%81Asp-net-Core%E4%B8%AD%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">2.7.</span> <span class="toc-text">7、Asp.net Core中依赖注入的使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8%E3%80%81AutoMapper%E5%BA%94%E7%94%A8"><span class="toc-number">2.8.</span> <span class="toc-text">8、AutoMapper应用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-AutoMapper%E4%BD%BF%E7%94%A81"><span class="toc-number">2.8.1.</span> <span class="toc-text">8.1 AutoMapper使用1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-AutoMapper%E5%BA%94%E7%94%A82"><span class="toc-number">2.8.2.</span> <span class="toc-text">8.2  AutoMapper应用2</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9%E3%80%81%E7%BC%93%E5%AD%98Cache"><span class="toc-number">2.9.</span> <span class="toc-text">9、缓存Cache</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#9-1-%E4%BB%80%E4%B9%88%E6%98%AF%E7%BC%93%E5%AD%98"><span class="toc-number">2.9.1.</span> <span class="toc-text">9.1 什么是缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-2-%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%93%8D%E5%BA%94%E7%BC%93%E5%AD%98"><span class="toc-number">2.9.2.</span> <span class="toc-text">9.2  客户端响应缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-3-%E5%86%85%E5%AD%98%E7%BC%93%E5%AD%98"><span class="toc-number">2.9.3.</span> <span class="toc-text">9.3 内存缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-4-%E7%BC%93%E5%AD%98%E8%BF%87%E6%9C%9F%E6%97%B6%E9%97%B4%E7%AD%96%E7%95%A5"><span class="toc-number">2.9.4.</span> <span class="toc-text">9.4 缓存过期时间策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-5-%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F%E9%97%AE%E9%A2%98"><span class="toc-number">2.9.5.</span> <span class="toc-text">9.5 缓存穿透问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-6-%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9%E9%97%AE%E9%A2%98"><span class="toc-number">2.9.6.</span> <span class="toc-text">9.6 缓存雪崩问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10%E3%80%81Filter"><span class="toc-number">2.10.</span> <span class="toc-text">10、Filter</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#10-1-%E5%BC%82%E5%B8%B8%E7%AD%9B%E9%80%89%E5%99%A8"><span class="toc-number">2.10.1.</span> <span class="toc-text">10.1  异常筛选器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-2-ActionFilter%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="toc-number">2.10.2.</span> <span class="toc-text">10.2 ActionFilter基本使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-3-ActionFilter%E6%A1%88%E4%BE%8B"><span class="toc-number">2.10.3.</span> <span class="toc-text">10.3 ActionFilter案例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#10-3-1-TransactionScope%E4%BA%8B%E5%8A%A1"><span class="toc-number">2.10.3.1.</span> <span class="toc-text">10.3.1 TransactionScope事务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#10-3-2-Action-Filter%E5%B0%81%E8%A3%85TransactionScope"><span class="toc-number">2.10.3.2.</span> <span class="toc-text">10.3.2 Action Filter封装TransactionScope</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-4-ActionFilter%E6%A1%88%E4%BE%8B2"><span class="toc-number">2.10.4.</span> <span class="toc-text">10.4 ActionFilter案例2</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11%E3%80%81%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">2.11.</span> <span class="toc-text">11、中间件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#11-1-%E4%BB%80%E4%B9%88%E6%98%AF%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">2.11.1.</span> <span class="toc-text">11.1 什么是中间件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-2-%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%B8%B8%E8%A7%81%E6%A6%82%E5%BF%B5"><span class="toc-number">2.11.2.</span> <span class="toc-text">11.2 中间件常见概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-3-%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-number">2.11.3.</span> <span class="toc-text">11.3 中间件执行流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-4-%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%B0%81%E8%A3%85"><span class="toc-number">2.11.4.</span> <span class="toc-text">11.4  中间件封装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-5-%E6%A8%A1%E6%8B%9FMVC%E6%A1%86%E6%9E%B6"><span class="toc-number">2.11.5.</span> <span class="toc-text">11.5 模拟MVC框架</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#11-5-1-%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86"><span class="toc-number">2.11.5.1.</span> <span class="toc-text">11.5.1  静态文件处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#11-5-2-%E6%9C%AA%E6%89%BE%E5%88%B0%E8%B5%84%E6%BA%90%E5%A4%84%E7%90%86"><span class="toc-number">2.11.5.2.</span> <span class="toc-text">11.5.2  未找到资源处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#11-5-3-%E5%A4%84%E7%90%86%E6%8E%A7%E5%88%B6%E5%99%A8%E5%92%8C%E6%96%B9%E6%B3%95"><span class="toc-number">2.11.5.3.</span> <span class="toc-text">11.5.3 处理控制器和方法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-6-%E8%B0%83%E6%95%B4%E5%86%85%E7%BD%AE%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%9A%84%E9%A1%BA%E5%BA%8F"><span class="toc-number">2.11.6.</span> <span class="toc-text">11.6 调整内置中间件的顺序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-7-%E4%B8%AD%E9%97%B4%E4%BB%B6%E4%B8%8EFilter%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">2.11.7.</span> <span class="toc-text">11.7 中间件与Filter的区别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-8%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">2.11.8.</span> <span class="toc-text">11.8异常处理中间件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12%E3%80%81%E8%B7%AF%E7%94%B1"><span class="toc-number">2.12.</span> <span class="toc-text">12、路由</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13%E3%80%81%E7%8A%B6%E6%80%81%E4%BF%9D%E6%8C%81"><span class="toc-number">2.13.</span> <span class="toc-text">13、状态保持</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#13-1-Cookie"><span class="toc-number">2.13.1.</span> <span class="toc-text">13.1  Cookie</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#13-1-1-Cookie%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="toc-number">2.13.1.1.</span> <span class="toc-text">13.1.1 Cookie基本使用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13-1-2-%E5%B0%81%E8%A3%85%E5%A4%84%E7%90%86"><span class="toc-number">2.13.1.2.</span> <span class="toc-text">13.1.2 封装处理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-2-Session"><span class="toc-number">2.13.2.</span> <span class="toc-text">13.2 Session</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#13-2-1-Session%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="toc-number">2.13.2.1.</span> <span class="toc-text">13.2.1 Session基本使用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13-2-2-Session-%E7%9B%B8%E5%85%B3%E7%9A%84%E9%85%8D%E7%BD%AE"><span class="toc-number">2.13.2.2.</span> <span class="toc-text">13.2.2 Session 相关的配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13-2-3-%E5%AD%98%E5%82%A8%E5%BA%8F%E5%88%97%E5%8C%96%E5%AF%B9%E8%B1%A1"><span class="toc-number">2.13.2.3.</span> <span class="toc-text">13.2.3   存储序列化对象</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13-2-4-%E5%B0%81%E8%A3%85%E5%A4%84%E7%90%86"><span class="toc-number">2.13.2.4.</span> <span class="toc-text">13.2.4  封装处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13-2-5-Protobuf%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">2.13.2.5.</span> <span class="toc-text">13.2.5  Protobuf序列化</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#14%E3%80%81%E9%AA%8C%E8%AF%81%E7%A0%81"><span class="toc-number">2.14.</span> <span class="toc-text">14、验证码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#15%E3%80%81AJAX%E5%BA%94%E7%94%A8"><span class="toc-number">2.15.</span> <span class="toc-text">15、AJAX应用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#15-1-%E4%BB%80%E4%B9%88%E6%98%AFAjax"><span class="toc-number">2.15.1.</span> <span class="toc-text">15.1   什么是Ajax</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-2-%E4%BD%BF%E7%94%A8axios%E5%8F%91%E9%80%81get%E8%AF%B7%E6%B1%82"><span class="toc-number">2.15.2.</span> <span class="toc-text">15.2 使用axios发送get请求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-3-%E6%9F%A5%E8%AF%A2%E5%8F%82%E6%95%B0%E7%9A%84%E6%9C%AC%E8%B4%A8"><span class="toc-number">2.15.3.</span> <span class="toc-text">15.3  查询参数的本质</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-4-%E4%BD%BF%E7%94%A8axios%E5%8F%91%E8%B5%B7POST%E8%AF%B7%E6%B1%82"><span class="toc-number">2.15.4.</span> <span class="toc-text">15.4 使用axios发起POST请求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-5-%E6%B5%8B%E8%AF%95POST%E7%9A%84%E8%AF%B7%E6%B1%82%E4%BD%93%E5%92%8C%E6%9F%A5%E8%AF%A2%E5%8F%82%E6%95%B0"><span class="toc-number">2.15.5.</span> <span class="toc-text">15.5  测试POST的请求体和查询参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-6-%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95"><span class="toc-number">2.15.6.</span> <span class="toc-text">15.6  用户登录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-7-form-serialize%E6%8F%92%E4%BB%B6%E5%BA%94%E7%94%A8"><span class="toc-number">2.15.7.</span> <span class="toc-text">15.7 form-serialize插件应用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-8-FormData-%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="toc-number">2.15.8.</span> <span class="toc-text">15.8  FormData 基本使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-9-FormData%E5%AE%9E%E7%8E%B0%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-number">2.15.9.</span> <span class="toc-text">15.9  FormData实现文件上传</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-10-AJAX%E6%A1%88%E4%BE%8B%E2%80%93%E5%9B%BE%E4%B9%A6%E7%AE%A1%E7%90%86"><span class="toc-number">2.15.10.</span> <span class="toc-text">15.10  AJAX案例–图书管理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#15-10-1-%E5%9B%BE%E4%B9%A6%E5%88%97%E8%A1%A8%E5%B1%95%E7%A4%BA"><span class="toc-number">2.15.10.1.</span> <span class="toc-text">15.10.1  图书列表展示</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#15-10-2-%E6%B7%BB%E5%8A%A0%E5%9B%BE%E4%B9%A6"><span class="toc-number">2.15.10.2.</span> <span class="toc-text">15.10.2  添加图书</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#15-10-3-%E5%88%A0%E9%99%A4%E5%9B%BE%E4%B9%A6"><span class="toc-number">2.15.10.3.</span> <span class="toc-text">15.10.3  删除图书</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-11-XMLHttpRequest%E5%AF%B9%E8%B1%A1"><span class="toc-number">2.15.11.</span> <span class="toc-text">15.11  XMLHttpRequest对象</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#15-11-1-%E5%8F%91%E9%80%81get%E8%AF%B7%E6%B1%82"><span class="toc-number">2.15.11.1.</span> <span class="toc-text">15.11.1  发送get请求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#15-11-2-%E5%8F%91%E9%80%81post%E8%AF%B7%E6%B1%82"><span class="toc-number">2.15.11.2.</span> <span class="toc-text">15.11.2 发送post请求</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-12-%E8%AF%B7%E6%B1%82%E4%BD%93%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BC%96%E7%A0%81%E6%A0%BC%E5%BC%8F%E8%AF%B4%E6%98%8E"><span class="toc-number">2.15.12.</span> <span class="toc-text">15.12  请求体的数据编码格式说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-13-axios%E7%AE%80%E5%8C%96%E7%94%A8%E6%B3%95"><span class="toc-number">2.15.13.</span> <span class="toc-text">15.13 axios简化用法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-14-JSON%E6%95%B0%E6%8D%AE%E8%AF%B4%E6%98%8E"><span class="toc-number">2.15.14.</span> <span class="toc-text">15.14 JSON数据说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-5-XMLHttpRequest%E5%AF%B9%E8%B1%A1%E5%8F%91%E8%B5%B7Post%E8%AF%B7%E6%B1%82%E2%80%93%E5%8F%91%E9%80%81JSON"><span class="toc-number">2.15.15.</span> <span class="toc-text">15.5  XMLHttpRequest对象发起Post请求–发送JSON</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-6-%E6%A2%B3%E7%90%86%E5%B8%B8%E8%A7%81%E7%96%91%E6%83%91%E7%82%B9"><span class="toc-number">2.15.16.</span> <span class="toc-text">15.6  梳理常见疑惑点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-7-async%E4%B8%8Eawait%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="toc-number">2.15.17.</span> <span class="toc-text">15.7  async与await基本使用</span></a></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2025 By kilgour</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">2</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --><script data-pjax>
  function butterfly_footer_beautify_injector_config(){
    var parent_div_git = document.getElementById('footer-wrap');
    var item_html = '<div id="workboard"></div>';
    console.log('已挂载butterfly_footer_beautify')
    parent_div_git.insertAdjacentHTML("beforeend",item_html)
    }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_footer_beautify_injector_config();
  }
  else if (epage === cpage){
    butterfly_footer_beautify_injector_config();
  }
  </script><script async src="/js/runtime.js"></script><!-- hexo injector body_end end --></body></html>