<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Kilgour Notes | Kilgour Notes</title><meta name="author" content="kilgour"><meta name="copyright" content="kilgour"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content=".Net Core  Web  Api1、什么是.Net Core ApiApi:Application Programming Interface,应用程序编程接口 前后端分离：     2、.Net Core Api 与 MVC开发区别返回数据格式不同，Api返回json格式。 MVC:返回整个html页面。 3、Api 项目创建在创建项目的时候，我们选择的是Asp.net Core Web">
<meta property="og:type" content="article">
<meta property="og:title" content="Kilgour Notes">
<meta property="og:url" content="http://www.kilgour.top/2024/07/25/%E8%80%81%E7%8E%8B-18%E3%80%81Net-Core-Web-Api/index.html">
<meta property="og:site_name" content="Kilgour Notes">
<meta property="og:description" content=".Net Core  Web  Api1、什么是.Net Core ApiApi:Application Programming Interface,应用程序编程接口 前后端分离：     2、.Net Core Api 与 MVC开发区别返回数据格式不同，Api返回json格式。 MVC:返回整个html页面。 3、Api 项目创建在创建项目的时候，我们选择的是Asp.net Core Web">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/kilg0ur/picture/master/picture/cover2.jpg">
<meta property="article:published_time" content="2024-07-25T09:02:57.932Z">
<meta property="article:modified_time" content="2024-07-26T13:01:39.219Z">
<meta property="article:author" content="kilgour">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/kilg0ur/picture/master/picture/cover2.jpg"><link rel="shortcut icon" href="https://raw.githubusercontent.com/kilg0ur/picture/master/picture/logo.png"><link rel="canonical" href="http://www.kilgour.top/2024/07/25/%E8%80%81%E7%8E%8B-18%E3%80%81Net-Core-Web-Api/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":230},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"top-right"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Kilgour Notes',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-07-26 21:01:39'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/panarama.css" media="defer" onload="this.media='all'"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-footer-beautify@1.0.0/lib/runtime.css" media="print" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/5.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">35</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 列表</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> 图库</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://raw.githubusercontent.com/kilg0ur/picture/master/picture/cover2.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="Kilgour Notes"><img class="site-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/kilg0ur/picture/master/picture/logo.png"/><span class="site-name">Kilgour Notes</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 列表</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> 图库</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">无题</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-07-25T09:02:57.932Z" title="发表于 2024-07-25 17:02:57">2024-07-25</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-07-26T13:01:39.219Z" title="更新于 2024-07-26 21:01:39">2024-07-26</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">25.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>100分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Net-Core-Web-Api"><a href="#Net-Core-Web-Api" class="headerlink" title=".Net Core  Web  Api"></a>.Net Core  Web  Api</h1><h2 id="1、什么是-Net-Core-Api"><a href="#1、什么是-Net-Core-Api" class="headerlink" title="1、什么是.Net Core Api"></a>1、什么是<code>.Net Core Api</code></h2><p><code>Api</code>:<code>Application Programming Interface,应用程序编程接口</code></p>
<p>前后端分离：    </p>
<h2 id="2、-Net-Core-Api-与-MVC开发区别"><a href="#2、-Net-Core-Api-与-MVC开发区别" class="headerlink" title="2、.Net Core Api 与 MVC开发区别"></a>2、<code>.Net Core Api 与 MVC</code>开发区别</h2><p>返回数据格式不同，<code>Api</code>返回<code>json</code>格式。</p>
<p><code>MVC</code>:返回整个<code>html</code>页面。</p>
<h2 id="3、Api-项目创建"><a href="#3、Api-项目创建" class="headerlink" title="3、Api 项目创建"></a>3、<code>Api</code> 项目创建</h2><p>在创建项目的时候，我们选择的是<code>Asp.net Core Web Api</code> 的项目。</p>
<p>在创建项目的时候把<code>启用OpenAPI</code>支持，这一个选项选中。</p>
<p>创建好的项目中有<code>Controllers</code>文件夹，但是没有<code>Views</code>文件夹，因为现在我们不需要操作视图。</p>
<p>因为，视图也就是我们所说的页面，都是有前端开发人员进行开发的，而我们作为服务端开发人员，不用关心页面的实现，</p>
<p>也就是说，我们服务端开发人员，只负责实现服务端的业务，并且向前端提供数据，前端页面应该怎样展示数据，服务端开发人员不用关心，都是有前端开发人员实现的。</p>
<p>当启动默认创建好的<code>Api</code>程序以后，会呈现出<code>Swagger</code>。</p>
<p>这是由于我们在创建项目的时候，选择了<code>OpenAPI</code>这个选项以后所提供的。</p>
<p>因为<code>Api</code>项目没有界面，所以提供了<code>Swagger</code>访问我们所创建的<code>Api</code>程序。普通用户是无法看到这个<code>Swagger</code>页面的。</p>
<p>普通用户是通过浏览器，<code>App</code>，微信小程序来访问我们的<code>api</code>程序的。所以说<code>Swagger</code>页面是我们开发人员，对<code>Api</code>接口程序进行调试所使用的。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">ApiController</span>] <span class="comment">// 表示的是一个Api的控制器</span></span><br><span class="line">  [<span class="meta">Route(<span class="string">&quot;[controller]&quot;</span>)</span>] <span class="comment">// 在请求的时候需要添加控制器的名字</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Route(<span class="string">&quot;api/[controller]&quot;</span>)</span>] <span class="comment">// 添加了前缀api,所以在访问的时候需要添加该前缀，如下所示：https://localhost:7081/api/WeatherForecast</span></span><br></pre></td></tr></table></figure>

<p>如果发送的请求是一个<code>get</code>请求，就会被<code>Get</code>这个方法所处理。</p>
<p>当然，这里我们也可以直接在浏览器的地址栏中输入<code>api</code>的地址进行访问。</p>
<h2 id="4、第一个Api程序"><a href="#4、第一个Api程序" class="headerlink" title="4、第一个Api程序"></a>4、第一个<code>Api</code>程序</h2><p>在这一小节中，我们重新创建一个<code>控制器</code>。</p>
<p>注意：这里在创建控制器的时候，一定要选择的是<code>API控制器</code></p>
<p>在<code>UserInfoController.cs</code>这个控制器中添加如下代码：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Route(<span class="string">&quot;api/[controller]&quot;</span>)</span>]</span><br><span class="line">[<span class="meta">ApiController</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserInfoController</span> : <span class="title">ControllerBase</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">HttpGet</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Person <span class="title">GetPerson</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Person()</span><br><span class="line">        &#123;</span><br><span class="line">            Id = <span class="number">1</span>,</span><br><span class="line">            Name = <span class="string">&quot;Test&quot;</span>,</span><br><span class="line">            Password = <span class="string">&quot;123&quot;</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当以<code>Get</code>请求的方式，请求<code>GetPerson</code>方法的时候，会返回用户的信息，这里返回的是一个对象。</p>
<p>这里需要在项目中创建<code>Models</code>文件夹，在该文件夹中创建一个<code>Person.cs</code>类，该类中的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Person</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? Password &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>下面我们在发送一个<code>Post</code>请求</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">HttpPost</span>]</span><br><span class="line">     <span class="function"><span class="keyword">public</span> ApiResult <span class="title">Login</span>(<span class="params">Person p</span>) <span class="comment">// 接收数据</span></span></span><br><span class="line">     &#123;</span><br><span class="line">         <span class="keyword">if</span>(p.Name ==<span class="string">&quot;admin&quot;</span> &amp;&amp; p.Password == <span class="string">&quot;123&quot;</span>)</span><br><span class="line">         &#123;</span><br><span class="line">             <span class="keyword">return</span> <span class="keyword">new</span> ApiResult &#123; Code = <span class="number">200</span>, Message = <span class="string">&quot;登录成功&quot;</span> &#125;;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">else</span></span><br><span class="line">         &#123;</span><br><span class="line">             <span class="keyword">return</span> <span class="keyword">new</span> ApiResult &#123; Code = <span class="number">500</span>, Message = <span class="string">&quot;登录失败&quot;</span> &#125;;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>

<p>返回的结果是通过<code>ApiResult</code>这个类来表示的。</p>
<p>所以在<code>Models</code>目录下面创建<code>ApiResult</code>这个类，该类中的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ApiResult</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> Code &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Message &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>启动程序进行测试。</p>
<p>这里会要求输入请求体。</p>
<h2 id="5、什么是REST-Restful"><a href="#5、什么是REST-Restful" class="headerlink" title="5、什么是REST/Restful"></a>5、什么是<code>REST/Restful</code></h2><p><code>Rest</code>与<code>Restful</code>是一样的，只是不同的叫法。</p>
<p>针对<code>Web Api</code>的开发风格（所谓的风格，指的是请求方式怎么使用，状态码怎样使用，路径怎样使用），有两种。</p>
<p>分别是面向过程(<code>RPC</code>【<code>Remote Procedure Call</code>】), 面向<code>Rest</code>【<code>Representational State Transfer</code>】</p>
<p>先来看一下面向过程：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">在RPC风格的WebAPI中，我们通过“控制器／操作方法”的形式把服务器端的代码当成方法去调用。这样的接口只是把HTTP当成一个传输数据的通道，而不关心HTTP谓词的语义(`http`语义,可以理解成协议的一种规范、约定、要求，。例如，删除数据，按照`http`的语义来讲，应该发送`delete`请求，但是我们前面发送的是`get`请求，这就是说明我们定义的`api`不符合`http`协议的语义)、状态码。比如：/Persons/GetAll、/Persons/GetById?id=8、/Persons/Update、/Persons/DeleteById/8；</span><br><span class="line">这种方式简单，粗暴，很多人都习惯采用这种方式来开发`Web Api`</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">HttpGet(<span class="string">&quot;[action]&quot;</span>)</span>]</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">GetName</span>(<span class="params"><span class="built_in">int</span> id</span>)</span></span><br><span class="line">      &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="string">&quot;zhangsan&quot;</span> + id;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>这里访问的地址：<code>https://localhost:7081/api/UserInfo/GetName?id=10</code></p>
<p><strong>下面看一下<code>REST</code></strong></p>
<p><code>REST</code>:按照<code>http</code>的语义来使用<code>http</code>协议。</p>
<p><code>http</code>语义,可以理解成协议的一种规范、约定、要求。例如，删除数据，按照<code>http</code>的语义来讲，应该发送<code>delete</code>请求，但是我们前面发送的是<code>get</code>请求，这就是说明我们定义的<code>api</code>不符合<code>http</code>协议的语义，也不是<code>rest</code>方式。还有关于状态码，如果新增成功，按照<code>http</code>的语义，应该返回的是201（表示新增成功），但是前面我们写的都是200，说明我们前面写的也不符合<code>http</code>语义，也不符合<code>rest</code>风格。</p>
<p>我们只有将符合<code>http</code>语义的<code>web api</code>开发方式称作为<code>rest</code>风格。</p>
<p>当然，我们不使用<code>rest</code>方式，使用<code>rpc</code>方式程序也不会出错。</p>
<p>举一个生活的例子来进一步理解语义的含义：</p>
<p>小轿车的作用就是拉人，但是你拉货，也没有问题，但是不符合小轿车的最初设计的用途。</p>
<p>所以说按照<code>http</code>语义来设计<code>Web api</code>的接口，我们就说所设计的<code>web api</code>接口符合<code>rest</code>风格。</p>
<p>常见的语义：</p>
<p><strong>第一：域名</strong></p>
<p>应该尽量将API部署在专用域名之下。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://api.example.com</span><br></pre></td></tr></table></figure>

<p>如果确定<code>API</code>很简单，不会有进一步扩展，可以考虑放在主域名下。(我们默认创建的<code>WebApi</code>项目符合这个规范)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://example.org/api/</span><br></pre></td></tr></table></figure>

<p><strong>第二：版本</strong></p>
<p>应该将<code>API</code>的版本号放入<code>URL</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://api.example.com/v1/</span><br></pre></td></tr></table></figure>

<p><strong>第三：路径</strong></p>
<p>路径又称”终点”（<code>endpoint</code>），表示API的具体网址。</p>
<p>在<code>RESTful</code>架构中，每个网址代表一种资源（<code>resource</code>），所以网址中不能有动词，只能有名词，而且所用的名词往往与数据库的表格名对应。一般来说，数据库中的表都是同种记录的”集合”（<code>collection</code>），所以<code>API</code>中的名词也应该使用复数。</p>
<p>举例来说，有一个API提供动物园（<code>zoo</code>）的信息，还包括各种动物和雇员的信息，则它的路径应该设计成下面这样。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https://api.example.com/v1/zoos</span><br><span class="line">https://api.example.com/v1/animals</span><br><span class="line">https://api.example.com/v1/employees</span><br></pre></td></tr></table></figure>

<p>还有如下形式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/users/5  // 获取编号为5的用户信息</span><br><span class="line"></span><br><span class="line">/users/5/orders // 获取编号为5的用户的所有的订单信息</span><br></pre></td></tr></table></figure>

<p><strong>第四：<code>HTTP</code>动词(谓词)</strong></p>
<p>对于资源的具体操作类型，由<code>HTTP</code>动词表示。</p>
<p>常用的<code>HTTP</code>动词有下面五个（括号里是对应的<code>SQL</code>命令）。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET（SELECT）：从服务器取出资源（一项或多项）。</span><br><span class="line">POST（Insert）：在服务器新增一个资源。</span><br><span class="line">PUT（UPDATE）：在服务器更新资源（整体更新，更新全部字段）。</span><br><span class="line">PATCH（UPDATE）：在服务器更新资源（局部更新,只是更新部分字段）。</span><br><span class="line">DELETE（DELETE）：从服务器删除资源。</span><br></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /zoos：列出所有动物园</span><br><span class="line">POST /zoos：新建一个动物园</span><br><span class="line">GET /zoos/ID：获取某个指定动物园的信息</span><br><span class="line">PUT /zoos/ID：更新某个指定动物园的信息（提供该动物园的全部信息）</span><br><span class="line">PATCH /zoos/ID：更新某个指定动物园的信息（提供该动物园的部分信息）</span><br><span class="line">DELETE /zoos/ID：删除某个动物园</span><br><span class="line">GET /zoos/ID/animals：列出某个指定动物园的所有动物</span><br><span class="line">DELETE /zoos/ID/animals/ID：删除某个指定动物园的指定动物</span><br></pre></td></tr></table></figure>

<p>第五：状态码</p>
<p>服务器向用户返回的状态码和提示信息，常见的有以下一些【方括号中是该状态码对应的HTTP动词】</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">200 OK - [GET]：服务器成功返回用户请求的数据</span><br><span class="line">201 CreatedAtAction - [POST/PUT/PATCH]：用户新建或修改数据成功。</span><br><span class="line">202 Accepted - [*]：表示一个请求已经进入后台排队（异步任务）</span><br><span class="line">204 NO CONTENT - [DELETE]：用户删除数据成功。</span><br><span class="line">400 INVALID REQUEST - [POST/PUT/PATCH]：用户发出的请求有错误，服务器没有进行新建或修改数据的操作</span><br><span class="line">401 Unauthorized - [*]：表示请求需要用户认证信息，用户未经过身份的验证，。</span><br><span class="line">403 Forbidden - [*] 表示服务端已经知道客户端的身份，只是用户未被授权，用户没有足够的权限来执行某些操作。</span><br><span class="line">404 NOT FOUND - [*]：用户发出的请求针对的是不存在的记录，服务器没有进行操作，例如请求编号为1的用户，如果不存在，返回404</span><br><span class="line">406 Not Acceptable - [GET]：用户请求的格式不可得（比如用户请求JSON格式，但是只有XML格式）。</span><br><span class="line">410 Gone -[GET]：用户请求的资源被永久删除，且不会再得到的。</span><br><span class="line">422 Unprocesable entity - [POST/PUT/PATCH] 当创建一个对象时，发生一个验证错误。</span><br><span class="line">500 INTERNAL SERVER ERROR - [*]：服务器发生错误，用户将无法判断发出的请求是否成功。</span><br></pre></td></tr></table></figure>

<p>以下定义的符合<code>rest</code>风格</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="E:/netcore/WebApi/讲义/images/243.png"></p>
<p>如何请求这些控制器中的方法呢？<br>例如：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">HttpGet(<span class="string">&quot;&#123;id&#125;&quot;</span>)</span>]</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">GetName</span>(<span class="params"><span class="built_in">int</span> id</span>)</span></span><br><span class="line">     &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="string">&quot;zhangsan&quot;</span> + id;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>以上方法请求的方式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://localhost:7081/api/UserInfo/12</span><br></pre></td></tr></table></figure>

<p>注意：在以上的地址中没有添加方法的名字。与传统<code>MVC</code>访问是不同的</p>
<p>以上常见的<code>restful</code>的风格，其他的在后面用到的时候再进行讲解。</p>
<p>路由：<code>https://learn.microsoft.com/zh-cn/aspnet/core/mvc/controllers/routing?view=aspnetcore-7.0</code></p>
<h2 id="6、REST优缺点"><a href="#6、REST优缺点" class="headerlink" title="6、REST优缺点"></a>6、<code>REST</code>优缺点</h2><p>优点：</p>
<ol>
<li><p><strong>通过URL对资源定位,语义更清晰;</strong></p>
</li>
<li><p><strong>通过HTTP谓词表示不同的操作，接口统一且具有自描述性，减少了前端开发人员对接口文档的依赖性。</strong></p>
<p>例如：删除编号为12用户请求的就是：<code>/UserInfos/12</code>, 而且发送的是<code>delete</code>请求，这里我们不需要查看稳当就知道。</p>
</li>
<li><p><strong>可以用GET请求做缓存</strong></p>
</li>
<li><p><strong>通过HTTP状态码反映服务器端的处理结果统一错误处理机制。</strong></p>
</li>
</ol>
<p>缺点：</p>
<ol>
<li><strong>真实系统资源复杂，很难清晰划分，对业务技术水平要求高；Restful 风格对设计人员的IT技能和业务知识的水平要求都非常高。</strong></li>
</ol>
<p>2、<strong>不是所有操作都能简单的对应到确定的HTTP谓词操作；</strong>（有些接口中包含了更新，包含了删除）</p>
<p>3、<strong>通过URL进行资源定位不符合中文用户习惯；</strong></p>
<p>4、<strong>HTTP状态码个数有限；有些复杂的情况，仅通过状态码无法描述</strong></p>
<p>选择：</p>
<p>第一：<code>Rest</code>是学术化的概念，仅供参考。国内很多公司也并不是<code>Restful</code>1</p>
<p>第二：根据公司情况，进行<code>Rest</code>的选择和裁剪。</p>
<p>实现业务才是王道。</p>
<h2 id="7、获取用户信息。"><a href="#7、获取用户信息。" class="headerlink" title="7、获取用户信息。"></a>7、获取用户信息。</h2><p>在这个小节中，我们需要创建两个<code>api</code>接口。</p>
<p>第一个获取用户的所有信息，第二个获取获取指定的用户信息。</p>
<p>这里我们在原有的<code>MVC</code>架构的基础上做修改。</p>
<p>使用原有项目架构的模版（使用原有的服务层，数据仓储层）</p>
<p>创建一个<code>Web Api</code>项目，在该项中把原来<code>MVC</code>项目中使用到的<code>Filters,Attributes,AutofaceDI</code>文件夹，都拷贝到<code>Web Api</code>项目中</p>
<p>然后修改命名空间的名称</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.WebApi.Filters</span> <span class="comment">// 这里修改成了Cms.WebApi</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UnitOfWorkFilter</span> : <span class="title">IAsyncActionFilter</span></span><br><span class="line">    &#123;</span><br></pre></td></tr></table></figure>

<p>下面修改<code>AutofaceDI</code>文件夹中<code>AutofacModuleRegister</code>类的命名空间</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.WebApi.AutofaceDI</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AutofacModuleRegister</span>:<span class="title">Autofac.Module</span></span><br><span class="line">    &#123;</span><br></pre></td></tr></table></figure>

<p><code>Attributes</code>目录下的类<code>UnitOfWorkAttribute.cs</code>的命名空间</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.WebApi.Attributes</span></span><br><span class="line">&#123;</span><br></pre></td></tr></table></figure>

<p>同时<code>Cms.WebApi</code>这个<code>WebApi</code>项目需要引入其他的类库项目</p>
<p>同时还需要包含如下项目的引用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;PackageReference Include=&quot;Microsoft.EntityFrameworkCore.Design&quot; Version=&quot;7.0.4&quot;&gt;</span><br><span class="line">		  &lt;PrivateAssets&gt;all&lt;/PrivateAssets&gt;</span><br><span class="line">		  &lt;IncludeAssets&gt;runtime; build; native; contentfiles; analyzers; buildtransitive&lt;/IncludeAssets&gt;</span><br><span class="line">	  &lt;/PackageReference&gt;</span><br><span class="line">	  &lt;PackageReference Include=&quot;Autofac&quot; Version=&quot;7.0.0&quot; /&gt;</span><br><span class="line">	  &lt;PackageReference Include=&quot;Autofac.Extensions.DependencyInjection&quot; Version=&quot;8.0.0&quot; /&gt;</span><br></pre></td></tr></table></figure>

<p>下面在<code>Program.cs</code>文件中进行注入的操作：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">builder.Services.AddControllers();</span><br><span class="line"></span><br><span class="line"><span class="comment">//注入DbContext,同时获取数据库链接字符串</span></span><br><span class="line">builder.Services.AddDbContext&lt;MyDbContext&gt;(opt =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">string</span> connStr = builder.Configuration.GetConnectionString(<span class="string">&quot;StrConn&quot;</span>)!;</span><br><span class="line">    opt.UseSqlServer(connStr);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 完成Filter的注册</span></span><br><span class="line">builder.Services.Configure&lt;MvcOptions&gt;(c =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    c.Filters.Add&lt;UnitOfWorkFilter&gt;();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 完成Autofac的创建</span></span><br><span class="line">builder.Host.UseServiceProviderFactory(<span class="keyword">new</span> AutofacServiceProviderFactory()).ConfigureContainer&lt;ContainerBuilder&gt;(builder =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    builder.RegisterModule(<span class="keyword">new</span> AutofacModuleRegister());</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>最后，还需要注意链接字符串，在<code>Cms.WebApi</code>项目的<code>appsettings.json</code>配置文件中不要忘记添加数据库链接字符串</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;Logging&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;LogLevel&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Default&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Information&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Microsoft.AspNetCore&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Warning&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;AllowedHosts&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;ConnectionStrings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;StrConn&quot;</span><span class="punctuation">:</span> <span class="string">&quot;server=localhost;database=CmsDb;uid=sa;pwd=123456;TrustServerCertificate=true&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>完成以上的配置修改以后创建控制器<code>UsersController.cs</code>,代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UsersController</span> : <span class="title">ControllerBase</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IUserInfoService _userInfoService;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">UsersController</span>(<span class="params">IUserInfoService _userInfoService</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>._userInfoService = _userInfoService;</span><br><span class="line">        &#125;</span><br><span class="line">        [<span class="meta">HttpGet</span>] <span class="comment">// api/v1/users  get</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> IActionResult <span class="title">GetAllUsers</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> users = _userInfoService.LoadEntities(c=&gt;<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">return</span> Ok(users);  <span class="comment">// 返回的状态码是200</span></span><br><span class="line">        &#125;</span><br><span class="line">    s</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>以上实现的就是返回所有用户信息的接口实现。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">HttpGet(<span class="string">&quot;&#123;id&#125;&quot;</span>)</span>]  /</span><br><span class="line">       <span class="function"><span class="keyword">public</span> IActionResult <span class="title">GetUser</span>(<span class="params"><span class="built_in">int</span> id</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">var</span> user = _userInfoService.LoadEntities(u=&gt;u.Id==id).FirstOrDefault;</span><br><span class="line">           <span class="keyword">return</span> Ok(user);</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<h2 id="8、返回正确的状态码"><a href="#8、返回正确的状态码" class="headerlink" title="8、返回正确的状态码"></a>8、返回正确的状态码</h2><p>在访问<code>GetUser</code>方法的时候，传递过滤的用户编号是不存在的应该怎样进行处理呢？</p>
<p>可以测试一下，输入一个不存在的用户编号，发现返回的状态码还是200，但是这种情况下返回的状态码应该是404.</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">HttpGet(<span class="string">&quot;&#123;id&#125;&quot;</span>)</span>]</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">GetUser</span>(<span class="params"><span class="built_in">int</span> id</span>)</span></span><br><span class="line">      &#123;</span><br><span class="line">          <span class="keyword">var</span> user = <span class="keyword">await</span> _userInfoService.LoadEntities(u=&gt;u.Id==id).FirstOrDefaultAsync();</span><br><span class="line">          <span class="keyword">if</span>(user == <span class="literal">null</span>)</span><br><span class="line">          &#123;</span><br><span class="line">              <span class="keyword">return</span> NotFound(<span class="string">$&quot;编号为<span class="subst">&#123;id&#125;</span>的用户不存在!!&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> Ok(user);</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>同理修改一下<code>GetAllUsers</code>这个方法，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">HttpGet</span>]</span><br><span class="line">     <span class="function"><span class="keyword">public</span> IActionResult <span class="title">GetAllUsers</span>()</span></span><br><span class="line">     &#123;</span><br><span class="line">         <span class="keyword">var</span> users = _userInfoService.LoadEntities(c =&gt; <span class="literal">true</span>);</span><br><span class="line">         <span class="keyword">if</span>(users==<span class="literal">null</span> || users.Count() == <span class="number">0</span>)</span><br><span class="line">         &#123;</span><br><span class="line">             <span class="keyword">return</span> NotFound(<span class="string">&quot;用户信息不存在!!&quot;</span>);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">return</span> Ok(users);</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>

<p>也可以在<code>Apifox</code>中进行测试</p>
<h2 id="9、数据传输对象DTO（-Data-Transfer-Object-）"><a href="#9、数据传输对象DTO（-Data-Transfer-Object-）" class="headerlink" title="9、数据传输对象DTO（(Data Transfer Object)）"></a>9、数据传输对象<code>DTO</code>（(Data Transfer Object)）</h2><p>关于数据传输对象我们前面也已经讲过。</p>
<p>如果我们直接将数据实体模型<code>Model</code>返回到前端，一般会有如下两个问题</p>
<p>第一个问题：直接项前端返回实体模型，会暴露系统的业务核心。</p>
<p>第二个问题：返回的颗粒度太粗，也就是返回到前端的数据无法精细的调整</p>
<p>例如，有一个电商系统。</p>
<p>该系统针对商品有两个价格，一个是内部的员工价格，另外一个是市场价格</p>
<p>公司的内网使用的是员工价格，外网使用的是市场价格</p>
<p>问题是：产品的数据模型只有一个，难道要因为区别不同的价格而拆分模型吗？</p>
<p>这样就会很麻烦，而我们这里只是要求根据不同的场景对外传递不同数据对象，而这个向外传递数据的对象就是<code>DTO</code>.</p>
<p>简单的理解就是<code>DTO</code>是面向界面的，而<code>Model</code>是根据业务来进行设计的，所以它是面向业务的。</p>
<p>例如：前面我们所设计的<code>UserInfo</code>这个实体数据模型，里面包含了关于用户很多的信息，但是如果在页面上只需要展示用户的用户名，这时候就需要用到<code>DTO</code>.</p>
<p>所以说，使用<code>DTO</code>完全可以解决上面我们提到的两个问题。</p>
<p>第一：使用<code>DTO</code>的时候可以屏蔽我们不希望对外暴露的核心业务</p>
<p>第二：通过不同<code>DTO</code>的组合，又可以调整输出数据的结果，从而解决颗粒度太粗的问题。</p>
<h2 id="10、分离Model与DTO"><a href="#10、分离Model与DTO" class="headerlink" title="10、分离Model与DTO"></a>10、分离<code>Model</code>与<code>DTO</code></h2><p>在<code>Cms.WebApi</code>项目中添加一个<code>Dtos</code>文件夹，在该文件夹中创建<code>UserInfoDTO.cs</code>这个类，该类中的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserInfoDto</span></span><br><span class="line">  &#123;</span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> 主键id</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="keyword">public</span> <span class="built_in">long</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span>  添加数据时间</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="keyword">public</span> <span class="built_in">string</span>  CreateTime &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; <span class="comment"><span class="doctag">///</span>/ 注意：这里的类型与UserInfo这个Model实体类中的CreateTime的类型是不一样的，所以需要单独的进行映射投影操作。</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> 更新数据时间</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="keyword">public</span> DateTime UpdateTime &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">public</span> <span class="built_in">string</span>? UserName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> 邮箱</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="keyword">public</span> <span class="built_in">string</span>? UserEmail &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> 电话</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="keyword">public</span> <span class="built_in">string</span>? UserPhone &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; </span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> 区号</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="keyword">public</span> <span class="built_in">string</span>? AreaCode &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> 性别：0表示男，1表示女</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="keyword">public</span> <span class="built_in">int</span> Gender &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> 用户头像，存储头像路径</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="keyword">public</span> <span class="built_in">string</span>? PhotoUrl &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>这里对比<code>Models</code>中的<code>UserInfo.cs</code>中发现缺少了<code>Password</code>，也就是说前端展示的时候不需要展示密码。</p>
<p>上面的<code>UserInfoDto.cs</code>中定义的属性类型也可以根据前端页面实际展示情况进行调整，例如：前端展示的用户添加日期为<code>xxxx年xx月xx日</code>形式，这里就可以将<code>CreateTime</code>修改成<code>string</code>类型。</p>
<p>下面可以通过前面我们所学习的<code>AutoMapper</code>实现<code>数据模型</code>与<code>DTO</code>之间的映射。</p>
<p>在<code>Cms.WebApi</code>项目中安装如下包</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Install-Package AutoMapper.Extensions.Microsoft.DependencyInjection</span><br></pre></td></tr></table></figure>

<p>下面配置映射关系</p>
<p>在<code>Cms.WebApi</code>这个项目中再创建一个<code>Profiles</code>文件夹，在该文件夹中创建<code>UserInfoProfile.cs</code> 类，该类中的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserInfoProfile</span>:<span class="title">Profile</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">UserInfoProfile</span>()</span> &#123;</span><br><span class="line">            CreateMap&lt;UserInfo, UserInfoDto&gt;()                .ForMember(dest=&gt;dest.CreateTime,opt=&gt;opt.MapFrom(src=&gt;src.CreateTime.Year+<span class="string">&quot;年&quot;</span>+src.CreateTime.Month+<span class="string">&quot;月&quot;</span>+src.CreateTime.Day+<span class="string">&quot;日&quot;</span>));</span><br><span class="line">           </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里是将<code>UserInfo</code>这个数据模型映射成<code>UserInfoDto</code>，如果两个类中的属性名字，类型是一样的，会自动进行映射。</p>
<p>但是这里的<code>UserInfoDto</code>中的<code>CreateTime</code>的类型是字符串类型，与<code>UserInfo</code>这个实体类中的<code>CreateTime</code>的类型是不一样的，所以这里需要借助于<code>ForMember</code>函数进行单独的配置映射。将<code>UserInfo</code>这个实体类中的<code>CreateTime</code>属性映射成<code>UserInfoDto</code>中的<code>CreateTime</code>属性，这时候该属性的值就变成了<code>xxxx年xx月xx日</code>的形式。</p>
<p>下面将<code>AutoMapper</code>添加到容器中</p>
<p>修改<code>Program.cs</code>文件中的代码</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">builder.Services.AddAutoMapper(<span class="keyword">typeof</span>(UserInfoProfile)); <span class="comment">// 将AutoMapper添加到容器中</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Learn more about configuring Swagger/OpenAPI at https://aka.ms/aspnetcore/swashbuckle</span></span><br><span class="line">builder.Services.AddEndpointsApiExplorer();</span><br></pre></td></tr></table></figure>

<p>当然，这里也可以修改成如下的形式：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">builder.Services.AddAutoMapper(AppDomain.CurrentDomain.GetAssemblies());</span><br></pre></td></tr></table></figure>

<p><code>AppDomain</code>: 应用程序域，表示的是一组程序集的逻辑容器。<code>AppDomain.CurrentDomain.GetAssemblies()</code>获取到当前应用程序域下的所有的程序集。综合的起来就是获取当前应用程序集下的所有继承了<code>Profile</code>的类。</p>
<p>返回到<code>UsersController</code>控制器中进行代码的修改：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UsersController</span> : <span class="title">ControllerBase</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">readonly</span> IUserInfoService _userInfoService;</span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">readonly</span> IMapper mapper; </span><br><span class="line">    <span class="comment">// 这里完成了mapper的注入操作</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="title">UsersController</span>(<span class="params">IUserInfoService _userInfoService,IMapper mapper</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">this</span>._userInfoService = _userInfoService;</span><br><span class="line">           <span class="keyword">this</span>.mapper = mapper;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">HttpGet(<span class="string">&quot;&#123;id&#125;&quot;</span>)</span>]</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">GetUser</span>(<span class="params"><span class="built_in">int</span> id</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="comment">// 可以进行测试</span></span><br><span class="line">          <span class="comment">// Console.WriteLine(&quot;AppDomain==&quot;+ AppDomain.CurrentDomain);//Cms.WebApi,当前的程序集</span></span><br><span class="line">         <span class="comment">/* foreach(var assembly in AppDomain.CurrentDomain.GetAssemblies())</span></span><br><span class="line"><span class="comment">           &#123;</span></span><br><span class="line"><span class="comment">               Console.WriteLine(assembly.FullName); // 打印的是当前Cms.WebApi所引用的所有程序集</span></span><br><span class="line"><span class="comment">           &#125;*/</span></span><br><span class="line">           <span class="keyword">var</span> user = <span class="keyword">await</span> _userInfoService.LoadEntities(u=&gt;u.Id==id).FirstOrDefaultAsync();</span><br><span class="line">           <span class="keyword">var</span> userDTO = mapper.Map&lt;UserInfoDto&gt;(user);</span><br><span class="line">           <span class="keyword">if</span>(user == <span class="literal">null</span>)</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">return</span> NotFound(<span class="string">$&quot;编号为<span class="subst">&#123;id&#125;</span>的用户不存在!!&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> Ok(userDTO);</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>在上面的代码中，当我们获取到了数据以后，调用<code>Map</code>方法，将获取到的数据都映射到了<code>UserInfoDto</code>对象的属性中。</p>
<p>进行测试，返回的数据如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;id&quot;</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="string">&quot;createTime&quot;</span>: <span class="string">&quot;2012年12月1日&quot;</span>, <span class="comment">// 这里的日期发生了变化。</span></span><br><span class="line">  <span class="string">&quot;updateTime&quot;</span>: <span class="string">&quot;2012-12-03T00:00:00&quot;</span>,</span><br><span class="line">  <span class="string">&quot;userName&quot;</span>: <span class="string">&quot;张三&quot;</span>,</span><br><span class="line">  <span class="string">&quot;userEmail&quot;</span>: <span class="string">&quot;zhangsan@126.com&quot;</span>,</span><br><span class="line">  <span class="string">&quot;userPhone&quot;</span>: <span class="string">&quot;12345678901&quot;</span>,</span><br><span class="line">  <span class="string">&quot;gender&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="string">&quot;photoUrl&quot;</span>: <span class="string">&quot;/images/f.jpg&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面我们又修改了<code>GetAllUsers</code>方法</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">HttpGet</span>]</span><br><span class="line">      <span class="function"><span class="keyword">public</span> IActionResult <span class="title">GetAllUsers</span>()</span></span><br><span class="line">      &#123;</span><br><span class="line">          <span class="keyword">var</span> users = _userInfoService.LoadEntities(c =&gt; <span class="literal">true</span>);</span><br><span class="line">          <span class="comment">// 这里有映射成了List集合</span></span><br><span class="line">          <span class="keyword">var</span> usersDto = mapper.Map&lt;List&lt;UserInfoDto&gt;&gt;(users);</span><br><span class="line">          <span class="comment">// 判断的是usersDto</span></span><br><span class="line">          <span class="keyword">if</span>(usersDto == <span class="literal">null</span> || usersDto.Count() == <span class="number">0</span>)</span><br><span class="line">          &#123;</span><br><span class="line">              <span class="keyword">return</span> NotFound(<span class="string">&quot;用户信息不存在!!&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">              <span class="comment">// 这里返回的是usersDto</span></span><br><span class="line">              <span class="keyword">return</span> Ok(usersDto);</span><br><span class="line">          &#125;</span><br><span class="line">         </span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>启动项目进行测试，发现数据中的<code>createTime</code>的值都发生了变化，改成了我们想要的格式。</p>
<h2 id="11、获取文章信息"><a href="#11、获取文章信息" class="headerlink" title="11、获取文章信息"></a>11、获取文章信息</h2><h3 id="11-1-配置一对多关系"><a href="#11-1-配置一对多关系" class="headerlink" title="11.1 配置一对多关系"></a>11.1 配置一对多关系</h3><p>定义文章的数据模型，这里为了简单，定义的文章实体模型如下所示，在<code>Cms.Entity</code>中创建<code>Articel.cs</code></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Articel</span>:<span class="title">BaseEntity</span>&lt;<span class="title">long</span>&gt;</span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">string</span>? Title &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">string</span>? Content &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment">// 表示一篇文章只能属于一个用户</span></span><br><span class="line">       <span class="keyword">public</span> UserInfo? UserInfo &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>定义<code>ArticelConfig.cs</code>配置类，代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ArticelConfig</span> : <span class="title">IEntityTypeConfiguration</span>&lt;<span class="title">Articel</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">EntityTypeBuilder&lt;Articel&gt; builder</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            builder.ToTable(<span class="string">&quot;T_Articels&quot;</span>);</span><br><span class="line">            builder.Property(x =&gt; x.Title).HasMaxLength(<span class="number">100</span>).IsRequired();</span><br><span class="line">            builder.Property(x =&gt; x.Content).IsRequired();</span><br><span class="line">            <span class="comment">// 配置一对多的关系</span></span><br><span class="line">            builder.HasOne(c=&gt;c.UserInfo).WithMany(a=&gt;a.Articels).IsRequired();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>修改<code>UserInfo.cs</code>这个实体类，代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">string</span>? PhotoUrl &#123; <span class="keyword">get</span>; <span class="keyword">set</span>;&#125;</span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> 一个用户可以发布多篇文章</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">     <span class="keyword">public</span> List&lt;Articel&gt; Articels &#123; <span class="keyword">get</span>; <span class="keyword">set</span>;&#125;=<span class="keyword">new</span> List&lt;Articel&gt;();</span><br></pre></td></tr></table></figure>

<p>修改<code>Cms.EntityFrameworkCore</code>项目中的<code>MyDbContext.cs</code>数据上下文类，这里需要增加<code>DbSet</code></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyDbContext</span>:<span class="title">DbContext</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> DbSet&lt;UserInfo&gt;UserInfos &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> DbSet&lt;Articel&gt; Articels &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br></pre></td></tr></table></figure>

<p>同时还需要修改<code>MyDbContextDesign.cs</code>这个类，我们这里换了数据库</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> MyDbContext <span class="title">CreateDbContext</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">           DbContextOptionsBuilder builder = <span class="keyword">new</span> DbContextOptionsBuilder&lt;MyDbContext&gt;();</span><br><span class="line">            <span class="built_in">string</span> connStr = <span class="string">&quot;server=localhost;database=APIDemo;uid=sa;pwd=123456;TrustServerCertificate=true&quot;</span>;</span><br><span class="line">            builder.UseSqlServer(connStr);</span><br></pre></td></tr></table></figure>

<p>这里我们更换了一个新的数据库<code>APIDemo</code>,当然这里我们可以先在<code>SQLServer</code>中创建<code>APIDemo</code>这个数据库。</p>
<p>当然，<code>Cms.WebApi</code>项目中的配置文件<code>appsettings.json</code>也需要修改一下数据库链接字符串。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;ConnectionStrings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;StrConn&quot;</span>: <span class="string">&quot;server=localhost;database=APIDemo;uid=sa;pwd=123456;TrustServerCertificate=true&quot;</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>链接到的数据库也是<code>APIDemo</code></p>
<p>下面生成数据迁移</p>
<p>在<code>[程序包管理器控制台]</code>中选择<code>Cms.EntityFrameworkCore</code>,执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Add-Migration createArticel</span><br><span class="line">Update-database</span><br></pre></td></tr></table></figure>

<p>下面在数据库中添加测试数据。</p>
<p>下面再创建数据仓储</p>
<p>创建<code>IArticelRepository.cs</code></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.IRepository</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IArticelRepository</span>:<span class="title">IBaseRepository</span>&lt;<span class="title">Articel</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>创建<code>ArticelRepository.cs</code></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.Repository</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ArticelRepository</span>:<span class="title">BaseRepository</span>&lt;<span class="title">Articel</span>&gt;,<span class="title">IArticelRepository</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ArticelRepository</span>(<span class="params">MyDbContext context</span>) : <span class="title">base</span>(<span class="params">context</span>)</span> &#123; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>下面创建服务</p>
<p><code>IArticelService.cs</code></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.IService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IArticelService</span>:<span class="title">IBaseService</span>&lt;<span class="title">Articel</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建<code>ArticelService.cs</code></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.Service</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ArticelService</span>:<span class="title">BaseService</span>&lt;<span class="title">Articel</span>&gt;,<span class="title">IArticelService</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IArticelRepository articelRepository;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ArticelService</span>(<span class="params">IArticelRepository articelRepository</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">base</span>.repository = articelRepository;</span><br><span class="line">            <span class="keyword">this</span>.articelRepository = articelRepository;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="11-2-实现信息的查询"><a href="#11-2-实现信息的查询" class="headerlink" title="11.2   实现信息的查询"></a>11.2   实现信息的查询</h3><p>在<code>Cms.WebApi</code>项目中的<code>Dtos</code>文件夹下面创建<code>ArticelDto.cs</code>类</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ArticelDto</span></span><br><span class="line">  &#123;</span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> 主键id</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="keyword">public</span> <span class="built_in">long</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span>  添加数据时间</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="keyword">public</span> DateTime CreateTime &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> 更新数据时间</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="keyword">public</span> DateTime UpdateTime &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">public</span> <span class="built_in">string</span>? Title &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">      <span class="keyword">public</span> <span class="built_in">string</span>? Content &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>在<code>Profiles</code>文件夹下面创建<code>ArticelProfile.cs</code>类，代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.WebApi.Profiles</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ArticelProfile</span>:<span class="title">Profile</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ArticelProfile</span>()</span> &#123; </span><br><span class="line">            CreateMap&lt;Articel,ArticelDto&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>UsersController.cs</code>控制器中添加如下代码</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 获取某个用户发布的文章</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;userId&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span>  api/v1/users/1/articels</span></span><br><span class="line">       [<span class="meta">HttpGet(<span class="string">&quot;&#123;userId&#125;/articels&quot;</span>)</span>] <span class="comment">// 这里的userId与参数userId名字一样</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">GetArticelForUser</span>(<span class="params"><span class="built_in">int</span> userId</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">var</span> userInfo = <span class="keyword">await</span> _userInfoService.LoadEntities(u =&gt; u.Id == userId).FirstOrDefaultAsync();</span><br><span class="line">           <span class="keyword">if</span> (userInfo == <span class="literal">null</span>)</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">return</span> NotFound(<span class="string">&quot;用户不存在&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">var</span> articels = _articelService.LoadEntities(a =&gt; a.UserInfo == userInfo).ToList();</span><br><span class="line">           <span class="keyword">if</span> (articels.Count() &lt;= <span class="number">0</span>)</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">return</span> NotFound(<span class="string">&quot;文章不存在&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> Ok(mapper.Map&lt;List&lt;ArticelDto&gt;&gt;(articels));</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>当然，在<code>UsersController.cs</code>中需要注入文章服务。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UsersController</span> : <span class="title">ControllerBase</span></span><br><span class="line">  &#123;</span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">readonly</span> IUserInfoService _userInfoService;</span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">readonly</span> IArticelService _articelService;</span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">readonly</span> IMapper mapper;</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="title">UsersController</span>(<span class="params">IUserInfoService _userInfoService,IMapper mapper, IArticelService _articelService</span>)</span></span><br><span class="line">      &#123;</span><br><span class="line">          <span class="keyword">this</span>._userInfoService = _userInfoService;</span><br><span class="line">          <span class="keyword">this</span>.mapper = mapper;</span><br><span class="line">          <span class="comment">// 注入文章服务</span></span><br><span class="line">          <span class="keyword">this</span>._articelService = _articelService;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>



<h2 id="12、加载所有用户以及用户发布的文章"><a href="#12、加载所有用户以及用户发布的文章" class="headerlink" title="12、加载所有用户以及用户发布的文章"></a>12、加载所有用户以及用户发布的文章</h2><p>这里，我们希望，当获取用户信息的时候，顺便把用户发布的文章也给查询出来。</p>
<p>我们知道，在<code>Cms.Entity</code>中的<code>UserInfo.cs</code>这个实体类中，定义了如下内容：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> 一个用户可以发布多篇文章</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">     <span class="keyword">public</span> List&lt;Articel&gt; Articels &#123; <span class="keyword">get</span>; <span class="keyword">set</span>;&#125;=<span class="keyword">new</span> List&lt;Articel&gt;();</span><br></pre></td></tr></table></figure>

<p>表示的是一个用户发布的多篇文章。</p>
<p>当然，在<code>UserInfoDto.cs</code>中也可以进行表示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? PhotoUrl &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">//  注意这里的属性名字Articels必须与上面`UserInfo.cs`实体类中的Articels属性名字保持一致</span></span><br><span class="line"><span class="comment">// 只不过这里返回的List中的内容类型是ArticelDto</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> List&lt;ArticelDto&gt;? Articels &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br></pre></td></tr></table></figure>

<p>下面在<code>UsersController.cs</code>控制器中添加如下的代码：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">HttpGet(<span class="string">&quot;articels&quot;</span>)</span>]  <span class="comment">// api/v1/users/articels</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> IActionResult <span class="title">GetUsersAndArticels</span>()</span></span><br><span class="line">      &#123;</span><br><span class="line">       <span class="comment">// 使用了Include，在查询用户的时候，关联对应的文章，也就是查询用户的同时，把用户发布的文章也查询出来。</span></span><br><span class="line">          <span class="keyword">var</span> users = _userInfoService.LoadEntities(c =&gt; <span class="literal">true</span>).Include(c=&gt;c.Articels);</span><br><span class="line"><span class="comment">// 映射到List&lt;UserInfoDto&gt;</span></span><br><span class="line">          <span class="keyword">var</span> usersDto = mapper.Map&lt;List&lt;UserInfoDto&gt;&gt;(users);</span><br><span class="line">          <span class="keyword">if</span> (usersDto == <span class="literal">null</span> || usersDto.Count() == <span class="number">0</span>)</span><br><span class="line">          &#123;</span><br><span class="line">              <span class="keyword">return</span> NotFound(<span class="string">&quot;用户信息不存在!!&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">              <span class="keyword">return</span> Ok(usersDto);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>启动程序进行测试。</p>
<h2 id="13、文章搜索"><a href="#13、文章搜索" class="headerlink" title="13、文章搜索"></a>13、文章搜索</h2><p>修改<code>ArticelsController</code>这个控制器中的代码，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.WebApi.Controllers</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">Route(<span class="string">&quot;api/[controller]&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">ApiController</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ArticelsController</span> : <span class="title">ControllerBase</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IArticelService _articelService;</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IMapper mapper;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ArticelsController</span>(<span class="params">IArticelService articelService, IMapper mapper</span>)</span> &#123;</span><br><span class="line">           <span class="keyword">this</span>.mapper = mapper;</span><br><span class="line">            <span class="comment">// 完成了注入的操作</span></span><br><span class="line">            <span class="keyword">this</span>._articelService = articelService;           </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//这是要求搜索的url地址：  api/articels?keyword=传入的参数</span></span><br><span class="line">        [<span class="meta">HttpGet</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span>  IActionResult <span class="title">GetArticel</span>(<span class="params">[FromQuery]<span class="built_in">string</span> keyword</span>) <span class="comment">// 通过FromQuery来接收参数keyword</span></span></span><br><span class="line">        &#123;</span><br><span class="line">           <span class="keyword">var</span> articels = _articelService.LoadEntities(a=&gt;a.Title!.Contains(keyword)); <span class="comment">// 针对文章标题进行搜索</span></span><br><span class="line">            <span class="keyword">if</span> (articels.Count() &lt;= <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> NotFound(<span class="string">&quot;没有找到文章&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> articelList = mapper.Map&lt;List&lt;ArticelDto&gt;&gt;(articels);</span><br><span class="line">            <span class="keyword">return</span> Ok(articelList);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上实现了一个基本的搜索。</p>
<p>如果是多条件搜索，可以继续在<code>url</code>地址中添加搜索的条件。</p>
<p>下面我们来修改上面的代码实现多条件搜索。</p>
<p>在<code>Cms.Entity</code>这个类库项目中创建<code>Search</code>目录，在该目录中创建<code>ArticelSeach.cs</code>这个类，该类中的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ArticelSearch</span>:<span class="title">BaseSearch</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">string</span>? title &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">string</span>? FormDatepicker &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">string</span>? ToDatepicker &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>同时在<code>Seach</code>目录中创建<code>BaseSearch.cs</code>这个类，该类中的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BaseSearch</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">int</span> PageIndex &#123; <span class="keyword">get</span>;<span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">int</span> PageSize &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">int</span> TotalCount &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">bool</span> Order &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>修改<code>IArticelService.cs</code>这个文章服务类中的代码，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IArticelService</span>:<span class="title">IBaseService</span>&lt;<span class="title">Articel</span>&gt;</span><br><span class="line">   &#123;</span><br><span class="line">       <span class="function">IQueryable&lt;Articel&gt; <span class="title">LoadSearchEntities</span>(<span class="params">ArticelSearch articelSearch,<span class="built_in">bool</span> delFlag</span>)</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>这里增加了一个<code>LoadSearchEntities</code>接口。</p>
<p>下面在<code>ArticelService.cs</code>类中实现上面的接口，代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ArticelService</span>:<span class="title">BaseService</span>&lt;<span class="title">Articel</span>&gt;,<span class="title">IArticelService</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">readonly</span> IArticelRepository articelRepository;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="title">ArticelService</span>(<span class="params">IArticelRepository articelRepository</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">base</span>.repository = articelRepository;</span><br><span class="line">           <span class="keyword">this</span>.articelRepository = articelRepository;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> IQueryable&lt;Articel&gt; <span class="title">LoadSearchEntities</span>(<span class="params">ArticelSearch articelSearch, <span class="built_in">bool</span> delFlag</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">var</span> temp = articelRepository.LoadEntities(a=&gt;a.DelFlag==delFlag);</span><br><span class="line">           <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrWhiteSpace(articelSearch.title))</span><br><span class="line">           &#123;</span><br><span class="line">               temp = temp.Where(a=&gt;a.Title!.Contains(articelSearch.title));</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">// 开始时间与结束时间必须都完整</span></span><br><span class="line">           <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrWhiteSpace(articelSearch.FormDatepicker)&amp;&amp;!<span class="built_in">string</span>.IsNullOrWhiteSpace(articelSearch.ToDatepicker))</span><br><span class="line">           &#123;</span><br><span class="line">               DateTime startDateTime = Convert.ToDateTime(articelSearch.FormDatepicker);</span><br><span class="line">               DateTime endDateTime = Convert.ToDateTime(articelSearch.ToDatepicker);</span><br><span class="line">               temp = temp.Where(a=&gt;a.CreateTime&gt;=startDateTime &amp;&amp;a.CreateTime&lt;=endDateTime);</span><br><span class="line">           &#125;</span><br><span class="line">           articelSearch.TotalCount = temp.Count(); <span class="comment">// 统计总的记录数</span></span><br><span class="line">           <span class="comment">// 判断是升序还是降序</span></span><br><span class="line">           <span class="keyword">if</span>(articelSearch.Order)</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">return</span> temp.OrderBy&lt;Articel, <span class="built_in">long</span>&gt;(a =&gt; a.Id).Skip&lt;Articel&gt;((articelSearch.PageIndex - <span class="number">1</span>) * articelSearch.PageSize).Take&lt;Articel&gt;(articelSearch.PageSize);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">else</span></span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">return</span> temp.OrderByDescending&lt;Articel, <span class="built_in">long</span>&gt;(a =&gt; a.Id).Skip&lt;Articel&gt;((articelSearch.PageIndex - <span class="number">1</span>) * articelSearch.PageSize).Take&lt;Articel&gt;(articelSearch.PageSize);</span><br><span class="line">           &#125;</span><br><span class="line">         </span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>修改控制器<code>ArticelsController</code>中的代码，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// api/articels?keyword=传入的参数</span></span><br><span class="line">        [<span class="meta">HttpGet</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span>  IActionResult <span class="title">GetArticel</span>(<span class="params">[FromQuery]ArticelSearch articelSearch</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// var articels = _articelService.LoadEntities(a=&gt;a.Title!.Contains(keyword));</span></span><br><span class="line">            articelSearch.PageSize = <span class="number">5</span>;</span><br><span class="line">            articelSearch.PageIndex = <span class="number">1</span>;</span><br><span class="line">            <span class="built_in">int</span> totalCount = <span class="number">0</span>;</span><br><span class="line">            articelSearch.TotalCount = totalCount;</span><br><span class="line">            <span class="keyword">var</span> articels = _articelService.LoadSearchEntities(articelSearch,Convert.ToBoolean(DelFlagEnum.Normal));</span><br><span class="line">            <span class="keyword">if</span> ( articelSearch.TotalCount &lt;= <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> NotFound(<span class="string">&quot;没有找到文章&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> articelList = mapper.Map&lt;List&lt;ArticelDto&gt;&gt;(articels);</span><br><span class="line">            <span class="keyword">return</span> Ok(articelList);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>在上面的代码中，我们用<code>ArticelSearch</code>接收前端发送过滤的搜索条件的数据</p>
<p>当然，这里关于分页的内容，我们暂时先不考虑，所以将<code>pageSize,pageIndex</code>属性的值先固定具体的值。</p>
<p>启动项目进行测试。</p>
<p>通过测试页面，我们发现这里也需要前端发送<code>TotalCount</code>，这是不合理的，因为<code>TotalCount</code>表示的是满足条件的总的记录数，是有服务端对数据进行过滤后统计出来的，并不是有前端发送过来的。而<code>PageIndex,PageSize</code>是有前端发送过来的。</p>
<p>所以说这里，我们通过<code>ArticelSearch</code>这个类型作为<code>GetArticel</code>方法接收前端发送过来的搜索内容的类型是不合适的。</p>
<p>所以这里还需要进一步处理。</p>
<p>在<code>Cms.WebApi</code>这个项目中创建文件夹<code>ResourceParams</code>文件夹，该文件中创建<code>ArticelParams.cs</code>这个类，该类中的代码，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ArticelParams</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">string</span>? title &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">string</span>? FormDatepicker &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">string</span>? ToDatepicker &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">int</span> PageIndex &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">int</span> PageSize &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">bool</span> Order &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>目前我们暂时不考虑分页，只考虑多条件搜索的情况。</p>
<p>下面在修改控制器中的代码，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// api/articels?keyword=传入的参数</span></span><br><span class="line">     [<span class="meta">HttpGet</span>]</span><br><span class="line">     <span class="function"><span class="keyword">public</span>  IActionResult <span class="title">GetArticel</span>(<span class="params">[FromQuery] ArticelParams articelParams</span>) <span class="comment">// 这里接收到的参数的类型是ArticelParams</span></span></span><br><span class="line">     &#123;</span><br><span class="line">         articelParams.PageIndex = <span class="number">1</span>; <span class="comment">// 这里暂时不考虑分页的实现，所以先将数据固定</span></span><br><span class="line">         articelParams.PageSize = <span class="number">10</span>;</span><br><span class="line">         <span class="comment">// var articels = _articelService.LoadEntities(a=&gt;a.Title!.Contains(keyword));</span></span><br><span class="line">         <span class="built_in">int</span> totalCount = <span class="number">0</span>;</span><br><span class="line">         <span class="comment">// 把articelParams中接收到的前端传递过来的数据重新赋值给ArticelSearch对象。因为在业务层使用该对象进行的搜索功能柜的实现。</span></span><br><span class="line">         ArticelSearch articelSearch = <span class="keyword">new</span> ArticelSearch()</span><br><span class="line">         &#123;</span><br><span class="line">             title = articelParams.title,</span><br><span class="line">             FormDatepicker = articelParams.FormDatepicker,</span><br><span class="line">             ToDatepicker = articelParams.ToDatepicker,</span><br><span class="line">             PageSize = articelParams.PageSize,</span><br><span class="line">             PageIndex = articelParams.PageIndex,</span><br><span class="line">             Order = articelParams.Order,</span><br><span class="line">             TotalCount = totalCount</span><br><span class="line">         &#125;;</span><br><span class="line">     <span class="comment">// 传递到业务层中的代码还是ArticelSearch这个对象</span></span><br><span class="line">         <span class="keyword">var</span> articels = _articelService.LoadSearchEntities(articelSearch,Convert.ToBoolean(DelFlagEnum.Normal));</span><br><span class="line">         <span class="comment">// 这里可以对articelSearch.TotalCount进行判断。</span></span><br><span class="line">         <span class="keyword">if</span> (articelSearch.TotalCount &lt;= <span class="number">0</span>)</span><br><span class="line">         &#123;</span><br><span class="line">             <span class="keyword">return</span> NotFound(<span class="string">&quot;没有找到文章&quot;</span>);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">var</span> articelList = mapper.Map&lt;List&lt;ArticelDto&gt;&gt;(articels);</span><br><span class="line">         <span class="keyword">return</span> Ok(articelList);</span><br><span class="line"></span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>

<p>启动项目进行测试。</p>
<p>通过测试，我们发现数据都是通过<code>url</code>地址参数传递过来的。</p>
<h2 id="14、创建用户"><a href="#14、创建用户" class="headerlink" title="14、创建用户"></a>14、创建用户</h2><p>这里，我们主要学习的是<code>post</code>请求。</p>
<p>创建用户的时候，我们需要接收前端发送过来的数据，最终保存到数据库中。</p>
<p>这里我们接收到的数据还是要交给<code>DTO</code>对象，然后映射到数据模型中。</p>
<p>前面我们已经在<code>Dtos</code>目录中创建了<code>UserInfoDto.cs</code>，是否可以直接使用该对象呢？</p>
<p>不建议，前面创建的<code>UserInfoDto.cs</code>是负责输出的，也就是用来展示数据的。而现在我们创建的<code>Dto</code>对象是负责接收的，也就是输入的。因为，不同的操作对数据的要求是不同的，例如：在输入的时候，不需要<code>id</code>，同时还需要对数据进行校验（输出的数据是最终来自数据库，不需要对数据进行校验）。<code>Dto</code>对象针对的是前端的逻辑，不同的前端页面的逻辑是不一样的。这样职责更加的明确。</p>
<p>所以在<code>Dtos</code>文件夹中创建一个<code>UserInfoCreateDto.cs</code>类，作为输入用户信息的数据传输对象。</p>
<p>该类中的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserInfoCreateDto</span></span><br><span class="line">   &#123;</span><br><span class="line">      </span><br><span class="line"></span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">string</span>? UserName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 邮箱</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">string</span>? UserEmail &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 电话</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">string</span>? UserPhone &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 密码 //----------------------------------这里在添加用户的时候必须指定密码</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">string</span>? UserPassword &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 性别：0表示男，1表示女</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">int</span> Gender &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 用户头像，存储头像路径</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">string</span>? PhotoUrl &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>以上代码我们是从<code>UserInfoDto.cs</code>中直接拷贝过来的，但是这里缺少了<code>Id</code>属性，我们知道，在添加数据的时候，前端页面不需要传递<code>Id</code>，因为<code>Id</code>的值是有服务端在向数据库中插入数据的时候确定的。同时也没有添加<code>CreateTime</code>和<code>UpdateTime</code>（因为添加信息的时候，日期时间是不需要用户输入的，只需要获取当前系统的日期时间就可以了）</p>
<p>但是这里需要密码，所以上面添加了<code>UserPassword</code>这个属性。</p>
<p>同时这里我们少了<code>        public List&lt;ArticelDto&gt;? Articels &#123; get; set; &#125;</code></p>
<p>关于<code>Articels</code>这个集合的处理我们后面在进行讲解。</p>
<p>下面返回到控制器中，添加如下方法：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 创建用户</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">       [<span class="meta">HttpPost</span>]</span><br><span class="line">       <span class="function"><span class="keyword">public</span> IActionResult <span class="title">CreatUser</span>(<span class="params">[FromBody]UserInfoCreateDto userInfoCreateDto</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line"></span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>这里我们创建了<code>CreateUser</code>方法来完成用户信息的创建，这里是一个<code>Post</code>请求，接收前端页面发送过来的数据，需要使用到<code>[FromBody]</code>,然后数据都传递给了<code>UserInfoCreateDto</code>这个对象。</p>
<p>下面我们需要将<code>UserInfoCreateDto</code>这个<code>Dto</code>对象映射到<code>UserInfo</code>这个实体模型类。</p>
<p>修改<code>Profiles/UserInfoProfile.cs</code>文件的配置，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">UserInfoProfile</span>()</span> &#123;</span><br><span class="line">           CreateMap&lt;UserInfo, UserInfoDto&gt;()</span><br><span class="line">               .ForMember(dest=&gt;dest.CreateTime,opt=&gt;opt.MapFrom(src=&gt;src.CreateTime.Year+<span class="string">&quot;年&quot;</span>+src.CreateTime.Month+<span class="string">&quot;月&quot;</span>+src.CreateTime.Day+<span class="string">&quot;日&quot;</span>));</span><br><span class="line">    <span class="comment">// 这里将UserInfoCreateDto，映射到UserInfo</span></span><br><span class="line">    <span class="comment">// 由于UserInfoCreateDto中没有添加CreateTime与UpdateTime两个属性，所以将其映射给UserInfo的时候，这里只能将当前时间映射给UserInfo中的CreateTime和UpdateTime</span></span><br><span class="line">          CreateMap&lt;UserInfoCreateDto, UserInfo&gt;().ForMember(dest=&gt;dest.CreateTime,opt=&gt;opt.MapFrom(src=&gt;DateTime.Now)).ForMember(dest=&gt;dest.UpdateTime,opt=&gt;opt.MapFrom(src=&gt;DateTime.Now));</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>下面修改控制器<code>UsersController.cs</code>中的代码：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">     <span class="comment"><span class="doctag">///</span> 创建用户: http://localhost:5154/api/Users</span></span><br><span class="line">     <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">     <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">     [<span class="meta">HttpPost</span>]</span><br><span class="line">     [<span class="meta">UnitOfWork(new Type[</span>] &#123; <span class="keyword">typeof</span>(MyDbContext) &#125;)] <span class="comment">//注意，添加该Attribute才能把数据保存到数据库中。</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">CreatUser</span>(<span class="params">[FromBody]UserInfoCreateDto userInfoCreateDto</span>)</span></span><br><span class="line">     &#123;</span><br><span class="line">        <span class="comment">//这里是将userInfoCreateDto映射到UserInfo</span></span><br><span class="line">         <span class="keyword">var</span> userInfoModel = mapper.Map&lt;UserInfo&gt;(userInfoCreateDto);</span><br><span class="line">         <span class="comment">// 将userInfoModel添加到DbContext中</span></span><br><span class="line">         <span class="keyword">await</span> _userInfoService.InsertEntityAsync(userInfoModel);</span><br><span class="line">         <span class="comment">// 添加完成后，把userInfoModel映射成UserInfoDto中，方面前端页面展示</span></span><br><span class="line">         <span class="keyword">var</span> user = mapper.Map&lt;UserInfoDto&gt;(userInfoModel);</span><br><span class="line">         <span class="comment">// return CreatedAtRoute(&quot;GetUser&quot;,new &#123;id =user.Id &#125;,user); // 返回</span></span><br><span class="line">         <span class="comment">// 第一个参数：表示的是控制器中的方法</span></span><br><span class="line">         <span class="comment">// 第二个参数：表示的是添加用户成功后，将添加成功的用户信息返回</span></span><br><span class="line">         <span class="keyword">return</span> CreatedAtAction(<span class="string">&quot;GetAllUsers&quot;</span>, user);<span class="comment">// 返回的状态码是201，同时把添加成功的用户信息返回到前端，而且在返回的响应头中会有 location: http://localhost:5154/api/Users 这个信息，告诉前端，可以通过这个地址，访问所有用户的信息。</span></span><br><span class="line">         <span class="comment">// 以get请求上面的地址，访问的就是GetAllUsers这个方法</span></span><br><span class="line">        </span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>

<p>启动项目进行测试。</p>
<h2 id="15、用户发布文章"><a href="#15、用户发布文章" class="headerlink" title="15、用户发布文章"></a>15、用户发布文章</h2><p>在这一小节中，我们实现的是指定的某个用户发布文章的<code>api</code>接口</p>
<p>在<code>Dtos</code>目录下面创建<code>ArticelForCreateDto.cs</code>这个类，该类中的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ArticelForCreateDto</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? Title &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? Content &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>上面代码中，表示用户在发布文章的时候，只需要输入文章的标题和文章的内容就可以了。</p>
<p>下面需要进行配置，也就是将<code>ArticelForCreateDto</code>映射到<code>Articel</code>这个实体类中(但是在映射的时候，要注意的是<code>ArticelForCreateDto</code>这个数据传输对象中没有<code>CreateTime,UpdateTime,DelFlag</code>属性，需要再配置中进行指定，如下所示：)。</p>
<p>修改<code>Profiles</code>文件夹下的<code>ArticelProfile.cs</code>中的代码，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ArticelProfile</span>()</span> &#123; </span><br><span class="line">            CreateMap&lt;Articel,ArticelDto&gt;();</span><br><span class="line">    <span class="comment">// 这里将`ArticelForCreateDto`映射到Articel中。</span></span><br><span class="line">    <span class="comment">// 这里同样针对Articel这个模型类中的CreateTime和UpdateTime属性赋值为当前时间</span></span><br><span class="line">    <span class="comment">// 对Articel中的DelFlag属性默认值为true</span></span><br><span class="line">            CreateMap&lt;ArticelForCreateDto, Articel&gt;().ForMember(dest =&gt; dest.CreateTime, opt =&gt; opt.MapFrom(src =&gt; DateTime.Now)).ForMember(dest =&gt; dest.UpdateTime, opt =&gt; opt.MapFrom(src =&gt; DateTime.Now)).ForMember(dest=&gt;dest.DelFlag,opt=&gt;opt.MapFrom(src=&gt;<span class="literal">true</span>)) ;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>下面修改<code>UsersController.cs</code>控制器中的代码，该该控制器中添加如下方法：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">     <span class="comment"><span class="doctag">///</span> 指定的某个用户发布文章 /api/Users/9/articels</span></span><br><span class="line">     <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">     <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">     [<span class="meta">HttpPost(<span class="string">&quot;&#123;userId&#125;/articels&quot;</span>)</span>]</span><br><span class="line">     [<span class="meta">UnitOfWork(new Type[</span>] &#123; <span class="keyword">typeof</span>(MyDbContext) &#125;)]</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">CreateArticelForUser</span>(<span class="params">[FromRoute]<span class="built_in">int</span> userId, [FromBody] ArticelForCreateDto articelForCreateDto</span>)</span></span><br><span class="line">     &#123;</span><br><span class="line">         <span class="keyword">var</span> userInfo = <span class="keyword">await</span> _userInfoService.LoadEntities(u=&gt;u.Id==userId).FirstOrDefaultAsync();</span><br><span class="line">         <span class="keyword">if</span> (userInfo == <span class="literal">null</span>)</span><br><span class="line">         &#123;</span><br><span class="line">             <span class="keyword">return</span> NotFound(<span class="string">&quot;用户不存在!&quot;</span>);</span><br><span class="line">         &#125; </span><br><span class="line">         <span class="comment">// 这里将articelForCreateDto映射到Articel</span></span><br><span class="line">         <span class="keyword">var</span> articelModel = mapper.Map&lt;Articel&gt;(articelForCreateDto);</span><br><span class="line">         articelModel.UserInfo = userInfo; <span class="comment">// 我们知道在Articel中的UserInfo属性表示的是，文章是谁添加的，所以必须确定其只。</span></span><br><span class="line">         <span class="keyword">await</span> _articelService.InsertEntityAsync(articelModel); <span class="comment">// 把articelModel添加到EFCore 上下文中</span></span><br><span class="line">        <span class="keyword">var</span> articel =  mapper.Map&lt;ArticelDto&gt;(articelModel);  <span class="comment">// 把articelModel在映射成ArticelDto,也就是添加成功后前端展示的内容</span></span><br><span class="line">         <span class="comment">// 返回的状态码是201，同时返回的响应头中会有 location:http://localhost:5154/api/Users/9/articels</span></span><br><span class="line">         <span class="comment">// 表示以get请求该地址，会查看对应的用户发送的文章.该地址请求的是GetArticelForUser方法。</span></span><br><span class="line">         <span class="comment">// 第一个参数：当前控制器中的方法名</span></span><br><span class="line">         <span class="comment">// 第二个参数：在通过url访问GetArticelForUser方法的时候需要传递的参数.</span></span><br><span class="line">         <span class="comment">// 第三个参数：当文章发布成功以后，将发布成功的文章信息返回到前端。</span></span><br><span class="line">         <span class="keyword">return</span> CreatedAtAction(<span class="string">&quot;GetArticelForUser&quot;</span>,<span class="keyword">new</span> &#123; userId=userInfo.Id&#125;,articel); <span class="comment">//这里也会将用户发布成功的文章信息返回。</span></span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>

<p>首先参数<code>userId</code>是从路由中获取所以使用了<code>[FromRoute]</code>，<code>articelForCreateDto</code>参数接收的就是文章的数据，这是数据是通过<code>json</code>格式传递过来的。所以使用了<code>[FromBody]</code>.</p>
<h2 id="16、数据验证"><a href="#16、数据验证" class="headerlink" title="16、数据验证"></a>16、数据验证</h2><p>当我们接收到前端页面发送过来的数据的时候，都需要对数据进行校验。</p>
<p>例如：创建用户的时候，发布文章的时候，都需要对数据进行校验。</p>
<p>关于校验的方式在前面讲解<code>.net core mvc</code>课程的时候都给大家讲解过，关键是当数据没有通过校验以后，返回给前端的状态码是多少呢？</p>
<p>一般返回的状态码是422，该状态码的含义是服务端接收到的前端数据是有错误的。当然，除了返回状态码，还要给前端返回错误的信息。</p>
<h3 id="16-1-添加数据验证"><a href="#16-1-添加数据验证" class="headerlink" title="16.1 添加数据验证"></a>16.1 添加数据验证</h3><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ArticelForCreateDto</span></span><br><span class="line">  &#123;</span><br><span class="line">      [<span class="meta">Required(ErrorMessage =<span class="string">&quot;title 不能为空!&quot;</span>)</span>]</span><br><span class="line">      [<span class="meta">MaxLength(100)</span>]</span><br><span class="line">      <span class="keyword">public</span> <span class="built_in">string</span>? Title &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">      [<span class="meta">Required(ErrorMessage = <span class="string">&quot;content 不能为空!&quot;</span>)</span>]</span><br><span class="line">      <span class="keyword">public</span> <span class="built_in">string</span>? Content &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">     </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>启动项目进行测试，输入空字符串进行校验。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;: &quot;&quot;</span><br><span class="line">  &quot;content&quot;: &quot;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进行测试，返回的响应报文是：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://tools.ietf.org/html/rfc7231#section-6.5.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;One or more validation errors occurred.&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">400</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;traceId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;00-810c18ca31baa2592ee25638dd409c64-16d3580cb5db9a6d-00&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;errors&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Title&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;title 不能为空!&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Content&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;content 不能为空!&quot;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>当然，除了这种数据验证方式以外，还可以给当前需要校验的<code>DTO</code>数据传输类添加<code>Attribute</code>.</p>
<p>在<code>Cms.WebApi</code>这个<code>api</code>项中创建<code>ValidationAttributes</code>文件夹，在该文件夹中创建<code>ArticelValidateAttribute.cs</code>,这里必须使用<code>Attribute</code>进行结尾。</p>
<p><code>ArticelValidateAttribute.cs</code>文件中的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Cms.WebApi.Dtos;</span><br><span class="line"><span class="keyword">using</span> System.ComponentModel.DataAnnotations;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.WebApi.ValidationAttributes</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 这里继承ValidationAttribute类，该类来自 System.ComponentModel.DataAnnotations;命名空间</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ArticelValidateAttribute</span>:<span class="title">ValidationAttribute</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 这里重写IsValid方法</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">override</span> ValidationResult? IsValid(<span class="built_in">object</span>? <span class="keyword">value</span>, ValidationContext validationContext)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 通过校验的上下文获取到需要校验的对象，当然这里需要强制转换成ArticelForCreateDto，因为这里就是对输入的文章内容进行校验。</span></span><br><span class="line">          <span class="keyword">var</span> articelDto = (ArticelForCreateDto) validationContext.ObjectInstance;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrWhiteSpace(articelDto.Title))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 第一个参数：错误信息</span></span><br><span class="line">                <span class="comment">// 第二个参数： 错误路径</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> ValidationResult(<span class="string">&quot;title 文章标题不能为空!!&quot;</span>, <span class="keyword">new</span>[] &#123; <span class="string">&quot;ArticelForCreateDto&quot;</span> &#125;);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrWhiteSpace(articelDto.Content))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> ValidationResult(<span class="string">&quot;content 文章内容不能为空!!&quot;</span>, <span class="keyword">new</span>[] &#123; <span class="string">&quot;ArticelForCreateDto&quot;</span> &#125;);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> ValidationResult.Success; <span class="comment">// 表示校验通过了。</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>下面使用<code>ArticelValidateAttribute</code>.</p>
<p>修改<code>Dtos/ArticelForCreateDto.cs</code>类中的代码</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Cms.Entity;</span><br><span class="line"><span class="keyword">using</span> Cms.WebApi.ValidationAttributes;</span><br><span class="line"><span class="keyword">using</span> System.ComponentModel.DataAnnotations;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.WebApi.Dtos</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">ArticelValidate</span>] <span class="comment">// 使用ArticelValidate对输入的文章数据进行校验。</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ArticelForCreateDto</span></span><br><span class="line">    &#123;      </span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? Title &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       </span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? Content &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动项目进行测试。</p>
<p>例如：如果不输入标题，会出现如下错误信息</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://tools.ietf.org/html/rfc7231#section-6.5.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;One or more validation errors occurred.&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">400</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;traceId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;00-9e8a2ff25d30f264e249bab2eb0eaca2-8c70b91fc63e5a93-00&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;errors&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;ArticelForCreateDto&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="comment">// 出现错误的数据传输对象。</span></span><br><span class="line">      <span class="string">&quot;title 文章标题不能为空!!&quot;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<h3 id="16-2-输出状态码422"><a href="#16-2-输出状态码422" class="headerlink" title="16.2  输出状态码422"></a>16.2  输出状态码422</h3><p>现在我们可以看到，当数据没有通过校验的时候，返回的状态码是400，但是实际上在<code>http</code>语义中，数据没有通过校验要求返回的状态码是<code>422</code>.</p>
<p>修改<code>Program.cs</code>文件中的代码，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在AddControllers方法后面添加ConfigureApiBehaviorOptions方法</span></span><br><span class="line">builder.Services.AddControllers().ConfigureApiBehaviorOptions(c =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    c.InvalidModelStateResponseFactory = context =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> problemDetails = <span class="keyword">new</span> ValidationProblemDetails(context.ModelState)</span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            Title = <span class="string">&quot;数据校验有问题&quot;</span>,</span><br><span class="line">            Status = StatusCodes.Status422UnprocessableEntity,</span><br><span class="line">            Instance = context.HttpContext.Request.Path</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// UnprocessableEntityObjectResult:执行时将生成无法处理的实体 (422) 响应。</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> UnprocessableEntityObjectResult(problemDetails)</span><br><span class="line">        &#123;</span><br><span class="line">            ContentTypes = &#123; <span class="string">&quot;application/problem+json&quot;</span> &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>重新启动项目进行测试，这里不输入文章的标题，查看一下返回的响应信息。</p>
<h2 id="17、数据更新操作"><a href="#17、数据更新操作" class="headerlink" title="17、数据更新操作"></a>17、数据更新操作</h2><p>关于数据更新有两项操作</p>
<p><code>put</code>与<code>patch</code></p>
<p><code>put</code>：对某个资源所有的字段进行更新操作   &#x2F;&#x2F; update table set  username&#x3D;”admin”,userpwsd&#x3D;123,email &#x3D; where id&#x3D;1</p>
<p><code>patch</code>:对某个资源的某几个字段进行部分更新操作。</p>
<h3 id="17-1-使用put请求更新资源"><a href="#17-1-使用put请求更新资源" class="headerlink" title="17.1 使用put请求更新资源"></a>17.1 使用<code>put</code>请求更新资源</h3><p>这里我们先使用<code>put</code>的方式来更新用户的信息。</p>
<p>首先在<code>Dtos</code>目录下面创建一个更新用户的数据传输对象<code>UserInfoForUpdateDto.cs</code>，该类中的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserInfoForUpdateDto</span></span><br><span class="line">  &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">public</span> <span class="built_in">string</span>? UserName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> 邮箱</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="keyword">public</span> <span class="built_in">string</span>? UserEmail &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> 电话</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="keyword">public</span> <span class="built_in">string</span>? UserPhone &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> 密码</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="keyword">public</span> <span class="built_in">string</span>? UserPassword &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> 性别：0表示男，1表示女</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="keyword">public</span> <span class="built_in">int</span> Gender &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> 用户头像，存储头像路径</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="keyword">public</span> <span class="built_in">string</span>? PhotoUrl &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>在<code>Profiles/UserInfoProfile.cs</code>中进行配置，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">UserInfoProfile</span>()</span> &#123;</span><br><span class="line">          CreateMap&lt;UserInfo, UserInfoDto&gt;()</span><br><span class="line">              .ForMember(dest=&gt;dest.CreateTime,opt=&gt;opt.MapFrom(src=&gt;src.CreateTime.Year+<span class="string">&quot;年&quot;</span>+src.CreateTime.Month+<span class="string">&quot;月&quot;</span>+src.CreateTime.Day+<span class="string">&quot;日&quot;</span>));</span><br><span class="line">          CreateMap&lt;UserInfoCreateDto, UserInfo&gt;().ForMember(dest=&gt;dest.CreateTime,opt=&gt;opt.MapFrom(src=&gt;DateTime.Now)).ForMember(dest=&gt;dest.UpdateTime,opt=&gt;opt.MapFrom(src=&gt;DateTime.Now));</span><br><span class="line">    <span class="comment">// 这里是将UserInfoForUpdateDto映射给UserInfo.</span></span><br><span class="line">    <span class="comment">// 这里的UpdatetTime是需要更新的，但是在前端我们是不需要用户输入更新时间的，所以这里只能用当前时间重新给UpdateTime赋值。</span></span><br><span class="line">          CreateMap&lt;UserInfoForUpdateDto, UserInfo&gt;().ForMember(dest=&gt;dest.UpdateTime,opt=&gt;opt.MapFrom(src=&gt;DateTime.Now));</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>下面修改<code>UsersController.cs</code>控制器</p>
<p>在该控制器中添加了如下的方式：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> 更新用户信息</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;userId&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;userInfoForUpdateDto&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">      [<span class="meta">HttpPut(<span class="string">&quot;&#123;userId&#125;&quot;</span>)</span>]</span><br><span class="line">      [<span class="meta">UnitOfWork(new Type[</span>] &#123; <span class="keyword">typeof</span>(MyDbContext) &#125;)]</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">EditUser</span>(<span class="params">[FromRoute]<span class="built_in">int</span> userId, [FromBody]UserInfoForUpdateDto userInfoForUpdateDto</span>)</span></span><br><span class="line">      &#123;</span><br><span class="line">          <span class="keyword">var</span> userInfo = <span class="keyword">await</span> _userInfoService.LoadEntities(u=&gt;u.Id ==userId).FirstOrDefaultAsync();</span><br><span class="line">          <span class="keyword">if</span>(userInfo == <span class="literal">null</span>)</span><br><span class="line">          &#123;</span><br><span class="line">              <span class="keyword">return</span> NotFound(<span class="string">&quot;用户不存在&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// 把userInfoForUpdateDtao映射给userInfo这个数据模型</span></span><br><span class="line">          mapper.Map(userInfoForUpdateDto,userInfo);</span><br><span class="line">          <span class="keyword">return</span> NoContent();<span class="comment">// 返回204状态码（当然，这里也可以自己定义返回的信息）</span></span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>注意：这里是全部更新，如果某个字段的值不更新，也要给其原先的值。（但是，我们发现<code>CreateTime</code>和<code>DelFlag</code>两个字段中的值还是原来的值，原因是：在<code>UserInfoForUpdateDto</code>中我们没有创建这两个属性，所以在将<code>UserInfoForUpdateDto</code>映射给<code>UserInfo</code>的时候，这两个字段，没有进行映射，当向数据库中保存的时候，还是使用的<code>UserInfo</code>这个数据模型中的<code>CreateTime和DelFlag</code>）</p>
<p>启动项目进行测试。</p>
<h3 id="17-2-put请求的数据校验"><a href="#17-2-put请求的数据校验" class="headerlink" title="17.2 put请求的数据校验"></a>17.2 <code>put</code>请求的数据校验</h3><p>在更新用户数据的时候，也是要对数据进行校验，并且校验规则也是与创建用户的时候是一样的。</p>
<p>而且，我们所创建的<code>UserInfoCreateDto.cs</code>与<code>UserInfoForUpdateDto.cs</code>两个数据传输类中的属性都是一样的，所以这里完全可以做进一步的封装处理。</p>
<p>在<code>Dtos</code>目录下面创建一个<code>UserInfoForAbstractDto.cs</code>类，该类中的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">UserInfoForAbstractDto</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">string</span>? UserName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 邮箱</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">string</span>? UserEmail &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 电话</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">string</span>? UserPhone &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 密码</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">string</span>? UserPassword &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 性别：0表示男，1表示女</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">int</span> Gender &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 用户头像，存储头像路径</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">string</span>? PhotoUrl &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>由于这里是输入的用户<code>DTO</code>对象和输出的用户<code>DTO</code>对象都需要继承<code>UserInfoForAbstractDto</code>这个类，并且我们也不是直接使用该类，所以<code>UserInfoForAbstractDto</code>这个类定义成抽象类就可以了。</p>
<p>修改<code>Dto/UserInfoCreateDto.cs</code>中的代码，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserInfoCreateDto</span>:<span class="title">UserInfoForAbstractDto</span></span><br><span class="line">   &#123;</span><br><span class="line">        <span class="comment">// 这里需要继承抽象类UserInfoForAbstractDto</span></span><br><span class="line">     </span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>修改<code>Dto/UserInfoForUpdateDto.cs</code>中的代码，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserInfoForUpdateDto</span>: <span class="title">UserInfoForAbstractDto</span></span><br><span class="line">   &#123;</span><br><span class="line">  <span class="comment">// 这里需要继承抽象类UserInfoForAbstractDto</span></span><br><span class="line">      </span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>如果完成校验，我们还需要在<code>ValidationAttributes</code>目录下面创建<code>UserInfoValidateAttribute.cs</code>类，该类的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserInfoValidateAttribute</span>: <span class="title">ValidationAttribute</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">protected</span> <span class="keyword">override</span> ValidationResult? IsValid(<span class="built_in">object</span>? <span class="keyword">value</span>, ValidationContext validationContext)</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="comment">// 这里我们修改成了抽象类UserInfoForAbstractDto</span></span><br><span class="line">           <span class="keyword">var</span> userDto = (UserInfoForAbstractDto)validationContext.ObjectInstance;</span><br><span class="line">           <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrWhiteSpace(userDto.UserName))</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">new</span> ValidationResult(<span class="string">&quot;UserName 用户名不能为空!!&quot;</span>, <span class="keyword">new</span>[] &#123; <span class="string">&quot;UserInfoForAbstractDto&quot;</span> &#125;);</span><br><span class="line"></span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrWhiteSpace(userDto.UserPhone))</span><br><span class="line">           &#123;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">new</span> ValidationResult(<span class="string">&quot;UserPhone 用户电话号码不能为空!!&quot;</span>, <span class="keyword">new</span>[] &#123; <span class="string">&quot;UserInfoForAbstractDto&quot;</span> &#125;);</span><br><span class="line"></span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">return</span> ValidationResult.Success;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>下面在<code>UserInfoCreateDto.cs</code>和<code>UserInfoForUpdateDto.cs</code>这两个类中使用上面所定义的<code>UserInfoValidateAttribute</code>,如下代码所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">UserInfoValidate</span>]</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserInfoCreateDto</span>:<span class="title">UserInfoForAbstractDto</span></span><br><span class="line">   &#123;</span><br><span class="line">      </span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">UserInfoValidate</span>]</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserInfoForUpdateDto</span>: <span class="title">UserInfoForAbstractDto</span></span><br><span class="line">   &#123;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>启动项目进行测试。</p>
<p>在更新的时候，如果输入的用户名是一个空字符串会给出错误提示。</p>
<p>问题：如果在更新的时候，<code>UserName</code>如果为空的情况下，给出的错误提示与创建的时候给出的错误提示不一样应该怎样进行处理呢？</p>
<p>修改<code>UserInfoForAbstractDto.cs</code>抽象类中的代码：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">UserInfoForAbstractDto</span></span><br><span class="line">   &#123;</span><br><span class="line">    <span class="comment">// 这里添加了virtual</span></span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">virtual</span> <span class="built_in">string</span>? UserName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 邮箱</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">string</span>? UserEmail &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br></pre></td></tr></table></figure>

<p>这里给<code>UserName</code>添加了<code>virtual</code>，那么对应的子类中就可以进行重写了，例如：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">UserInfoValidate</span>]</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserInfoForUpdateDto</span>: <span class="title">UserInfoForAbstractDto</span></span><br><span class="line">   &#123;</span><br><span class="line">       [<span class="meta">Required(ErrorMessage =<span class="string">&quot;用户名不能为空，难道你不知道？？&quot;</span>)</span>]</span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">string</span>? UserName &#123; <span class="keyword">get</span> ; <span class="keyword">set</span>; &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>在<code>UserInfoForUpdateDto.cs</code>类中，这里对<code>UserName</code>进行了重写，并且通过<code>ErrorMessage</code>给出了不同的错误提示。</p>
<p>下面可以进行测试，在创建用户和更新用户的时候，当用户名为空字符串的时候，给出的错误提示是不一样的。</p>
<h3 id="17-3-patch数据的局部更新"><a href="#17-3-patch数据的局部更新" class="headerlink" title="17.3  patch数据的局部更新"></a>17.3  <code>patch</code>数据的局部更新</h3><p>在上一小节中，我们通过<code>put</code>完成了数据的全部更新，但是如果只是更新部分字段，还是建议使用<code>patch</code>的方式。</p>
<p>前端发送<code>patch</code>请求给服务端，服务端需要将前端发送过来的<code>json</code>数据转换成以下的数据格式：如下所示：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span><span class="attr">&quot;op&quot;</span><span class="punctuation">:</span><span class="string">&quot;replace&quot;</span><span class="punctuation">,</span><span class="attr">&quot;path&quot;</span><span class="punctuation">:</span><span class="string">&quot;/UserName&quot;</span><span class="punctuation">,</span><span class="attr">&quot;value&quot;</span><span class="punctuation">:</span><span class="string">&quot;admin&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="comment">// 这里是对UserName这个字段进行替换的操作，将其值替换成admin</span></span><br><span class="line">      <span class="punctuation">&#123;</span><span class="attr">&quot;op&quot;</span><span class="punctuation">:</span><span class="string">&quot;remove&quot;</span><span class="punctuation">,</span><span class="attr">&quot;path&quot;</span><span class="punctuation">:</span><span class="string">&quot;/Gender&quot;</span><span class="punctuation">,</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<p>以上这种表示如何修改数据的结构，我们称作<code>JSON Patch</code></p>
<p><code>op</code>指定操作，<code>path</code>指定资源，也就是对哪个属性进行操作，<code>value</code>表示的就是对应的值.</p>
<p>当然，对没有指定的字段，会保留原有的值。</p>
<p>关于<code>op</code>操作，包含了6个选项，分别是：<code>add</code>添加某个字段，<code>remove</code>:删除某个字段,<code>replace</code>：替换某个字段的数据</p>
<p>“move”:转移,”copy”:赋值，<code>test</code>:测试</p>
<p>服务端对<code>patch</code>请求的处理，需要安装如下两个包,安装到<code>Cms.WebApi</code>项目中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Install-Package microsoft.aspnetcore.jsonpatch</span><br><span class="line">Install-Package microsoft.aspnetcore.mvc.NewtonsoftJson</span><br></pre></td></tr></table></figure>

<p>下面在<code>UsersController.cs</code>控制器中添加如下方法：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> 部分更新用户信息</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;userId&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;patchDocument&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">      [<span class="meta">HttpPatch(<span class="string">&quot;&#123;userId&#125;&quot;</span>)</span>]</span><br><span class="line">      [<span class="meta">UnitOfWork(new Type[</span>] &#123; <span class="keyword">typeof</span>(MyDbContext) &#125;)]</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">UpdateUser</span>(<span class="params">[FromRoute] <span class="built_in">int</span> userId, [FromBody] JsonPatchDocument&lt;UserInfoForUpdateDto&gt; patchDocument</span>) <span class="comment">// 表示接收前端传递过来的JsonPatch文档，不再是UserInfoForUpdateDto对象</span></span></span><br><span class="line">      &#123;</span><br><span class="line">          <span class="keyword">var</span> userInfo = <span class="keyword">await</span> _userInfoService.LoadEntities(u =&gt; u.Id == userId).FirstOrDefaultAsync();</span><br><span class="line">          <span class="keyword">if</span> (userInfo == <span class="literal">null</span>)</span><br><span class="line">          &#123;</span><br><span class="line">              <span class="keyword">return</span> NotFound(<span class="string">&quot;用户不存在&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// 把UserInfo映射给UserInfoForUpdateDto,因为UserInfoForUpdateDto中属性是没有值的，而经过上面的查询UserInfo中是有值的</span></span><br><span class="line">        <span class="keyword">var</span> userPatch = mapper.Map&lt;UserInfoForUpdateDto&gt;(userInfo);</span><br><span class="line">          <span class="comment">// 通过ApplyTo方法，就知道更新哪些数据了，patchDocument中保存的是要更新的数据，与userPatch进行比对，就知道修改userPatch中哪些属性了。</span></span><br><span class="line">          patchDocument.ApplyTo(userPatch);</span><br><span class="line">          <span class="comment">// 在更新数据到数据库之前，还是要将`userPath`,映射到UserInfo中，就相当于以前需要将userInfoForUpdateDto映射到UserInfo中是一样的。</span></span><br><span class="line">          mapper.Map(userPatch,userInfo);</span><br><span class="line">          <span class="keyword">return</span> NoContent();</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>这里还需要修改<code>Profiles/UserInfoProfile.cs</code>中的代码，在最后添加</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CreateMap&lt;UserInfo, UserInfoForUpdateDto&gt;();</span><br></pre></td></tr></table></figure>

<p>这里需要将<code>UserInfo</code>这个数据模型，映射到<code>UserInfoForUpdateDto</code>中。</p>
<p>最后，还需要注意的一个点，就是前端发送过来的<code>JSON</code>数据，需要转换成<code>JsonPatchDocument</code>，这里就需要使用到我们前面所安装的<code>NewtonsoftJson</code>包，这个包需要在<code>Program.cs</code>中进行配置，如下所示:</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在AddControllers方法后面添加AddNewtonsoftJson方法</span></span><br><span class="line">builder.Services.AddControllers().AddNewtonsoftJson(a =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 在转换的时候，使用驼峰命名的方式。</span></span><br><span class="line">    a.SerializerSettings.ContractResolver = <span class="keyword">new</span> CamelCasePropertyNamesContractResolver();</span><br><span class="line">&#125;)</span><br><span class="line">    .ConfigureApiBehaviorOptions(c =&gt;</span><br><span class="line">&#123;</span><br></pre></td></tr></table></figure>

<p>启动项目进行测试，在界面窗口中输入：</p>
<p>输入：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;operationType&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/UserName&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;op&quot;</span><span class="punctuation">:</span> <span class="string">&quot;replace&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;from&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;admin&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<p>主要考虑：<code>path,op,value</code></p>
<p>在进行测试的时候，给控制器中的<code>UpdateUser</code>这个方法打上断点，看一下数据的变化情况，更容易理解方法中的代码。</p>
<h3 id="17-4-patch请求的数据校验"><a href="#17-4-patch请求的数据校验" class="headerlink" title="17.4 patch请求的数据校验"></a>17.4 <code>patch</code>请求的数据校验</h3><p>前面在更新数据的时候，我们添加了相应的校验，那么我们来测试一下通过<code>patch</code>请求更新数据的时候，校验是否还起作用。</p>
<p>当输入：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;operationType&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/UserName&quot;</span>,</span><br><span class="line">    <span class="string">&quot;op&quot;</span>: <span class="string">&quot;replace&quot;</span>,</span><br><span class="line">    <span class="string">&quot;from&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">    <span class="string">&quot;value&quot;</span>: <span class="string">&quot;&quot;</span> <span class="comment">// 这里输入的是空字符串</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>发现已经定义的校验规则没有起作用。</p>
<p>原因是：我们现在获取到的数据是<code>JsonPatchDocument</code>,而不是原来的<code>DTO</code>数据传输对象。所以添加到数据传输对象上的校验规则没有起作用。</p>
<p>所以这里需要修改控制器中的<code>UpdateUser</code>方法，代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">UpdateUser</span>(<span class="params">[FromRoute] <span class="built_in">int</span> userId, [FromBody] JsonPatchDocument&lt;UserInfoForUpdateDto&gt; patchDocument</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> userInfo = <span class="keyword">await</span> _userInfoService.LoadEntities(u =&gt; u.Id == userId).FirstOrDefaultAsync();</span><br><span class="line">            <span class="keyword">if</span> (userInfo == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> NotFound(<span class="string">&quot;用户不存在&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">          <span class="keyword">var</span> userPatch = mapper.Map&lt;UserInfoForUpdateDto&gt;(userInfo);</span><br><span class="line">            patchDocument.ApplyTo(userPatch,ModelState);<span class="comment">// 这里将全局属性ModelState与对应的UsserInfoFouUpdateDto进行了绑定</span></span><br><span class="line">          <span class="comment">// 对userPatch进行校验，TryValidateModel：验证成功返回true,没有验证通过返回false</span></span><br><span class="line">            <span class="keyword">if</span> (!TryValidateModel(userPatch))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 返回错误的信息。ModelState在前面已经与具体的`DTO`对象绑定了，所以知道具体的错误信息</span></span><br><span class="line">                <span class="keyword">return</span> ValidationProblem(ModelState);</span><br><span class="line">            &#125;</span><br><span class="line">            mapper.Map(userPatch,userInfo);</span><br><span class="line">            <span class="keyword">return</span> NoContent();</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>再次进行测试。</p>
<p>问题，如果修改多个字段，可以采用如下方式进行测试：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;operationType&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/UserName&quot;</span>,</span><br><span class="line">    <span class="string">&quot;op&quot;</span>: <span class="string">&quot;replace&quot;</span>,</span><br><span class="line">    <span class="string">&quot;from&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">    <span class="string">&quot;value&quot;</span>: <span class="string">&quot;admin12&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line"> &#123;</span><br><span class="line">    <span class="string">&quot;operationType&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/UserPassword&quot;</span>,</span><br><span class="line">    <span class="string">&quot;op&quot;</span>: <span class="string">&quot;replace&quot;</span>,</span><br><span class="line">    <span class="string">&quot;from&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">    <span class="string">&quot;value&quot;</span>: <span class="string">&quot;123&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h2 id="18、数据删除"><a href="#18、数据删除" class="headerlink" title="18、数据删除"></a>18、数据删除</h2><h3 id="18-1-删除指定的用户信息"><a href="#18-1-删除指定的用户信息" class="headerlink" title="18.1  删除指定的用户信息"></a>18.1  删除指定的用户信息</h3><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">HttpDelete(<span class="string">&quot;&#123;userId&#125;&quot;</span>)</span>] <span class="comment">// 指定HttpDelete</span></span><br><span class="line">     [<span class="meta">UnitOfWork(new Type[</span>] &#123; <span class="keyword">typeof</span>(MyDbContext) &#125;)]</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">DeleteUser</span>(<span class="params">[FromRoute]<span class="built_in">int</span> userId</span>)</span></span><br><span class="line">     &#123;</span><br><span class="line">         <span class="keyword">var</span> userInfo = <span class="keyword">await</span> _userInfoService.LoadEntities(u =&gt; u.Id == userId).FirstOrDefaultAsync();</span><br><span class="line">         <span class="keyword">if</span> (userInfo == <span class="literal">null</span>)</span><br><span class="line">         &#123;</span><br><span class="line">             <span class="keyword">return</span> NotFound(<span class="string">&quot;用户不存在&quot;</span>);</span><br><span class="line">         &#125;</span><br><span class="line">        <span class="keyword">await</span> _userInfoService.DeleteEntityAsync(userInfo); <span class="comment">// 这里直接进行物理删除</span></span><br><span class="line">         <span class="keyword">return</span> NoContent();<span class="comment">// 直接返回204状态码</span></span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>

<h3 id="18-2-删除用户发布的文章"><a href="#18-2-删除用户发布的文章" class="headerlink" title="18.2  删除用户发布的文章"></a>18.2  删除用户发布的文章</h3><p>这里我们需要删除的是某个用户发布的谋篇文章。</p>
<p>这里我们还在<code>UsersController.cs</code>控制器中添加代码</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 删除指定用户的指定文章</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;userId&quot;&gt;</span>用户编号<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;articelId&quot;&gt;</span>文章编号<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">       [<span class="meta">HttpDelete(<span class="string">&quot;&#123;userId&#125;/articels/&#123;articelId&#125;&quot;</span>)</span>] <span class="comment">// ---------注意请求地址的设置</span></span><br><span class="line">       [<span class="meta">UnitOfWork(new Type[</span>] &#123; <span class="keyword">typeof</span>(MyDbContext) &#125;)]</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">DeleteUserArticel</span>(<span class="params">[FromRoute]<span class="built_in">int</span> userId, [FromRoute]<span class="built_in">int</span> articelId</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">var</span> userInfo = <span class="keyword">await</span> _userInfoService.LoadEntities(u =&gt; u.Id == userId).FirstOrDefaultAsync();</span><br><span class="line">           <span class="keyword">if</span> (userInfo == <span class="literal">null</span>)</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">return</span> NotFound(<span class="string">&quot;用户不存在&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">var</span> articelInfo = <span class="keyword">await</span> _articelService.LoadEntities(a =&gt; a.Id == articelId&amp;&amp;a.UserInfo==userInfo).FirstOrDefaultAsync(); <span class="comment">// 注意-----这里指定的查询条件</span></span><br><span class="line">           <span class="keyword">if</span> (articelInfo == <span class="literal">null</span>)</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">return</span> NotFound(<span class="string">&quot;文章不存在&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">await</span> _articelService.DeleteEntityAsync(articelInfo);</span><br><span class="line">           <span class="keyword">return</span> NoContent();</span><br><span class="line"></span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<h3 id="18-3-批量删除用户"><a href="#18-3-批量删除用户" class="headerlink" title="18.3 批量删除用户"></a>18.3 批量删除用户</h3><p>在这一小节中，我们来看一下怎样创建批量删除用户信息的<code>Api</code>接口。</p>
<p>批量删除的<code>URL</code>构建</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">方式1: 参数使用?号的方式</span><br><span class="line">   delete  api/users?Ids=1,2,3,4,5</span><br><span class="line">方式2：参数构建URL片段</span><br><span class="line">   delete api/users/(1,2,3,4,5)</span><br></pre></td></tr></table></figure>

<p>方式1，在前面讲解<code>.net core mvc</code>的时候，给大家演示过。</p>
<p>在这以小节中，我们主要采用的是方式2.</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 批量删除用户信息</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;userIds&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">       [<span class="meta">HttpDelete(<span class="string">&quot;(&#123;userIds&#125;)&quot;</span>)</span>] <span class="comment">// 注意：这里使用了小括号包裹了参数名</span></span><br><span class="line">       [<span class="meta">UnitOfWork(new Type[</span>] &#123; <span class="keyword">typeof</span>(MyDbContext) &#125;)]</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">DeleteAllUsers</span>(<span class="params">[FromRoute]List&lt;<span class="built_in">string</span>&gt;userIds</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">var</span> strIds = userIds[<span class="number">0</span>].Split(<span class="string">&#x27;,&#x27;</span>); <span class="comment">// 集合中第一个元素中存储了用小括号括起来的用户编号，所以这里取出来以后使用逗号进行分割</span></span><br><span class="line">           List&lt;<span class="built_in">long</span>&gt; newList=<span class="keyword">new</span> List&lt;<span class="built_in">long</span>&gt;();</span><br><span class="line">           <span class="keyword">foreach</span>(<span class="keyword">var</span> id <span class="keyword">in</span> strIds)</span><br><span class="line">           &#123;</span><br><span class="line">               newList.Add(Convert.ToInt32(id));</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">var</span> userInfoList = _userInfoService.LoadEntities(u=&gt;newList.Contains(u.Id));</span><br><span class="line">          <span class="keyword">foreach</span>(<span class="keyword">var</span> user <span class="keyword">in</span> userInfoList)</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">await</span> _userInfoService.DeleteEntityAsync(user);</span><br><span class="line">           &#125;</span><br><span class="line">          <span class="keyword">return</span> NoContent();</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>启动项目进行测试。</p>
<p>以下代码采用了方式1来进行处理</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> 批量删除用户信息</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;userIds&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">      [<span class="meta">HttpDelete(<span class="string">&quot;&#123;userIds&#125;/alluser&quot;</span>)</span>] <span class="comment">// 这里不用给参数&#123;userId&#125;添加小括号，同时为了区分删除单条记录的url地址，所以后面添加了一个alluser</span></span><br><span class="line">      [<span class="meta">UnitOfWork(new Type[</span>] &#123; <span class="keyword">typeof</span>(MyDbContext) &#125;)]</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">DeleteAllUsers</span>(<span class="params">[FromRoute]<span class="built_in">string</span> userIds</span>) <span class="comment">// 这里接收的是字符串</span></span></span><br><span class="line">      &#123;</span><br><span class="line">          <span class="keyword">var</span> strIds = userIds.Split(<span class="string">&#x27;,&#x27;</span>);<span class="comment">// 字符串中每个编号都是使用逗号进行分割的</span></span><br><span class="line">          List&lt;<span class="built_in">long</span>&gt; newList=<span class="keyword">new</span> List&lt;<span class="built_in">long</span>&gt;();</span><br><span class="line">          <span class="keyword">foreach</span>(<span class="keyword">var</span> id <span class="keyword">in</span> strIds)</span><br><span class="line">          &#123;</span><br><span class="line">              newList.Add(Convert.ToInt32(id));</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">var</span> userInfoList = _userInfoService.LoadEntities(u=&gt;newList.Contains(u.Id));</span><br><span class="line">         <span class="keyword">foreach</span>(<span class="keyword">var</span> user <span class="keyword">in</span> userInfoList)</span><br><span class="line">          &#123;</span><br><span class="line">              <span class="keyword">await</span> _userInfoService.DeleteEntityAsync(user);</span><br><span class="line">          &#125;</span><br><span class="line">         <span class="keyword">return</span> NoContent();</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>启动项目进行测试，可以监视浏览器中的请求，看一下请求的地址。</p>
<h2 id="19、JWT"><a href="#19、JWT" class="headerlink" title="19、JWT"></a>19、<code>JWT</code></h2><h3 id="19-1、JWT介绍"><a href="#19-1、JWT介绍" class="headerlink" title="19.1、JWT介绍"></a>19.1、<code>JWT</code>介绍</h3><p>参考文档:<code>https://www.cnblogs.com/jingboweilan/p/14569434.html</code></p>
<p><code>https://www.cnblogs.com/yuanrw/p/10089796.html</code></p>
<p><code>JSON Web Token（JWT）</code></p>
<p>Internet服务无法与用户身份验证分开。一般过程如下。</p>
<p>1.用户向服务器发送用户名和密码。</p>
<p>2.验证服务器后，相关数据（如用户角色，登录时间等）将保存在当前会话中。</p>
<p>3.服务器向用户返回session_id，session信息都会写入到用户的Cookie。</p>
<p>4.用户的每个后续请求都将通过在Cookie中取出session_id传给服务器。</p>
<p>5.服务器收到session_id并对比之前保存的数据，确认用户的身份。</p>
<p>这种模式最大的问题是，没有分布式架构，无法支持横向扩展。如果使用一个服务器，该模式完全没有问题。但是，如果它是服务器群集或面向服务的跨域体系结构的话，则需要一个统一的session数据库库来保存会话数据实现共享，这样负载均衡下的每个服务器才可以正确的验证用户身份。</p>
<p>例如：站点A和站点B提供同一公司的相关服务。现在要求用户只需要登录其中一个网站，然后它就会自动登录到另一个网站。怎么做？</p>
<p>一种解决方案是听过持久化session数据，写入数据库或文件持久层等。收到请求后，验证服务从持久层请求数据。该解决方案的优点在于架构清晰，而缺点是架构修改比较费劲，整个服务的验证逻辑层都需要重写，工作量相对较大。而且由于依赖于持久层的数据库或者问题系统，会有单点风险，如果持久层失败，整个认证体系都会挂掉。</p>
<p>所以这里，可以通过客户端保存数据，而服务器根本不保存会话数据，每个请求都被发送回服务器。 JWT是这种解决方案的代表。</p>
<h3 id="19-2-JWT的原则"><a href="#19-2-JWT的原则" class="headerlink" title="19.2. JWT的原则"></a><strong>19.2. JWT的原则</strong></h3><p>（<code>JSON Web Tocken</code>）</p>
<p>JWT的原则是在服务器身份验证之后，将生成一个JSON对象并将其发送回用户，如下所示。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">&quot;UserName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Chongchong&quot;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line"><span class="attr">&quot;Role&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Admin&quot;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line"><span class="attr">&quot;Expire&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2018-08-08 20:15:56&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>之后，当用户与服务器通信时，客户在请求中发回JSON对象。服务器仅依赖于这个JSON对象来标识用户。为了防止用户篡改数据，服务器将在生成对象时添加签名</p>
<p>服务器不保存任何会话数据，即服务器变为无状态，使其更容易扩展。</p>
<h3 id="19-3-JWT的数据结构"><a href="#19-3-JWT的数据结构" class="headerlink" title="19.3. JWT的数据结构"></a><strong>19.3. JWT的数据结构</strong></h3><p>典型的，一个JWT看起来如下图。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="E:/netcore/WebApi/%E8%AE%B2%E4%B9%89/images/JWT%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84.jpg"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="E:/netcore/WebApi/%E8%AE%B2%E4%B9%89/images/jwt.jpg"></p>
<p>改对象为一个很长的字符串，字符之间通过”.”分隔符分为三个子串。注意JWT对象为一个长字串，各字串之间也没有换行符，此处为了演示需要，我们特意分行并用不同颜色表示了。每一个子串表示了一个功能块，总共有以下三个部分：</p>
<p>JWT的三个部分如下。JWT头、有效载荷和签名，将它们写成一行如下。</p>
<p>JWT头部分是一个描述JWT元数据的JSON对象，通常如下所示。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">&quot;alg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HS256&quot;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;type&quot;</span> <span class="string">&quot;JWT&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在上面的代码中，alg属性表示签名使用的算法，默认为HMAC SHA256（写为HS256）；typ属性表示令牌的类型，JWT令牌统一写为JWT。</p>
<p>最后，使用Base64 URL算法将上述JSON对象转换为字符串保存。</p>
<p><strong>3.2 有效载荷</strong></p>
<p>有效载荷部分，是JWT的主体内容部分，也是一个JSON对象，包含需要传递的数据。 JWT指定七个默认字段供选择。</p>
<p>iss：发行人</p>
<p>exp：到期时间</p>
<p>sub：主题</p>
<p>aud：用户</p>
<p>nbf：在此之前不可用</p>
<p>iat：发布时间</p>
<p>jti：JWT ID用于标识该JWT</p>
<p>除以上默认字段外，我们还可以自定义私有字段，如下例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">&quot;sub&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1234567890&quot;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line"><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;chongchong&quot;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line"><span class="attr">&quot;admin&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>请注意，默认情况下JWT载荷是未加密的，任何人都可以解读其内容，因此不要构建隐私信息字段，存放保密信息，以防止信息泄露。</p>
<p>JSON对象也使用Base64 URL算法转换为字符串保存。</p>
<p><strong>3.3签名哈希</strong></p>
<p>签名哈希部分是对上面两部分数据签名，通过指定的算法生成哈希，以确保数据不会被篡改。</p>
<p>首先，需要指定一个密钥（secret）。该密码仅仅为保存在服务器中，并且不能向用户公开。然后，使用标头中指定的签名算法（默认情况下为HMAC SHA256）根据以下公式生成签名。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">HMACSHA256</span>(<span class="title function_">base64UrlEncode</span>(header) + <span class="string">&quot;.&quot;</span> + <span class="title function_">base64UrlEncode</span>(payload),secret)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在计算出签名哈希后，JWT头，有效载荷和签名哈希的三个部分组合成一个字符串，每个部分用”.”分隔，就构成整个JWT对象。</p>
<p><strong>4. JWT的用法</strong></p>
<p>客户端接收服务器返回的JWT，将其存储在Cookie或localStorage中。</p>
<p>此后，客户端将在与服务器交互中都会带JWT。如果将它存储在Cookie中，就可以自动发送，但是不会跨域，因此一般是将它放入HTTP请求的Header Authorization字段中。</p>
<p>Authorization: Bearer</p>
<p>当跨域时，也可以将JWT被放置于POST请求的数据主体中</p>
<p>总结内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"> 它是一个很长的字符串，中间用点（`.`）分隔成三个部分。注意，JWT 内部是没有换行的，这里只是为了便于展示，将它写成了几行。 </span><br><span class="line"></span><br><span class="line"> JWT 的三个部分依次如下。 </span><br><span class="line"></span><br><span class="line">```</span><br><span class="line">Header（头部）</span><br><span class="line">Payload（负载）</span><br><span class="line">Signature（签名）</span><br><span class="line">```</span><br><span class="line"></span><br><span class="line">写成一行，就是下面的样子。 </span><br><span class="line"></span><br><span class="line">```</span><br><span class="line">Header.Payload.Signature</span><br><span class="line">```</span><br><span class="line"></span><br><span class="line"> 下面依次介绍这三个部分。 </span><br><span class="line"></span><br><span class="line">**Header**</span><br><span class="line"></span><br><span class="line"> Header 部分是一个 JSON 对象，描述 JWT 的元数据，通常是下面的样子。 </span><br><span class="line"></span><br><span class="line">```json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;alg&quot;: &quot;HS256&quot;,</span><br><span class="line">  &quot;typ&quot;: &quot;JWT&quot;</span><br><span class="line">&#125;</span><br><span class="line">```</span><br><span class="line"></span><br><span class="line"> 上面代码中，`alg`属性表示签名的算法（algorithm），默认是 HMAC SHA256（写成 HS256）；`typ`属性表示这个令牌（token）的类型（type），JWT 令牌统一写为`JWT`。 </span><br><span class="line"></span><br><span class="line"> 最后，将上面的 JSON 对象使用 Base64URL 算法转成字符串。 </span><br><span class="line"></span><br><span class="line">**Payload**</span><br><span class="line"></span><br><span class="line"> Payload 部分也是一个 JSON 对象，用来存放实际需要传递的数据。JWT 规定了7个官方字段，供选用。 </span><br><span class="line"></span><br><span class="line">```</span><br><span class="line">iss (issuer)：签发人</span><br><span class="line">exp (expiration time)：过期时间</span><br><span class="line">sub (subject)：主题</span><br><span class="line">aud (audience)：受众</span><br><span class="line">nbf (Not Before)：生效时间</span><br><span class="line">iat (Issued At)：签发时间</span><br><span class="line">jti (JWT ID)：编号</span><br><span class="line">```</span><br><span class="line"></span><br><span class="line"> 除了官方字段，你还可以在这个部分定义私有字段，下面就是一个例子。 </span><br><span class="line"></span><br><span class="line">```</span><br><span class="line">&#123;</span><br><span class="line">  &quot;sub&quot;: &quot;1234567890&quot;,</span><br><span class="line">  &quot;name&quot;: &quot;John Doe&quot;,</span><br><span class="line">  &quot;admin&quot;: true</span><br><span class="line">&#125;</span><br><span class="line">```</span><br><span class="line"></span><br><span class="line">这个 JSON 对象也要使用 Base64URL 算法转成字符串。 </span><br><span class="line"></span><br><span class="line">**Signature**</span><br><span class="line"></span><br><span class="line">Signature 部分是对前两部分的签名，防止数据篡改。</span><br><span class="line"></span><br><span class="line">首先，需要指定一个密钥（secret）。这个密钥只有服务器才知道，不能泄露给用户。然后，使用 Header 里面指定的签名算法（默认是 HMAC SHA256），按照下面的公式产生签名。</span><br><span class="line"></span><br><span class="line">```</span><br><span class="line">HMACSHA256(</span><br><span class="line">  base64UrlEncode(header) + &quot;.&quot; +</span><br><span class="line">  base64UrlEncode(payload),</span><br><span class="line">  secret)</span><br><span class="line">```</span><br><span class="line"></span><br><span class="line"> 算出签名以后，把 Header、Payload、Signature 三个部分拼成一个字符串，每个部分之间用&quot;点&quot;（`.`）分隔，就可以返回给用户。 </span><br></pre></td></tr></table></figure>

<h3 id="19-4-JWT的基本使用"><a href="#19-4-JWT的基本使用" class="headerlink" title="19.4 JWT的基本使用"></a>19.4 <code>JWT</code>的基本使用</h3><p>我们首先完成的是用户登录，登录成功以后，会创建<code>JWT</code>，然后返回给客户端。</p>
<p>当然，在项目中使用<code>JWT</code>，需要再<code>Cms.WebApi</code>项目中安装如下的包。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Install-Package  Microsoft.AspNetCore.Authentication.JwtBearer</span><br></pre></td></tr></table></figure>

<p>这里首先会进行登录的校验，所以针对登录，先创建一个<code>DTO</code>数据传输对象。</p>
<p>在<code>Dtos</code>这个目录下面创建<code>LoginDto.cs</code>类，该类中的代码，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">LoginDto</span></span><br><span class="line"> &#123;</span><br><span class="line">     [<span class="meta">Required</span>]</span><br><span class="line">     <span class="keyword">public</span> <span class="built_in">string</span>? UserName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">     [<span class="meta">Required</span>]</span><br><span class="line">     <span class="keyword">public</span> <span class="built_in">string</span>? UserPassword &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>针对登录，很难创建一个标注的<code>Restful</code>的接口，但是我们前面也已经讲解过，不用为了<code>Restful</code>而<code>Restful</code>。</p>
<p>这里创建一个<code>LoginController.cs</code>控制器，该控制器中的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Cms.IService;</span><br><span class="line"><span class="keyword">using</span> Cms.WebApi.Dtos;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Http;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"><span class="keyword">using</span> Microsoft.EntityFrameworkCore;</span><br><span class="line"><span class="keyword">using</span> Microsoft.IdentityModel.JsonWebTokens;</span><br><span class="line"><span class="keyword">using</span> Microsoft.IdentityModel.Tokens;</span><br><span class="line"><span class="keyword">using</span> System.IdentityModel.Tokens.Jwt;</span><br><span class="line"><span class="keyword">using</span> System.Security.Claims;</span><br><span class="line"><span class="keyword">using</span> System.Security.Permissions;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.WebApi.Controllers</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">Route(<span class="string">&quot;api/[controller]&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">ApiController</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">LoginController</span> : <span class="title">ControllerBase</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IUserInfoService _userInfoService; </span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IConfiguration configuration;</span><br><span class="line">        <span class="comment">// 注入IUserInfoService和IConfiguration（这里获取配置文件中的内容）</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">LoginController</span>(<span class="params">IUserInfoService _userInfoService,IConfiguration configuration</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>._userInfoService = _userInfoService;   </span><br><span class="line">            <span class="keyword">this</span>.configuration = configuration;</span><br><span class="line">        &#125;</span><br><span class="line">        [<span class="meta">HttpPost</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span>  <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">login</span>(<span class="params">[FromBody] LoginDto loginDto</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">string</span>.IsNullOrWhiteSpace(loginDto.UserName)||<span class="built_in">string</span>.IsNullOrWhiteSpace(loginDto.UserName))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> BadRequest(<span class="string">&quot;用户名或密码不能为空!&quot;</span>);</span><br><span class="line">            &#125;    </span><br><span class="line">            <span class="comment">// 1、验证用户</span></span><br><span class="line">           <span class="keyword">var</span> loginUsr = <span class="keyword">await</span> _userInfoService.LoadEntities(u=&gt;u.UserName==loginDto.UserName&amp;&amp;u.UserPassword==loginDto.UserPassword).FirstOrDefaultAsync();</span><br><span class="line">            <span class="keyword">if</span> (loginUsr == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> BadRequest(<span class="string">&quot;用户名或密码错误!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 2、创建JWT</span></span><br><span class="line">            <span class="comment">// 创建header,内部定义了JWT编码的算法</span></span><br><span class="line">          <span class="keyword">var</span>  securityAlgorithm =  SecurityAlgorithms.HmacSha256;</span><br><span class="line">            <span class="comment">// 创建payload,需要根据项目的需求来进行创建，例如可能会使用到用户的编号，用户名，邮箱等</span></span><br><span class="line">            <span class="comment">// 创建payload的内容，需要使用到Claim(每创建一个Claim对象，表示用户的一个信息)</span></span><br><span class="line">            <span class="keyword">var</span> claims = <span class="keyword">new</span>[]</span><br><span class="line">            &#123;</span><br><span class="line">                  <span class="comment">// 第一项是，用户的ID，但是在JWT中，关于ID在JWT中有一个专用的名词叫做sub</span></span><br><span class="line">                  <span class="keyword">new</span> Claim(System.IdentityModel.Tokens.Jwt.JwtRegisteredClaimNames.Sub,loginUsr.Id.ToString())</span><br><span class="line">              &#125;;</span><br><span class="line">            <span class="comment">// 创建签名，签名会使用到私钥，可以把私钥保存在配置文件中</span></span><br><span class="line">            <span class="comment">// 读取配置文件中的私钥，然后转成字节</span></span><br><span class="line">            <span class="keyword">var</span> secretByte = Encoding.UTF8.GetBytes(configuration[<span class="string">&quot;Authentication:SecretKey&quot;</span>]!);</span><br><span class="line">            <span class="comment">// 使用加密算法，对私钥进行加密</span></span><br><span class="line">              <span class="keyword">var</span> signingKey = <span class="keyword">new</span> SymmetricSecurityKey(secretByte);</span><br><span class="line">            <span class="comment">// 构建数字签名</span></span><br><span class="line">           <span class="keyword">var</span> signingCredentials = <span class="keyword">new</span> SigningCredentials(signingKey, securityAlgorithm);</span><br><span class="line">            <span class="comment">// 构建token 内容</span></span><br><span class="line">            <span class="keyword">var</span> token = <span class="keyword">new</span> JwtSecurityToken(</span><br><span class="line">                <span class="comment">// 谁发布的token数据，一般是服务端的地址</span></span><br><span class="line">                issuer: configuration[<span class="string">&quot;Authentication:Issuer&quot;</span>],</span><br><span class="line">                <span class="comment">// 把token数据发布给谁，一般就是前端项目，这里也可以填写服务端的地址，或者不填写也可以</span></span><br><span class="line">                 audience: configuration[<span class="string">&quot;Authentication:Audience&quot;</span>],</span><br><span class="line">                claims,</span><br><span class="line">                <span class="comment">// 发布时间</span></span><br><span class="line">                notBefore:DateTime.Now,</span><br><span class="line">                <span class="comment">// 有效期</span></span><br><span class="line">                expires:DateTime.Now.AddDays(<span class="number">1</span>),</span><br><span class="line">                <span class="comment">// 数字签名</span></span><br><span class="line">                signingCredentials</span><br><span class="line"></span><br><span class="line">                );</span><br><span class="line">            <span class="comment">// 将token生成字符串的形式进行输出</span></span><br><span class="line">            <span class="keyword">var</span> tokenStr = <span class="keyword">new</span> JwtSecurityTokenHandler().WriteToken(token);</span><br><span class="line">            <span class="comment">//3、返回 200状态码和JWT内容</span></span><br><span class="line">            <span class="keyword">return</span> Ok(tokenStr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在上面的代码中，我们构建数字签名的时候，使用了私钥，私钥必须保存到服务端，同时这里我们将其保存在了<code>appsettings.json</code>文件中</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;ConnectionStrings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;StrConn&quot;</span>: <span class="string">&quot;server=localhost;database=APIDemo;uid=sa;pwd=123456;TrustServerCertificate=true&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;Authentication&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;SecretKey&quot;</span>:<span class="string">&quot;abc123456789@126.com&quot;</span>  <span class="comment">// 这里的值一定要长，否则会出错。</span></span><br><span class="line">      <span class="string">&quot;Issuer&quot;</span>: <span class="string">&quot;xxx.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Audience&quot;</span>: <span class="string">&quot;xxx.com&quot;</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h3 id="19-5-启动授权"><a href="#19-5-启动授权" class="headerlink" title="19.5 启动授权"></a>19.5 启动授权</h3><p>当用户访问某些资源的时候，需要进行验证。</p>
<p>这就是使用前面所生成的<code>token</code>.</p>
<p>当然，这里需要注入<code>jwt</code>的认证服务。</p>
<p>修改<code>Program.cs</code>文件中的代码，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注入jwt的认证服务（这里采用默认的认证）</span></span><br><span class="line">builder.Services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme).AddJwtBearer(options =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 获取配置文件中存储的密钥</span></span><br><span class="line">    <span class="keyword">var</span> secretByte = Encoding.UTF8.GetBytes(builder.Configuration[<span class="string">&quot;Authentication:SecretKey&quot;</span>]!);</span><br><span class="line">    options.TokenValidationParameters = <span class="keyword">new</span> TokenValidationParameters()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 验证token的发布者</span></span><br><span class="line">        ValidateIssuer = <span class="literal">true</span>,</span><br><span class="line">        ValidIssuer = builder.Configuration[<span class="string">&quot;Authentication:Issuer&quot;</span>],</span><br><span class="line">        <span class="comment">// 验证token的持有者</span></span><br><span class="line">        ValidateAudience = <span class="literal">true</span>,</span><br><span class="line">        ValidAudience = builder.Configuration[<span class="string">&quot;Authentication:Audience&quot;</span>],</span><br><span class="line">        <span class="comment">// 验证toen是否过期</span></span><br><span class="line">        ValidateLifetime = <span class="literal">true</span>,</span><br><span class="line">        <span class="comment">// 使用私钥</span></span><br><span class="line">        IssuerSigningKey = <span class="keyword">new</span> SymmetricSecurityKey(secretByte)</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//注入DbContext,同时获取数据库链接字符串</span></span><br><span class="line">builder.Services.AddDbContext&lt;MyDbContext&gt;(opt =&gt;</span><br></pre></td></tr></table></figure>

<p>以上代码就是在注入<code>DbContext</code>服务的上面，注入了<code>JWT</code>的认证服务。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Configure the HTTP request pipeline.</span></span><br><span class="line"><span class="keyword">if</span> (app.Environment.IsDevelopment())</span><br><span class="line">&#123;</span><br><span class="line">    app.UseSwagger();</span><br><span class="line">    app.UseSwaggerUI();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 你是谁，是否登录</span></span><br><span class="line">app.UseAuthentication();</span><br><span class="line"><span class="comment">// 你可以干什么，有什么权限？</span></span><br><span class="line">app.UseAuthorization();</span><br><span class="line"></span><br><span class="line">app.MapControllers();</span><br></pre></td></tr></table></figure>

<p>同时，在<code>Program.cs</code>文件的下面添加了<code>app.UseAuthentication(),app.UseAuthorization();app.MapControllers();</code></p>
<p>下面，我们进行测试。</p>
<p>我们考虑到用户登录了才能创建其他的用户。</p>
<p>所以说，在<code>UsersController.cs</code>控制器中的<code>CreateUser</code>方法上面添加了<code>Authorize</code>，进行校验。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 创建用户: http://localhost:5154/api/Users</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        [<span class="meta">HttpPost</span>]</span><br><span class="line">        [<span class="meta">Authorize</span>] <span class="comment">// 启用授权</span></span><br><span class="line">        [<span class="meta">UnitOfWork(new Type[</span>] &#123; <span class="keyword">typeof</span>(MyDbContext) &#125;)]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">CreatUser</span>(<span class="params">[FromBody]UserInfoCreateDto userInfoCreateDto</span>)</span></span><br><span class="line">        &#123;</span><br></pre></td></tr></table></figure>

<p>下面进行测试，首先在<code>swagger</code>页面中进行登录，当登录成功以后，才能获取到<code>token</code>信息。</p>
<p>下面访问[<code>Post</code>]<code>/api/Users</code>的地址，去创建用户，这里我们输入完用户信息以后，单击执行的<code>Execute</code>按钮以后，会返回401状态码，表示要求进行身份认证，原因是：针对这次创建用户的这次<code>POST</code>请求我们没有带上<code>token</code>信息。</p>
<p>才导致了返回<code>401</code>状态码，在<code>swagger</code>中配置请求中添加<code>token</code>稍微麻烦，这里我们可以使用<code>ApifOX</code>软件。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="E:/netcore/WebApi/%E8%AE%B2%E4%B9%89/images/437.png"></p>
<h2 id="20、分页处理"><a href="#20、分页处理" class="headerlink" title="20、分页处理"></a>20、分页处理</h2><p>分页的参数传递方式，通常都是通过查询字符串来进行传递的。</p>
<p>例如：<code>/api/users?当前页=1&amp;每页显示记录数=10</code></p>
<p>当然，如果用户没有设置页码或者是每页显示的记录数，可以设置默认值，例如:默认页码值为1，每页显示的记录数默认值为10.</p>
<p>这里我们以文章分页来进行演示。</p>
<p>这里我们首先修改<code>ResourceParams/ArticelParams.cs</code>中的代码</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ArticelParams</span></span><br><span class="line">    &#123;</span><br><span class="line">     </span><br><span class="line">       </span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? title &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? FormDatepicker &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? ToDatepicker &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment">// 定义一个成员变量</span></span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">int</span> _pageIndex = <span class="number">1</span>;</span><br><span class="line">        <span class="comment">// 当前页码值，默认值是1</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> PageIndex &#123; </span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> _pageIndex;</span><br><span class="line">            &#125; </span><br><span class="line">            <span class="keyword">set</span> &#123; </span><br><span class="line"></span><br><span class="line">              <span class="keyword">if</span>(<span class="keyword">value</span> &gt;=<span class="number">1</span> )</span><br><span class="line">                &#123;</span><br><span class="line">                    _pageIndex = <span class="keyword">value</span>;</span><br><span class="line">                &#125;</span><br><span class="line">             </span><br><span class="line">            &#125; </span><br><span class="line">        &#125;</span><br><span class="line">      <span class="comment">// 定义成员变量_pageSize,默认值是10</span></span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">int</span> _pageSize = <span class="number">10</span>;</span><br><span class="line">    <span class="comment">// 表示最大值是50,也就是说如果用户随意的输入了每页显示的记录数，如果大于了50，最多每页显示的记录数也是50</span></span><br><span class="line">        <span class="keyword">const</span> <span class="built_in">int</span> maxPageSize = <span class="number">50</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> PageSize &#123; </span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> _pageSize;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">set</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">value</span> &gt;= <span class="number">1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    </span><br><span class="line">                    _pageSize = <span class="keyword">value</span> &gt; maxPageSize?maxPageSize : <span class="keyword">value</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">bool</span> Order &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>在以上的代码中，通过定义私有成员变量<code> _pageIndex 和_pageSize</code>对当前的页码与每页显示的记录数都做了一定的限制。</p>
<p>返回到<code>ArticelsController.cs</code>这控制器中，把注释测试代码注释掉。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// api/articels?keyword=传入的参数</span></span><br><span class="line">       [<span class="meta">HttpGet</span>]</span><br><span class="line">       <span class="function"><span class="keyword">public</span>  IActionResult <span class="title">GetArticel</span>(<span class="params">[FromQuery] ArticelParams articelParams</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">        <span class="comment">/*   articelParams.PageIndex = 1;</span></span><br><span class="line"><span class="comment">           articelParams.PageSize = 10;*/</span></span><br><span class="line">           <span class="comment">// var articels = _articelService.LoadEntities(a=&gt;a.Title!.Contains(keyword));</span></span><br><span class="line">           <span class="built_in">int</span> totalCount = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="E:/netcore/WebApi/%E8%AE%B2%E4%B9%89/images/324.png"></p>
<p>当然，这里我们也完全可以定义一个<code>BaseParams.cs</code>封装公共的分页属性，然后让<code>ArticelParams</code>类继承<code>BaseParams</code></p>
<p><strong>怎样返回分页的数据？</strong></p>
<p>在前面我们只是将数据源返回到前端了，但是相关的分页信息我们也需要返回，因为前端在进行分页的时候，还需要使用相关的信息，例如总的记录，或者是总的页数等。</p>
<p>这里怎样将这些信息返回到前端呢？</p>
<p>这里可以将分页的信息放到响应头中返回，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span>  IActionResult <span class="title">GetArticel</span>(<span class="params">[FromQuery] ArticelParams articelParams</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">        <span class="comment">/*   articelParams.PageIndex = 1;</span></span><br><span class="line"><span class="comment">           articelParams.PageSize = 10;*/</span></span><br><span class="line">           <span class="comment">// var articels = _articelService.LoadEntities(a=&gt;a.Title!.Contains(keyword));</span></span><br><span class="line">           <span class="built_in">int</span> totalCount = <span class="number">0</span>;</span><br><span class="line">           ArticelSearch articelSearch = <span class="keyword">new</span> ArticelSearch()</span><br><span class="line">           &#123;</span><br><span class="line">               title = articelParams.title,</span><br><span class="line">               FormDatepicker = articelParams.FormDatepicker,</span><br><span class="line">               ToDatepicker = articelParams.ToDatepicker,</span><br><span class="line">               PageSize = articelParams.PageSize,</span><br><span class="line">               PageIndex = articelParams.PageIndex,</span><br><span class="line">               Order = articelParams.Order,</span><br><span class="line">               TotalCount = totalCount</span><br><span class="line">           &#125;;</span><br><span class="line">       </span><br><span class="line">           <span class="keyword">var</span> articels = _articelService.LoadSearchEntities(articelSearch,Convert.ToBoolean(DelFlagEnum.Normal));</span><br><span class="line">           <span class="keyword">if</span> (articelSearch.TotalCount &lt;= <span class="number">0</span>)</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">return</span> NotFound(<span class="string">&quot;没有找到文章&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">var</span> articelList = mapper.Map&lt;List&lt;ArticelDto&gt;&gt;(articels);</span><br><span class="line">    <span class="comment">// 这里添加了分页的信息，如下</span></span><br><span class="line">           <span class="keyword">var</span> paginationInfo = <span class="keyword">new</span> &#123;</span><br><span class="line">               totalCount = articelSearch.TotalCount,</span><br><span class="line">               pageSize = articelSearch.PageSize,</span><br><span class="line">               pageIndex = articelSearch.PageIndex,</span><br><span class="line">               totalPages =(<span class="built_in">int</span>)Math.Ceiling(articelSearch.TotalCount / (<span class="built_in">double</span>)articelSearch.PageSize)</span><br><span class="line">           &#125;;</span><br><span class="line">    <span class="comment">// 将分页的信息序列化json字符串后，写到`x-pagination`这个响应头中，然后返回到前端</span></span><br><span class="line">           HttpContext.Response.Headers.Add(<span class="string">&quot;x-pagination&quot;</span>, Newtonsoft.Json.JsonConvert.SerializeObject(paginationInfo));</span><br><span class="line">           <span class="keyword">return</span> Ok(articelList);</span><br><span class="line"></span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<h2 id="21、数据排序"><a href="#21、数据排序" class="headerlink" title="21、数据排序"></a>21、数据排序</h2><p>关于数据的排序，我们前面也实现了，但是我们当时将排序的字段固定死了，就是根据<code>ID</code>排序，但是很多的时候，我们需要指定不同的字段来进行排序。</p>
<p>这里我们会使用到一个包</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.Linq.Dynamic.Core</span><br></pre></td></tr></table></figure>

<p>这个包的作用：可以生成<code>Linq</code>查询表达式。</p>
<p>可以将传递过来的字符串，通过这个包转换成<code>Linq</code>查询表达式。</p>
<p>在访问排序的接口的时候，请求的地址形式如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/api/articels?orderBy=id,createTime desc</span><br></pre></td></tr></table></figure>

<p>为了对排序进行处理，这里我们为<code>IQueryable</code>接口进行了扩展，也就是为其定义了一个扩展的方法。</p>
<p>在<code>Cms.Repository</code>这个数据仓储项目中创建一个文件夹<code>Extensions</code>,在该文件夹下面创建一个<code>RepositoryExtensions.cs</code>类，该类中的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Reflection;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"><span class="keyword">using</span> System.Linq.Dynamic.Core; <span class="comment">// ---------------导入了对应的包</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.Repository.Extensions</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">RepositoryExtensions</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="title">IQueryable</span>&lt;<span class="title">T</span>&gt; <span class="title">OrderByQuery</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="keyword">this</span> IQueryable&lt;T&gt; queryable, <span class="built_in">string</span> queryString</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrEmpty(queryString))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> queryable;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// id,crateTime desc</span></span><br><span class="line">            <span class="keyword">var</span> orderParams = queryString.Trim().Split(<span class="string">&#x27;,&#x27;</span>);</span><br><span class="line">            <span class="comment">// 利用反射技术，获取要查询的模型中(实体类)的所有属性。</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> propertyInfos = <span class="keyword">typeof</span>(T).GetProperties(BindingFlags.Public | BindingFlags.Instance);</span><br><span class="line">            <span class="keyword">var</span> orderQueryBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> param <span class="keyword">in</span> orderParams)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 有可能传递过来的排序参数是： id,,crateTime desc 这种形式，这时候，通过分号分隔完，然后进行遍历，param就会出现空字符串的情况</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrEmpty(param))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 这里会按照空格继续分隔，因为按照前面的处理，会得到：crateTime desc.</span></span><br><span class="line">                <span class="comment">// 而排序的字段与排序方式之间是通过空格进行分割的。</span></span><br><span class="line">                <span class="comment">// 这时候propertyFromQueryName变量中存储的是crateTime,也就是排序的字段。</span></span><br><span class="line">                <span class="keyword">var</span> propertyFromQueryName = param.Split(<span class="string">&quot; &quot;</span>)[<span class="number">0</span>];</span><br><span class="line">                <span class="comment">// 前面通过反射获取到了实体类中所有的属性，这里又通过分割处理，获取到了排序的字段，看一下排序字段是否与实体类中的属性一致。如果不一致，则表示传递过来的搜索字段是错误的。</span></span><br><span class="line">                <span class="keyword">var</span> objectProperty = propertyInfos.FirstOrDefault(p =&gt; p.Name.Equals(propertyFromQueryName, StringComparison.InvariantCultureIgnoreCase));</span><br><span class="line">                <span class="keyword">if</span> (objectProperty == <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">var</span> sortingOrder = param.EndsWith(<span class="string">&quot; desc&quot;</span>) ? <span class="string">&quot;descending&quot;</span> : <span class="string">&quot;ascending&quot;</span>;</span><br><span class="line">                <span class="comment">// 这里还需要注意，两个&#123;&#125;括号之间是有空格的。</span></span><br><span class="line">                orderQueryBuilder.Append(<span class="string">$&quot;<span class="subst">&#123;objectProperty.Name&#125;</span> <span class="subst">&#123;sortingOrder&#125;</span>,&quot;</span>);  <span class="comment">// 注意：这里进行了逗号分割</span></span><br><span class="line"></span><br><span class="line">            &#125; <span class="comment">// 循环结束</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> orderQuery = orderQueryBuilder.ToString().TrimEnd(<span class="string">&#x27;,&#x27;</span>, <span class="string">&#x27; &#x27;</span>);<span class="comment">// 去掉最后的逗号</span></span><br><span class="line">            <span class="comment">// 调用  System.Linq.Dynamic.Core 包中的OrderBy方法，该方法需要的参数是字符串</span></span><br><span class="line">            <span class="keyword">return</span> queryable.OrderBy(orderQuery);  <span class="comment">// createTime descending</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>上面为<code>IQueryable</code>泛型接口定义了扩展方法<code>OrderByQuery</code>.下面看一下怎样调用该扩展方法。</p>
<p>我们可以在<code>ArticelService.cs</code>这个业务类中使用。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 多条件搜索</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;articelSearch&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;flag&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> IQueryable&lt;Articel&gt; <span class="title">LoadSearchEntities</span>(<span class="params">ArticelSearch articelSearch, <span class="built_in">bool</span> flag</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> temp = articelRepository.LoadEntities(a =&gt; a.DelFlag == flag);</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrEmpty(articelSearch.title))</span><br><span class="line">            &#123;</span><br><span class="line">                temp = temp.Where&lt;Articel&gt;(a =&gt; a.Title!.Contains(articelSearch.title));</span><br><span class="line">                <span class="comment">//  var d = temp.ToList();</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrEmpty(articelSearch.FormDatepicker))</span><br><span class="line">            &#123;</span><br><span class="line">                DateTime startDate = Convert.ToDateTime(articelSearch.FormDatepicker);</span><br><span class="line">                temp = temp.Where&lt;Articel&gt;(a =&gt; a.CreateTime &gt;= startDate);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrEmpty(articelSearch.ToDatepicker))</span><br><span class="line">            &#123;</span><br><span class="line">                DateTime endDate = Convert.ToDateTime((articelSearch.ToDatepicker));</span><br><span class="line">                temp = temp.Where&lt;Articel&gt;(a =&gt; a.CreateTime &lt;= endDate);</span><br><span class="line">            &#125;</span><br><span class="line">            articelSearch.TotalCount = temp.Count(); <span class="comment">// select count(*) from T_Articels where </span></span><br><span class="line"><span class="comment">//-----------------------------这里调用了扩展方法OrderByQuery</span></span><br><span class="line">            temp = temp.OrderByQuery&lt;Articel&gt;(articelSearch.OrderBy!).Skip&lt;Articel&gt;((articelSearch.PageIndex - <span class="number">1</span>) * articelSearch.PageSize).Take&lt;Articel&gt;(articelSearch.PageSize);</span><br><span class="line">            <span class="comment">/* if (articelSearch.Order)</span></span><br><span class="line"><span class="comment">             &#123;</span></span><br><span class="line"><span class="comment">                 temp = temp.OrderBy&lt;Articel, long&gt;(a =&gt; a.Id).Skip&lt;Articel&gt;((articelSearch.PageIndex - 1) * articelSearch.PageSize).Take&lt;Articel&gt;(articelSearch.PageSize);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">             &#125;</span></span><br><span class="line"><span class="comment">             else</span></span><br><span class="line"><span class="comment">             &#123;</span></span><br><span class="line"><span class="comment">                 temp = temp.OrderByDescending&lt;Articel, long&gt;(a =&gt; a.Id).Skip&lt;Articel&gt;((articelSearch.PageIndex - 1) * articelSearch.PageSize).Take&lt;Articel&gt;(articelSearch.PageSize);</span></span><br><span class="line"><span class="comment">                 //   var data = temp.Count();</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">             &#125;*/</span></span><br><span class="line">            <span class="keyword">return</span> temp;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>在对应的分页方法中调用了排序的扩展方法。</p>
<p>在调用扩展方法<code>OrderByQuery</code>的时候，需要传递参数，这个参数就是排序的字段与排序方式，类型是字符串。</p>
<p>当然，需要<code>ArticelSearch.cs</code>类中定义<code>OrderBy</code>属性。当然定义到了其父类<code>BaseSearch.cs</code>中。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BaseSearch</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> PageIndex &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> PageSize &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> TotalCount &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">bool</span> Order &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? OrderBy &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>下面修改<code>ArticelsController.cs</code>控制器中的<code>GetArticels</code>方法中的代码，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">GetArticels</span>(<span class="params">[FromQuery] ArticelParams articelParams</span>)</span></span><br><span class="line">      &#123;</span><br><span class="line">          <span class="built_in">int</span> pageIndex = articelParams.PageIndex == <span class="number">0</span> ? <span class="number">1</span> : articelParams.PageIndex;</span><br><span class="line">          <span class="built_in">int</span> pageSize = articelParams.PageSize == <span class="number">0</span> ? <span class="number">2</span> : articelParams.PageSize;</span><br><span class="line">          <span class="built_in">int</span> totalCount = <span class="number">0</span>;</span><br><span class="line">          ArticelSearch articelSearch = <span class="keyword">new</span> ArticelSearch()</span><br><span class="line">          &#123;</span><br><span class="line">              FormDatepicker = articelParams.FormDatepicker,</span><br><span class="line">              Order = articelParams.Order,</span><br><span class="line">              PageIndex = pageIndex,</span><br><span class="line">              PageSize = pageSize,</span><br><span class="line">              title = articelParams.title,</span><br><span class="line">              ToDatepicker = articelParams.ToDatepicker,</span><br><span class="line">              TotalCount = totalCount,</span><br><span class="line">              OrderBy = articelParams.OrderBy, <span class="comment">//--------- 将ArticelParams对象中的OrderBy属性值赋值给了ArticelSearch对象中的OrderByS属性。</span></span><br><span class="line"></span><br><span class="line">          &#125;;</span><br></pre></td></tr></table></figure>

<p>下面，修改<code>ArticelParams</code>类。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ArticelParams</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? title &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? FormDatepicker &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? ToDatepicker &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> PageIndex &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> PageSize &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">bool</span> Order &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? Fields &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? OrderBy &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;<span class="comment">//--------------添加OrderBy属性。</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>返回到浏览器中进行测试。</p>
<h2 id="22、数据塑形"><a href="#22、数据塑形" class="headerlink" title="22、数据塑形"></a>22、数据塑形</h2><h3 id="22-1-什么是数据塑形？"><a href="#22-1-什么是数据塑形？" class="headerlink" title="22.1 什么是数据塑形？"></a>22.1 什么是数据塑形？</h3><p>所谓的数据塑性：就是客户端可以<strong>定制化</strong>选择后端输出数据的技术。</p>
<p>例如：针对用户信息，只希望返回，用户名和邮箱，这时候的<code>api</code>地址就可以采用如下的形式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/api/users?fields =username,useremail</span><br></pre></td></tr></table></figure>

<p>数据塑性可以极大的提高数据处理的能力。例如：<code>用户</code>有20个字段，每次展示50条数据，这样就是1000条数据，</p>
<p>如果只传递以上两个字段，只需要传输的数据就是100条</p>
<h3 id="22-2-处理动态类型对象"><a href="#22-2-处理动态类型对象" class="headerlink" title="22.2 处理动态类型对象"></a>22.2 处理动态类型对象</h3><p>下面我们来看一下，	<code>ArticelsController.cs</code>控制器中的<code>GetArticel</code>方法，该方法返回的<code>List&lt;ArticelDto&gt;</code>.</p>
<p>但是经过数据的塑性以后，我们不再返回<code>ArticelDto</code>,而是返回一个仅仅包含所需要的字段的对象来代替。</p>
<p>我们会在程序运行的时候，根据<code>ArticelDto</code>来动态创建这个对象。</p>
<p>在这一小节中，我们会处理动态类型对象<code>dynamic object</code></p>
<p><code>ExpandoObject</code> 是专为动态类型封装的类型,是对动态类型对象的处理。可以在程序运行的时候，动态的添加或者是删除一个类的成员变量。也就是可以动态的处理对象的字段。而动态处理对象字段，就是数据塑性需要具有的能力。</p>
<p>在<code>Cms.WebApi</code>项目中创建<code>Helper</code>目录，在该目录下面创建<code>IEnumerableExtensions.cs</code>,该类是对<code>IEnumerable</code>类型的扩展，从而实现数据的塑性。</p>
<p>该类中的代码，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Dynamic;</span><br><span class="line"><span class="keyword">using</span> System.Reflection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.WebApi.Helper</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 这里是对IEnumerable的拓展，同时定义的类必须是static</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">IEnumerableExtensions</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 创建拓展的函数，必须是静态的</span></span><br><span class="line">        <span class="comment">// 拓展的是IEnumerable，列表返回的类型是ExpandoObject</span></span><br><span class="line">        <span class="comment">// 第一个参数是数据源，需要添加this</span></span><br><span class="line">        <span class="comment">// 第二个参数需要塑性后输出的字段的名称</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="title">IEnumerable</span>&lt;<span class="title">ExpandoObject</span>&gt;<span class="title">ShapeDatad</span>&lt;<span class="title">TSource</span>&gt;(<span class="params"><span class="keyword">this</span> IEnumerable&lt;TSource&gt; source,<span class="built_in">string</span> fields</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(source == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="string">&quot;source&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 创建一个集合用来存储动态类型</span></span><br><span class="line">            <span class="keyword">var</span> expandoObjectList = <span class="keyword">new</span> List&lt;ExpandoObject&gt;();</span><br><span class="line">            <span class="comment">// 为了获取对应的字段，需要使用反射机制。</span></span><br><span class="line">            <span class="comment">// 这里会创建一个属性的信息列表</span></span><br><span class="line">            <span class="comment">// PropertyInfo：会包含对象中的所有属性的信息</span></span><br><span class="line">            <span class="keyword">var</span> propertyInfoList = <span class="keyword">new</span> List&lt;PropertyInfo&gt;();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrWhiteSpace(fields))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 如果这里没有指定塑性后输出的字段的名称，这里我们就返回动态类型对象ExpandoObject的所有属性。</span></span><br><span class="line">                <span class="comment">// 首选获取数据源类型TSource的类型，然后通过PropertyInfo获取数据源中所有属性的信息</span></span><br><span class="line">                <span class="comment">// 获取属性的信息的时候，忽略大小写，获取的是公共的，并且是非静态类，</span></span><br><span class="line">                <span class="keyword">var</span> propertyInfos = <span class="keyword">typeof</span>(TSource).GetProperties(BindingFlags.IgnoreCase|BindingFlags.Public|BindingFlags.Instance);</span><br><span class="line"></span><br><span class="line">                propertyInfoList.AddRange(propertyInfos);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 使用逗号分割字符串</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">var</span> fieldsAfterSplit = fields.Split(<span class="string">&#x27;,&#x27;</span>);</span><br><span class="line">                <span class="keyword">foreach</span> ( <span class="keyword">var</span> field <span class="keyword">in</span> fieldsAfterSplit)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 去掉首位多余的空格，获取的属性名称</span></span><br><span class="line">                    <span class="keyword">var</span> propertyName = field.Trim();</span><br><span class="line">                    <span class="comment">// 获取到属性名以后，就可以获取该属性对应的信息了</span></span><br><span class="line"></span><br><span class="line">                    <span class="keyword">var</span> propertyInfo = <span class="keyword">typeof</span>(TSource).GetProperty(propertyName, BindingFlags.IgnoreCase | BindingFlags.Public | BindingFlags.Instance);</span><br><span class="line">                    <span class="keyword">if</span> (propertyInfo == <span class="literal">null</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">$&quot;属性<span class="subst">&#123;propertyName&#125;</span>找不到&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    propertyInfoList.Add(propertyInfo);</span><br><span class="line">                &#125;</span><br><span class="line">              </span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">              <span class="comment">// 下面遍历数据源</span></span><br><span class="line">                <span class="keyword">foreach</span>(TSource sourceObject <span class="keyword">in</span> source)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 创建动态类型对象，创建数据塑性对象</span></span><br><span class="line">                    <span class="keyword">var</span> dataShapedObject = <span class="keyword">new</span> ExpandoObject();</span><br><span class="line">                   <span class="keyword">foreach</span> ( <span class="keyword">var</span> propertyInfo <span class="keyword">in</span> propertyInfoList)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="comment">// 获得对应属性的真实数据,并且添加到字典集合中</span></span><br><span class="line">                        <span class="keyword">var</span> propertyValue = propertyInfo.GetValue(sourceObject);</span><br><span class="line">                        ((IDictionary&lt;<span class="built_in">string</span>,<span class="built_in">object</span>&gt;)dataShapedObject!).Add(propertyInfo.Name, propertyValue!);</span><br><span class="line">                    &#125;</span><br><span class="line">                   expandoObjectList.Add(dataShapedObject);</span><br><span class="line">                &#125;</span><br><span class="line">             </span><br><span class="line"></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> expandoObjectList;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>下面修改<code>ResourceParams/ArticelParams.cs</code>中的代码</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">bool</span> Order &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 该属性接收的是要展示的字段</span></span><br><span class="line">      <span class="keyword">public</span> <span class="built_in">string</span>? Fields &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>这里添加了<code>Fields</code>属性，通过该属性接收前端传递过来的要展示的字段的名称。</p>
<p>下面修改<code>ArticelsController.cs</code>控制器中的代码</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HttpContext.Response.Headers.Add(<span class="string">&quot;x-pagination&quot;</span>, Newtonsoft.Json.JsonConvert.SerializeObject(paginationInfo));</span><br><span class="line">            <span class="keyword">return</span> Ok(articelList.ShapeDatad(articelParams.Fields!));<span class="comment">//这里接收到前端传递过来的要展示的字段，然后传递到ShapeDatad方法中进行数据的塑性，这里是`IEnumerable`的扩展方法，所以可以直接调用。</span></span><br></pre></td></tr></table></figure>

<h3 id="22-3-单一资源的塑形"><a href="#22-3-单一资源的塑形" class="headerlink" title="22.3 单一资源的塑形"></a>22.3 单一资源的塑形</h3><p>在上一小节中，我们扩展了<code>IEnumerable</code>，实现了对集合的塑性。</p>
<p>在这一小节中，我们实现对单一资源的塑性。</p>
<p>同样在<code>Cms.WebApi</code>项目的<code>Helper</code>文件夹中创建<code>ObjectExtensions.cs</code>，该类中的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">ObjectExtensions</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExpandoObject <span class="title">ShapeData</span>&lt;<span class="title">TSource</span>&gt;(<span class="params"><span class="keyword">this</span> TSource source,<span class="built_in">string</span> fields</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">if</span>(source == <span class="literal">null</span>)</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="string">&quot;source&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">var</span> dataShapedObject = <span class="keyword">new</span> ExpandoObject();</span><br><span class="line">           <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrWhiteSpace(fields))</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">var</span> propertyInfos = <span class="keyword">typeof</span>(TSource).GetProperties(BindingFlags.IgnoreCase|BindingFlags.Public|BindingFlags.Instance);</span><br><span class="line">               <span class="keyword">foreach</span>( <span class="keyword">var</span> propertyInfo <span class="keyword">in</span> propertyInfos)</span><br><span class="line">               &#123;</span><br><span class="line">                   <span class="keyword">var</span> propertyValue = propertyInfo.GetValue(source);</span><br><span class="line">                   ((IDictionary&lt;<span class="built_in">string</span>,<span class="built_in">object</span>&gt;)dataShapedObject!).Add(propertyInfo.Name, propertyValue!);</span><br><span class="line"></span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">return</span> dataShapedObject;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">var</span> fieldsAfterSplit = fields.Split(<span class="string">&#x27;,&#x27;</span>);</span><br><span class="line">           <span class="keyword">foreach</span> (<span class="keyword">var</span> field <span class="keyword">in</span> fieldsAfterSplit)</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="comment">// trim each field, as it might contain leading </span></span><br><span class="line">               <span class="comment">// or trailing spaces. Can&#x27;t trim the var in foreach,</span></span><br><span class="line">               <span class="comment">// so use another var.</span></span><br><span class="line">               <span class="keyword">var</span> propertyName = field.Trim();</span><br><span class="line"></span><br><span class="line">               <span class="comment">// use reflection to get the property on the source object</span></span><br><span class="line">               <span class="comment">// we need to include public and instance, b/c specifying a </span></span><br><span class="line">               <span class="comment">// binding flag overwrites the already-existing binding flags.</span></span><br><span class="line">               <span class="keyword">var</span> propertyInfo = <span class="keyword">typeof</span>(TSource)</span><br><span class="line">                   .GetProperty(propertyName,</span><br><span class="line">                   BindingFlags.IgnoreCase | BindingFlags.Public | BindingFlags.Instance);</span><br><span class="line"></span><br><span class="line">               <span class="keyword">if</span> (propertyInfo == <span class="literal">null</span>)</span><br><span class="line">               &#123;</span><br><span class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">$&quot;Property <span class="subst">&#123;propertyName&#125;</span> wasn&#x27;t found &quot;</span> +</span><br><span class="line">                       <span class="string">$&quot;on <span class="subst">&#123;<span class="keyword">typeof</span>(TSource)&#125;</span>&quot;</span>);</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="comment">// get the value of the property on the source object</span></span><br><span class="line">               <span class="keyword">var</span> propertyValue = propertyInfo.GetValue(source);</span><br><span class="line"></span><br><span class="line">               <span class="comment">// add the field to the ExpandoObject</span></span><br><span class="line">               ((IDictionary&lt;<span class="built_in">string</span>, <span class="built_in">object</span>&gt;)dataShapedObject!)</span><br><span class="line">                   .Add(propertyInfo.Name, propertyValue!);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> dataShapedObject;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>这里是对<code>object</code>对象的扩展。（因为这里是对单一的资源对象进行数据的塑性）</p>
<p>这里单独创建一个类来实现单一资源的数据塑性的原因是：职责明确，再有方便管理，性能高。</p>
<p>下面我们返回的到<code>UsersController.cs</code>控制器中进行测试。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">GetUser</span>(<span class="params"><span class="built_in">int</span> id,<span class="built_in">string</span> fields</span>) <span class="comment">//------------------- 添加fields参数</span></span></span><br><span class="line">       &#123;</span><br><span class="line">          <span class="comment">// Console.WriteLine(&quot;AppDomain==&quot;+ AppDomain.CurrentDomain);//Cms.WebApi</span></span><br><span class="line">         <span class="comment">/* foreach(var assembly in AppDomain.CurrentDomain.GetAssemblies())</span></span><br><span class="line"><span class="comment">           &#123;</span></span><br><span class="line"><span class="comment">               Console.WriteLine(assembly.FullName); // 打印的是当前Cms.WebApi所引用的所有程序集</span></span><br><span class="line"><span class="comment">           &#125;*/</span></span><br><span class="line">           <span class="keyword">var</span> user = <span class="keyword">await</span> _userInfoService.LoadEntities(u=&gt;u.Id==id).FirstOrDefaultAsync();</span><br><span class="line">           <span class="keyword">var</span> userDTO = mapper.Map&lt;UserInfoDto&gt;(user);</span><br><span class="line">           <span class="keyword">if</span>(user == <span class="literal">null</span>)</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">return</span> NotFound(<span class="string">$&quot;编号为<span class="subst">&#123;id&#125;</span>的用户不存在!!&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> Ok(userDTO.ShapeData(fields)); <span class="comment">// ----------------------调用`ShapeData`方法对数据进行塑性</span></span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p><code>GetUser</code>方法，是根据用户传递过来的<code>id</code>，查询单一用户的方法，所以这里我们又给其添加了一个参数<code>fields</code>,接收前端传递过来的需要展示的字段。</p>
<p>启动项目进行测试。（多个字段名之间使用逗号进行分割）</p>
<h3 id="22-4-数据塑形错误的处理"><a href="#22-4-数据塑形错误的处理" class="headerlink" title="22.4 数据塑形错误的处理"></a>22.4 数据塑形错误的处理</h3><p>当前端给<code>fields</code>参数传递的是不存在的字段的时候，服务端的程序会出现500的错误。</p>
<p>但是，这种情况是前端输入错误，应该给出400的状态码，同时给出相应的错误提示。</p>
<p>具体的处理方式如下所示：</p>
<p>在<code>Helper</code>目录下面创建<code>PropertyCheck.cs</code>类，该类中的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PropertyCheck</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">IsPropertiesExists</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="built_in">string</span> fields</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 如果前端没有输入任何字段，表示的就是直接返回dto对象，所以这里就不需要向下处理了，直接返回true</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrWhiteSpace(fields))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果前端用户输入了字段，那么这里使用逗号来分割字段的字符串</span></span><br><span class="line">            <span class="keyword">var</span> fieldsAfterSplit = fields.Split(<span class="string">&#x27;,&#x27;</span>);</span><br><span class="line">            <span class="keyword">foreach</span> ( <span class="keyword">var</span> field <span class="keyword">in</span> fieldsAfterSplit )</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 前端用户在输入字段的名称的时候，有可能输入了空格，所以这里需要去掉空格，然后获取属性名称(当然这个属性名是字符串)</span></span><br><span class="line">                <span class="keyword">var</span> propertyName = field.Trim();</span><br><span class="line">                <span class="comment">// 使用反射技术，来获取对象中某个属性的信息</span></span><br><span class="line">                <span class="keyword">var</span> propertyInfo = <span class="keyword">typeof</span>(T).GetProperty(propertyName,BindingFlags.Public|BindingFlags.IgnoreCase|BindingFlags.Instance);</span><br><span class="line">                <span class="comment">// 如果泛型T所表示的对象中，没有找到对应的属性信息，直接返回false</span></span><br><span class="line">                <span class="keyword">if</span> (propertyInfo == <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果循环执行完毕以后，所有的属性验证都没有问题，表示前端用户输入的字段信息是合法的。</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>返回到<code>UsersController.cs</code>控制器中的<code>GetUser</code>这个方法进行测试，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">HttpGet(<span class="string">&quot;&#123;id&#125;&quot;</span>,Name =<span class="string">&quot;GetUser&quot;</span>)</span>]</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">GetUser</span>(<span class="params"><span class="built_in">int</span> id,<span class="built_in">string</span> fields</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="comment">// Console.WriteLine(&quot;AppDomain==&quot;+ AppDomain.CurrentDomain);//Cms.WebApi</span></span><br><span class="line">           <span class="comment">/* foreach(var assembly in AppDomain.CurrentDomain.GetAssemblies())</span></span><br><span class="line"><span class="comment">             &#123;</span></span><br><span class="line"><span class="comment">                 Console.WriteLine(assembly.FullName); // 打印的是当前Cms.WebApi所引用的所有程序集</span></span><br><span class="line"><span class="comment">             &#125;*/</span></span><br><span class="line">           <span class="comment">// ---------------------------这里添加了对前端传递过来的字段的校验，如果校验不通过，返回400的状态码------------------------------------------------------------</span></span><br><span class="line">           <span class="keyword">if</span> (!PropertyCheck.IsPropertiesExists&lt;UserInfoDto&gt;(fields))</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">return</span> BadRequest(<span class="string">&quot;传递的字段是错误的!&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">var</span> user = <span class="keyword">await</span> _userInfoService.LoadEntities(u=&gt;u.Id==id).FirstOrDefaultAsync();</span><br><span class="line">           <span class="keyword">var</span> userDTO = mapper.Map&lt;UserInfoDto&gt;(user);</span><br><span class="line">           <span class="keyword">if</span>(user == <span class="literal">null</span>)</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">return</span> NotFound(<span class="string">$&quot;编号为<span class="subst">&#123;id&#125;</span>的用户不存在!!&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> Ok(userDTO.ShapeData(fields));</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>启动项目进行测试。</p>
<h2 id="23、HATEOAS应用"><a href="#23、HATEOAS应用" class="headerlink" title="23、HATEOAS应用"></a>23、<code>HATEOAS</code>应用</h2><h3 id="23-1-HATEOAS介绍"><a href="#23-1-HATEOAS介绍" class="headerlink" title="23.1 HATEOAS介绍"></a>23.1 <code>HATEOAS</code>介绍</h3><p><code>hateoas</code>是<code>rest</code>架构风格中最复杂的约束，也是构建成熟<code>rest</code>服务的核心，它的重要性在于打破了客户端和服务器之间严格的契约，使得客户端可以更加智能和自适应，而<code>Rest</code>服务本身的演化和更新也变得更加容易。</p>
<p><code>hateoas</code>:<code>Hypermedia as the engine of application state</code>(超媒体即应用状态引擎)</p>
<p><code>hateoas</code>核心思想：在响应中包含其他资源的链接，客户端可以使用这些链接与服务器进行交互。</p>
<p>下面通过一个例子来体会一下<code>heateoas</code></p>
<p>在返回的资源中添加了<code>Links</code>属性，表示可以对该资源还可以进行哪些操作。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;userName&quot;</span><span class="punctuation">:</span><span class="string">&quot;zhangsan&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;userEmail&quot;</span><span class="punctuation">:</span><span class="string">&quot;zhangsan@126.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Links&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;href&quot;</span><span class="punctuation">:</span><span class="string">&quot;https://localhost:5050/api/users/1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;rel&quot;</span><span class="punctuation">:</span><span class="string">&quot;self&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span><span class="string">&quot;Get&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;href&quot;</span><span class="punctuation">:</span><span class="string">&quot;https://localhost:5050/api/users/1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;rel&quot;</span><span class="punctuation">:</span><span class="string">&quot;更新&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span><span class="string">&quot;Put&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;href&quot;</span><span class="punctuation">:</span><span class="string">&quot;https://localhost:5050/api/users/1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;rel&quot;</span><span class="punctuation">:</span><span class="string">&quot;局部更新&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span><span class="string">&quot;PATCH&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">         <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;href&quot;</span><span class="punctuation">:</span><span class="string">&quot;https://localhost:5050/api/users/1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;rel&quot;</span><span class="punctuation">:</span><span class="string">&quot;删除&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span><span class="string">&quot;Delete&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><code>Links</code>中的这些链接返回到前端以后，前端可以直接使用。</p>
<p>这样做的好处，就是服务端可以根据实际的情况，返回<code>Links</code>，例如：后端可以根据用户具有的不同的权限，在<code>Links</code>中返回不同的链接，这样前端可以根据<code>Links</code>中的链接向服务端发送请求，前端不需要参考任何的接口文档。</p>
<p><code>Link</code>是<code>HATEOAS</code>的核心</p>
<p><code>Link</code>中的三个成员的含义：</p>
<p><code>href</code>:表示的是资源的地址。</p>
<p><code>rel</code>: 用来描述资源和<code>url</code>的关系。例如：<code>self</code>:表示了<code>url</code>自我描述的关系。</p>
<p><code>method</code>:表示的是访问资源对应的方法。</p>
<p>当然<code>Links</code>中的内容是根据业务来定义的。</p>
<h3 id="23-2-处理单一资源"><a href="#23-2-处理单一资源" class="headerlink" title="23.2 处理单一资源"></a>23.2 处理单一资源</h3><p>在<code>Dtos</code>目录中创建<code>LinkDto.cs</code>类，在该类中定义<code>Link</code>中的核心成员，代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.WebApi.Dtos</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">LinkDto</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? Href &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? Rel &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? Method &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="comment">// 通过构造方法，为定义的属性赋值</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">LinkDto</span>(<span class="params"><span class="built_in">string</span> href,<span class="built_in">string</span> rel,<span class="built_in">string</span> method</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Href = href;</span><br><span class="line">           Rel = rel;</span><br><span class="line">            Method = method;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>下面修改<code>UsersController.cs</code>中的代码，如下所示：</p>
<p>在控制器的<code>GetUser</code>方法的下面定义<code>CreateLinkForUsers</code>方法，</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建hatoeas的Links数组</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> IEnumerable&lt;LinkDto&gt; <span class="title">CreateLinkForUsers</span>(<span class="params"><span class="built_in">int</span> id,<span class="built_in">string</span> fields</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> links = <span class="keyword">new</span> List&lt;LinkDto&gt;();</span><br><span class="line">    links.Add(<span class="keyword">new</span> LinkDto(Url.Link(<span class="string">&quot;GetUser&quot;</span>,<span class="keyword">new</span> &#123;id,fields &#125;)!,<span class="string">&quot;self&quot;</span>,<span class="string">&quot;GET&quot;</span>)); <span class="comment">// self:表示自身</span></span><br><span class="line">    <span class="built_in">int</span> userId = id; <span class="comment">// 这里一定要将id参数赋值给userId变量，原因是下面创建href的时候，所指定的方法，例如EditUser,UpdateUser,DeleteUser等，所需要的参数是userId.如果这里不赋值给userId,无法创建herf属性所需要的地址。</span></span><br><span class="line">    <span class="comment">// 更新</span></span><br><span class="line">    links.Add(<span class="keyword">new</span> LinkDto(Url.Link(<span class="string">&quot;EditUser&quot;</span>, <span class="keyword">new</span> &#123; userId &#125;)!, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;PUT&quot;</span>));</span><br><span class="line">    <span class="comment">// 局部更新</span></span><br><span class="line">    links.Add(<span class="keyword">new</span> LinkDto(Url.Link(<span class="string">&quot;UpdateUser&quot;</span>, <span class="keyword">new</span> &#123; userId &#125;)!, <span class="string">&quot;update_patch&quot;</span>, <span class="string">&quot;PATCH&quot;</span>));</span><br><span class="line">    <span class="comment">// 删除</span></span><br><span class="line">    links.Add(<span class="keyword">new</span> LinkDto(Url.Link(<span class="string">&quot;DeleteUser&quot;</span>, <span class="keyword">new</span> &#123; userId &#125;)!,<span class="string">&quot;delete&quot;</span>,<span class="string">&quot;Delete&quot;</span>));</span><br><span class="line">    <span class="comment">// 获取用户发布的文章</span></span><br><span class="line">    links.Add(<span class="keyword">new</span> LinkDto(Url.Link(<span class="string">&quot;GetArticelForUser&quot;</span>, <span class="keyword">new</span> &#123; userId &#125;)!, <span class="string">&quot;get_articels&quot;</span>, <span class="string">&quot;GET&quot;</span>));</span><br><span class="line">    <span class="keyword">return</span> links;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在<code>CreateLinkForUsers</code>方法中，创建一个一个的<code>LinkDto</code>对象，然后添加到<code>links</code>这个<code>List</code>集合中。</p>
<p>在创建<code>LinkDto</code>这个对象的时候，在确定<code>Href</code>这个属性的值的时候，是通过<code>.net core</code>中内置的<code>Url.Link</code>方法来创建的，该方法的第一个参数是方法对应的路由的名字。</p>
<p>所以说，在<code>GetUser</code>方法对应的<code>HttpGet</code>中指定了<code>Name</code>属性，取值就是<code>GetUser</code>.</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">HttpGet(<span class="string">&quot;&#123;id&#125;&quot;</span>,Name =<span class="string">&quot;GetUser&quot;</span>)</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">GetUser</span>(<span class="params"><span class="built_in">int</span> id,<span class="built_in">string</span> fields</span>)</span></span><br><span class="line">&#123;</span><br></pre></td></tr></table></figure>

<p>下面对应的给其他的方法添加相应的<code>name</code>属性值</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 获取某个用户发布的文章</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;userId&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">       [<span class="meta">HttpGet(<span class="string">&quot;&#123;userId&#125;/articels&quot;</span>,Name = <span class="string">&quot;GetArticelForUser&quot;</span>)</span>]</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">GetArticelForUser</span>(<span class="params"><span class="built_in">int</span> userId</span>)</span></span><br><span class="line">       &#123;</span><br></pre></td></tr></table></figure>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> 更新用户信息     </span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;userId&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;userInfoForUpdateDto&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">      [<span class="meta">HttpPut(<span class="string">&quot;&#123;userId&#125;&quot;</span>,Name =<span class="string">&quot;EditUser&quot;</span>)</span>]</span><br><span class="line">      [<span class="meta">UnitOfWork(new Type[</span>] &#123; <span class="keyword">typeof</span>(MyDbContext) &#125;)]</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">EditUser</span>(<span class="params">[FromRoute]<span class="built_in">int</span> userId, [FromBody]UserInfoForUpdateDto userInfoForUpdateDto</span>)</span></span><br><span class="line">      &#123;</span><br></pre></td></tr></table></figure>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 部分更新用户信息</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;userId&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;patchDocument&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    [<span class="meta">HttpPatch(<span class="string">&quot;&#123;userId&#125;&quot;</span>,Name = <span class="string">&quot;UpdateUser&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">UnitOfWork(new Type[</span>] &#123; <span class="keyword">typeof</span>(MyDbContext) &#125;)]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">UpdateUser</span>(<span class="params">[FromRoute] <span class="built_in">int</span> userId, [FromBody] JsonPatchDocument&lt;UserInfoForUpdateDto&gt; patchDocument</span>)</span></span><br><span class="line">    &#123;</span><br></pre></td></tr></table></figure>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> 删除用户</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;userId&quot;&gt;</span>要删除的用户编号<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">      [<span class="meta">HttpDelete(<span class="string">&quot;&#123;userId&#125;&quot;</span>,Name =<span class="string">&quot;DeleteUser&quot;</span>)</span>]</span><br><span class="line">      [<span class="meta">UnitOfWork(new Type[</span>] &#123; <span class="keyword">typeof</span>(MyDbContext) &#125;)]</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">DeleteUser</span>(<span class="params">[FromRoute]<span class="built_in">int</span> userId</span>)</span></span><br><span class="line">      &#123;</span><br></pre></td></tr></table></figure>

<p>问题：在什么位置调用<code>CreateLinkForUsers这个方法呢？</code></p>
<p>这一次是对单一资源的处理，所以这里是在<code>GetUser</code>这个方法中进行调用的。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">HttpGet(<span class="string">&quot;&#123;id&#125;&quot;</span>,Name =<span class="string">&quot;GetUser&quot;</span>)</span>]</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">GetUser</span>(<span class="params"><span class="built_in">int</span> id,<span class="built_in">string</span> fields</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="comment">// Console.WriteLine(&quot;AppDomain==&quot;+ AppDomain.CurrentDomain);//Cms.WebApi</span></span><br><span class="line">           <span class="comment">/* foreach(var assembly in AppDomain.CurrentDomain.GetAssemblies())</span></span><br><span class="line"><span class="comment">             &#123;</span></span><br><span class="line"><span class="comment">                 Console.WriteLine(assembly.FullName); // 打印的是当前Cms.WebApi所引用的所有程序集</span></span><br><span class="line"><span class="comment">             &#125;*/</span></span><br><span class="line">           <span class="keyword">if</span> (!PropertyCheck.IsPropertiesExists&lt;UserInfoDto&gt;(fields))</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">return</span> BadRequest(<span class="string">&quot;传递的字段是错误的!&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">var</span> user = <span class="keyword">await</span> _userInfoService.LoadEntities(u=&gt;u.Id==id).FirstOrDefaultAsync();</span><br><span class="line">           <span class="keyword">var</span> userDTO = mapper.Map&lt;UserInfoDto&gt;(user);</span><br><span class="line">           <span class="keyword">if</span>(user == <span class="literal">null</span>)</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">return</span> NotFound(<span class="string">$&quot;编号为<span class="subst">&#123;id&#125;</span>的用户不存在!!&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">/*  return Ok(userDTO.ShapeData(fields));*/</span></span><br><span class="line">           </span><br><span class="line">           <span class="comment">//---------------------调用CreateLinkForUsers这个方法-----------------</span></span><br><span class="line">           <span class="keyword">var</span> linkDtos = CreateLinkForUsers(id,fields);</span><br><span class="line">           <span class="comment">// 对数据进行塑形，并且转成字典集合</span></span><br><span class="line">           <span class="keyword">var</span> result= userDTO.ShapeData(fields)<span class="keyword">as</span> IDictionary&lt;<span class="built_in">string</span>, <span class="built_in">object</span>&gt;;</span><br><span class="line">           <span class="comment">// 把links添加到字典集合中</span></span><br><span class="line">           result.Add(<span class="string">&quot;links&quot;</span>, linkDtos);</span><br><span class="line">           <span class="keyword">return</span> Ok(result);</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>启动项目进行测试。在返回的响应报文中包含了<code>links</code></p>
<p>23.2 <code>post</code>请求的处理</p>
<p>我们知道，当创建一个用户的时候，会执行如下的<code>CreatUser</code>方法。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 创建用户: http://localhost:5154/api/Users</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">       [<span class="meta">HttpPost(Name =<span class="string">&quot;CreateUser&quot;</span>)</span>]</span><br><span class="line">       [<span class="meta">Authorize</span>]</span><br><span class="line">       [<span class="meta">UnitOfWork(new Type[</span>] &#123; <span class="keyword">typeof</span>(MyDbContext) &#125;)]</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">CreatUser</span>(<span class="params">[FromBody]UserInfoCreateDto userInfoCreateDto</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">          </span><br><span class="line">           <span class="keyword">var</span> userInfoModel = mapper.Map&lt;UserInfo&gt;(userInfoCreateDto);</span><br><span class="line">           <span class="keyword">await</span> _userInfoService.InsertEntityAsync(userInfoModel);</span><br><span class="line">           <span class="keyword">var</span> user = mapper.Map&lt;UserInfoDto&gt;(userInfoModel);</span><br><span class="line">           <span class="comment">// return CreatedAtRoute(&quot;GetUser&quot;,new &#123;id =user.Id &#125;,user); // 返回</span></span><br><span class="line">           <span class="keyword">return</span> CreatedAtAction(<span class="string">&quot;GetAllUsers&quot;</span>, user);</span><br><span class="line">          </span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>我们这里可以看到，当创建完一个用户以后，最终返回的是一个所创建的用户的信息。</p>
<p>所以这里给<code>post</code>请求，添加<code>links</code>，也是很有必要的。</p>
<p>下面修改<code>CreateUser</code>方法，代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 创建用户: http://localhost:5154/api/Users</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">       [<span class="meta">HttpPost(Name =<span class="string">&quot;CreateUser&quot;</span>)</span>]</span><br><span class="line">       [<span class="meta">Authorize</span>]</span><br><span class="line">       [<span class="meta">UnitOfWork(new Type[</span>] &#123; <span class="keyword">typeof</span>(MyDbContext) &#125;)]</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">CreatUser</span>(<span class="params">[FromBody]UserInfoCreateDto userInfoCreateDto</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">          </span><br><span class="line">           <span class="keyword">var</span> userInfoModel = mapper.Map&lt;UserInfo&gt;(userInfoCreateDto);</span><br><span class="line">           <span class="keyword">await</span> _userInfoService.InsertEntityAsync(userInfoModel);</span><br><span class="line">           <span class="keyword">var</span> user = mapper.Map&lt;UserInfoDto&gt;(userInfoModel);</span><br><span class="line">           <span class="comment">// return CreatedAtRoute(&quot;GetUser&quot;,new &#123;id =user.Id &#125;,user); // 返回</span></span><br><span class="line">           <span class="comment">//--------------------------这里调用CreateLinkForUsers方法，获取links数组---------------------------</span></span><br><span class="line">           <span class="comment">// 这里不需要进行数据的塑形，所以第二个参数传递的是null</span></span><br><span class="line">           <span class="keyword">var</span> links = CreateLinkForUsers( Convert.ToInt32(userInfoModel.Id), <span class="literal">null</span>!);</span><br><span class="line">           <span class="comment">//------------------------这里不需要进行数据的塑形，所以给ShapeData方法传递的参数是null,同时这里也是转换成字典的集合</span></span><br><span class="line">           <span class="keyword">var</span> result = user.ShapeData(<span class="literal">null</span>!) <span class="keyword">as</span> IDictionary&lt;<span class="built_in">string</span>, <span class="built_in">object</span>&gt;;</span><br><span class="line">           <span class="comment">//------------------------------这里把`links`添加到字典的集合中</span></span><br><span class="line">           result.Add(<span class="string">&quot;links&quot;</span>, links);</span><br><span class="line">           <span class="comment">// return CreatedAtAction(&quot;GetAllUsers&quot;, user);</span></span><br><span class="line">           <span class="comment">//-------------------------最后返回字典集合</span></span><br><span class="line">           <span class="keyword">return</span> CreatedAtAction(<span class="string">&quot;GetAllUsers&quot;</span>, result);</span><br><span class="line"></span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>由于这里，添加了<code>     [Authorize]</code>，所以只能有登录的用户才能创建用户，这里登录了以后，拷贝一下<code>token</code>信息，然后在<code>apifox</code>软件中进行测试</p>
<p>添加的完用户以后，返回的信息是：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;id&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">&quot;createTime&quot;</span>: <span class="string">&quot;2023年4月17日&quot;</span>,</span><br><span class="line">    <span class="string">&quot;updateTime&quot;</span>: <span class="string">&quot;2023-04-17T14:58:13.4652567+08:00&quot;</span>,</span><br><span class="line">    <span class="string">&quot;userName&quot;</span>: <span class="string">&quot;maliu23&quot;</span>,</span><br><span class="line">    <span class="string">&quot;userEmail&quot;</span>: <span class="string">&quot;maliu2@126.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;userPhone&quot;</span>: <span class="string">&quot;1312222222&quot;</span>,</span><br><span class="line">    <span class="string">&quot;gender&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">&quot;photoUrl&quot;</span>: <span class="string">&quot;/images/b.jpg&quot;</span>,</span><br><span class="line">    <span class="string">&quot;articels&quot;</span>: [],</span><br><span class="line">    <span class="string">&quot;links&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;href&quot;</span>: <span class="string">&quot;http://localhost:5154/api/Users/0&quot;</span>,</span><br><span class="line">            <span class="string">&quot;rel&quot;</span>: <span class="string">&quot;self&quot;</span>,</span><br><span class="line">            <span class="string">&quot;method&quot;</span>: <span class="string">&quot;GET&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;href&quot;</span>: <span class="string">&quot;http://localhost:5154/api/Users/0&quot;</span>,</span><br><span class="line">            <span class="string">&quot;rel&quot;</span>: <span class="string">&quot;update&quot;</span>,</span><br><span class="line">            <span class="string">&quot;method&quot;</span>: <span class="string">&quot;PUT&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;href&quot;</span>: <span class="string">&quot;http://localhost:5154/api/Users/0&quot;</span>,</span><br><span class="line">            <span class="string">&quot;rel&quot;</span>: <span class="string">&quot;update_patch&quot;</span>,</span><br><span class="line">            <span class="string">&quot;method&quot;</span>: <span class="string">&quot;PATCH&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;href&quot;</span>: <span class="string">&quot;http://localhost:5154/api/Users/0&quot;</span>,</span><br><span class="line">            <span class="string">&quot;rel&quot;</span>: <span class="string">&quot;delete&quot;</span>,</span><br><span class="line">            <span class="string">&quot;method&quot;</span>: <span class="string">&quot;Delete&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;href&quot;</span>: <span class="string">&quot;http://localhost:5154/api/Users/0/articels&quot;</span>,</span><br><span class="line">            <span class="string">&quot;rel&quot;</span>: <span class="string">&quot;get_articels&quot;</span>,</span><br><span class="line">            <span class="string">&quot;method&quot;</span>: <span class="string">&quot;GET&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里添加完用户以后，也将添加成功的用户的信息返回了，同时包含了<code>links</code>数组。</p>
<p>问题：这里的用户编号为什么是0呢？</p>
<p>原因是与<code>savechanges</code>方法的执行时机有关。解决的方案：我们可以在<code>CreateUser</code>方法中，获取原有的用户数据源中最大的用户编号，然后这里进行加1的操作。</p>
<h3 id="23-3-列表资源的处理"><a href="#23-3-列表资源的处理" class="headerlink" title="23.3 列表资源的处理"></a>23.3 列表资源的处理</h3><p>这里我们以<code>ArticelsController</code>控制器中的<code>GetArticel</code>方法为例来说明一下。</p>
<p>在<code>ArticelsController</code>控制器中增加如下两个私有的方法。</p>
<p>当调用<code>CreateLinksForArticelList</code>这个私有的方法的时候，根据传递过来的相关参数，构建<code>Links</code>数组。这里只是增加了自身，其他的内容与前面讲解的是一样的。同时在该方法中还调用了私有方法<code>createArticeParams方法</code>，该方法的作用就是对搜索参数的处理。</p>
<p>在<code>createArticeParams</code>方法的内部创建了一个匿名对象，来对搜索的参数进行处理。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> IEnumerable&lt;LinkDto&gt; <span class="title">CreateLinksForArticelList</span>(<span class="params">ArticelParams articelParams</span>)</span></span><br><span class="line">      &#123;</span><br><span class="line">          <span class="keyword">var</span> links = <span class="keyword">new</span> List&lt;LinkDto&gt;();</span><br><span class="line">          links.Add(<span class="keyword">new</span> LinkDto(Url.Link(<span class="string">&quot;GetArticel&quot;</span>, createArticeParams(articelParams))!, <span class="string">&quot;self&quot;</span>, <span class="string">&quot;GET&quot;</span>));</span><br><span class="line">          <span class="keyword">return</span> links;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="function"><span class="keyword">private</span> <span class="built_in">object</span> <span class="title">createArticeParams</span>(<span class="params">ArticelParams articelParams</span>)</span></span><br><span class="line">      &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">new</span></span><br><span class="line">          &#123;</span><br><span class="line">              title = articelParams.title,</span><br><span class="line">              PageIndex = articelParams.PageIndex,</span><br><span class="line">              PageSize = articelParams.PageSize,</span><br><span class="line">              FormDatepicker = articelParams.FormDatepicker,</span><br><span class="line">              ToDatepicker = articelParams.ToDatepicker,</span><br><span class="line">              Order = articelParams.Order,</span><br><span class="line">              Fields = articelParams.Fields,</span><br><span class="line"></span><br><span class="line">          &#125;;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>下面看一下<code>GetArticel</code>方法的修改。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">     HttpContext.Response.Headers.Add(<span class="string">&quot;x-pagination&quot;</span>, Newtonsoft.Json.JsonConvert.SerializeObject(paginationInfo));</span><br><span class="line">            <span class="comment">//--------------------------------------------------------------</span></span><br><span class="line"><span class="comment">// 这里获取到了塑形后的数据</span></span><br><span class="line">            <span class="keyword">var</span> shapedDtoList = articelList.ShapeDatad(articelParams.Fields!);</span><br><span class="line"><span class="comment">// 然后调用CreateLinksForArticelList这个私有方法，获取到了对应的Links数组</span></span><br><span class="line">            <span class="keyword">var</span> linkDto = CreateLinksForArticelList(articelParams);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">          <span class="comment">// 构建匿名对象，具体的数据赋值给了value属性，链接内容赋值给了links属性</span></span><br><span class="line">            <span class="keyword">var</span> result = <span class="keyword">new</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">value</span> = shapedDtoList,</span><br><span class="line">                links = linkDto</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> Ok(result);<span class="comment">// 返回到前端。</span></span><br><span class="line">            <span class="comment">// return Ok(articelList.ShapeDatad(articelParams.Fields!));</span></span><br></pre></td></tr></table></figure>

<p>启动项目进行测试。</p>
<h3 id="23-4-媒体类型"><a href="#23-4-媒体类型" class="headerlink" title="23.4 媒体类型"></a>23.4 媒体类型</h3><p>目前面临的问题：<code>links</code>成为了响应数据的一部分，但是它们并不属于资源。当响应数据中包含这里<code>links</code>这些链接的时候，已经违反<code>restful</code>的定义了。</p>
<p>解决的办法就是通过内容协商来解决，</p>
<p>内容协商指的是：在请求中包含不同的媒体类型，服务端的<code>api</code>返回不同的响应数据。</p>
<p>例如：假设请求中包含的媒体类型是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;Accept&quot;:&quot;application/json&quot;</span><br></pre></td></tr></table></figure>

<p>这表示请求的是一个资源类型。</p>
<p><strong>什么是媒体类型呢？</strong></p>
<p><code>Multipurpose Interrnet Mail Extensions(MIME) </code>是一种标准，用来表示文档，文件或字节流的性质和格式。</p>
<p><strong>它的结构：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">type/subtype    // 中间不能出现空格</span><br></pre></td></tr></table></figure>

<p><code>type</code>：表示的是独立类别</p>
<p><code>subtype</code>:表示细分后的子类型</p>
<p>媒体类型对大小写不敏感，但是传统写法都是小写。</p>
<p><strong>常见的媒体类型结构</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="E:/netcore/WebApi/%E8%AE%B2%E4%B9%89/images/304.png"></p>
<p>以上表格就是常见的媒体类型的分类。</p>
<p><strong>自定义媒体类型</strong></p>
<p>当然，我们开发人员也可以自定义媒体类型</p>
<p>格式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">application/vnd.mycompany.hateoas+json</span><br></pre></td></tr></table></figure>

<p><code>vnd</code>:全称”vendor”的缩写，表示供应商，也就是说这个媒体类型是特定的供应商所使用的</p>
<p>“mycompany”:是自定义的标识，可以是公司名</p>
<p>“hateoas”:表示返回的响应中要包含超媒体链接</p>
<p>”json“:表示输出的数据结构</p>
<h3 id="23-5-媒体类型应用"><a href="#23-5-媒体类型应用" class="headerlink" title="23.5 媒体类型应用"></a>23.5 媒体类型应用</h3><p>这里我们修改<code>ArticelsController</code>控制器中的<code>GetArticel</code>方法。</p>
<p>我们知道当请求该方法的时候，会将具体的数据资源以及hateoas对应的<code>links</code>链接返回，这样会导致数据传输的性能降低。</p>
<p>我们希望的是，当请求的<code>Accept</code>是<code>application/json</code>的时候，只返回具体的资源数据，也是文章信息，不在返回<code>hateoas</code></p>
<p>对应的<code>links</code>数据。</p>
<p>要实现这种需求，就需要使用到自定义的媒体类型。</p>
<p>格式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">application/vnd.mycompany.hateoas+json</span><br></pre></td></tr></table></figure>

<p>当然，如果请求的是以上媒体类型，才会将具体的资源数据以及<code>hateoas</code>中的<code>links</code>以<code>json</code>格式的形式返回。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">        <span class="comment">// api/articels?keyword=传入的参数</span></span><br><span class="line">        [<span class="meta">HttpGet(Name =<span class="string">&quot;GetArticel&quot;</span>)</span>]</span><br><span class="line"><span class="comment">// ------------------这里添加了FromHeader接收Accept请求的媒体类型</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span>  IActionResult <span class="title">GetArticel</span>(<span class="params">[FromQuery] ArticelParams articelParams, [FromHeader(Name =<span class="string">&quot;Accept&quot;</span></span>)]<span class="built_in">string</span> mediaType)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//-------------------------注意：这里导入的是 using Microsoft.Net.Http.Headers;命名空间</span></span><br><span class="line">            <span class="comment">// ---------------------对媒体类型进行解析，解析后的内容，都存储到MediaTypeHeaderValue类型的parsedMediatype变量中</span></span><br><span class="line">            <span class="keyword">if</span> (!MediaTypeHeaderValue.TryParse(mediaType,<span class="keyword">out</span> MediaTypeHeaderValue? parsedMediatype))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// --------------------------对媒体类型解析失败以后，直接返回400的错误</span></span><br><span class="line">                <span class="keyword">return</span> BadRequest(<span class="string">&quot;错误的媒体类型&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">         <span class="comment">/*   articelParams.PageIndex = 1;</span></span><br><span class="line"><span class="comment">            articelParams.PageSize = 10;*/</span></span><br><span class="line">            <span class="comment">// var articels = _articelService.LoadEntities(a=&gt;a.Title!.Contains(keyword));</span></span><br><span class="line">            <span class="built_in">int</span> totalCount = <span class="number">0</span>;</span><br><span class="line">            ArticelSearch articelSearch = <span class="keyword">new</span> ArticelSearch()</span><br><span class="line">            &#123;</span><br></pre></td></tr></table></figure>

<p>对媒体类型解析完成以后，下面就需要进行判断了，继续修改<code>CreateArticel</code>这个方法中的代码，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> HttpContext.Response.Headers.Add(<span class="string">&quot;x-pagination&quot;</span>, Newtonsoft.Json.JsonConvert.SerializeObject(paginationInfo));</span><br><span class="line">            <span class="comment">//--------------------------------------------------------------</span></span><br><span class="line">            <span class="keyword">var</span> shapedDtoList = articelList.ShapeDatad(articelParams.Fields!);</span><br><span class="line"><span class="comment">//---------------------------------判断接收到的媒体类型是否是application/vnd.xxx.hateoas+json，如果是则返回links</span></span><br><span class="line">            <span class="keyword">if</span> (parsedMediatype.MediaType == <span class="string">&quot;application/vnd.xxx.hateoas+json&quot;</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> linkDto = CreateLinksForArticelList(articelParams);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">var</span> result = <span class="keyword">new</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">value</span> = shapedDtoList,</span><br><span class="line">                    links = linkDto</span><br><span class="line">                &#125;;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> Ok(result);</span><br><span class="line">            &#125;</span><br><span class="line"><span class="comment">//------------------------这里只返回具体的数据资源。</span></span><br><span class="line">            <span class="keyword">return</span> Ok(shapedDtoList);</span><br></pre></td></tr></table></figure>

<p>下面进行测试</p>
<p>当请求的媒体类型是<code>application/json</code>的时候，可以返回具体的文章数据。</p>
<p>这里我们测试的时候，我们需要使用<code>Apifox</code>工具进行测试</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="E:/netcore/WebApi/%E8%AE%B2%E4%B9%89/images/059.png"></p>
<p>这里我们首先，指定了<code>Params</code>项，传递的参数是<code>Fields</code>，参数值是<code>id,title</code>,表示的是只展示这两个字段的数据，完成了数据的塑形操作。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="E:/netcore/WebApi/%E8%AE%B2%E4%B9%89/images/230.png"></p>
<p>这里指定的是<code>Header</code>中的<code>Accept</code>的值是<code>application/vnd.xxx.hateoas+json</code>会出错，如果指定的是<code>applicaiton/json</code>则会返回正确的数据，这里指定<code>application/vnd.xxx.hateoas+json</code>出错的原因是：</p>
<p>对于自定义的媒体类型，需要再系统中进行注册。否则无法处理。</p>
<p>修改<code>Program.cs</code>文件中的代码，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 完成AutoMapper的注册</span></span><br><span class="line">builder.Services.AddAutoMapper(AppDomain.CurrentDomain.GetAssemblies());</span><br><span class="line"><span class="comment">//---------------------------------完成自定义媒体类型的处理</span></span><br><span class="line">builder.Services.Configure&lt;MvcOptions&gt;(config =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//OutputFormatters是一个集合，该集合中个存储了所有的媒体类型处理器</span></span><br><span class="line">    <span class="comment">// 获取媒体类型处理器</span></span><br><span class="line">    <span class="keyword">var</span> outputFormatter = config.OutputFormatters.OfType&lt;NewtonsoftJsonOutputFormatter&gt;().FirstOrDefault();</span><br><span class="line">    <span class="keyword">if</span> (outputFormatter != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 将自定义媒体类型添加到媒体类型处理器中。</span></span><br><span class="line">        outputFormatter.SupportedMediaTypes.Add(<span class="string">&quot;application/vnd.xxx.hateoas+json&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>重新启动项目进行测试</p>
<p>当然，我们在请求头中如果不指定<code>Accept</code>,默认是<code>application/json</code></p>
<p>以上就是媒体类型的处理。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://www.kilgour.top">kilgour</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://www.kilgour.top/2024/07/25/%E8%80%81%E7%8E%8B-18%E3%80%81Net-Core-Web-Api/">http://www.kilgour.top/2024/07/25/%E8%80%81%E7%8E%8B-18%E3%80%81Net-Core-Web-Api/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://www.kilgour.top" target="_blank">Kilgour Notes</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://raw.githubusercontent.com/kilg0ur/picture/master/picture/cover2.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/07/27/%E8%80%81%E7%8E%8B-19%E3%80%81Vue-%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF/" title=""><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/kilg0ur/picture/master/picture/cover17.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info"></div></div></a></div><div class="next-post pull-right"><a href="/2024/07/23/%E8%80%81%E7%8E%8B-17%E3%80%81%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%A1%86%E6%9E%B6Quartz-NET/" title=""><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/kilg0ur/picture/master/picture/cover11.jpeg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info"></div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/5.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">kilgour</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">35</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/kilg0ur"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">欢迎来到我的博客！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Net-Core-Web-Api"><span class="toc-number">1.</span> <span class="toc-text">.Net Core  Web  Api</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E4%BB%80%E4%B9%88%E6%98%AF-Net-Core-Api"><span class="toc-number">1.1.</span> <span class="toc-text">1、什么是.Net Core Api</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81-Net-Core-Api-%E4%B8%8E-MVC%E5%BC%80%E5%8F%91%E5%8C%BA%E5%88%AB"><span class="toc-number">1.2.</span> <span class="toc-text">2、.Net Core Api 与 MVC开发区别</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81Api-%E9%A1%B9%E7%9B%AE%E5%88%9B%E5%BB%BA"><span class="toc-number">1.3.</span> <span class="toc-text">3、Api 项目创建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E7%AC%AC%E4%B8%80%E4%B8%AAApi%E7%A8%8B%E5%BA%8F"><span class="toc-number">1.4.</span> <span class="toc-text">4、第一个Api程序</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%E3%80%81%E4%BB%80%E4%B9%88%E6%98%AFREST-Restful"><span class="toc-number">1.5.</span> <span class="toc-text">5、什么是REST&#x2F;Restful</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6%E3%80%81REST%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="toc-number">1.6.</span> <span class="toc-text">6、REST优缺点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7%E3%80%81%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%E3%80%82"><span class="toc-number">1.7.</span> <span class="toc-text">7、获取用户信息。</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8%E3%80%81%E8%BF%94%E5%9B%9E%E6%AD%A3%E7%A1%AE%E7%9A%84%E7%8A%B6%E6%80%81%E7%A0%81"><span class="toc-number">1.8.</span> <span class="toc-text">8、返回正确的状态码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9%E3%80%81%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93%E5%AF%B9%E8%B1%A1DTO%EF%BC%88-Data-Transfer-Object-%EF%BC%89"><span class="toc-number">1.9.</span> <span class="toc-text">9、数据传输对象DTO（(Data Transfer Object)）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10%E3%80%81%E5%88%86%E7%A6%BBModel%E4%B8%8EDTO"><span class="toc-number">1.10.</span> <span class="toc-text">10、分离Model与DTO</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11%E3%80%81%E8%8E%B7%E5%8F%96%E6%96%87%E7%AB%A0%E4%BF%A1%E6%81%AF"><span class="toc-number">1.11.</span> <span class="toc-text">11、获取文章信息</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#11-1-%E9%85%8D%E7%BD%AE%E4%B8%80%E5%AF%B9%E5%A4%9A%E5%85%B3%E7%B3%BB"><span class="toc-number">1.11.1.</span> <span class="toc-text">11.1 配置一对多关系</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-2-%E5%AE%9E%E7%8E%B0%E4%BF%A1%E6%81%AF%E7%9A%84%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.11.2.</span> <span class="toc-text">11.2   实现信息的查询</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12%E3%80%81%E5%8A%A0%E8%BD%BD%E6%89%80%E6%9C%89%E7%94%A8%E6%88%B7%E4%BB%A5%E5%8F%8A%E7%94%A8%E6%88%B7%E5%8F%91%E5%B8%83%E7%9A%84%E6%96%87%E7%AB%A0"><span class="toc-number">1.12.</span> <span class="toc-text">12、加载所有用户以及用户发布的文章</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13%E3%80%81%E6%96%87%E7%AB%A0%E6%90%9C%E7%B4%A2"><span class="toc-number">1.13.</span> <span class="toc-text">13、文章搜索</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#14%E3%80%81%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7"><span class="toc-number">1.14.</span> <span class="toc-text">14、创建用户</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#15%E3%80%81%E7%94%A8%E6%88%B7%E5%8F%91%E5%B8%83%E6%96%87%E7%AB%A0"><span class="toc-number">1.15.</span> <span class="toc-text">15、用户发布文章</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#16%E3%80%81%E6%95%B0%E6%8D%AE%E9%AA%8C%E8%AF%81"><span class="toc-number">1.16.</span> <span class="toc-text">16、数据验证</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#16-1-%E6%B7%BB%E5%8A%A0%E6%95%B0%E6%8D%AE%E9%AA%8C%E8%AF%81"><span class="toc-number">1.16.1.</span> <span class="toc-text">16.1 添加数据验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#16-2-%E8%BE%93%E5%87%BA%E7%8A%B6%E6%80%81%E7%A0%81422"><span class="toc-number">1.16.2.</span> <span class="toc-text">16.2  输出状态码422</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#17%E3%80%81%E6%95%B0%E6%8D%AE%E6%9B%B4%E6%96%B0%E6%93%8D%E4%BD%9C"><span class="toc-number">1.17.</span> <span class="toc-text">17、数据更新操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#17-1-%E4%BD%BF%E7%94%A8put%E8%AF%B7%E6%B1%82%E6%9B%B4%E6%96%B0%E8%B5%84%E6%BA%90"><span class="toc-number">1.17.1.</span> <span class="toc-text">17.1 使用put请求更新资源</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#17-2-put%E8%AF%B7%E6%B1%82%E7%9A%84%E6%95%B0%E6%8D%AE%E6%A0%A1%E9%AA%8C"><span class="toc-number">1.17.2.</span> <span class="toc-text">17.2 put请求的数据校验</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#17-3-patch%E6%95%B0%E6%8D%AE%E7%9A%84%E5%B1%80%E9%83%A8%E6%9B%B4%E6%96%B0"><span class="toc-number">1.17.3.</span> <span class="toc-text">17.3  patch数据的局部更新</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#17-4-patch%E8%AF%B7%E6%B1%82%E7%9A%84%E6%95%B0%E6%8D%AE%E6%A0%A1%E9%AA%8C"><span class="toc-number">1.17.4.</span> <span class="toc-text">17.4 patch请求的数据校验</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#18%E3%80%81%E6%95%B0%E6%8D%AE%E5%88%A0%E9%99%A4"><span class="toc-number">1.18.</span> <span class="toc-text">18、数据删除</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#18-1-%E5%88%A0%E9%99%A4%E6%8C%87%E5%AE%9A%E7%9A%84%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF"><span class="toc-number">1.18.1.</span> <span class="toc-text">18.1  删除指定的用户信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#18-2-%E5%88%A0%E9%99%A4%E7%94%A8%E6%88%B7%E5%8F%91%E5%B8%83%E7%9A%84%E6%96%87%E7%AB%A0"><span class="toc-number">1.18.2.</span> <span class="toc-text">18.2  删除用户发布的文章</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#18-3-%E6%89%B9%E9%87%8F%E5%88%A0%E9%99%A4%E7%94%A8%E6%88%B7"><span class="toc-number">1.18.3.</span> <span class="toc-text">18.3 批量删除用户</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#19%E3%80%81JWT"><span class="toc-number">1.19.</span> <span class="toc-text">19、JWT</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#19-1%E3%80%81JWT%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.19.1.</span> <span class="toc-text">19.1、JWT介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#19-2-JWT%E7%9A%84%E5%8E%9F%E5%88%99"><span class="toc-number">1.19.2.</span> <span class="toc-text">19.2. JWT的原则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#19-3-JWT%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">1.19.3.</span> <span class="toc-text">19.3. JWT的数据结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#19-4-JWT%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="toc-number">1.19.4.</span> <span class="toc-text">19.4 JWT的基本使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#19-5-%E5%90%AF%E5%8A%A8%E6%8E%88%E6%9D%83"><span class="toc-number">1.19.5.</span> <span class="toc-text">19.5 启动授权</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#20%E3%80%81%E5%88%86%E9%A1%B5%E5%A4%84%E7%90%86"><span class="toc-number">1.20.</span> <span class="toc-text">20、分页处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#21%E3%80%81%E6%95%B0%E6%8D%AE%E6%8E%92%E5%BA%8F"><span class="toc-number">1.21.</span> <span class="toc-text">21、数据排序</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#22%E3%80%81%E6%95%B0%E6%8D%AE%E5%A1%91%E5%BD%A2"><span class="toc-number">1.22.</span> <span class="toc-text">22、数据塑形</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#22-1-%E4%BB%80%E4%B9%88%E6%98%AF%E6%95%B0%E6%8D%AE%E5%A1%91%E5%BD%A2%EF%BC%9F"><span class="toc-number">1.22.1.</span> <span class="toc-text">22.1 什么是数据塑形？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#22-2-%E5%A4%84%E7%90%86%E5%8A%A8%E6%80%81%E7%B1%BB%E5%9E%8B%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.22.2.</span> <span class="toc-text">22.2 处理动态类型对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#22-3-%E5%8D%95%E4%B8%80%E8%B5%84%E6%BA%90%E7%9A%84%E5%A1%91%E5%BD%A2"><span class="toc-number">1.22.3.</span> <span class="toc-text">22.3 单一资源的塑形</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#22-4-%E6%95%B0%E6%8D%AE%E5%A1%91%E5%BD%A2%E9%94%99%E8%AF%AF%E7%9A%84%E5%A4%84%E7%90%86"><span class="toc-number">1.22.4.</span> <span class="toc-text">22.4 数据塑形错误的处理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#23%E3%80%81HATEOAS%E5%BA%94%E7%94%A8"><span class="toc-number">1.23.</span> <span class="toc-text">23、HATEOAS应用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#23-1-HATEOAS%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.23.1.</span> <span class="toc-text">23.1 HATEOAS介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#23-2-%E5%A4%84%E7%90%86%E5%8D%95%E4%B8%80%E8%B5%84%E6%BA%90"><span class="toc-number">1.23.2.</span> <span class="toc-text">23.2 处理单一资源</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#23-3-%E5%88%97%E8%A1%A8%E8%B5%84%E6%BA%90%E7%9A%84%E5%A4%84%E7%90%86"><span class="toc-number">1.23.3.</span> <span class="toc-text">23.3 列表资源的处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#23-4-%E5%AA%92%E4%BD%93%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.23.4.</span> <span class="toc-text">23.4 媒体类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#23-5-%E5%AA%92%E4%BD%93%E7%B1%BB%E5%9E%8B%E5%BA%94%E7%94%A8"><span class="toc-number">1.23.5.</span> <span class="toc-text">23.5 媒体类型应用</span></a></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2025 By kilgour</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">2</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --><script data-pjax>
  function butterfly_footer_beautify_injector_config(){
    var parent_div_git = document.getElementById('footer-wrap');
    var item_html = '<div id="workboard"></div>';
    console.log('已挂载butterfly_footer_beautify')
    parent_div_git.insertAdjacentHTML("beforeend",item_html)
    }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_footer_beautify_injector_config();
  }
  else if (epage === cpage){
    butterfly_footer_beautify_injector_config();
  }
  </script><script async src="/js/runtime.js"></script><!-- hexo injector body_end end --></body></html>