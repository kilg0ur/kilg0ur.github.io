<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Kilgour Notes | Kilgour Notes</title><meta name="author" content="kilgour"><meta name="copyright" content="kilgour"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="一、项目多层架构搭建1、项目环境这里我们会新创建一个空白的解决方案。 创建对应的项目，以及接口项目 2、实体类创建在Cms.Entity这个类库项目中创建BaseEntity.cs实体类，封装公共的属性，代码如下所示： 123456789101112131415161718192021222324252627282930using System;using System.Collections.G">
<meta property="og:type" content="article">
<meta property="og:title" content="Kilgour Notes">
<meta property="og:url" content="http://www.kilgour.top/2024/07/18/%E8%80%81%E7%8E%8B-12%E3%80%81CMS%E9%A1%B9%E7%9B%AE/index.html">
<meta property="og:site_name" content="Kilgour Notes">
<meta property="og:description" content="一、项目多层架构搭建1、项目环境这里我们会新创建一个空白的解决方案。 创建对应的项目，以及接口项目 2、实体类创建在Cms.Entity这个类库项目中创建BaseEntity.cs实体类，封装公共的属性，代码如下所示： 123456789101112131415161718192021222324252627282930using System;using System.Collections.G">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/kilg0ur/picture/master/picture/cover3.jpg">
<meta property="article:published_time" content="2024-07-18T05:58:46.949Z">
<meta property="article:modified_time" content="2024-07-28T06:52:29.074Z">
<meta property="article:author" content="kilgour">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/kilg0ur/picture/master/picture/cover3.jpg"><link rel="shortcut icon" href="https://raw.githubusercontent.com/kilg0ur/picture/master/picture/logo.png"><link rel="canonical" href="http://www.kilgour.top/2024/07/18/%E8%80%81%E7%8E%8B-12%E3%80%81CMS%E9%A1%B9%E7%9B%AE/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":230},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"top-right"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Kilgour Notes',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-07-28 14:52:29'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/panarama.css" media="defer" onload="this.media='all'"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-footer-beautify@1.0.0/lib/runtime.css" media="print" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/5.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">35</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 列表</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> 图库</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://raw.githubusercontent.com/kilg0ur/picture/master/picture/cover3.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="Kilgour Notes"><img class="site-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/kilg0ur/picture/master/picture/logo.png"/><span class="site-name">Kilgour Notes</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 列表</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> 图库</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">无题</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-07-18T05:58:46.949Z" title="发表于 2024-07-18 13:58:46">2024-07-18</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-07-28T06:52:29.074Z" title="更新于 2024-07-28 14:52:29">2024-07-28</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">23.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>106分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="一、项目多层架构搭建"><a href="#一、项目多层架构搭建" class="headerlink" title="一、项目多层架构搭建"></a>一、项目多层架构搭建</h1><h2 id="1、项目环境"><a href="#1、项目环境" class="headerlink" title="1、项目环境"></a>1、项目环境</h2><p>这里我们会新创建一个空白的解决方案。</p>
<p>创建对应的项目，以及接口项目</p>
<h2 id="2、实体类创建"><a href="#2、实体类创建" class="headerlink" title="2、实体类创建"></a>2、实体类创建</h2><p>在<code>Cms.Entity</code>这个类库项目中创建<code>BaseEntity.cs</code>实体类，封装公共的属性，代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.Entity</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BaseEntity</span>&lt;<span class="title">TKey</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 主键id</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> TKey Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>  添加数据时间</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> DateTime CreateTime &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 更新数据时间</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> DateTime UpdateTime &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span>  软删除</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">bool</span> Del工作单Flag &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>同时创建一个<code>UserInfo.cs</code>实体类，代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.Entity</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserInfo</span>:<span class="title">BaseEntity</span>&lt;<span class="title">long</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 用户名</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? UserName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 密码</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? UserPassword &#123; <span class="keyword">get</span>; <span class="keyword">set</span>;&#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 邮箱</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? UserEmail &#123; <span class="keyword">get</span>; <span class="keyword">set</span>;&#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 电话</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? UserPhone &#123; <span class="keyword">get</span>; <span class="keyword">set</span>;&#125; </span><br><span class="line">        </span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 性别：0表示男，1表示女</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> Gender &#123; <span class="keyword">get</span>; <span class="keyword">set</span>;&#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 用户头像，存储头像路径</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? PhotoUrl &#123; <span class="keyword">get</span>; <span class="keyword">set</span>;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>创建一个<code>UserInfoConfig.cs</code>类，进行配置，代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.EntityFrameworkCore;</span><br><span class="line"><span class="keyword">using</span> Microsoft.EntityFrameworkCore.Metadata.Builders;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.Entity</span></span><br><span class="line">&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserInfoConfig</span> : <span class="title">IEntityTypeConfiguration</span>&lt;<span class="title">UserInfo</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">EntityTypeBuilder&lt;UserInfo&gt; builder</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            builder.ToTable(<span class="string">&quot;T_UserInfos&quot;</span>);</span><br><span class="line">            builder.Property(x=&gt;x.UserName).HasMaxLength(<span class="number">20</span>).IsRequired();</span><br><span class="line">            builder.Property(x=&gt;x.UserPassword).HasMaxLength(<span class="number">20</span>).IsRequired();</span><br><span class="line">            builder.Property(x =&gt; x.UserEmail).HasMaxLength(<span class="number">100</span>).IsRequired();</span><br><span class="line">            builder.Property(x=&gt;x.UserPhone).HasMaxLength(<span class="number">16</span>).IsRequired();</span><br><span class="line">            builder.Property(x =&gt; x.Gender).HasDefaultValue(<span class="number">0</span>);</span><br><span class="line">            builder.Property(x =&gt; x.PhotoUrl).HasMaxLength(<span class="number">100</span>);</span><br><span class="line">        &#125;</span><br><span class="line">       </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在当前的<code>Cms.Entity</code>类库项目中，需要安装的包：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;PackageReference Include=&quot;Microsoft.EntityFrameworkCore&quot; Version=&quot;7.0.4&quot; /&gt;</span><br><span class="line">  &lt;PackageReference Include=&quot;Microsoft.EntityFrameworkCore.Relational&quot; Version=&quot;7.0.4&quot;&gt;&lt;/PackageReference&gt;</span><br></pre></td></tr></table></figure>



<h2 id="3、DbContext搭建"><a href="#3、DbContext搭建" class="headerlink" title="3、DbContext搭建"></a>3、<code>DbContext</code>搭建</h2><p>在<code>Cms.EntityFrameworkCore</code>项目中安装<code>EFCore</code>所需要的包</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Install-Package Microsoft.EntityFrameworkCore.SqlServer</span><br><span class="line">Install-Package Microsoft.EntityFrameworkCore.Tools</span><br></pre></td></tr></table></figure>

<p>注意：在<code>程序包管理器控制台</code>中选择的项目是<code>Cms.EntityFrameworkCore</code></p>
<p>同时在该项目中创建<code>DbContext</code></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyDbContext</span>:<span class="title">DbContext</span></span><br><span class="line">  &#123;</span><br><span class="line">      <span class="keyword">public</span> DbSet&lt;UserInfo&gt;UserInfos &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="title">MyDbContext</span>(<span class="params">DbContextOptions&lt;MyDbContext&gt;options</span>):<span class="title">base</span>(<span class="params">options</span>)</span> </span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// 这里添加构造方法的目的：就是对当前的MyDbContext进行注入，并且从配置文件中读取数据库链接配置</span></span><br><span class="line">      </span><br><span class="line">      &#125;</span><br><span class="line">     </span><br><span class="line">      <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnConfiguring</span>(<span class="params">DbContextOptionsBuilder optionsBuilder</span>)</span></span><br><span class="line">      &#123;</span><br><span class="line">          <span class="keyword">base</span>.OnConfiguring(optionsBuilder);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnModelCreating</span>(<span class="params">ModelBuilder modelBuilder</span>)</span></span><br><span class="line">      &#123;</span><br><span class="line">          <span class="keyword">base</span>.OnModelCreating(modelBuilder);</span><br><span class="line">          <span class="comment">// 通过反射机制加载程序集（AppDomain.CurrentDomain.BaseDirectory：当前程序集的基目录）</span></span><br><span class="line">          <span class="keyword">var</span> assembly = Assembly.LoadFrom(Path.Combine(AppDomain.CurrentDomain.BaseDirectory, <span class="string">&quot;Cms.Entity.dll&quot;</span>));</span><br><span class="line">         <span class="comment">// 获取此程序集中定义的所有类型。</span></span><br><span class="line">            <span class="keyword">var</span> types = assembly.GetTypes();</span><br><span class="line">          <span class="keyword">foreach</span> ( <span class="keyword">var</span> type <span class="keyword">in</span> types ) &#123;</span><br><span class="line">              modelBuilder.ApplyConfigurationsFromAssembly(type.Assembly); <span class="comment">// 执行`Cms.Entity`程序集中实现了IEntityTypeConfiguration接口的配置</span></span><br><span class="line">          &#125;         </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>在当前的<code>Cms.EntityFrameworkCore</code>的类库项目中引入<code>Cms.Entity</code>项目</p>
<p>在<code>Cms.WebUI</code>这个<code>Web</code>项目中引入<code>Cms.EntityFrameworkCore</code>和<code>Cms.Entity</code>项目</p>
<p>同时在<code>Web</code>项目中的<code>appsettings.json</code>文件中，添加数据库的链接字符串</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;Logging&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;LogLevel&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Default&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Information&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Microsoft.AspNetCore&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Warning&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;AllowedHosts&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;ConnectionStrings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;StrConn&quot;</span><span class="punctuation">:</span> <span class="string">&quot;server=localhost;database=CmsDb;uid=sa;pwd=123456;TrustServerCertificate=true&quot;</span> <span class="comment">// 数据库链接字符串</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在<code>Program.cs</code>文件中，对<code>DbContext</code>进行注入</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">builder.Services.AddControllersWithViews();</span><br><span class="line"><span class="comment">//注入DbContext,同时获取数据库链接字符串</span></span><br><span class="line">builder.Services.AddDbContext&lt;MyDbContext&gt;(opt =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">string</span> connStr = builder.Configuration.GetConnectionString(<span class="string">&quot;StrConn&quot;</span>)!;</span><br><span class="line">    opt.UseSqlServer(connStr);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">var</span> app = builder.Build();</span><br></pre></td></tr></table></figure>

<p>同时在<code>CMS.WebUI</code>这个<code>UI</code>项目中，也需要安装如下包：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;PackageReference Include=&quot;Microsoft.EntityFrameworkCore.Design&quot; Version=&quot;7.0.4&quot;&gt;</span><br><span class="line">    &lt;PrivateAssets&gt;all&lt;/PrivateAssets&gt;</span><br><span class="line">    &lt;IncludeAssets&gt;runtime; build; native; contentfiles; analyzers; buildtransitive&lt;/IncludeAssets&gt;</span><br><span class="line">  &lt;/PackageReference&gt;</span><br></pre></td></tr></table></figure>



<p>下面生成数据库迁移</p>
<p>在【程序包管理器控制台】中选择<code>Cms.EntityFrameworkCore</code>这个类库项目</p>
<p>然后执行如下迁移命令(<strong>需要将<code>CMS.WebUI</code>项目设置为启动项目，同时将以上安装的各个库的版本保持一致</strong>)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Add-Migration CreateUserInfo</span><br><span class="line"> Update-database</span><br></pre></td></tr></table></figure>

<p>完成迁移以后，查看数据库。</p>
<h2 id="4、数据仓储设计"><a href="#4、数据仓储设计" class="headerlink" title="4、数据仓储设计"></a>4、数据仓储设计</h2><h3 id="4-1-仓储接口设计"><a href="#4-1-仓储接口设计" class="headerlink" title="4.1   仓储接口设计"></a>4.1   仓储接口设计</h3><p>在<code> Cms.IRepository</code>项目中（在该项目中需要引用<code>Cms.Entity</code>类库项目），创建<code>IUserInfoRepository.cs</code>接口，该接口中的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IUserInfoRepository</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="function">IQueryable&lt;UserInfo&gt; <span class="title">LoadEntities</span>(<span class="params">Expression&lt;Func&lt;UserInfo,<span class="built_in">bool</span>&gt;&gt;wehreLambda</span>)</span>;</span><br><span class="line">       <span class="function">IQueryable&lt;UserInfo&gt; <span class="title">LoadPageEntities</span>(<span class="params"><span class="built_in">int</span> pageIndex, <span class="built_in">int</span> pageSize, <span class="keyword">out</span> <span class="built_in">int</span> totalCount, Expression&lt;Func&lt;UserInfo, <span class="built_in">bool</span>&gt;&gt; whereLambda, Expression&lt;Func&lt;UserInfo, <span class="built_in">int</span>&gt;&gt; orderbyLambda, <span class="built_in">bool</span> isAsc</span>)</span>;</span><br><span class="line">       <span class="function">Task&lt;<span class="built_in">bool</span>&gt; <span class="title">DeleteEntityAsync</span>(<span class="params">UserInfo entity</span>)</span>;</span><br><span class="line">       <span class="function">Task&lt;<span class="built_in">bool</span>&gt; <span class="title">UpdateEntityAsync</span>(<span class="params">UserInfo entity</span>)</span>;</span><br><span class="line">       <span class="function">Task&lt;UserInfo&gt; <span class="title">InsertEntityAsync</span>(<span class="params">UserInfo entity</span>)</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>我们可以看到了在这个接口中，定义了针对用户信息的增删改查的方法。</p>
<p>但是有一个问题，其它的接口中也有这些方法，所以这里我们需要做进一步的进行封装的处理。</p>
<p>在<code>Cms.IRepository</code>中在创建一个基接口的仓储<code>IBaseRepository.cs</code>，代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.IRepository</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IBaseRepository</span>&lt;<span class="title">T</span>&gt;<span class="title">where</span> T : <span class="keyword">class</span>,<span class="keyword">new</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="title">IQueryable</span>&lt;<span class="title">T</span>&gt; <span class="title">LoadEntities</span>(<span class="params">Expression&lt;Func&lt;T, <span class="built_in">bool</span>&gt;&gt; wehreLambda</span>)</span>;</span><br><span class="line">        <span class="function"><span class="title">IQueryable</span>&lt;<span class="title">T</span>&gt; <span class="title">LoadPageEntities</span>&lt;<span class="title">S</span>&gt;(<span class="params"><span class="built_in">int</span> pageIndex, <span class="built_in">int</span> pageSize, <span class="keyword">out</span> <span class="built_in">int</span> totalCount, Expression&lt;Func&lt;T, <span class="built_in">bool</span>&gt;&gt; whereLambda, Expression&lt;Func&lt;T, S&gt;&gt; orderbyLambda, <span class="built_in">bool</span> isAsc</span>)</span>;</span><br><span class="line">        <span class="function">Task&lt;<span class="built_in">bool</span>&gt; <span class="title">DeleteEntityAsync</span>(<span class="params">T entity</span>)</span>;</span><br><span class="line">        <span class="function">Task&lt;<span class="built_in">bool</span>&gt; <span class="title">UpdateEntityAsync</span>(<span class="params">T entity</span>)</span>;</span><br><span class="line">        <span class="function">Task&lt;T&gt; <span class="title">InsertEntityAsync</span>(<span class="params">T entity</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里我们使用了泛型。</p>
<p>而<code>IUserInfoRepository</code>接口要继承<code>IBaseRepository</code>这个接口。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IUserInfoRepository</span>:<span class="title">IBaseRepository</span>&lt;<span class="title">UserInfo</span>&gt;</span><br><span class="line">  &#123;</span><br><span class="line">     <span class="comment">// 这里定义的是`IUserInfoRepository`这个接口自己独有的方法。</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-实现仓储接口1"><a href="#4-2-实现仓储接口1" class="headerlink" title="4.2 实现仓储接口1"></a>4.2 实现仓储接口1</h3><p>仓库接口的具体实现是在<code>Cms.Repository</code>这个类库项目中完成的。</p>
<p>在该类库项目中先将<code>CMS.Entity</code>和<code>Cms.IRepository</code>这两个项目引入进来。</p>
<p>然后创建<code>UserInfoRepository.cs</code>这个具体的用户信息仓储类。它应该实现自己的<code>IUserInfoRepository</code>接口</p>
<p>如下代码所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserInfoRepository</span> : <span class="title">IUserInfoRepository</span></span><br><span class="line">   &#123;</span><br><span class="line">     </span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="title">Task</span>&lt;<span class="title">bool</span>&gt; <span class="title">DeleteEntityAsync</span>(<span class="params">UserInfo entity</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> NotImplementedException();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="title">Task</span>&lt;<span class="title">UserInfo</span>&gt; <span class="title">InsertEntityAsync</span>(<span class="params">UserInfo entity</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> NotImplementedException();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="title">IQueryable</span>&lt;<span class="title">UserInfo</span>&gt; <span class="title">LoadEntities</span>(<span class="params">Expression&lt;Func&lt;UserInfo, <span class="built_in">bool</span>&gt;&gt; wehreLambda</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> NotImplementedException();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="title">IQueryable</span>&lt;<span class="title">UserInfo</span>&gt; <span class="title">LoadPageEntities</span>&lt;<span class="title">s</span>&gt;(<span class="params"><span class="built_in">int</span> pageIndex, <span class="built_in">int</span> pageSize, <span class="keyword">out</span> <span class="built_in">int</span> totalCount, Expression&lt;Func&lt;UserInfo, <span class="built_in">bool</span>&gt;&gt; whereLambda, Expression&lt;Func&lt;UserInfo, s&gt;&gt; orderbyLambda, <span class="built_in">bool</span> isAsc</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> NotImplementedException();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> Task&lt;<span class="built_in">bool</span>&gt; <span class="title">UpdateEntityAsync</span>(<span class="params">UserInfo entity</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> NotImplementedException();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>当看到以上代码的时候，我们就想到了，这些代码也是公共的代码，也应该进行进一步的封装处理。</p>
<p>这时候，再创建<code>BaseRepository.cs</code>这个基仓储，其中的代码如下所示</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.Repository</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BaseRepository</span>&lt;<span class="title">T</span>&gt; <span class="keyword">where</span> T : <span class="keyword">class</span>,<span class="keyword">new</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Task</span>&lt;<span class="title">bool</span>&gt; <span class="title">DeleteEntityAsync</span>(<span class="params">T entity</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NotImplementedException();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Task</span>&lt;<span class="title">T</span>&gt; <span class="title">InsertEntityAsync</span>(<span class="params">T entity</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NotImplementedException();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">IQueryable</span>&lt;<span class="title">T</span>&gt; <span class="title">LoadEntities</span>(<span class="params">Expression&lt;Func&lt;T, <span class="built_in">bool</span>&gt;&gt; wehreLambda</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NotImplementedException();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">IQueryable</span>&lt;<span class="title">T</span>&gt; <span class="title">LoadPageEntities</span>&lt;<span class="title">s</span>&gt;(<span class="params"><span class="built_in">int</span> pageIndex, <span class="built_in">int</span> pageSize, <span class="keyword">out</span> <span class="built_in">int</span> totalCount, Expression&lt;Func&lt;T, <span class="built_in">bool</span>&gt;&gt; whereLambda, Expression&lt;Func&lt;T, s&gt;&gt; orderbyLambda, <span class="built_in">bool</span> isAsc</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NotImplementedException();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Task&lt;<span class="built_in">bool</span>&gt; <span class="title">UpdateEntityAsync</span>(<span class="params">T entity</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NotImplementedException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>上面的<code>BaseRepository</code>类实现了泛型。</p>
<p>同时封装的就是公共的代码的实现。</p>
<p>下面修改<code>UserInfoRepository.cs</code>类中的代码</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserInfoRepository</span> :<span class="title">BaseRepository</span>&lt;<span class="title">UserInfo</span>&gt;, <span class="title">IUserInfoRepository</span></span><br><span class="line">  &#123;</span><br><span class="line">    </span><br><span class="line">      <span class="comment">// 这里实现的是`UserInfoRepository`独有的方法。</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>可以看到这里继承了<code>BaseRepository</code>，传递的泛型的类型是<code>UserInfo</code>这个类型。</p>
<p><strong>下面要考虑的就是在<code>BaseRepository</code>类中所定义的这些公共方法的具体实现。</strong></p>
<p>这里要实现这些方法，就需要将<code>DbContext</code>注入进来。</p>
<p>修改<code>BaseRepository.cs</code>类，代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BaseRepository</span>&lt;<span class="title">T</span>&gt; <span class="keyword">where</span> <span class="title">T</span> : <span class="keyword">class</span>,<span class="title">new</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 注入DbContext</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">readonly</span> MyDbContext ctx;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">BaseRepository</span>(<span class="params">MyDbContext ctx</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.ctx = ctx;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>这里我们在<code>BaseRepository.cs</code>类中注入了<code>MyDbContext</code>。</p>
<p>这里注意：关于<code>ctx</code>声明，我们使用了<code>protected</code>，原因就是在子类<code>UserInfoRepository.cs</code>中我们也要使用<code>ctx</code>这个<code>MyDbContext</code>，因为在<code>UserInfoRepository</code>实现的是它自己独有的方法，而这些方法在操作数据的时候也需要使用到<code>ctx</code>这个<code>MyDbContext</code>.</p>
<p>下面再对<code>UserInfoRepository.cs</code>这个子类中的代码做一下修改</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserInfoRepository</span> :<span class="title">BaseRepository</span>&lt;<span class="title">UserInfo</span>&gt;, <span class="title">IUserInfoRepository</span></span><br><span class="line">   &#123;</span><br><span class="line">     <span class="comment">// 由于父类BaseRepository的构造方法中，需要MyDbContext,所以这里子类的构造函数中添加MyDbContext参数，最终会传递给父类的构造函数，这样才真正的完成了MyDbContext的注入操作。</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="title">UserInfoRepository</span>(<span class="params">MyDbContext context</span>):<span class="title">base</span>(<span class="params">context</span>)</span> &#123; &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>下面要实现的就是<code>BaseRepository.cs</code>中具体的方法中的代码：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BaseRepository</span>&lt;<span class="title">T</span>&gt; <span class="keyword">where</span> <span class="title">T</span> : <span class="keyword">class</span>,<span class="title">new</span>()</span><br><span class="line">   &#123;</span><br><span class="line">       <span class="comment">// 注入DbContext</span></span><br><span class="line">       <span class="keyword">protected</span> <span class="keyword">readonly</span> MyDbContext ctx;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="title">BaseRepository</span>(<span class="params">MyDbContext ctx</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">this</span>.ctx = ctx;</span><br><span class="line">       &#125;</span><br><span class="line"> <span class="comment">// 实现删除操作</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> <span class="title">Task</span>&lt;<span class="title">bool</span>&gt; <span class="title">DeleteEntityAsync</span>(<span class="params">T entity</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">          ctx.Set&lt;T&gt;().Remove(entity);</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">await</span> ctx.SaveChangesAsync()&gt;<span class="number">0</span>;  </span><br><span class="line">       &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在上面的代码中，我们先实现了删除的方法，但是实现这个方法以后，我们发现了一个问题：就是每次调用删除或者是更新的时候都需要执行<code>SaveChangesAsync</code>方法，完成数据的操作。但是在某些业务场景下，我们只希望提交一次数据。</p>
<p>例如：一个请求过来，把张三这个学生的总分成绩加10分，同时将李四学生的成绩减去5分，如果按照我们现在的设计，需要提交两次数据库。而为了提升性能，我们针对当前的请求其实只需要向数据库发送一次请求就可以了。</p>
<p>要达到这样的效果，就需要使用工作单元模式。</p>
<h3 id="4-3-工作单元的实现"><a href="#4-3-工作单元的实现" class="headerlink" title="4.3 工作单元的实现"></a>4.3 工作单元的实现</h3><p>我们知道，要想把数据保存，更新到数据库中，我们必须要调用<code>SaveChanges</code>方法。</p>
<p>而且一个请求过来以后，首先到达控制器中的方法，在控制器的方法中调用了业务，业务最终调用了数据仓储，当这些操作完成后，我们就可以统一调用<code>SaveChangeAsync</code>方法，完成数据的操作。</p>
<p>这里我们可以使用<code>Filter</code>过滤器来帮我们实现。好处是不需要我们自己手动调用<code>SaveChangeAsync</code>方法，如果将工作单元的代码封装到一个类中，还需要我们手动调用。</p>
<p>我们将代码定义在<code>Filter</code>中的好处就是，当控制器方法执行完毕后自动调用<code>SaveChangeAsync</code>方法。</p>
<p>当然，如果通过<code>Filter</code>来完成数据的操作，就会涉及到一个问题，所有控制器中的方法执行完后，都会执行<code>ActionFiler</code>.</p>
<p>为了避免这个问题，这里我们可以创建一个<code>Attribute</code>,只有给控制器的方法上添加了该<code>Attribute</code>，才会执行<code>ActionFiler</code>完成数据的操作。</p>
<p>在<code>Cms.WebUI</code>项目中创建<code>Attributes</code>目录，在该目录下面创建<code>UnitOfWorkAttribute.cs</code>类，该类的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.WebUI.Attributes</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">AttributeUsage(AttributeTargets.Method)</span>] <span class="comment">// 这里的Attribute只能用于方法中</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UnitOfWorkAttribute</span>:<span class="title">Attribute</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> Type[] DbContextTypes &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;<span class="comment">// 考虑到项目中可能有多个DbContext,所以定义了一个数组</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">UnitOfWorkAttribute</span>(<span class="params">Type[] dbContextTypes</span>)</span> &#123;</span><br><span class="line">           <span class="keyword">this</span>.DbContextTypes = dbContextTypes;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面在<code>Cms.WebUI</code>中创建一个<code>Filters</code>文件夹，在该文件夹下面创建<code>UnitOfWorkFilter.cs</code>类</p>
<p>该类的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.WebUI.Filters</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UnitOfWorkFilter</span> : <span class="title">IAsyncActionFilter</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">OnActionExecutionAsync</span>(<span class="params">ActionExecutingContext context, ActionExecutionDelegate next</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> result = <span class="keyword">await</span> next();<span class="comment">// 执行完控制器中的方法了</span></span><br><span class="line">            <span class="keyword">if</span> (result.Exception != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;<span class="comment">// 如果该条件成立，表示控制器中方法执行出现了错误，所以就没有必要执行SaveChanges方法了</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 下面要获取添加在控制器方法上的Attribute</span></span><br><span class="line">            <span class="keyword">var</span> actionDesc = context.ActionDescriptor <span class="keyword">as</span> ControllerActionDescriptor;</span><br><span class="line">            <span class="keyword">if</span> (actionDesc == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;<span class="comment">// 表示无法转换，也会终止</span></span><br><span class="line">            &#125;</span><br><span class="line">           <span class="keyword">var</span> unAttr =  actionDesc.MethodInfo.GetCustomAttribute&lt;UnitOfWorkAttribute&gt;();</span><br><span class="line">            <span class="keyword">if</span> (unAttr == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;<span class="comment">// 如果该条件成立，表示所执行的控制器的方法上没有添加UnitOfWorkAttribute，这里就会终止，没有必要在执行下面的SaveChanges方法了</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 从UnitOfWorkAttribute中的DbContextTypes数组中获取所保存的DbContext</span></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> dbCxtType <span class="keyword">in</span> unAttr.DbContextTypes)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 我们知道DbContext都是注入到容器中，所以这里需要从容器中获取</span></span><br><span class="line">                <span class="comment">//HttpContext.RequestServices:表示针对当前请求，从容器中获取对应的实例对象</span></span><br><span class="line">                <span class="keyword">var</span> dbCtx = context.HttpContext.RequestServices.GetService(dbCxtType) <span class="keyword">as</span> DbContext;</span><br><span class="line">                <span class="keyword">if</span> (dbCtx != <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">await</span> dbCtx.SaveChangesAsync();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>下面在<code>Program.cs</code>中注册上面所创建的<code>Filter</code></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">builder.Services.AddDbContext&lt;MyDbContext&gt;(opt =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">string</span> connStr = builder.Configuration.GetConnectionString(<span class="string">&quot;StrConn&quot;</span>)!;</span><br><span class="line">    opt.UseSqlServer(connStr);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 注入UnitOfWorkFilter</span></span><br><span class="line">builder.Services.Configure&lt;MvcOptions&gt;(c =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    c.Filters.Add&lt;UnitOfWorkFilter&gt;();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>下面做一个简单的测试</p>
<p>在<code>Home</code>控制器中添加一个<code>Test</code>方法</p>
<p>如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">UnitOfWork(new Type[</span>] &#123;<span class="keyword">typeof</span>(MyDbContext) &#125;)]</span><br><span class="line">   <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Test</span>()</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">return</span> Content(<span class="string">&quot;ok&quot;</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>在<code>Test</code>方上添加了<code>UnitOfWork</code>这个<code>Attribute</code>.</p>
<p>下面启动项目测试一下，给<code>UnitOfWorkFilter.cs</code>类中的代码打上断点进行调试。</p>
<h3 id="4-4-实现仓储接口2"><a href="#4-4-实现仓储接口2" class="headerlink" title="4.4  实现仓储接口2"></a>4.4  实现仓储接口2</h3><p>在这一小节中，我们继续来实现<code>BaseRepository.cs</code>中的方法。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Cms.Entity;</span><br><span class="line"><span class="keyword">using</span> Cms.EntityFrameworkCore;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Linq.Expressions;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.Repository</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BaseRepository</span>&lt;<span class="title">T</span>&gt; <span class="keyword">where</span> <span class="title">T</span> : <span class="keyword">class</span>,<span class="title">new</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 注入DbContext</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">readonly</span> MyDbContext ctx;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">BaseRepository</span>(<span class="params">MyDbContext ctx</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.ctx = ctx;</span><br><span class="line">        &#125;</span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 删除</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;entity&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span>  <span class="title">Task</span>&lt;<span class="title">bool</span>&gt; <span class="title">DeleteEntityAsync</span>(<span class="params">T entity</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">           ctx.Set&lt;T&gt;().Remove(entity);</span><br><span class="line">            <span class="keyword">return</span> Task.FromResult&lt;<span class="built_in">bool</span>&gt;(<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 添加</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;entity&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Task</span>&lt;<span class="title">T</span>&gt; <span class="title">InsertEntityAsync</span>(<span class="params">T entity</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">          ctx.Set&lt;T&gt;().Add(entity);</span><br><span class="line">            <span class="keyword">return</span> Task.FromResult&lt;T&gt;(entity);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 查询</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;wehreLambda&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">IQueryable</span>&lt;<span class="title">T</span>&gt; <span class="title">LoadEntities</span>(<span class="params">Expression&lt;Func&lt;T, <span class="built_in">bool</span>&gt;&gt; wehreLambda</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> ctx.Set&lt;T&gt;().Where&lt;T&gt;(wehreLambda);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 分页查询</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;s&quot;&gt;</span>方法的泛型类型<span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;pageIndex&quot;&gt;</span>当前页码<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;pageSize&quot;&gt;</span>每页显示的记录数<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;totalCount&quot;&gt;</span>总的记录数<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;whereLambda&quot;&gt;</span>过滤条件<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;orderbyLambda&quot;&gt;</span>排序条件<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;isAsc&quot;&gt;</span>排序方式<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;NotImplementedException&quot;&gt;</span><span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">IQueryable</span>&lt;<span class="title">T</span>&gt; <span class="title">LoadPageEntities</span>&lt;<span class="title">S</span>&gt;(<span class="params"><span class="built_in">int</span> pageIndex, <span class="built_in">int</span> pageSize, <span class="keyword">out</span> <span class="built_in">int</span> totalCount, Expression&lt;Func&lt;T, <span class="built_in">bool</span>&gt;&gt; whereLambda, Expression&lt;Func&lt;T, S&gt;&gt; orderbyLambda, <span class="built_in">bool</span> isAsc</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">           <span class="keyword">var</span> temp = ctx.Set&lt;T&gt;().Where&lt;T&gt;(whereLambda);</span><br><span class="line">            totalCount = temp.Count();</span><br><span class="line">            <span class="keyword">if</span> (isAsc) <span class="comment">// 升序排序</span></span><br><span class="line">            &#123;</span><br><span class="line">                temp = temp.OrderBy&lt;T,S&gt;(orderbyLambda).Skip&lt;T&gt;((pageIndex<span class="number">-1</span>)*pageSize).Take&lt;T&gt;(pageSize);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                temp = temp.OrderByDescending&lt;T, S&gt;(orderbyLambda).Skip&lt;T&gt;((pageIndex - <span class="number">1</span>) * pageSize).Take&lt;T&gt;(pageSize);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> temp;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 更新</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;entity&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Task</span>&lt;<span class="title">bool</span>&gt; <span class="title">UpdateEntityAsync</span>(<span class="params">T entity</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            ctx.Set&lt;T&gt;().Update(entity);</span><br><span class="line">            <span class="keyword">return</span> Task.FromResult&lt;<span class="built_in">bool</span>&gt;(<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="5、服务层设计"><a href="#5、服务层设计" class="headerlink" title="5、服务层设计"></a>5、服务层设计</h2><h3 id="5-1-服务接口设计"><a href="#5-1-服务接口设计" class="headerlink" title="5.1 服务接口设计"></a>5.1 服务接口设计</h3><p>在<code>Cms.IService</code>项目中(需要在该项目中引入<code>Cms.Entity</code>)，创建一个<code>IUserInfoService.cs</code>，针对用户的业务操作。</p>
<p>目前<code>IUserInfoService.cs</code>也是基本的增删改查，这些公共的方法。</p>
<p>同样把公共的业务操作的方法进行封装处理。所以这里在<code>Cms.IService</code>项目中在创建<code>IBaseService.cs</code>这个接口，该接口中的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.IService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IBaseService</span>&lt;<span class="title">T</span>&gt;<span class="title">where</span> T:<span class="keyword">class</span>,<span class="keyword">new</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="title">IQueryable</span>&lt;<span class="title">T</span>&gt; <span class="title">LoadEntities</span>(<span class="params">Expression&lt;Func&lt;T, <span class="built_in">bool</span>&gt;&gt; wehreLambda</span>)</span>;</span><br><span class="line">        <span class="function"><span class="title">IQueryable</span>&lt;<span class="title">T</span>&gt; <span class="title">LoadPageEntities</span>&lt;<span class="title">S</span>&gt;(<span class="params"><span class="built_in">int</span> pageIndex, <span class="built_in">int</span> pageSize, <span class="keyword">out</span> <span class="built_in">int</span> totalCount, Expression&lt;Func&lt;T, <span class="built_in">bool</span>&gt;&gt; whereLambda, Expression&lt;Func&lt;T, S&gt;&gt; orderbyLambda, <span class="built_in">bool</span> isAsc</span>)</span>;</span><br><span class="line">        <span class="function">Task&lt;<span class="built_in">bool</span>&gt; <span class="title">DeleteEntityAsync</span>(<span class="params">T entity</span>)</span>;</span><br><span class="line">        <span class="function">Task&lt;<span class="built_in">bool</span>&gt; <span class="title">UpdateEntityAsync</span>(<span class="params">T entity</span>)</span>;</span><br><span class="line">        <span class="function">Task&lt;T&gt; <span class="title">InsertEntityAsync</span>(<span class="params">T entity</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>同样的<code>IUserInfoService.cs</code>要继承<code>IBseService.cs</code></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.IService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IUserInfoService</span>:<span class="title">IBaseService</span>&lt;<span class="title">UserInfo</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-2-实现服务接口"><a href="#5-2-实现服务接口" class="headerlink" title="5.2  实现服务接口"></a>5.2  实现服务接口</h3><p>在<code>Cms.Service</code>这个类库项目中（在该类库项目中引入<code>Cms.Entity,Cms.IService,Cms.IRepository</code>），创建一个<code>UserInfoService.cs</code>这个类.该类的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.Service</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserInfoService</span> :<span class="title">BaseService</span>&lt;<span class="title">UserInfo</span>&gt;,<span class="title">IUserInfoService</span></span><br><span class="line">    &#123;</span><br><span class="line">       </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在<code>UserInfoService.cs</code>这个具体的服务类中要实现用户管理的具体的业务，所以要实现<code>IUserInfoService</code>这个接口，但是公共的业务方法也要进行封装，这里封装到了<code>BaseService</code>中。</p>
<p><code>BaseSevice.cs</code>这个类中的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Cms.Entity;</span><br><span class="line"><span class="keyword">using</span> Cms.IRepository;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Linq.Expressions;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.Service</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BaseService</span>&lt;<span class="title">T</span>&gt;<span class="title">where</span> T : <span class="keyword">class</span>,<span class="keyword">new</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 从子类的构造函数中传入</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="title">IBaseRepository</span>&lt;<span class="title">T</span>&gt; repository</span> &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> <span class="title">Task</span>&lt;<span class="title">bool</span>&gt; <span class="title">DeleteEntityAsync</span>(<span class="params">T entity</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> repository.DeleteEntityAsync(entity);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> <span class="title">Task</span>&lt;<span class="title">T</span>&gt; <span class="title">InsertEntityAsync</span>(<span class="params">T entity</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">await</span> repository.InsertEntityAsync(entity);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">IQueryable</span>&lt;<span class="title">T</span>&gt; <span class="title">LoadEntities</span>(<span class="params">Expression&lt;Func&lt;T, <span class="built_in">bool</span>&gt;&gt; wehreLambda</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">         <span class="keyword">return</span>  repository.LoadEntities(wehreLambda);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">IQueryable</span>&lt;<span class="title">T</span>&gt; <span class="title">LoadPageEntities</span>&lt;<span class="title">S</span>&gt;(<span class="params"><span class="built_in">int</span> pageIndex, <span class="built_in">int</span> pageSize, <span class="keyword">out</span> <span class="built_in">int</span> totalCount, Expression&lt;Func&lt;T, <span class="built_in">bool</span>&gt;&gt; whereLambda, Expression&lt;Func&lt;T, S&gt;&gt; orderbyLambda, <span class="built_in">bool</span> isAsc</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> repository.LoadPageEntities(pageIndex, pageSize, <span class="keyword">out</span> totalCount, whereLambda, orderbyLambda, isAsc);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;<span class="built_in">bool</span>&gt; <span class="title">UpdateEntityAsync</span>(<span class="params">T entity</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> repository.UpdateEntityAsync(entity);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>当然，在<code>UserInfoService.cs</code>这个类的构造函数中，要确定<code>repository</code>这个属性的值。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserInfoService</span> :<span class="title">BaseService</span>&lt;<span class="title">UserInfo</span>&gt;,<span class="title">IUserInfoService</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="title">UserInfoService</span>(<span class="params">IUserInfoRepository userInfoRepository</span>)</span> &#123; </span><br><span class="line">          <span class="keyword">base</span>.repository = userInfoRepository;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>这里，我们可以看到在<code>UserInfoService</code>这个构造函数中，我们给父类<code>BaseService</code>中的<code>repository</code>传递的是<code>userInfoRepository</code>，表示使用的是用户的仓储，也就是对用户的数据进行操作。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserInfoService</span> :<span class="title">BaseService</span>&lt;<span class="title">UserInfo</span>&gt;,<span class="title">IUserInfoService</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">readonly</span> IUserInfoRepository _userInfoRepository;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="title">UserInfoService</span>(<span class="params">IUserInfoRepository userInfoRepository</span>)</span> &#123; </span><br><span class="line">          <span class="keyword">base</span>.repository = userInfoRepository;</span><br><span class="line">           _userInfoRepository = userInfoRepository;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>同时这里我们也定义了<code>_userInfoRepository</code>成员，同时在其构造方法中对其进行了注入，这里定义<code>_userInfoRepository</code>这个成员的目的是在当前的<code>UserInfoService</code>服务类中独有的方法中需要使用到对应的仓储的时候，使用的就是<code>_userInfoRepository</code>.</p>
<p>当目前为止服务层已经设计完毕。</p>
<h2 id="6、配置依赖注入"><a href="#6、配置依赖注入" class="headerlink" title="6、配置依赖注入"></a>6、配置依赖注入</h2><h3 id="6-1-基本注入实现"><a href="#6-1-基本注入实现" class="headerlink" title="6.1  基本注入实现"></a>6.1  基本注入实现</h3><p>下面我们需要在应用表现层中，导入所有的项目(这里为了防止出现问题，导入所有项目)，然后进行服务以及数据仓储的注入操作。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">builder.Services.Configure&lt;MvcOptions&gt;(c =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    c.Filters.Add&lt;UnitOfWorkFilter&gt;();</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 注入</span></span><br><span class="line">builder.Services.AddScoped&lt;IUserInfoService, UserInfoService&gt;();</span><br><span class="line">builder.Services.AddScoped&lt;IUserInfoRepository, UserInfoRepository&gt;();</span><br></pre></td></tr></table></figure>

<p>在<code>Program.cs</code>文件中添加以上的注入代码。</p>
<p>下面进行测试。</p>
<p>创建<code>UserInfoController.cs</code>，然后添加如下代码</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserInfoController</span> : <span class="title">Controller</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IUserInfoService userInfoService;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">UserInfoController</span>(<span class="params">IUserInfoService userInfoService</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.userInfoService = userInfoService;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Index</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> View();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> IActionResult <span class="title">GetUser</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">           <span class="keyword">var</span> userList = userInfoService.LoadEntities(u=&gt;<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123; data =userList &#125;  );</span><br><span class="line">        &#125;</span><br><span class="line">        [<span class="meta">UnitOfWork(new Type[</span>] &#123; <span class="keyword">typeof</span>(MyDbContext) &#125;)]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">CreateUser</span>()</span> &#123;</span><br><span class="line"></span><br><span class="line">            UserInfo userInfo = <span class="keyword">new</span> UserInfo();</span><br><span class="line">            userInfo.UserName = <span class="string">&quot;lisi&quot;</span>;</span><br><span class="line">            userInfo.UserPhone = <span class="string">&quot;12345678999&quot;</span>;</span><br><span class="line">            userInfo.UserEmail = <span class="string">&quot;lisi@126.com&quot;</span>;</span><br><span class="line">            userInfo.UserPassword = <span class="string">&quot;123&quot;</span>;</span><br><span class="line">            userInfo.Gender = <span class="number">1</span>;</span><br><span class="line">            userInfo.CreateTime = DateTime.Now;</span><br><span class="line">            userInfo.UpdateTime = DateTime.Now;</span><br><span class="line">            userInfo.DelFlag = <span class="literal">true</span>;</span><br><span class="line">            userInfo.PhotoUrl = <span class="string">&quot;b.jpg&quot;</span>;</span><br><span class="line">          <span class="keyword">var</span> user =  <span class="keyword">await</span>  userInfoService.InsertEntityAsync(userInfo);</span><br><span class="line">            <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123; code = <span class="number">200</span>, msg = <span class="string">&quot;添加成功&quot;</span>,user &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>在上面的代码中，在<code>UserInfoController</code>这个构造方法中，完成了<code>IUserInfoService</code>的注入操作。</p>
<p>同时创建了<code>GetUser</code>方法，来查询数据。</p>
<p>通过<code>CreateUser</code>方法来创建用户。注意这里需要执行<code>SaveChanges</code>方法来保存数据，所以添加了<code>UnitOfWork</code>这个<code>Attribute</code>.</p>
<p>启动项目进行测试。</p>
<h3 id="6-2-通过Autofac来实现注入"><a href="#6-2-通过Autofac来实现注入" class="headerlink" title="6.2 通过Autofac来实现注入"></a>6.2 通过<code>Autofac</code>来实现注入</h3><p>是一个轻量级的依赖注入（DI）框架</p>
<p>在上一小节中，我们虽然已经实现了注入的操作，但是面临一个问题，就是每次添加一个服务或者是仓储，都需要手动的进行注入，操作起来比较的麻烦。</p>
<p>这里我们可以通过<code>Autofac</code>这个第三方的注入框架来完成注入的操作。</p>
<p>安装对应的包：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Install-Package Autofac</span><br><span class="line">Install-Package Autofac.Extensions.DependencyInjection </span><br></pre></td></tr></table></figure>

<p>这里我们先在<code>Cms.WebUI</code>这个应用项目中安装以上的包。注意：在【程序包管理器控制台】中选择<code>Cms.WebUI</code></p>
<p>在这个应用项目中创建<code>AutofaceDI</code>文件夹，在该文件夹下面创建<code>AutofacModuleRegister.cs</code>类，该类中的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Autofac;</span><br><span class="line"><span class="keyword">using</span> System.Reflection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.WebUI.AutofaceDI</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AutofacModuleRegister</span>:<span class="title">Autofac.Module</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 重写Autoface中的Load方法，从而实现注入的操作</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Load</span>(<span class="params">ContainerBuilder builder</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">base</span>.Load(builder);</span><br><span class="line">            <span class="keyword">var</span> AppServices = Assembly.Load(<span class="string">&quot;Cms.Service&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> IAppServices = Assembly.Load(<span class="string">&quot;Cms.IService&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> AppRepository = Assembly.Load(<span class="string">&quot;Cms.Repository&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> IAppRepository = Assembly.Load(<span class="string">&quot;Cms.IRepository&quot;</span>);</span><br><span class="line">            <span class="comment">// 这里做了一个约定，服务层中的类都是以Service结尾，仓储项目中的类都是以Repository结尾</span></span><br><span class="line">            builder.RegisterAssemblyTypes(IAppServices, AppServices).Where(a =&gt; a.Name.EndsWith(<span class="string">&quot;Service&quot;</span>)).AsImplementedInterfaces();<span class="comment">//是以接口方式进行注入,</span></span><br><span class="line"></span><br><span class="line">            builder.RegisterAssemblyTypes(IAppRepository, AppRepository).Where(a =&gt; a.Name.EndsWith(<span class="string">&quot;Repository&quot;</span>)).AsImplementedInterfaces();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在上面的代码中，我们重写了<code>Load</code>方法，这个方法中实现了注入的操作。</p>
<p>这里做了一个约定，服务层中的类都是以<code>Service</code>结尾，仓储项目中的类都是以<code>Repository</code>结尾.</p>
<p>修改<code>Program.cs</code>文件中的代码，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*builder.Services.AddScoped&lt;IUserInfoService, UserInfoService&gt;();</span></span><br><span class="line"><span class="comment">builder.Services.AddScoped&lt;IUserInfoRepository, UserInfoRepository&gt;();*/</span></span><br><span class="line"><span class="comment">// 替换容器，初始化一个Autofac的示例。</span></span><br><span class="line">builder.Host.UseServiceProviderFactory(<span class="keyword">new</span> AutofacServiceProviderFactory()).ConfigureContainer&lt;ContainerBuilder&gt;(builder =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    builder.RegisterModule(<span class="keyword">new</span> AutofacModuleRegister());</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>由于<code>.net core</code>内置的<code>IOC</code>容器是<code>IServiceCollection</code>，而这里我们需要使用<code>Autofac</code>来替换对应的容器，所以需要使用<code>AutofacServiceProviderFactory</code>这个工厂类。</p>
<p>当使用第三方容器的时候，同一通过<code>ConfigureContainer</code>这个方法来完成对应的配置，所以在该方法中，添加了所需要的服务。</p>
<h2 id="7、AutoMapper搭建"><a href="#7、AutoMapper搭建" class="headerlink" title="7、AutoMapper搭建"></a>7、<code>AutoMapper</code>搭建</h2><p>现在有一个问题，我们要展示用户的信息，但是并不是展示全部，例如，用户的密码，用户的注册时间等信息不进行展示。</p>
<p>这样应该怎样进行处理呢？</p>
<p>我们可以创建一个<code>UserInfoDTO.CS</code>类，该类中定义的都是在前端需要展示的用户信息。</p>
<p>这里就需要通过<code>AutoMapper</code>这个库，把<code>UserInfo.cs</code>这个实体类，转换成<code>UserInfoDTO.cs</code>这个类。</p>
<p>在<code>cms.WebUI</code>这个应用项目中安装对应的包</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Install-Package AutoMapper.Extensions.Microsoft.DependencyInjection</span><br></pre></td></tr></table></figure>

<p>在<code>cms.WebUI</code>项目中创建文件夹<code>Profiles</code>,在该文件夹下面创建<code>CustomAutoMapperProfile.cs</code>类，该类中的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.WebUI.Profiles</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomAutoMapperProfile</span>:<span class="title">Profile</span> <span class="comment">// 这里需要继承Profile类</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">CustomAutoMapperProfile</span>()</span> &#123;</span><br><span class="line">        </span><br><span class="line">         CreateMap&lt;UserInfo,UserInfoDTO&gt;(); <span class="comment">//在这里我们指定了映射关系</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>以上完成了映射的配置。</p>
<p>下面返回到<code>Program.cs</code>文件中，将<code>CustomAutoMapperProfile</code>添加到容器中。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// // 将AutoMapper添加到容器中</span></span><br><span class="line">builder.Services.AddAutoMapper(<span class="keyword">typeof</span>(CustomAutoMapperProfile));</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = builder.Build();</span><br></pre></td></tr></table></figure>

<p>下面在<code>UserInfoController.cs</code>控制器中，进行注入</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserInfoController</span> : <span class="title">Controller</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">readonly</span> IUserInfoService userInfoService;</span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">readonly</span> IMapper mapper; <span class="comment">// 声明mapper</span></span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="title">UserInfoController</span>(<span class="params">IUserInfoService userInfoService,IMapper mapper</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">this</span>.userInfoService = userInfoService;</span><br><span class="line">           <span class="keyword">this</span>.mapper = mapper; <span class="comment">// 完成注入</span></span><br><span class="line">       &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>下面在<code>GetUser</code>方法中进行映射的操作</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">GetUser</span>()</span></span><br><span class="line">       &#123;</span><br><span class="line">          <span class="keyword">var</span> userList = userInfoService.LoadEntities(u=&gt;<span class="literal">true</span>);</span><br><span class="line">           <span class="keyword">var</span> userDTOList = mapper.Map&lt;List&lt;UserInfoDTO&gt;&gt;(userList.ToList()); <span class="comment">// 这里是完成了list集合的转换，这里如果转换IQueryable，会出现错误。</span></span><br><span class="line">           <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123; data = userDTOList &#125;  );</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>同时，我们还需要在<code>cms.WebUI</code>项目的<code>Models</code>目录下面创建<code>UserInfoDTO.cs</code>类，代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserInfoDTO</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">long</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">string</span>? UserName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">string</span>? UserEmail &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">string</span>? UserPhone &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">int</span> Gender &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 用户头像，存储头像路径</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">string</span>? PhotoUrl &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>我们可以看到这里不会展示用户的密码等信息。</p>
<p>启动项目，访问<code>GetUser</code>方法，查看效果。</p>
<p>通过浏览器中展示的结果，我们可以看到，最终展示的数据中没有用户密码等信息。</p>
<h1 id="二、用户管理"><a href="#二、用户管理" class="headerlink" title="二、用户管理"></a>二、用户管理</h1><h2 id="1、展示用户基本信息"><a href="#1、展示用户基本信息" class="headerlink" title="1、展示用户基本信息"></a>1、展示用户基本信息</h2><p>这里我们使用<code>Miniui</code>这个库来进行前端展示，它是基于<code>jquery</code>库来实现的。</p>
<p>后面我们做前后端分离项目的时候，我们使用的是<code>Vue</code>框架。</p>
<p><code>Miniui</code>文档：<code>http://www.miniui.com/docs/quickstart/</code></p>
<p>把<code>miniui</code>这个文件夹拷贝到<code>wwwroot</code>目录下面，<code>miniui</code>这个文件夹下面包含了对应的样式与<code>js</code>文件。</p>
<p>针对<code>UserInfoController</code>控制器的<code>index</code>方法创建视图，该视图中的代码如下所示：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">@&#123;</span><br><span class="line">    Layout = null;  <span class="comment">&lt;!---注意:这里我们把MVC默认的模版去掉了--&gt;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/lib/jquery/dist/jquery.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">&quot;/miniui/themes/default/miniui.css&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/js/miniui.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Pagination 分页表格<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;padding-bottom:5px;&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span>&gt;</span>员工姓名：<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">id</span>=<span class="string">&quot;key&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">value</span>=<span class="string">&quot;查找&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;search()&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;datagrid1&quot;</span> <span class="attr">class</span>=<span class="string">&quot;mini-datagrid&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width:100%;height:250px;&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">url</span>=<span class="string">&quot;../data/AjaxService.aspx?method=SearchEmployees&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">idField</span>=<span class="string">&quot;id&quot;</span> <span class="attr">allowResize</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">sizeList</span>=<span class="string">&quot;[20,30,50,100]&quot;</span> <span class="attr">pageSize</span>=<span class="string">&quot;20&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">showHeader</span>=<span class="string">&quot;true&quot;</span> <span class="attr">title</span>=<span class="string">&quot;表格面板&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">onmouseup</span>=<span class="string">&quot;return datagrid1_onmouseup()&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">property</span>=<span class="string">&quot;columns&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">type</span>=<span class="string">&quot;indexcolumn&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">field</span>=<span class="string">&quot;loginname&quot;</span> <span class="attr">width</span>=<span class="string">&quot;120&quot;</span> <span class="attr">headerAlign</span>=<span class="string">&quot;center&quot;</span> <span class="attr">allowSort</span>=<span class="string">&quot;true&quot;</span>&gt;</span>员工帐号<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">field</span>=<span class="string">&quot;name&quot;</span> <span class="attr">width</span>=<span class="string">&quot;120&quot;</span> <span class="attr">headerAlign</span>=<span class="string">&quot;center&quot;</span> <span class="attr">allowSort</span>=<span class="string">&quot;true&quot;</span>&gt;</span>姓名<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">field</span>=<span class="string">&quot;gender&quot;</span> <span class="attr">width</span>=<span class="string">&quot;100&quot;</span> <span class="attr">renderer</span>=<span class="string">&quot;onGenderRenderer&quot;</span> <span class="attr">align</span>=<span class="string">&quot;center&quot;</span> <span class="attr">headerAlign</span>=<span class="string">&quot;center&quot;</span>&gt;</span>性别<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">field</span>=<span class="string">&quot;salary&quot;</span> <span class="attr">numberFormat</span>=<span class="string">&quot;¥#,0.00&quot;</span> <span class="attr">align</span>=<span class="string">&quot;right&quot;</span> <span class="attr">width</span>=<span class="string">&quot;100&quot;</span> <span class="attr">allowSort</span>=<span class="string">&quot;true&quot;</span>&gt;</span>薪资<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">field</span>=<span class="string">&quot;age&quot;</span> <span class="attr">width</span>=<span class="string">&quot;100&quot;</span> <span class="attr">allowSort</span>=<span class="string">&quot;true&quot;</span> <span class="attr">decimalPlaces</span>=<span class="string">&quot;2&quot;</span> <span class="attr">dataType</span>=<span class="string">&quot;float&quot;</span>&gt;</span>年龄<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">field</span>=<span class="string">&quot;createtime&quot;</span> <span class="attr">width</span>=<span class="string">&quot;100&quot;</span> <span class="attr">headerAlign</span>=<span class="string">&quot;center&quot;</span> <span class="attr">dateFormat</span>=<span class="string">&quot;yyyy-MM-dd&quot;</span> <span class="attr">allowSort</span>=<span class="string">&quot;true&quot;</span>&gt;</span>创建日期<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这个<code>datagrid1</code>就是<code>miniui</code>这个库提供的表格，具体的示例可以参考官网：</p>
<p><code>http://www.miniui.com/demo/#src=datagrid/pager.html</code></p>
<p>服务端返回的数据格式（具体的使用案例）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.miniui.com/docs/tutorial/datagrid.html</span><br></pre></td></tr></table></figure>

<p>下面修改视图中的代码，如下所示：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>用户信息管理<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;padding-bottom:5px;&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span>&gt;</span>员工姓名：<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">id</span>=<span class="string">&quot;key&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">value</span>=<span class="string">&quot;查找&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;search()&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;datagrid1&quot;</span> <span class="attr">class</span>=<span class="string">&quot;mini-datagrid&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width:60%;height:250px;&quot;</span> <span class="attr">ajaxType</span>=<span class="string">&quot;get&quot;</span> <span class="attr">url</span>=<span class="string">&quot;/userinfo/getuser&quot;</span>         </span></span><br><span class="line"><span class="tag">         <span class="attr">idField</span>=<span class="string">&quot;id&quot;</span> <span class="attr">allowResize</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">sizeList</span>=<span class="string">&quot;[20,30,50,100]&quot;</span> <span class="attr">pageSize</span>=<span class="string">&quot;20&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">showHeader</span>=<span class="string">&quot;true&quot;</span> <span class="attr">title</span>=<span class="string">&quot;用户信息&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">onmouseup</span>=<span class="string">&quot;return datagrid1_onmouseup()&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">property</span>=<span class="string">&quot;columns&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">type</span>=<span class="string">&quot;indexcolumn&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-----注意：这里修改了field属性，该属性的取值是服务端返回的数据--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">field</span>=<span class="string">&quot;id&quot;</span> <span class="attr">width</span>=<span class="string">&quot;120&quot;</span> <span class="attr">headerAlign</span>=<span class="string">&quot;center&quot;</span> <span class="attr">allowSort</span>=<span class="string">&quot;true&quot;</span>&gt;</span>员工编号<span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="comment">&lt;!--只保留了编号排序--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">field</span>=<span class="string">&quot;userName&quot;</span> <span class="attr">width</span>=<span class="string">&quot;120&quot;</span> <span class="attr">headerAlign</span>=<span class="string">&quot;center&quot;</span> &gt;</span>姓名<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">field</span>=<span class="string">&quot;gender&quot;</span> <span class="attr">width</span>=<span class="string">&quot;100&quot;</span> <span class="attr">renderer</span>=<span class="string">&quot;onGenderRenderer&quot;</span> <span class="attr">align</span>=<span class="string">&quot;center&quot;</span> <span class="attr">headerAlign</span>=<span class="string">&quot;center&quot;</span>&gt;</span>性别<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">field</span>=<span class="string">&quot;userEmail&quot;</span>  <span class="attr">align</span>=<span class="string">&quot;right&quot;</span> <span class="attr">width</span>=<span class="string">&quot;100&quot;</span>&gt;</span>用户邮箱<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">field</span>=<span class="string">&quot;userPhone&quot;</span> <span class="attr">width</span>=<span class="string">&quot;100&quot;</span> <span class="attr">allowSort</span>=<span class="string">&quot;true&quot;</span> &gt;</span>手机号码<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">field</span>=<span class="string">&quot;photoUrl&quot;</span> <span class="attr">width</span>=<span class="string">&quot;100&quot;</span> <span class="attr">headerAlign</span>=<span class="string">&quot;center&quot;</span>&gt;</span>头像<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        mini.<span class="title function_">parse</span>(); <span class="comment">// 获取mini对象</span></span></span><br><span class="line"><span class="language-javascript">       <span class="keyword">var</span> grid = mini.<span class="title function_">get</span>(<span class="string">&quot;datagrid1&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> url = <span class="string">&quot;/userinfo/getuser&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">        grid.<span class="title function_">setUrl</span>(url); <span class="comment">// 设置服务端请求的地址</span></span></span><br><span class="line"><span class="language-javascript">        grid.<span class="title function_">load</span>(); <span class="comment">// 加载数据</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>启动项目，查看结果</p>
<h3 id="1-1-处理性别"><a href="#1-1-处理性别" class="headerlink" title="1.1  处理性别"></a>1.1  <strong>处理性别</strong></h3><p>下面处理一下性别的展示</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;div field=<span class="string">&quot;gender&quot;</span> width=<span class="string">&quot;100&quot;</span> renderer=<span class="string">&quot;onGenderRenderer&quot;</span> align=<span class="string">&quot;center&quot;</span> headerAlign=<span class="string">&quot;center&quot;</span>&gt;性别&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<p>在这里添加了一个<code>renderer</code>属性，取值是<code>onGenderRenderer</code>，表示在渲染数据的时候，会调用<code>onGenderRenderer</code>函数</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">        mini.parse();</span><br><span class="line">       <span class="keyword">var</span> grid = mini.<span class="keyword">get</span>(<span class="string">&quot;datagrid1&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> url = <span class="string">&quot;/userinfo/getuser&quot;</span>;</span><br><span class="line">        grid.setUrl(url);</span><br><span class="line">        grid.load();</span><br><span class="line"><span class="comment">//  这里定义了一个数组Genders数组，数组中的每一个元素都是一个对象，id取值是0表示是男</span></span><br><span class="line">        <span class="keyword">var</span> Genders = [&#123; id:<span class="number">0</span>, text: <span class="string">&#x27;男&#x27;</span> &#125;, &#123; id: <span class="number">1</span>, text: <span class="string">&#x27;女&#x27;</span> &#125;];</span><br><span class="line">        <span class="function">function <span class="title">onGenderRenderer</span>(<span class="params">e</span>)</span> &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 参数e中存储的就是性别列传递过来的数据，我们知道，性别这一列中value属性存储的数据是0，或者是1</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, l = Genders.length; i &lt; l; i++) &#123;</span><br><span class="line">                <span class="keyword">var</span> g = Genders[i];</span><br><span class="line">                <span class="keyword">if</span> (g.id == e.<span class="keyword">value</span>) <span class="keyword">return</span> g.text;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h3 id="1-2-头像处理"><a href="#1-2-头像处理" class="headerlink" title="1.2 头像处理"></a>1.2 <strong>头像处理</strong></h3><p>在项目中的<code>wwwroot</code>目录下面创建<code>images</code>文件夹，该文件夹中存储的就是用户的头像照片。</p>
<p>同时，这里需要把数据库中<code>T_UserInfos</code>表中的字段<code>PhotoUrl</code>字段的值修改一下，修改成<code>/images/f.jpg</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">field</span>=<span class="string">&quot;photoUrl&quot;</span> <span class="attr">width</span>=<span class="string">&quot;100&quot;</span> <span class="attr">headerAlign</span>=<span class="string">&quot;center&quot;</span> <span class="attr">renderer</span>=<span class="string">&quot;onPhotoRenderer&quot;</span>&gt;</span>头像<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以看到这里我们也是修改了<code>头像</code>列，为其添加了<code> renderer=&quot;onPhotoRenderer&quot;</code></p>
<p>对应的<code>onPhotoRenderer</code>函数的具体实现如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 展示头像</span></span><br><span class="line">       <span class="function">function <span class="title">onPhotoRenderer</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="string">&quot;&lt;img width =&#x27;100px&#x27; height =&#x27;100px&#x27; src =&quot;</span>+e.<span class="keyword">value</span> + <span class="string">&quot;&gt;&quot;</span></span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-3-分页展示数据"><a href="#1-3-分页展示数据" class="headerlink" title="1.3 分页展示数据"></a>1.3 <strong>分页展示数据</strong></h3><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">GetUser</span>()</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">var</span> pageIndex = <span class="built_in">string</span>.IsNullOrEmpty(Request.Query[<span class="string">&quot;pageIndex&quot;</span>]) ? <span class="number">1</span>:<span class="built_in">int</span>.Parse(Request.Query[<span class="string">&quot;pageIndex&quot;</span>]!)+<span class="number">1</span>; <span class="comment">// 注意：这里浏览器端传递过来的pageIndex的值第一页是0</span></span><br><span class="line">           <span class="keyword">var</span> pageSize = <span class="built_in">string</span>.IsNullOrEmpty(Request.Query[<span class="string">&quot;pageSize&quot;</span>]) ? <span class="number">5</span> : <span class="built_in">int</span>.Parse(Request.Query[<span class="string">&quot;pageSize&quot;</span>]!);</span><br><span class="line">          </span><br><span class="line">           <span class="keyword">var</span> sortOrder = <span class="built_in">string</span>.IsNullOrEmpty(Request.Query[<span class="string">&quot;sortOrder&quot;</span>]) ? <span class="string">&quot;asc&quot;</span> : Request.Query[<span class="string">&quot;sortOrder&quot;</span>].ToString();</span><br><span class="line">           <span class="keyword">var</span> order = sortOrder == <span class="string">&quot;asc&quot;</span> ? <span class="literal">true</span> : <span class="literal">false</span>;</span><br><span class="line">           <span class="comment">/*</span></span><br><span class="line"><span class="comment">                       var userList = userInfoService.LoadEntities(u=&gt;true);*/</span></span><br><span class="line">           <span class="built_in">int</span> totalCount = <span class="number">0</span>;</span><br><span class="line">           <span class="keyword">var</span> userList = userInfoService.LoadPageEntities&lt;<span class="built_in">long</span>&gt;(pageIndex, pageSize, <span class="keyword">out</span> totalCount, u =&gt; u.DelFlag == <span class="literal">true</span>, u =&gt; u.Id, order);</span><br><span class="line">           <span class="keyword">var</span> userDTOList = mapper.Map&lt;List&lt;UserInfoDTO&gt;&gt;(userList.ToList());</span><br><span class="line">           <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123; total = totalCount, data = userDTOList &#125;  ); <span class="comment">// 返回的数据格式，总的记录数必须赋值给total属性</span></span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>同时，前端能够看到展示的效果，调整了<code>sizeList,pageSize</code>属性的值。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;datagrid1&quot;</span> <span class="attr">class</span>=<span class="string">&quot;mini-datagrid&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width:60%;height:250px;&quot;</span> <span class="attr">ajaxType</span>=<span class="string">&quot;get&quot;</span> <span class="attr">url</span>=<span class="string">&quot;/userinfo/getuser&quot;</span>         </span></span><br><span class="line"><span class="tag">         <span class="attr">idField</span>=<span class="string">&quot;id&quot;</span> <span class="attr">allowResize</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">sizeList</span>=<span class="string">&quot;[2,5,10,30]&quot;</span> <span class="attr">pageSize</span>=<span class="string">&quot;2&quot;</span></span></span><br></pre></td></tr></table></figure>

<h2 id="2、用户信息搜索"><a href="#2、用户信息搜索" class="headerlink" title="2、用户信息搜索"></a>2、用户信息搜索</h2><p>在页面中增加搜索框，如下所示：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;padding-bottom:5px;&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span>&gt;</span>员工姓名：<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">id</span>=<span class="string">&quot;name&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span>&gt;</span>员工邮箱：<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">id</span>=<span class="string">&quot;email&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">value</span>=<span class="string">&quot;查找&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;search()&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>search</code>方法的实现</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 用户信息搜索</span></span><br><span class="line">      <span class="keyword">function</span> <span class="title function_">search</span>(<span class="params"></span>)&#123;</span><br><span class="line">          <span class="keyword">var</span> searchName = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;name&quot;</span>).<span class="property">value</span>;</span><br><span class="line">          <span class="keyword">var</span> searchEmail = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;email&quot;</span>).<span class="property">value</span>;</span><br><span class="line">          grid.<span class="title function_">load</span>(&#123;<span class="attr">name</span>:searchName,<span class="attr">email</span>:searchEmail&#125;); <span class="comment">//发送请求，加载表格中的数据，这里可以参考文档</span></span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>服务端实现：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> order = sortOrder == <span class="string">&quot;asc&quot;</span> ? <span class="literal">true</span> : <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">var</span> userName = Request.Query[<span class="string">&quot;name&quot;</span>];</span><br><span class="line"><span class="keyword">var</span> userEmail = Request.Query[<span class="string">&quot;email&quot;</span>];</span><br></pre></td></tr></table></figure>

<p>这里首先接收传递过来的搜索条件。</p>
<p>然后作为<code>LoadPageEntities</code>方法的查询参数，但是这样导致了<code>LoadPageEntities</code>方法的参数比较多。</p>
<p>所以这里我们可以对参数进行封装处理。</p>
<p>在<code>Cms.Entity</code>这个项目中，创建一个文件夹<code>Search</code>，在该文件夹下面创建<code>userInfoSearch.cs</code>类，该类中构建了搜索条件，代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.WebUI.Models.Search</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">userInfoSearch</span>:<span class="title">BaseSearch</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? UName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? UEmail &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>搜索的结果展示也需要分页展示，所以分页展示所需要的属性封装到了<code>BaseSearch</code>类中，这里的<code>UserInfoSerach</code>类会继承<code>BaseSearch</code>类。</p>
<p><code>BaseSerach.cs</code>类中的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.WebUI.Models.Search</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BaseSearch</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> PageIndex &#123; <span class="keyword">get</span>;<span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> PageSize &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> TotalCount &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">bool</span> Order &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>下面返回到<code>UserInfoController.cs</code>这个控制器中构建搜索的条件，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> userName = Request.Query[<span class="string">&quot;name&quot;</span>];</span><br><span class="line">       <span class="keyword">var</span> userEmail = Request.Query[<span class="string">&quot;email&quot;</span>];</span><br><span class="line">       <span class="comment">/*</span></span><br><span class="line"><span class="comment">                   var userList = userInfoService.LoadEntities(u=&gt;true);*/</span></span><br><span class="line">       <span class="built_in">int</span> totalCount = <span class="number">0</span>;</span><br><span class="line">       <span class="comment">// 构建搜索条件</span></span><br><span class="line">       userInfoSearch userInfoSearch = <span class="keyword">new</span> userInfoSearch()</span><br><span class="line">       &#123;</span><br><span class="line">           UName = userName,</span><br><span class="line">           UEmail = userEmail,</span><br><span class="line">           PageIndex = pageIndex,</span><br><span class="line">           PageSize = pageSize,</span><br><span class="line">           TotalCount = totalCount,</span><br><span class="line">           Order = order</span><br><span class="line">       &#125;;</span><br></pre></td></tr></table></figure>

<p>然后将<code>userInfoSearch</code>对象传递给服务层，但是在服务层中定义的方法，没有满足该条件的。</p>
<p>所以修改<code>IUserInfoService.cs</code>这个接口中的代码，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IUserInfoService</span>:<span class="title">IBaseService</span>&lt;<span class="title">UserInfo</span>&gt;</span><br><span class="line">   &#123;</span><br><span class="line">       <span class="function">IQueryable&lt;UserInfo&gt; <span class="title">LoadSearchEntities</span>(<span class="params">userInfoSearch userInfoSearch, <span class="built_in">bool</span> delFlag</span>)</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>这里我们又定义了一个<code>LoadSearchEntities</code>方法。</p>
<p>下面要实现该方法，修改<code>UserInfoService.cs</code>这个业务类中的代码，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">readonly</span> IUserInfoRepository _userInfoRepository;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">UserInfoService</span>(<span class="params">IUserInfoRepository userInfoRepository</span>)</span> &#123; </span><br><span class="line">           <span class="keyword">base</span>.repository = userInfoRepository;</span><br><span class="line">            _userInfoRepository = userInfoRepository;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 搜索方法的实现</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> IQueryable&lt;UserInfo&gt; <span class="title">LoadSearchEntities</span>(<span class="params">userInfoSearch userInfoSearch, <span class="built_in">bool</span> delFlag</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> temp =  _userInfoRepository.LoadEntities(u =&gt; u.DelFlag == delFlag);</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrEmpty(userInfoSearch.UName))</span><br><span class="line">            &#123;</span><br><span class="line">                temp = temp.Where&lt;UserInfo&gt;(u=&gt;u.UserName!.Contains(userInfoSearch.UName));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrEmpty(userInfoSearch.UEmail))</span><br><span class="line">            &#123;</span><br><span class="line">                temp = temp.Where&lt;UserInfo&gt;(u=&gt;u.UserEmail!.Contains(userInfoSearch.UEmail));</span><br><span class="line">            &#125;</span><br><span class="line">            userInfoSearch.TotalCount = temp.Count();</span><br><span class="line">            <span class="keyword">if</span> (userInfoSearch.Order)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> temp.OrderBy&lt;UserInfo,<span class="built_in">long</span>&gt;(u =&gt; u.Id).Skip&lt;UserInfo&gt;((userInfoSearch.PageIndex<span class="number">-1</span>)*userInfoSearch.PageSize).Take&lt;UserInfo&gt;(userInfoSearch.PageSize);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> temp.OrderByDescending&lt;UserInfo, <span class="built_in">long</span>&gt;(u =&gt; u.Id).Skip&lt;UserInfo&gt;((userInfoSearch.PageIndex - <span class="number">1</span>) * userInfoSearch.PageSize).Take&lt;UserInfo&gt;(userInfoSearch.PageSize);</span><br><span class="line">            &#125;</span><br><span class="line">           </span><br><span class="line">		<span class="keyword">return</span> temp;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>下面再次返回到<code>UserInfoController.cs</code>这个控制器中进行代码的修改</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">int</span> totalCount = <span class="number">0</span>;</span><br><span class="line">           <span class="comment">// 构建搜索条件</span></span><br><span class="line">           userInfoSearch userInfoSearch = <span class="keyword">new</span> userInfoSearch()</span><br><span class="line">           &#123;</span><br><span class="line">               UName = userName,</span><br><span class="line">               UEmail = userEmail,</span><br><span class="line">               PageIndex = pageIndex,</span><br><span class="line">               PageSize = pageSize,</span><br><span class="line">               TotalCount = totalCount,</span><br><span class="line">               Order = order</span><br><span class="line">           &#125;;</span><br><span class="line">           <span class="comment">/* var userList = userInfoService.LoadPageEntities&lt;long&gt;(pageIndex, pageSize, out totalCount, u =&gt; u.DelFlag == true, u =&gt; u.Id, order);*/</span></span><br><span class="line"><span class="comment">// 这里调用了LoadSearchEntities方法进行搜索，传递的是对象userInfoSearch，true表示展示的是没有被逻辑删除的用户信息</span></span><br><span class="line">           <span class="keyword">var</span> userList = userInfoService.LoadSearchEntities(userInfoSearch,<span class="literal">true</span>);</span><br><span class="line">           <span class="keyword">var</span> userDTOList = mapper.Map&lt;List&lt;UserInfoDTO&gt;&gt;(userList.ToList());</span><br><span class="line">           <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123; total = userInfoSearch.TotalCount, data = userDTOList &#125;  );<span class="comment">// 注意：这里返回的总的记录数是userInfoSearch.TotalCount属性中的值</span></span><br></pre></td></tr></table></figure>

<p>注意：这里返回的总的记录数是<code>userInfoSearch.TotalCount</code>属性中的值</p>
<p>启动项目进行测试。</p>
<p>当然，这里还有一个小问题，就是当调用<code>LoadSearchEntities</code>方法的时候，传递的<code>true</code>表示的是查询没有被逻辑删除的用户信息，但是这里写成<code>true</code>，含义不明确，最好定义成枚举类型。</p>
<p>在<code>Cms.Entity</code>类库项目中创建一个<code>Enum</code>文件夹，在该文件夹中创建一个<code>DelFlagEnum.cs</code>文件，该文件中的代码，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.Entity.Enum</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">enum</span> DelFlagEnum</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 逻辑删除</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        logicDelete = <span class="number">0</span>,</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 正常</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        Normal = <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>返回到<code>UserInfoController.cs</code>控制器中，进行代码的修改</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">bool</span> delFlag =Convert.ToBoolean(DelFlagEnum.Normal);</span><br><span class="line">         <span class="keyword">var</span> userList = userInfoService.LoadSearchEntities(userInfoSearch, delFlag);</span><br></pre></td></tr></table></figure>

<p>这里获取枚举中的<code>DelFlagEnum.Normal</code>，并且将其转换成<code>bool</code>类型。</p>
<p>然后作为了<code>LoadSearchEntities</code>方法的参数。</p>
<h2 id="3、删除用户信息"><a href="#3、删除用户信息" class="headerlink" title="3、删除用户信息"></a>3、删除用户信息</h2><p>参考文档：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.miniui.com/demo/#src=datagrid/rowedit.html</span><br></pre></td></tr></table></figure>

<p>前端视图页面处理</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">field</span>=<span class="string">&quot;photoUrl&quot;</span> <span class="attr">width</span>=<span class="string">&quot;100&quot;</span> <span class="attr">headerAlign</span>=<span class="string">&quot;center&quot;</span> <span class="attr">renderer</span>=<span class="string">&quot;onPhotoRenderer&quot;</span>&gt;</span>头像<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--这里添加了操作列--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">name</span>=<span class="string">&quot;action&quot;</span> <span class="attr">width</span>=<span class="string">&quot;120&quot;</span> <span class="attr">headerAlign</span>=<span class="string">&quot;center&quot;</span> <span class="attr">align</span>=<span class="string">&quot;center&quot;</span> <span class="attr">renderer</span>=<span class="string">&quot;onActionRenderer&quot;</span> <span class="attr">cellStyle</span>=<span class="string">&quot;padding:0;&quot;</span>&gt;</span>操作<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>onActionRenderer</code>函数的实现如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// “操作”列实现</span></span><br><span class="line">      <span class="keyword">function</span> <span class="title function_">onActionRenderer</span>(<span class="params">e</span>) &#123;</span><br><span class="line">          </span><br><span class="line">          <span class="keyword">var</span> record = e.<span class="property">record</span>;</span><br><span class="line">          <span class="keyword">var</span> uid = record.<span class="property">id</span>;</span><br><span class="line">          <span class="keyword">var</span> s = <span class="string">&#x27;&lt;a class=&quot;Edit_Button&quot; href=&quot;javascript:editRow(\&#x27;&#x27;</span> + uid + <span class="string">&#x27;\&#x27;)&quot; &gt;编辑&lt;/a&gt;&#x27;</span></span><br><span class="line">              + <span class="string">&#x27; &lt;a class=&quot;Delete_Button&quot; href=&quot;javascript:delRow(\&#x27;&#x27;</span> + uid + <span class="string">&#x27;\&#x27;)&quot;&gt;删除&lt;/a&gt;&#x27;</span>;</span><br><span class="line">         </span><br><span class="line">          <span class="keyword">return</span> s;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>以上代码参考文档中的案例。</p>
<p><code>delRow</code>函数的实现如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 删除方法</span></span><br><span class="line">      <span class="keyword">function</span> <span class="title function_">delRow</span>(<span class="params">userId</span>)&#123;</span><br><span class="line">          <span class="keyword">if</span>(<span class="title function_">confirm</span>(<span class="string">&quot;确定要删除该记录吗？&quot;</span>))&#123;</span><br><span class="line">              grid.<span class="title function_">loading</span>(<span class="string">&quot;删除中，请稍后......&quot;</span>);</span><br><span class="line">              $.<span class="title function_">ajax</span>(&#123;</span><br><span class="line">                  <span class="attr">url</span>:<span class="string">&#x27;/userInfo/deleteUser?userId=&#x27;</span>+userId,</span><br><span class="line">                  <span class="attr">success</span>:<span class="keyword">function</span>(<span class="params">data</span>)&#123;</span><br><span class="line">                      <span class="keyword">if</span>(data.<span class="property">code</span> ==<span class="number">200</span>)&#123;</span><br><span class="line">                          grid.<span class="title function_">reload</span>();</span><br><span class="line">                          <span class="title function_">alert</span>(data.<span class="property">msg</span>);</span><br><span class="line">                      &#125;</span><br><span class="line">                  &#125;,</span><br><span class="line">                  <span class="attr">error</span>:<span class="keyword">function</span>(<span class="params">data</span>)&#123;</span><br><span class="line">                      <span class="title function_">alert</span>(data.<span class="property">msg</span>)</span><br><span class="line">                  &#125;</span><br><span class="line"></span><br><span class="line">              &#125;);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>这里请求了<code>/userInfo/deleteUser</code>，同时传递了<code>userId</code>这个用户的编号。</p>
<p><code>DeleteUser</code>方法的实现如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">region</span> 删除用户信息</span></span><br><span class="line">       [<span class="meta">UnitOfWork(new Type[</span>] &#123; <span class="keyword">typeof</span>(MyDbContext) &#125;)] <span class="comment">//注意：这里需要添加UnitOfWorkAttrbuite</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">DeleteUser</span>()</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">var</span> userId =Convert.ToInt32(Request.Query[<span class="string">&quot;userId&quot;</span>]);</span><br><span class="line">           <span class="built_in">bool</span> delFlag = Convert.ToBoolean(DelFlagEnum.logicDelete); <span class="comment">// 逻辑删除</span></span><br><span class="line">           <span class="keyword">var</span> userInfo = <span class="keyword">await</span> userInfoService.LoadEntities(u=&gt;u.Id == userId).FirstOrDefaultAsync();</span><br><span class="line">           <span class="keyword">if</span> (userInfo != <span class="literal">null</span>)</span><br><span class="line">           &#123;</span><br><span class="line">               userInfo.DelFlag = delFlag;</span><br><span class="line">              <span class="keyword">await</span> userInfoService.UpdateEntityAsync(userInfo);</span><br><span class="line">               <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123; code = <span class="number">200</span>,msg =<span class="string">&quot;删除成功&quot;</span> &#125;);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">else</span></span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123; code = <span class="number">501</span>, msg = <span class="string">&quot;删除失败&quot;</span> &#125;);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="meta">#<span class="keyword">endregion</span></span></span><br></pre></td></tr></table></figure>

<h2 id="4、批量删除用户"><a href="#4、批量删除用户" class="headerlink" title="4、批量删除用户"></a>4、批量删除用户</h2><p>在上一小节中，我们虽然实现了删除操作，但是每次只能删除一条记录，在这一小节中，我们来看一下怎样批量删除多条记录。</p>
<p>前端页面的处理。</p>
<p>参考文档:<code>http://www.miniui.com/demo/#src=datagrid/datagrid.html</code></p>
<p>首先增加一个复选框列</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;datagrid1&quot;</span> <span class="attr">class</span>=<span class="string">&quot;mini-datagrid&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width:60%;height:550px;&quot;</span> <span class="attr">ajaxType</span>=<span class="string">&quot;get&quot;</span> <span class="attr">url</span>=<span class="string">&quot;/userinfo/getuser&quot;</span>         </span></span><br><span class="line"><span class="tag">         <span class="attr">idField</span>=<span class="string">&quot;id&quot;</span> <span class="attr">allowResize</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">sizeList</span>=<span class="string">&quot;[2,5,10,30]&quot;</span> <span class="attr">pageSize</span>=<span class="string">&quot;2&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">showHeader</span>=<span class="string">&quot;true&quot;</span> <span class="attr">title</span>=<span class="string">&quot;用户信息&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">multiSelect</span>=<span class="string">&quot;true&quot;</span>  <span class="attr">allowCellEdit</span>=<span class="string">&quot;true&quot;</span> <span class="attr">allowCellSelect</span>=<span class="string">&quot;true&quot;</span> &lt;!<span class="attr">--注意</span>：<span class="attr">这里必须添加这三个属性</span>，<span class="attr">否则复选框无法选中--</span>&gt;</span>        </span><br><span class="line">         onmouseup=&quot;return datagrid1_onmouseup()&quot;&gt;</span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">property</span>=<span class="string">&quot;columns&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">type</span>=<span class="string">&quot;indexcolumn&quot;</span> &gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">type</span>=<span class="string">&quot;checkcolumn&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="comment">&lt;!--这里增加了一个复选框列--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">field</span>=<span class="string">&quot;id&quot;</span> <span class="attr">width</span>=<span class="string">&quot;120&quot;</span> <span class="attr">headerAlign</span>=<span class="string">&quot;center&quot;</span>&gt;</span>编号<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>同时在<code>datagrid</code>这个表格上面增加“删除按钮”</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--这里添加  增加按钮与删除按钮 开始--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;width:800px;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;mini-toolbar&quot;</span> <span class="attr">style</span>=<span class="string">&quot;border-bottom:0;padding:0px;&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">table</span> <span class="attr">style</span>=<span class="string">&quot;width:100%;&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">td</span> <span class="attr">style</span>=<span class="string">&quot;width:100%;&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;mini-button&quot;</span> <span class="attr">iconCls</span>=<span class="string">&quot;icon-add&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;add()&quot;</span>&gt;</span>增加<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;mini-button&quot;</span> <span class="attr">iconCls</span>=<span class="string">&quot;icon-remove&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;remove()&quot;</span>&gt;</span>删除<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--这里添加  增加按钮与删除按钮  结束--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;datagrid1&quot;</span> <span class="attr">class</span>=<span class="string">&quot;mini-datagrid&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width:60%;height:550px;&quot;</span> <span class="attr">ajaxType</span>=<span class="string">&quot;get&quot;</span> <span class="attr">url</span>=<span class="string">&quot;/userinfo/getuser&quot;</span>       </span></span><br></pre></td></tr></table></figure>

<p>同时，按钮上面有图标，所以这里还需要引入对应的样式</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/lib/jquery/dist/jquery.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">&quot;/miniui/themes/default/miniui.css&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">&quot;/miniui/themes/icons.css&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> /&gt;</span> <span class="comment">&lt;!--这里添加了图标样式--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">&quot;/miniui/themes/bootstrap/skin.css&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> /&gt;</span> <span class="comment">&lt;!--这里给表格换成了bootstrap的样式---&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/js/miniui.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>当单击“删除”按钮的时候，要调用<code>remove</code>这个函数，该函数的实现方式如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 批量删除</span></span><br><span class="line">       <span class="keyword">function</span> <span class="title function_">remove</span>(<span class="params"></span>)&#123;</span><br><span class="line">           <span class="keyword">var</span> rows = grid.<span class="title function_">getSelecteds</span>();</span><br><span class="line">           <span class="keyword">if</span>(rows.<span class="property">length</span> &gt; <span class="number">0</span>)&#123;</span><br><span class="line">               <span class="keyword">if</span> (<span class="title function_">confirm</span>(<span class="string">&quot;确定删除选中记录？&quot;</span>)) &#123;</span><br><span class="line">                   <span class="keyword">var</span> ids = [];</span><br><span class="line">                   <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, l = rows.<span class="property">length</span>; i &lt; l; i++) &#123;</span><br><span class="line">                       <span class="keyword">var</span> r = rows[i];</span><br><span class="line">                       ids.<span class="title function_">push</span>(r.<span class="property">id</span>);</span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="keyword">var</span> id = ids.<span class="title function_">join</span>(<span class="string">&#x27;,&#x27;</span>);</span><br><span class="line">                   grid.<span class="title function_">loading</span>(<span class="string">&quot;操作中，请稍后......&quot;</span>);</span><br><span class="line">                   $.<span class="title function_">ajax</span>(&#123;</span><br><span class="line">                       <span class="attr">url</span>: <span class="string">&quot;/userInfo/deleteUsers?userIds=&quot;</span> + id,</span><br><span class="line">                       <span class="attr">success</span>: <span class="keyword">function</span> (<span class="params">data</span>) &#123;</span><br><span class="line">                           <span class="keyword">if</span>(data.<span class="property">code</span> === <span class="number">200</span>)&#123;</span><br><span class="line">                               grid.<span class="title function_">reload</span>();</span><br><span class="line">                               <span class="title function_">alert</span>(data.<span class="property">msg</span>);</span><br><span class="line">                           &#125;</span><br><span class="line">                           </span><br><span class="line">                       &#125;,</span><br><span class="line">                       <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">               <span class="title function_">alert</span>(<span class="string">&quot;请选中一条记录&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>下面实现<code>UserInfo</code>控制器中的<code>DeleteUsers</code>方法</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">region</span> 批量删除用户</span></span><br><span class="line">        [<span class="meta">UnitOfWork(new Type[</span>] &#123; <span class="keyword">typeof</span>(MyDbContext) &#125;)] <span class="comment">// 注意：这里使用了UnitOfWork这个Attribute</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">DeleteUsers</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">string</span> strId = Request.Query[<span class="string">&quot;userIds&quot;</span>]!;</span><br><span class="line">            <span class="built_in">string</span>[]strIds = strId.Split(<span class="string">&#x27;,&#x27;</span>);</span><br><span class="line">            List&lt;<span class="built_in">long</span>&gt; list = <span class="keyword">new</span> List&lt;<span class="built_in">long</span>&gt;(); <span class="comment">// 注意：这里指定的类型是long</span></span><br><span class="line">            <span class="keyword">foreach</span>(<span class="built_in">string</span> id <span class="keyword">in</span> strIds)</span><br><span class="line">            &#123;</span><br><span class="line">                list.Add(Convert.ToInt32(id));</span><br><span class="line">            &#125;</span><br><span class="line">           <span class="keyword">await</span> userInfoService.DeleteEntities(list); <span class="comment">// 这里需要进行批量删除，需要再服务层中定义该方法。</span></span><br><span class="line">            <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123; code = <span class="number">200</span>, msg = <span class="string">&quot;删除成功&quot;</span> &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br></pre></td></tr></table></figure>

<p>说明：以上控制器中的方法的代码业务是否太重，这里，我们完全可以把<code>strIds</code>传递到<code>DeleteEntities</code>这业务方法中，在该方法中执行循环操作，尽量让控制器中的方法不包含业务的内容。</p>
<p>修改<code>IUserInfoService.cs</code>这个接口中的代码，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IUserInfoService</span>:<span class="title">IBaseService</span>&lt;<span class="title">UserInfo</span>&gt;</span><br><span class="line">   &#123;</span><br><span class="line">       <span class="function">IQueryable&lt;UserInfo&gt; <span class="title">LoadSearchEntities</span>(<span class="params">userInfoSearch userInfoSearch, <span class="built_in">bool</span> delFlag</span>)</span>;</span><br><span class="line">    <span class="comment">// 这里声明了DeleteEntities方法</span></span><br><span class="line">       <span class="function">Task&lt;<span class="built_in">bool</span>&gt;  <span class="title">DeleteEntities</span>(<span class="params">List&lt;<span class="built_in">long</span>&gt; list</span>)</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>下面修改<code>UserInfoService.cs</code>这个类中的代码，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> 批量删除</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;list&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;NotImplementedException&quot;&gt;</span><span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;<span class="built_in">bool</span>&gt; <span class="title">DeleteEntities</span>(<span class="params">List&lt;<span class="built_in">long</span>&gt; list</span>)</span></span><br><span class="line">      &#123;</span><br><span class="line">          <span class="keyword">var</span> userInfoList = _userInfoRepository.LoadEntities(u =&gt; list.Contains(u.Id));</span><br><span class="line">          <span class="keyword">foreach</span> (<span class="keyword">var</span> userInfo <span class="keyword">in</span> userInfoList)</span><br><span class="line">          &#123;</span><br><span class="line">              userInfo.DelFlag =Convert.ToBoolean(DelFlagEnum.logicDelete); <span class="comment">//进行逻辑删除</span></span><br><span class="line">            <span class="keyword">await</span>  _userInfoRepository.UpdateEntityAsync(userInfo);  <span class="comment">// 这里执行了更新的操作。</span></span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">await</span> Task.FromResult(<span class="literal">true</span>);</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>当然，这里会生成多条<code>select</code>和<code>update</code>语句，可以使用我们前面讲解的批量删除的方式。</p>
<p>启动项目进行测试。</p>
<h2 id="5、新增用户1"><a href="#5、新增用户1" class="headerlink" title="5、新增用户1"></a>5、新增用户1</h2><p>前端视图中的代码修改（这里修改<code>UserInfoController.cs</code>控制器中的<code>index</code>方法对应的<code>index</code>视图）</p>
<p>在<code>index</code>这个视图中，首先添加一个<code>新增</code>按钮</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;td style=<span class="string">&quot;width:100%;&quot;</span>&gt;</span><br><span class="line">                        &lt;a <span class="keyword">class</span>=<span class="string">&quot;mini-button&quot;</span> iconCls=<span class="string">&quot;icon-add&quot;</span> onclick=<span class="string">&quot;add()&quot;</span>&gt;增加&lt;/a&gt;</span><br><span class="line">                        &lt;a <span class="keyword">class</span>=<span class="string">&quot;mini-button&quot;</span> iconCls=<span class="string">&quot;icon-remove&quot;</span> onclick=<span class="string">&quot;remove()&quot;</span>&gt;删除&lt;/a&gt;</span><br><span class="line">                    &lt;/td&gt;</span><br></pre></td></tr></table></figure>

<p>当单击<code>增加</code>按钮的时候，会调用<code>add</code>这个函数，该函数的实现如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 新增用户信息</span></span><br><span class="line">       <span class="comment">// http://www.miniui.com/docs/api/index.html#ui=messagebox </span></span><br><span class="line">       <span class="comment">// 以上是弹出窗口文档</span></span><br><span class="line">       <span class="keyword">function</span> <span class="title function_">add</span>(<span class="params"></span>)&#123;</span><br><span class="line">           mini.<span class="title function_">open</span>(&#123;</span><br><span class="line">               <span class="attr">targetWindow</span>: <span class="variable language_">window</span>,</span><br><span class="line">               <span class="attr">url</span>: <span class="string">&quot;/userInfo/showAdd&quot;</span>,</span><br><span class="line">               <span class="attr">title</span>: <span class="string">&quot;新增员工&quot;</span>, <span class="attr">width</span>: <span class="number">600</span>, <span class="attr">height</span>: <span class="number">400</span>,</span><br><span class="line">               <span class="attr">onload</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">                   <span class="keyword">var</span> iframe = <span class="variable language_">this</span>.<span class="title function_">getIFrameEl</span>();</span><br><span class="line">                   iframe.<span class="property">contentWindow</span>;<span class="comment">// 文档中这里调用了SetData方法，指的是在打开的页面中会有setData函数，而我们这里showAdd方法对应的视图中没有定义SetData函数，</span></span><br><span class="line">                   <span class="comment">//所以这里不用调用</span></span><br><span class="line">               &#125;,</span><br><span class="line">               <span class="attr">ondestroy</span>: <span class="keyword">function</span> (<span class="params">action</span>) &#123;</span><br><span class="line"></span><br><span class="line">                   grid.<span class="title function_">reload</span>();</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;);</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>在以上的代码中，会弹出一个窗口，在该窗口中展示的就是<code>showAdd</code>这个视图页面。</p>
<p>关于该页面中的内容就是添加用户信息的表单。</p>
<p>关于该表单的设计，可以参考如下文档中的内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.miniui.com/demo/#src=datagrid/datagrid.html</span><br></pre></td></tr></table></figure>

<p>在该文档中，有如下案例</p>
<p>弹出窗口所展示的表单：参考文档：<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images%5C958.png"></p>
<p>通过上图可以看到，这里弹出的窗口中展示的是<code>EmployeeWindow.html 页面</code>。该页面中也是一个表单页面，具体访问地址，如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://www.miniui.com/demo/#src=datagrid/datagrid.html</span><br><span class="line">具体的表单示例代码，访问EmployeeWindow.html 页面，该页面的地址：www.miniui.com/demo/CommonLibs/EmployeeWindow.html</span><br><span class="line">打开该页面以后，查看对应的HTML代码</span><br></pre></td></tr></table></figure>

<p>下面我们需要在<code>UserInfoController.cs</code>这个控制器中创建<code>ShowAdd</code>这个方法，该方法的作用就是为了呈现<code>ShowAdd</code>视图，代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">ShowAdd</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">           <span class="keyword">return</span> View();</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p><code>ShowAdd</code>方法对应的视图中的代码，如下所示：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">@&#123;</span><br><span class="line">    Layout = null;</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/lib/jquery/dist/jquery.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">&quot;/miniui/themes/default/miniui.css&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">&quot;/miniui/themes/icons.css&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">&quot;/miniui/themes/bootstrap/skin.css&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/js/miniui.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/js/form-serialize.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span> <span class="comment">&lt;!--这里需要引入form-serialize.js文件--&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">&quot;form1&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mini-hidden</span> <span class="attr">name</span>=<span class="string">&quot;id&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">mini-hidden</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;padding-left:11px;padding-bottom:5px;&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">table</span> <span class="attr">style</span>=<span class="string">&quot;table-layout:fixed;&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">td</span> <span class="attr">style</span>=<span class="string">&quot;width:90px;&quot;</span>&gt;</span>用户姓名：<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">td</span> <span class="attr">style</span>=<span class="string">&quot;width:150px;&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span> =<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;UserName&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;请输入姓名&quot;</span> <span class="attr">autocomplete</span>=<span class="string">&quot;off&quot;</span> /&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">td</span> <span class="attr">style</span>=<span class="string">&quot;width:90px;&quot;</span>&gt;</span>用户密码<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;UserPassword&quot;</span>  <span class="attr">placeholder</span>=<span class="string">&quot;请输入密码&quot;</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">td</span> <span class="attr">style</span>=<span class="string">&quot;width:90px;&quot;</span>&gt;</span>用户邮箱：<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;UserEmail&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;请输入邮箱&quot;</span> <span class="attr">autocomplete</span> =<span class="string">&quot;off&quot;</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">td</span> <span class="attr">style</span>=<span class="string">&quot;width:90px;&quot;</span>&gt;</span>手机号码：<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;UserPhone&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;请输入手机号码&quot;</span> <span class="attr">autocomplete</span> =<span class="string">&quot;off&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">input</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">td</span> <span class="attr">style</span>=<span class="string">&quot;width:90px;&quot;</span>&gt;</span>性别：<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">select</span> <span class="attr">name</span>=<span class="string">&quot;gender&quot;</span> <span class="attr">class</span>=<span class="string">&quot;mini-radiobuttonlist&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;0&quot;</span>&gt;</span>男<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span>&gt;</span>女<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">td</span>&gt;</span>头像：<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">input</span> <span class="attr">class</span>=<span class="string">&quot;mini-htmlfile&quot;</span> <span class="attr">name</span>=<span class="string">&quot;PhotoUrl&quot;</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> /&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;text-align:center;padding:10px;&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">mini-button</span> <span class="attr">onclick</span>=<span class="string">&quot;onOk&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width:60px;margin-right:20px;&quot;</span>&gt;</span>确定<span class="tag">&lt;/<span class="name">mini-button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">mini-button</span> <span class="attr">onclick</span>=<span class="string">&quot;onCancel&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width:60px;&quot;</span>&gt;</span>取消<span class="tag">&lt;/<span class="name">mini-button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> form = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;form1&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 关闭窗口</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">onCancel</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">window</span>.<span class="title class_">CloseOwnerWindow</span>();</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 保存表单中的数据</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">onOk</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="title class_">SaveData</span>();</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">SaveData</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> data = <span class="title function_">serialize</span>(form);</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;data = &quot;</span>,data);</span></span><br><span class="line"><span class="language-javascript">        $.<span class="title function_">ajax</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">url</span>: <span class="string">&#x27;/userInfo/CreateUser&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">method</span>:<span class="string">&quot;post&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">data</span>:data,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">success</span>:<span class="keyword">function</span>(<span class="params">data</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">            &#125;,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">error</span>:<span class="keyword">function</span>(<span class="params">error</span>)&#123;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;)</span></span><br><span class="line"><span class="language-javascript">        </span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">  </span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>当单击<code>取消按钮</code>的时候会调用<code>onCancel</code>方法，该方法就是调用了<code>window.CloseOwnerWindow</code>中的方法关闭了窗口。</p>
<p>当单击<code>确定</code>按钮的时候，会调用<code>SaveData</code>方法，通过<code>serialize</code>方法获取表单中的数据，然后发送<code>ajax</code>请求。</p>
<p>这里有一个问题，就是用户头像的问题。这里需要先上传用户的头像，然后再把头像的地址发送到服务端，最终保存到数据库中。</p>
<h2 id="6、用户头像上传"><a href="#6、用户头像上传" class="headerlink" title="6、用户头像上传"></a>6、用户头像上传</h2><p>下面修改<code>ShowAdd.cshtml</code>这个视图文件中的代码</p>
<p>首先引入样式与<code>axios.js</code>这个文件</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/lib/bootstrap/dist/css/bootstrap.css&quot;</span>&gt;</span> <span class="comment">&lt;!--这里引入了bootstrap.css--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/js/miniui.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/js/form-serialize.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span> =<span class="string">&quot;/js/axios.js&quot;</span> &gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span> <span class="comment">&lt;!--这里引入了axios.js--&gt;</span></span><br></pre></td></tr></table></figure>

<p>下面在添加样式，控制上传成功的头像的展示效果</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span> =<span class="string">&quot;/js/axios.js&quot;</span> &gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--下面添加了样式--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.thumb-box</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">text-align</span>: center;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">margin-top</span>: <span class="number">50px</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.thumb</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">width</span>: <span class="number">250px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">height</span>: <span class="number">250px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">object-fit</span>: cover;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-radius</span>: <span class="number">50%</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>下面给文件上传域添加对应的属性</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">td</span>&gt;</span>头像：<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">input</span> <span class="attr">class</span>=<span class="string">&quot;mini-htmlfile&quot;</span>  <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">id</span>=<span class="string">&quot;iptFile&quot;</span> <span class="attr">accept</span>=<span class="string">&quot;image/*&quot;</span> /&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里添加了一个<code>id</code>属性，<code>accept</code>属性。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">td</span> <span class="attr">style</span>=<span class="string">&quot;width:190px;&quot;</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-primary&quot;</span> <span class="attr">id</span>=<span class="string">&quot;btnChoose&quot;</span>&gt;</span>选择 &amp; 上传图片<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;thumb-box&quot;</span>&gt;</span></span><br><span class="line">                           <span class="comment">&lt;!-- 头像 --&gt;</span></span><br><span class="line">                           <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;img-thumbnail thumb&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line">                           <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>同时在表格中又添加了两行，一个展示上传图片的按钮，另一行中展示了上传成功的头像。</p>
<p>下面实现对应的<code>js</code>代码</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> form = document.getElementById(<span class="string">&quot;form1&quot;</span>);</span><br><span class="line">   <span class="keyword">let</span> btnChoose = document.querySelector(<span class="string">&#x27;#btnChoose&#x27;</span>) <span class="comment">// -----------获取上传按钮</span></span><br><span class="line">   <span class="keyword">let</span> iptFile = document.querySelector(<span class="string">&#x27;#iptFile&#x27;</span>) <span class="comment">// -------------找到文件上传域</span></span><br><span class="line">   <span class="keyword">let</span> img = document.querySelector(<span class="string">&#x27;.thumb&#x27;</span>) <span class="comment">// -------------找到展示头像图片的img标签</span></span><br><span class="line">       <span class="comment">//-----------给上传按钮注册单击事件</span></span><br><span class="line">   btnChoose.addEventListener(<span class="string">&#x27;click&#x27;</span>, function (e) &#123;</span><br><span class="line">       e.preventDefault(); <span class="comment">//----------------注意这里一定要阻止默认行为，因为按钮在表单中会有提交的动作。</span></span><br><span class="line">       iptFile.click()</span><br><span class="line">   &#125;)</span><br><span class="line">   <span class="comment">// FormData 存文件  ==&gt; axios 发请求 (看接口文档)</span></span><br><span class="line">   iptFile.addEventListener(<span class="string">&#x27;change&#x27;</span>, function () &#123;</span><br><span class="line">       <span class="comment">// 用户选择的文件，该如何拿到？</span></span><br><span class="line">     <span class="comment">//  console.log(this.files[0])</span></span><br><span class="line"></span><br><span class="line">       <span class="comment">// 当this.files[0] 是undefined的时候，表示用户未选中文件，以下代码不用执行</span></span><br><span class="line">       <span class="keyword">if</span> (!<span class="keyword">this</span>.files[<span class="number">0</span>]) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="comment">// 阻止后续代码的执行</span></span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// FormData 构造函数 new一起使用</span></span><br><span class="line">       <span class="keyword">let</span> fd = <span class="keyword">new</span> FormData()</span><br><span class="line">       fd.append(<span class="string">&#x27;avatar&#x27;</span>, <span class="keyword">this</span>.files[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">       <span class="comment">// axios 发请求代码</span></span><br><span class="line">       axios(&#123;</span><br><span class="line">           method: <span class="string">&#x27;post&#x27;</span>,</span><br><span class="line">           <span class="comment">// 请求的url地址一定要从接口文档中去复制</span></span><br><span class="line">           url: <span class="string">&#x27;/userInfo/fileupload&#x27;</span>,</span><br><span class="line">           <span class="comment">// data的值是fd（把FormData存的数据给发送到服务器上）</span></span><br><span class="line">           data: fd</span><br><span class="line">       &#125;).then((&#123; data: res &#125;) =&gt; &#123;</span><br><span class="line">         <span class="comment">//  console.log(res)</span></span><br><span class="line"></span><br><span class="line">           <span class="comment">// 更换图片（以下写法有问题，res.url 缺少根路径）</span></span><br><span class="line">           <span class="comment">// img.src = res.url // error</span></span><br><span class="line">           <span class="keyword">let</span> photourl = document.getElementById(<span class="string">&quot;photourl&quot;</span>);</span><br><span class="line">           photourl.<span class="keyword">value</span> = res.url;  <span class="comment">// ------------------- 注意：将上传成功的头像的路径保存到隐藏域中</span></span><br><span class="line">           img.src = `http:<span class="comment">//localhost:5219/$&#123;res.url&#125;`</span></span><br><span class="line">       &#125;)</span><br><span class="line">   &#125;)</span><br></pre></td></tr></table></figure>

<p>问题：当上传成功以后，我们会将服务端返回的头像图片的路径存储到一个隐藏域中，原因就是：当单击<code>确认</code>按钮的时候，会将图片路径发送到服务端，然后和其它用户的信息一起保存到数据库中。</p>
<p>所以在<code>form</code>表单中，我们要添加一个隐藏域，如下所示：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">&quot;form1&quot;</span>&gt;</span></span><br><span class="line">    @*    <span class="tag">&lt;<span class="name">mini-hidden</span> <span class="attr">name</span>=<span class="string">&quot;id&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">mini-hidden</span>&gt;</span>*@</span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;PhotoUrl&quot;</span> <span class="attr">id</span>=<span class="string">&quot;photourl&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>同样这里还需要注意必须添加<code>name</code>属性，该属性的取值与实体类<code>UserInfo.cs</code>中的<code>PhotoUrl</code>属性保持同名，方便后面提交表单。</p>
<p>下面需要实现的就是<code>UserInfoController.cs</code>中的<code>FileUpload</code>方法，该方法的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">FileUpload</span>()</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">var</span> file = Request.Form.Files[<span class="string">&quot;avatar&quot;</span>]; <span class="comment">// 接收上传的图片文件</span></span><br><span class="line">           <span class="keyword">if</span> (file == <span class="literal">null</span>) <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123; code = <span class="number">500</span>, msg = <span class="string">&quot;请选择上传文件&quot;</span> &#125;);</span><br><span class="line">           <span class="built_in">string</span> fileName = Guid.NewGuid().ToString() + Path.GetExtension(file.FileName);</span><br><span class="line">           <span class="comment">// 构建文件存储的路径（一定要放在wwwroot目录下面）</span></span><br><span class="line">           <span class="keyword">var</span> filePath = Path.Combine(webHostEnvironment.ContentRootPath, <span class="string">&quot;wwwroot/images&quot;</span>, fileName);</span><br><span class="line"></span><br><span class="line">           <span class="keyword">using</span> (FileStream fileStream = <span class="keyword">new</span> FileStream(filePath, FileMode.Create, FileAccess.Write))</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">await</span> file.CopyToAsync(fileStream);</span><br><span class="line">               <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123; code = <span class="number">200</span>, url = <span class="string">&quot;images/&quot;</span> + fileName &#125;); <span class="comment">// 将上传成功的图片路径进行返回</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>同样这里需要注入<code>webHostEnvironment</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> private readonly <span class="title class_">IUserInfoService</span> userInfoService;</span><br><span class="line">        private readonly <span class="title class_">IMapper</span> mapper;</span><br><span class="line">        private readonly <span class="title class_">IWebHostEnvironment</span> webHostEnvironment;</span><br><span class="line"><span class="comment">//  ------------这里注入IWebHostEnvironment</span></span><br><span class="line">        public <span class="title class_">UserInfoController</span>(<span class="title class_">IUserInfoService</span> userInfoService,<span class="title class_">IMapper</span> mapper, <span class="title class_">IWebHostEnvironment</span> webHostEnvironment)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">userInfoService</span> = userInfoService;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">mapper</span> = mapper;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">webHostEnvironment</span> = webHostEnvironment;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>启动项目进行测试。</p>
<h2 id="7、完成新增用户操作"><a href="#7、完成新增用户操作" class="headerlink" title="7、完成新增用户操作"></a>7、完成新增用户操作</h2><p>在这一小节中，我们要完成用户信息的保存工作。</p>
<p>完善<code>UserInfoController.cs</code>控制器中的<code>CreateUser</code>方法中的代码</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line">       [<span class="meta">UnitOfWork(new Type[</span>] &#123; <span class="keyword">typeof</span>(MyDbContext) &#125;)]</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">CreateUser</span>(<span class="params">UserInfo userInfo</span>)</span> &#123;</span><br><span class="line">                  userInfo.CreateTime = DateTime.Now;</span><br><span class="line">           userInfo.UpdateTime = DateTime.Now;</span><br><span class="line">           userInfo.DelFlag = Convert.ToBoolean(DelFlagEnum.Normal);</span><br><span class="line">          <span class="comment">//  userInfo.PhotoUrl = userInfo.PhotoUrl;</span></span><br><span class="line">           <span class="keyword">var</span> user = <span class="keyword">await</span> userInfoService.InsertEntityAsync(userInfo);</span><br><span class="line">           <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123; code = <span class="number">200</span>, msg = <span class="string">&quot;添加成功&quot;</span>, user &#125;);</span><br><span class="line">          </span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>问题：当单击了弹出窗口的<code>确定</code>按钮以后，第一个问题就是需要关闭窗口。</p>
<p>第二个问题，我们发现，在表格中无法正常的展示图片。</p>
<p>首先解决第二个问题：</p>
<p>我们可以审查元素，发现图片的路径如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;img width=&quot;100px&quot; height=&quot;100px&quot; src=&quot;images/c6fa233f-d144-4923-9156-5a7e121e84e6.jpg&quot;&gt;</span><br></pre></td></tr></table></figure>

<p>这里很明显是相对路径，我们应该修改成绝对路径</p>
<p>修改<code>UserInfoController.cs</code>控制器中的<code>FileUpload</code>方法中的代码</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> Json(<span class="keyword">new</span> &#123; code = <span class="number">200</span>, url = <span class="string">&quot;/images/&quot;</span> + fileName &#125;); <span class="comment">// 将上传成功的图片路径进行返回</span></span><br></pre></td></tr></table></figure>

<p>这里直接返回绝对路径的形式</p>
<p>下面修改<code>ShowAdd.cshtml</code>视图中的代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">SaveData</span>(<span class="params"></span>) &#123;</span><br><span class="line">       <span class="keyword">let</span> data = <span class="title function_">serialize</span>(form);</span><br><span class="line">       <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;data = &quot;</span>,data);</span><br><span class="line">       $.<span class="title function_">ajax</span>(&#123;</span><br><span class="line">           <span class="attr">url</span>: <span class="string">&#x27;/userInfo/CreateUser&#x27;</span>,</span><br><span class="line">           <span class="attr">method</span>:<span class="string">&quot;post&quot;</span>,</span><br><span class="line">           <span class="attr">data</span>:data,</span><br><span class="line">           <span class="attr">success</span>:<span class="keyword">function</span>(<span class="params">data</span>)&#123;</span><br><span class="line">               <span class="title function_">onCancel</span>(); <span class="comment">// 当添加成功以后，直接调用onCancel方法关闭窗口，当然这里也可以做一个判断，给出用户添加成功的提示信息。</span></span><br><span class="line">           &#125;,</span><br><span class="line">           <span class="attr">error</span>:<span class="keyword">function</span>(<span class="params">error</span>)&#123;</span><br><span class="line"></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;)</span><br><span class="line">       </span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h2 id="8、编辑用户信息"><a href="#8、编辑用户信息" class="headerlink" title="8、编辑用户信息"></a>8、编辑用户信息</h2><h3 id="8-1-展示编辑的信息"><a href="#8-1-展示编辑的信息" class="headerlink" title="8.1 展示编辑的信息"></a>8.1 展示编辑的信息</h3><p>修改<code>index.cshtml</code>这个视图中的代码</p>
<p>我们知道当单击<code>编辑</code>链接的时候，会执行<code>editRow</code>这个函数，该函数对应的实现代码如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 编辑用户信息</span></span><br><span class="line">       <span class="keyword">function</span> <span class="title function_">editRow</span>(<span class="params">userId</span>) &#123;</span><br><span class="line">           mini.<span class="title function_">open</span>(&#123;</span><br><span class="line">               <span class="attr">targetWindow</span>: <span class="variable language_">window</span>,</span><br><span class="line">               <span class="attr">url</span>: <span class="string">&quot;/userInfo/showEdit?userId=&quot;</span>+userId, <span class="comment">// 传递了用户的编号</span></span><br><span class="line">               <span class="attr">title</span>: <span class="string">&quot;编辑员工&quot;</span>, <span class="attr">width</span>: <span class="number">700</span>, <span class="attr">height</span>: <span class="number">600</span>,</span><br><span class="line">               <span class="attr">onload</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">                   <span class="keyword">var</span> iframe = <span class="variable language_">this</span>.<span class="title function_">getIFrameEl</span>();                    </span><br><span class="line">                   iframe.<span class="property">contentWindow</span>;</span><br><span class="line">               &#125;,</span><br><span class="line">               <span class="attr">ondestroy</span>: <span class="keyword">function</span> (<span class="params">action</span>) &#123;</span><br><span class="line"></span><br><span class="line">                   grid.<span class="title function_">reload</span>();</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;);</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>下面在<code>UserInfoController.cs</code> 控制器中添加<code>showEdit</code>这个方法，该方法中的代码实现如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">region</span> 展示编辑用户信息窗口</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">ShowEdit</span>()</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">var</span> userId =Convert.ToInt32(Request.Query[<span class="string">&quot;userId&quot;</span>]);</span><br><span class="line">          <span class="keyword">var</span> userInfo = <span class="keyword">await</span> userInfoService.LoadEntities(u=&gt;u.Id == userId).FirstOrDefaultAsync();</span><br><span class="line">            <span class="keyword">return</span> View(userInfo);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="meta">#<span class="keyword">endregion</span></span></span><br></pre></td></tr></table></figure>

<p>接收传递过来的用户编号，然后根据用户的编号查询用户的信息，然后传递给视图中进行展示。</p>
<p><code>ShowEdit.cshtml</code>视图中代码，该视图中还是使用了添加用户时的表单，这里为什么没有使用同一个页面来完成添加与更新操作呢？</p>
<p>主要考虑的就是公用一个页面，会导致页面逻辑变得复杂，所以建议更新与添加分开到两个页面中。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line">@using Cms.Entity; <span class="comment">//---------------------------------这里导入了命名空间</span></span><br><span class="line">@model UserInfo; <span class="comment">//-----------------------这里指定了页面所关联的类型</span></span><br><span class="line">@&#123;</span><br><span class="line">    Layout = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;script src=<span class="string">&quot;/lib/jquery/dist/jquery.min.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">    &lt;link href=<span class="string">&quot;/miniui/themes/default/miniui.css&quot;</span> type=<span class="string">&quot;text/css&quot;</span> rel=<span class="string">&quot;stylesheet&quot;</span> /&gt;</span><br><span class="line">    &lt;link href=<span class="string">&quot;/miniui/themes/icons.css&quot;</span> type=<span class="string">&quot;text/css&quot;</span> rel=<span class="string">&quot;stylesheet&quot;</span> /&gt;</span><br><span class="line">    &lt;link href=<span class="string">&quot;/miniui/themes/bootstrap/skin.css&quot;</span> type=<span class="string">&quot;text/css&quot;</span> rel=<span class="string">&quot;stylesheet&quot;</span> /&gt;</span><br><span class="line">    &lt;link rel=<span class="string">&quot;stylesheet&quot;</span> href=<span class="string">&quot;/lib/bootstrap/dist/css/bootstrap.css&quot;</span>&gt;</span><br><span class="line">    &lt;script src=<span class="string">&quot;/js/miniui.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script src=<span class="string">&quot;/js/form-serialize.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script src=<span class="string">&quot;/js/axios.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">    &lt;style&gt;</span><br><span class="line">        .thumb-box &#123;</span><br><span class="line">            text-align: center;</span><br><span class="line">            margin-top: <span class="number">50</span>px;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        .thumb &#123;</span><br><span class="line">            width: <span class="number">250</span>px;</span><br><span class="line">            height: <span class="number">250</span>px;</span><br><span class="line">            <span class="built_in">object</span>-fit: cover;</span><br><span class="line">            border-radius: <span class="number">50</span>%;</span><br><span class="line">        &#125;</span><br><span class="line">    &lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line">    &lt;form id=<span class="string">&quot;form1&quot;</span>&gt;</span><br><span class="line">        @*    &lt;mini-hidden name=<span class="string">&quot;id&quot;</span>&gt;&lt;/mini-hidden&gt;*@</span><br><span class="line">     <span class="comment">//-----------------这里注意不要忘记将头像图片的地址赋值给隐藏域，因为用户有可能不会修改头像，这样就会导致该隐藏域中没有值。</span></span><br><span class="line">      &lt;input type=<span class="string">&quot;hidden&quot;</span> name=<span class="string">&quot;PhotoUrl&quot;</span> id=<span class="string">&quot;photourl&quot;</span>  <span class="keyword">value</span>=<span class="string">&quot;@Model.PhotoUrl&quot;</span>/&gt;</span><br><span class="line">        &lt;div style=<span class="string">&quot;padding-left:11px;padding-bottom:5px;&quot;</span>&gt;</span><br><span class="line">            &lt;table style=<span class="string">&quot;table-layout:fixed;&quot;</span>&gt;</span><br><span class="line">                &lt;tr&gt;</span><br><span class="line">                    &lt;td style=<span class="string">&quot;width:90px;&quot;</span>&gt;用户姓名：&lt;/td&gt;</span><br><span class="line">                    &lt;td style=<span class="string">&quot;width:150px;&quot;</span>&gt;</span><br><span class="line">                        &lt;input type=<span class="string">&quot;text&quot;</span> name=<span class="string">&quot;UserName&quot;</span> placeholder=<span class="string">&quot;请输入姓名&quot;</span> autocomplete=<span class="string">&quot;off&quot;</span> <span class="keyword">value</span>=<span class="string">&quot;@Model.UserName&quot;</span> /&gt; <span class="comment">// ------------给表单元素填充值</span></span><br><span class="line">                    &lt;/td&gt;</span><br><span class="line">                    &lt;td style=<span class="string">&quot;width:90px;&quot;</span>&gt;用户密码&lt;/td&gt;</span><br><span class="line">                    &lt;td&gt;</span><br><span class="line">                        &lt;input type=<span class="string">&quot;password&quot;</span> name=<span class="string">&quot;UserPassword&quot;</span> placeholder=<span class="string">&quot;请输入密码&quot;</span> <span class="keyword">value</span>=<span class="string">&quot;@Model.UserPassword&quot;</span> /&gt;<span class="comment">//--------------------给表单元素填充值</span></span><br><span class="line">                    &lt;/td&gt;</span><br><span class="line">                &lt;/tr&gt;</span><br><span class="line">                &lt;tr&gt;</span><br><span class="line">                    &lt;td style=<span class="string">&quot;width:90px;&quot;</span>&gt;用户邮箱：&lt;/td&gt;</span><br><span class="line">                    &lt;td&gt;</span><br><span class="line">                        &lt;input type=<span class="string">&quot;text&quot;</span> name=<span class="string">&quot;UserEmail&quot;</span> placeholder=<span class="string">&quot;请输入邮箱&quot;</span> autocomplete=<span class="string">&quot;off&quot;</span> <span class="keyword">value</span>=<span class="string">&quot;@Model.UserEmail&quot;</span> /&gt; <span class="comment">// -------------------给表单元素填充值</span></span><br><span class="line">                    &lt;/td&gt;</span><br><span class="line">                    &lt;td style=<span class="string">&quot;width:90px;&quot;</span>&gt;手机号码：&lt;/td&gt;</span><br><span class="line">                    &lt;td&gt;</span><br><span class="line">                        &lt;input type=<span class="string">&quot;text&quot;</span> name=<span class="string">&quot;UserPhone&quot;</span> placeholder=<span class="string">&quot;请输入手机号码&quot;</span> autocomplete=<span class="string">&quot;off&quot;</span> <span class="keyword">value</span>=<span class="string">&quot;@Model.UserPhone&quot;</span>&gt;&lt;/input&gt; <span class="comment">// -------------------给表单元素填充值</span></span><br><span class="line">                    &lt;/td&gt;</span><br><span class="line">                &lt;/tr&gt;</span><br><span class="line"></span><br><span class="line">                &lt;tr&gt;</span><br><span class="line">                    &lt;td style=<span class="string">&quot;width:90px;&quot;</span>&gt;性别：&lt;/td&gt;</span><br><span class="line">                    &lt;td&gt;</span><br><span class="line">        <span class="comment">// ------------------------判断性别的范围</span></span><br><span class="line">                        &lt;<span class="keyword">select</span> name=<span class="string">&quot;gender&quot;</span> <span class="keyword">class</span>=<span class="string">&quot;mini-radiobuttonlist&quot;</span>&gt;</span><br><span class="line">                            @&#123;</span><br><span class="line">                                <span class="keyword">if</span>(Model.Gender == <span class="number">0</span>)</span><br><span class="line">                                &#123;</span><br><span class="line">                                    &lt;option <span class="keyword">value</span>=<span class="string">&quot;0&quot;</span> selected&gt;男&lt;/option&gt;</span><br><span class="line">                                    &lt;option <span class="keyword">value</span>=<span class="string">&quot;1&quot;</span>&gt;女&lt;/option&gt;</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">else</span></span><br><span class="line">                                &#123;</span><br><span class="line">                                    &lt;option <span class="keyword">value</span>=<span class="string">&quot;0&quot;</span> &gt;男&lt;/option&gt;</span><br><span class="line">                                    &lt;option <span class="keyword">value</span>=<span class="string">&quot;1&quot;</span> selected&gt;女&lt;/option&gt;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                          </span><br><span class="line">                        &lt;/<span class="keyword">select</span>&gt;</span><br><span class="line">                    &lt;/td&gt;</span><br><span class="line">                    &lt;td&gt;头像：&lt;/td&gt;</span><br><span class="line">                    &lt;td&gt;</span><br><span class="line">                        &lt;input <span class="keyword">class</span>=<span class="string">&quot;mini-htmlfile&quot;</span> type=<span class="string">&quot;file&quot;</span> id=<span class="string">&quot;iptFile&quot;</span> accept=<span class="string">&quot;image/*&quot;</span> /&gt;</span><br><span class="line">                    &lt;/td&gt;</span><br><span class="line"></span><br><span class="line">                &lt;/tr&gt;</span><br><span class="line">                &lt;tr&gt;</span><br><span class="line">                    &lt;td style=<span class="string">&quot;width:190px;&quot;</span>&gt;</span><br><span class="line">                        &lt;button <span class="keyword">class</span>=<span class="string">&quot;btn btn-primary&quot;</span> id=<span class="string">&quot;btnChoose&quot;</span>&gt;选择 &amp; 上传图片&lt;/button&gt;</span><br><span class="line">                    &lt;/td&gt;</span><br><span class="line">                    &lt;td&gt;</span><br><span class="line">                            <span class="comment">// -----------------给表单元素填充值，这里是将用户的头像地址赋值给了img标签的src属性</span></span><br><span class="line">                        &lt;div <span class="keyword">class</span>=<span class="string">&quot;thumb-box&quot;</span>&gt;</span><br><span class="line">                            &lt;!-- 头像 --&gt;</span><br><span class="line">                            &lt;img src=<span class="string">&quot;@Model.PhotoUrl&quot;</span> <span class="keyword">class</span>=<span class="string">&quot;img-thumbnail thumb&quot;</span> alt=<span class="string">&quot;&quot;</span>&gt;</span><br><span class="line">                        &lt;/div&gt;</span><br><span class="line">                    &lt;/td&gt;</span><br><span class="line">                &lt;/tr&gt;</span><br><span class="line">            &lt;/table&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div style=<span class="string">&quot;text-align:center;padding:10px;&quot;</span>&gt;</span><br><span class="line">            &lt;mini-button onclick=<span class="string">&quot;onOk&quot;</span> style=<span class="string">&quot;width:60px;margin-right:20px;&quot;</span>&gt;确定&lt;/mini-button&gt;</span><br><span class="line">            &lt;mini-button onclick=<span class="string">&quot;onCancel&quot;</span> style=<span class="string">&quot;width:60px;&quot;</span>&gt;取消&lt;/mini-button&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    <span class="keyword">var</span> form = document.getElementById(<span class="string">&quot;form1&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> btnChoose = document.querySelector(<span class="string">&#x27;#btnChoose&#x27;</span>)</span><br><span class="line">    <span class="keyword">let</span> iptFile = document.querySelector(<span class="string">&#x27;#iptFile&#x27;</span>)</span><br><span class="line">    <span class="keyword">let</span> img = document.querySelector(<span class="string">&#x27;.thumb&#x27;</span>)</span><br><span class="line">    btnChoose.addEventListener(<span class="string">&#x27;click&#x27;</span>, function (e) &#123;</span><br><span class="line">        e.preventDefault();</span><br><span class="line">        iptFile.click()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// FormData 存文件  ==&gt; axios 发请求 (看接口文档)</span></span><br><span class="line">    iptFile.addEventListener(<span class="string">&#x27;change&#x27;</span>, function () &#123;</span><br><span class="line">        <span class="comment">// 用户选择的文件，该如何拿到？</span></span><br><span class="line">        <span class="comment">//  console.log(this.files[0])</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 当this.files[0] 是undefined的时候，表示用户未选中文件，以下代码不用执行</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.files[<span class="number">0</span>]) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="comment">// 阻止后续代码的执行</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// FormData 构造函数 new一起使用</span></span><br><span class="line">        <span class="keyword">let</span> fd = <span class="keyword">new</span> FormData()</span><br><span class="line">        fd.append(<span class="string">&#x27;avatar&#x27;</span>, <span class="keyword">this</span>.files[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">        <span class="comment">// axios 发请求代码</span></span><br><span class="line">        axios(&#123;</span><br><span class="line">            method: <span class="string">&#x27;post&#x27;</span>,</span><br><span class="line">            <span class="comment">// 请求的url地址一定要从接口文档中去复制</span></span><br><span class="line">            url: <span class="string">&#x27;/userInfo/fileupload&#x27;</span>,</span><br><span class="line">            <span class="comment">// data的值是fd（把FormData存的数据给发送到服务器上）</span></span><br><span class="line">            data: fd</span><br><span class="line">        &#125;).then((&#123; data: res &#125;) =&gt; &#123;</span><br><span class="line">            <span class="comment">//  console.log(res)</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 更换图片（以下写法有问题，res.url 缺少根路径）</span></span><br><span class="line">            <span class="comment">// img.src = res.url // error</span></span><br><span class="line">            <span class="keyword">let</span> photourl = document.getElementById(<span class="string">&quot;photourl&quot;</span>);</span><br><span class="line">            photourl.<span class="keyword">value</span> = res.url;</span><br><span class="line">            img.src = `http:<span class="comment">//localhost:5219/$&#123;res.url&#125;`</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关闭窗口</span></span><br><span class="line">    <span class="function">function <span class="title">onCancel</span>()</span> &#123;</span><br><span class="line">        window.CloseOwnerWindow();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 保存表单中的数据</span></span><br><span class="line">    <span class="function">function <span class="title">onOk</span>()</span> &#123;</span><br><span class="line">        SaveData();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">function <span class="title">SaveData</span>()</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> data = serialize(form);</span><br><span class="line">        $.ajax(&#123;</span><br><span class="line">            url: <span class="string">&#x27;/userInfo/EditUser&#x27;</span>, <span class="comment">//-----------------------------这里修改了地址</span></span><br><span class="line">            method: <span class="string">&quot;post&quot;</span>,</span><br><span class="line">            data: data,</span><br><span class="line">            success: function (data) &#123;</span><br><span class="line">                onCancel();</span><br><span class="line">            &#125;,</span><br><span class="line">            error: function (error) &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="8-2-完成用户信息编辑"><a href="#8-2-完成用户信息编辑" class="headerlink" title="8.2  完成用户信息编辑"></a>8.2  完成用户信息编辑</h3><p>下面在<code>UserInfoController.cs</code>控制器中创建<code>EditUser</code>这个方法，该方法实现的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">UnitOfWork(new Type[</span>] &#123; <span class="keyword">typeof</span>(MyDbContext) &#125;)] <span class="comment">// 注意添加UnitofWork这个Attribute</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">EditUser</span>(<span class="params">UserInfo userInfo</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           userInfo.DelFlag = Convert.ToBoolean(DelFlagEnum.Normal); <span class="comment">// 删除标记</span></span><br><span class="line">           userInfo.UpdateTime = DateTime.Now; <span class="comment">// 更新时间。</span></span><br><span class="line">          <span class="keyword">await</span> userInfoService.UpdateEntityAsync(userInfo);</span><br><span class="line">           <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123; code = <span class="number">200</span>, msg = <span class="string">&quot;更新成功&quot;</span> &#125;);</span><br><span class="line"></span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>但是，这里还有一个问题，更新的时候我们需要用户的<code>Id</code>编号。</p>
<p>当展示<code>ShowEdit.cshtml</code>这个视图的时候，已经传递了用户的编号，所以这里也需要将其保存到隐藏域中，同理，添加时间也是一样。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;form id=<span class="string">&quot;form1&quot;</span>&gt;</span><br><span class="line">       @*    &lt;mini-hidden name=<span class="string">&quot;id&quot;</span>&gt;&lt;/mini-hidden&gt;*@</span><br><span class="line">       &lt;input type=<span class="string">&quot;hidden&quot;</span> name=<span class="string">&quot;PhotoUrl&quot;</span> id=<span class="string">&quot;photourl&quot;</span>  <span class="keyword">value</span>=<span class="string">&quot;@Model.PhotoUrl&quot;</span>/&gt;</span><br><span class="line">    <span class="comment">// 隐藏域中保存了用户编号</span></span><br><span class="line">       &lt;input type=<span class="string">&quot;hidden&quot;</span> name=<span class="string">&quot;Id&quot;</span> <span class="keyword">value</span>=<span class="string">&quot;@Model.Id&quot;</span>/&gt;</span><br><span class="line">     <span class="comment">// 隐藏域中保存了添加时间</span></span><br><span class="line">       &lt;input type=<span class="string">&quot;hidden&quot;</span> name=<span class="string">&quot;CreateTime&quot;</span> <span class="keyword">value</span>=<span class="string">&quot;@Model.CreateTime&quot;</span> /&gt;</span><br></pre></td></tr></table></figure>

<p>启动项目进行测试。</p>
<h2 id="9、首页布局"><a href="#9、首页布局" class="headerlink" title="9、首页布局"></a>9、首页布局</h2><p>参考官方文档：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.miniui.com/docs/tutorial/layout.html</span><br></pre></td></tr></table></figure>

<p>这里需要修改<code>HomeController.cs</code>控制器中的代码，这里只保留<code>Index</code>这个方法。</p>
<p>同时把<code>Views</code>目录下的<code>Home</code>目录删除掉，这里重新针对<code>Index</code>方法，创建相应的视图页面。</p>
<p>对应的<code>Index.cshtml</code>视图中的代码如下所示：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">@&#123;</span><br><span class="line">    Layout = null;</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/lib/jquery/dist/jquery.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">&quot;/miniui/themes/default/miniui.css&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">&quot;/miniui/themes/icons.css&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">&quot;/miniui/themes/bootstrap/skin.css&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/js/miniui.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.txt</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">font-family</span>: <span class="string">&quot;微软雅黑&quot;</span>, <span class="string">&quot;Helvetica Neue&quot;</span>,​Helvetica,​Arial,​sans-serif;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">font-size</span>: <span class="number">28px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">font-weight</span>: bold;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">cursor</span>: default;</span></span><br><span class="line"><span class="language-css">             <span class="attribute">margin-top</span>:<span class="number">20px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">color</span>: <span class="number">#444</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.topNav</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">position</span>: absolute;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">right</span>: <span class="number">8px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">top</span>: <span class="number">12px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">font-size</span>: <span class="number">12px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">line-height</span>: <span class="number">25px</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.topNav</span> <span class="selector-tag">a</span> &#123;</span></span><br><span class="line"><span class="language-css">                <span class="attribute">text-decoration</span>: none;</span></span><br><span class="line"><span class="language-css">                <span class="attribute">font-weight</span>: normal;</span></span><br><span class="line"><span class="language-css">                <span class="attribute">font-size</span>: <span class="number">12px</span>;</span></span><br><span class="line"><span class="language-css">                <span class="attribute">line-height</span>: <span class="number">25px</span>;</span></span><br><span class="line"><span class="language-css">                <span class="attribute">margin-left</span>: <span class="number">3px</span>;</span></span><br><span class="line"><span class="language-css">                <span class="attribute">margin-right</span>: <span class="number">3px</span>;</span></span><br><span class="line"><span class="language-css">                <span class="attribute">color</span>: <span class="number">#333</span>;</span></span><br><span class="line"><span class="language-css">            &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">       <span class="selector-class">.topNav</span> <span class="selector-tag">a</span><span class="selector-pseudo">:hover</span> &#123;</span></span><br><span class="line"><span class="language-css">                    <span class="attribute">text-decoration</span>: underline;</span></span><br><span class="line"><span class="language-css">             &#125;</span></span><br><span class="line"><span class="language-css">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!---撑满页面-------------&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;mini-fit&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!------------------mini-fit内部的子元素宽高要100%---------------&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;layout1&quot;</span> <span class="attr">class</span>=<span class="string">&quot;mini-layout &quot;</span> <span class="attr">style</span>=<span class="string">&quot;width:100%;height:100%;&quot;</span> <span class="attr">borderStyle</span>=<span class="string">&quot;border:solid 1px #aaa;&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">region</span>=<span class="string">&quot;north&quot;</span> <span class="attr">height</span>=<span class="string">&quot;80&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;txt&quot;</span>&gt;</span>CMS文章管理系统<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;topNav&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span>&gt;</span>Admin<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span>&gt;</span>退出<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span>  <span class="attr">region</span>=<span class="string">&quot;south&quot;</span> <span class="attr">showSplit</span>=<span class="string">&quot;false&quot;</span> <span class="attr">showHeader</span>=<span class="string">&quot;true&quot;</span> <span class="attr">height</span>=<span class="string">&quot;80&quot;</span>&gt;</span></span><br><span class="line">                south</span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span>  <span class="attr">region</span>=<span class="string">&quot;west&quot;</span> <span class="attr">width</span>=<span class="string">&quot;200&quot;</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!--------这里使用了tree控件-----------&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">&quot;tree1&quot;</span> <span class="attr">class</span>=<span class="string">&quot;mini-tree&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width:100px;padding:5px;height:100px&quot;</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">showTreeIcon</span>=<span class="string">&quot;true&quot;</span> <span class="attr">textField</span>=<span class="string">&quot;text&quot;</span> <span class="attr">idField</span>=<span class="string">&quot;id&quot;</span> <span class="attr">value</span>=<span class="string">&quot;base&quot;</span> <span class="attr">expandOnNodeClick</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">                      <span class="comment">&lt;!------------树中的每一个菜单项，添加了class属性与url属性，同时注册了onclick事件---------------&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;javascript:void(0)&quot;</span> <span class="attr">url</span>=<span class="string">&quot;/userInfo/index&quot;</span> <span class="attr">class</span>=<span class="string">&quot;detailLink&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;getUrl(this)&quot;</span>&gt;</span>用户管理<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;javascript:void(0)&quot;</span> <span class="attr">url</span>=<span class="string">&quot;/articelInfo/index&quot;</span> <span class="attr">class</span>=<span class="string">&quot;detailLink&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;getUrl(this)&quot;</span>&gt;</span>文章管理<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">         <span class="comment">&lt;!--------------------在中间件区域--通过iframe来指定要展示的页面内容----------------------------------&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">region</span>=<span class="string">&quot;center&quot;</span> &gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">&quot;/userInfo&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width:100%;height:100%&quot;</span> <span class="attr">frameborder</span>=<span class="string">&quot;0&quot;</span> <span class="attr">id</span>=<span class="string">&quot;frame&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 当单击了不同的菜单项以后，对应的iframe中展示不同的内容</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">getUrl</span>(<span class="params">e</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">var</span> url = e.<span class="title function_">getAttribute</span>(<span class="string">&quot;url&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">var</span> frame = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;frame&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">      frame.<span class="property">src</span> = url;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">   </span></span><br><span class="line"><span class="language-javascript">  </span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>启动项目进行测试。</p>
<h1 id="三、文章管理"><a href="#三、文章管理" class="headerlink" title="三、文章管理"></a>三、文章管理</h1><h2 id="1、模型设计"><a href="#1、模型设计" class="headerlink" title="1、模型设计"></a>1、模型设计</h2><p>在<code>Cms.Entity</code>这个类库项目中创建<code>ArticelInfo.cs</code>类，该类中的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ArticelInfo</span>:<span class="title">BaseEntity</span>&lt;<span class="title">long</span>&gt;</span><br><span class="line">   &#123;</span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 关 键 字</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">string</span>? KeyWords &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 标题类型，例如：公告，图文，推荐等类型</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">string</span>? TitleType &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 文章简短标题</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">string</span>? Title &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span>  完整标题</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">string</span>? FullTitle &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 文章导读</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">string</span>? Intro &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 文章标题颜色</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">string</span>? TitleFontColor &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 文章标题字体类型</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">string</span>? TitleFontType &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 文章内容</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">string</span>? ArticleContent &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 文章的作者</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">string</span>? Author &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 文章来源</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">string</span>? Origin &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">      </span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 图片的地址</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">string</span>? PhotoUrl &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 文章属于哪个类别</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="keyword">public</span> ArticelClass? ArticelClass &#123; <span class="keyword">get</span>; <span class="keyword">set</span>;&#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>同时创建一个实体类<code>ArticelClass.cs</code>,代码如下所示</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ArticelClass</span>:<span class="title">BaseEntity</span>&lt;<span class="title">int</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span>? ArticleClassName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> ParentId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span>? Remark &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 类别下面很多文章</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> List&lt;ArticelInfo&gt; ArticelInfos &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; = <span class="keyword">new</span> List&lt;ArticelInfo&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定义配置类<code>ArticelInfoConfig.cs</code></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ArticelInfoConfig</span> : <span class="title">IEntityTypeConfiguration</span>&lt;<span class="title">ArticelInfo</span>&gt;</span><br><span class="line">   &#123;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">EntityTypeBuilder&lt;ArticelInfo&gt; builder</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           builder.ToTable(<span class="string">&quot;T_ArticelInfos&quot;</span>);</span><br><span class="line">           builder.Property(x =&gt; x.KeyWords).HasMaxLength(<span class="number">500</span>).IsRequired();</span><br><span class="line">           builder.Property(x =&gt; x.TitleType).HasMaxLength(<span class="number">200</span>).IsRequired();</span><br><span class="line">           builder.Property(x =&gt; x.Title).HasMaxLength(<span class="number">100</span>).IsRequired();</span><br><span class="line">           builder.Property(x =&gt; x.FullTitle).HasMaxLength(<span class="number">200</span>).IsRequired();</span><br><span class="line">           builder.Property(x =&gt; x.Intro).HasMaxLength(<span class="number">500</span>).IsRequired();</span><br><span class="line">           builder.Property(x =&gt; x.TitleFontColor).HasMaxLength(<span class="number">50</span>).IsRequired();</span><br><span class="line">           builder.Property(x =&gt; x.TitleFontType).HasMaxLength(<span class="number">50</span>).IsRequired();</span><br><span class="line">           builder.Property(x =&gt; x.ArticleContent).IsRequired();</span><br><span class="line">           builder.Property(x =&gt; x.Author).HasMaxLength(<span class="number">20</span>).IsRequired();</span><br><span class="line">           builder.Property(x =&gt; x.Origin).HasMaxLength(<span class="number">100</span>).IsRequired();</span><br><span class="line">           builder.Property(x =&gt; x.PhotoUrl).HasMaxLength(<span class="number">500</span>).IsRequired();</span><br><span class="line">          <span class="comment">// 一个类别下面多篇文章</span></span><br><span class="line">           builder.HasOne&lt;ArticelClass&gt;(c =&gt; c.ArticelClass).WithMany(a =&gt; a.ArticelInfos).IsRequired();</span><br><span class="line"></span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>定义配置类<code>ArticelClassConfig.cs</code></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ArticelClassConfig</span> : <span class="title">IEntityTypeConfiguration</span>&lt;<span class="title">ArticelClass</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">EntityTypeBuilder&lt;ArticelClass&gt; builder</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            builder.ToTable(<span class="string">&quot;T_ArticelClasses&quot;</span>);</span><br><span class="line">            builder.Property(x =&gt; x.ArticleClassName).HasMaxLength(<span class="number">50</span>).IsRequired();</span><br><span class="line">            builder.Property(x =&gt; x.Remark).HasMaxLength(<span class="number">200</span>).IsRequired();</span><br><span class="line">           </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意：一定不要忘记创建<code>DbSet</code>对象</strong></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyDbContext</span>:<span class="title">DbContext</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">public</span> DbSet&lt;UserInfo&gt;UserInfos &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="keyword">public</span> DbSet&lt;ArticelClass&gt;ArticelClasses &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="keyword">public</span> DbSet&lt;ArticelInfo&gt;ArticelInfos &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br></pre></td></tr></table></figure>

<p>下面进行数据库的迁移操作</p>
<p>在【程序包管理器控制台】中选择的项目是<code>Cms.EntityFrameworkCore</code></p>
<p>然后执行数据库的迁移命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Add-Migration createArticelAndArticelClass</span><br><span class="line"> Update-database</span><br></pre></td></tr></table></figure>

<p>查看数据库。</p>
<h2 id="2、文章展示布局"><a href="#2、文章展示布局" class="headerlink" title="2、文章展示布局"></a>2、文章展示布局</h2><p>文章信息的展示，与用户信息的展示一样，也是通过表格进行展示。</p>
<p>创建控制器<code>ArticelInfoController</code></p>
<p>针对该控制器中的<code>index</code>方法创建视图</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">@&#123;</span><br><span class="line">    Layout = null;</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/lib/jquery/dist/jquery.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">&quot;/miniui/themes/default/miniui.css&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">&quot;/miniui/themes/icons.css&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">&quot;/miniui/themes/bootstrap/skin.css&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/js/miniui.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>文章信息管理<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;padding-bottom:5px;&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span>&gt;</span>文章标题：<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">id</span>=<span class="string">&quot;title&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span>&gt;</span>文章作者：<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">id</span>=<span class="string">&quot;author&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">value</span>=<span class="string">&quot;查找&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;search()&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;width:800px;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;mini-toolbar&quot;</span> <span class="attr">style</span>=<span class="string">&quot;border-bottom:0;padding:0px;&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">table</span> <span class="attr">style</span>=<span class="string">&quot;width:100%;&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">td</span> <span class="attr">style</span>=<span class="string">&quot;width:100%;&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;mini-button&quot;</span> <span class="attr">iconCls</span>=<span class="string">&quot;icon-add&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;add()&quot;</span>&gt;</span>增加<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;mini-button&quot;</span> <span class="attr">iconCls</span>=<span class="string">&quot;icon-remove&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;remove()&quot;</span>&gt;</span>删除<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;datagrid1&quot;</span> <span class="attr">class</span>=<span class="string">&quot;mini-datagrid&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width:60%;height:550px;&quot;</span> <span class="attr">ajaxType</span>=<span class="string">&quot;get&quot;</span> <span class="attr">url</span>=<span class="string">&quot;/articelInfo/getArticels&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">idField</span>=<span class="string">&quot;id&quot;</span> <span class="attr">allowResize</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">sizeList</span>=<span class="string">&quot;[2,5,10,30]&quot;</span> <span class="attr">pageSize</span>=<span class="string">&quot;2&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">showHeader</span>=<span class="string">&quot;true&quot;</span> <span class="attr">title</span>=<span class="string">&quot;文章信息&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">multiSelect</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">allowCellEdit</span>=<span class="string">&quot;true&quot;</span> <span class="attr">allowCellSelect</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">onmouseup</span>=<span class="string">&quot;return datagrid1_onmouseup()&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">property</span>=<span class="string">&quot;columns&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">type</span>=<span class="string">&quot;indexcolumn&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">type</span>=<span class="string">&quot;checkcolumn&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">field</span>=<span class="string">&quot;id&quot;</span> <span class="attr">width</span>=<span class="string">&quot;120&quot;</span> <span class="attr">headerAlign</span>=<span class="string">&quot;center&quot;</span>&gt;</span>编号<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">field</span>=<span class="string">&quot;Title&quot;</span> <span class="attr">width</span>=<span class="string">&quot;120&quot;</span> <span class="attr">headerAlign</span>=<span class="string">&quot;center&quot;</span>&gt;</span>文章标题<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">field</span>=<span class="string">&quot;ClassName&quot;</span> <span class="attr">align</span>=<span class="string">&quot;right&quot;</span> <span class="attr">width</span>=<span class="string">&quot;100&quot;</span>&gt;</span>文章类别<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">field</span>=<span class="string">&quot;Author&quot;</span> <span class="attr">width</span>=<span class="string">&quot;100&quot;</span> <span class="attr">allowSort</span>=<span class="string">&quot;true&quot;</span>&gt;</span>文章作者<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">field</span>=<span class="string">&quot;Origin&quot;</span> <span class="attr">width</span>=<span class="string">&quot;100&quot;</span> <span class="attr">headerAlign</span>=<span class="string">&quot;center&quot;</span>&gt;</span>文章来源<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">field</span>=<span class="string">&quot;CreateTime&quot;</span> <span class="attr">width</span>=<span class="string">&quot;100&quot;</span> <span class="attr">headerAlign</span>=<span class="string">&quot;center&quot;</span>&gt;</span>发布时间<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">name</span>=<span class="string">&quot;action&quot;</span> <span class="attr">width</span>=<span class="string">&quot;120&quot;</span> <span class="attr">headerAlign</span>=<span class="string">&quot;center&quot;</span> <span class="attr">align</span>=<span class="string">&quot;center&quot;</span> <span class="attr">cellStyle</span>=<span class="string">&quot;padding:0;&quot;</span>&gt;</span>操作<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="3、添加文章视图"><a href="#3、添加文章视图" class="headerlink" title="3、添加文章视图"></a>3、添加文章视图</h2><p>首先修改修改上面<code>index.cshtml</code>视图中的代码</p>
<p>当点击添加按钮的时候，会弹出一个窗口，在该窗口中呈现添加文章的表单。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">function</span> <span class="title function_">add</span>(<span class="params"></span>) &#123;</span><br><span class="line">           mini.<span class="title function_">open</span>(&#123;</span><br><span class="line">               <span class="attr">targetWindow</span>: <span class="variable language_">window</span>,</span><br><span class="line">               <span class="attr">url</span>: <span class="string">&quot;/articelInfo/showAdd&quot;</span>,</span><br><span class="line">               <span class="attr">title</span>: <span class="string">&quot;添加文章&quot;</span>, <span class="attr">width</span>: <span class="number">800</span>, <span class="attr">height</span>: <span class="number">800</span>,</span><br><span class="line">               <span class="attr">onload</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">                   <span class="keyword">var</span> iframe = <span class="variable language_">this</span>.<span class="title function_">getIFrameEl</span>();</span><br><span class="line">                   iframe.<span class="property">contentWindow</span>;<span class="comment">// 文档中这里调用了SetData方法，指的是在打开的页面中会有setData函数，而我们这里showAdd方法对应的视图中没有定义SetData函数，</span></span><br><span class="line">                   <span class="comment">//所以这里不用调用</span></span><br><span class="line">               &#125;,</span><br><span class="line">               <span class="attr">ondestroy</span>: <span class="keyword">function</span> (<span class="params">action</span>) &#123;</span><br><span class="line"></span><br><span class="line">                   grid.<span class="title function_">reload</span>();</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;);</span><br><span class="line">       &#125;</span><br><span class="line">   &lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>下面在<code>ArticelInfo</code>控制器中创建<code>ShowAdd</code>方法</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">ShowAdd</span>()</span></span><br><span class="line">     &#123;</span><br><span class="line">         <span class="keyword">return</span> View();</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>

<p>该方法呈现的视图为<code>ShowAdd.cshtml</code>,该视图中的代码如下所示：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line">@&#123;</span><br><span class="line">    Layout = null;</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">&quot;/css/tableStyle.css&quot;</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span>/&gt;</span><span class="comment">&lt;!--添加表格样式--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/ckeditor/ckeditor.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="comment">&lt;!--添加ckeditor编辑器---&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/lib/jquery/dist/jquery.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">textarea</span>, select &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>: <span class="number">2px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border</span>: <span class="number">1px</span> solid;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-color</span>: <span class="number">#666</span> <span class="number">#ccc</span> <span class="number">#ccc</span> <span class="number">#666</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background</span>: <span class="number">#F9F9F9</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">color</span>: <span class="number">#333</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">resize</span>: none;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">width</span>: <span class="number">100%</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.textbox</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>: <span class="number">3px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border</span>: <span class="number">1px</span> solid;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-color</span>: <span class="number">#666</span> <span class="number">#ccc</span> <span class="number">#ccc</span> <span class="number">#666</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background</span>: <span class="number">#F9F9F9</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">color</span>: <span class="number">#333</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">resize</span>: none;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">width</span>: <span class="number">100%</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">            <span class="selector-class">.textbox</span><span class="selector-pseudo">:hover</span>, <span class="selector-class">.textbox</span><span class="selector-pseudo">:focus</span>, <span class="selector-tag">textarea</span><span class="selector-pseudo">:hover</span>, <span class="selector-tag">textarea</span><span class="selector-pseudo">:focus</span> &#123;</span></span><br><span class="line"><span class="language-css">                <span class="attribute">border-color</span>: <span class="number">#09C</span>;</span></span><br><span class="line"><span class="language-css">                <span class="attribute">background</span>: <span class="number">#F5F9FD</span>;</span></span><br><span class="line"><span class="language-css">            &#125;</span></span><br><span class="line"><span class="language-css">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">style</span>=<span class="string">&quot;width:auto; margin: 0 auto&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>简短标题:<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">select</span> <span class="attr">name</span>=<span class="string">&quot;TitleType&quot;</span> <span class="attr">id</span>=<span class="string">&quot;TitleType&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">option</span>&gt;</span><span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">option</span> <span class="attr">style</span>=<span class="string">&quot;color: green&quot;</span>&gt;</span>[图文]<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">option</span> <span class="attr">style</span>=<span class="string">&quot;color: red&quot;</span>&gt;</span>[组图]<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">option</span> <span class="attr">style</span>=<span class="string">&quot;color: #990000&quot;</span>&gt;</span>[推荐]<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">option</span> <span class="attr">style</span>=<span class="string">&quot;color: #0000FF&quot;</span>&gt;</span>[注意]<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">option</span> <span class="attr">style</span>=<span class="string">&quot;color: blue&quot;</span>&gt;</span>[公告]<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;title&quot;</span> <span class="attr">maxlength</span>=<span class="string">&quot;160&quot;</span> <span class="attr">class</span>=<span class="string">&quot;textbox&quot;</span> <span class="attr">id</span>=<span class="string">&quot;title&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">select</span> <span class="attr">name</span>=<span class="string">&quot;TitleFontType&quot;</span> <span class="attr">id</span>=<span class="string">&quot;TitleFontType&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;0&quot;</span>&gt;</span>字形<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span>&gt;</span>粗体<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;2&quot;</span>&gt;</span>斜体<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;3&quot;</span>&gt;</span>粗+斜<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;0&quot;</span>&gt;</span>规则<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">select</span> <span class="attr">name</span>=<span class="string">&quot;TitleFontColor&quot;</span> <span class="attr">id</span>=<span class="string">&quot;TitleFontColor&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;0&quot;</span>&gt;</span>颜色<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span>&gt;</span>红色<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;2&quot;</span>&gt;</span>蓝色<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;3&quot;</span>&gt;</span>绿色<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>完整标题:<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span> <span class="attr">colspan</span>=<span class="string">&quot;4&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;Fulltitle&quot;</span> <span class="attr">class</span>=<span class="string">&quot;textbox&quot;</span> <span class="attr">id</span>=<span class="string">&quot;Fulltitle&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>归属栏目:<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span> <span class="attr">colspan</span>=<span class="string">&quot;4&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">select</span> <span class="attr">name</span>=<span class="string">&quot;ArticelClassInfo&quot;</span> <span class="attr">id</span>=<span class="string">&quot;ArticelClassInfo&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span>&gt;</span>--请选择归属栏目--<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">                    </span><br><span class="line">                <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>关 键 字<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span> <span class="attr">colspan</span>=<span class="string">&quot;4&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;KeyWords&quot;</span> <span class="attr">class</span>=<span class="string">&quot;textbox&quot;</span> <span class="attr">id</span>=<span class="string">&quot;KeyWords&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>文章作者:<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span> <span class="attr">colspan</span>=<span class="string">&quot;4&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;Author&quot;</span> <span class="attr">class</span>=<span class="string">&quot;textbox&quot;</span> <span class="attr">id</span>=<span class="string">&quot;Author&quot;</span> /&gt;</span><span class="symbol">&amp;nbsp;</span><span class="symbol">&amp;nbsp;</span>【<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;javascript:void(0)&quot;</span> <span class="attr">class</span>=<span class="string">&quot;authorClick&quot;</span>&gt;</span>未知<span class="tag">&lt;/<span class="name">a</span>&gt;</span>】【<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;javascript:void(0)&quot;</span> <span class="attr">class</span>=<span class="string">&quot;authorClick&quot;</span>&gt;</span>佚名<span class="tag">&lt;/<span class="name">a</span>&gt;</span>】【<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;javascript:void(0)&quot;</span> <span class="attr">class</span>=<span class="string">&quot;authorClick&quot;</span>&gt;</span>老王<span class="tag">&lt;/<span class="name">a</span>&gt;</span>】</span><br><span class="line">            <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>文章来源:<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span> <span class="attr">colspan</span>=<span class="string">&quot;4&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;Origin&quot;</span> <span class="attr">id</span>=<span class="string">&quot;Origin&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span> <span class="attr">size</span>=<span class="string">&quot;50&quot;</span> <span class="attr">class</span>=<span class="string">&quot;textbox&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span>&gt;</span><span class="symbol">&amp;nbsp;</span><span class="symbol">&amp;nbsp;</span>【<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;javascript:void(0)&quot;</span> <span class="attr">class</span>=<span class="string">&quot;originInfo&quot;</span>&gt;</span>不详<span class="tag">&lt;/<span class="name">a</span>&gt;</span>】【<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;javascript:void(0)&quot;</span> <span class="attr">class</span>=<span class="string">&quot;originInfo&quot;</span>&gt;</span>本站原创<span class="tag">&lt;/<span class="name">a</span>&gt;</span>】【<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;javascript:void(0)&quot;</span> <span class="attr">class</span>=<span class="string">&quot;originInfo&quot;</span>&gt;</span>互联网<span class="tag">&lt;/<span class="name">a</span>&gt;</span>】</span><br><span class="line">            <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>文章导读<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span> <span class="attr">colspan</span>=<span class="string">&quot;4&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">class</span>=<span class="string">&quot;textbox&quot;</span> <span class="attr">name</span>=<span class="string">&quot;Intro&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width: 95%; height: 80px&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>文章内容<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span> <span class="attr">colspan</span>=<span class="string">&quot;4&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">class</span>=<span class="string">&quot;textbox&quot;</span> <span class="attr">onblur</span>=<span class="string">&quot;getData2()&quot;</span> <span class="attr">id</span>=<span class="string">&quot;ArticleContent&quot;</span> <span class="attr">name</span>=<span class="string">&quot;ArticleContent1&quot;</span> <span class="attr">rows</span>=<span class="string">&quot;30&quot;</span> <span class="attr">cols</span>=<span class="string">&quot;40&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width: 95%; height: 80px&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-handlebars"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">                    //&lt;![CDATA[</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">                    // Replace the &lt;textarea id=&quot;editor1&quot;&gt; with an CKEditor instance.</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">                    // 这里是给id属性值为ArticleContent的textare添加富文本编辑器</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">                    var editor = CKEDITOR.replace(&#x27;ArticleContent&#x27;);</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">                                              //]]&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">                </span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">                </span><br><span class="line">                <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">class</span>=<span class="string">&quot;textbox&quot;</span> <span class="attr">name</span>=<span class="string">&quot;ArticleContent&quot;</span> <span class="attr">id</span>=<span class="string">&quot;txtArticleContent&quot;</span> <span class="attr">rows</span>=<span class="string">&quot;30&quot;</span> <span class="attr">cols</span>=<span class="string">&quot;40&quot;</span> <span class="attr">style</span>=<span class="string">&quot;display:none&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>图片地址:<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span> <span class="attr">colspan</span>=<span class="string">&quot;4&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;content&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">img</span> <span class="attr">id</span>=<span class="string">&quot;imgSrc&quot;</span> <span class="attr">width</span>=<span class="string">&quot;50px&quot;</span> <span class="attr">height</span>=<span class="string">&quot;50px&quot;</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;PhotoUrl&quot;</span> <span class="attr">id</span>=<span class="string">&quot;PhotoUrl&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;AddWaterFlag&quot;</span> <span class="attr">id</span>=<span class="string">&quot;AddWaterFlag&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span>&gt;</span>添加水印</span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;InsertEditContent&quot;</span> <span class="attr">id</span>=<span class="string">&quot;InsertEditContent&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span>&gt;</span>图片是否插入编辑器</span><br><span class="line">            <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>看一下基本的效果</p>
<p>同时，这里我们可以完成<code>添加作者，添加原创，给富文本编辑器绑定一个事件</code>的操作</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">          <span class="comment">//添加作者</span></span><br><span class="line">          $(<span class="string">&quot;.authorClick&quot;</span>).<span class="title function_">click</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">              $(<span class="string">&quot;#Author&quot;</span>).<span class="title function_">val</span>($(<span class="variable language_">this</span>).<span class="title function_">text</span>());</span><br><span class="line">          &#125;);</span><br><span class="line">          <span class="comment">//添加原创</span></span><br><span class="line">          $(<span class="string">&quot;.originInfo&quot;</span>).<span class="title function_">click</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">              $(<span class="string">&quot;#Origin&quot;</span>).<span class="title function_">val</span>($(<span class="variable language_">this</span>).<span class="title function_">text</span>());</span><br><span class="line">          &#125;);</span><br><span class="line">          <span class="comment">//给富文本编辑器绑定一个事件。</span></span><br><span class="line">          <span class="variable constant_">CKEDITOR</span>.<span class="property">instances</span>[<span class="string">&quot;ArticleContent&quot;</span>].<span class="title function_">on</span>(<span class="string">&quot;blur&quot;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">              <span class="comment">//获取编辑器内容。把用户在富文本编辑中添加的文章内容获取到以后，赋值给了id属性值为txtArticleContent的隐藏的文本域，最后提交的是该隐藏的文本域。</span></span><br><span class="line">              <span class="keyword">var</span> oEditor = <span class="variable constant_">CKEDITOR</span>.<span class="property">instances</span>.<span class="property">ArticleContent</span>;</span><br><span class="line">              <span class="keyword">var</span> content = oEditor.<span class="title function_">getData</span>();</span><br><span class="line">              $(<span class="string">&quot;#txtArticleContent&quot;</span>).<span class="title function_">val</span>(content);</span><br><span class="line"></span><br><span class="line">          &#125;);</span><br><span class="line">      &#125;);</span><br></pre></td></tr></table></figure>



<h2 id="4、上传图片并添加到富文本编辑器中。"><a href="#4、上传图片并添加到富文本编辑器中。" class="headerlink" title="4、上传图片并添加到富文本编辑器中。"></a>4、上传图片并添加到富文本编辑器中。</h2><p>导入<code>axios.js</code>文件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=<span class="string">&quot;/js/axios.js&quot;</span>&gt;&lt;/script&gt; &lt;!--这里引入了axios.<span class="property">js</span>--&gt;</span><br></pre></td></tr></table></figure>

<p>下面修改表格中的结构</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">td</span>&gt;</span>图片地址:<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">td</span> <span class="attr">colspan</span>=<span class="string">&quot;4&quot;</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;content&quot;</span>&gt;</span></span><br><span class="line">                   <span class="comment">&lt;!--这里将文件上传域给隐藏了--&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">input</span> <span class="attr">class</span>=<span class="string">&quot;mini-htmlfile&quot;</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">id</span>=<span class="string">&quot;iptFile&quot;</span> <span class="attr">accept</span>=<span class="string">&quot;image/*&quot;</span> <span class="attr">style</span>=<span class="string">&quot;display:none&quot;</span> /&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-primary&quot;</span> <span class="attr">id</span>=<span class="string">&quot;btnChoose&quot;</span>&gt;</span>选择 &amp; 上传图片<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">img</span> <span class="attr">id</span>=<span class="string">&quot;imgSrc&quot;</span> <span class="attr">width</span>=<span class="string">&quot;50px&quot;</span> <span class="attr">height</span>=<span class="string">&quot;50px&quot;</span> /&gt;</span></span><br><span class="line">               <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>下面是具体的<code>js</code>代码实现</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> btnChoose = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#btnChoose&#x27;</span>) <span class="comment">// -----------获取上传按钮</span></span><br><span class="line">       <span class="keyword">let</span> iptFile = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#iptFile&#x27;</span>) <span class="comment">// -------------找到文件上传域</span></span><br><span class="line">       <span class="keyword">let</span> imgsrc = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#imgSrc&#x27;</span>) <span class="comment">// -------------注意：这里获取的是imgSrc找到展示头像图片的img标签</span></span><br><span class="line"></span><br><span class="line">       <span class="comment">//-----------给上传按钮注册单击事件</span></span><br><span class="line">       btnChoose.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span><br><span class="line">           e.<span class="title function_">preventDefault</span>(); <span class="comment">//----------------注意这里一定要阻止默认行为，因为按钮在表单中会有提交的动作。</span></span><br><span class="line">           iptFile.<span class="title function_">click</span>()</span><br><span class="line">       &#125;)</span><br><span class="line">       <span class="comment">// FormData 存文件  ==&gt; axios 发请求 (看接口文档)</span></span><br><span class="line">       iptFile.<span class="title function_">addEventListener</span>(<span class="string">&#x27;change&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">           <span class="comment">// 用户选择的文件，该如何拿到？</span></span><br><span class="line">           <span class="comment">//  console.log(this.files[0])</span></span><br><span class="line"></span><br><span class="line">           <span class="comment">// 当this.files[0] 是undefined的时候，表示用户未选中文件，以下代码不用执行</span></span><br><span class="line">           <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">files</span>[<span class="number">0</span>]) &#123;</span><br><span class="line">               <span class="keyword">return</span> <span class="comment">// 阻止后续代码的执行</span></span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// FormData 构造函数 new一起使用</span></span><br><span class="line">           <span class="keyword">let</span> fd = <span class="keyword">new</span> <span class="title class_">FormData</span>()</span><br><span class="line">           fd.<span class="title function_">append</span>(<span class="string">&#x27;avatar&#x27;</span>, <span class="variable language_">this</span>.<span class="property">files</span>[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">           <span class="comment">// axios 发请求代码</span></span><br><span class="line">           <span class="title function_">axios</span>(&#123;</span><br><span class="line">               <span class="attr">method</span>: <span class="string">&#x27;post&#x27;</span>,</span><br><span class="line">               <span class="comment">// 请求的url地址一定要从接口文档中去复制</span></span><br><span class="line">               <span class="attr">url</span>: <span class="string">&#x27;/ArticelInfo/fileupload&#x27;</span>,</span><br><span class="line">               <span class="comment">// data的值是fd（把FormData存的数据给发送到服务器上）</span></span><br><span class="line">               <span class="attr">data</span>: fd</span><br><span class="line">           &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">&#123; data: res &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(res)</span><br><span class="line"></span><br><span class="line">               <span class="comment">// 更换图片（以下写法有问题，res.url 缺少根路径）</span></span><br><span class="line">               <span class="comment">// img.src = res.url // error</span></span><br><span class="line">               <span class="keyword">let</span> photourl = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;PhotoUrl&quot;</span>);</span><br><span class="line">               photourl.<span class="property">value</span> = res.<span class="property">url</span>;  <span class="comment">// ------------------- 注意：将上传成功的头像的路径保存到隐藏域中</span></span><br><span class="line">               imgsrc.<span class="property">src</span> = res.<span class="property">url</span></span><br><span class="line">            </span><br><span class="line">               <span class="comment">//----------------------------判断是否选择了&quot;图片是否插入编辑器&quot;</span></span><br><span class="line">               <span class="keyword">var</span> flag = $(<span class="string">&quot;#InsertEditContent&quot;</span>).<span class="title function_">is</span>(<span class="string">&quot;:checked&quot;</span>);</span><br><span class="line">               <span class="keyword">if</span> (flag) &#123;</span><br><span class="line">                   <span class="keyword">var</span> oEditor = <span class="variable constant_">CKEDITOR</span>.<span class="property">instances</span>.<span class="property">ArticleContent</span>;<span class="comment">//找到编辑器</span></span><br><span class="line">                   <span class="keyword">if</span> (oEditor.<span class="property">mode</span> == <span class="string">&#x27;wysiwyg&#x27;</span>) &#123;</span><br><span class="line">                       <span class="keyword">var</span> img = <span class="string">&quot;&lt;img src=&#x27;&quot;</span> + res.<span class="property">url</span> + <span class="string">&quot;&#x27;/&gt;&quot;</span>;</span><br><span class="line">                       oEditor.<span class="title function_">insertHtml</span>(img);<span class="comment">//将上传成功的图片插入到编辑器中。</span></span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="keyword">else</span></span><br><span class="line">                       <span class="title function_">alert</span>(<span class="string">&#x27;You must be in WYSIWYG mode!&#x27;</span>);</span><br><span class="line"></span><br><span class="line">               &#125;</span><br><span class="line">           &#125;)</span><br><span class="line">       &#125;)</span><br></pre></td></tr></table></figure>

<p>下面要实现的<code>ArticelInfo</code>控制器中的<code>FileUpload</code>方法，代码如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#region 图片上传</span><br><span class="line">       public <span class="keyword">async</span> <span class="title class_">Task</span>&lt;<span class="title class_">IActionResult</span>&gt; <span class="title class_">FileUpload</span>()</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">var</span> file = <span class="title class_">Request</span>.<span class="property">Form</span>.<span class="property">Files</span>[<span class="string">&quot;avatar&quot;</span>]; <span class="comment">// 接收上传的图片文件</span></span><br><span class="line">           <span class="keyword">if</span> (file == <span class="literal">null</span>) <span class="keyword">return</span> <span class="title class_">Json</span>(<span class="keyword">new</span> &#123; code = <span class="number">500</span>, msg = <span class="string">&quot;请选择上传文件&quot;</span> &#125;); <span class="comment">// ----------注意：前端没有对返回的这块信息进行处理</span></span><br><span class="line">           string fileExtension = <span class="title class_">Path</span>.<span class="title class_">GetExtension</span>(file.<span class="property">FileName</span>);</span><br><span class="line">           <span class="keyword">if</span>(fileExtension !=<span class="string">&quot;.jpg&quot;</span>) <span class="keyword">return</span>  <span class="title class_">Json</span>(<span class="keyword">new</span> &#123; code = <span class="number">500</span>, msg = <span class="string">&quot;只能上传.jpg格式的文件&quot;</span> &#125;);<span class="comment">//---------------注意：前端没有对返回的这块信息进行处理</span></span><br><span class="line">           string fileName = <span class="title class_">Guid</span>.<span class="title class_">NewGuid</span>().<span class="title class_">ToString</span>() + <span class="title class_">Path</span>.<span class="title class_">GetExtension</span>(file.<span class="property">FileName</span>);</span><br><span class="line">           <span class="comment">// 将上传的图片存储到不同的文件夹中，这里是以年月日作为文件夹名</span></span><br><span class="line">           string dir = <span class="string">&quot;/ImageUp/&quot;</span> + <span class="title class_">DateTime</span>.<span class="property">Now</span>.<span class="property">Year</span> + <span class="string">&quot;/&quot;</span> + <span class="title class_">DateTime</span>.<span class="property">Now</span>.<span class="property">Month</span> + <span class="string">&quot;/&quot;</span> + <span class="title class_">DateTime</span>.<span class="property">Now</span>.<span class="property">Day</span> + <span class="string">&quot;/&quot;</span>;</span><br><span class="line">           <span class="comment">// 在wwwroot目录下面创建文件夹</span></span><br><span class="line">           <span class="title class_">Directory</span>.<span class="title class_">CreateDirectory</span>(<span class="title class_">Path</span>.<span class="title class_">Combine</span>(webHostEnvironment.<span class="property">ContentRootPath</span>, <span class="string">&quot;wwwroot&quot;</span> + dir));</span><br><span class="line">           <span class="comment">// 构建文件存储的路径（一定要放在wwwroot目录下面）</span></span><br><span class="line">           <span class="keyword">var</span> filePath = <span class="title class_">Path</span>.<span class="title class_">Combine</span>(webHostEnvironment.<span class="property">ContentRootPath</span>, <span class="string">&quot;wwwroot&quot;</span> + dir, fileName);</span><br><span class="line"></span><br><span class="line">           using (<span class="title class_">FileStream</span> fileStream = <span class="keyword">new</span> <span class="title class_">FileStream</span>(filePath, <span class="title class_">FileMode</span>.<span class="property">Create</span>, <span class="title class_">FileAccess</span>.<span class="property">Write</span>))</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">await</span> file.<span class="title class_">CopyToAsync</span>(fileStream);</span><br><span class="line">               <span class="keyword">return</span> <span class="title class_">Json</span>(<span class="keyword">new</span> &#123; code = <span class="number">200</span>, url = dir + fileName &#125;); <span class="comment">// 将上传成功的图片路径进行返回</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       #endregion</span><br></pre></td></tr></table></figure>

<p>启动项目进行测试。</p>
<p>这里也可以将上面的代码封装到服务层中。在对应的文章服务接口中定义如下方法</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Task&lt;<span class="built_in">string</span>&gt; <span class="title">FileUploadSave</span>(<span class="params">IFormFile file,<span class="built_in">string</span> rootPath</span>)</span>;</span><br></pre></td></tr></table></figure>

<p>注意：这里使用了<code>IFormFile</code>这个接口，所以需要导入<code>using Microsoft.AspNetCore.Http</code></p>
<p>在具体的文章服务中实现上面的方法</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span>  <span class="keyword">async</span> Task&lt;<span class="built_in">string</span>&gt; <span class="title">FileUploadSave</span>(<span class="params">IFormFile file,<span class="built_in">string</span> rootPath</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="built_in">string</span> fileName = Guid.NewGuid().ToString() + Path.GetExtension(file.FileName);</span><br><span class="line">           <span class="comment">// 将上传的图片存储到不同的文件夹中，这里是以年月日作为文件夹名</span></span><br><span class="line">           <span class="built_in">string</span> dir = Path.Combine ( <span class="string">&quot;ImageUp&quot;</span>, DateTime.Now.Year.ToString(), DateTime.Now.Month.ToString(), DateTime.Now.Day.ToString());</span><br><span class="line">           <span class="comment">// 在wwwroot目录下面创建文件夹</span></span><br><span class="line">           Directory.CreateDirectory(Path.Combine(rootPath, <span class="string">&quot;wwwroot&quot;</span> , dir));</span><br><span class="line">           <span class="comment">// 构建文件存储的路径（一定要放在wwwroot目录下面）</span></span><br><span class="line">           <span class="keyword">var</span> filePath = Path.Combine(rootPath, <span class="string">&quot;wwwroot&quot;</span>, dir, fileName);</span><br><span class="line"></span><br><span class="line">           <span class="keyword">using</span> (FileStream fileStream = <span class="keyword">new</span> FileStream(filePath, FileMode.Create, FileAccess.Write))</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">await</span> file.CopyToAsync(fileStream);</span><br><span class="line">               <span class="keyword">return</span> dir + fileName;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>文章控制器中的代码</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">FileUpload</span>()</span></span><br><span class="line">      &#123;</span><br><span class="line">          <span class="keyword">var</span> file = Request.Form.Files[<span class="string">&quot;avatar&quot;</span>]; <span class="comment">// 接收上传的图片文件</span></span><br><span class="line">          <span class="keyword">if</span> (file == <span class="literal">null</span>) <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123; code = <span class="number">500</span>, msg = <span class="string">&quot;请选择上传文件&quot;</span> &#125;); <span class="comment">// ----------注意：前端没有对返回的这块信息进行处理</span></span><br><span class="line">          <span class="built_in">string</span> fileExtension = Path.GetExtension(file.FileName);</span><br><span class="line">          <span class="keyword">if</span> (fileExtension != <span class="string">&quot;.jpg&quot;</span>) <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123; code = <span class="number">500</span>, msg = <span class="string">&quot;只能上传.jpg格式的文件&quot;</span> &#125;);<span class="comment">//---------------注意：前端没有对返回的这块信息进行处理</span></span><br><span class="line">          <span class="built_in">string</span> rootPath = webHostEnvironment.ContentRootPath;</span><br><span class="line">          <span class="built_in">string</span> filePath = <span class="keyword">await</span> articelInfo.FileUploadSave(file, rootPath);</span><br><span class="line">          <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123; code = <span class="number">200</span>, url = filePath &#125;);</span><br><span class="line"></span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">readonly</span> IWebHostEnvironment webHostEnvironment;</span><br><span class="line">     <span class="keyword">private</span> <span class="keyword">readonly</span> IArticelInfoService articelInfoService;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="title">ArticelInfoController</span>(<span class="params">IWebHostEnvironment webHostEnvironment, IUserInfoService asrticelInfoService</span>)</span></span><br><span class="line">     &#123;</span><br><span class="line">         <span class="keyword">this</span>.webHostEnvironment = webHostEnvironment;</span><br><span class="line">         <span class="keyword">this</span>.ArticelInfoService = articelInfoService;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>

<p>在控制器的构造方法中进行注入。</p>
<h2 id="5、添加水印"><a href="#5、添加水印" class="headerlink" title="5、添加水印"></a>5、添加水印</h2><p>前端处理：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// axios 发请求代码</span></span><br><span class="line">           <span class="title function_">axios</span>(&#123;</span><br><span class="line">               <span class="attr">method</span>: <span class="string">&#x27;post&#x27;</span>,</span><br><span class="line">               <span class="comment">// 请求的url地址一定要从接口文档中去复制</span></span><br><span class="line">               <span class="attr">url</span>: <span class="string">&#x27;/ArticelInfo/fileupload?warterFlag=&#x27;</span> + <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;AddWaterFlag&quot;</span>).<span class="property">value</span>,</span><br><span class="line">               <span class="comment">// data的值是fd（把FormData存的数据给发送到服务器上）</span></span><br><span class="line">               <span class="attr">data</span>: fd</span><br><span class="line">           &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">&#123; data: res &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(res)</span><br></pre></td></tr></table></figure>

<p>在向<code>ArticelInfo</code>控制器中的<code>FileUpload</code>方法发送请求的时候，添加了<code>warterFlag</code>参数，如果用户选择了[添加水印]这复选框，该参数是有值的。</p>
<p>下面修改<code>ArticelInfo</code>控制器中的<code>FileUpload</code>方法中的代码，如下所示： </p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> (FileStream fileStream = <span class="keyword">new</span> FileStream(filePath, FileMode.Create, FileAccess.Write))</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrEmpty(Request.Query[<span class="string">&quot;warterFlag&quot;</span>])) <span class="comment">//------ 接收warterFlag参数，判断是否有值</span></span><br><span class="line">               &#123;</span><br><span class="line"></span><br><span class="line">                   <span class="keyword">using</span> (<span class="keyword">var</span> stream = <span class="keyword">new</span> MemoryStream()) <span class="comment">//----- 创建内存流</span></span><br><span class="line">                   &#123;</span><br><span class="line">                       <span class="comment">//------ 将接收到的文件流拷贝到内存流中，内存流中存储了文件数据</span></span><br><span class="line">                       <span class="keyword">await</span> file.CopyToAsync(stream);</span><br><span class="line">                       <span class="comment">// ----根据内存流创建画布</span></span><br><span class="line">                       <span class="keyword">using</span> (Bitmap map = <span class="keyword">new</span> Bitmap(stream))</span><br><span class="line">                       &#123;</span><br><span class="line">                           <span class="comment">// ------根据画布创建画笔</span></span><br><span class="line">                           <span class="keyword">using</span> (Graphics g = Graphics.FromImage(map))</span><br><span class="line">                           &#123;</span><br><span class="line">                              <span class="comment">// -----通过画笔在画布上写字</span></span><br><span class="line">                               g.DrawString(<span class="string">&quot;老王&quot;</span>, <span class="keyword">new</span> Font(<span class="string">&quot;微软雅黑&quot;</span>, <span class="number">60.0f</span>, FontStyle.Bold), Brushes.Red, <span class="keyword">new</span> PointF(map.Width - <span class="number">160</span>, map.Height - <span class="number">130</span>));</span><br><span class="line">						<span class="comment">// ---将画布的内容保存到fileStream这个文件流中，从而将图片保存到了指定的目录中</span></span><br><span class="line">                               map.Save(fileStream, ImageFormat.Jpeg);</span><br><span class="line">                               <span class="comment">// ----------返回保存的图片路径</span></span><br><span class="line">                               <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123; code = <span class="number">200</span>, url = dir + fileName &#125;);</span><br><span class="line">                           &#125;</span><br><span class="line">                       &#125;</span><br><span class="line"></span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">else</span></span><br><span class="line">               &#123;</span><br><span class="line">                   <span class="comment">// ----------如果没有选择添加水印，直接将文件保存到文件流中，从而保存到了指定的目录下面。</span></span><br><span class="line">                   <span class="keyword">await</span> file.CopyToAsync(fileStream);</span><br><span class="line">                   <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123; code = <span class="number">200</span>, url = dir + fileName &#125;); <span class="comment">// 将上传成功的图片路径进行返回</span></span><br><span class="line">               &#125;</span><br><span class="line">             </span><br><span class="line">           &#125;</span><br></pre></td></tr></table></figure>

<p>启动项目进行测试。</p>
<p>如果封装到了业务层，这里需要修改一下文章服务接口</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Task&lt;<span class="built_in">string</span>&gt; <span class="title">FileUploadSave</span>(<span class="params">IFormFile file,<span class="built_in">string</span> rootPath,<span class="built_in">string</span> warterFlag</span>)</span>;</span><br></pre></td></tr></table></figure>

<p>这里添加了参数<code>warterFlag</code></p>
<p>文章服务类中具体代码的修改，如下：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;<span class="built_in">string</span>&gt; <span class="title">FileUploadSave</span>(<span class="params">IFormFile file, <span class="built_in">string</span> rootPath, <span class="built_in">string</span> warterFlag</span>)</span></span><br><span class="line">      &#123;</span><br><span class="line">          <span class="built_in">string</span> fileName = Guid.NewGuid().ToString() + Path.GetExtension(file.FileName);</span><br><span class="line">          <span class="comment">// 将上传的图片存储到不同的文件夹中，这里是以年月日作为文件夹名</span></span><br><span class="line">          <span class="built_in">string</span> dir = Path.Combine(<span class="string">&quot;ImageUp&quot;</span>, DateTime.Now.Year.ToString(), DateTime.Now.Month.ToString(), DateTime.Now.Day.ToString());</span><br><span class="line">          <span class="comment">// 在wwwroot目录下面创建文件夹</span></span><br><span class="line">          Directory.CreateDirectory(Path.Combine(rootPath, <span class="string">&quot;wwwroot&quot;</span>, dir));</span><br><span class="line">          <span class="comment">// 构建文件存储的路径（一定要放在wwwroot目录下面）</span></span><br><span class="line">          <span class="keyword">var</span> filePath = Path.Combine(rootPath, <span class="string">&quot;wwwroot&quot;</span>, dir, fileName);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">using</span> (FileStream fileStream = <span class="keyword">new</span> FileStream(filePath, FileMode.Create, FileAccess.Write))</span><br><span class="line">          &#123;</span><br><span class="line">              <span class="comment">// ---------------------判断参数warterFlag是否为空</span></span><br><span class="line">              <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrEmpty(warterFlag))</span><br><span class="line">              &#123;</span><br><span class="line">                  <span class="keyword">using</span> (<span class="keyword">var</span> stream = <span class="keyword">new</span> MemoryStream()) <span class="comment">//----- 创建内存流</span></span><br><span class="line">                  &#123;</span><br><span class="line">                      <span class="comment">//------ 将接收到的文件流拷贝到内存流中，内存流中存储了文件数据</span></span><br><span class="line">                      <span class="keyword">await</span> file.CopyToAsync(stream);</span><br><span class="line">                      <span class="comment">// ----根据内存流创建画布</span></span><br><span class="line">                      <span class="keyword">using</span> (Bitmap map = <span class="keyword">new</span> Bitmap(stream))</span><br><span class="line">                      &#123;</span><br><span class="line">                          <span class="comment">// ------根据画布创建画笔</span></span><br><span class="line">                          <span class="keyword">using</span> (Graphics g = Graphics.FromImage(map))</span><br><span class="line">                          &#123;</span><br><span class="line">                              <span class="comment">// -----通过画笔在画布上写字</span></span><br><span class="line">                              g.DrawString(<span class="string">&quot;老王&quot;</span>, <span class="keyword">new</span> Font(<span class="string">&quot;微软雅黑&quot;</span>, <span class="number">60.0f</span>, FontStyle.Bold), Brushes.Red, <span class="keyword">new</span> PointF(map.Width - <span class="number">160</span>, map.Height - <span class="number">130</span>));</span><br><span class="line">                              <span class="comment">// ---将画布的内容保存到fileStream这个文件流中，从而将图片保存到了指定的目录中</span></span><br><span class="line">                              map.Save(fileStream, ImageFormat.Jpeg);</span><br><span class="line">                              <span class="comment">// ----------返回保存的图片路径</span></span><br><span class="line"></span><br><span class="line">                          &#125;</span><br><span class="line">                      &#125;</span><br><span class="line"></span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">else</span></span><br><span class="line">              &#123;</span><br><span class="line">                  <span class="keyword">await</span> file.CopyToAsync(fileStream);</span><br><span class="line"></span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">              <span class="keyword">return</span> dir + fileName;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>



<p>控制器中代码的修改</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">FileUpload</span>()</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">var</span> file = Request.Form.Files[<span class="string">&quot;avatar&quot;</span>]; <span class="comment">// 接收上传的图片文件</span></span><br><span class="line">           <span class="keyword">if</span> (file == <span class="literal">null</span>) <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123; code = <span class="number">500</span>, msg = <span class="string">&quot;请选择上传文件&quot;</span> &#125;); <span class="comment">// ----------注意：前端没有对返回的这块信息进行处理</span></span><br><span class="line">           <span class="built_in">string</span> fileExtension = Path.GetExtension(file.FileName);</span><br><span class="line">           <span class="keyword">if</span> (fileExtension != <span class="string">&quot;.jpg&quot;</span>) <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123; code = <span class="number">500</span>, msg = <span class="string">&quot;只能上传.jpg格式的文件&quot;</span> &#125;);<span class="comment">//---------------注意：前端没有对返回的这块信息进行处理</span></span><br><span class="line">           <span class="built_in">string</span> rootPath = webHostEnvironment.ContentRootPath;</span><br><span class="line">           <span class="built_in">string</span> filePath = <span class="keyword">await</span> articelInfoService.FileUploadSave(file, rootPath, Request.Query[<span class="string">&quot;warterFlag&quot;</span>]); <span class="comment">//这里传递了waterFlag参数</span></span><br><span class="line">           <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123; code = <span class="number">200</span>, url = filePath &#125;);</span><br><span class="line"></span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>这里在调用<code>articelInfoService</code>服务类中的<code>FileUploadSave</code>方法的时候传递了<code>Request.Query[&quot;warterFlag&quot;]</code></p>
<h2 id="6、加载文章分类"><a href="#6、加载文章分类" class="headerlink" title="6、加载文章分类"></a>6、加载文章分类</h2><p>在添加文章的表单中，有一个下拉框，来展示文章的分类，下面实现文章分类的加载功能。</p>
<p>这里采用的是递归的方式，获取所有的文章分类（文章分类就是一个树形结构）。</p>
<p>当然，在页面的下拉框中进行展示的时候，我们只是展示前两层分类就可以了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//将数组中的数据转换成树形数据(使用递归算法)</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">tranListToTreeData</span>(<span class="params">list, rootValue</span>) &#123; <span class="comment">// 0</span></span><br><span class="line">    <span class="keyword">var</span> arr = [];</span><br><span class="line">    list.<span class="title function_">forEach</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (item.<span class="property">parentId</span> === rootValue) &#123;</span><br><span class="line">        <span class="comment">// 找到之后 就要去找 item 下面有没有子节点</span></span><br><span class="line">        <span class="keyword">const</span> children = <span class="title function_">tranListToTreeData</span>(list, item.<span class="property">id</span>);</span><br><span class="line">        <span class="keyword">if</span> (children.<span class="property">length</span>) &#123;</span><br><span class="line">          <span class="comment">// 如果children的长度大于0 说明找到了子节点</span></span><br><span class="line">          item.<span class="property">children</span> = children;</span><br><span class="line">        &#125;</span><br><span class="line">        arr.<span class="title function_">push</span>(item); <span class="comment">// 将内容加入到数组中</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> arr;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>



<h2 id="7、页面静态化"><a href="#7、页面静态化" class="headerlink" title="7、页面静态化"></a>7、页面静态化</h2><p>在<code>Cms.Common</code> 安装<code>NVelocity</code>模版引擎</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Install-Package NVelocity</span><br></pre></td></tr></table></figure>

<p>同时在该类库项目中创建<code>NVelocityHelper</code>类，该类中的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 创建NVelocity模板引擎，读取设计好的模板页面，替换占位符。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;templateName&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;data&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;templateFilePath&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">RenderTemplate</span>(<span class="params"><span class="built_in">string</span> templateName, <span class="built_in">object</span> data, <span class="built_in">string</span> templateFilePath</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            VelocityEngine vltEngine = <span class="keyword">new</span> VelocityEngine(); <span class="comment">// 创建模版引擎</span></span><br><span class="line">            vltEngine.SetProperty(RuntimeConstants.RESOURCE_LOADER, <span class="string">&quot;file&quot;</span>);</span><br><span class="line">            vltEngine.SetProperty(RuntimeConstants.FILE_RESOURCE_LOADER_PATH, templateFilePath);</span><br><span class="line">            vltEngine.Init();</span><br><span class="line"></span><br><span class="line">            VelocityContext vltContext = <span class="keyword">new</span> VelocityContext();</span><br><span class="line">            vltContext.Put(<span class="string">&quot;data&quot;</span>, data); <span class="comment">// 把data对象中的数据传递数据给data属性，在模版中会替换对应的占位符</span></span><br><span class="line"></span><br><span class="line">            Template vltTemplate = vltEngine.GetTemplate(templateName + <span class="string">&quot;.html&quot;</span>); <span class="comment">// 得到模版文件名称</span></span><br><span class="line">            System.IO.StringWriter vltWriter = <span class="keyword">new</span> System.IO.StringWriter();</span><br><span class="line">            vltTemplate.Merge(vltContext, vltWriter);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> vltWriter.GetStringBuilder().ToString();</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>以上代码是固定的写法，直接使用</p>
<p>将<code>ArticelTemplate</code>这个文件夹拷贝到<code>Cms.WebUI</code>项目中的<code>wwwroot</code>这个目录中。<code>ArticelTemplate</code>这个文件夹中存放的就是生成静态页面的模版文件。</p>
<p>返回到添加文章的视图页面<code>ShowAdd.cshtml</code>中，进行代码的修改：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=<span class="string">&quot;/js/axios.js&quot;</span>&gt;&lt;/script&gt; </span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/js/form-serialize.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span> &lt;!--这里引入了form-serialize.<span class="property">js</span>--&gt;</span><br></pre></td></tr></table></figure>

<p>这里首先引入了<code>form-serialize.js</code>这个文件。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">&quot;form1&quot;</span>&gt;</span> <span class="comment">&lt;!---------添加form标签----------&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">style</span>=<span class="string">&quot;width:auto; margin: 0 auto&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>简短标题:<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里使用<code>form</code>标签包裹了整个表格中的表单元素。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">   </span><br><span class="line"><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;text-align:center;padding:10px;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">style</span>=<span class="string">&quot;width:60px;margin-right:20px;&quot;</span> <span class="attr">id</span>=<span class="string">&quot;btnOk&quot;</span>&gt;</span>确定<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;onCancel()&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width:60px;&quot;</span>&gt;</span>取消<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>同时在表格标签的后面添加了<code>确定与取消</code>的按钮。这里我们直接给<code>确定</code>按钮添加了一个<code>id</code>属性。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> $(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">         <span class="comment">//--------省略了以前的代码</span></span><br><span class="line">      <span class="comment">// 给确定按钮注册了单击事件</span></span><br><span class="line">            $(<span class="string">&quot;#btnOk&quot;</span>).<span class="title function_">click</span>(<span class="keyword">function</span>(<span class="params">e</span>)&#123;</span><br><span class="line">                <span class="title class_">SaveData</span>(e)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;);</span><br><span class="line"><span class="comment">//  关闭窗口的方法</span></span><br><span class="line">        <span class="keyword">function</span> <span class="title function_">onCancel</span>(<span class="params"></span>) &#123;</span><br><span class="line">   </span><br><span class="line">            <span class="variable language_">window</span>.<span class="title class_">CloseOwnerWindow</span>();</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>上面的代码中，我们给【确定】按钮注册了单击事件，事件触发以后，调用了<code>SaveData</code>方法来发送请求，这里传递了事件对象<code>e</code>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 保存表单中的数据      </span></span><br><span class="line">     <span class="keyword">function</span> <span class="title function_">SaveData</span>(<span class="params">e</span>) &#123;</span><br><span class="line">          e.<span class="title function_">preventDefault</span>(); <span class="comment">// 阻止默认行为</span></span><br><span class="line">          <span class="keyword">var</span> form = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;form1&quot;</span>);</span><br><span class="line">          <span class="keyword">let</span> data = <span class="title function_">serialize</span>(form); <span class="comment">// 获取表单中的数据</span></span><br><span class="line">          $.<span class="title function_">ajax</span>(&#123;</span><br><span class="line">              <span class="attr">url</span>: <span class="string">&#x27;/ArticelInfo/CreateArticel&#x27;</span>,</span><br><span class="line">              <span class="attr">method</span>: <span class="string">&quot;post&quot;</span>,</span><br><span class="line">              <span class="attr">data</span>: data,</span><br><span class="line">              <span class="attr">success</span>: <span class="keyword">function</span> (<span class="params">data</span>) &#123;</span><br><span class="line">                  <span class="title function_">onCancel</span>();</span><br><span class="line">              &#125;,</span><br><span class="line">              <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line"></span><br><span class="line">              &#125;</span><br><span class="line">          &#125;)</span><br><span class="line"></span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>在上面的代码中，获取了表单中的数据，然后通过<code>ajax</code>请求，发送到<code>ArticelInfo</code>这个控制器中的<code>CreateArticel</code>方法中。</p>
<p>下面实现该方法。代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">region</span> 保存文章信息</span></span><br><span class="line">      [<span class="meta">UnitOfWork(new Type[</span>] &#123; <span class="keyword">typeof</span>(MyDbContext) &#125;)]</span><br><span class="line">      <span class="function"><span class="keyword">public</span> IActionResult <span class="title">CreateArticel</span>(<span class="params">ArticelInfo articelInfo</span>)</span></span><br><span class="line">      &#123;</span><br><span class="line">          articelInfo.CreateTime = DateTime.Now;</span><br><span class="line">          articelInfo.UpdateTime = DateTime.Now;</span><br><span class="line">          articelInfo.DelFlag =Convert.ToBoolean(DelFlagEnum.Normal); </span><br><span class="line">    <span class="comment">// 这里需要特别注意的是，需要单独的接收下拉框中所选择的文章分类的编号</span></span><br><span class="line">          <span class="built_in">int</span> cId =Convert.ToInt32(Request.Form[<span class="string">&quot;ArticelClassInfo&quot;</span>]);</span><br><span class="line">    <span class="comment">// 调用CreateHtmlPage 方法，生成静态页面。</span></span><br><span class="line">          CreateHtmlPage(articelInfo,<span class="string">&quot;add&quot;</span>);</span><br><span class="line">          <span class="keyword">return</span> Content(<span class="string">&quot;ok&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">#<span class="keyword">endregion</span></span></span><br></pre></td></tr></table></figure>

<p>在上面的代码中，我们还没有将提交过来的文章数据保存到数据库，这里只是做了相应的接收以后，调用了<code>CreateHtmlPage</code>方法生成了静态页面。</p>
<p>下面就直接创建<code>CreateHtmlPage</code>方法来生成静态页面，该方法的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">region</span> 生成静态页面.</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> <span class="keyword">void</span> <span class="title">CreateHtmlPage</span>(<span class="params">ArticelInfo articelInfo, <span class="built_in">string</span> flag</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">    <span class="comment">//  调用RenderTemplate方法完成模版中占位符的替换，生成静态页面完整的数据</span></span><br><span class="line">    <span class="comment">// 第一个参数：表示模版的名称</span></span><br><span class="line">    <span class="comment">// 第二个参数：表示具体的数据，也就是使用该对象替换模版中的占位符</span></span><br><span class="line">    <span class="comment">// 第三个参数，指定具体的模版文件的具体存放路径</span></span><br><span class="line">           <span class="built_in">string</span> html = NVelocityHelper.RenderTemplate(<span class="string">&quot;ArticelTemplateInfo&quot;</span>, articelInfo, Path.Combine(webHostEnvironment.ContentRootPath, <span class="string">&quot;wwwroot/ArticelTemplate/&quot;</span>));</span><br><span class="line">    <span class="comment">// 生成好的静态文件存放在该目录下面</span></span><br><span class="line">           <span class="built_in">string</span> dir = <span class="string">&quot;/ArticelHtml/&quot;</span> + articelInfo.CreateTime.Year + <span class="string">&quot;/&quot;</span> + articelInfo.CreateTime.Month + <span class="string">&quot;/&quot;</span> + articelInfo.CreateTime.Day + <span class="string">&quot;/&quot;</span>;</span><br><span class="line">    <span class="comment">// 这里将生成好的静态文件也是存放在了wwwroot目录下的ArticelHtml目录中</span></span><br><span class="line">           <span class="built_in">string</span> dirCombine= Path.Combine(webHostEnvironment.ContentRootPath, <span class="string">&quot;wwwroot&quot;</span> + dir);</span><br><span class="line">           <span class="keyword">if</span> (flag == <span class="string">&quot;add&quot;</span>)</span><br><span class="line">           &#123;            </span><br><span class="line">               <span class="comment">// 创建指定的目录</span></span><br><span class="line">               Directory.CreateDirectory(dirCombine);</span><br><span class="line">           &#125;</span><br><span class="line">          </span><br><span class="line">	<span class="comment">// 获取具体的静态文件完整的路径（包含文件名，文件名就是guid来命名的）</span></span><br><span class="line">          <span class="built_in">string</span> fullDir = dirCombine + Guid.NewGuid().ToString().Substring(<span class="number">0</span>,<span class="number">8</span>) + <span class="string">&quot;.html&quot;</span>;</span><br><span class="line">       <span class="comment">//  html参数中存储的是通过NVelocity模版替换站位符以后得到的静态页面的完整数据</span></span><br><span class="line">    <span class="comment">// fullDir是静态文件完整的存储路径</span></span><br><span class="line">    <span class="comment">// 通过WriteAllTextAsync方法把html参数中的数据，写入到指定的目录下面</span></span><br><span class="line">          <span class="keyword">await</span> System.IO.File.WriteAllTextAsync(fullDir, html, System.Text.Encoding.UTF8);</span><br><span class="line"></span><br><span class="line">       &#125;</span><br><span class="line">       <span class="meta">#<span class="keyword">endregion</span></span></span><br></pre></td></tr></table></figure>

<p>启动程序进行测试。</p>
<p>可以在<code>wwwroot</code>目录下面看到一个<code>ArticelHtml</code>目录，在该目录下的指定的日期命名的文件夹中，可以看到一个<code>0.html</code>文件，这就是我们生成的具体的静态页面。这里文件名是<code>0</code>的原因是，我们还没有保存数据到数据库中，所以<code>Id</code>的值就是0。</p>
<h2 id="8、完成文章信息的存储"><a href="#8、完成文章信息的存储" class="headerlink" title="8、完成文章信息的存储"></a>8、完成文章信息的存储</h2><p>指定数据仓储接口<code>IArticelInfoRepository.cs</code></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IArticelInfoRepository</span>:<span class="title">IBaseRepository</span>&lt;<span class="title">ArticelInfo</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>创建具体的数据仓储实现<code>ArticelInfoRepository.cs</code>，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.Repository</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ArticelInfoRepository</span>:<span class="title">BaseRepository</span>&lt;<span class="title">ArticelInfo</span>&gt;,<span class="title">IArticelInfoRepository</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ArticelInfoRepository</span>(<span class="params">MyDbContext context</span>) : <span class="title">base</span>(<span class="params">context</span>)</span> &#123; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>创建具体的服务接口<code>IArticelInfoService.cs</code></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.IService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IArticelInfoService</span>:<span class="title">IBaseService</span>&lt;<span class="title">ArticelInfo</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建具体的服务实现类<code>ArticelInfoService.cs</code></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ArticelInfoService</span>:<span class="title">BaseService</span>&lt;<span class="title">ArticelInfo</span>&gt;,<span class="title">IArticelInfoService</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">readonly</span> IArticelInfoRepository _articelRepository;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="title">ArticelInfoService</span>(<span class="params">IArticelInfoRepository articelRepository</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">base</span>.repository = articelRepository;</span><br><span class="line">           _articelRepository = articelRepository;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>下面完善控制器中的<code>CreateArticel</code>方法</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">region</span> 保存文章信息</span></span><br><span class="line">       [<span class="meta">UnitOfWork(new Type[</span>] &#123; <span class="keyword">typeof</span>(MyDbContext) &#125;)]</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">CreateArticel</span>(<span class="params">ArticelInfo articelInfo</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           articelInfo.CreateTime = DateTime.Now;</span><br><span class="line">           articelInfo.UpdateTime = DateTime.Now;</span><br><span class="line">           articelInfo.DelFlag =Convert.ToBoolean(DelFlagEnum.Normal);</span><br><span class="line">           <span class="built_in">int</span> cId =Convert.ToInt32(Request.Form[<span class="string">&quot;ArticelClassInfo&quot;</span>]);</span><br><span class="line">        </span><br><span class="line">           articelInfo.ArticelClassId = cId;</span><br><span class="line">          </span><br><span class="line">        </span><br><span class="line">         <span class="keyword">var</span> articel =  <span class="keyword">await</span> articelInfoService.InsertEntityAsync(articelInfo);</span><br><span class="line"></span><br><span class="line">            CreateHtmlPage(articel, <span class="string">&quot;add&quot;</span>);</span><br><span class="line">       </span><br><span class="line">           <span class="keyword">return</span> Json(<span class="keyword">new</span> &#123; code = <span class="number">200</span>, msg = <span class="string">&quot;添加成功&quot;</span>, articelInfo &#125;);</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>这里我们接收到<code>cId</code>这个文章的类别编号以后，我们没有查询对应的类别信息，而是直接赋值给了<code>articelInfo</code>对象中表示外键的属性<code>ArticelClassId</code>属性。</p>
<p>这就要求我们指定这个外键，关于这一点，我们在学习<code>EF Core</code>的时候给大家讲解过。</p>
<p>这里我们需要修改一下<code>Cms.Entity</code>这个类库项目中的<code>ArticelInfo.cs</code>实体类</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">string</span>? PhotoUrl &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> 文章属于哪个类别</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="keyword">public</span> ArticelClass? ArticelClass &#123; <span class="keyword">get</span>; <span class="keyword">set</span>;&#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">public</span> <span class="built_in">int</span> ArticelClassId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; <span class="comment">// 这里添加了外键的属性ArticelClassId</span></span><br></pre></td></tr></table></figure>

<p> 这里添加了外键的属性<code>ArticelClassId</code></p>
<p>同时修改<code>ArticelInfoConfig.cs</code>这个配置文件，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 一个类别下面多篇文章</span></span><br><span class="line">          builder.HasOne&lt;ArticelClass&gt;(c =&gt; c.ArticelClass).WithMany(a =&gt; a.ArticelInfos).IsRequired().HasForeignKey(c=&gt;c.ArticelClassId);</span><br></pre></td></tr></table></figure>

<p>这里，通过<code>HasForeignKey</code>指定了外键是<code>ArticelClassId</code>.</p>
<p>这里，不需要重新进行数据库的迁移操作，因为在<code>T_ArticelInfos</code>表中，有对应的外键就是<code>ArticelClassId</code>.</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">region</span> 生成静态页面.</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> <span class="keyword">void</span> <span class="title">CreateHtmlPage</span>(<span class="params">ArticelInfo articelInfo, <span class="built_in">string</span> flag</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">if</span> (articelInfo.TitleFontColor == <span class="string">&quot;1&quot;</span>)</span><br><span class="line">           &#123;</span><br><span class="line">               articelInfo.Title = <span class="string">&quot;&lt;font color=&#x27;red&#x27; &gt;&quot;</span> + articelInfo.Title + <span class="string">&quot;&lt;/font&gt;&quot;</span>;</span><br><span class="line">           &#125;</span><br></pre></td></tr></table></figure>

<p>在生成静态页面的时候，可以判断<code>TitleFontColor</code>属性的取值，如果是1，表示用户选择的标题颜色是红色。所以这里使用了<code>font</code>标签添加了红色。</p>
<p>其他的选项，大家可以自己进行判断。</p>
<h2 id="9、敏感词过滤"><a href="#9、敏感词过滤" class="headerlink" title="9、敏感词过滤"></a>9、敏感词过滤</h2><p>在添加文章或者是发布评论的时候，需要对用户输入的内容进行审查，这里主要是审查一下是否有敏感词。</p>
<p>关于敏感词，主要分为审查词和禁用词。</p>
<p>审查词：如果文章内容中含有审查词，可以将文章内容存储到数据库中，但是需要管理员审查以后才能展示到前端页面中。</p>
<p>禁用词：直接不允许将文章内容存储到数据库中。</p>
<p>替换词：有些词可以进行替换。 </p>
<p>把数据库中存储的词库取出来以后，存储到缓存中。</p>
<h2 id="10、网站发布"><a href="#10、网站发布" class="headerlink" title="10、网站发布"></a>10、网站发布</h2><p>可以在<code>Cms.WebUI</code>这个<code>Web</code>应用程序上右击，从弹出的快捷菜单中选择<code>发布</code></p>
<p>选择发布目标的时候，可以选择【文件夹】,这样可以将项目中的文件发布到指定的文件夹下面，然后拷贝到服务器上。</p>
<p>我们可以单击【所有显示设置】，在弹出的设置的窗口中，进行设置</p>
<p>【配置】：选择<code>Release</code>，不要选择<code>Debug</code>，因为<code>Release</code>性能高，<code>Debug</code>中包含了很多的调试信息。</p>
<p>【目标框架】：这里我们选择<code>.net 7.0</code></p>
<p>【部署模式】：关于“框架依赖”这个选项的含义：发布的项目是不包含<code>.net</code>运行时的，需要服务器上单独的安装<code>.net</code>的运行时。</p>
<p>​                “独立”：表示发布的程序中包含了<code>.net</code>的运行时。</p>
<p>【文件发布选项】：“生成单个文件”：表示的是把所有的<code>.dll</code>文件生成到一个文件中。“在发布前删除所有现有文件”：表示的是把用来存放发布项目对应的文件夹中原有的文件删除掉，保证该文件夹一直存储最新的发布后的文件。</p>
<p>“启用<code>ReadyToRun </code>编译”这个选项：<code>https://learn.microsoft.com/zh-cn/dotnet/core/deploying/ready-to-run</code></p>
<p>【数据库】选项中，不需要更改，因为以后，上线，需要更改成生成数据库的链接字符串。</p>
<p>当网站发布以后，我们双击对应的<code>exe</code>文件，就可以启动我们所发布的网站的原因是：在<code>.net core</code>中内置了<code>Kestrel</code>服务器，尽管该服务器已经非常的强大了，但是一般仍然不会让<code>Kestrel</code>直接面对用户的请求，</p>
<p>一般都是浏览器与<code>Kestrel</code>服务器之间会添加一个反向代理服务器。</p>
<p>添加反向代理服务器的好处：实现集群化配置。</p>
<p>当然，针对<code>.net core</code>有很多的部署：<code>K8s</code>+容器(推荐，难道高),<code>Linux+Nginx</code>，<code>Windows+IIS</code></p>
<p>部署到<code>IIS</code>参考文档：<code>https://blog.csdn.net/qq_16256429/article/details/122400717</code></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://www.kilgour.top">kilgour</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://www.kilgour.top/2024/07/18/%E8%80%81%E7%8E%8B-12%E3%80%81CMS%E9%A1%B9%E7%9B%AE/">http://www.kilgour.top/2024/07/18/%E8%80%81%E7%8E%8B-12%E3%80%81CMS%E9%A1%B9%E7%9B%AE/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://www.kilgour.top" target="_blank">Kilgour Notes</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://raw.githubusercontent.com/kilg0ur/picture/master/picture/cover3.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/07/21/%E8%80%81%E7%8E%8B-14%E3%80%81CMS%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8/" title=""><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/kilg0ur/picture/master/picture/cover17.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info"></div></div></a></div><div class="next-post pull-right"><a href="/2024/07/07/%E8%80%81%E7%8E%8B-11%E3%80%81MVC/" title=""><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/kilg0ur/picture/master/picture/cover6.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info"></div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/5.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">kilgour</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">35</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/kilg0ur"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">欢迎来到我的博客！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E9%A1%B9%E7%9B%AE%E5%A4%9A%E5%B1%82%E6%9E%B6%E6%9E%84%E6%90%AD%E5%BB%BA"><span class="toc-number">1.</span> <span class="toc-text">一、项目多层架构搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E9%A1%B9%E7%9B%AE%E7%8E%AF%E5%A2%83"><span class="toc-number">1.1.</span> <span class="toc-text">1、项目环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E5%AE%9E%E4%BD%93%E7%B1%BB%E5%88%9B%E5%BB%BA"><span class="toc-number">1.2.</span> <span class="toc-text">2、实体类创建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81DbContext%E6%90%AD%E5%BB%BA"><span class="toc-number">1.3.</span> <span class="toc-text">3、DbContext搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E6%95%B0%E6%8D%AE%E4%BB%93%E5%82%A8%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.4.</span> <span class="toc-text">4、数据仓储设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E4%BB%93%E5%82%A8%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.4.1.</span> <span class="toc-text">4.1   仓储接口设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E5%AE%9E%E7%8E%B0%E4%BB%93%E5%82%A8%E6%8E%A5%E5%8F%A31"><span class="toc-number">1.4.2.</span> <span class="toc-text">4.2 实现仓储接口1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E5%B7%A5%E4%BD%9C%E5%8D%95%E5%85%83%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.4.3.</span> <span class="toc-text">4.3 工作单元的实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-%E5%AE%9E%E7%8E%B0%E4%BB%93%E5%82%A8%E6%8E%A5%E5%8F%A32"><span class="toc-number">1.4.4.</span> <span class="toc-text">4.4  实现仓储接口2</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%E3%80%81%E6%9C%8D%E5%8A%A1%E5%B1%82%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.5.</span> <span class="toc-text">5、服务层设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.5.1.</span> <span class="toc-text">5.1 服务接口设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-%E5%AE%9E%E7%8E%B0%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%8F%A3"><span class="toc-number">1.5.2.</span> <span class="toc-text">5.2  实现服务接口</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6%E3%80%81%E9%85%8D%E7%BD%AE%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5"><span class="toc-number">1.6.</span> <span class="toc-text">6、配置依赖注入</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-%E5%9F%BA%E6%9C%AC%E6%B3%A8%E5%85%A5%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.6.1.</span> <span class="toc-text">6.1  基本注入实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-%E9%80%9A%E8%BF%87Autofac%E6%9D%A5%E5%AE%9E%E7%8E%B0%E6%B3%A8%E5%85%A5"><span class="toc-number">1.6.2.</span> <span class="toc-text">6.2 通过Autofac来实现注入</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7%E3%80%81AutoMapper%E6%90%AD%E5%BB%BA"><span class="toc-number">1.7.</span> <span class="toc-text">7、AutoMapper搭建</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86"><span class="toc-number">2.</span> <span class="toc-text">二、用户管理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E5%B1%95%E7%A4%BA%E7%94%A8%E6%88%B7%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF"><span class="toc-number">2.1.</span> <span class="toc-text">1、展示用户基本信息</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E5%A4%84%E7%90%86%E6%80%A7%E5%88%AB"><span class="toc-number">2.1.1.</span> <span class="toc-text">1.1  处理性别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E5%A4%B4%E5%83%8F%E5%A4%84%E7%90%86"><span class="toc-number">2.1.2.</span> <span class="toc-text">1.2 头像处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E5%88%86%E9%A1%B5%E5%B1%95%E7%A4%BA%E6%95%B0%E6%8D%AE"><span class="toc-number">2.1.3.</span> <span class="toc-text">1.3 分页展示数据</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%E6%90%9C%E7%B4%A2"><span class="toc-number">2.2.</span> <span class="toc-text">2、用户信息搜索</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E5%88%A0%E9%99%A4%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF"><span class="toc-number">2.3.</span> <span class="toc-text">3、删除用户信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E6%89%B9%E9%87%8F%E5%88%A0%E9%99%A4%E7%94%A8%E6%88%B7"><span class="toc-number">2.4.</span> <span class="toc-text">4、批量删除用户</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%E3%80%81%E6%96%B0%E5%A2%9E%E7%94%A8%E6%88%B71"><span class="toc-number">2.5.</span> <span class="toc-text">5、新增用户1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6%E3%80%81%E7%94%A8%E6%88%B7%E5%A4%B4%E5%83%8F%E4%B8%8A%E4%BC%A0"><span class="toc-number">2.6.</span> <span class="toc-text">6、用户头像上传</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7%E3%80%81%E5%AE%8C%E6%88%90%E6%96%B0%E5%A2%9E%E7%94%A8%E6%88%B7%E6%93%8D%E4%BD%9C"><span class="toc-number">2.7.</span> <span class="toc-text">7、完成新增用户操作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8%E3%80%81%E7%BC%96%E8%BE%91%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF"><span class="toc-number">2.8.</span> <span class="toc-text">8、编辑用户信息</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-%E5%B1%95%E7%A4%BA%E7%BC%96%E8%BE%91%E7%9A%84%E4%BF%A1%E6%81%AF"><span class="toc-number">2.8.1.</span> <span class="toc-text">8.1 展示编辑的信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-%E5%AE%8C%E6%88%90%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%E7%BC%96%E8%BE%91"><span class="toc-number">2.8.2.</span> <span class="toc-text">8.2  完成用户信息编辑</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9%E3%80%81%E9%A6%96%E9%A1%B5%E5%B8%83%E5%B1%80"><span class="toc-number">2.9.</span> <span class="toc-text">9、首页布局</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E6%96%87%E7%AB%A0%E7%AE%A1%E7%90%86"><span class="toc-number">3.</span> <span class="toc-text">三、文章管理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E6%A8%A1%E5%9E%8B%E8%AE%BE%E8%AE%A1"><span class="toc-number">3.1.</span> <span class="toc-text">1、模型设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E6%96%87%E7%AB%A0%E5%B1%95%E7%A4%BA%E5%B8%83%E5%B1%80"><span class="toc-number">3.2.</span> <span class="toc-text">2、文章展示布局</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E6%B7%BB%E5%8A%A0%E6%96%87%E7%AB%A0%E8%A7%86%E5%9B%BE"><span class="toc-number">3.3.</span> <span class="toc-text">3、添加文章视图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E5%B9%B6%E6%B7%BB%E5%8A%A0%E5%88%B0%E5%AF%8C%E6%96%87%E6%9C%AC%E7%BC%96%E8%BE%91%E5%99%A8%E4%B8%AD%E3%80%82"><span class="toc-number">3.4.</span> <span class="toc-text">4、上传图片并添加到富文本编辑器中。</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%E3%80%81%E6%B7%BB%E5%8A%A0%E6%B0%B4%E5%8D%B0"><span class="toc-number">3.5.</span> <span class="toc-text">5、添加水印</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6%E3%80%81%E5%8A%A0%E8%BD%BD%E6%96%87%E7%AB%A0%E5%88%86%E7%B1%BB"><span class="toc-number">3.6.</span> <span class="toc-text">6、加载文章分类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7%E3%80%81%E9%A1%B5%E9%9D%A2%E9%9D%99%E6%80%81%E5%8C%96"><span class="toc-number">3.7.</span> <span class="toc-text">7、页面静态化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8%E3%80%81%E5%AE%8C%E6%88%90%E6%96%87%E7%AB%A0%E4%BF%A1%E6%81%AF%E7%9A%84%E5%AD%98%E5%82%A8"><span class="toc-number">3.8.</span> <span class="toc-text">8、完成文章信息的存储</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9%E3%80%81%E6%95%8F%E6%84%9F%E8%AF%8D%E8%BF%87%E6%BB%A4"><span class="toc-number">3.9.</span> <span class="toc-text">9、敏感词过滤</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10%E3%80%81%E7%BD%91%E7%AB%99%E5%8F%91%E5%B8%83"><span class="toc-number">3.10.</span> <span class="toc-text">10、网站发布</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2025 By kilgour</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">2</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --><script data-pjax>
  function butterfly_footer_beautify_injector_config(){
    var parent_div_git = document.getElementById('footer-wrap');
    var item_html = '<div id="workboard"></div>';
    console.log('已挂载butterfly_footer_beautify')
    parent_div_git.insertAdjacentHTML("beforeend",item_html)
    }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_footer_beautify_injector_config();
  }
  else if (epage === cpage){
    butterfly_footer_beautify_injector_config();
  }
  </script><script async src="/js/runtime.js"></script><!-- hexo injector body_end end --></body></html>