<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Kilgour Notes | Kilgour Notes</title><meta name="author" content="kilgour"><meta name="copyright" content="kilgour"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="人力资源管理项目一、前端项目搭建1、搭建项目前的一些基本准备前端使用的是Vue3框架，所以开始先使用Vue脚手架来创建前端的项目。 确保在电脑中安装了对应的脚手架vue&#x2F;cli 1npm install -g @vue&#x2F;cli  当然，首先必须在电脑中安装node.js环境 查看node 和 npm的版本 12$ node -v #查看node版本$ npm  -v #查看npm版本  **npm">
<meta property="og:type" content="article">
<meta property="og:title" content="Kilgour Notes">
<meta property="og:url" content="http://www.kilgour.top/2024/08/02/%E8%80%81%E7%8E%8B-20%E3%80%81%E4%BA%BA%E5%8A%9B%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E9%A1%B9%E7%9B%AE/index.html">
<meta property="og:site_name" content="Kilgour Notes">
<meta property="og:description" content="人力资源管理项目一、前端项目搭建1、搭建项目前的一些基本准备前端使用的是Vue3框架，所以开始先使用Vue脚手架来创建前端的项目。 确保在电脑中安装了对应的脚手架vue&#x2F;cli 1npm install -g @vue&#x2F;cli  当然，首先必须在电脑中安装node.js环境 查看node 和 npm的版本 12$ node -v #查看node版本$ npm  -v #查看npm版本  **npm">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/kilg0ur/picture/master/picture/cover8.jpg">
<meta property="article:published_time" content="2024-08-02T12:48:58.899Z">
<meta property="article:modified_time" content="2024-08-14T13:00:45.746Z">
<meta property="article:author" content="kilgour">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/kilg0ur/picture/master/picture/cover8.jpg"><link rel="shortcut icon" href="https://raw.githubusercontent.com/kilg0ur/picture/master/picture/logo.png"><link rel="canonical" href="http://www.kilgour.top/2024/08/02/%E8%80%81%E7%8E%8B-20%E3%80%81%E4%BA%BA%E5%8A%9B%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E9%A1%B9%E7%9B%AE/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":230},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"top-right"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Kilgour Notes',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-08-14 21:00:45'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/panarama.css" media="defer" onload="this.media='all'"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-footer-beautify@1.0.0/lib/runtime.css" media="print" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/5.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">35</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 列表</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> 图库</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://raw.githubusercontent.com/kilg0ur/picture/master/picture/cover8.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="Kilgour Notes"><img class="site-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/kilg0ur/picture/master/picture/logo.png"/><span class="site-name">Kilgour Notes</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 列表</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> 图库</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">无题</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-08-02T12:48:58.899Z" title="发表于 2024-08-02 20:48:58">2024-08-02</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-08-14T13:00:45.746Z" title="更新于 2024-08-14 21:00:45">2024-08-14</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">69.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>286分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="人力资源管理项目"><a href="#人力资源管理项目" class="headerlink" title="人力资源管理项目"></a>人力资源管理项目</h1><h2 id="一、前端项目搭建"><a href="#一、前端项目搭建" class="headerlink" title="一、前端项目搭建"></a>一、前端项目搭建</h2><h2 id="1、搭建项目前的一些基本准备"><a href="#1、搭建项目前的一些基本准备" class="headerlink" title="1、搭建项目前的一些基本准备"></a>1、搭建项目前的一些基本准备</h2><p>前端使用的是<code>Vue3</code>框架，所以开始先使用<code>Vue</code>脚手架来创建前端的项目。</p>
<p>确保在电脑中安装了对应的脚手架<code>vue/cli</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g @vue/cli</span><br></pre></td></tr></table></figure>

<p>当然，首先必须在电脑中安装<code>node.js</code>环境</p>
<p>查看<code>node</code> 和 <code>npm</code>的版本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ node -v #查看node版本</span><br><span class="line">$ npm  -v #查看npm版本</span><br></pre></td></tr></table></figure>

<p><strong><code>**npm</code>淘宝镜像</strong>**</p>
<p><code>npm</code>是非常重要的<code>npm</code>管理工具,由于<code>npm</code>的服务器位于国外, 所以一般建议 将 <code>npm</code>设置成国内的淘宝镜像</p>
<p>设置淘宝镜像</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ npm config set registry  https://registry.npm.taobao.org/  #设置淘宝镜像地址</span><br><span class="line">$ npm config get registry  #查看镜像地址</span><br></pre></td></tr></table></figure>

<h2 id="2、使用脚手架搭建Vue3开发环境"><a href="#2、使用脚手架搭建Vue3开发环境" class="headerlink" title="2、使用脚手架搭建Vue3开发环境"></a>2、使用脚手架搭建<code>Vue3</code>开发环境</h2><p>在指定的目录下面执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vue create 项目名称</span><br></pre></td></tr></table></figure>

<p>使用以上命令创建项目的时候，出现了如下错误</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vue : 无法加载文件 C:\XXX\AppData\Roaming\npm\vue.ps1，因为在此系统上禁止运行脚本。</span><br></pre></td></tr></table></figure>

<p>参考解决方案：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://blog.csdn.net/ying456baby/article/details/126379392</span><br></pre></td></tr></table></figure>

<p>第一：以管理身份启动命令窗口</p>
<p>第二：在终端窗口输入<code> **set-ExecutionPolicy RemoteSigned**</code></p>
<p> 输入命令查看 <code>**get-ExecutionPolicy**</code> 为 <code>“**RemoteSigned**”</code></p>
<p>项目创建的步骤如下</p>
<p>第一步：打开命令行窗口(以管理员身份)</p>
<p>第二步：在打开的命令行窗口中输入<code>vue create hr-front</code></p>
<p>第三步：选择自定义创建</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images%5C1.png"></p>
<p>第四：选中<code>vue-router</code>,<code>vuex</code>,<code>css Pre-processors</code>选项</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images%5C2.png"></p>
<p>第五步：选择<code>vue3.0</code>版本</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images%5C3.png"></p>
<p>第六步：选择<code>hash</code>模式的路由</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images%5C4.png"></p>
<p>第七步：选择<code>less</code>作为预处理器</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images%5C5.png"></p>
<p>第八步：选择 <code>standard </code>标准代码风格</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images%5C6.png"></p>
<p>第九步：保存代码校验代码风格，代码提交时候校验代码风格</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images%5C7.png"></p>
<p>第十步：依赖插件或者工具的配置文件分文件保存</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images%5C8.png"></p>
<p>第十一步：是否记录以上操作，选择否</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images%5C9.png"></p>
<p>第十二步：等待安装…</p>
<p>最后：安装完毕</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images%5C10.png"></p>
<p>这里可以<code>cd</code>到<code>hr-front</code>目录，然后通过执行<code>npm run serve</code>命令来启动项目</p>
<h2 id="3、API模块和请求封装模块介绍"><a href="#3、API模块和请求封装模块介绍" class="headerlink" title="3、API模块和请求封装模块介绍"></a>3、<code>API</code>模块和请求封装模块介绍</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i axios</span><br></pre></td></tr></table></figure>

<p>在<code>src</code>目录下面创建<code>utils</code>目录，在该目录下面创建<code>request.js</code>文件，该文件中的初步代码如下所示：</p>
<p>先创建<code>axios</code>的基本结构，后面在完善</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导出一个axios实例，这个实例中要求有请求拦截器与响应拦截器</span></span><br><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&#x27;axios&#x27;</span></span><br><span class="line"><span class="keyword">const</span> service = axios.<span class="title function_">create</span>(); <span class="comment">// 创建一个axios的实例</span></span><br><span class="line">service.<span class="property">interceptors</span>.<span class="property">request</span>.<span class="title function_">use</span>(); <span class="comment">// 请求拦截器</span></span><br><span class="line">service.<span class="property">interceptors</span>.<span class="property">response</span>.<span class="title function_">use</span>();<span class="comment">// 响应拦截器</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> service;</span><br></pre></td></tr></table></figure>

<p><strong><code>api</code>模块的单独封装</strong></p>
<p>我们习惯性的将所有的网络请求 放置在<code>api</code>目录下统一管理,按照模块进行划分</p>
<p>在<code>src</code>目录下面创建<code>api</code>目录，在该目录下面创建<code>user.js</code>文件，该文件中封装的就是获取用户信息，或者是对用户信息进行操作的<code>api</code>接口。</p>
<p>初步代码如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> request <span class="keyword">from</span> <span class="string">&quot;@/utils/request&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">login</span>(<span class="params">data</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getInfo</span>(<span class="params"></span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">logout</span>(<span class="params"></span>) &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>4、公共资源图片和统一样式</p>
<p>将文件夹拷贝到<code>assets</code>目录下面</p>
<p>在<code>src</code>目录下面创建<code>styles</code>目录，把样式都拷贝到该目录下面</p>
<p>5、修改网站名称</p>
<p>在<code>public/index.html</code>文件中，可以在<code>title</code>标签中看到如下的代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;title&gt;&lt;%= htmlWebpackPlugin.options.title %&gt;&lt;/title&gt;</span><br></pre></td></tr></table></figure>

<p>这里获取的是<code>webpack</code>中的<code>htmlWebpackPlugin</code>插件中配置的标题</p>
<p>默认情况下，项目显示的标题为项目路径对应的名称，下面介绍修改<code>htmlWebpackPlugin.options.title</code>对应的值。</p>
<p>修改项目中<code>vue.config.js</code>文件中的配置</p>
<p><strong><code>vue.config.js</code></strong> 就是<code>vue</code>项目相关的编译，配置，打包，启动服务相关的配置文件.</p>
<p>在文件中添加如下配置：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">lintOnSave</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">chainWebpack</span>: <span class="function">(<span class="params">config</span>) =&gt;</span> &#123;</span><br><span class="line">    config.<span class="title function_">plugin</span>(<span class="string">&quot;html&quot;</span>).<span class="title function_">tap</span>(<span class="function">(<span class="params">args</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">//  console.log(&quot;args===&quot;, args);</span></span><br><span class="line">        <span class="comment">// // args相当于 html模板中 htmlWebpackplugin.options</span></span><br><span class="line">      args[<span class="number">0</span>].<span class="property">title</span> = <span class="string">&quot;人力资源管理平台&quot;</span>; <span class="comment">// 这里修改了网站的标题</span></span><br><span class="line">      <span class="keyword">return</span> args;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>args</code>参数的值为</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">args=== [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&#x27;hr-front&#x27;</span>,</span><br><span class="line">    <span class="attr">templateParameters</span>: [<span class="title class_">Function</span>: templateParameters],</span><br><span class="line">    <span class="attr">template</span>: <span class="string">&#x27;index.html文件的路径&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>所以说<code>args</code>参数相当于<code>html</code>模板中的<code>htmlWebpackplugin.options</code>.</p>
<p><strong>配置完成后一定要重新启动项目。</strong></p>
<p>返回浏览器，查看标题。</p>
<p><strong>6、修改端口号</strong></p>
<p>项目启动以后，对应的端口号是<code>8080</code></p>
<p>如果想修改默认的端口号应该怎样处理呢？</p>
<p>在项目的<strong>根目录</strong>下面创建两个文件：</p>
<p>分别是<code>.env.development</code>,<code>.env.production</code> </p>
<p><code>development</code> &#x3D;&gt; 开发环境</p>
<p><code>production</code> &#x3D;&gt; 生产环境</p>
<p>当我们运行**<code>npm run serve</code><strong>进行开发调试的时候,此时会加载执行</strong><code>.env.development</code>**文件内容</p>
<p>当我们运行**<code>npm run build</code><strong>进行生产环境打包的时候,会加载执行</strong><code>.env.production</code>**文件内容</p>
<p>所以,如果想要设置开发环境的接口,直接在**<code>.env.development</code>**中写入对于port变量的赋值即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 设置端口号</span><br><span class="line">port = 8888</span><br></pre></td></tr></table></figure>

<p>问题是怎样获取该变量的值？</p>
<p>下面继续修改<code>vue.config.js</code>文件中的配置</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> port = process.<span class="property">env</span>.<span class="property">port</span> || <span class="number">8080</span>;</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">lintOnSave</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">chainWebpack</span>: <span class="function">(<span class="params">config</span>) =&gt;</span> &#123;</span><br><span class="line">    config.<span class="title function_">plugin</span>(<span class="string">&quot;html&quot;</span>).<span class="title function_">tap</span>(<span class="function">(<span class="params">args</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// console.log(&quot;args===&quot;, args);</span></span><br><span class="line">      args[<span class="number">0</span>].<span class="property">title</span> = <span class="string">&quot;人力资源管理平台&quot;</span>;</span><br><span class="line">      <span class="keyword">return</span> args;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">devServer</span>: &#123;</span><br><span class="line">    <span class="attr">port</span>: port, <span class="comment">// port:8888    8666</span></span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里首先通过<code>process.env.port</code>获取到<code>.env.development</code>文件中所定义的<code>port</code>变量值。</p>
<p>然后把该变量的值赋值给<code>devServer</code>配置项中的<code>port</code>属性。</p>
<p><strong>重新启动项目。</strong></p>
<h2 id="二、登录模块"><a href="#二、登录模块" class="headerlink" title="二、登录模块"></a>二、登录模块</h2><h3 id="1、登录布局实现"><a href="#1、登录布局实现" class="headerlink" title="1、登录布局实现"></a>1、登录布局实现</h3><p>这里我们会使用<code>Element Plus</code>组件来实现登录界面布局。</p>
<p><code>https://element-plus.gitee.io/zh-CN/</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install element-plus --save</span><br></pre></td></tr></table></figure>

<p>安装好以后，在项目中使用<code>Element Plus</code>组件，这里需要按需导入：</p>
<p><code>https://element-plus.gitee.io/zh-CN/guide/quickstart.html#%E6%8C%89%E9%9C%80%E5%AF%BC%E5%85%A5</code></p>
<p>修改<code>vue.config.js</code>这个配置文件，实现组件的按需导入</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">AutoImport</span> = <span class="built_in">require</span>(<span class="string">&quot;unplugin-auto-import/webpack&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Components</span> = <span class="built_in">require</span>(<span class="string">&quot;unplugin-vue-components/webpack&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">ElementPlusResolver</span> &#125; = <span class="built_in">require</span>(<span class="string">&quot;unplugin-vue-components/resolvers&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; defineConfig &#125; = <span class="built_in">require</span>(<span class="string">&#x27;@vue/cli-service&#x27;</span>)</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="attr">transpileDependencies</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">lintOnSave</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">chainWebpack</span>: <span class="function">(<span class="params">config</span>) =&gt;</span> &#123;</span><br><span class="line">    config.<span class="title function_">plugin</span>(<span class="string">&quot;html&quot;</span>).<span class="title function_">tap</span>(<span class="function">(<span class="params">args</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">//  console.log(&quot;args===&quot;, args);</span></span><br><span class="line">        <span class="comment">// // args相当于 html模板中 htmlWebpackplugin.options</span></span><br><span class="line">      args[<span class="number">0</span>].<span class="property">title</span> = <span class="string">&quot;人力资源管理平台&quot;</span>; <span class="comment">// 这里修改了网站的标题</span></span><br><span class="line">      <span class="keyword">return</span> args;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">   <span class="comment">// 实现Element Plus组件的按需导入</span></span><br><span class="line">    <span class="comment">// configureWebpack中指定的属性与webpack中的属性完全一致，最后会进行合并</span></span><br><span class="line">    <span class="attr">configureWebpack</span>: &#123;</span><br><span class="line">      <span class="attr">plugins</span>: [</span><br><span class="line">        <span class="title class_">AutoImport</span>(&#123;</span><br><span class="line">          <span class="attr">resolvers</span>: [<span class="title class_">ElementPlusResolver</span>()],</span><br><span class="line">        &#125;),</span><br><span class="line">        <span class="title class_">Components</span>(&#123;</span><br><span class="line">          <span class="attr">resolvers</span>: [<span class="title class_">ElementPlusResolver</span>()],</span><br><span class="line">        &#125;),</span><br><span class="line">      ],</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>这里你需要安装<code>unplugin-vue-components</code> 和 <code>unplugin-auto-import</code>这两款插件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -D unplugin-vue-components unplugin-auto-import</span><br></pre></td></tr></table></figure>

<p>下面进行测试：在<code>views</code>目录下面创建<code>login</code>目录，在该目录下面创建<code>index.vue</code>组件，该组件中的初步代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;el-button&gt;按钮&lt;/el-button&gt;</span><br><span class="line">    hello world</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>

<p>在模板中直接使用了按钮组件。</p>
<p>这里还需要配置一下路由：</p>
<p>修改<code>src/router/index.js</code>文件中的代码，添加如下路由规则</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">const</span> routes = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&quot;/&quot;</span>,</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;Home&quot;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="title class_">Home</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&quot;/login&quot;</span>,</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;Login&quot;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&quot;@/views/login/index.vue&quot;</span>),</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>

<p>在上面添加了登录的路由规则。</p>
<p>由于修改了配置文件，<strong>需要重新启动项目</strong></p>
<p><code>http://localhost:8080/#/login</code> 进行访问</p>
<p>下面进行布局：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;login-container&quot;&gt;</span><br><span class="line">    &lt;el-form class=&quot;login-form&quot;&gt;</span><br><span class="line">      &lt;div class=&quot;title-container&quot;&gt;</span><br><span class="line">        &lt;h3 class=&quot;title&quot;&gt;</span><br><span class="line">          &lt;!-- &lt;img src=&quot;@/assets/common/login-logo.png&quot; alt=&quot;&quot; /&gt; --&gt;</span><br><span class="line">        &lt;/h3&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">      &lt;el-form-item&gt;</span><br><span class="line">        &lt;el-input placeholder=&quot;请输入手机号&quot; type=&quot;text&quot; v-model=&quot;mobile&quot; tabindex=&quot;1&quot; /&gt;</span><br><span class="line">      &lt;/el-form-item&gt;</span><br><span class="line"></span><br><span class="line">      &lt;el-form-item&gt;</span><br><span class="line">        &lt;el-input placeholder=&quot;请输入密码&quot; name=&quot;password&quot; type=&quot;password&quot; tabindex=&quot;2&quot; v-model=&quot;password&quot; /&gt;</span><br><span class="line">      &lt;/el-form-item&gt;</span><br><span class="line"></span><br><span class="line">      &lt;el-button class=&quot;loginBtn&quot; type=&quot;primary&quot; style=&quot;width: 100%; margin-bottom: 30px&quot; @click=&quot;submit&quot;&gt;登录&lt;/el-button&gt;</span><br><span class="line">      &lt;div class=&quot;tips&quot;&gt;</span><br><span class="line">        &lt;span style=&quot;margin-right: 20px&quot;&gt;账号: 13811111111&lt;/span&gt;</span><br><span class="line">        &lt;span&gt; 密码: 123&lt;/span&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/el-form&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">import &#123; ref &#125; from &quot;vue&quot;;</span><br><span class="line">export default &#123;</span><br><span class="line">  name: &quot;Login&quot;,</span><br><span class="line">  setup() &#123;</span><br><span class="line">    const mobile = ref(&quot;&quot;);</span><br><span class="line">    const password = ref(&quot;&quot;);</span><br><span class="line">    const submit = () =&gt; &#123;</span><br><span class="line">      console.log(mobile.value + &quot; &quot; + password.value);</span><br><span class="line">    &#125;;</span><br><span class="line">    return &#123;</span><br><span class="line">      mobile,</span><br><span class="line">      password,</span><br><span class="line">      submit,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">  </span><br><span class="line">&lt;style lang=&quot;scss&quot; scoped&gt;</span><br><span class="line">$bg: #2d3a4b;</span><br><span class="line">$dark_gray: #889aa4;</span><br><span class="line">$light_gray: #eee;</span><br><span class="line"></span><br><span class="line">.login-container &#123;</span><br><span class="line">  min-height: 100%;</span><br><span class="line">  width: 100%;</span><br><span class="line">  background-color: $bg;</span><br><span class="line">  overflow: hidden;</span><br><span class="line">  background-image: url(&quot;~@/assets/common/login.jpg&quot;); // 设置背景图片，注意：如需要在样式表中使用**`@`**别名的时候，需要在@前面加上一个**`~`**符号，否则不识别</span><br><span class="line">  background-position: center; // 将图片位置设置为充满整个屏幕</span><br><span class="line"></span><br><span class="line">  .login-form &#123;</span><br><span class="line">    position: relative;</span><br><span class="line">    width: 520px;</span><br><span class="line">    max-width: 100%;</span><br><span class="line">    padding: 160px 35px 0;</span><br><span class="line">    margin: 0 auto;</span><br><span class="line">    overflow: hidden;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  .el-form-item &#123;</span><br><span class="line">    border: 1px solid rgba(255, 255, 255, 0.1);</span><br><span class="line">    background: rgba(255, 255, 255, 0.7); // 输入登录表单的背景色</span><br><span class="line">    border-radius: 5px;</span><br><span class="line">    color: #454545;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  .el-form-item__error &#123;</span><br><span class="line">    color: #fff;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  .loginBtn &#123;</span><br><span class="line">    background: #407ffe;</span><br><span class="line">    height: 64px;</span><br><span class="line">    line-height: 32px;</span><br><span class="line">    font-size: 24px;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  .tips &#123;</span><br><span class="line">    font-size: 14px;</span><br><span class="line">    color: #fff;</span><br><span class="line">    margin-bottom: 10px;</span><br><span class="line"></span><br><span class="line">    span &#123;</span><br><span class="line">      &amp;:first-of-type &#123;</span><br><span class="line">        margin-right: 16px;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  .title-container &#123;</span><br><span class="line">    position: relative;</span><br><span class="line"></span><br><span class="line">    .title &#123;</span><br><span class="line">      font-size: 26px;</span><br><span class="line">      color: $light_gray;</span><br><span class="line">      margin: 0px auto 40px auto;</span><br><span class="line">      text-align: center;</span><br><span class="line">      font-weight: bold;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  .show-pwd &#123;</span><br><span class="line">    position: absolute;</span><br><span class="line">    right: 10px;</span><br><span class="line">    top: 7px;</span><br><span class="line">    font-size: 16px;</span><br><span class="line">    color: $dark_gray;</span><br><span class="line">    cursor: pointer;</span><br><span class="line">    user-select: none;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">  </span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Failed to resolve loader: sass-loader</span><br><span class="line">Can&#x27;t resolve &#x27;sass-loader&#x27;</span><br></pre></td></tr></table></figure>

<p>编译项目的时候，会出现如上的错误，原因：我们使用的是<code>sass</code>来编写样式，当时我们使用脚手架搭建项目的时候，使用的是<code>less</code>.</p>
<p>所以我们现在搭建的项目无法处理<code>sass</code>。这里需要安装<code>sass-loader</code>这个包来进行处理。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm i sass</span><br><span class="line"> npm i sass-loader</span><br></pre></td></tr></table></figure>



<p>在上面的代码中，完成了表单的布局。（注意：如需要在样式表中使用**<code>@</code><strong>别名的时候，需要在@前面加上一个</strong><code>~</code>**符号，否则不识别）</p>
<p>同时文本框通过<code>v-model</code>进行了双向绑定。</p>
<p>在<code>setup</code>入口函数中，通过<code>ref</code>创建响应式对象，由于与文本框进行了双向绑定，所以在单击登录按钮的时候，在所触发的方法中可以获取到文本框中的值。</p>
<p>返回到浏览器中进行测试。</p>
<p>当然我们也可以按照文档中的使用方式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">import &#123; reactive &#125; from &quot;vue&quot;;</span><br><span class="line">export default &#123;</span><br><span class="line">  name: &quot;Login&quot;,</span><br><span class="line">  setup() &#123;</span><br><span class="line">    const ruleForm = reactive(&#123;</span><br><span class="line">      mobile: &quot;&quot;,</span><br><span class="line">      password: &quot;&quot;,</span><br><span class="line">    &#125;);</span><br><span class="line">    const submit = () =&gt; &#123;</span><br><span class="line">      console.log(ruleForm.mobile + &quot;....&quot; + ruleForm.password); // 打印在文本框与密码框中输入的内容</span><br><span class="line">    &#125;;</span><br><span class="line">    return &#123;</span><br><span class="line">      submit,</span><br><span class="line">      ruleForm, // 注意：这里将响应式对象返回到模版中，模版中才会使用</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>通过<code>reactive</code>创建一个响应式对象，让后返回到模板中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-form class=&quot;login-form&quot; :model=&quot;ruleForm&quot;&gt;</span><br></pre></td></tr></table></figure>

<p>将<code>ruleForm</code>与<code>el-form</code>中的<code>model</code>进行关联。</p>
<p><code>model</code>是<code>el-form</code>表单提供的属性,含义是：表单数据对象</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-input</span><br><span class="line">         placeholder=&quot;请输入手机号&quot;</span><br><span class="line">         type=&quot;text&quot;</span><br><span class="line">         v-model=&quot;ruleForm.mobile&quot;</span><br><span class="line">         tabindex=&quot;1&quot;</span><br><span class="line">       /&gt;</span><br><span class="line">&lt;el-input</span><br><span class="line">         placeholder=&quot;请输入密码&quot;</span><br><span class="line">         name=&quot;password&quot;</span><br><span class="line">         type=&quot;password&quot;</span><br><span class="line">         tabindex=&quot;2&quot;</span><br><span class="line">         v-model=&quot;ruleForm.password&quot;</span><br><span class="line">       /&gt;</span><br></pre></td></tr></table></figure>

<p>通过<code>v-model</code>与<code>ruleForm</code>中的属性进行了双向绑定</p>
<p>返回浏览器中进行测试</p>
<p>官方文档案例：<code>https://element-plus.gitee.io/zh-CN/component/form.html#%E8%A1%A8%E5%8D%95%E6%A0%A1%E9%AA%8C</code></p>
<h3 id="2、表单校验"><a href="#2、表单校验" class="headerlink" title="2、表单校验"></a>2、表单校验</h3><p>关于对手机号码的正则表达式的校验，单独的封装到了一个<code>js</code>文件中。</p>
<p>在<code>utils</code>目录下面创建<code>validate.js</code>文件，该文件中的代码如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  校验手机号</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">validMobile</span>(<span class="params">str</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="regexp">/^1[3-9]\d&#123;9&#125;$/</span>.<span class="title function_">test</span>(str);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回到<code>views/login/index.vue</code>文件中继续修改代码，如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">import &#123; reactive &#125; from &quot;vue&quot;;</span><br><span class="line">import &#123; validMobile &#125; from &#x27;@/utils/validate&#x27; // 导入validMobile</span><br><span class="line">export default &#123;</span><br><span class="line">  name: &quot;Login&quot;,</span><br><span class="line">  setup() &#123;</span><br><span class="line">    const ruleForm =reactive(&#123;</span><br><span class="line">        mobile:&quot;&quot;,</span><br><span class="line">        password:&quot;&quot;</span><br><span class="line">    &#125;);</span><br><span class="line">    // 手机号码的验证：</span><br><span class="line">    const validateMobile =(rule,value,callback)=&gt;&#123;</span><br><span class="line">      console.log(&#x27;rule =&#x27;,rule);</span><br><span class="line">      console.log(&quot;value = &quot;,value);</span><br><span class="line">      console.log(&quot;callback = &quot;,callback);</span><br><span class="line">        // 调用所导入的validMobile这个函数，对传递过来的手机号进行校验</span><br><span class="line">      validMobile(value)?callback():callback(new Error(&quot;手机号码错误&quot;));</span><br><span class="line">    &#125;</span><br><span class="line">    // 定义校验的规则</span><br><span class="line">    const loginRules =reactive(&#123;</span><br><span class="line">      mobile:[&#123;</span><br><span class="line">        required:true,</span><br><span class="line">        message:&#x27;请输入手机号码&#x27;,</span><br><span class="line">        trigger:&quot;blur&quot;</span><br><span class="line">      &#125;,&#123;</span><br><span class="line">        trigger:&quot;blur&quot;,</span><br><span class="line">         validator:  validateMobile // 当手机号文本框失去焦点以后，会自动调用validateMobile这个函数。</span><br><span class="line">      &#125;],</span><br><span class="line">      password:[&#123;</span><br><span class="line">        required:true,</span><br><span class="line">        message:&#x27;请输入密码&#x27;,</span><br><span class="line">        trigger:&quot;blur&quot;</span><br><span class="line">      &#125;,&#123;</span><br><span class="line">        min:6,</span><br><span class="line">        max:16,</span><br><span class="line">        message:&#x27;密码的长度在6-16位之间&#x27;,</span><br><span class="line">        trigger:&quot;blur&quot;</span><br><span class="line">      &#125;]</span><br><span class="line">    &#125;);</span><br><span class="line">    const submit = () =&gt; &#123;</span><br><span class="line">      console.log(ruleForm.mobile + &quot; &quot; + ruleForm.password);</span><br><span class="line">    &#125;;</span><br><span class="line">    return &#123;</span><br><span class="line">      ruleForm,</span><br><span class="line">      submit,</span><br><span class="line">      loginRules // 返回定义的校验规则</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>在上面的代码中，先将<code>validMobile</code>方法导入进来。</p>
<p>定义了校验的响应式对象<code>loginRules</code> ,并且返回</p>
<p>在该对象中定义了校验规则，<strong>注意<code>mobile</code>和<code>password</code> 一定要与<code>el-form-item</code>中的<code>prop</code>属性保持一致，校验才会起作用。</strong></p>
<p>在校验手机号码的时候，要求必填，同时指定了<code>validator</code>属性，在失去焦点后，会执行<code>validator</code>属性对应的<code>validateMobile</code>方法，</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 手机号码的验证：</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">validateMobile</span> =(<span class="params">rule,value,callback</span>)=&gt;&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;rule =&#x27;</span>,rule);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;value = &quot;</span>,value);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;callback = &quot;</span>,callback);</span><br><span class="line">    <span class="comment">// 调用所导入的validMobile这个函数，对传递过来的手机号进行校验</span></span><br><span class="line">  <span class="title function_">validMobile</span>(value)?<span class="title function_">callback</span>():<span class="title function_">callback</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;手机号码错误&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>validateMobile </code>方法有三个参数，第一个参数：表示校验的规则，第二个参数，用户输入的手机号码，第三个参数<code>callback</code>是一个函数。</p>
<p>在<code>validateMobile </code>方法内部，调用<code>validMobile</code>方法校验手机号码，如果通过校验了，调用<code>callback</code>函数，如果没有通过校验，也会调用<code>callback</code>函数，只不过会传递错误对象。</p>
<p>模板中的代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-form class=&quot;login-form&quot; :model=&quot;ruleForm&quot; :rules=&quot;loginRules&quot;&gt;</span><br></pre></td></tr></table></figure>

<p>这里将定义的规则对象与<code>el-form</code>组件中的<code>rules</code>属性关联在一起。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-form-item prop =&quot;mobile&quot;&gt;</span><br><span class="line">       &lt;el-input placeholder=&quot;请输入手机号&quot; type=&quot;text&quot; v-model=&quot;ruleForm.mobile&quot; tabindex=&quot;1&quot; /&gt;</span><br><span class="line">     &lt;/el-form-item&gt;</span><br><span class="line"></span><br><span class="line">     &lt;el-form-item prop =&quot;password&quot;&gt;</span><br><span class="line">       &lt;el-input placeholder=&quot;请输入密码&quot; name=&quot;password&quot; type=&quot;password&quot; tabindex=&quot;2&quot; v-model=&quot;ruleForm.password&quot; /&gt;</span><br><span class="line">     &lt;/el-form-item&gt;</span><br></pre></td></tr></table></figure>

<p>注意:<code>el-form-item</code>中的<code>prop</code>属性一定要与校验规则对象<code>loginRules</code>中定义的属性保持一致，校验才起作用。</p>
<p>返回浏览器中进行测试。</p>
<p><strong>修饰符</strong></p>
<p>这里还有一个小问题就是，用户一般都是输入完密码以后，按下回车键，就可以发送请求，也就是相当于单击了<code>登录</code>按钮。</p>
<p>要想实现这样的效果，需要用到修饰符</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://cn.vuejs.org/guide/essentials/event-handling.html#event-modifiers</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-input placeholder=&quot;请输入密码&quot; name=&quot;password&quot; type=&quot;password&quot; tabindex=&quot;2&quot; v-model=&quot;ruleForm.password&quot; @keyup.enter=&quot;submit&quot;/&gt;</span><br></pre></td></tr></table></figure>

<p>在上面的代码中添加了<code>@keyup.enter</code>修饰符</p>
<p>输入完密码，按下回车键，也要调用<code>submit</code>方法。</p>
<p>返回到浏览器中进行测试,在浏览器的控制台中查看输入的结果。</p>
<p>这里有一个小的问题，当在密码框中输入完内容以后，按下回车键会调用<code>submit</code>打印所输入的手机号码与密码。</p>
<p>但是，如果密码没有按照上面定义的验证规则进行输入，按下回车键以后，也会打印出来，这样就不行了，而这种情况应该</p>
<p>给出相应的错误提示。也就是说，在按下了登录按钮把用户在表单中所输入的内容发送到服务端之前，也需要进行校验</p>
<p>这里也是参考<code>element-ui</code>文档中的校验方式</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; reactive,ref &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>; <span class="comment">// 导入ref</span></span><br><span class="line"><span class="keyword">import</span> &#123; validMobile &#125; <span class="keyword">from</span> <span class="string">&#x27;@/utils/validate&#x27;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;Login&quot;</span>,</span><br><span class="line">  <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> ruleForm =<span class="title function_">reactive</span>(&#123;</span><br><span class="line">        <span class="attr">mobile</span>:<span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="attr">password</span>:<span class="string">&quot;&quot;</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">const</span> ruleFormRef=<span class="title function_">ref</span>(); <span class="comment">// 这里创建了一个ref对象ruleFormRef</span></span><br></pre></td></tr></table></figure>

<p>上面的代码中，我们创建了一个<code>ruleFormRef</code>对象，创建该对象的目的就是与<code>form</code>表单进行关联，通过该对象获取<code>form</code>表单，完成校验。</p>
<p>所以这里需要将<code>ruleFormRef</code>这个对象返回</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">     ruleForm,</span><br><span class="line">     submit,</span><br><span class="line">     loginRules,</span><br><span class="line">     ruleFormRef <span class="comment">// 将ruleFormRef对象返回</span></span><br><span class="line">   &#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-form class=&quot;login-form&quot; :model=&quot;ruleForm&quot; :rules=&quot;loginRules&quot; ref=&quot;ruleFormRef&quot;&gt;</span><br></pre></td></tr></table></figure>

<p>给<code>el-form</code>这个表单组件，添加<code>ref</code>属性与<code>ruleFormRef</code>进行关联。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-input placeholder=&quot;请输入密码&quot; name=&quot;password&quot; type=&quot;password&quot; tabindex=&quot;2&quot; v-model=&quot;ruleForm.password&quot; @keyup.enter=&quot;submit(ruleFormRef)&quot;/&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;el-button class=&quot;loginBtn&quot; type=&quot;primary&quot; style=&quot;width: 100%; margin-bottom: 30px&quot; @click=&quot;submit(ruleFormRef)&quot;&gt;登录&lt;/el-button&gt;</span><br></pre></td></tr></table></figure>

<p>不管是在按下回车键的时候，还是单击<code>登录</code>按钮的时候，都把<code>ruleFormRef</code>这个对象，传递到<code>submit</code>方法中。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 进行表单的提交</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">submit</span> = (<span class="params">loginForm</span>) =&gt; &#123; <span class="comment">// ----接收表单</span></span><br><span class="line">       <span class="comment">// 调用validate方法进行校验</span></span><br><span class="line">     loginForm.<span class="title function_">validate</span>(<span class="function">(<span class="params">valid</span>)=&gt;</span>&#123;</span><br><span class="line">         <span class="comment">// 校验通过valid这个参数的值就是true,否则就是false</span></span><br><span class="line">      <span class="keyword">if</span>(valid)&#123;</span><br><span class="line">          <span class="comment">// 打印用户输入的手机号与密码(这里把手机号码的空格去掉了)</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(ruleForm.<span class="property">mobile</span>.<span class="title function_">trim</span>() + <span class="string">&quot; &quot;</span> + ruleForm.<span class="property">password</span>);    </span><br><span class="line">      &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">          <span class="comment">// 如果出错了给出错误的提示</span></span><br><span class="line">        <span class="title class_">ElMessageBox</span>.<span class="title function_">alert</span>(<span class="string">&quot;密码没有通过验证!&quot;</span>,<span class="string">&quot;数据校验&quot;</span>,&#123;</span><br><span class="line">          <span class="attr">confirmButtonText</span>:<span class="string">&quot;OK&quot;</span></span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    )</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>

<p>在<code>submit</code>这个方法中，接收传递过来的<code>ruleFormRef</code>对象，也就是<code>form</code>表单，然后进行校验。</p>
<p>启动项目进行测试。</p>
<h3 id="3、服务端环境搭建"><a href="#3、服务端环境搭建" class="headerlink" title="3、服务端环境搭建"></a>3、服务端环境搭建</h3><p>这里的服务端架构还是以前的架构设计。</p>
<p>这里首先修改一下数据库链接字符串<code>appsettings.json</code>和<code>MyDbContextDesign.cs</code>两个文件中的字符串都需要修改</p>
<p>第二点：创建一个<code>WebApi</code>项目，并且添加如下的包</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;PackageReference Include=&quot;Microsoft.AspNetCore.OpenApi&quot; Version=&quot;7.0.3&quot; /&gt;</span><br><span class="line">   &lt;PackageReference Include=&quot;Swashbuckle.AspNetCore&quot; Version=&quot;6.4.0&quot; /&gt;</span><br><span class="line">  &lt;PackageReference Include=&quot;AutoMapper.Extensions.Microsoft.DependencyInjection&quot; Version=&quot;12.0.0&quot; /&gt;</span><br><span class="line">  &lt;PackageReference Include=&quot;Microsoft.EntityFrameworkCore.Design&quot; Version=&quot;7.0.4&quot;&gt;</span><br><span class="line">	  &lt;PrivateAssets&gt;all&lt;/PrivateAssets&gt;</span><br><span class="line">	  &lt;IncludeAssets&gt;runtime; build; native; contentfiles; analyzers; buildtransitive&lt;/IncludeAssets&gt;</span><br><span class="line">  &lt;/PackageReference&gt;</span><br><span class="line">  &lt;PackageReference Include=&quot;Autofac&quot; Version=&quot;7.0.0&quot; /&gt;</span><br><span class="line">  &lt;PackageReference Include=&quot;Autofac.Extensions.DependencyInjection&quot; Version=&quot;8.0.0&quot; /&gt;</span><br></pre></td></tr></table></figure>

<p>第三点：把<code>Attributes,AutofaceDI,Filters</code>三个文件夹都拷贝到<code>WebApi</code>项目中，并且修改这些文件夹中所有类的命名空间。</p>
<p>第四点：在<code>Program.cs</code>文件中完成相应的注册操作</p>
<h3 id="4、服务端登录接口开发"><a href="#4、服务端登录接口开发" class="headerlink" title="4、服务端登录接口开发"></a>4、服务端登录接口开发</h3><p>创建一个<code>login</code>控制器</p>
<p>并且在<code>WebApi</code>项目中，安装<code>Jwt</code>所需要的包</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Install-Package  Microsoft.AspNetCore.Authentication.JwtBearer</span><br></pre></td></tr></table></figure>

<p>这里为了简化项目的复杂度，我们不再创建<code>DTO</code>数据传输对象，大家在做的时候，可以根据情况自行添加</p>
<p>针对登录，很难创建一个标注的<code>Restful</code>的接口，但是我们前面也已经讲解过，不用为了<code>Restful</code>而<code>Restful</code>。</p>
<p>这里创建一个<code>LoginController.cs</code>控制器，该控制器中的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Cms.Entity;</span><br><span class="line"><span class="keyword">using</span> Cms.IService;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Http;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"><span class="keyword">using</span> Microsoft.EntityFrameworkCore;</span><br><span class="line"><span class="keyword">using</span> Microsoft.IdentityModel.Tokens;</span><br><span class="line"><span class="keyword">using</span> System.IdentityModel.Tokens.Jwt;</span><br><span class="line"><span class="keyword">using</span> System.Security.Claims;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.WebApi.Controllers</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">Route(<span class="string">&quot;api/[controller]&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">ApiController</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">LoginController</span> : <span class="title">ControllerBase</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IUserInfoService _userInfoService;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IConfiguration configuration;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">LoginController</span>(<span class="params">IUserInfoService userInfoService, IConfiguration configuration</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>._userInfoService = userInfoService;</span><br><span class="line">            <span class="keyword">this</span>.configuration = configuration;</span><br><span class="line">        &#125;</span><br><span class="line">        [<span class="meta">HttpPost</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">login</span>(<span class="params">[FromBody] UserInfo userInfo</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrWhiteSpace(userInfo.UserPhone) || <span class="built_in">string</span>.IsNullOrWhiteSpace(userInfo.UserPassword))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> BadRequest(<span class="string">&quot;手机号与密码不能为空!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//校验用户</span></span><br><span class="line">            <span class="keyword">var</span> loginUser = <span class="keyword">await</span> _userInfoService.LoadEntities(u=&gt;u.UserPhone==userInfo.UserPhone&amp;&amp;u.UserPassword==userInfo.UserPassword).FirstOrDefaultAsync();</span><br><span class="line">            <span class="keyword">if</span> (loginUser == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> BadRequest(<span class="string">&quot;手机号与密码错误&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 2、创建JWT</span></span><br><span class="line">            <span class="comment">// 创建header,内部定义了JWT编码的算法</span></span><br><span class="line">            <span class="keyword">var</span> securityAlgorithm = SecurityAlgorithms.HmacSha256;</span><br><span class="line">            <span class="comment">// 创建payload,需要根据项目的需求来进行创建，例如可能会使用到用户的编号，用户名，邮箱等</span></span><br><span class="line">            <span class="comment">// 创建payload的内容，需要使用到Claim(每创建一个Claim对象，表示用户的一个信息)</span></span><br><span class="line">            <span class="keyword">var</span> claims = <span class="keyword">new</span>[]</span><br><span class="line">            &#123;</span><br><span class="line">                  <span class="comment">// 第一项是，用户的ID，但是在JWT中，关于ID在JWT中有一个专用的名词叫做sub</span></span><br><span class="line">                  <span class="keyword">new</span> Claim(System.IdentityModel.Tokens.Jwt.JwtRegisteredClaimNames.Sub,loginUser.Id.ToString())</span><br><span class="line">              &#125;;</span><br><span class="line">            <span class="comment">// 创建签名，签名会使用到私钥，可以把私钥保存在配置文件中</span></span><br><span class="line">            <span class="comment">// 读取配置文件中的私钥，然后转成字节</span></span><br><span class="line">            <span class="keyword">var</span> secretByte = Encoding.UTF8.GetBytes(configuration[<span class="string">&quot;Authentication:SecretKey&quot;</span>]!);</span><br><span class="line">            <span class="comment">// 使用加密算法，对私钥进行加密</span></span><br><span class="line">            <span class="keyword">var</span> signingKey = <span class="keyword">new</span> SymmetricSecurityKey(secretByte);</span><br><span class="line">            <span class="comment">// 构建数字签名</span></span><br><span class="line">            <span class="keyword">var</span> signingCredentials = <span class="keyword">new</span> SigningCredentials(signingKey, securityAlgorithm);</span><br><span class="line">            <span class="comment">// 构建token 内容</span></span><br><span class="line">            <span class="keyword">var</span> token = <span class="keyword">new</span> JwtSecurityToken(</span><br><span class="line">                <span class="comment">// 谁发布的token数据，一般是服务端的地址</span></span><br><span class="line">                issuer: configuration[<span class="string">&quot;Authentication:Issuer&quot;</span>],</span><br><span class="line">                 <span class="comment">// 把token数据发布给谁，一般就是前端项目，这里也可以填写服务端的地址，或者不填写也可以</span></span><br><span class="line">                 audience: configuration[<span class="string">&quot;Authentication:Audience&quot;</span>],</span><br><span class="line">                claims,</span><br><span class="line">                <span class="comment">// 发布时间</span></span><br><span class="line">                notBefore: DateTime.Now,</span><br><span class="line">                <span class="comment">// 有效期</span></span><br><span class="line">                expires: DateTime.Now.AddDays(<span class="number">1</span>),</span><br><span class="line">                <span class="comment">// 数字签名</span></span><br><span class="line">                signingCredentials</span><br><span class="line"></span><br><span class="line">                );</span><br><span class="line">            <span class="comment">// 将token生成字符串的形式进行输出</span></span><br><span class="line">            <span class="keyword">var</span> tokenStr = <span class="keyword">new</span> JwtSecurityTokenHandler().WriteToken(token);</span><br><span class="line">            <span class="comment">//3、返回 200状态码和JWT内容</span></span><br><span class="line">            <span class="keyword">return</span> Ok(tokenStr);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在上面的代码中，我们构建数字签名的时候，使用了私钥，私钥必须保存到服务端，同时这里我们将其保存在了<code>appsettings.json</code>文件中</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;ConnectionStrings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;StrConn&quot;</span>: <span class="string">&quot;server=localhost;database=HrDb;uid=sa;pwd=123456;TrustServerCertificate=true&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;Authentication&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;SecretKey&quot;</span>: <span class="string">&quot;abc123456789@126.com&quot;</span>, <span class="comment">// 这里的值一定要长，否则会出错。</span></span><br><span class="line">    <span class="string">&quot;Issuer&quot;</span>: <span class="string">&quot;xxx.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Audience&quot;</span>: <span class="string">&quot;xxx.com&quot;</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p> <strong>启动授权</strong></p>
<p>当用户访问某些资源的时候，需要进行验证。</p>
<p>这就是使用前面所生成的<code>token</code>.</p>
<p>当然，这里需要注入<code>jwt</code>的认证服务。</p>
<p>修改<code>Program.cs</code>文件中的代码，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注入jwt的认证服务（这里采用默认的认证）</span></span><br><span class="line">builder.Services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme).AddJwtBearer(options =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 获取配置文件中存储的密钥</span></span><br><span class="line">    <span class="keyword">var</span> secretByte = Encoding.UTF8.GetBytes(builder.Configuration[<span class="string">&quot;Authentication:SecretKey&quot;</span>]!);</span><br><span class="line">    options.TokenValidationParameters = <span class="keyword">new</span> TokenValidationParameters()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 验证token的发布者</span></span><br><span class="line">        ValidateIssuer = <span class="literal">true</span>,</span><br><span class="line">        ValidIssuer = builder.Configuration[<span class="string">&quot;Authentication:Issuer&quot;</span>],</span><br><span class="line">        <span class="comment">// 验证token的持有者</span></span><br><span class="line">        ValidateAudience = <span class="literal">true</span>,</span><br><span class="line">        ValidAudience = builder.Configuration[<span class="string">&quot;Authentication:Audience&quot;</span>],</span><br><span class="line">        <span class="comment">// 验证toen是否过期</span></span><br><span class="line">        ValidateLifetime = <span class="literal">true</span>,</span><br><span class="line">        <span class="comment">// 使用私钥</span></span><br><span class="line">        IssuerSigningKey = <span class="keyword">new</span> SymmetricSecurityKey(secretByte)</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//注入DbContext,同时获取数据库链接字符串</span></span><br><span class="line">builder.Services.AddDbContext&lt;MyDbContext&gt;(opt =&gt;</span><br><span class="line">&#123;</span><br></pre></td></tr></table></figure>

<p>以上代码就是在注入<code>DbContext</code>服务的上面，注入了<code>JWT</code>的认证服务。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Configure the HTTP request pipeline.</span></span><br><span class="line"><span class="keyword">if</span> (app.Environment.IsDevelopment())</span><br><span class="line">&#123;</span><br><span class="line">    app.UseSwagger();</span><br><span class="line">    app.UseSwaggerUI();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 你是谁，是否登录</span></span><br><span class="line">app.UseAuthentication();</span><br><span class="line"><span class="comment">// 你可以干什么，有什么权限？</span></span><br><span class="line">app.UseAuthorization();</span><br><span class="line"></span><br><span class="line">app.MapControllers();</span><br></pre></td></tr></table></figure>

<p>同时，在<code>Program.cs</code>文件的下面添加了<code>app.UseAuthentication(),app.UseAuthorization();app.MapControllers();</code></p>
<p>下面，我们进行测试。</p>
<p>这里我们可以把登录成功后，返回前端的数据格式修改一下：</p>
<p>在<code>WebApi</code>项目中创建<code>models</code>文件夹，在该文件夹中创建<code>ApiResult.cs</code>类，该类中的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.WebApi.models</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ApiResult</span>&lt;<span class="title">T</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">bool</span> Success &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? Message &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> T? Data &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>下面修改一下<code>LoginController</code>控制器中的<code>login</code>方法中的代码，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将token生成字符串的形式进行输出</span></span><br><span class="line">           <span class="keyword">var</span> tokenStr = <span class="keyword">new</span> JwtSecurityTokenHandler().WriteToken(token);</span><br><span class="line">           <span class="comment">//------------------3、返回 200状态码和JWT内容,这里返回的是ApiResult中定义的格式</span></span><br><span class="line">           <span class="keyword">return</span> Ok( <span class="keyword">new</span> ApiResult&lt;<span class="built_in">string</span>&gt; ()&#123; Success=<span class="literal">true</span>, Message=<span class="string">&quot;登录成功&quot;</span>,Data=tokenStr&#125;);</span><br></pre></td></tr></table></figure>

<p>在上面的代码中，返回的就是<code>ApiResult</code>定义的格式。</p>
<h3 id="5、前端–封装单独的登录接口"><a href="#5、前端–封装单独的登录接口" class="headerlink" title="5、前端–封装单独的登录接口"></a>5、前端–封装单独的登录接口</h3><p>在<code>src/api/user.js</code>文件中，完善<code>login</code>方法，如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> request <span class="keyword">from</span> <span class="string">&quot;@/utils/request&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">login</span>(<span class="params">data</span>) &#123;</span><br><span class="line">    <span class="comment">// 返回一个promise对象</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">request</span>(&#123;</span><br><span class="line">        <span class="attr">url</span>:<span class="string">&#x27;/api/login&#x27;</span>,</span><br><span class="line">        <span class="attr">method</span>:<span class="string">&#x27;post&#x27;</span>,</span><br><span class="line">        data</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getInfo</span>(<span class="params"></span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">logout</span>(<span class="params"></span>) &#123;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6、Vuex中对token进行管理"><a href="#6、Vuex中对token进行管理" class="headerlink" title="6、Vuex中对token进行管理"></a>6、<code>Vuex</code>中对<code>token</code>进行管理</h3><p>关于<code>token</code>信息，我们需要存储到<code>Vuex</code>中，因为需要在不同的组件中使用。将<code>Token</code>信息存储到<code>Vuex</code>中可以实现<code>Token</code>信息的共享，更方便读取。</p>
<p>当然，存储到<code>Vuex</code>中的<code>Token</code>信息，在刷新浏览器后会丢失，所以需要持久化到本地。</p>
<p>在<code>src/utils/</code>目录下面创建<code>storage.js</code> 文件，该文件中的代码，如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 存储token信息的本地存储名称</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">TOKEN_KEY</span> = <span class="string">&quot;hr-token&quot;</span>;</span><br><span class="line"><span class="comment">// 将token信息存储到本地</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">setTokenInfo</span> =(<span class="params">tokenInfo</span>)=&gt;&#123;</span><br><span class="line">    <span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="variable constant_">TOKEN_KEY</span>,<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(tokenInfo));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 从本地获取token信息</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">getTokenInfo</span>=(<span class="params"></span>)=&gt;&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="variable constant_">TOKEN_KEY</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 删除本地token信息</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">removeTokenInfo</span>=(<span class="params"></span>)=&gt;&#123;</span><br><span class="line">    <span class="variable language_">localStorage</span>.<span class="title function_">removeItem</span>(<span class="variable constant_">TOKEN_KEY</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上定义了相关方法，实现将<code>token</code>信息存储到本地，以及从本地读取<code>token</code>信息和删除<code>token</code>信息。</p>
<p>在<code>store</code>目录下面创建<code>modules</code>目录，在该目录下面创建的文件都是<code>Vuex</code>的模块。</p>
<p>在这里我们先创建<code>user.js</code>文件，该文件中的代码如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; getTokenInfo, removeTokenInfo, setTokenInfo &#125; <span class="keyword">from</span> <span class="string">&quot;@/utils/storage&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">namespaced</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="title function_">state</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">token</span>: <span class="title function_">getTokenInfo</span>(), <span class="comment">// 获取token信息，初始化vuex</span></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">mutations</span>: &#123;</span><br><span class="line">    <span class="title function_">setToken</span>(<span class="params">state, payload</span>) &#123;</span><br><span class="line">      state.<span class="property">token</span> = payload; <span class="comment">// 将token信息保存到vuex容器中</span></span><br><span class="line">      <span class="title function_">setTokenInfo</span>(payload); <span class="comment">// 将token信息持久化到本地</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">removeToken</span>(<span class="params">state</span>) &#123;</span><br><span class="line">      state.<span class="property">token</span> = <span class="literal">null</span>; <span class="comment">// 清空vuex中的token信息</span></span><br><span class="line">      <span class="title function_">removeTokenInfo</span>(); <span class="comment">// 删除本地token信息</span></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这里我们需要将上面创建的<code>user</code>模块，注册到<code>vuex</code>容器中。</p>
<p>修改<code>src/store/index.js</code>文件中的代码，如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createStore &#125; <span class="keyword">from</span> <span class="string">&quot;vuex&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> user <span class="keyword">from</span> <span class="string">&quot;./modules/user&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">createStore</span>(&#123;</span><br><span class="line">  <span class="attr">modules</span>: &#123;</span><br><span class="line">    user,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>将创建的<code>user</code>模块，添加到了<code>modules</code>这个选项中，完成了模块的注册操作。</p>
<p>当然，在入口文件<code>main,js</code>文件中，也已经将<code>vuex</code>容器注册到了<code>应用实例</code>中。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createApp &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&#x27;./App.vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">&#x27;./router&#x27;</span></span><br><span class="line"><span class="keyword">import</span> store <span class="keyword">from</span> <span class="string">&#x27;./store&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">createApp</span>(<span class="title class_">App</span>).<span class="title function_">use</span>(store).<span class="title function_">use</span>(router).<span class="title function_">mount</span>(<span class="string">&#x27;#app&#x27;</span>) <span class="comment">// use(store)</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">localstorage和cookie都可以用来做本地存储，实现数据持久化。它们的区别还是很多的，主要体现在以下几个方面。</span><br><span class="line"></span><br><span class="line">第一：能保存的数据大小不同。localstorage能保存的内容更多一些，查资料差不多是5M；cookie能保存的内容少一些，差不多4K</span><br><span class="line"></span><br><span class="line">第二: 有效时间不同。cookie的有效期可以自行设置，而localstorage可以一直生效。</span><br><span class="line"></span><br><span class="line">第三：在请求时，cookie会被携带，而localstorage不会。同源的cookie信息会自动作为请求头的一部分发给服务器，如果过多设置cookie，会额外增加通信负荷。而localstorage没有这个问题，它会一直存在于浏览器端。</span><br><span class="line"></span><br><span class="line">在实际开发中，我会根据具体情况来选择使用它们。如果不需要与服务器通信并且可以长时间保存在客户端的信息就可以采用localstorage来保存，例如：网站中，提供的个人设置信息。</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h3 id="7、创建登录的Action"><a href="#7、创建登录的Action" class="headerlink" title="7、创建登录的Action"></a>7、创建登录的<code>Action</code></h3><p>修改<code>store/modules/user.js</code>文件中的代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; getTokenInfo, removeTokenInfo, setTokenInfo &#125; <span class="keyword">from</span> <span class="string">&quot;@/utils/storage&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; login &#125; <span class="keyword">from</span> <span class="string">&quot;@/api/user&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">namespaced</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="title function_">state</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">token</span>: <span class="title function_">getTokenInfo</span>(), <span class="comment">// 获取token信息，初始化vuex</span></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">mutations</span>: &#123;</span><br><span class="line">    <span class="title function_">setToken</span>(<span class="params">state, payload</span>) &#123;</span><br><span class="line">      state.<span class="property">token</span> = payload; <span class="comment">// 将token信息保存到vuex容器中</span></span><br><span class="line">      <span class="title function_">setTokenInfo</span>(payload); <span class="comment">// 将token信息持久化到本地</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">removeToken</span>(<span class="params">state</span>) &#123;</span><br><span class="line">      state.<span class="property">token</span> = <span class="literal">null</span>; <span class="comment">// 清空vuex中的token信息</span></span><br><span class="line">      <span class="title function_">removeTokenInfo</span>(); <span class="comment">// 删除本地token信息</span></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">actions</span>: &#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">userLogin</span>(<span class="params">context, payload</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="title function_">login</span>(payload);</span><br><span class="line">        <span class="comment">// // axios默认给数据加了一层data</span></span><br><span class="line">      <span class="keyword">if</span> (result.<span class="property">data</span>.<span class="property">success</span>) &#123;</span><br><span class="line">        context.<span class="title function_">commit</span>(<span class="string">&quot;setToken&quot;</span>, result.<span class="property">data</span>.<span class="property">data</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>在上面的代码中，导入了<code>api/user.js</code>文件中定义的<code>login</code>方法。</p>
<p>然后创建<code>actions</code>,在<code>actions</code>中创建<code>userLogin</code>方法，在调用该方法的时候，会传递手机号和密码。</p>
<p>在该方法中调用<code>login</code>方法发送请求，实现登录。</p>
<p>登录成功以后，提交<code>setToken</code>这个<code>mutations</code>方法，这样就可以将服务端返回的<code>token</code>数据存储到<code>vuex</code>中，同时也实现了本地持久化操作。</p>
<p>除此之外，为了更好的让其他模块和组件更好的获取token数据，我们可以在**<code>store/getters.js</code>**中将token值作为公共的访问属性放出.</p>
<p>在<code>store</code>目录下面创建<code>getters.js</code>文件，该文件中的代码如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> getters = &#123;</span><br><span class="line">  <span class="attr">token</span>: <span class="function">(<span class="params">state</span>) =&gt;</span> state.<span class="property">user</span>.<span class="property">token</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> getters;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在上面的代码中从<code>user</code>模块中获取<code>token</code>这个状态数据。</p>
<p>当然，也需要将上面定义的<code>getters</code>注册到<code>vuex</code>容器中。</p>
<p>所以还需要修改<code>store/index.js</code>文件中的代码，如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createStore &#125; <span class="keyword">from</span> <span class="string">&quot;vuex&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> user <span class="keyword">from</span> <span class="string">&quot;./modules/user&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> getters <span class="keyword">from</span> <span class="string">&quot;./getters&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">createStore</span>(&#123;</span><br><span class="line">  <span class="attr">modules</span>: &#123;</span><br><span class="line">    user,</span><br><span class="line">  &#125;,</span><br><span class="line">  getters,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在上面的代码中，导入了<code>getters</code>，同时在创建<code>store</code>容器的时候，完成了对应的注册操作。</p>
<h3 id="8、完善axios配置"><a href="#8、完善axios配置" class="headerlink" title="8、完善axios配置"></a>8、完善<code>axios</code>配置</h3><h4 id="8-1-区分axios在不同环境中的请求地址"><a href="#8-1-区分axios在不同环境中的请求地址" class="headerlink" title="8.1  区分axios在不同环境中的请求地址"></a>8.1  区分<code>axios</code>在不同环境中的请求地址</h4><p>在开发环境与生产环境中请求的服务端接口是不一样的。</p>
<p>怎样进行区分呢？</p>
<p>通过**<code>.env.development</code><strong>和</strong><code>.env.production</code>**两个文件进行区分。</p>
<p><code>.env.development</code>是在开发环境中执行的文件，而<code>.env.production</code>是在生产环境中执行的文件。</p>
<p>所以：我们可以在**<code>.env.development</code><strong>和</strong><code>.env.production</code>**定义变量，变量自动就为当前环境的值</p>
<p>下面修改<strong>根目录</strong>下面的<code>.env.development</code>文件中的配置：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">port = <span class="number">8888</span></span><br><span class="line"></span><br><span class="line"># 开发环境的基础地址和代理对应</span><br><span class="line"><span class="variable constant_">VUE_APP_BASE_API</span> = <span class="string">&#x27;http://localhost:5105/api&#x27;</span></span><br></pre></td></tr></table></figure>

<p>但是我们的开发环境代理是**<code>/api</code>**，所以可以采用以上的统一方式。</p>
<p>如果是生产环境，需要修改<code>.env.production</code>文件，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 生产环境的基础地址和代理对应</span></span><br><span class="line">VUE_APP_BASE_API = <span class="string">&#x27;http://localhost:8105/api&#x27;</span></span><br></pre></td></tr></table></figure>

<p>以上是生产环境下的接口地址。</p>
<p>下面修改<code>utils/request.js</code>文件中的代码，如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导出一个axios的实例  而且这个实例要有请求拦截器 响应拦截器</span></span><br><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&quot;axios&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> service = axios.<span class="title function_">create</span>(&#123;</span><br><span class="line">    <span class="comment">// 如果执行 npm run serve  值为 /api 正确  /api 这个代理只是给开发环境配置的代理</span></span><br><span class="line">  <span class="comment">// 如果执行 npm run build 值为 /prod-api  没关系  运维应该在上线的时候 给你配置上 /prod-api的代理</span></span><br><span class="line">  <span class="attr">baseURL</span>: process.<span class="property">env</span>.<span class="property">VUE_APP_BASE_API</span>,</span><br><span class="line">  <span class="attr">timeout</span>: <span class="number">5000</span>,</span><br><span class="line">&#125;); <span class="comment">// 创建一个axios的实例</span></span><br><span class="line">service.<span class="property">interceptors</span>.<span class="property">request</span>.<span class="title function_">use</span>(); <span class="comment">// 请求拦截器</span></span><br><span class="line">service.<span class="property">interceptors</span>.<span class="property">response</span>.<span class="title function_">use</span>(); <span class="comment">// 响应拦截器</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> service; <span class="comment">// 导出axios实例</span></span><br></pre></td></tr></table></figure>



<h4 id="8-2-响应拦截器配置"><a href="#8-2-响应拦截器配置" class="headerlink" title="8.2 响应拦截器配置"></a>8.2 响应拦截器配置</h4><p>修改<code>utils/request.js</code>文件中的代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导出一个axios的实例  而且这个实例要有请求拦截器 响应拦截器</span></span><br><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&quot;axios&quot;</span>;</span><br><span class="line"> <span class="comment">//  import &#123; ElMessage &#125; from &quot;element-plus&quot;; //注意：前面我们针对element-plus已经配置了按需导入，所以这里不需要导入ElMessage,而是直接使用</span></span><br><span class="line"><span class="keyword">const</span> service = axios.<span class="title function_">create</span>(&#123;</span><br><span class="line">  <span class="attr">baseURL</span>: process.<span class="property">env</span>.<span class="property">VUE_APP_BASE_API</span>,</span><br><span class="line">  <span class="attr">timeout</span>: <span class="number">5000</span>,</span><br><span class="line">&#125;); <span class="comment">// 创建一个axios的实例</span></span><br><span class="line">service.<span class="property">interceptors</span>.<span class="property">request</span>.<span class="title function_">use</span>(); <span class="comment">// 请求拦截器</span></span><br><span class="line"><span class="comment">// 配置响应拦截器</span></span><br><span class="line">service.<span class="property">interceptors</span>.<span class="property">response</span>.<span class="title function_">use</span>(</span><br><span class="line">  <span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// axios 默认添加了一层data</span></span><br><span class="line">    <span class="keyword">const</span> &#123; success, message, data &#125; = response.<span class="property">data</span>;</span><br><span class="line">    <span class="keyword">if</span> (success) &#123;</span><br><span class="line">      <span class="keyword">return</span> data;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 业务已经错误了（例如输入的手机号或者是密码是错误的），需要给出错误提示，并且应该进入catch</span></span><br><span class="line">      <span class="title class_">ElMessage</span>.<span class="title function_">error</span>(message);</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(message));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title class_">ElMessage</span>.<span class="title function_">error</span>(error.<span class="property">message</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(error); <span class="comment">// 返回执行错误，让当前的执行链跳出成功，直接进行入catch</span></span><br><span class="line">  &#125;</span><br><span class="line">); <span class="comment">// 响应拦截器</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> service; <span class="comment">// 导出axios实例</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在上面的代码中，我们实现了响应拦截，这里<code>use</code>方法需要两个参数，都是函数。</p>
<p>第一个表示处理成功的响应</p>
<p>第二个表示处理失败的响应。</p>
<p>如果处理失败了，首先通过<code>ElMessage</code>弹出错误的消息，同时执行<code> return Promise.reject(error)</code>,表示返回执行的错误，让当前的执行链跳出成功，直接进入<code>catch</code>.</p>
<p>例如：登录的时候，我们执行的是<code>login().then().catch()</code>，如果成功了会进入到<code>then</code>方法，但是如果服务端处理失败了，会执行<code>catch</code>，</p>
<p>在第一个处理函数中，我们解构出了服务端返回内容，当前服务端接口，返回的内容包括了<code>success,message,data</code></p>
<p>这里我们判断一下<code>success</code>如果为<code>true</code>，表示服务端返回了正确的响应数据，这里直接将<code>data</code>返回。</p>
<p>否则表示业务执行错误，需要进行错误处理。</p>
<p>如果响应是成功的，这里我们直接将服务端返回的响应数据返回了，所以在<code>store/modules/user.js</code>文件中的<code>userLogin</code>这个<code>actions</code>方法中，不需要添加判断，并且<code>result</code>中存储的就是服务端返回的响应数据。所以修改成如下的形式。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">actions</span>: &#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">userLogin</span>(<span class="params">context, payload</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="title function_">login</span>(payload);</span><br><span class="line">      context.<span class="title function_">commit</span>(<span class="string">&quot;setToken&quot;</span>, result);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>

<h3 id="9、实现登录"><a href="#9、实现登录" class="headerlink" title="9、实现登录"></a>9、实现登录</h3><p>下面修改<code>views/login/index.vue</code>中的代码</p>
<p>我们知道当我们单击<code>登录</code>按钮的时候，会调用<code>submit</code>方法</p>
<p>在该方法中，我们需要派发<code>action</code>，来发送请求。</p>
<p>修改<code>submit</code>方法中的代码，如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 进行表单的提交</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">submit</span> = (<span class="params">loginForm</span>) =&gt; &#123;</span><br><span class="line"> loginForm.<span class="title function_">validate</span>(<span class="title function_">async</span>(valid)=&gt;&#123;</span><br><span class="line">  <span class="keyword">if</span>(valid)&#123;</span><br><span class="line">      <span class="comment">//-----------------注意：这里重新定义了一个loginForm对象，保存用户在表单中输入的内容，这里的属性一定要是userPhone和userPassword,服务端才会自动进行接收。</span></span><br><span class="line">  <span class="keyword">const</span> loginForm=&#123;</span><br><span class="line">    <span class="attr">userPhone</span>:ruleForm.<span class="property">mobile</span>,</span><br><span class="line">    <span class="attr">userPassword</span>:ruleForm.<span class="property">password</span></span><br><span class="line">  &#125;  </span><br><span class="line">  <span class="keyword">await</span> store.<span class="title function_">dispatch</span>(<span class="string">&quot;user/userLogin&quot;</span>, loginForm);</span><br><span class="line">        router.<span class="title function_">push</span>(<span class="string">&quot;/&quot;</span>);  </span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title class_">ElMessageBox</span>.<span class="title function_">alert</span>(<span class="string">&quot;密码没有通过验证!&quot;</span>,<span class="string">&quot;数据校验&quot;</span>,&#123;</span><br><span class="line">      <span class="attr">confirmButtonText</span>:<span class="string">&quot;OK&quot;</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>通过通过校验了<code>这里通过store.dispatch</code>派发的是<code>user</code>模块中的<code>userLogin</code>这个<code>actions</code>方法，同时为该方法传递的是用户在表单中输入的数据.</p>
<p>成功以后进行跳转。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import &#123; useStore &#125; <span class="keyword">from</span> <span class="string">&quot;vuex&quot;</span>;</span><br><span class="line">import &#123; useRouter &#125; <span class="keyword">from</span> <span class="string">&quot;vue-router&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>导入<code>useStore和useRouter</code>两个方法。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> formRef = <span class="title function_">ref</span>(<span class="literal">null</span>);</span><br><span class="line">   <span class="keyword">const</span> store = <span class="title function_">useStore</span>();</span><br><span class="line">   <span class="keyword">const</span> router = <span class="title function_">useRouter</span>();</span><br></pre></td></tr></table></figure>

<p>调用<code>useStore</code>方法创建<code>store</code>实例，调用<code>useRouter</code>创建<code>router</code>实例。</p>
<p>返回到浏览器中进行测试。</p>
<p>先输入错误的密码进行测试</p>
<p>然后输入正确的手机号和密码进行测试。</p>
<p>当登录成功以后，可以查看本地存储的<code>token</code>信息。</p>
<p><strong>注意：在进行测试的时候，一定要重新启动项目，因为前面修改了配置。</strong></p>
<p>但是这里出错了，出错的原因是出现了跨域的问题。</p>
<h3 id="10、跨域"><a href="#10、跨域" class="headerlink" title="10、跨域"></a>10、跨域</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">跨源（跨域） HTTP 请求的一个例子：运行在 https://domain-a.com 的 JavaScript 代码使用 XMLHttpRequest 来发起一个到 https://domain-b.com/data.json 的请求。</span><br><span class="line"></span><br><span class="line">出于安全性，浏览器限制脚本内发起的跨源 HTTP 请求</span><br></pre></td></tr></table></figure>

<p>它是浏览器<strong>同源策略</strong>造成的，是浏览器对<code>JS</code>实施的安全限制。</p>
<p>浏览器安全性可防止网页向不处理网页的域发送请求。 此限制称为同域（同源）策略。 同域（同源）策略可防止恶意站点从另一站点读取敏感数据</p>
<p><em><strong>*什么是同源策略？*</strong></em> （所谓同源是指：“域名”、“协议”、“端口”均为相同）</p>
<p>具体参考微软官方文档:<code>https://learn.microsoft.com/zh-cn/aspnet/core/security/cors?view=aspnetcore-7.0</code></p>
<p><em><strong>常见的跨域场景</strong></em></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images%5Cd.png"></p>
<p><strong><code>跨域资源共享CORS</code></strong></p>
<p>CORS是一个W3C标准，全称是”跨域资源共享”（Cross-origin resource sharing）。 它允许浏览器向跨源服务器，发出XMLHttpRequest请求，从而克服了AJAX只能同源使用的限制。</p>
<p>CORS需要浏览器和服务器同时支持。目前，所有浏览器都支持该功能，IE浏览器不能低于IE10。IE8+：IE8&#x2F;9需要使用XDomainRequest对象来支持CORS。</p>
<p>整个CORS通信过程，都是浏览器自动完成，不需要用户参与。对于开发者来说，CORS通信与同源的AJAX通信没有差别，代码完全一样。浏览器一旦发现AJAX请求跨源，就会自动添加一些附加的头信息，有时还会多出一次附加的请求，但用户不会有感觉。 因此，实现CORS通信的关键是服务器。只要服务器实现了CORS接口，就可以跨源通信。</p>
<p>基本流程：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">对于简单请求，浏览器直接发出CORS请求。具体来说，就是在头信息之中，增加一个Origin字段。 下面是一个例子，浏览器发现这次跨源AJAX请求是简单请求，就自动在头信息之中，添加一个Origin字段。</span><br><span class="line"></span><br><span class="line">GET /cors HTTP/1.1</span><br><span class="line">Origin: http://api.bob.com</span><br><span class="line">Host: api.alice.com</span><br><span class="line">Accept-Language: en-US</span><br><span class="line">Connection: keep-alive</span><br><span class="line">User-Agent: Mozilla/5.0</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Origin字段用来说明，本次请求来自哪个源（协议 + 域名 + 端口）。服务器根据这个值，决定是否同意这次请求。</p>
<p>如果Origin指定的源，不在许可范围内，服务器会返回一个正常的HTTP回应。 浏览器发现，这个回应的头信息没有包含Access-Control-Allow-Origin字段，就知道出错了，从而抛出一个错误，被<code>XMLHttpRequest</code>的<code>onerror</code>回调函数捕获。</p>
<p>如果Origin指定的域名在许可范围内，服务器返回的响应，会多出几个头信息字段。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">   Access-Control-Allow-Origin: http://api.bob.com</span><br><span class="line">   Access-Control-Allow-Credentials: true</span><br><span class="line">   Access-Control-Expose-Headers: FooBar</span><br><span class="line">   Content-Type: text/html; charset=utf-8</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">上面的头信息之中，有三个与CORS请求相关的字段，都以Access-Control-开头</span><br><span class="line"></span><br><span class="line">Access-Control-Allow-Origin :该字段是必须的。它的值要么是请求时Origin字段的值，要么是一个*，表示接受任意域名的请求</span><br><span class="line">Access-Control-Allow-Credentials: 该字段可选。它的值是一个布尔值，表示是否允许发送Cookie。默认情况下，Cookie不包括在CORS请求之中。设为true，即表示服务器明确许可，Cookie可以包含在请求中，一起发给服务器。这个值也只能设为true，如果服务器不要浏览器发送Cookie，删除该字段即可。</span><br><span class="line">Access-Control-Expose-Headers:该字段可选。CORS请求时，XMLHttpRequest对象的getResponseHeader()方法只能拿到6个基本字段：Cache-Control、Content-Language、Content-Type、Expires、Last-Modified、Pragma。如果想拿到其他字段，就必须在Access-Control-Expose-Headers里面指定。</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>参考：<code>https://juejin.cn/post/6844903521163182088</code></p>
<p>这里服务端进行解决：(修改<code>Program.cs</code>文件中的代码)</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">builder.Services.AddSwaggerGen();</span><br><span class="line"></span><br><span class="line"><span class="comment">//跨域</span></span><br><span class="line"><span class="keyword">var</span> MyAllowSpecificOrigins = <span class="string">&quot;_myAllowSpecificOrigins&quot;</span>;</span><br><span class="line">builder.Services.AddCors(options =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    options.AddPolicy(name: MyAllowSpecificOrigins,</span><br><span class="line">                      policy =&gt;</span><br><span class="line">                      &#123;</span><br><span class="line">                          policy.AllowAnyOrigin().AllowAnyHeader().AllowAnyMethod();</span><br><span class="line">                      &#125;);</span><br><span class="line">    </span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">var</span> app = builder.Build();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.UseCors(MyAllowSpecificOrigins);<span class="comment">// 启用跨域处理的中间件</span></span><br></pre></td></tr></table></figure>



<p>测试完成，查看本地存储中的<code>token</code>信息。</p>
<h3 id="11、Loading效果实现"><a href="#11、Loading效果实现" class="headerlink" title="11、Loading效果实现"></a>11、<code>Loading</code>效果实现</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-button</span><br><span class="line">       class=&quot;loginBtn&quot;</span><br><span class="line">       type=&quot;primary&quot;</span><br><span class="line">       style=&quot;width: 100%; margin-bottom: 30px&quot;</span><br><span class="line">       @click=&quot;submit(formRef)&quot;</span><br><span class="line">       :loading=&quot;loading&quot;</span><br><span class="line">       &gt;登录&lt;/el-button</span><br><span class="line">     &gt;</span><br></pre></td></tr></table></figure>

<p>给<code>el-button</code>组件添加<code>loading</code>属性，关联的是<code>loading</code>对象。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> router = <span class="title function_">useRouter</span>();</span><br><span class="line">  <span class="keyword">const</span> loading = <span class="title function_">ref</span>(<span class="literal">false</span>);</span><br></pre></td></tr></table></figure>

<p>创建<code>loading</code>对象，默认值是<code>false</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">     ruleForm,</span><br><span class="line">     submit,</span><br><span class="line">     loginRules,</span><br><span class="line">     ruleFormRef,</span><br><span class="line">     loading</span><br><span class="line">   &#125;;</span><br></pre></td></tr></table></figure>

<p>并且将<code>loading</code>返回。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// 进行表单的提交</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">submit</span> = (<span class="params">loginForm</span>) =&gt; &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;loginForm = &quot;</span>,loginForm);</span><br><span class="line">   loginForm.<span class="title function_">validate</span>(<span class="title function_">async</span>(valid)=&gt;&#123;</span><br><span class="line">    <span class="keyword">if</span>(valid)&#123;</span><br><span class="line">      loading.<span class="property">value</span> = <span class="literal">true</span>; <span class="comment">// ---------------------开启loading效果</span></span><br><span class="line">    <span class="comment">//  console.log(ruleForm.mobile.trim() + &quot; &quot; + ruleForm.password);</span></span><br><span class="line">    <span class="keyword">const</span> loginForm=&#123;</span><br><span class="line">      <span class="attr">userPhone</span>:ruleForm.<span class="property">mobile</span>,</span><br><span class="line">      <span class="attr">userPassword</span>:ruleForm.<span class="property">password</span></span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">      <span class="keyword">await</span> store.<span class="title function_">dispatch</span>(<span class="string">&quot;user/userLogin&quot;</span>, loginForm);</span><br><span class="line">          router.<span class="title function_">push</span>(<span class="string">&quot;/&quot;</span>);  </span><br><span class="line">    &#125;<span class="keyword">catch</span>(error)&#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(error)</span><br><span class="line">    &#125; <span class="keyword">finally</span>&#123;</span><br><span class="line">      loading.<span class="property">value</span> = <span class="literal">false</span>;<span class="comment">//----------------关闭loading效果</span></span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="title class_">ElMessageBox</span>.<span class="title function_">alert</span>(<span class="string">&quot;密码没有通过验证!&quot;</span>,<span class="string">&quot;数据校验&quot;</span>,&#123;</span><br><span class="line">        <span class="attr">confirmButtonText</span>:<span class="string">&quot;OK&quot;</span></span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  )</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>在<code>submit</code>方法中，通过表单校验后将<code>loading</code>设置为<code>true</code>.</p>
<p>不管是登录成功还是失败都需要将<code>loading</code>设置为<code>false</code>，也就是关闭<code>loading</code>的效果。</p>
<p>所以这里在<code>finally</code>中将<code>loading</code>设置为<code>false</code>。</p>
<p>返回到浏览器中进行测试。（把浏览器的网络调慢，来查看<code>loading</code>的效果）</p>
<p>在测试的时候，可以输入错误的手机号或者是密码，查看控制台中的输出，这时候服务端返回的状态码是400，所以前端项目也需要针对这种这种进行处理，这里我们没有处理，只是打印到了浏览器的控制台中，大家可以自行完善。</p>
<h2 id="三、主页模块"><a href="#三、主页模块" class="headerlink" title="三、主页模块"></a>三、主页模块</h2><h3 id="1、主页的token拦截处理"><a href="#1、主页的token拦截处理" class="headerlink" title="1、主页的token拦截处理"></a>1、主页的token拦截处理</h3><p>我们已经完成了登录的过程，并且存储了token，但是此时主页并没有因为token的有无而被控制访问权限，</p>
<p>也就是说，如果用户没有登录，是不能直接访问主页的，但是现在却可以。</p>
<p>所以下面我们看一下，怎样对用户是否登录进行判断，从而决定是否允许访问主页。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images%5C30.png"></p>
<p>通过上图，可以看到整个的校验流程</p>
<p>首先判断是否有<code>token</code>，如果有<code>token</code>说明用户已经登录，但是如果用户又访问了登录页面，这时候会直接跳转到主页，但是如果访问的不是登录页面，而是其他的页面，放行，运行访问。也就是说，用户如果登录了，在访问登录页面，是不会出现登录表单的，直接就进入主页了。</p>
<p>如果没有<code>token</code>信息，说明用户没有登录，这时候，我们就需要看一下用户访问的地址是否是在白名单中，所谓的白名单指的就是不需要登录也能够访问的页面。例如404页面，登录页面，这些页面用户不用登录也可以访问。如果访问的地址是在白名单中，就允许访问。如果访问的地址不在白名单中，说明用户访问的地址只能是登录以后才能访问，而这时候用户又没有登录，所以只能跳转到登录页面，进行登录。</p>
<p>以上就是关于用户是否登录的判断流程。</p>
<p>当输入地址访问页面的时候，会执行路由守卫，所以在路由守卫中进行判断。</p>
<p>下面看一下具体代码的实现。</p>
<p>在项目的<code>src</code>目录下面创建<code>permission.js</code>文件，该文件中的代码如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 权限拦截在路由跳转，导航守卫中完成</span></span><br><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">&quot;@/router&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> store <span class="keyword">from</span> <span class="string">&quot;@/store&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> whiteList =[<span class="string">&quot;/login&quot;</span>,<span class="string">&quot;/404&quot;</span>]; <span class="comment">// 定义白名单。</span></span><br><span class="line"><span class="comment">// 前置守卫</span></span><br><span class="line"><span class="comment">// next() :表示放行</span></span><br><span class="line"><span class="comment">// next(false):表示路由跳转终止</span></span><br><span class="line"><span class="comment">// next(地址):表示跳转到指定的地址</span></span><br><span class="line">router.<span class="title function_">beforeEach</span>(<span class="function">(<span class="params">to,<span class="keyword">from</span>,next</span>)=&gt;</span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 通过keys获取对象中的属性，返回值是一个数组，如果length大于0，表示对象中有属性，而不是一个空对象。</span></span><br><span class="line">  <span class="keyword">if</span> (store.<span class="property">getters</span>.<span class="property">token</span>!=<span class="literal">null</span>&amp;&amp; <span class="title class_">Object</span>.<span class="title function_">keys</span>(store.<span class="property">getters</span>.<span class="property">token</span>).<span class="property">length</span>) &#123;</span><br><span class="line">    <span class="comment">// 如果有token</span></span><br><span class="line">    <span class="keyword">if</span> (to.<span class="property">path</span> === <span class="string">&quot;/login&quot;</span>) &#123;</span><br><span class="line">      <span class="comment">// 如果访问的是登录页面，跳转到主页</span></span><br><span class="line">      <span class="title function_">next</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">next</span>(); <span class="comment">// 放行</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 如果没有登录,也就没有token</span></span><br><span class="line">    <span class="keyword">if</span> (whiteList.<span class="title function_">indexOf</span>(to.<span class="property">path</span>) &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">      <span class="comment">// 表示要去的地址在白名单中，放行</span></span><br><span class="line">      <span class="title function_">next</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 用户没有登录，访问的地址也不在白名单中，跳转到登录页面</span></span><br><span class="line">      <span class="title function_">next</span>(<span class="string">&quot;/login&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>同时在<code>main.js</code>文件中导入<code>permission.js</code>，如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createApp &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&#x27;./App.vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">&#x27;./router&#x27;</span></span><br><span class="line"><span class="keyword">import</span> store <span class="keyword">from</span> <span class="string">&#x27;./store&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;./permission&quot;</span> <span class="comment">// 导入permission</span></span><br><span class="line"><span class="title function_">createApp</span>(<span class="title class_">App</span>).<span class="title function_">use</span>(store).<span class="title function_">use</span>(router).<span class="title function_">mount</span>(<span class="string">&#x27;#app&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>返回到浏览器中进行测试，按照上图的流程进行测试。</p>
<p>下面添加进度条效果，在路由切换的时候，如果加载比较慢，可以出现进度条。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i nprogress</span><br></pre></td></tr></table></figure>

<p>继续修改<code>permission.js</code>文件中的代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 权限拦截在路由跳转，导航守卫中完成</span></span><br><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">&quot;@/router&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> store <span class="keyword">from</span> <span class="string">&quot;@/store&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">NProgress</span> <span class="keyword">from</span> <span class="string">&quot;nprogress&quot;</span>; <span class="comment">// --------------------引入一份进度条插件</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;nprogress/nprogress.css&quot;</span>; <span class="comment">// ------------------------引入进度条样式</span></span><br><span class="line"><span class="keyword">const</span> whiteList =[<span class="string">&quot;/login&quot;</span>,<span class="string">&quot;/404&quot;</span>]; <span class="comment">// 定义白名单。</span></span><br><span class="line"><span class="comment">// 前置守卫</span></span><br><span class="line"><span class="comment">// next() :表示放行</span></span><br><span class="line"><span class="comment">// next(false):表示路由跳转终止</span></span><br><span class="line"><span class="comment">// next(地址):表示跳转到指定的地址</span></span><br><span class="line">router.<span class="title function_">beforeEach</span>(<span class="function">(<span class="params">to,<span class="keyword">from</span>,next</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="title class_">NProgress</span>.<span class="title function_">start</span>(); <span class="comment">//------------------------------------ 开启进度条</span></span><br><span class="line">  <span class="comment">// 通过keys获取对象中的属性，返回值是一个数组，如果length大于0，表示对象中有属性，而不是一个空对象。</span></span><br><span class="line">  <span class="keyword">if</span> (store.<span class="property">getters</span>.<span class="property">token</span>!=<span class="literal">null</span>&amp;&amp; <span class="title class_">Object</span>.<span class="title function_">keys</span>(store.<span class="property">getters</span>.<span class="property">token</span>).<span class="property">length</span>) &#123;</span><br><span class="line">    <span class="comment">// 如果有token</span></span><br><span class="line">    <span class="keyword">if</span> (to.<span class="property">path</span> === <span class="string">&quot;/login&quot;</span>) &#123;</span><br><span class="line">      <span class="comment">// 如果访问的是登录页面，跳转到主页</span></span><br><span class="line">      <span class="title function_">next</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">next</span>(); <span class="comment">// 放行</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 如果没有登录,也就没有token</span></span><br><span class="line">    <span class="keyword">if</span> (whiteList.<span class="title function_">indexOf</span>(to.<span class="property">path</span>) &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">      <span class="comment">// 表示要去的地址在白名单中，放行</span></span><br><span class="line">      <span class="title function_">next</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 用户没有登录，访问的地址也不在白名单中，跳转到登录页面</span></span><br><span class="line">      <span class="title function_">next</span>(<span class="string">&quot;/login&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 后置守卫</span></span><br><span class="line">router.<span class="title function_">afterEach</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">NProgress</span>.<span class="title function_">done</span>(); <span class="comment">// -----------------------------关闭进度条</span></span><br><span class="line">  &#125;);</span><br><span class="line">  </span><br></pre></td></tr></table></figure>

<p>在最开始导入进度条插件，同时导入进度条所需要的样式。</p>
<p>在前置守卫中开启进度条</p>
<p>在后置守卫中关闭进度条。</p>
<p>返回到浏览器中进行测试。</p>
<h3 id="2、主页布局实现"><a href="#2、主页布局实现" class="headerlink" title="2、主页布局实现"></a>2、主页布局实现</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images%5C%E4%B8%BB%E9%A1%B5%E5%B8%83%E5%B1%80%E7%BB%93%E6%9E%84.png"></p>
<p>在<code>src</code>目录下面创建<code>layout</code>目录，在该目录下面创建<code>index.vue</code>组件，该组件中的代码如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;el-container class=&quot;el-container&quot;&gt;</span><br><span class="line">      &lt;el-header&gt;</span><br><span class="line">        &lt;div class=&quot;header-div&quot;&gt;</span><br><span class="line">          &lt;img src=&quot;@/assets/logo.png&quot; alt=&quot;logo&quot; /&gt;</span><br><span class="line">          &lt;span&gt;&lt;router-link to=&quot;/&quot;&gt;后台管理系统&lt;/router-link&gt;&lt;/span&gt;</span><br><span class="line">          &lt;el-button style=&quot;float: right&quot; type=&quot;info&quot;&gt;退出&lt;/el-button&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/el-header&gt;</span><br><span class="line">      &lt;el-container&gt;</span><br><span class="line">        &lt;el-aside :width=&quot;isCollapse ? &#x27;60px&#x27; : &#x27;200px&#x27;&quot;&gt;</span><br><span class="line">          &lt;div class=&quot;toggle-button&quot; @click=&quot;openCollapse&quot;&gt;|||&lt;/div&gt;</span><br><span class="line">          &lt;el-menu</span><br><span class="line">            active-text-color=&quot;#ffd04b&quot;</span><br><span class="line">            background-color=&quot;#545c64&quot;</span><br><span class="line">            class=&quot;el-menu-vertical-demo&quot;</span><br><span class="line">            default-active=&quot;2&quot;</span><br><span class="line">            text-color=&quot;#fff&quot;</span><br><span class="line">            @open=&quot;handleOpen&quot;</span><br><span class="line">            @close=&quot;handleClose&quot;</span><br><span class="line">          &gt;</span><br><span class="line">            &lt;el-sub-menu index=&quot;1&quot;&gt;</span><br><span class="line">              &lt;template #title&gt;</span><br><span class="line">                &lt;el-icon&gt;&lt;location /&gt;&lt;/el-icon&gt;</span><br><span class="line">                &lt;span&gt;Navigator One&lt;/span&gt;</span><br><span class="line">              &lt;/template&gt;</span><br><span class="line">              &lt;el-menu-item-group title=&quot;Group One&quot;&gt;</span><br><span class="line">                &lt;el-menu-item index=&quot;1-1&quot;&gt;item one&lt;/el-menu-item&gt;</span><br><span class="line">                &lt;el-menu-item index=&quot;1-2&quot;&gt;item one&lt;/el-menu-item&gt;</span><br><span class="line">              &lt;/el-menu-item-group&gt;</span><br><span class="line">              &lt;el-menu-item-group title=&quot;Group Two&quot;&gt;</span><br><span class="line">                &lt;el-menu-item index=&quot;1-3&quot;&gt;item three&lt;/el-menu-item&gt;</span><br><span class="line">              &lt;/el-menu-item-group&gt;</span><br><span class="line">              &lt;el-sub-menu index=&quot;1-4&quot;&gt;</span><br><span class="line">                &lt;template #title&gt;item four&lt;/template&gt;</span><br><span class="line">                &lt;el-menu-item index=&quot;1-4-1&quot;&gt;item one&lt;/el-menu-item&gt;</span><br><span class="line">              &lt;/el-sub-menu&gt;</span><br><span class="line">            &lt;/el-sub-menu&gt;</span><br><span class="line">            &lt;el-menu-item index=&quot;2&quot;&gt;</span><br><span class="line">              &lt;el-icon&gt;&lt;icon-menu /&gt;&lt;/el-icon&gt;</span><br><span class="line">              &lt;span&gt;Navigator Two&lt;/span&gt;</span><br><span class="line">            &lt;/el-menu-item&gt;</span><br><span class="line">            &lt;el-menu-item index=&quot;3&quot; disabled&gt;</span><br><span class="line">              &lt;el-icon&gt;&lt;document /&gt;&lt;/el-icon&gt;</span><br><span class="line">              &lt;span&gt;Navigator Three&lt;/span&gt;</span><br><span class="line">            &lt;/el-menu-item&gt;</span><br><span class="line">            &lt;el-menu-item index=&quot;4&quot;&gt;</span><br><span class="line">              &lt;el-icon&gt;&lt;setting /&gt;&lt;/el-icon&gt;</span><br><span class="line">              &lt;span&gt;Navigator Four&lt;/span&gt;</span><br><span class="line">            &lt;/el-menu-item&gt;</span><br><span class="line">          &lt;/el-menu&gt;</span><br><span class="line">        &lt;/el-aside&gt;</span><br><span class="line">        &lt;!-- 所单击菜单对应的组件在该位置进行展示 --&gt;</span><br><span class="line">        &lt;el-main&gt;&lt;router-view /&gt;&lt;/el-main&gt;</span><br><span class="line">      &lt;/el-container&gt;</span><br><span class="line">    &lt;/el-container&gt;</span><br><span class="line">  &lt;/template&gt;</span><br><span class="line">  &lt;script&gt;</span><br><span class="line">  import &#123; ref &#125; from &quot;vue&quot;;</span><br><span class="line">  export default &#123;</span><br><span class="line">    name: &quot;Layout&quot;,</span><br><span class="line">    setup() &#123;</span><br><span class="line">      const isCollapse = ref(false);</span><br><span class="line">      function openCollapse() &#123;</span><br><span class="line">        isCollapse.value = !isCollapse.value;</span><br><span class="line">      &#125;</span><br><span class="line">      return &#123;</span><br><span class="line">        isCollapse,</span><br><span class="line">        openCollapse,</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line">  &lt;/script&gt;</span><br><span class="line">  &lt;style&gt;</span><br><span class="line">  .el-container &#123;</span><br><span class="line">    height: 1000px;</span><br><span class="line">  &#125;</span><br><span class="line">  .el-aside &#123;</span><br><span class="line">    background-color: #333744;</span><br><span class="line">  &#125;</span><br><span class="line">  .el-main &#123;</span><br><span class="line">    background-color: #eaedf1;</span><br><span class="line">  &#125;</span><br><span class="line">  .el-header &#123;</span><br><span class="line">    background-color: #373d41;</span><br><span class="line">    color: #fff;</span><br><span class="line">    font-size: 20px;</span><br><span class="line">  &#125;</span><br><span class="line">  a &#123;</span><br><span class="line">    text-decoration: none;</span><br><span class="line">    color: #fff;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  .header-div img &#123;</span><br><span class="line">    /* 让文字在图片中间对齐 */</span><br><span class="line">    vertical-align: middle;</span><br><span class="line">    width: 60px;</span><br><span class="line">    height: 60px;</span><br><span class="line">    margin-right: 10px;</span><br><span class="line">  &#125;</span><br><span class="line">  .toggle-button &#123;</span><br><span class="line">    background-color: #4a5064;</span><br><span class="line">    font-size: 10px;</span><br><span class="line">    line-height: 24px;</span><br><span class="line">    color: #fff;</span><br><span class="line">    text-align: center;</span><br><span class="line">    letter-spacing: 0.2em;</span><br><span class="line">    cursor: pointer;</span><br><span class="line">  &#125;</span><br><span class="line">  &lt;/style&gt;</span><br><span class="line">  </span><br></pre></td></tr></table></figure>

<p>在上面的代码中指定了头部区域，左侧的区域。以及中间区域</p>
<p>左侧区域展示菜单，所以使用到了<code>menu</code>组件。</p>
<p>中间区域，会展示当单击了菜单后对应的组件。</p>
<p>同时通过<code>isCollapse</code>控制了左侧区域的显示与隐藏。</p>
<p>路由规则配置：</p>
<p>修改<code>router/index.js</code>文件中的代码，如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createRouter, createWebHashHistory &#125; <span class="keyword">from</span> <span class="string">&#x27;vue-router&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Layout</span> <span class="keyword">from</span> <span class="string">&#x27;@/layout&#x27;</span>  <span class="comment">//-------导入了layout组件</span></span><br><span class="line"><span class="keyword">const</span> routes = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">    <span class="attr">redirect</span>:<span class="string">&#x27;/dashboard&#x27;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="title class_">Layout</span>,</span><br><span class="line">    <span class="attr">children</span>:[ <span class="comment">//-----------配置子路由</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">path</span>:<span class="string">&#x27;dashboard&#x27;</span>,</span><br><span class="line">        <span class="attr">name</span>:<span class="string">&#x27;dashboard&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>:<span class="function">()=&gt;</span><span class="keyword">import</span>(<span class="string">&quot;@/views/dashboard/index&quot;</span>),</span><br><span class="line">        <span class="attr">meta</span>:&#123;<span class="attr">title</span>:<span class="string">&quot;首页&quot;</span>,<span class="attr">icon</span>:<span class="string">&#x27;dashboard&#x27;</span>&#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">   <span class="attr">path</span>:<span class="string">&#x27;/login&#x27;</span>,</span><br><span class="line">   <span class="attr">name</span>:<span class="string">&#x27;login&#x27;</span>,</span><br><span class="line">   <span class="attr">component</span>:<span class="function">()=&gt;</span><span class="keyword">import</span>(<span class="string">&quot;@/views/login/index.vue&quot;</span>)</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>

<p>在上面的代码中，导入了<code>Layout</code>组件，同时配置了相应的路由规则。</p>
<p>这里配置了子路由。</p>
<p>在<code>views</code>目录下面创建<code>dashboard</code>目录，在该目录下面创建<code>index.vue</code>组件，该组件中的初步代码如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;后台布局&lt;/template&gt;</span><br></pre></td></tr></table></figure>

<p>返回到浏览器中进行查看。</p>
<p>修改一下菜单(可以先将菜单修改成如下的形式)</p>
<h3 id="3、获取用户资料信息-前端实现"><a href="#3、获取用户资料信息-前端实现" class="headerlink" title="3、获取用户资料信息-前端实现"></a>3、获取用户资料信息-前端实现</h3><p>在登录成功后，可以将用户的信息返回。</p>
<p>当然，这里我们也可以再查询一次。</p>
<p>在前端<code>login/index.vue</code>组件的的<code>submit</code>方法中，我们可以先将用户的手机号码存储到<code>localStorage</code>中，然后根据手机号查询用户的信息。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">       <span class="keyword">await</span> store.<span class="title function_">dispatch</span>(<span class="string">&quot;user/userLogin&quot;</span>, loginForm);</span><br><span class="line">       <span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&quot;userPhone&quot;</span>,loginForm.<span class="property">userPhone</span>); <span class="comment">// 将用户的手机号存储到localStorage中</span></span><br><span class="line">           router.<span class="title function_">push</span>(<span class="string">&quot;/&quot;</span>);  </span><br><span class="line">     &#125;<span class="keyword">catch</span>(error)&#123;</span><br><span class="line">       <span class="variable language_">console</span>.<span class="title function_">log</span>(error)</span><br><span class="line">     &#125; <span class="keyword">finally</span>&#123;</span><br><span class="line">       loading.<span class="property">value</span> = <span class="literal">false</span>;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>

<p>下面要做的就是定义前端获取用户信息资料的<code>api</code>接口。</p>
<p>修改<code>api/user.js</code>文件中的代码，如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取用户的基本信息</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getUserInfo</span>(<span class="params">mobile</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">request</span>(<span class="string">&quot;/users?userPhone=&quot;</span>+mobile);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当调用上面的方法发送请求的时候，请求中需要带上<code>token</code>数据。而我们知道后期会有很多的<code>请求接口</code>都需要带上<code>token</code>信息，所以可以在请求拦截器中添加。修改<code>utils/request.js</code>文件中的代码:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> store <span class="keyword">from</span> <span class="string">&#x27;@/store&#x27;</span>;  <span class="comment">// -----导入store</span></span><br><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&#x27;axios&#x27;</span></span><br><span class="line"> <span class="comment">// 创建一个axios的实例</span></span><br><span class="line"><span class="keyword">const</span> service = axios.<span class="title function_">create</span>(&#123;</span><br><span class="line">    <span class="attr">baseURL</span>:process.<span class="property">env</span>.<span class="property">VUE_APP_BASE_API</span>,</span><br><span class="line">    <span class="attr">timeout</span>:<span class="number">5000</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// -----------请求拦截器</span></span><br><span class="line">service.<span class="property">interceptors</span>.<span class="property">request</span>.<span class="title function_">use</span>(</span><br><span class="line">  <span class="function">(<span class="params">config</span>)=&gt;</span>&#123;</span><br><span class="line">   <span class="keyword">if</span>(store.<span class="property">getters</span>.<span class="property">token</span>)&#123;</span><br><span class="line">     config.<span class="property">headers</span>[<span class="string">&quot;Authorization&quot;</span>]=<span class="string">`Bearer <span class="subst">$&#123;store.getters.token&#125;</span>`</span>;<span class="comment">// 注意 Bearer后面的空格。</span></span><br><span class="line">   &#125;</span><br><span class="line">    <span class="comment">// 一定要返回配置信息</span></span><br><span class="line">    <span class="keyword">return</span> config;</span><br><span class="line">  &#125;,<span class="function">(<span class="params">error</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(error);</span><br><span class="line">  &#125;</span><br><span class="line">); </span><br></pre></td></tr></table></figure>

<p>问题：在什么地方调用<code>api/user.js</code>文件中的<code>getUserInfo</code>方法发送请求呢？</p>
<p>我们知道，用户信息资料，会在很多组件中使用，所以是共享的数据。那么就应该存储到<code>vuex</code>中，所以需要在<code>actions</code>中发送请求。</p>
<p>下面修改<code>store/modules/user.js</code>文件中的代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">actions</span>: &#123;</span><br><span class="line">   <span class="comment">// 用户登录</span></span><br><span class="line">   <span class="keyword">async</span> <span class="title function_">userLogin</span>(<span class="params">context, payload</span>) &#123;</span><br><span class="line">     <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="title function_">login</span>(payload);</span><br><span class="line">       <span class="comment">// // axios默认给数据加了一层data</span></span><br><span class="line">     <span class="comment">//if (result.data.success) &#123;</span></span><br><span class="line">       context.<span class="title function_">commit</span>(<span class="string">&quot;setToken&quot;</span>, result);</span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">   &#125;,</span><br><span class="line">   <span class="comment">// -----------------获取用户资料信息</span></span><br><span class="line">   <span class="keyword">async</span> <span class="title function_">getUserInfo</span>(<span class="params">context</span>)&#123;</span><br><span class="line">     <span class="keyword">const</span> userPhone =<span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">&quot;userPhone&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="title function_">getUserInfo</span>(userPhone);</span><br><span class="line">     context.<span class="title function_">commit</span>(<span class="string">&quot;setUserInfo&quot;</span>,result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;,</span><br></pre></td></tr></table></figure>

<p>在<code>actions</code>中也定义了一个<code>getUserInfo</code>方法(从<code>localStorage</code>中获取用户的手机号，传递给该方法)，然后调用<code>api/user.js</code>文件中的<code>getUserInfo</code>方法，发送请求获取数据，将获取到的数据提交到<code>mutations</code>中的<code>setUserInfo</code>这个方法中，完成状态的更新。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; login, getUserInfo &#125; <span class="keyword">from</span> <span class="string">&quot;@/api/user&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>这里需要从<code>api/user.js</code>文件中导入<code>getUserInfo</code>方法。</p>
<p>下面要做的就是在<code>state</code>中定义状态，存储从服务端返回的用户信息。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">namespaced</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="title function_">state</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">token</span>: <span class="title function_">getTokenInfo</span>(), <span class="comment">// 获取token信息，初始化vuex</span></span><br><span class="line">      <span class="attr">userInfo</span>:&#123;&#125; <span class="comment">//-----------------存储用户的信息</span></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>

<p>在上面的代码中，定义了<code>userInfo</code>这个状态属性，默认值是一个空对象。为什么是空对象，而不是<code>null</code>呢？因为后面我们需要从该状态中获取具体的数据，例如用户名，如果<code>userInfo</code>没有获取到服务端的数据，并且默认值是<code>null</code>，哪么就会变成<code>null.name</code>，这样就出错了。</p>
<p>下面实现对应的<code>mutations</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">mutations</span>: &#123;</span><br><span class="line">  <span class="title function_">setToken</span>(<span class="params">state, payload</span>) &#123;</span><br><span class="line">    state.<span class="property">token</span> = payload; <span class="comment">// 将token信息保存到vuex容器中</span></span><br><span class="line">    <span class="title function_">setTokenInfo</span>(payload); <span class="comment">// 将token信息持久化到本地</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">removeToken</span>(<span class="params">state</span>) &#123;</span><br><span class="line">    state.<span class="property">token</span> = <span class="literal">null</span>; <span class="comment">// 清空vuex中的token信息</span></span><br><span class="line">    <span class="title function_">removeTokenInfo</span>(); <span class="comment">// 删除本地token信息</span></span><br><span class="line">  &#125;,</span><br><span class="line">      <span class="comment">// ------------------------保存用户信息</span></span><br><span class="line">  <span class="title function_">setUserInfo</span>(<span class="params">state,payload</span>)&#123;</span><br><span class="line">    state.<span class="property">userInfo</span> = payload;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// --------------------------------删除用户信息</span></span><br><span class="line">  <span class="title function_">removeUserInfo</span>(<span class="params">state</span>)&#123;</span><br><span class="line">    state.<span class="property">userInfo</span> =&#123;&#125;;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>在上面的<code>mutations</code>中定义了<code>setUserInfo</code>方法，将用户信息资料存储到了<code>userInfo</code>这个状态属性中。</p>
<p>同时，添加了一个<code>removeUserInfo</code>的方法，删除用户信息，这个会在后面退出的时候使用到。</p>
<p>下面在<code>getters</code>中创建关于用户信息的快捷访问。</p>
<p><strong>这里我们先创建对用户名的快捷访问。</strong></p>
<p>修改<code>store/getters.js</code>文件中的代码，如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> getters = &#123;</span><br><span class="line">    <span class="attr">token</span>: <span class="function">(<span class="params">state</span>) =&gt;</span> state.<span class="property">user</span>.<span class="property">token</span>,</span><br><span class="line">    <span class="attr">name</span>:<span class="function">(<span class="params">state</span>)=&gt;</span>state.<span class="property">user</span>.<span class="property">userInfo</span>.<span class="property">userName</span><span class="comment">//  访问user模块中的userInfo状态对象中的username属性的值(该属性是服务端返回的)</span></span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">export</span> <span class="keyword">default</span> getters;</span><br></pre></td></tr></table></figure>

<p>问题：在<code>actions</code>中的<code>getUserInfo</code>方法什么时候调用呢？</p>
<p>在下一小节中将实现对该方法的调用。</p>
<h3 id="4、获取用户资料信息2-前端实现"><a href="#4、获取用户资料信息2-前端实现" class="headerlink" title="4、获取用户资料信息2-前端实现"></a>4、获取用户资料信息2-前端实现</h3><p>在这一小节中，我们需要实现的就是对<code>store/modules/user.js</code>文件中定义的<code>getUserInfo</code>这个<code>actions</code>方法进行调用。</p>
<p>我们知道，调用该方法，会发送请求获取用户信息，而且请求头中必须有<code>token</code>信息才可以。</p>
<p>所以在调用<code>getUserInfo</code>这个<code>actions</code>方法的时候，必须确保已经获取到了<code>token</code>信息。</p>
<p>下面修改<code>src/permission.js</code>文件中的代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_">beforeEach</span>(<span class="title function_">async</span>(to,<span class="keyword">from</span>,)=&gt;&#123;</span><br><span class="line">    <span class="title class_">NProgress</span>.<span class="title function_">start</span>(); <span class="comment">// 开启进度条</span></span><br><span class="line">  <span class="comment">// 通过keys获取对象中的属性，返回值是一个数组，如果length大于0，表示对象中有属性，而不是一个空对象。</span></span><br><span class="line">  <span class="keyword">if</span> (store.<span class="property">getters</span>.<span class="property">token</span>!=<span class="literal">null</span>&amp;&amp; <span class="title class_">Object</span>.<span class="title function_">keys</span>(store.<span class="property">getters</span>.<span class="property">token</span>).<span class="property">length</span>) &#123;</span><br><span class="line">    <span class="comment">// 如果有token</span></span><br><span class="line">    <span class="keyword">if</span> (to.<span class="property">path</span> === <span class="string">&quot;/login&quot;</span>) &#123;</span><br><span class="line">      <span class="comment">// 如果访问的是登录页面，跳转到主页</span></span><br><span class="line">      <span class="title function_">next</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// -------------------判断是否能够获取到用户的编号</span></span><br><span class="line">      <span class="keyword">if</span>(!store.<span class="property">state</span>.<span class="property">user</span>.<span class="property">userInfo</span>.<span class="property">Id</span>)&#123;</span><br><span class="line">        <span class="keyword">await</span> store.<span class="title function_">dispatch</span>(<span class="string">&quot;user/getUserInfo&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="title function_">next</span>(); <span class="comment">// 放行</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br></pre></td></tr></table></figure>

<p>如果有<code>token</code>信息了，才会去获取用户的信息资料</p>
<p>同时是在用户访问其它页面的时候判断一下是否能够获取到用户的编号(<code>Id</code>是服务端返回的属性)，如果能够获取到说明<code>vuex</code>中已经存储了用户的信息资料，这里就没有必要发送请求了。</p>
<p>否则调用<code>user</code>模块中的<code>getUserInfo</code>这个<code>actions</code>方法进行请求的发送，获取用户的信息资料。</p>
<p>同时还需要注意一个问题，这里我们添加了<code>await</code>，含义就是一定是等待获取到了用户信息资料以后，才会执行<code>next()</code>方法，访问其它页面。</p>
<p>原因是，在其它页面中有可能会使用用户信息资料。如果这里不添加<code>await</code>，就会导致请求还没有结束，就执行了<code>next</code>方法，请求是异步的。</p>
<p>这里还有一个问题，就是用户的资料信息为什么没有存储到本地的<code>localStorage</code>中呢？</p>
<p>因为，我们是在<code>beforeEach</code>方法中发送请求，不管是刷新浏览器还是切换路由，都会重新发送请求来获取用户的资料信息，所以不需要存储到本地的<code>localStoreage</code>中。</p>
<p>下面，在头部展示用户名</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;span&gt;&lt;router-link to=&quot;/&quot;&gt;HR后台管理系统&lt;/router-link&gt;&lt;/span&gt;</span><br><span class="line">       &lt;span style=&quot;font-size: 16px; float: right&quot;&gt;&#123;&#123;</span><br><span class="line">         $store.getters.name</span><br><span class="line">       &#125;&#125;&lt;/span&gt;</span><br></pre></td></tr></table></figure>

<p>返回到浏览器中进行测试。</p>
<p>这里测试的时候，有可能<code>token</code>已经失效了，所以将本地存储的<code>token</code>信息删除，然后重新登录，监视请求。</p>
<h3 id="5、获取用户资料信息3–服务端接口实现"><a href="#5、获取用户资料信息3–服务端接口实现" class="headerlink" title="5、获取用户资料信息3–服务端接口实现"></a>5、获取用户资料信息3–服务端接口实现</h3><p>下面我们需要实现的就是服务端获取用户资料信息的接口。</p>
<p>创建<code>UsersController.cs</code>控制器，该控制器中的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[<span class="meta">Route(<span class="string">&quot;api/[controller]&quot;</span>)</span>]</span><br><span class="line">[<span class="meta">ApiController</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UsersController</span> : <span class="title">ControllerBase</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> IUserInfoService _userInfoService;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UsersController</span>(<span class="params">IUserInfoService userInfoService</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">this</span>._userInfoService = userInfoService;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    [<span class="meta">HttpGet</span>]</span><br><span class="line">    [<span class="meta">Authorize</span>]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">GetUserInfo</span>(<span class="params">[FromQuery]<span class="built_in">string</span> userPhone</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrWhiteSpace(userPhone))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> BadRequest(<span class="string">&quot;手机号不能为空&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="keyword">var</span> user = <span class="keyword">await</span>  _userInfoService.LoadEntities(u =&gt; u.UserPhone == userPhone).FirstOrDefaultAsync();</span><br><span class="line">        <span class="keyword">if</span>(user == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> BadRequest(<span class="string">&quot;没有查找到对应用户&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Ok(<span class="keyword">new</span> ApiResult&lt;UserInfo&gt;() &#123; Success = <span class="literal">true</span>, Message = <span class="string">&quot;获取用户成功&quot;</span>, Data = user &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接收前端传递过来的手机号码</p>
<p>然后根据手机号码查询用户的信息。</p>
<p>返回到浏览器中进行测试。</p>
<p>这里测试的时候，有可能<code>token</code>已经失效了，所以将本地存储的<code>token</code>信息删除，然后重新登录，监视请求。</p>
<p>当登录成功以后，可以看到顶部展示了用户名</p>
<p>下面将头像也展示出来。</p>
<h3 id="6、展示用户头像"><a href="#6、展示用户头像" class="headerlink" title="6、展示用户头像"></a>6、展示用户头像</h3><p>这里我们已经将登录的用户名展示出来了，下面展示用户的头像</p>
<p>第一:服务端设置</p>
<p>在<code>WebApi</code>项目中创建<code>wwwroot</code>目录，在该目录下面创建<code>images</code>文件夹，上传成功的图片都是存储在服务端的，也就是当前的<code>images</code>文件夹中。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">app.UseCors(MyAllowSpecificOrigins);</span><br><span class="line"></span><br><span class="line">app.UseStaticFiles();<span class="comment">// 处理静态资源</span></span><br><span class="line"></span><br><span class="line">app.UseAuthentication();</span><br></pre></td></tr></table></figure>

<p>同时在<code>Program.cs</code>文件中启用处理静态资源文件的中间件。</p>
<p>一定要将服务端项目重新启动。</p>
<p>第二：前端设置</p>
<p>我们知道，现在在前端已经获取到了登录成功的用户资料信息。</p>
<p>在用户资料信息中有一个属性是<code>photoUrl</code>,存储的是用户的头像地址。</p>
<p>所以这里，我们先修改<code>store/getter.js</code>文件中的代码，如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> getters = &#123;</span><br><span class="line">    <span class="attr">token</span>: <span class="function">(<span class="params">state</span>) =&gt;</span> state.<span class="property">user</span>.<span class="property">token</span>,</span><br><span class="line">    <span class="attr">name</span>:<span class="function">(<span class="params">state</span>)=&gt;</span>state.<span class="property">user</span>.<span class="property">userInfo</span>.<span class="property">userName</span>,</span><br><span class="line">    <span class="attr">photoUrl</span>:<span class="function">(<span class="params">state</span>)=&gt;</span>state.<span class="property">user</span>.<span class="property">userInfo</span>.<span class="property">photoUrl</span> <span class="comment">// 获取头像地址，建立用户头像的快捷访问，注意photoUrl是服务端返回的属性</span></span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">export</span> <span class="keyword">default</span> getters;</span><br></pre></td></tr></table></figure>

<p>这里了能够更好的获取用户的头像，可以把获取用户头像 的代码写到<code>getters</code>中，也就是建立<code>getters</code>的快捷访问的方式。</p>
<p>这里从<code>user</code>模块中找到<code>userInfo</code>对象，获取<code>photoUrl</code>属性的值，也就是头像的路径地址。</p>
<p>返回到<code>layout/index.vue</code>组件中，在头部区域展示登录成功的用户头像。</p>
<p>但是，问题是，我们这里获取到的<code>photoUrl</code>属性的值是数据库中存储的头像路径的地址，是相对路径，例如：<code>/images/f.jpg</code></p>
<p>而具体的图片文件是存储在服务端的，所以这里我们需要添加上服务端的地址，才能获取到真正的图片文件。</p>
<p><code>.env.development</code>文件，如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">port = 8888</span><br><span class="line"></span><br><span class="line"># 开发环境的基础地址和代理对应</span><br><span class="line">VUE_APP_BASE_API = &#x27;http://localhost:5105/api&#x27;</span><br><span class="line">VUE_APP_BASE_URL=&#x27;http://localhost:5105&#x27; # --------------这里通过该值获取服务端的地址，</span><br></pre></td></tr></table></figure>

<p>注意：一定要以<code>VUE_APP_</code>开头。</p>
<p>同时，<code>.env.production</code>文件中也添加该项</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 生产环境的基础地址和代理对应</span><br><span class="line">VUE_APP_BASE_API = &#x27;/api&#x27;</span><br><span class="line">VUE_APP_BASE_URL=&#x27;http://localhost:5105&#x27;</span><br></pre></td></tr></table></figure>

<p>下面返回到<code>layout/index.vue</code>中进行代码的修改：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; ref &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>;</span><br><span class="line"> <span class="keyword">import</span> &#123; useStore &#125; <span class="keyword">from</span> <span class="string">&quot;vuex&quot;</span>; <span class="comment">// 导入useStore</span></span><br><span class="line">  <span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;Layout&quot;</span>,</span><br><span class="line">    <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> isCollapse = <span class="title function_">ref</span>(<span class="literal">false</span>);</span><br><span class="line">      <span class="keyword">const</span> store = <span class="title function_">useStore</span>(); <span class="comment">// 创建store仓库对象</span></span><br><span class="line">     <span class="keyword">const</span> baseUrl = process.<span class="property">env</span>.<span class="property">VUE_APP_BASE_URL</span>; <span class="comment">// 获取图片所在的服务端地址</span></span><br><span class="line">     <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;baseUrl=&quot;</span>,baseUrl);</span><br><span class="line">     <span class="keyword">const</span> imgUrl = baseUrl+store.<span class="property">getters</span>.<span class="property">photoUrl</span>; <span class="comment">// 拼接完整的地址（这里直接通过Store容器对象获取getter中的photoUrl）</span></span><br><span class="line">      <span class="keyword">function</span> <span class="title function_">openCollapse</span>(<span class="params"></span>) &#123;</span><br><span class="line">        isCollapse.<span class="property">value</span> = !isCollapse.<span class="property">value</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        isCollapse,</span><br><span class="line">        openCollapse,</span><br><span class="line">        imgUrl <span class="comment">// 将拼接好的图片地址返回。</span></span><br><span class="line">      &#125;;</span><br></pre></td></tr></table></figure>

<p>下面看一下模版代码的修改</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;span style=&quot;font-size: 16px;color:darkred; float: right&quot;&gt;&#123;&#123;</span><br><span class="line">         $store.getters.name</span><br><span class="line">       &#125;&#125;&lt;/span&gt;</span><br><span class="line">        &lt;img :src=&quot;imgUrl&quot; style=&quot;float: right&quot; /&gt; &lt;!----添加img标签，其src属性动态绑定了imgUrl属性的值---&gt;</span><br><span class="line">         &lt;el-button style=&quot;float: right&quot; type=&quot;info&quot;&gt;退出&lt;/el-button&gt;</span><br></pre></td></tr></table></figure>

<p>注意：由于前端项目也修改了配置文件，也需要重新启动前端项目</p>
<p>返回浏览器中查看效果。</p>
<h3 id="7、用户退出登录"><a href="#7、用户退出登录" class="headerlink" title="7、用户退出登录"></a>7、用户退出登录</h3><p>在用户单击了<code>退出</code>按钮后，进行退出。</p>
<p>退出的时候需要删除用户的<code>token</code>以及<code>vuex</code>中存储的当前登录用户的信息。</p>
<p>修改<code>src/store/modules/user.js</code>文件中的代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 用户退出</span></span><br><span class="line">  <span class="title function_">logout</span>(<span class="params">context</span>)&#123;</span><br><span class="line">    <span class="comment">// 删除token信息</span></span><br><span class="line">    context.<span class="title function_">commit</span>(<span class="string">&quot;removeToken&quot;</span>);</span><br><span class="line">    <span class="comment">// 删除用户信息</span></span><br><span class="line">    context.<span class="title function_">commit</span>(<span class="string">&quot;removeUserInfo&quot;</span>);</span><br><span class="line">    <span class="comment">// 删除本地存储的手机号</span></span><br><span class="line">    <span class="variable language_">localStorage</span>.<span class="title function_">removeItem</span>(<span class="string">&quot;userPhone&quot;</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>在<code>actions</code>中定义了<code>logout</code>方法。</p>
<p>在该方法中提交了<code>removeToken</code>这个<code>mutations</code>方法，删除了<code>token</code>信息，这里不仅删除了<code>vuex</code>中存储的<code>token</code>信息，同时也删除了本地存储的<code>token</code>信息,以及本地存储的手机号码信息</p>
<p>关于<code>removeToken</code>这个<code>mutations</code>方法，在前面我们已经定义好了。</p>
<p>下面紧跟着提交了<code>removeUserInfo</code>这个<code>mutations</code>方法，删除了用户的资料信息，该方法在前面也已经定义了。</p>
<p>问题是<code>logout</code>这个<code>actions</code>方法在哪调用。</p>
<p>下面修改<code>layout/index.vue</code>组件中的代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;img :src=&quot;imgUrl&quot; style=&quot;float: right&quot; /&gt;</span><br><span class="line">         &lt;el-button style=&quot;float: right&quot; type=&quot;info&quot; @click=&quot;logout&quot;&gt;退出&lt;/el-button&gt;</span><br></pre></td></tr></table></figure>

<p>当单击了退出按钮的时候，调用上面所定义的<code>logout</code>这个<code>actions</code>方法。</p>
<p>所以这里我们先给<code>退出</code>按钮注册了单击事件，事件触发调用<code>logout</code>方法，下面在<code>setup</code>入口函数中实现该方法。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; ref &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; useStore &#125; <span class="keyword">from</span> <span class="string">&quot;vuex&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; useRouter &#125; <span class="keyword">from</span> <span class="string">&quot;vue-router&quot;</span>; <span class="comment">//------------------ 导入useRouter方法</span></span><br><span class="line"> <span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">   <span class="attr">name</span>: <span class="string">&quot;Layout&quot;</span>,</span><br><span class="line">   <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">     <span class="keyword">const</span> isCollapse = <span class="title function_">ref</span>(<span class="literal">false</span>);</span><br><span class="line">     <span class="keyword">const</span> store = <span class="title function_">useStore</span>();</span><br><span class="line">     <span class="keyword">const</span> router = <span class="title function_">useRouter</span>(); <span class="comment">// ----------------------------获取router实例</span></span><br><span class="line">    <span class="keyword">const</span> baseUrl = process.<span class="property">env</span>.<span class="property">VUE_APP_BASE_URL</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;baseUrl=&quot;</span>,baseUrl);</span><br><span class="line">    <span class="keyword">const</span> imgUrl = baseUrl+store.<span class="property">getters</span>.<span class="property">photoUrl</span>;</span><br><span class="line">     <span class="keyword">function</span> <span class="title function_">openCollapse</span>(<span class="params"></span>) &#123;</span><br><span class="line">       isCollapse.<span class="property">value</span> = !isCollapse.<span class="property">value</span>;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">//------------------------ 用户退出登录</span></span><br><span class="line">     <span class="keyword">const</span> <span class="title function_">logout</span>=(<span class="params"></span>)=&gt;&#123;</span><br><span class="line">        <span class="title class_">ElMessageBox</span>.<span class="title function_">confirm</span>(<span class="string">&quot;确定要退出系统吗？&quot;</span>,<span class="string">&quot;退出系统&quot;</span>,&#123;</span><br><span class="line">         <span class="attr">confirmButtonText</span>:<span class="string">&quot;确定&quot;</span>,</span><br><span class="line">         <span class="attr">cancelButtonText</span>:<span class="string">&quot;取消&quot;</span>,</span><br><span class="line">         <span class="attr">type</span>:<span class="string">&quot;questions&quot;</span></span><br><span class="line">        &#125;).<span class="title function_">then</span>(<span class="function">()=&gt;</span>&#123; <span class="comment">// ------------------ // 单击`确定`按钮会执行then</span></span><br><span class="line">            <span class="comment">// ---------------- // 执行了user模块中`actions`中定义的`logout`方法</span></span><br><span class="line">            <span class="comment">//  由于在user模块中的logout这个`actions`方法中没有进行异步操作，所以这里不需要添加await</span></span><br><span class="line">         store.<span class="title function_">dispatch</span>(<span class="string">&quot;user/logout&quot;</span>);</span><br><span class="line">            <span class="comment">//  进行跳转，跳转到登录页面。</span></span><br><span class="line">         router.<span class="title function_">push</span>(<span class="string">&quot;/login&quot;</span>);</span><br><span class="line">         <span class="title class_">ElMessage</span>(&#123;<span class="attr">type</span>:<span class="string">&#x27;success&#x27;</span>,<span class="attr">message</span>:<span class="string">&#x27;退出成功&#x27;</span>&#125;);</span><br><span class="line">        &#125;)</span><br><span class="line">        .<span class="title function_">catch</span>(<span class="function">()=&gt;</span>&#123; <span class="comment">//------------------单击`取消`按钮会执行catch</span></span><br><span class="line">         <span class="title class_">ElMessage</span>(&#123;</span><br><span class="line">           <span class="attr">type</span>:<span class="string">&#x27;info&#x27;</span>,</span><br><span class="line">           <span class="attr">message</span>:<span class="string">&#x27;取消退出&#x27;</span></span><br><span class="line">         &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> &#123;</span><br><span class="line">       isCollapse,</span><br><span class="line">       openCollapse,</span><br><span class="line">       imgUrl,</span><br><span class="line">       logout</span><br><span class="line">     &#125;;</span><br><span class="line">   &#125;,</span><br></pre></td></tr></table></figure>

<p>进行测试。</p>
<h3 id="8、Token失效的处理"><a href="#8、Token失效的处理" class="headerlink" title="8、Token失效的处理"></a>8、<code>Token</code>失效的处理</h3><p><strong>服务端处理</strong></p>
<p>问题：我们知道在登录的时候，我们创建的<code>token</code>数据，并且设置了过期时间，问题是，怎样判断<code>token</code>过期了呢？</p>
<p>这里我们需要注册事件，修改<code>Program.cs</code>文件中的代码</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注入jwt的认证服务（这里采用默认的认证）</span></span><br><span class="line">builder.Services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme).AddJwtBearer(options =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 获取配置文件中存储的密钥</span></span><br><span class="line">    <span class="keyword">var</span> secretByte = Encoding.UTF8.GetBytes(builder.Configuration[<span class="string">&quot;Authentication:SecretKey&quot;</span>]!);</span><br><span class="line">    options.TokenValidationParameters = <span class="keyword">new</span> TokenValidationParameters()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 验证token的发布者</span></span><br><span class="line">        ValidateIssuer = <span class="literal">true</span>,</span><br><span class="line">        ValidIssuer = builder.Configuration[<span class="string">&quot;Authentication:Issuer&quot;</span>],</span><br><span class="line">        <span class="comment">// 验证token的持有者</span></span><br><span class="line">        ValidateAudience = <span class="literal">true</span>,</span><br><span class="line">        ValidAudience = builder.Configuration[<span class="string">&quot;Authentication:Audience&quot;</span>],</span><br><span class="line">        <span class="comment">// 验证toen是否过期</span></span><br><span class="line">        ValidateLifetime = <span class="literal">true</span>,</span><br><span class="line">        ClockSkew = TimeSpan.Zero,</span><br><span class="line">        <span class="comment">// 使用私钥</span></span><br><span class="line">        IssuerSigningKey = <span class="keyword">new</span> SymmetricSecurityKey(secretByte)</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// --------------------------------------jwt 过期后触发该事件。</span></span><br><span class="line">    options.Events = <span class="keyword">new</span> JwtBearerEvents &#123;</span><br><span class="line">        <span class="comment">// 授权失败</span></span><br><span class="line">        OnAuthenticationFailed = context =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 错误的类型是token过期</span></span><br><span class="line">            <span class="keyword">if</span> (context.Exception.GetType() == <span class="keyword">typeof</span>(SecurityTokenExpiredException))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">/* context.Response.Headers.Add();*/</span></span><br><span class="line">                </span><br><span class="line">                context.Response.Headers.Add(<span class="string">&quot;Access-Control-Expose-Headers&quot;</span>, <span class="string">&quot;act&quot;</span>);</span><br><span class="line">                context.HttpContext.Response.Headers.Add(<span class="string">&quot;act&quot;</span>, <span class="string">&quot;expired&quot;</span>);</span><br><span class="line">                context.Response.Headers.AccessControlAllowOrigin = <span class="string">&quot;*&quot;</span>; <span class="comment">// 防止出现跨域的问题</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>  Task.CompletedTask;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>在上面的代码中，当授权失败以后，判断错误的类型是否是<code>token</code>过期，如果是<code>token</code>过期，这里会向前端返回<code>act</code>这个响应头，该响应头的值是<code>expired</code>，当然，该响应头大家可以随意命名。目的是，将自定义<code>act</code>这个响应头返回到前端以后，前端获取到该响应头并判断其值是<code>expired</code>，表示的是<code>token</code>过期了，这样前端路由就可以跳转到登录页面。</p>
<p>但是这里有一个问题：要想前端的<code>axios</code>获取到自定义的响应头<code>act</code>,需要添加<code>Access-Control-Expose-Headers</code>,它的值是<code>act</code>这个自定义的响应头，这样前端的<code>axios</code>就可以过去该自定义的响应头了。</p>
<p>为了进行测试，我们修改一下<code>LoginController</code>这个控制器中创建的<code>token</code>的过期时间，</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> token = <span class="keyword">new</span> JwtSecurityToken(</span><br><span class="line">               <span class="comment">// 谁发布的token数据，一般是服务端的地址</span></span><br><span class="line">               issuer: configuration[<span class="string">&quot;Authentication:Issuer&quot;</span>],</span><br><span class="line">                <span class="comment">// 把token数据发布给谁，一般就是前端项目，这里也可以填写服务端的地址，或者不填写也可以</span></span><br><span class="line">                audience: configuration[<span class="string">&quot;Authentication:Audience&quot;</span>],</span><br><span class="line">               claims,</span><br><span class="line">               <span class="comment">// 发布时间</span></span><br><span class="line">               notBefore: DateTime.Now,</span><br><span class="line">               <span class="comment">// 有效期</span></span><br><span class="line">               expires: DateTime.Now.AddSeconds(<span class="number">30</span>), <span class="comment">//--------------------这里为了进行测试，将过期时间设置为了30秒</span></span><br><span class="line">               <span class="comment">// 数字签名</span></span><br><span class="line">               signingCredentials</span><br><span class="line"></span><br><span class="line">               );</span><br></pre></td></tr></table></figure>

<p>这里关于过期时间在强调一下，如果不设置<code>token</code>的过期时间，默认过期时间是5分钟，当然，即使过期的时间到了，也不会马上失效，而是再过5分钟才会失效。</p>
<p>但是，这里我们为了方便测试，在<code>Program.cs</code>中修改了配置。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注入jwt的认证服务（这里采用默认的认证）</span></span><br><span class="line">builder.Services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme).AddJwtBearer(options =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 获取配置文件中存储的密钥</span></span><br><span class="line">    <span class="keyword">var</span> secretByte = Encoding.UTF8.GetBytes(builder.Configuration[<span class="string">&quot;Authentication:SecretKey&quot;</span>]!);</span><br><span class="line">    options.TokenValidationParameters = <span class="keyword">new</span> TokenValidationParameters()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 验证token的发布者</span></span><br><span class="line">        ValidateIssuer = <span class="literal">true</span>,</span><br><span class="line">        ValidIssuer = builder.Configuration[<span class="string">&quot;Authentication:Issuer&quot;</span>],</span><br><span class="line">        <span class="comment">// 验证token的持有者</span></span><br><span class="line">        ValidateAudience = <span class="literal">true</span>,</span><br><span class="line">        ValidAudience = builder.Configuration[<span class="string">&quot;Authentication:Audience&quot;</span>],</span><br><span class="line">        <span class="comment">// 验证toen是否过期</span></span><br><span class="line">        ValidateLifetime = <span class="literal">true</span>,</span><br><span class="line">        ClockSkew = TimeSpan.Zero, <span class="comment">// ------------------------这里将ClockSkew属性的值设置为了0时，表示token有效时间到期后，立马生效。</span></span><br><span class="line">        <span class="comment">// 使用私钥</span></span><br><span class="line">        IssuerSigningKey = <span class="keyword">new</span> SymmetricSecurityKey(secretByte)</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>

<p>在上面的<code>jwt</code>的认证配置中，我们添加了<code>ClockSkew</code>属性，该属性的值设置为了<code>TimeSpan.Zero</code></p>
<p>表示的含义就是<code>token</code>到期后就失效，没有缓冲期。</p>
<p>以上是服务端的配置。</p>
<p>下面看一下前端代码的修改</p>
<p><strong>前端处理</strong></p>
<p>修改<code>utils/request.js</code>文件中的代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 响应拦截器</span></span><br><span class="line">service.<span class="property">interceptors</span>.<span class="property">response</span>.<span class="title function_">use</span>( </span><br><span class="line">     <span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// axios 默认添加了一层data</span></span><br><span class="line">  <span class="comment">//  console.log(&#x27;data =&#x27;,response.data);</span></span><br><span class="line">    <span class="keyword">const</span> &#123; success, message, data &#125; = response.<span class="property">data</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (success) &#123;</span><br><span class="line">      <span class="keyword">return</span> data;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 业务已经错误了（例如输入的手机号或者是密码是错误的），需要给出错误提示，并且应该进入catch</span></span><br><span class="line">      <span class="title class_">ElMessage</span>.<span class="title function_">error</span>(message);</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(message));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function">(<span class="params">error</span>) =&gt;</span> &#123; <span class="comment">//-----------------错误的处理</span></span><br><span class="line">   <span class="keyword">if</span>(error.<span class="property">response</span>&amp;&amp; error.<span class="property">response</span>.<span class="property">headers</span>[<span class="string">&quot;act&quot;</span>]&amp;&amp;error.<span class="property">response</span>.<span class="property">headers</span>[<span class="string">&quot;act&quot;</span>]===<span class="string">&#x27;expired&#x27;</span>)&#123;</span><br><span class="line">    store.<span class="title function_">dispatch</span>(<span class="string">&quot;user/logout&quot;</span>); <span class="comment">// 退出操作</span></span><br><span class="line">      router.<span class="title function_">push</span>(<span class="string">&quot;/login&quot;</span>);</span><br><span class="line">   &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title class_">ElMessage</span>.<span class="title function_">error</span>(error.<span class="property">message</span>);</span><br><span class="line">   &#125;</span><br><span class="line">     <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(error); <span class="comment">// 返回执行错误，让当前的执行链跳出成功，直接进行入catch</span></span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p>在上面的代码中，我们修改了响应拦截器中的代码</p>
<p>如果服务端返回的内容有错误，会执行响应拦截器中错误的处理程序，在这里判断<code>error.response</code>对象中是否有<code>act</code>这个响应头，并且该响应头的值是否是<code>expired</code>，如果条件成立，则表示服务端的<code>token</code>信息过期了，这里我们需要退出登录，并且重新跳转到登录页面。</p>
<p>如果以上条件不满足，这里我们只是通过<code>ElMessage</code>这个组件展示错误信息就可以了。</p>
<p>启动项目进行测试，这里可以先将以前登录所保存的<code>localStorage</code>中信息删除，重新进行登录后，等待30秒钟后重新刷新浏览器进行测试。</p>
<h2 id="四、路由与菜单模块"><a href="#四、路由与菜单模块" class="headerlink" title="四、路由与菜单模块"></a>四、路由与菜单模块</h2><h3 id="1、路由说明"><a href="#1、路由说明" class="headerlink" title="1、路由说明"></a>1、路由说明</h3><p>简单项目中的路由设置</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images%5C%E7%AE%80%E5%8D%95%E9%A1%B9%E7%9B%AE%E8%B7%AF%E7%94%B1%E8%A7%84%E5%88%99.png"></p>
<p>当前项目结构</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images%5C%E5%A4%8D%E6%9D%82%E9%A1%B9%E7%9B%AE%E8%B7%AF%E7%94%B1%E8%A7%84%E5%88%99.png"></p>
<p>为什么要拆成若干个路由模块呢？ </p>
<p>因为复杂项目的页面众多，不可能把所有的业务都集中在一个文件上进行管理和维护，并且还有最重要的，前端的页面中主要分为两部分，一部分是所有人都可以访问的， 一部分是只有有权限的人才可以访问的，拆分多个模块便于更好的控制</p>
<p>这里我们将所有用户都可以访问的路由称作<strong>静态路由</strong></p>
<p>而具有了一定的权限才能访问的路由就是<strong>动态路由</strong></p>
<p>**<code>注意</code>**这里的动态路由并不是 <strong>路由传参</strong>的动态路由</p>
<p>最后，在路由中把<code>404</code>规则添加上。</p>
<p>修改<code>router/index.js</code>文件中的路由规则，如下 所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&quot;/login&quot;</span>,</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;Login&quot;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&quot;@/views/login/index.vue&quot;</span>),</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&quot;/404&quot;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&quot;../views/404.vue&quot;</span>),</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&quot;/:pathMatch(.*)*&quot;</span>, <span class="comment">// 没有其他的路由规则相匹配</span></span><br><span class="line">    <span class="attr">redirect</span>: <span class="string">&quot;/404&quot;</span>,</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>

<p>在上面的代码中，需要指定<code>404</code>路由规则。</p>
<p>在<code>views</code>目录下面创建<code>404.vue</code></p>
<p>返回到浏览器中进行测试。</p>
<h3 id="2、前端项目模块说明"><a href="#2、前端项目模块说明" class="headerlink" title="2、前端项目模块说明"></a>2、前端项目模块说明</h3><p>下面，我们将本项目中所要做的模块快速搭建相应的页面和路由</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">├── dashboard           <span class="comment"># 首页</span></span><br><span class="line">├── login               <span class="comment"># 登录</span></span><br><span class="line">├── 404                 <span class="comment"># 404</span></span><br><span class="line">├── departments         <span class="comment"># 组织架构</span></span><br><span class="line">├── employees           <span class="comment"># 员工</span></span><br><span class="line">├── setting             <span class="comment"># 公司设置</span></span><br><span class="line">├── salarys             <span class="comment"># 工资</span></span><br><span class="line">├── social              <span class="comment"># 社保</span></span><br><span class="line">├── attendances         <span class="comment"># 考勤</span></span><br><span class="line">├── approvals           <span class="comment"># 审批</span></span><br><span class="line">├── permission          <span class="comment"># 权限管理</span></span><br></pre></td></tr></table></figure>

<p>根据上图中的结构，在views目录下，建立对应的目录，给每个模块新建一个**<code>index.vue</code>**，作为每个模块的主页</p>
<p><strong>快速新建文件夹</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir departments employees setting salarys social attendances approvals permission</span><br></pre></td></tr></table></figure>

<p>注意：找到项目中的<code>views</code>文件夹，按住<code>ctrl</code>键右击，在弹出的快捷菜单中选择<code>Git Bash Here</code>，执行以上创建文件夹的命令。(在<code>win11</code>中以上命令有问题)</p>
<p>每个模块的内容，可以先按照标准的模板建立，如</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;dashboard-container&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;app-container&quot;&gt;</span><br><span class="line">      &lt;h2&gt;</span><br><span class="line">        员工</span><br><span class="line">      &lt;/h2&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">export default &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style&gt;</span><br><span class="line"></span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<p>根据以上的标准建立好对应页面之后，接下来建立每个模块的路由规则</p>
<p>路由模块目录结构</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">├── router               <span class="comment"># 路由目录</span></span><br><span class="line"> ├── index.js            <span class="comment"># 路由主文件</span></span><br><span class="line"> ├── modules             <span class="comment"># 模块目录</span></span><br><span class="line">  ├── departments.js     <span class="comment"># 组织架构</span></span><br><span class="line">  ├── employees.js       <span class="comment"># 员工 </span></span><br><span class="line">  ├── setting.js         <span class="comment"># 公司设置</span></span><br><span class="line">  ├── salarys.js         <span class="comment"># 工资</span></span><br><span class="line">  ├── social.js          <span class="comment"># 社保</span></span><br><span class="line">  ├── attendances.js     <span class="comment"># 考勤</span></span><br><span class="line">  ├── approvals.js       <span class="comment"># 审批</span></span><br><span class="line">  ├── permission.js      <span class="comment"># 权限管理</span></span><br></pre></td></tr></table></figure>

<h3 id="3、设置每个模块的路由规则"><a href="#3、设置每个模块的路由规则" class="headerlink" title="3、设置每个模块的路由规则"></a>3、设置每个模块的路由规则</h3><p>每个模块导出的内容表示该模块下的路由规则</p>
<p>如果员工的路由规则:<code>router/modules/employees.js</code>文件中的代码，如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导出员工的路由规则</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Layout</span> <span class="keyword">from</span> <span class="string">&quot;@/layout&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">path</span>: <span class="string">&quot;/employees&quot;</span>, <span class="comment">// 路由地址</span></span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;employees&quot;</span>, <span class="comment">// 给模块的一级路由设置一个name属性，后面设置权限的时候会使用到（注意这里如果只是给父级添加name属性在浏览器的控制台中会给出警告信息，为了解决这个问题，也需要在下面的子路由中添加name，当然这里可以先暂时的将name属性去掉，后面讲解到权限的时候在添加）</span></span><br><span class="line">    <span class="comment">// 都采用了Layout组件中的布局</span></span><br><span class="line">  <span class="attr">component</span>: <span class="title class_">Layout</span>,</span><br><span class="line">  <span class="attr">children</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">path</span>: <span class="string">&quot;&quot;</span>, <span class="comment">// 这里写成一个空字符串，当访问的地址是`/employees`的时候，不但会展示layout布局页面，而会展示下面component中指定的页面</span></span><br><span class="line">      <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&quot;@/views/employees&quot;</span>),</span><br><span class="line">      <span class="comment">// 路由元信息，可以存储任何的数据</span></span><br><span class="line">      <span class="attr">meta</span>: &#123;</span><br><span class="line">        <span class="attr">title</span>: <span class="string">&quot;员工管理&quot;</span>, <span class="comment">// 这里保存的是title,目的：会读取该属性作为左侧的菜单项。</span></span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>上述代码中，我们用到了meta属性，该属性为一个对象，里面可放置自定义属性，主要用于读取一些配置和参数，并且值得**<code>注意</code><strong>的是：我们的meta写在了二级默认路由上面，而不是一级路由，因为当存在二级路由的时候，访问当前路由信息访问的就是</strong><code>二级默认路由</code>**</p>
<h3 id="4、路由合并"><a href="#4、路由合并" class="headerlink" title="4、路由合并"></a>4、路由合并</h3><p> 将静态路由和动态路由的路由表进行临时合并</p>
<p>什么叫临时合并？</p>
<p>在第一个小节中，我们讲过了，动态路由是需要权限进行访问的，但是权限的动态路由访问是很复杂的，我们稍后在进行讲解，所以为了更好地看到效果，我们可以先将 静态路由和动态路由进行合并</p>
<p>修改<code>src/router/index.js</code>文件中的代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createRouter, createWebHashHistory &#125; <span class="keyword">from</span> <span class="string">&#x27;vue-router&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Layout</span> <span class="keyword">from</span> <span class="string">&#x27;@/layout&#x27;</span></span><br><span class="line"><span class="keyword">import</span> employeesRouter <span class="keyword">from</span> <span class="string">&#x27;./modules/employees&#x27;</span>  <span class="comment">// -----------------导入员工的路由信息</span></span><br><span class="line"><span class="keyword">const</span> routes = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">    <span class="attr">redirect</span>:<span class="string">&#x27;/dashboard&#x27;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="title class_">Layout</span>,</span><br><span class="line">    <span class="attr">children</span>:[</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">path</span>:<span class="string">&#x27;dashboard&#x27;</span>,</span><br><span class="line">        <span class="attr">name</span>:<span class="string">&#x27;dashboard&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>:<span class="function">()=&gt;</span><span class="keyword">import</span>(<span class="string">&quot;@/views/dashboard/index&quot;</span>),</span><br><span class="line">        <span class="attr">meta</span>:&#123;<span class="attr">title</span>:<span class="string">&quot;首页&quot;</span>,<span class="attr">icon</span>:<span class="string">&#x27;dashboard&#x27;</span>&#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">   <span class="attr">path</span>:<span class="string">&#x27;/login&#x27;</span>,</span><br><span class="line">   <span class="attr">name</span>:<span class="string">&#x27;login&#x27;</span>,</span><br><span class="line">   <span class="attr">component</span>:<span class="function">()=&gt;</span><span class="keyword">import</span>(<span class="string">&quot;@/views/login/index.vue&quot;</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&quot;/404&quot;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&quot;../views/404.vue&quot;</span>),</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&quot;/:pathMatch(.*)*&quot;</span>, <span class="comment">// 没有其他的路由规则相匹配</span></span><br><span class="line">    <span class="attr">redirect</span>: <span class="string">&quot;/404&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/about&#x27;</span>,</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;about&#x27;</span>,</span><br><span class="line">    <span class="comment">// route level code-splitting</span></span><br><span class="line">    <span class="comment">// this generates a separate chunk (about.[hash].js) for this route</span></span><br><span class="line">    <span class="comment">// which is lazy-loaded when the route is visited.</span></span><br><span class="line">    <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="comment">/* webpackChunkName: &quot;about&quot; */</span> <span class="string">&#x27;../views/AboutView.vue&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line"><span class="comment">// -------------------------// 动态路由（将导入的动态路由规则对象放到数组中）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> asyncRoutes =[</span><br><span class="line">  employeesRouter</span><br><span class="line">];</span><br><span class="line"><span class="keyword">const</span> router = <span class="title function_">createRouter</span>(&#123;</span><br><span class="line">  <span class="attr">history</span>: <span class="title function_">createWebHashHistory</span>(),</span><br><span class="line">  <span class="attr">routes</span>:[...routes,...asyncRoutes]  <span class="comment">// 把routes数组中存储的静态路由规则对象与asyncRoutes数组中存储的动态路由规则对象进行合并。</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>首先导入模块中定义的动态路由规则</p>
<p>然后定义一个<code>asyncRoutes</code>数组，数组中存储的就是定义的动态路由规则对象，</p>
<p>在<code>createRouter</code>中将静态路由规则和动态路由规则进行合并。</p>
<p>可以在浏览器中输入：<code>http://localhost:8888/#/employees</code>来进行访问。</p>
<h3 id="5、菜单展示"><a href="#5、菜单展示" class="headerlink" title="5、菜单展示"></a>5、菜单展示</h3><p>在这一小节中，我们将所有路由规则中的<code>meta</code>中的<code>title</code>属性的值获取到，然后将其作为左侧的菜单项。</p>
<p>先修改<code>router/index.js</code>文件中的代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> routes = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">    <span class="attr">redirect</span>:<span class="string">&#x27;/dashboard&#x27;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="title class_">Layout</span>,</span><br><span class="line">    <span class="attr">children</span>:[</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">path</span>:<span class="string">&#x27;dashboard&#x27;</span>,</span><br><span class="line">        <span class="attr">name</span>:<span class="string">&#x27;dashboard&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>:<span class="function">()=&gt;</span><span class="keyword">import</span>(<span class="string">&quot;@/views/dashboard/index&quot;</span>),</span><br><span class="line">        <span class="attr">meta</span>:&#123;<span class="attr">title</span>:<span class="string">&quot;首页&quot;</span>,<span class="attr">icon</span>:<span class="string">&#x27;dashboard&#x27;</span>&#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">   <span class="attr">path</span>:<span class="string">&#x27;/login&#x27;</span>,</span><br><span class="line">   <span class="attr">name</span>:<span class="string">&#x27;login&#x27;</span>,</span><br><span class="line">   <span class="attr">hidden</span>: <span class="literal">true</span>, <span class="comment">// -------------------------------------hiddren属性值为true</span></span><br><span class="line">   <span class="attr">component</span>:<span class="function">()=&gt;</span><span class="keyword">import</span>(<span class="string">&quot;@/views/login/index.vue&quot;</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&quot;/404&quot;</span>,</span><br><span class="line">   <span class="attr">hidden</span>: <span class="literal">true</span>, <span class="comment">// ----------------------------------------hiddren属性值为true</span></span><br><span class="line">    <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&quot;../views/404.vue&quot;</span>),</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&quot;/:pathMatch(.*)*&quot;</span>, <span class="comment">// 没有其他的路由规则相匹配</span></span><br><span class="line">    <span class="attr">redirect</span>: <span class="string">&quot;/404&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/about&#x27;</span>,</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;about&#x27;</span>,</span><br><span class="line">    <span class="comment">// route level code-splitting</span></span><br><span class="line">    <span class="comment">// this generates a separate chunk (about.[hash].js) for this route</span></span><br><span class="line">    <span class="comment">// which is lazy-loaded when the route is visited.</span></span><br><span class="line">    <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="comment">/* webpackChunkName: &quot;about&quot; */</span> <span class="string">&#x27;../views/AboutView.vue&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>在上面定义的<code>静态路由</code>规则中，每个路由规则都添加了<code>hiddren</code>属性，并且该属性的取值为<code>true</code>.</p>
<p>设置为<code>true</code>的目的表示该项不会在左侧进行展示，也就是不是菜单项。</p>
<p>下面修改<code>src/layout/index.vue</code>组件中的代码，如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> isCollapse = <span class="title function_">ref</span>(<span class="literal">false</span>);</span><br><span class="line">      <span class="keyword">const</span> store = <span class="title function_">useStore</span>();</span><br><span class="line">      <span class="keyword">const</span> router = <span class="title function_">useRouter</span>(); </span><br><span class="line">      <span class="keyword">let</span> routes = <span class="title function_">ref</span>([]);<span class="comment">// -----定义routes数组，用来存储路由规则的信息</span></span><br></pre></td></tr></table></figure>

<p>在<code>setup</code>入口函数中，定义<code>routes</code>数组，该数组中会存储<code>获取到的路由规则信息</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">import</span> &#123; ref,computed &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>; <span class="comment">// 这里需要导入computed</span></span><br><span class="line">routes = <span class="title function_">computed</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> router.<span class="property">options</span>.<span class="property">routes</span>;</span><br><span class="line">      &#125;)</span><br><span class="line">    <span class="comment">//  console.log(&quot;routes = &quot;,routes);</span></span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        isCollapse,</span><br><span class="line">        openCollapse,</span><br><span class="line">        imgUrl,</span><br><span class="line">        logout,</span><br><span class="line">        routes <span class="comment">// 返回</span></span><br><span class="line">      &#125;;</span><br></pre></td></tr></table></figure>

<p>这里添加了计算属性，在计算属性中通过<code>router</code>对象中的<code>options</code>中的<code>routes</code>属性获取对应的路由规则信息，然后将这些信息存储到了<code>rotues</code>这个数组中，并且返回。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-menu</span><br><span class="line">           active-text-color=&quot;#ffd04b&quot;</span><br><span class="line">           background-color=&quot;#545c64&quot;</span><br><span class="line">           class=&quot;el-menu-vertical-demo&quot;</span><br><span class="line">           default-active=&quot;2&quot;</span><br><span class="line">           text-color=&quot;#fff&quot;</span><br><span class="line">           @open=&quot;handleOpen&quot;</span><br><span class="line">           @close=&quot;handleClose&quot;</span><br><span class="line">         &gt;</span><br><span class="line">         &lt;template v-for=&quot;route in routes&quot; &gt;</span><br><span class="line">           &lt;el-menu-item v-if=&quot;!route.hidden &amp;&amp; route.children&quot; :index=&quot;route.path&quot; &gt;</span><br><span class="line">             &lt;el-icon&gt;&lt;icon-menu /&gt;&lt;/el-icon&gt;</span><br><span class="line">             &lt;span&gt;</span><br><span class="line">               &lt;router-link :to=&quot;route.path&quot;&gt;</span><br><span class="line">               &#123;&#123; route.children[0].meta.title &#125;&#125;</span><br><span class="line">             &lt;/router-link&gt;</span><br><span class="line">             &lt;/span&gt;</span><br><span class="line">           &lt;/el-menu-item&gt;</span><br><span class="line">         </span><br><span class="line">         &lt;/template&gt;</span><br><span class="line">         &lt;/el-menu&gt;</span><br></pre></td></tr></table></figure>

<p>这里在<code>el-menu-item</code>上面添加了<code>template</code>标签，对<code>routes</code>进行遍历，然后在<code>el-menu-item</code>组件上添加判断，判断<code>hidden</code>是否为<code>false</code>，并且是否有<code>children</code>，该条件满足，展示<code>router-link</code>组件，并且该组件中展示的就是<code>路由规则</code>中的<code>title</code>属性的值</p>
<p>返回到浏览器中进行查看。</p>
<h3 id="6、菜单图标处理"><a href="#6、菜单图标处理" class="headerlink" title="6、菜单图标处理"></a>6、菜单图标处理</h3><p><strong>第一：在<code>src</code>目录下面创建<code>icons</code>目录，在该目录下面创建<code>svg</code>目录，将图标拷贝到该目录下面。</strong></p>
<p><strong>第二：修改<code>src/router/index.js</code>文件中的代码：</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">    <span class="attr">redirect</span>:<span class="string">&#x27;/dashboard&#x27;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="title class_">Layout</span>,</span><br><span class="line">    <span class="attr">children</span>:[</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">path</span>:<span class="string">&#x27;dashboard&#x27;</span>,</span><br><span class="line">        <span class="attr">name</span>:<span class="string">&#x27;dashboard&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>:<span class="function">()=&gt;</span><span class="keyword">import</span>(<span class="string">&quot;@/views/dashboard/index&quot;</span>),</span><br><span class="line">        <span class="attr">meta</span>:&#123;<span class="attr">title</span>:<span class="string">&quot;首页&quot;</span>,<span class="attr">icon</span>:<span class="string">&#x27;dashboard&#x27;</span>&#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>

<p>这里给首页的<code>meta</code>中添加了<code>icon</code>属性，该属性的取值就是<code>图标的名称</code>。</p>
<p><strong>下面需要给<code>router/modules</code>目录下面的所有的模块中的<code>meta</code>都添加<code>icon</code>属性，指定图标的名称。</strong></p>
<p>对应的关系如下所示（模块对应的<code>icon</code>图标名称）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">├── dashboard           <span class="comment"># dashboard</span></span><br><span class="line">├── departments         <span class="comment"># tree</span></span><br><span class="line">├── employees           <span class="comment"># people</span></span><br><span class="line">├── setting             <span class="comment"># setting</span></span><br><span class="line">├── salarys             <span class="comment"># money</span></span><br><span class="line">├── social              <span class="comment"># table</span></span><br><span class="line">├── attendances         <span class="comment"># skill</span></span><br><span class="line">├── approvals           <span class="comment"># tree-table</span></span><br><span class="line">├── permission          <span class="comment"># lock</span></span><br></pre></td></tr></table></figure>

<p><strong>第三：在<code>src/icons/</code>目录下面创建<code>index.js</code>文件</strong></p>
<p>该文件中的代码如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 下面三行代码的任务是 把 同级目录的 svg目录下的.svg图片引入到项目中来</span></span><br><span class="line"><span class="comment">// 第一个参数表示要查找的目录地址</span></span><br><span class="line"><span class="comment">// 第二个参数：表示是否查找子目录</span></span><br><span class="line"><span class="comment">// 第三个参数：正则表达式，匹配对应的文件</span></span><br><span class="line"><span class="keyword">const</span> req = <span class="built_in">require</span>.<span class="title function_">context</span>(<span class="string">&quot;./svg&quot;</span>, <span class="literal">false</span>, <span class="regexp">/\.svg$/</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">requireAll</span> = (<span class="params">requireContext</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> result = requireContext.<span class="title function_">keys</span>().<span class="title function_">map</span>(requireContext);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">requireAll(req);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 相当于把svg下的所有的svg图片打包到了项目中</span></span><br><span class="line"><span class="comment">// 如果想用svg图片 就在svg目录下去寻找就可以了</span></span><br></pre></td></tr></table></figure>

<p>什么时候执行上面的代码，把<code>svg</code>目录下的图标文件打包到项目中呢？</p>
<p>在<code>main.js</code>这个入口文件中。</p>
<p>修改<code>main.js</code>文件中的代码如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> store <span class="keyword">from</span> <span class="string">&#x27;./store&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;./permission&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@/icons&quot;</span>; <span class="comment">// ------------icon</span></span><br></pre></td></tr></table></figure>

<p>导入<code>ioncs</code>，这时候会执行该目录下的<code>index.js</code>文件</p>
<p> <strong>第四：创建图标组件</strong></p>
<p>在项目中需要多次使用图标，可以将其单独的封装成一个公共的组件。</p>
<p>所以在<code>src/components</code>目录下面创建<code>SvgIcon</code>目录，在该目录下面创建<code>index.vue</code>文件，该文件中的代码如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;svg :class=&quot;className&quot; aria-hidden=&quot;true&quot;&gt;</span><br><span class="line">      &lt;use :xlink:href=&quot;&#x27;#icon-&#x27; + `$&#123;iconClass&#125;`&quot; /&gt;</span><br><span class="line">    &lt;/svg&gt;</span><br><span class="line">  &lt;/template&gt;</span><br><span class="line">  </span><br><span class="line">  &lt;script&gt;</span><br><span class="line">  // import &#123; computed &#125; from &quot;vue&quot;;</span><br><span class="line">  export default &#123;</span><br><span class="line">    name: &quot;SvgIcon&quot;,</span><br><span class="line">    props: &#123;</span><br><span class="line">      iconClass: &#123;</span><br><span class="line">        type: String,</span><br><span class="line">        required: true,</span><br><span class="line">      &#125;,</span><br><span class="line">      className: &#123;</span><br><span class="line">        type: String,</span><br><span class="line">        default: &quot;svg-icon&quot;,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  </span><br><span class="line">  &#125;;</span><br><span class="line">  &lt;/script&gt;</span><br><span class="line">  </span><br><span class="line">  &lt;style scoped&gt;</span><br><span class="line">  .svg-icon &#123;</span><br><span class="line">    width: 1em;</span><br><span class="line">    height: 1em;</span><br><span class="line">    vertical-align: -0.15em;</span><br><span class="line">    fill: currentColor;</span><br><span class="line">    overflow: hidden;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  .svg-external-icon &#123;</span><br><span class="line">    background-color: currentColor;</span><br><span class="line">    mask-size: cover !important;</span><br><span class="line">    display: inline-block;</span><br><span class="line">  &#125;</span><br><span class="line">  &lt;/style&gt;</span><br></pre></td></tr></table></figure>

<p>当使用上面的图标组件的时候可以传递<code>className</code>，如果不传递默认是<code>svg-icon.</code></p>
<p>该组件中的重点就是使用了<code>svg</code>标签，然后通过内部的标签<code>use</code>标签的指定要插入的图标。这里通过<code>iconClass</code>接收传递过来的图标名称。</p>
<p>问题：怎样使用该图标组件？</p>
<p>在<code>src/layout/index.vue</code>文件中使用该图标组件。原因是在<code>layout</code>中使用了菜单组件。</p>
<p>思考：由于公共组件使用比较频繁，如果每次使用都导入比较麻烦，所以可以完成统一的注册。</p>
<p>在<code>src/components</code>目录下面创建<code>index.js</code>文件，该文件中的代码如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">SvgIcon</span> <span class="keyword">from</span> <span class="string">&quot;@/components/SvgIcon&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="title function_">install</span>(<span class="params">app</span>) &#123;</span><br><span class="line">    app.<span class="title function_">component</span>(<span class="title class_">SvgIcon</span>.<span class="property">name</span>, <span class="title class_">SvgIcon</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里导入了图标组件，并且导入一个对象，该对象中有一个<code>install</code>方法（注意必须是<code>install</code>方法），这里相当于做了一个插件，插件可以扩展<code>vue</code>的功能。而插件中必须有<code>install</code>方法，参数是应用实例。这里调用了应用实例中的<code>component</code>方法，进行组件的注册。第一个参数表示要注册的组件的名称，这里获取了其<code>name</code>属性，所以要求定义公共组件的时候，一定要有<code>name</code>名称。第二个参数就是要注册的组件。</p>
<p>问题：以上<code>install</code>方法什么时候被调用呢？</p>
<p>在<code>main.js</code>文件中进行代码的修改</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;@/icons&quot;</span>; </span><br><span class="line"><span class="keyword">import</span> <span class="variable constant_">UI</span> <span class="keyword">from</span> <span class="string">&quot;@/components/index&quot;</span>;</span><br><span class="line"><span class="title function_">createApp</span>(<span class="title class_">App</span>).<span class="title function_">use</span>(store).<span class="title function_">use</span>(router).<span class="title function_">use</span>(<span class="variable constant_">UI</span>).<span class="title function_">mount</span>(<span class="string">&#x27;#app&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里导入了<code>components/index</code>，然后<code>use</code>到了<code>app</code>这个应用实例上。</p>
<p>这样到项目启动后，公共组件都挂载到了<code>app</code>这个应用实例上了，也就是完成了组件的注册。</p>
<p>下面使用该图标组件。</p>
<p>在<code>src/layout/index.vue</code>文件中使用以上图标组件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;template v-for=&quot;route in routes&quot; &gt;</span><br><span class="line">           &lt;el-menu-item v-if=&quot;!route.hidden &amp;&amp; route.children&quot; :index=&quot;route.path&quot; &gt;</span><br><span class="line">             &lt;el-icon&gt;&lt;SvgIcon :iconClass=&quot;route.children[0].meta.icon&quot;  &lt;!--使用SvgIcon组件---&gt;</span><br><span class="line">               /&gt;&lt;/el-icon&gt;</span><br><span class="line">             &lt;span&gt;</span><br><span class="line">               &lt;router-link :to=&quot;route.path&quot;&gt;</span><br><span class="line">               &#123;&#123; route.children[0].meta.title &#125;&#125;</span><br><span class="line">             &lt;/router-link&gt;</span><br><span class="line">             &lt;/span&gt;</span><br><span class="line">           &lt;/el-menu-item&gt;</span><br><span class="line">         </span><br><span class="line">         &lt;/template&gt;</span><br></pre></td></tr></table></figure>

<p>在<code>layout/index.vue</code>中不需要导入图标组件，直接使用就可以了。</p>
<p>这里指定了<code>inconClass</code>，属性。其值就是所获取到的在<code>路由规则中定义的meta</code>对象中的<code>icon</code>属性。</p>
<p><strong>第五：配置<code>loader</code></strong></p>
<p>这里需要安装第三方包,解析<code>svg</code>文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install svg-sprite-loader </span><br></pre></td></tr></table></figure>

<p>修改<code>vue.config.js</code>文件中的配置：</p>
<p>代码如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; defineConfig &#125; = <span class="built_in">require</span>(<span class="string">&#x27;@vue/cli-service&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> path =<span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">resolve</span>(<span class="params">dir</span>)&#123;</span><br><span class="line">  <span class="comment">// __dirname：获取绝对路径</span></span><br><span class="line">  <span class="keyword">return</span> path.<span class="title function_">join</span>(__dirname,dir)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>导入<code>path</code>,定义<code>resolve</code>方法，拼接目录</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="attr">transpileDependencies</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">lintOnSave</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">chainWebpack</span>: <span class="function">(<span class="params">config</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 第一项配置</span></span><br><span class="line">    config.<span class="title function_">plugin</span>(<span class="string">&quot;html&quot;</span>).<span class="title function_">tap</span>(<span class="function">(<span class="params">args</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">//  console.log(&quot;args===&quot;, args);</span></span><br><span class="line">        <span class="comment">// // args相当于 html模板中 htmlWebpackplugin.options</span></span><br><span class="line">      args[<span class="number">0</span>].<span class="property">title</span> = <span class="string">&quot;人力资源管理平台&quot;</span>; <span class="comment">// 这里修改了网站的标题</span></span><br><span class="line">      <span class="keyword">return</span> args;</span><br><span class="line">    &#125;);</span><br><span class="line">   <span class="comment">// 第二项配置</span></span><br><span class="line">    config.<span class="property">module</span>.<span class="title function_">rule</span>(<span class="string">&quot;svg&quot;</span>).<span class="property">exclude</span>.<span class="title function_">add</span>(<span class="title function_">resolve</span>(<span class="string">&quot;src/icons&quot;</span>)).<span class="title function_">end</span>();</span><br><span class="line">    config.<span class="property">module</span></span><br><span class="line">      .<span class="title function_">rule</span>(<span class="string">&quot;icons&quot;</span>)</span><br><span class="line">      .<span class="title function_">test</span>(<span class="regexp">/\.svg$/</span>)</span><br><span class="line">      .<span class="property">include</span>.<span class="title function_">add</span>(<span class="title function_">resolve</span>(<span class="string">&quot;src/icons&quot;</span>))</span><br><span class="line">      .<span class="title function_">end</span>()</span><br><span class="line">      .<span class="title function_">use</span>(<span class="string">&quot;svg-sprite-loader&quot;</span>)</span><br><span class="line">      .<span class="title function_">loader</span>(<span class="string">&quot;svg-sprite-loader&quot;</span>)</span><br><span class="line">      .<span class="title function_">options</span>(&#123;</span><br><span class="line">        <span class="attr">symbolId</span>: <span class="string">&quot;icon-[name]&quot;</span>,  <span class="comment">// 注意这里添加了`icon`前缀，所以在定义图标组件的时候  &lt;use :xlink:href=&quot;&#x27;#icon-&#x27; + `$&#123;iconClass&#125;`&quot; /&gt;这里也添加了icon前缀，注意#不能省略。</span></span><br><span class="line">      &#125;)</span><br><span class="line">      .<span class="title function_">end</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>

<p>在<code>chainWebpack</code>中完成对<code>svg</code>的配置。</p>
<p>由于修改了配置文件需要重新启动项目</p>
<p>返回到浏览器中进行测试。</p>
<h2 id="五、组织架构模块"><a href="#五、组织架构模块" class="headerlink" title="五、组织架构模块"></a>五、组织架构模块</h2><h3 id="1、组织架构简介"><a href="#1、组织架构简介" class="headerlink" title="1、组织架构简介"></a>1、组织架构简介</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images%5C%E7%BB%84%E7%BB%87%E6%9E%B6%E6%9E%841.png"></p>
<h3 id="2、组织架构头部布局"><a href="#2、组织架构头部布局" class="headerlink" title="2、组织架构头部布局"></a>2、组织架构头部布局</h3><p>通过上图可以看到，头部分为两部分，左侧是公司的名称，右侧是负责人</p>
<p>这里我们可以使用<code>element-plus</code>中的<code>Layout</code>布局组件进行布局。</p>
<p>修改<code>src/views/departments/index.vue</code>文件中的代码，如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;div class=&quot;dashboard-container&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;app-container&quot;&gt;</span><br><span class="line">      &lt;!-- 组织架构--头部布局 --&gt;</span><br><span class="line">      &lt;el-card&gt;</span><br><span class="line">        &lt;el-row&gt;</span><br><span class="line">          &lt;el-col  :span=&quot;12&quot;&gt;  &lt;!--span表示宽度--&gt;</span><br><span class="line">            &lt;span&gt;xx教育集团&lt;/span&gt;</span><br><span class="line">          &lt;/el-col&gt;</span><br><span class="line">          &lt;el-col  :span=&quot;12&quot;&gt;123&lt;/el-col&gt;</span><br><span class="line">        &lt;/el-row&gt;</span><br><span class="line">      &lt;/el-card&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>

<p><code>el-card</code>就是一个<code>div</code></p>
<p><code>el-row:表示行</code> </p>
<p><code>el-col</code>表示列</p>
<p>上面一行中分为了两部分</p>
<p>但是以上<code>123</code>的内容没有在右侧。</p>
<p>下面，我们查看一下该页面的效果。</p>
<p>需要配置路由, 按照前面的方式进行配置</p>
<p>在<code>src/router/modules</code>目录下面创建<code>departments.js</code>文件，该文件中的代码如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导出部门的路由规则</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Layout</span> <span class="keyword">from</span> <span class="string">&quot;@/layout&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">path</span>: <span class="string">&quot;/departments&quot;</span>, <span class="comment">// 路由地址</span></span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;departments&quot;</span>, <span class="comment">// </span></span><br><span class="line">  <span class="attr">component</span>: <span class="title class_">Layout</span>,</span><br><span class="line">  <span class="attr">children</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">path</span>: <span class="string">&quot;&quot;</span>, <span class="comment">// 这里写成一个空字符串，当访问的地址是`/permission`的时候，不但会展示layout布局页面，而会展示下面component中指定的页面</span></span><br><span class="line">      <span class="attr">name</span>:<span class="string">&#x27;departmentsChild&#x27;</span>,</span><br><span class="line">      <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&quot;@/views/departments&quot;</span>),</span><br><span class="line">      <span class="comment">// 路由元信息，可以存储任何的数据</span></span><br><span class="line">      <span class="attr">meta</span>: &#123;</span><br><span class="line">        <span class="attr">title</span>: <span class="string">&quot;部门管理&quot;</span>, <span class="comment">// 这里保存的是title,目的：会读取作该属性作为左侧的菜单项。</span></span><br><span class="line">        <span class="attr">icon</span>:<span class="string">&quot;tree&quot;</span> <span class="comment">// 部门显示的图标</span></span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>下面在<code>src/router</code>中<code>index.js</code>文件中添加如下代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Layout</span> <span class="keyword">from</span> <span class="string">&#x27;@/layout&#x27;</span></span><br><span class="line"><span class="keyword">import</span> employeesRouter <span class="keyword">from</span> <span class="string">&#x27;./modules/employees&#x27;</span></span><br><span class="line"><span class="keyword">import</span> departmentsRouter <span class="keyword">from</span> <span class="string">&#x27;./modules/departments&#x27;</span> <span class="comment">// 导入departmentsRouter</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 动态路由</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> asyncRoutes =[</span><br><span class="line">  employeesRouter,</span><br><span class="line">  departmentsRouter <span class="comment">// 添加departmentsRouter</span></span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<p>返回到浏览器中查看效果。</p>
<p>下面需要指定对齐方式</p>
<p>这里给第二列又添加了<code>el-row</code>指定了<code>end</code>对齐方式。在右侧展示内容。<code>justify</code>属性只能用在<code>el-row</code>组件上。</p>
<p>右侧内容又分为两列。展示<code>负责人</code>以及下拉框。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 组织架构--头部布局 --&gt;</span><br><span class="line">  &lt;el-card&gt;</span><br><span class="line">    &lt;el-row&gt;</span><br><span class="line">      &lt;el-col  :span=&quot;20&quot;&gt;  &lt;!--这里调整了宽度--&gt;</span><br><span class="line">        &lt;span&gt;xx教育集团&lt;/span&gt;</span><br><span class="line">      &lt;/el-col&gt;</span><br><span class="line">      &lt;el-col  :span=&quot;4&quot;&gt;&lt;!--这里调整了宽度--&gt;</span><br><span class="line">      &lt;el-row  justify =&quot;end&quot;&gt;</span><br><span class="line">        &lt;el-col :span=&quot;12&quot;&gt;负责人&lt;/el-col&gt;</span><br><span class="line">        &lt;el-col :span=&quot;12&quot;&gt;</span><br><span class="line">            &lt;el-dropdown&gt;</span><br><span class="line">              &lt;span class=&quot;el-dropdown-link&quot;&gt;</span><br><span class="line">                操作</span><br><span class="line">                &lt;el-icon class=&quot;el-icon--right&quot;&gt;</span><br><span class="line">                  &lt;ArrowDown /&gt;</span><br><span class="line">                &lt;/el-icon&gt;</span><br><span class="line">              &lt;/span&gt;</span><br><span class="line">              &lt;!-- 下拉菜单 --&gt;</span><br><span class="line">              &lt;template #dropdown&gt;</span><br><span class="line">                &lt;el-dropdown-menu&gt;</span><br><span class="line">                  &lt;el-dropdown-item&gt;添加子部门&lt;/el-dropdown-item&gt;</span><br><span class="line">                &lt;/el-dropdown-menu&gt;</span><br><span class="line">              &lt;/template&gt;</span><br><span class="line">            &lt;/el-dropdown&gt;</span><br><span class="line">          &lt;/el-col&gt;</span><br><span class="line">      &lt;/el-row&gt;</span><br><span class="line">    &lt;/el-col&gt;</span><br><span class="line">    &lt;/el-row&gt;</span><br><span class="line">  &lt;/el-card&gt;</span><br></pre></td></tr></table></figure>

<p>这里在<code>操作</code>旁边使用了<code>ArrowDown</code>图标。</p>
<p>这里需要安装图标组件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install @element-plus/icons-vue</span><br></pre></td></tr></table></figure>

<p>然后在<code>main.js</code>文件中进行图标的<code>注册</code>。(参考文档：’<a target="_blank" rel="noopener" href="https://element-plus.gitee.io/zh-CN/component/icon.html">https://element-plus.gitee.io/zh-CN/component/icon.html</a>‘)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="variable constant_">UI</span> <span class="keyword">from</span> <span class="string">&quot;@/components/index&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> <span class="title class_">ElementPlusIconsVue</span> <span class="keyword">from</span> <span class="string">&#x27;@element-plus/icons-vue&#x27;</span>; <span class="comment">// 导入所有图标</span></span><br><span class="line"><span class="keyword">const</span> app =<span class="title function_">createApp</span>(<span class="title class_">App</span>);</span><br><span class="line"><span class="comment">// 完成图标的注册操作</span></span><br><span class="line"><span class="keyword">for</span>( <span class="keyword">const</span>[key,component] <span class="keyword">of</span> <span class="title class_">Object</span>.<span class="title function_">entries</span>(<span class="title class_">ElementPlusIconsVue</span>) )&#123;</span><br><span class="line">    app.<span class="title function_">component</span>(key,component);</span><br><span class="line">&#125;</span><br><span class="line">app.<span class="title function_">use</span>(store).<span class="title function_">use</span>(router).<span class="title function_">use</span>(<span class="variable constant_">UI</span>).<span class="title function_">mount</span>(<span class="string">&#x27;#app&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在上面的代码中使用到了<code>dropdown</code>组件，官方地址如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://element-plus.gitee.io/zh-CN/component/dropdown.html#%E5%9F%BA%E7%A1%80%E7%94%A8%E6%B3%95</span><br></pre></td></tr></table></figure>

<h3 id="3、树形组件基本使用"><a href="#3、树形组件基本使用" class="headerlink" title="3、树形组件基本使用"></a>3、树形组件基本使用</h3><p>通过前面的介绍，我们知道在展示组织结构信息时需要用到树形组件，这里我们先来看一下树形组件的基本使用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://element-plus.gitee.io/zh-CN/component/tree.html</span><br></pre></td></tr></table></figure>

<p>修改<code>views/departments/index.vue</code>文件中的代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">  &lt;/el-row&gt;</span><br><span class="line">  &lt;!-- 添加树形组件 --&gt;</span><br><span class="line">  &lt;el-tree :data=&quot;data&quot; :props=&quot;defaultProps&quot; /&gt;</span><br><span class="line">&lt;/el-card&gt;</span><br></pre></td></tr></table></figure>

<p>在原有的<code>el-row</code>组件下面添加了<code>el-tree</code>这个组件</p>
<p><code>data</code>属性表示该树形组件所展示的数据。</p>
<p>数据的定义如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">import</span> &#123; reactive &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> data = <span class="title function_">reactive</span>([</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">label</span>: <span class="string">&quot;hello&quot;</span>,</span><br><span class="line">        <span class="attr">children</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">label</span>: <span class="string">&quot;hello1&quot;</span>,</span><br><span class="line">          &#125;,</span><br><span class="line">        ],</span><br><span class="line">      &#125;,</span><br><span class="line">    ]);</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      data,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>这里定义了响应式对象<code>data</code>.</p>
<p>该对象的默认值是一个数组，数组中存储了一个对象，包含了<code>label</code>（表示树形结构中展示的文本节点），以及<code>children</code>属性（该属性也是一个数组，表示子节点）。</p>
<p>返回到浏览器中查看效果。</p>
<p>但是如果将上面的数据修改成如下的结构：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> data = <span class="title function_">reactive</span>([</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">title</span>: <span class="string">&quot;hello&quot;</span>,</span><br><span class="line">        <span class="attr">child</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">title</span>: <span class="string">&quot;hello1&quot;</span>,</span><br><span class="line">          &#125;,</span><br><span class="line">        ],</span><br><span class="line">      &#125;,</span><br><span class="line">    ]);</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      data,</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>

<p>这里的将原来的<code>label</code>修改成了<code>title</code>，将原来的<code>children</code>修改成了<code>child</code>，返回到浏览器中，发现不展示对应的树形结构了。</p>
<p>如果想展示需要定义<code>props</code>属性的值<code>defaultProps</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">   <span class="keyword">const</span> data = <span class="title function_">reactive</span>([</span><br><span class="line">     &#123;</span><br><span class="line">       <span class="attr">title</span>: <span class="string">&quot;hello&quot;</span>,</span><br><span class="line">       <span class="attr">child</span>: [</span><br><span class="line">         &#123;</span><br><span class="line">           <span class="attr">title</span>: <span class="string">&quot;hello1&quot;</span>,</span><br><span class="line">         &#125;,</span><br><span class="line">       ],</span><br><span class="line">     &#125;,</span><br><span class="line">   ]);</span><br><span class="line">   <span class="keyword">const</span> defaultProps = &#123;</span><br><span class="line">     <span class="attr">children</span>: <span class="string">&quot;child&quot;</span>,</span><br><span class="line">     <span class="attr">label</span>: <span class="string">&quot;title&quot;</span>,</span><br><span class="line">   &#125;;</span><br><span class="line">   <span class="keyword">return</span> &#123;</span><br><span class="line">     data,</span><br><span class="line">     defaultProps,</span><br><span class="line">   &#125;;</span><br><span class="line"> &#125;,</span><br></pre></td></tr></table></figure>

<p>上面定义了<code>defaultProps</code>对象，该对象中添加了<code>label</code>属性和<code>children</code>属性。</p>
<p><code>label</code>属性的取值为<code>title</code>，表示展示的文本节点来自<code>title</code></p>
<p><code>children</code>属性的取值为<code>child</code>，表示子节点来自<code>child</code>。</p>
<p>返回到浏览器中进行测试，发现树形结构可以展示。</p>
<p>注意：<code>defaultProps</code>对象中的<code>label</code>属性默认值是<code>label</code>，<code>children</code>属性默认值是<code>children</code>.</p>
<p>所以我们也可以不在树形组件中添加<code>props</code>属性并且指定其值为<code>defaultProps</code>。</p>
<p>只需要在创建数据结构的时候，使用<code>label</code>和<code>children</code>就可以了。</p>
<h3 id="4、树形组件构建组织架构"><a href="#4、树形组件构建组织架构" class="headerlink" title="4、树形组件构建组织架构"></a>4、树形组件构建组织架构</h3><p>在上一小节中，我们了解了树形组件的基本使用。</p>
<p>但是结构不是我们想要的，这里会使用到树形组件中的自定义节点内容，地址如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://element-plus.gitee.io/zh-CN/component/tree.html#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%8A%82%E7%82%B9%E5%86%85%E5%AE%B9</span><br></pre></td></tr></table></figure>

<p>树形结构如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 添加树形组件 --&gt;</span><br><span class="line">&lt;!--这里的data关联的数据是departs,同时添加default-expand-all属性，让树形默认全部展开--&gt;</span><br><span class="line">        &lt;el-tree :data=&quot;departs&quot; :props=&quot;defaultProps&quot; default-expand-all&gt;</span><br><span class="line">          &lt;template #default=&quot;&#123; node, data &#125;&quot;&gt; &lt;!--解构出传递给作用域插槽中的数据，data是每个节点的数据对象---&gt;</span><br><span class="line">            &lt;el-row style=&quot;height: 40px; width: 100%&quot; align=&quot;middle&quot;&gt;&lt;!--这里展示的结构与头部类似，所以将头部中使用的el-row直接拷贝到当前的树形组件中，然后进行调整。同时这里设置了el-row的高度与宽度 以及垂直居中---&gt;</span><br><span class="line">              &lt;el-col :span=&quot;20&quot;&gt;</span><br><span class="line">                &lt;span&gt;&#123;&#123; data.name &#125;&#125;&lt;/span&gt;</span><br><span class="line">              &lt;/el-col&gt;</span><br><span class="line">              &lt;el-col :span=&quot;4&quot;&gt;</span><br><span class="line">                &lt;el-row justify=&quot;end&quot;&gt;</span><br><span class="line">                  &lt;el-col :span=&quot;12&quot;&gt;&#123;&#123; data.manager &#125;&#125;&lt;/el-col&gt;</span><br><span class="line">                  &lt;el-col :span=&quot;12&quot;&gt;</span><br><span class="line">                    &lt;el-dropdown&gt;</span><br><span class="line">                      &lt;span class=&quot;el-dropdown-link&quot;&gt;</span><br><span class="line">                        操作</span><br><span class="line">                        &lt;el-icon class=&quot;el-icon--right&quot;&gt;</span><br><span class="line">                          &lt;ArrowDown /&gt;</span><br><span class="line">                        &lt;/el-icon&gt;</span><br><span class="line">                      &lt;/span&gt;</span><br><span class="line">                      &lt;!-- 下拉菜单 --&gt;</span><br><span class="line">                      &lt;template #dropdown&gt;</span><br><span class="line">                        &lt;el-dropdown-menu&gt;</span><br><span class="line">                          &lt;el-dropdown-item&gt;添加子部门&lt;/el-dropdown-item&gt;</span><br><span class="line">                          &lt;el-dropdown-item&gt;编辑部门&lt;/el-dropdown-item&gt;</span><br><span class="line">                          &lt;el-dropdown-item&gt;删除部门&lt;/el-dropdown-item&gt;</span><br><span class="line">                        &lt;/el-dropdown-menu&gt;</span><br><span class="line">                      &lt;/template&gt;</span><br><span class="line">                    &lt;/el-dropdown&gt;</span><br><span class="line">                  &lt;/el-col&gt;</span><br><span class="line">                &lt;/el-row&gt;</span><br><span class="line">              &lt;/el-col&gt;</span><br><span class="line">            &lt;/el-row&gt;</span><br><span class="line">          &lt;/template&gt;</span><br><span class="line">        &lt;/el-tree&gt;</span><br></pre></td></tr></table></figure>

<p>数据结构调整成如下的形式：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> departs = <span class="title function_">reactive</span>([</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&quot;总裁办&quot;</span>,</span><br><span class="line">        <span class="attr">manager</span>: <span class="string">&quot;曹操&quot;</span>,</span><br><span class="line">        <span class="attr">children</span>: [&#123; <span class="attr">name</span>: <span class="string">&quot;董事会&quot;</span>, <span class="attr">manager</span>: <span class="string">&quot;曹丕&quot;</span> &#125;],</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123; <span class="attr">name</span>: <span class="string">&quot;行政部&quot;</span>, <span class="attr">manager</span>: <span class="string">&quot;刘备&quot;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">name</span>: <span class="string">&quot;人事部&quot;</span>, <span class="attr">manager</span>: <span class="string">&quot;孙权&quot;</span> &#125;,</span><br><span class="line">    ]);</span><br><span class="line">    <span class="keyword">const</span> defaultProps = &#123;</span><br><span class="line">      <span class="attr">children</span>: <span class="string">&quot;children&quot;</span>,</span><br><span class="line">      <span class="attr">label</span>: <span class="string">&quot;name&quot;</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      departs,</span><br><span class="line">      defaultProps,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>返回到浏览器中进行测试</p>
<h3 id="5、将树形结构单独封装成组件"><a href="#5、将树形结构单独封装成组件" class="headerlink" title="5、将树形结构单独封装成组件"></a>5、将树形结构单独封装成组件</h3><p>通过上一小节，我们发现整个<strong>组织架构的顶部与具体内容展示的结构是一样的</strong>，所以这里可以单独的抽离出一个组件。</p>
<p>在<code>src/views/departments</code>目录下面创建一个<code>components</code>目录，在该目录下面创建<code>tree-tools.vue</code>组件。</p>
<p>该组件中的代码，如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;el-row style=&quot;height: 40px; width: 100%&quot; align=&quot;middle&quot;&gt;</span><br><span class="line">      &lt;el-col :span=&quot;20&quot;&gt;</span><br><span class="line">        &lt;span&gt;&#123;&#123; treeNode.name &#125;&#125;&lt;/span&gt;</span><br><span class="line">      &lt;/el-col&gt;</span><br><span class="line">      &lt;el-col :span=&quot;4&quot;&gt;</span><br><span class="line">        &lt;el-row justify=&quot;end&quot;&gt;</span><br><span class="line">          &lt;el-col :span=&quot;12&quot;&gt;&#123;&#123; treeNode.manager &#125;&#125;&lt;/el-col&gt;</span><br><span class="line">          &lt;el-col :span=&quot;12&quot;&gt;</span><br><span class="line">            &lt;el-dropdown&gt;</span><br><span class="line">              &lt;span class=&quot;el-dropdown-link&quot;&gt;</span><br><span class="line">                操作</span><br><span class="line">                &lt;el-icon class=&quot;el-icon--right&quot;&gt;</span><br><span class="line">                  &lt;ArrowDown /&gt;</span><br><span class="line">                &lt;/el-icon&gt;</span><br><span class="line">              &lt;/span&gt;</span><br><span class="line">              &lt;!-- 下拉菜单 --&gt;</span><br><span class="line">              &lt;template #dropdown&gt;</span><br><span class="line">                &lt;el-dropdown-menu&gt;</span><br><span class="line">                  &lt;el-dropdown-item&gt;添加子部门&lt;/el-dropdown-item&gt;</span><br><span class="line">                  &lt;el-dropdown-item&gt;编辑部门&lt;/el-dropdown-item&gt;</span><br><span class="line">                  &lt;el-dropdown-item&gt;删除部门&lt;/el-dropdown-item&gt;</span><br><span class="line">                &lt;/el-dropdown-menu&gt;</span><br><span class="line">              &lt;/template&gt;</span><br><span class="line">            &lt;/el-dropdown&gt;</span><br><span class="line">          &lt;/el-col&gt;</span><br><span class="line">        &lt;/el-row&gt;</span><br><span class="line">      &lt;/el-col&gt;</span><br><span class="line">    &lt;/el-row&gt;</span><br><span class="line">  &lt;/template&gt;</span><br><span class="line">  &lt;script&gt;</span><br><span class="line">  // 该组件需要对外开放属性 外部需要提供一个对象 对象里需要有name  manager</span><br><span class="line">  export default &#123;</span><br><span class="line">    name: &quot;TreeTools&quot;,</span><br><span class="line">    props: &#123;</span><br><span class="line">      //   定义一个props属性</span><br><span class="line">      treeNode: &#123;</span><br><span class="line">        type: Object, // 对象类型</span><br><span class="line">        required: true, // 要求对方使用您的组件的时候 必须传treeNode属性 如果不传 就会报错</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line">  &lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>这里我们将<code>el-row</code>组件中的内容拷贝过来了。</p>
<p>同时定义了<code>props</code>接收传递过来的数据。</p>
<p>下面看一下该组件的使用。</p>
<p>在**<code>src/views/departments/index.vue</code>**进行代码的简化</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; reactive, ref &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">TreeTools</span> <span class="keyword">from</span> <span class="string">&quot;./components/tree-tools.vue&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">components</span>: &#123;</span><br><span class="line">    <span class="title class_">TreeTools</span>,</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>

<p>导入<code>TreeTools</code>组件，并且完成注册。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 添加树形组件 --&gt;</span><br><span class="line">        &lt;el-tree :data=&quot;departs&quot; :props=&quot;defaultProps&quot; default-expand-all&gt;</span><br><span class="line">          &lt;template #default=&quot;&#123; node, data &#125;&quot;&gt;</span><br><span class="line">            &lt;TreeTools :treeNode=&quot;data&quot;&gt;&lt;/TreeTools&gt;</span><br><span class="line">          &lt;/template&gt;</span><br><span class="line">        &lt;/el-tree&gt;</span><br></pre></td></tr></table></figure>

<p>在<code>el-tree</code>中使用了<code>TreeTools</code>组件，并且传递了具体的数据。</p>
<p>下面，我们来看一下<code>组织架构</code>中顶部的改造，顶部也使用<code>TreeTools</code>这个组件。</p>
<p>只不过顶部需要传递公司的信息。</p>
<p>在<code>views/deparments/index.vue</code>中修改代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">   <span class="keyword">const</span> company=<span class="title function_">ref</span>(&#123;</span><br><span class="line">       <span class="attr">name</span>:<span class="string">&quot;xxx教育集团&quot;</span>,</span><br><span class="line">       <span class="attr">manager</span>:<span class="string">&quot;负责人&quot;</span></span><br><span class="line">   &#125;)</span><br></pre></td></tr></table></figure>

<p>在<code>setup</code>入口函数中定义了<code>company</code> 对象，该对象中存储了公司名称</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">    departs,</span><br><span class="line">    defaultProps,</span><br><span class="line">    company <span class="comment">// 返回公司信息</span></span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>

<p>将<code>company</code>返回到模板中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;div class=&quot;app-container&quot;&gt;</span><br><span class="line">     &lt;!-- 组织架构--头部布局 --&gt;</span><br><span class="line">     &lt;el-card&gt;</span><br><span class="line">       &lt;TreeTools :treeNode=&quot;company&quot;  :isRoot=&quot;true&quot; &gt;&lt;/TreeTools&gt;</span><br><span class="line">         &lt;!-- 添加树形组件 --&gt;</span><br></pre></td></tr></table></figure>

<p>这里将<code>company</code>作为<code>treeNode</code>的属性值，传递到<code>TreeTools</code>这个组件中。</p>
<p>这里同时给<code>isRoot</code>属性值为<code>true</code></p>
<p>原因是：在上下两个位置都使用了下拉框组件，但是放置在最上层的组件是不需要显示 **<code>删除部门</code><strong>和</strong><code>编辑部门</code>**的。所以下面在使用<code>TreeTools</code>组件的时候没有传递<code>isRoot</code>属性，没有传递，默认值是<code>false</code></p>
<p>所以，增加一个新的属性 **<code>isRoot（是否根节点）</code>**进行控制。</p>
<p>下面在<code>TreeTools</code>组件中添加该属性</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;TreeTools&quot;</span>,</span><br><span class="line">    <span class="attr">props</span>: &#123;</span><br><span class="line">      <span class="comment">//   定义一个props属性</span></span><br><span class="line">      <span class="attr">treeNode</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">Object</span>, <span class="comment">// 对象类型</span></span><br><span class="line">        <span class="attr">required</span>: <span class="literal">true</span>, <span class="comment">// 要求对方使用您的组件的时候 必须传treeNode属性 如果不传 就会报错</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">isRoot</span>:&#123;</span><br><span class="line">        <span class="attr">type</span>:<span class="title class_">Boolean</span>,</span><br><span class="line">        <span class="attr">default</span>:<span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>

<p>在上面的代码中，在<code>props</code>中定义了<code>isRoot</code>接收传递过来的值,然后在模板中进行判断，如下所示</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 下拉菜单 --&gt;</span><br><span class="line">             &lt;template #dropdown&gt;</span><br><span class="line">               &lt;el-dropdown-menu&gt;</span><br><span class="line">                 &lt;el-dropdown-item&gt;添加子部门&lt;/el-dropdown-item&gt;</span><br><span class="line">                 &lt;el-dropdown-item v-if=&quot;!isRoot&quot;&gt;编辑部门&lt;/el-dropdown-item&gt;</span><br><span class="line">                 &lt;el-dropdown-item  v-if=&quot;!isRoot&quot;&gt;删除部门&lt;/el-dropdown-item&gt;</span><br><span class="line">               &lt;/el-dropdown-menu&gt;</span><br><span class="line">             &lt;/template&gt;</span><br></pre></td></tr></table></figure>

<p>返回到浏览器中进行测试。</p>
<p>通过封装，在<code>src/views/departments/index.vue</code>文件中的代码看上去更加紧凑，简洁，这就是封装的魅力</p>
<h3 id="6、部门模型设计"><a href="#6、部门模型设计" class="headerlink" title="6、部门模型设计"></a>6、部门模型设计</h3><p>通过前面的学习，我们将组织架构的整体页面结构已经设计出来了，在这一小节中，我们需要在服务端设计部门的模型。</p>
<p><strong>这里需要注意的一点就是先把数据库中<code>T_UserInfos</code>这个表中的测试数据删除，否则无法建立数据表之间的关系。</strong></p>
<p>具体的模型设计如下</p>
<p>在<code> Cms.Entity</code>项目中创建<code>Department</code>类、</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Department</span> : <span class="title">BaseEntity</span>&lt;<span class="title">long</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 部门名称</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span>? DepartmentName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 部门编号</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span>? DepartmentCode &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 部门描述</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span>? DepartmentDescription &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 父级部门ID</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">long</span> ParentId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 部门所在城市</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span>? City &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 部门负责人</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span>? Manager &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 部分负责人编号</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">long</span> ManagerId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 一个部门下面又很多员工</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;UserInfo&gt; UserInfos &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;=<span class="keyword">new</span> List&lt;UserInfo&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同时修改<code>UserInfo.cs</code>实体类中的代码，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">int</span> Gender &#123; <span class="keyword">get</span>; <span class="keyword">set</span>;&#125;</span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> 用户头像，存储头像路径</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="keyword">public</span> <span class="built_in">string</span>? PhotoUrl &#123; <span class="keyword">get</span>; <span class="keyword">set</span>;&#125;</span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> -----------------一个员工只能属于一个部门</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="keyword">public</span> Department? Department &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br></pre></td></tr></table></figure>

<p>这里添加了一个<code>Department</code>属性。</p>
<p>下面定义<code>DepartmentConfig.cs</code>类，完成相应的配置，该类的代码如所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DepartmentConfig</span> : <span class="title">IEntityTypeConfiguration</span>&lt;<span class="title">Department</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">EntityTypeBuilder&lt;Department&gt; builder</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            builder.ToTable(<span class="string">&quot;T_Departments&quot;</span>);</span><br><span class="line">            builder.Property(x =&gt; x.DepartmentName).HasMaxLength(<span class="number">20</span>).IsRequired();</span><br><span class="line">            builder.Property(x =&gt; x.DepartmentCode).HasMaxLength(<span class="number">20</span>).IsRequired();</span><br><span class="line">            builder.Property(x =&gt; x.DepartmentDescription).IsRequired();</span><br><span class="line">            builder.Property(x =&gt; x.City).HasMaxLength(<span class="number">16</span>).IsRequired();</span><br><span class="line">            builder.Property(x =&gt; x.Manager).HasMaxLength(<span class="number">16</span>).IsRequired();</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>下面修改<code>UserInfoConfig.cs</code>类中的代码，该类中的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">  builder.Property(x =&gt; x.PhotoUrl).HasMaxLength(<span class="number">100</span>);</span><br><span class="line"><span class="comment">// 添加了一对多的关系</span></span><br><span class="line">            builder.HasOne&lt;Department&gt;(d=&gt;d.Department).WithMany(u=&gt;u.UserInfos).IsRequired();</span><br></pre></td></tr></table></figure>

<p>修改<code>MyDbContext</code></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyDbContext</span>:<span class="title">DbContext</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">public</span> DbSet&lt;UserInfo&gt;UserInfos &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="keyword">public</span> DbSet&lt;Department&gt; DepartmentInfos &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; <span class="comment">// 这里指定了`DepartmentInfos`这个DbSet</span></span><br></pre></td></tr></table></figure>

<p>下面完成数据的迁移操作。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Add-Migration CreateDepartament</span><br><span class="line">Update-database</span><br></pre></td></tr></table></figure>

<h3 id="7、获取部门信息接口设计"><a href="#7、获取部门信息接口设计" class="headerlink" title="7、获取部门信息接口设计"></a>7、获取部门信息接口设计</h3><p>在这一小节中，我们根据前面创建的部门的模型来获取对应的部门信息。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.IRepository</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IDepartmentRepository</span>:<span class="title">IBaseRepository</span>&lt;<span class="title">Department</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在上面的代码中定义了<code>IDepartmentRepository</code>这个数据仓储接口。</p>
<p>下面看一下具体的实现，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.Repository</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DepartmentRepository</span> : <span class="title">BaseRepository</span>&lt;<span class="title">Department</span>&gt;, <span class="title">IDepartmentRepository</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DepartmentRepository</span>(<span class="params">MyDbContext context</span>) : <span class="title">base</span>(<span class="params">context</span>)</span> &#123; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>下面，实现服务的接口。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.IService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IDepartmentService</span>:<span class="title">IBaseService</span>&lt;<span class="title">Department</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>实现具体的服务类</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.Service</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DepartmentService</span>:<span class="title">BaseService</span>&lt;<span class="title">Department</span>&gt;,<span class="title">IDepartmentService</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IDepartmentRepository _departmentRepository;    </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DepartmentService</span>(<span class="params">IDepartmentRepository departmentRepository</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">base</span>.repository = departmentRepository;</span><br><span class="line">            _departmentRepository = departmentRepository;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建具体的控制器<code>DepartmentsController</code>,该控制器中的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.WebApi.Controllers</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">Route(<span class="string">&quot;api/[controller]&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">ApiController</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DepartmentsController</span> : <span class="title">ControllerBase</span></span><br><span class="line">    &#123;   </span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">readonly</span> IDepartmentService _departmentsService;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DepartmentsController</span>(<span class="params">IDepartmentService departmentService</span>)</span> </span><br><span class="line">        &#123;</span><br><span class="line">           <span class="keyword">this</span>._departmentsService = departmentService;</span><br><span class="line">        &#125;</span><br><span class="line">        [<span class="meta">HttpGet</span>]</span><br><span class="line">        [<span class="meta">Authorize</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> IActionResult <span class="title">GetDepartments</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">           <span class="keyword">var</span> departs = _departmentsService.LoadEntities(d=&gt;d.DelFlag==Convert.ToBoolean(DelFlagEnum.Normal));</span><br><span class="line">            <span class="keyword">if</span> (departs.Count() &gt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> Ok(<span class="keyword">new</span> ApiResult&lt;IEnumerable&lt;Department&gt;&gt;() &#123; Success = <span class="literal">true</span>, Message = <span class="string">&quot;获取部门成功&quot;</span>, Data = departs &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> NotFound(<span class="string">&quot;没有部门信息&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8、前端获取组织架构数据"><a href="#8、前端获取组织架构数据" class="headerlink" title="8、前端获取组织架构数据"></a>8、前端获取组织架构数据</h3><p>在这一小节中，需要构建请求的<code>api</code>接口，向服务端发送请求获取组织架构的数据。</p>
<p>在<code>src/api</code>目录下面创建<code>departments.js</code>文件，该文件中的代码如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> request <span class="keyword">from</span> <span class="string">&quot;@/utils/request&quot;</span>;</span><br><span class="line"><span class="comment">/** *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 获取组织架构数据</span></span><br><span class="line"><span class="comment"> * **/</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getDepartments</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">request</span>(&#123;</span><br><span class="line">    <span class="attr">url</span>: <span class="string">&quot;/departments&quot;</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>返回到<code>src/views/departments/index.vue</code>组件中调用上面的方法来发送请求获取组织架构的数据。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; onMounted, reactive,ref &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">TreeTools</span> <span class="keyword">from</span> <span class="string">&#x27;./components/tree-tools.vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123;getDepartments&#125; <span class="keyword">from</span> <span class="string">&quot;@/api/departments&quot;</span></span><br></pre></td></tr></table></figure>

<p>这里导入了<code>getDepartments</code>这个方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">   <span class="keyword">const</span> company=<span class="title function_">ref</span>(&#123;</span><br><span class="line">       <span class="attr">name</span>:<span class="string">&quot;xxx教育集团&quot;</span>,</span><br><span class="line">       <span class="attr">manager</span>:<span class="string">&quot;负责人&quot;</span></span><br><span class="line">   &#125;)</span><br><span class="line">   <span class="keyword">const</span> departs = <span class="title function_">reactive</span>([]);</span><br><span class="line">   <span class="title function_">onMounted</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">     <span class="title function_">loadDepartments</span>();</span><br><span class="line">   &#125;)</span><br><span class="line">   <span class="keyword">const</span> <span class="title function_">loadDepartments</span> =<span class="keyword">async</span>(<span class="params"></span>)=&gt;&#123;</span><br><span class="line">     <span class="keyword">const</span> result =<span class="keyword">await</span> <span class="title function_">getDepartments</span>();</span><br><span class="line">     <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;result=&#x27;</span>,result);</span><br><span class="line">     </span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">const</span> defaultProps = &#123;</span><br><span class="line">     <span class="attr">children</span>: <span class="string">&quot;children&quot;</span>,</span><br><span class="line">     <span class="attr">label</span>: <span class="string">&quot;name&quot;</span>,</span><br><span class="line">   &#125;;</span><br></pre></td></tr></table></figure>

<p>这里我们将<code>departs</code>数组清空，然后在<code>onMounted</code>这个钩子函数中调用了<code>loadDepartments</code>这个方法。</p>
<p>在这方法中又调用了<code>getDepartments</code>方法发送请求，获取部门数据。</p>
<p>当然，这里也需要导入<code>onMounted</code>这个钩子函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; onMounted, reactive,ref &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>在<code>loadDepartments</code>方法中同时打印了<code>result</code>中的数据，通过查看浏览器的控制台，发现所有的组织架构的数据存储在一个数组中，而我们直接将这个数组给<code>departs</code>,然后交给<code>树形结构</code>是不合适的，因为该数据不是树形结构的数据。</p>
<p>所以在下一小节中，我们需要将数组中的数据转换成树形结构.</p>
<h3 id="9、将数组转换成树形结构"><a href="#9、将数组转换成树形结构" class="headerlink" title="9、将数组转换成树形结构"></a>9、将数组转换成树形结构</h3><p>在<code>src/utils</code>目录下面创建<code>index.js</code>文件，该文件的代码如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//将数组中的数据转换成树形数据(使用递归算法)</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">tranListToTreeData</span>(<span class="params">list, rootValue</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> arr = [];</span><br><span class="line">    list.<span class="title function_">forEach</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// parentId属性值为0，表示跟节点</span></span><br><span class="line">      <span class="keyword">if</span> (item.<span class="property">parentId</span> === rootValue) &#123;</span><br><span class="line">        <span class="comment">// 找到之后 就要去找 item 下面有没有子节点</span></span><br><span class="line">        <span class="keyword">const</span> children = <span class="title function_">tranListToTreeData</span>(list, item.<span class="property">id</span>);</span><br><span class="line">        <span class="keyword">if</span> (children.<span class="property">length</span>) &#123;</span><br><span class="line">          <span class="comment">// 如果children的长度大于0 说明找到了子节点</span></span><br><span class="line">          item.<span class="property">children</span> = children;</span><br><span class="line">        &#125;</span><br><span class="line">        arr.<span class="title function_">push</span>(item); <span class="comment">// 将内容加入到数组中</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> arr;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>下面返回到<code>views/departments/index.vue</code>组件中调用上面的递归方法。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;getDepartments&#125; <span class="keyword">from</span> <span class="string">&quot;@/api/departments&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123; tranListToTreeData &#125; <span class="keyword">from</span> <span class="string">&quot;@/utils/index&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>首先导入<code>tranListToTreeData</code>方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">loadDepartments</span> =<span class="keyword">async</span>(<span class="params"></span>)=&gt;&#123;</span><br><span class="line">  <span class="keyword">const</span> result =<span class="keyword">await</span> <span class="title function_">getDepartments</span>();    </span><br><span class="line">    <span class="comment">// 将tranListToTreeData方法返回的数组解构以后，在追加到departs这个新组件中，然后在树形结构中进行展示。</span></span><br><span class="line">   departs.<span class="title function_">push</span>(...<span class="title function_">tranListToTreeData</span>(result,<span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> defaultProps = &#123;</span><br><span class="line">  <span class="attr">children</span>: <span class="string">&quot;children&quot;</span>,<span class="comment">// 在导入的tranListToTreeData方法中都把子部门放到了children属性中了。</span></span><br><span class="line">  <span class="attr">label</span>: <span class="string">&quot;departmentName&quot;</span>, <span class="comment">// 注意：这里将label属性的值修改为departmentName,因为服务端返回的departmentName，表示部门名称</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这里在<code>loadDepartments</code>方法中调用了<code>tranListToTreeData</code>方法，传递的第一个参数是从服务端返回的的组织架构数组数据，第二个参数是0表示根节点，</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> company=<span class="title function_">ref</span>(&#123;</span><br><span class="line">     <span class="attr">departmentName</span>:<span class="string">&quot;xxx教育集团&quot;</span>, <span class="comment">// 这里将name修改为departmentName</span></span><br><span class="line">       <span class="attr">manager</span>:<span class="string">&quot;负责人&quot;</span></span><br><span class="line">   &#125;)</span><br></pre></td></tr></table></figure>

<p>同时还要修改一下<code>TreeTools.vue</code>这个组件中的代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;span&gt;&#123;&#123; treeNode.departmentName &#125;&#125;&lt;/span&gt; // 将这里修改成departmentName</span><br></pre></td></tr></table></figure>

<p>返回到浏览器中进行测试。</p>
<p>在加载数据的时候，如果数据还没有加载完，可以展示<code>loading</code>效果。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://element-plus.gitee.io/zh-CN/component/loading.html</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> departs = <span class="title function_">reactive</span>([]);</span><br><span class="line">   <span class="keyword">const</span> loading = <span class="title function_">ref</span>(<span class="literal">true</span>); <span class="comment">// 定义loading，默认值是true,表示开启loading效果</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">loadDepartments</span> =<span class="keyword">async</span>(<span class="params"></span>)=&gt;&#123;</span><br><span class="line">     <span class="keyword">const</span> result =<span class="keyword">await</span> <span class="title function_">getDepartments</span>();</span><br><span class="line">      departs.<span class="title function_">push</span>(...<span class="title function_">tranListToTreeData</span>(result,<span class="number">0</span>));</span><br><span class="line">      loading.<span class="property">value</span> = <span class="literal">false</span>; <span class="comment">// 关闭loading效果</span></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>这里在获取到数据以后<code>loading</code>的值设置为<code>false</code>，表示关闭<code>loading</code>效果。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">     departs,</span><br><span class="line">     defaultProps,</span><br><span class="line">     company,</span><br><span class="line">     loading,</span><br><span class="line">   &#125;;</span><br></pre></td></tr></table></figure>

<p>将<code>loading</code>返回</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-tree  v-loading=&quot;loading&quot;  :data=&quot;departs&quot; :props=&quot;defaultProps&quot; default-expand-all&gt;</span><br></pre></td></tr></table></figure>

<p>这里给<code>el-tree</code>添加了<code>v-loading</code>属性，取值为<code>loading</code>.</p>
<p>返回到浏览器端进行测试。(可以调整网速进行测试)</p>
<h3 id="10、删除部门信息接口设计"><a href="#10、删除部门信息接口设计" class="headerlink" title="10、删除部门信息接口设计"></a>10、删除部门信息接口设计</h3><p>在<code>DepartmentsController</code>控制器中添加如下方法。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">HttpDelete(<span class="string">&quot;&#123;id&#125;&quot;</span>)</span>]</span><br><span class="line">       [<span class="meta">Authorize</span>]</span><br><span class="line">       [<span class="meta">UnitOfWork(new Type[</span>] &#123; <span class="keyword">typeof</span>(MyDbContext) &#125;)]</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">DeleteDepartments</span>(<span class="params">[FromRoute]<span class="built_in">int</span> id</span>)</span> &#123;</span><br><span class="line">           <span class="keyword">var</span> depart = <span class="keyword">await</span> _departmentsService.LoadEntities(d =&gt; d.Id == id).FirstOrDefaultAsync();</span><br><span class="line">           <span class="keyword">if</span> (depart == <span class="literal">null</span>)</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">return</span> NotFound(<span class="string">&quot;没有找到要删除的部门&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           depart!.DelFlag =Convert.ToBoolean(DelFlagEnum.logicDelete);</span><br><span class="line">           <span class="keyword">await</span> _departmentsService.UpdateEntityAsync(depart);</span><br><span class="line">           <span class="keyword">return</span> Ok(<span class="keyword">new</span> ApiResult&lt;Department&gt;() &#123;Success=<span class="literal">true</span>,Message=<span class="string">&quot;删除成功&quot;</span>,Data=<span class="literal">null</span>&#125;);</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<h3 id="11、删除部门功能–前端实现"><a href="#11、删除部门功能–前端实现" class="headerlink" title="11、删除部门功能–前端实现"></a>11、删除部门功能–前端实现</h3><p>这里先封装删除部门的接口<code>api</code></p>
<p>在<code>src/api/departments.js</code>文件中添加如下方法：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** *</span></span><br><span class="line"><span class="comment"> *  根据id根据部门  接口是根据restful的规则设计的   删除 delete  新增 post  修改put 获取 get</span></span><br><span class="line"><span class="comment"> * **/</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">delDepartments</span>(<span class="params">id</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">request</span>(&#123;</span><br><span class="line">    <span class="attr">url</span>: <span class="string">`/departments/<span class="subst">$&#123;id&#125;</span>`</span>,</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&#x27;delete&#x27;</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>问题：在什么情况下调用以上方法，发送请求删除部门信息呢？</p>
<p>这里需要修改<code>views/departments/components/tree-tools.vue</code>组件中的代码，这里给下拉框中的<code>删除部门</code>这一项注册单击事件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://element-plus.gitee.io/zh-CN/component/dropdown.html#%E6%8C%87%E4%BB%A4%E4%BA%8B%E4%BB%B6</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-dropdown @command=&quot;operateDepts&quot;&gt; &lt;!--注册了command事件，该事件触发以后，会调用operateDepts方法--&gt;</span><br><span class="line">            &lt;span class=&quot;el-dropdown-link&quot;&gt;</span><br><span class="line">              操作</span><br><span class="line">              &lt;el-icon class=&quot;el-icon--right&quot;&gt;</span><br><span class="line">                &lt;ArrowDown /&gt;</span><br><span class="line">              &lt;/el-icon&gt;</span><br><span class="line">            &lt;/span&gt;</span><br><span class="line">            &lt;!-- 下拉菜单 --&gt;</span><br><span class="line">            &lt;template #dropdown&gt;</span><br><span class="line">              &lt;el-dropdown-menu&gt;</span><br><span class="line">                &lt;el-dropdown-item command=&quot;add&quot;&gt;添加子部门&lt;/el-dropdown-item&gt;&lt;!--注册了command--&gt;</span><br><span class="line">                &lt;el-dropdown-item v-if=&quot;!isRoot&quot; command=&quot;edit&quot;&gt;编辑部门&lt;/el-dropdown-item&gt;</span><br><span class="line">                &lt;el-dropdown-item  v-if=&quot;!isRoot&quot; command=&quot;del&quot;&gt;删除部门&lt;/el-dropdown-item&gt;</span><br><span class="line">              &lt;/el-dropdown-menu&gt;</span><br><span class="line">            &lt;/template&gt;</span><br><span class="line">          &lt;/el-dropdown&gt;</span><br></pre></td></tr></table></figure>

<p>在上面的代码中，给<code>el-dropdown-item</code>组件添加了<code>command</code>属性，并且给<code>el-dropdown</code>组件注册了<code>command</code>事件。当选择下拉框中的某一项的时候会触发该事件，这时候会调用<code>operateDepts</code>函数。</p>
<p>下面实现该方法：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">setup</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">operateDepts</span> = (<span class="params">type</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (type === <span class="string">&quot;add&quot;</span>) &#123;</span><br><span class="line">      <span class="comment">// 添加子部门</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type === <span class="string">&quot;edit&quot;</span>) &#123;</span><br><span class="line">      <span class="comment">// 编辑子部门</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 删除操作</span></span><br><span class="line">      <span class="title function_">alert</span>(<span class="string">&quot;删除&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    operateDepts,</span><br><span class="line">  &#125;;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>在上面的代码中实现了<code>operateDepts</code>方法，该方法的参数<code>type</code>存储的就是所单击的下拉框中对应项的<code>command</code>属性的值。</p>
<p>这里做了相应的判断。</p>
<p>返回到浏览器中进行测试，当单击了下拉框中的<code>删除部门</code>这一项的时候，就会弹出一个警示框。</p>
<h3 id="12、删除部门功能实现–前端实现2"><a href="#12、删除部门功能实现–前端实现2" class="headerlink" title="12、删除部门功能实现–前端实现2"></a>12、删除部门功能实现–前端实现2</h3><p>在这一小节中，将完成部门的真正删除操作。</p>
<p>修改<code>views/departments/components/tree-tools.vue</code>组件中的代码，如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; delDepartments &#125; <span class="keyword">from</span> <span class="string">&#x27;@/api/departments&#x27;</span>; <span class="comment">// 首先导入delDepartments方法</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title function_">setup</span>(<span class="params">props,&#123;emit&#125;</span>)&#123;</span><br><span class="line">      <span class="keyword">const</span> <span class="title function_">operateDepts</span> = (<span class="params">type</span>) =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (type === <span class="string">&quot;add&quot;</span>) &#123;</span><br><span class="line">        <span class="comment">// 添加子部门</span></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type === <span class="string">&quot;edit&quot;</span>) &#123;</span><br><span class="line">        <span class="comment">// 编辑子部门</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 删除操作</span></span><br><span class="line">        <span class="title class_">ElMessageBox</span>.<span class="title function_">confirm</span>(<span class="string">`确定要删除<span class="subst">$&#123;props.treeNode.departmentName&#125;</span>部门?`</span>)</span><br><span class="line">          .<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">delDepartments</span>(props.<span class="property">treeNode</span>.<span class="property">id</span>); <span class="comment">// 返回Promise对象</span></span><br><span class="line">          &#125;)</span><br><span class="line">          .<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">//  如果删除成功了  就会进入这里</span></span><br><span class="line">            <span class="title class_">ElMessage</span>(&#123;</span><br><span class="line">              <span class="attr">message</span>: <span class="string">&quot;删除部门成功&quot;</span>,</span><br><span class="line">              <span class="attr">type</span>: <span class="string">&quot;success&quot;</span>,</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="title function_">emit</span>(<span class="string">&quot;delDepts&quot;</span>); <span class="comment">// 触发自定义事件</span></span><br><span class="line">          &#125;);</span><br><span class="line">      </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      operateDepts,</span><br><span class="line">    &#125;;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>在上面的代码中，先通过<code>ElMessageBox.confirm方法给出了删除的提示</code>。在提示的信息中，需要展示要删除的部门的名称，所以这里通过<code>props.treeNode.departmentName</code>获取要删除的部门名称。<code>props</code>是通过<code>setup</code>入口函数第一个参数获取到的。</p>
<p>通过文档知道<code>confirm</code>方法返回的是<code>Promise</code>对象。当单击<code>确定</code>按钮的时候，会执行<code>then</code>方法，在该方法的中调用了<code>delDepartments</code>方法发送请求，更加部门编号删除部门信息，同时该方法返回的也是一个<code>Promise</code>对象,所以后面可以继续添加<code>then</code>方法，构成链式调用。</p>
<p>在该<code>then</code>方法中，处理删除成功的情况。给出删除成功的提示。并且触发一个自定义事件<code>delDepts</code></p>
<p>这里的<code>emit</code>方法是从<code>setup</code>入口函数的第二个参数解构出来的。</p>
<p>这里有两个问题：</p>
<p>第一个问题：删除失败的处理？</p>
<p>第二个问题：为什么触发自定义事件？</p>
<p>关于第一个问题，删除失败的处理，已经在响应拦截中处理了。</p>
<p>第二个问题：当删除成功以后，除了给出相应的删除成功的提示以外，还要让树形组件中展示最新的部门信息。</p>
<p>而树形组件是在父组件中的，所以这里需要触发自定义事件。</p>
<p>返回到父组件，也就是<code>views/delDepartments/index.vue</code>这个文件中修改代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-tree  v-loading=&quot;loading&quot;  :data=&quot;departs&quot; :props=&quot;defaultProps&quot; default-expand-all&gt;</span><br><span class="line">         &lt;template #default=&quot;&#123; node, data &#125;&quot;&gt; &lt;!--解构出传递给作用域插槽中的数据，data是每个节点的数据对象---&gt;</span><br><span class="line">         &lt;TreeTools :treeNode=&quot;data&quot; @delDepts=&quot;loadDepartments&quot;&gt;&lt;/TreeTools&gt;</span><br><span class="line">         &lt;/template&gt;</span><br><span class="line">       &lt;/el-tree&gt;</span><br></pre></td></tr></table></figure>

<p>在上面的代码中，给<code>TreeTools</code>组件，添加了<code>delDepts</code>这个自定义事件，当该事件触发以后，会调用<code>loadDepartments</code>方法重新发送请求，获取最新的部门信息数据。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">loadDepartments</span> =<span class="keyword">async</span>(<span class="params"></span>)=&gt;&#123;</span><br><span class="line">      <span class="keyword">const</span> result =<span class="keyword">await</span> <span class="title function_">getDepartments</span>();</span><br><span class="line">      departs.<span class="property">length</span> = <span class="number">0</span>; <span class="comment">// -----------------------------注意：这里先将数组清空</span></span><br><span class="line">       departs.<span class="title function_">push</span>(...<span class="title function_">tranListToTreeData</span>(result,<span class="number">0</span>));</span><br><span class="line">       loading.<span class="property">value</span> = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>在上面的代码中，先将<code>departs</code>数组中的原有数据清空，在添加新的数据，否则数组中会有原有的数据。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">     departs,</span><br><span class="line">     defaultProps,</span><br><span class="line">     company,</span><br><span class="line">     loading,</span><br><span class="line">     loadDepartments <span class="comment">//-------------返回loadDepartments方法</span></span><br><span class="line">   &#125;;</span><br></pre></td></tr></table></figure>

<p>注意这里也需要将<code>loadDepartments</code>方法返回。</p>
<p>返回到浏览器中进行测试。</p>
<h3 id="13、新增部门–展示弹出层"><a href="#13、新增部门–展示弹出层" class="headerlink" title="13、新增部门–展示弹出层"></a>13、新增部门–展示弹出层</h3><p>新增部门，需要弹出一个层，也就是弹出一个窗口，在这个窗口中展示表单。</p>
<p>下面在<code>src/views/departments/components</code>目录下面创建<code>add-dept.vue</code>组件，该组件中的代码如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;!-- 新增部门的弹层 --&gt;</span><br><span class="line">    &lt;el-dialog</span><br><span class="line">      title=&quot;新增部门&quot;</span><br><span class="line">      v-model=&quot;dialogVisible&quot;</span><br><span class="line">      :close-on-click-modal=&quot;false&quot;</span><br><span class="line">    &gt;</span><br><span class="line">      &lt;!-- 表单组件  el-form   label-width设置label的宽度   --&gt;</span><br><span class="line">      &lt;!-- 匿名插槽 --&gt;</span><br><span class="line">      &lt;el-form label-width=&quot;120px&quot;&gt;</span><br><span class="line">        &lt;el-form-item label=&quot;部门名称&quot;&gt;</span><br><span class="line">          &lt;el-input style=&quot;width: 80%&quot; placeholder=&quot;1-50个字符&quot; /&gt;</span><br><span class="line">        &lt;/el-form-item&gt;</span><br><span class="line">        &lt;el-form-item label=&quot;部门编码&quot;&gt;</span><br><span class="line">          &lt;el-input style=&quot;width: 80%&quot; placeholder=&quot;1-50个字符&quot; /&gt;</span><br><span class="line">        &lt;/el-form-item&gt;</span><br><span class="line">        &lt;el-form-item label=&quot;部门负责人&quot;&gt;</span><br><span class="line">          &lt;el-select style=&quot;width: 80%&quot; placeholder=&quot;请选择&quot; /&gt;</span><br><span class="line">        &lt;/el-form-item&gt;</span><br><span class="line">        &lt;el-form-item label=&quot;部门介绍&quot;&gt;</span><br><span class="line">          &lt;el-input</span><br><span class="line">            style=&quot;width: 80%&quot;</span><br><span class="line">            placeholder=&quot;1-300个字符&quot;</span><br><span class="line">            type=&quot;textarea&quot;</span><br><span class="line">            :rows=&quot;3&quot;</span><br><span class="line">          /&gt;</span><br><span class="line">        &lt;/el-form-item&gt;</span><br><span class="line">      &lt;/el-form&gt;</span><br><span class="line">      &lt;!-- el-dialog有专门放置底部操作栏的 插槽  具名插槽 --&gt;</span><br><span class="line">      &lt;template #footer&gt;</span><br><span class="line">        &lt;el-row type=&quot;flex&quot; justify=&quot;center&quot;&gt;</span><br><span class="line">          &lt;!-- 列被分为24 --&gt;</span><br><span class="line">          &lt;el-col :span=&quot;6&quot;&gt;</span><br><span class="line">            &lt;el-button type=&quot;primary&quot; size=&quot;small&quot;&gt;确定&lt;/el-button&gt;</span><br><span class="line">            &lt;el-button size=&quot;small&quot;&gt;取消&lt;/el-button&gt;</span><br><span class="line">          &lt;/el-col&gt;</span><br><span class="line">        &lt;/el-row&gt;</span><br><span class="line">      &lt;/template&gt;</span><br><span class="line">    &lt;/el-dialog&gt;</span><br><span class="line">  &lt;/template&gt;</span><br><span class="line">  &lt;script&gt;</span><br><span class="line">  import &#123; ref &#125; from &quot;vue&quot;;</span><br><span class="line">  export default &#123;</span><br><span class="line">    name: &quot;AddDept&quot;,</span><br><span class="line">    setup() &#123;</span><br><span class="line">      const dialogVisible = ref(true); // 展示窗口</span><br><span class="line">      return &#123;</span><br><span class="line">        dialogVisible,</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line">  &lt;/script&gt;</span><br><span class="line">  &lt;style scoped&gt;&lt;/style&gt;</span><br><span class="line">  </span><br></pre></td></tr></table></figure>

<p>返回到<code>views/departments/index.vue</code>这个组件中使用上面的添加部门组件，看一下窗口的效果。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">AddDept</span> <span class="keyword">from</span> <span class="string">&#x27;./components/add-dept.vue&#x27;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    <span class="attr">components</span>:&#123;</span><br><span class="line">        <span class="title class_">TreeTools</span>,</span><br><span class="line">        <span class="title class_">AddDept</span></span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure>

<p>导入<code>AddDept</code>这个组件,完成<code>AddDept</code>组件的注册。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;/el-tree&gt;</span><br><span class="line">   &lt;/el-card&gt;</span><br><span class="line">   &lt;AddDept&gt;&lt;/AddDept&gt;</span><br></pre></td></tr></table></figure>

<p>在模板中进行渲染。</p>
<p>返回到浏览器中查看效果。</p>
<h3 id="14、新增部门–控制弹出层显示与隐藏"><a href="#14、新增部门–控制弹出层显示与隐藏" class="headerlink" title="14、新增部门–控制弹出层显示与隐藏"></a>14、新增部门–控制弹出层显示与隐藏</h3><p>下面先修改<code>views/departments/components/add-dept.vue</code>组件中的代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"> <span class="keyword">import</span> &#123; ref &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>;</span><br><span class="line"> <span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">   <span class="attr">name</span>: <span class="string">&quot;AddDept&quot;</span>,</span><br><span class="line">   <span class="attr">props</span>:&#123;</span><br><span class="line">       <span class="attr">showDialog</span>:&#123;</span><br><span class="line">           <span class="attr">type</span>:<span class="title class_">Boolean</span>,</span><br><span class="line">           <span class="attr">default</span>:<span class="literal">false</span></span><br><span class="line">       &#125;</span><br><span class="line">   &#125;,</span><br><span class="line">   <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    </span><br><span class="line">   &#125;,</span><br><span class="line"> &#125;;</span><br><span class="line"> &lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>这里我们会接收父组件传递过来的<code>showDialog</code>属性，通过该属性控制添加窗口的显示与隐藏。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 新增部门的弹层 --&gt;</span><br><span class="line">  &lt;el-dialog</span><br><span class="line">    title=&quot;新增部门&quot;</span><br><span class="line">    v-model=&quot;showDialog&quot; &lt;!--这里指定了showDialog--&gt;</span><br><span class="line">    :close-on-click-modal=&quot;false&quot;</span><br><span class="line">  &gt;</span><br></pre></td></tr></table></figure>

<p>这里的<code>v-model</code>属性的取值就是<code>showDialog</code></p>
<p>返回到父组件<code>views/departments/index.vue</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;/el-card&gt;</span><br><span class="line">    &lt;AddDept :showDialog=&quot;showDialog&quot;&gt;&lt;/AddDept&gt;</span><br></pre></td></tr></table></figure>

<p>这里给<code>AddDept</code>这个子组件传递的属性就是<code>showDialog</code>,下面需要进行定义</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> loading = <span class="title function_">ref</span>(<span class="literal">true</span>); <span class="comment">// 定义loading，默认值是true,表示开启loading效果</span></span><br><span class="line"> <span class="keyword">const</span> showDialog = <span class="title function_">ref</span>(<span class="literal">false</span>); <span class="comment">// -------------控制窗口的弹出与隐藏</span></span><br></pre></td></tr></table></figure>

<p>这里的<code>showDialog</code>默认值是<code>false</code>.也就是添加窗口不展示</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">      departs,</span><br><span class="line">      defaultProps,</span><br><span class="line">      company,</span><br><span class="line">      loading,</span><br><span class="line">      loadDepartments,</span><br><span class="line">      showDialog <span class="comment">// 返回</span></span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>

<p>这里也将<code>showDialog</code>这个对象返回到了模版中，这样在模版中才会使用。</p>
<p>保存代码的时候，会出现如下的错误：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">VueCompilerError: v-model cannot be used on a prop, because local prop bindings are not writable.</span><br><span class="line">Use a v-bind binding combined with a v-on listener that emits update:x event instead.</span><br></pre></td></tr></table></figure>

<p><code>Vue</code>在编译的时候出错了，这里不能使用<code>v-model</code>来绑定<code>props</code>所接收到的值。因为<code>props</code>接收到的值是只读的，而<code>v-model</code>是双向绑定，所以会涉及到数据的更改操作。</p>
<p>所以这里，我们在修改一下<code>add-dept.vue</code>组件中的代码，如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">import</span> &#123; ref,watch &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>;  <span class="comment">// 需要导入watch</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;AddDept&quot;</span>,</span><br><span class="line">    <span class="attr">props</span>:&#123;</span><br><span class="line">        <span class="attr">showDialog</span>:&#123;</span><br><span class="line">            <span class="attr">type</span>:<span class="title class_">Boolean</span>,</span><br><span class="line">            <span class="attr">default</span>:<span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">setup</span>(<span class="params">props</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> visible = <span class="title function_">ref</span>(<span class="literal">false</span>);</span><br><span class="line">          visible.<span class="property">value</span> = props.<span class="property">ShowDialog</span>;</span><br><span class="line">      <span class="comment">// const visible = props.showDialog; // 将接收到的showDialog赋值给了visible</span></span><br><span class="line">        <span class="comment">// 这里还需要通过`watch`监听`props.showDialog`数据的变化，当数据变化以后，重新给visible赋值，它的值就是最新的值</span></span><br><span class="line">      <span class="title function_">watch</span>(<span class="function">()=&gt;</span>props.<span class="property">showDialog</span>,<span class="function">(<span class="params">newValue,oldValue</span>)=&gt;</span>&#123;</span><br><span class="line">        visible.<span class="property">value</span> = newValue;</span><br><span class="line">      &#125;)  </span><br><span class="line">       <span class="keyword">return</span> &#123;</span><br><span class="line">        visible <span class="comment">// 返回</span></span><br><span class="line">       &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>

<p>在上面的代码中，在<code>setup</code>这个入口函数中，通过参数<code>props</code>接收到父组件传递过来的<code>showDialog</code>属性的值，然后将接收到的值，赋值给了变量<code>visible</code>.（这里通过<code>watch</code>来监视<code>props.showDialog</code>值的变化）</p>
<p>最后，返回<code>visible</code>的值。</p>
<p>这里需要修改一下模版中的代码，如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 新增部门的弹层 --&gt;</span><br><span class="line">   &lt;el-dialog</span><br><span class="line">     title=&quot;新增部门&quot;</span><br><span class="line">     v-model=&quot;visible&quot; &lt;!--绑定了visible--&gt;</span><br><span class="line">     :close-on-click-modal=&quot;false&quot;</span><br><span class="line">   &gt;</span><br></pre></td></tr></table></figure>

<p>在上面的代码中，我们可以看到<code>v-model</code>绑定了<code>visible</code>.</p>
<p>保存程序，返回到浏览器中，可以看到新增部门的窗口没有展示，也就是说默认情况下新增部门的窗口是隐藏的。</p>
<p>而当单击<code>添加子部门</code>的时候需要展示窗口。</p>
<p>所以下面需要修改<code>src/views/departments/tree-tools.vue</code>文件中的代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">setup</span>(<span class="params">props,&#123;emit&#125;</span>)&#123;</span><br><span class="line">     <span class="keyword">const</span> <span class="title function_">operateDepts</span> = (<span class="params">type</span>) =&gt; &#123;</span><br><span class="line">     <span class="keyword">if</span> (type === <span class="string">&quot;add&quot;</span>) &#123;</span><br><span class="line">       <span class="comment">// 添加子部门</span></span><br><span class="line">       <span class="title function_">emit</span>(<span class="string">&#x27;addDepts&#x27;</span>,props.<span class="property">treeNode</span>);</span><br><span class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type === <span class="string">&quot;edit&quot;</span>) &#123;</span><br></pre></td></tr></table></figure>

<p>添加子部门的时候，这里触发了自定义事件<code>addDepts</code>，同时传递了数据，数据就是我们当前所单击的部门，也就是说，是在当前所单击的部门下面添加子部门。</p>
<p>在返回到父组件<code>index.vue</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 组织架构--头部布局 --&gt;</span><br><span class="line">     &lt;el-card&gt;</span><br><span class="line">       &lt;TreeTools :treeNode=&quot;company&quot;  :isRoot=&quot;true&quot;   @addDepts=&quot;addDepts&quot; &gt;&lt;/TreeTools&gt;</span><br></pre></td></tr></table></figure>

<p>上面是给头部区域所使用的<code>TreeTools</code>组件添加了自定义的事件<code>@addDepts</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;template #default=&quot;&#123; node, data &#125;&quot;&gt; &lt;!--解构出传递给作用域插槽中的数据，data是每个节点的数据对象---&gt;</span><br><span class="line">        &lt;TreeTools :treeNode=&quot;data&quot; @delDepts=&quot;loadDepartments&quot;     @addDepts=&quot;addDepts&quot;&gt;&lt;/TreeTools&gt;</span><br><span class="line">        &lt;/template&gt;</span><br></pre></td></tr></table></figure>

<p>上面是对<code>template</code>标签中所使用的<code>TreeTools</code>组件添加了<code> @addDepts=&quot;addDepts&quot;</code>事件。</p>
<p>通过上面的代码可以看到，头部和下面的<code>TreeTools</code>组件中都添加了<code>addDepts</code>事件，因为这两块区域都有添加子部门的功能。</p>
<p>自定义事件触发以后，调用的是<code>addDepts</code>方法，下面实现该方法。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">addDepts</span> = (<span class="params">nodeValue</span>) =&gt; &#123;</span><br><span class="line">    showDialog.<span class="property">value</span> = <span class="literal">true</span>; <span class="comment">// 将showDialog的值修改为true,表示展示窗口</span></span><br><span class="line">    node.<span class="property">value</span> = nodeValue; <span class="comment">// 存储当前单击的部门的信息。</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;nodeValue = &#x27;</span>,node.<span class="property">value</span> );</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    departs,</span><br><span class="line">    defaultProps,</span><br><span class="line">    company,</span><br><span class="line">    loading,</span><br><span class="line">    loadDepartments,</span><br><span class="line">    showDialog,</span><br><span class="line">    addDepts <span class="comment">// 返回addDepts方法</span></span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> showDialog = <span class="title function_">ref</span>(<span class="literal">false</span>); </span><br><span class="line">   <span class="keyword">const</span> node = <span class="title function_">ref</span>(<span class="literal">null</span>); <span class="comment">// 定义node对象，保存部门信息。</span></span><br></pre></td></tr></table></figure>



<p>注意：这里我们单击了<code>添加子部门</code>后展示窗口，当单击窗口右上角的叉号图标时可以关闭窗口，但是这时候再单击<code>添加子部门</code></p>
<p>无法弹出添加部门的窗口，原因是这里没有实现真正的对<code>showDialog</code>属性的控制。</p>
<p>因为：</p>
<p>当我们单击添加<code>子部门</code>的时候，会执行<code> emit(&#39;addDepts&#39;,props.treeNode);</code>这行代码，从而触发父组件中对应的<code>addDepts</code>事件，从而调用对应的<code>addDepts</code>方法，从而<code> showDialog.value = true</code>，这时候<code>showDialog</code>值发生了变化，由于<code>showDialog</code>是响应对象，从而重新渲染模版，这时候，就会将&#96;&#96;showDialog<code>中的新值传递给</code>AddDept<code>组件，在该组件中通过</code>watch<code>监视到了</code>showDialog&#96;值的变化，从而将添加窗口弹出来了。</p>
<p>但是，当我们添加窗口右上角的查号图标，将窗口关闭以后，再次单击<code>添加子部门</code>的时候，不会在弹出窗口。</p>
<p>当单击叉号图标关闭窗口的时候，并没有改变<code>showDialog</code>的值，它的值其实一直是<code>true</code>.</p>
<p>所以，这里我们需要在单击叉号图标的时候，改变<code>showDialog</code>的值。</p>
<p>在<code>add-dept.vue</code>这个组件中，给<code>dialog</code>窗口添加了<code>close</code>事件，该事件会在单击叉号图标的时候被触发。</p>
<p>当该事件触发以后，会调用<code>closeDialog</code>方法。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 新增部门的弹层 --&gt;</span><br><span class="line">    &lt;el-dialog</span><br><span class="line">      title=&quot;新增部门&quot;</span><br><span class="line">      v-model=&quot;visible&quot;</span><br><span class="line">      :close-on-click-modal=&quot;false&quot;</span><br><span class="line">      @close=&quot;closeDialog&quot;</span><br><span class="line">    &gt;</span><br></pre></td></tr></table></figure>

<p><code>closeDialog</code>方法的实现如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">closeDialog</span>=(<span class="params"></span>)=&gt;&#123;</span><br><span class="line">          <span class="comment">//console.log(&#x27;hello&#x27;);</span></span><br><span class="line">          <span class="title function_">emit</span>(<span class="string">&#x27;closeAddDialog&#x27;</span>,<span class="literal">false</span>);</span><br><span class="line">      &#125;</span><br><span class="line">     <span class="keyword">return</span> &#123;</span><br><span class="line">      visible,</span><br><span class="line">      closeDialog <span class="comment">// 返回到模版中，在模版中财可以使用</span></span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>

<p>在<code>closeDialog</code>方法的内部也是触发了自定义的事件<code>closeAddDialog</code>.并传递了参数<code>false</code></p>
<p>返回到父组件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;/el-card&gt;</span><br><span class="line">    &lt;AddDept :showDialog=&quot;showDialog&quot; @closeAddDialog=&quot;closeAddDialog&quot;&gt;&lt;/AddDept&gt;</span><br><span class="line">  &lt;/div&gt;</span><br></pre></td></tr></table></figure>

<p>这里指定了自定义事件<code>closeAddDialog</code>,该事件触发以后会调用<code>closeAddDialog</code>方法，该方法的实现如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 关闭添加窗口</span></span><br><span class="line"> <span class="keyword">const</span> <span class="title function_">closeAddDialog</span>=(<span class="params">state</span>)=&gt;&#123;</span><br><span class="line">   showDialog.<span class="property">value</span> = state;</span><br><span class="line"> &#125;</span><br><span class="line">   <span class="keyword">return</span> &#123;</span><br><span class="line">     departs,</span><br><span class="line">     defaultProps,</span><br><span class="line">     company,</span><br><span class="line">     loading,</span><br><span class="line">     loadDepartments,</span><br><span class="line">     showDialog,</span><br><span class="line">     addDepts,</span><br><span class="line">     closeAddDialog <span class="comment">//返回</span></span><br><span class="line">   &#125;;</span><br></pre></td></tr></table></figure>

<p>在<code>closeAddDialog</code>方法中，根据传递过来的<code>state</code>参数值，修改<code>showDialog</code>的值。</p>
<h3 id="15、新增部门–表单基本校验实现"><a href="#15、新增部门–表单基本校验实现" class="headerlink" title="15、新增部门–表单基本校验实现"></a>15、新增部门–表单基本校验实现</h3><p>修改<code>views/departments/components/add-dept.vue</code>组件中的代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">setup</span>(<span class="params">props,&#123;emit&#125;</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> visible = <span class="title function_">ref</span>(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> formData = <span class="title function_">reactive</span>(&#123;</span><br><span class="line">       <span class="attr">departmentName</span>: <span class="string">&quot;&quot;</span>, <span class="comment">// 部门名称</span></span><br><span class="line">       <span class="attr">departmentCode</span>: <span class="string">&quot;&quot;</span>, <span class="comment">// 部门编码</span></span><br><span class="line">       <span class="attr">manager</span>: <span class="string">&quot;&quot;</span>, <span class="comment">// 部门管理者</span></span><br><span class="line">       <span class="attr">departmentDescription</span>: <span class="string">&quot;&quot;</span>, <span class="comment">// 部门介绍</span></span><br><span class="line">   &#125;);</span><br><span class="line">   <span class="keyword">const</span> formRules = <span class="title function_">reactive</span>(&#123;</span><br><span class="line">       <span class="attr">departmentName</span>: [</span><br><span class="line">       &#123; <span class="attr">required</span>: <span class="literal">true</span>, <span class="attr">message</span>: <span class="string">&quot;部门名称不能为空&quot;</span>, <span class="attr">trigger</span>: <span class="string">&quot;blur&quot;</span> &#125;,</span><br><span class="line">       &#123; <span class="attr">min</span>: <span class="number">1</span>, <span class="attr">max</span>: <span class="number">50</span>, <span class="attr">message</span>: <span class="string">&quot;部门名称要求1-50个字符&quot;</span>, <span class="attr">trigger</span>: <span class="string">&quot;blur&quot;</span> &#125;,</span><br><span class="line">     ],</span><br><span class="line">     <span class="attr">departmentCode</span>: [</span><br><span class="line">       &#123; <span class="attr">required</span>: <span class="literal">true</span>, <span class="attr">message</span>: <span class="string">&quot;部门编码不能为空&quot;</span>, <span class="attr">trigger</span>: <span class="string">&quot;blur&quot;</span> &#125;,</span><br><span class="line">       &#123; <span class="attr">min</span>: <span class="number">1</span>, <span class="attr">max</span>: <span class="number">50</span>, <span class="attr">message</span>: <span class="string">&quot;部门编码要求1-50个字符&quot;</span>, <span class="attr">trigger</span>: <span class="string">&quot;blur&quot;</span> &#125;,</span><br><span class="line">     ],</span><br><span class="line">     <span class="attr">manager</span>: [</span><br><span class="line">       &#123; <span class="attr">required</span>: <span class="literal">true</span>, <span class="attr">message</span>: <span class="string">&quot;部门负责人不能为空&quot;</span>, <span class="attr">trigger</span>: <span class="string">&quot;blur&quot;</span> &#125;,</span><br><span class="line">     ],</span><br><span class="line">     <span class="attr">departmentDescription</span>: [</span><br><span class="line">       &#123; <span class="attr">required</span>: <span class="literal">true</span>, <span class="attr">message</span>: <span class="string">&quot;部门介绍不能为空&quot;</span>, <span class="attr">trigger</span>: <span class="string">&quot;blur&quot;</span> &#125;,</span><br><span class="line">       &#123;</span><br><span class="line">         <span class="attr">trigger</span>: <span class="string">&quot;blur&quot;</span>,</span><br><span class="line">         <span class="attr">min</span>: <span class="number">1</span>,</span><br><span class="line">         <span class="attr">max</span>: <span class="number">300</span>,</span><br><span class="line">         <span class="attr">message</span>: <span class="string">&quot;部门介绍要求1-50个字符&quot;</span>,</span><br><span class="line">       &#125;,</span><br><span class="line">     ],</span><br><span class="line">   &#125;);</span><br></pre></td></tr></table></figure>

<p>在上面的代码中定义了<code>formData</code>这个表单数据对象。</p>
<p>同时定义了<code>formRules</code>这个校验规则对象。</p>
<p>并且将两项内容返回。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">      visible,</span><br><span class="line">      closeDialog,</span><br><span class="line">      formData, <span class="comment">// 返回formData</span></span><br><span class="line">      formRules <span class="comment">// 返回formRules</span></span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>

<p>下面查看模版中的代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-form label-width=&quot;120px&quot; :model=&quot;formData&quot; :rules=&quot;formRules&quot;&gt;</span><br><span class="line">      &lt;el-form-item label=&quot;部门名称&quot; prop=&quot;departmentName&quot;&gt;</span><br><span class="line">        &lt;el-input style=&quot;width: 80%&quot; placeholder=&quot;1-50个字符&quot; v-model=&quot;formData.departmentName&quot; /&gt;</span><br><span class="line">      &lt;/el-form-item&gt;</span><br><span class="line">      &lt;el-form-item label=&quot;部门编码&quot; prop = &quot;departmentCode&quot;&gt;</span><br><span class="line">        &lt;el-input style=&quot;width: 80%&quot; placeholder=&quot;1-50个字符&quot; v-model=&quot;formData.departmentCode&quot; /&gt;</span><br><span class="line">      &lt;/el-form-item&gt;</span><br><span class="line">      &lt;el-form-item label=&quot;部门负责人&quot; prop=&quot;manager&quot;&gt;</span><br><span class="line">        &lt;el-select style=&quot;width: 80%&quot; placeholder=&quot;请选择&quot; v-model=&quot;formData.manager&quot; /&gt;</span><br><span class="line">      &lt;/el-form-item&gt;</span><br><span class="line">      &lt;el-form-item label=&quot;部门介绍&quot; prop=&quot;departmentDescription&quot;&gt;</span><br><span class="line">        &lt;el-input</span><br><span class="line">          style=&quot;width: 80%&quot;</span><br><span class="line">          placeholder=&quot;1-300个字符&quot;</span><br><span class="line">          type=&quot;textarea&quot;</span><br><span class="line">          :rows=&quot;3&quot;</span><br><span class="line">          v-model=&quot;formData.departmentDescription&quot;</span><br><span class="line">        /&gt;</span><br><span class="line">      &lt;/el-form-item&gt;</span><br><span class="line">    &lt;/el-form&gt;</span><br></pre></td></tr></table></figure>

<p>在上面的模板代码中，给<code>el-form</code>组件添加了<code>model</code>属性绑定了表单数据对象<code>formData</code>，同时添加了<code>rules</code>属性绑定了<code>formRules</code>这个表单校验规则对象。</p>
<p>为了完成表单的校验，下面给每个<code>el-form-item</code>添加了<code>prop</code>属性。</p>
<p>同时给每个<code>表单元素</code>通过<code>v-model</code>双向绑定了表单数据对象中的相应属性。</p>
<p>返回到浏览器中进行测试。</p>
<h3 id="16、新增部门–自定义校验"><a href="#16、新增部门–自定义校验" class="headerlink" title="16、新增部门–自定义校验"></a>16、新增部门–自定义校验</h3><p>部门名称（<code>departmentName</code>）：必填 1-50个字符  &#x2F; 同级部门中禁止出现重复部门</p>
<p>部门编码（<code>departmentCode</code>）：必填 1-50个字符  &#x2F; 部门编码在整个模块中都不允许重复</p>
<p>关于部门名称的基本校验(必填 1-50个字符 )和部门编码基本校验(必填 1-50个字符 )已经完成了，下面再来看一下关于部门名称和部门编码中其它的校验要求。</p>
<p>这些要求需要通过自定义校验来实现。</p>
<p>这里我们先来看一下关于部门名称的校验，校验规则的要求：同级部门中禁止出现重复部门。</p>
<p>例如：在上海实业部，这个部门下面已经有一个<code>A</code>部门了，现在就不能在在上海实业部下面添加<code>A</code>部门了。</p>
<p>下面修改<code>add-dept.vue</code>这个组件中的代码。</p>
<p>在该组件中，首先应该接受传递过来的当前所单击的部门的信息。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;AddDept&quot;</span>,</span><br><span class="line">  <span class="attr">props</span>:&#123;</span><br><span class="line">      <span class="attr">showDialog</span>:&#123;</span><br><span class="line">          <span class="attr">type</span>:<span class="title class_">Boolean</span>,</span><br><span class="line">          <span class="attr">default</span>:<span class="literal">false</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">treeNode</span>:&#123;</span><br><span class="line">          <span class="attr">type</span>:<span class="title class_">Object</span>,</span><br><span class="line">          <span class="attr">default</span>:<span class="literal">null</span></span><br><span class="line">      &#125;</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>

<p>这里在<code>props</code>中定义了<code>treeNode</code>属性接收父组件中传递过来的当前所单击的部门的信息，在当前所单击的部门下面查找对应的子部门，然后看看与现在新添加的部门是否有名称上的冲突。</p>
<p>问题：在哪传递<code>treeNode</code>?</p>
<p>在父组件中，返回到<code>index.vue</code>组件中传递所单击的部门的信息。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;/el-card&gt;</span><br><span class="line">    &lt;AddDept :showDialog=&quot;showDialog&quot; @closeAddDialog=&quot;closeAddDialog&quot; :treeNode=&quot;node&quot;&gt;&lt;/AddDept&gt;</span><br></pre></td></tr></table></figure>

<p>这里的<code>treeNode</code>的数据来自<code>node</code></p>
<p><code>node</code>中已经保存了所单击的部门的信息，如下所示：</p>
<p>就在当前父组件<code>index.vue</code>中的<code>addDepts</code>方法中，已经将所单击的部门信息保存到了<code>node</code>中。</p>
<p>当然，这里需要将<code>node</code>返回，这样在模板中才可以使用。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">     departs,</span><br><span class="line">     defaultProps,</span><br><span class="line">     company,</span><br><span class="line">     loading,</span><br><span class="line">     loadDepartments,</span><br><span class="line">     showDialog,</span><br><span class="line">     addDepts,</span><br><span class="line">     closeAddDialog,</span><br><span class="line">     node <span class="comment">// 返回node</span></span><br><span class="line">   &#125;;</span><br></pre></td></tr></table></figure>

<p>现在在返回到<code>add-dept.vue</code>组件中，在该组件中接收了传递过来的所单击的部门的信息，下面就是要查询一下在该单击的部门下的所有的子部门。看一下是否与新添加的部门名称有重复的。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> formRules = <span class="title function_">reactive</span>(&#123;</span><br><span class="line">       <span class="attr">departmentName</span>: [</span><br><span class="line">       &#123; <span class="attr">required</span>: <span class="literal">true</span>, <span class="attr">message</span>: <span class="string">&quot;部门名称不能为空&quot;</span>, <span class="attr">trigger</span>: <span class="string">&quot;blur&quot;</span> &#125;,</span><br><span class="line">       &#123; <span class="attr">min</span>: <span class="number">1</span>, <span class="attr">max</span>: <span class="number">50</span>, <span class="attr">message</span>: <span class="string">&quot;部门名称要求1-50个字符&quot;</span>, <span class="attr">trigger</span>: <span class="string">&quot;blur&quot;</span> &#125;,</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="attr">trigger</span>:<span class="string">&quot;blur&quot;</span>,</span><br><span class="line">           <span class="attr">validator</span>:checkNameRepeat <span class="comment">// 添加自定义检测</span></span><br><span class="line">       &#125;</span><br><span class="line">     ],</span><br></pre></td></tr></table></figure>

<p>在上面的代码中，首先指定了自定义校验，添加了<code>validator</code>属性，该属性的取值是<code>checkNameRepeat</code></p>
<p>下面实现<code>checkNameRepeat</code>方法，该方法的代码如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//---------------------------------------- 检测所添加的部门名称是否有重名的.</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">checkNameRepeat</span>=<span class="keyword">async</span>(<span class="params">rule,value,callback</span>)=&gt;&#123;</span><br><span class="line">          <span class="comment">// value参数中存储的是在文本框中用户输入的部门名称</span></span><br><span class="line">          <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="title function_">getDepartments</span>();</span><br><span class="line">          <span class="comment">// result中存储的是所有的部门</span></span><br><span class="line">            <span class="comment">// 先通过filter方法找所单击的部门下的所有的子部门</span></span><br><span class="line">    <span class="comment">// 然后再通过some方法查找所有的子部门名称与添加的部门名称是否有重名的，如果名称相同，some方法返回的是true</span></span><br><span class="line">        <span class="keyword">var</span> isRepeat =  result.<span class="title function_">filter</span>(<span class="function">(<span class="params">item</span>)=&gt;</span>item.<span class="property">parentId</span>===props.<span class="property">treeNode</span>.<span class="property">id</span>).<span class="title function_">some</span>(<span class="function">(<span class="params">item</span>)=&gt;</span>item.<span class="property">departmentName</span>===value);</span><br><span class="line">        isRepeat?<span class="title function_">callback</span>(<span class="string">`同级部门下已经有<span class="subst">$&#123;value&#125;</span>的部门了`</span>):<span class="title function_">callback</span>();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> formRules = <span class="title function_">reactive</span>(&#123;</span><br><span class="line">      <span class="attr">departmentName</span>: [</span><br><span class="line">      &#123; <span class="attr">required</span>: <span class="literal">true</span>, <span class="attr">message</span>: <span class="string">&quot;部门名称不能为空&quot;</span>, <span class="attr">trigger</span>: <span class="string">&quot;blur&quot;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">min</span>: <span class="number">1</span>, <span class="attr">max</span>: <span class="number">50</span>, <span class="attr">message</span>: <span class="string">&quot;部门名称要求1-50个字符&quot;</span>, <span class="attr">trigger</span>: <span class="string">&quot;blur&quot;</span> &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">          <span class="attr">trigger</span>:<span class="string">&quot;blur&quot;</span>,</span><br><span class="line">          <span class="attr">validator</span>:checkNameRepeat <span class="comment">// 添加自定义检测</span></span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br></pre></td></tr></table></figure>

<p>在所定义的<code>formRules</code>校验规则对象上面实现了<code>checkNameRepeat</code>方法。</p>
<p>在上面的代码中，需要调用<code>getDepartments</code>方法发送请求获取最新的架构数据数据，所以这里需要将该方法进行导入</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; ref,watch,reactive &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;getDepartments&#125;<span class="keyword">from</span> <span class="string">&#x27;@/api/departments&#x27;</span></span><br></pre></td></tr></table></figure>

<p>返回到浏览器中进行测试。</p>
<p>下面实现关于部门编码规则的校验</p>
<p>校验的规则要求是<strong>：部门编码在整个模块中都不允许重复</strong></p>
<p>思路上是一样的。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 检查编码是否重复</span></span><br><span class="line">     <span class="keyword">const</span> <span class="title function_">checkCodeRepeat</span>=<span class="keyword">async</span>(<span class="params">rule,value,callback</span>)=&gt;&#123;</span><br><span class="line">          <span class="comment">// value参数中存储的是在文本框中用户输入的部门编码</span></span><br><span class="line">          <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="title function_">getDepartments</span>();</span><br><span class="line">          <span class="keyword">const</span> isRepeat = result.<span class="title function_">some</span>(<span class="function">(<span class="params">item</span>)=&gt;</span>item.<span class="property">departmentCode</span>==value&amp;&amp;value)<span class="comment">// 这里加一个 value不为空 因为我们的部门有可能没有code</span></span><br><span class="line">          isRepeat?<span class="title function_">callback</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`组织架构中已经有部门使用<span class="subst">$&#123;value&#125;</span>编码了`</span>)):<span class="title function_">callback</span>()</span><br><span class="line">     &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里是从所有的组织架构数据中进行查找，看一下是否有部门编码相同。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">departmentCode</span>: [</span><br><span class="line">        &#123; <span class="attr">required</span>: <span class="literal">true</span>, <span class="attr">message</span>: <span class="string">&quot;部门编码不能为空&quot;</span>, <span class="attr">trigger</span>: <span class="string">&quot;blur&quot;</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">min</span>: <span class="number">1</span>, <span class="attr">max</span>: <span class="number">50</span>, <span class="attr">message</span>: <span class="string">&quot;部门编码要求1-50个字符&quot;</span>, <span class="attr">trigger</span>: <span class="string">&quot;blur&quot;</span> &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">trigger</span>:<span class="string">&quot;blur&quot;</span>,</span><br><span class="line">            <span class="attr">validator</span>:checkCodeRepeat</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br></pre></td></tr></table></figure>

<p>在<code>departmentCode</code>中添加了自定义的校验，完成了对<code>checkCodeRepeat</code>方法的调用。</p>
<p>下面返回到浏览器中进行测试。</p>
<h3 id="17、新增部门–自定义校验问题"><a href="#17、新增部门–自定义校验问题" class="headerlink" title="17、新增部门–自定义校验问题"></a>17、新增部门–自定义校验问题</h3><p>在上一小节中已经实现了自定义的校验，</p>
<p>但是这里有一个问题。</p>
<p>当单击顶部的下拉框，添加<code>子部门</code>的时候，输入了重名的部门名称并没有给出提示。</p>
<p>返回到<code>views/departments/index.vue</code>组件中</p>
<p>在头部布局中也使用了<code>TreeTools</code>组件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 组织架构--头部布局 --&gt;</span><br><span class="line">     &lt;el-card&gt;</span><br><span class="line">       &lt;TreeTools :treeNode=&quot;company&quot;  :isRoot=&quot;true&quot;   @addDepts=&quot;addDepts&quot; &gt;&lt;/TreeTools&gt;</span><br></pre></td></tr></table></figure>

<p>这里的<code>treeNode</code>属性的值是<code>company</code>,<code>company</code>的定义如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> company=<span class="title function_">ref</span>(&#123;</span><br><span class="line">   <span class="attr">departmentName</span>:<span class="string">&quot;xxx教育集团&quot;</span>,</span><br><span class="line">     <span class="attr">manager</span>:<span class="string">&quot;负责人&quot;</span></span><br><span class="line"> &#125;)</span><br></pre></td></tr></table></figure>

<p>以上对象中没有添加<code>id</code></p>
<p>对应的<code>tree-tools.vue</code>组件中接收的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">props</span>: &#123;</span><br><span class="line">     <span class="comment">//   定义一个props属性</span></span><br><span class="line">     <span class="attr">treeNode</span>: &#123;</span><br><span class="line">       <span class="attr">type</span>: <span class="title class_">Object</span>, <span class="comment">// 对象类型</span></span><br><span class="line">       <span class="attr">required</span>: <span class="literal">true</span>, <span class="comment">// 要求对方使用您的组件的时候 必须传treeNode属性 如果不传 就会报错</span></span><br><span class="line">     &#125;,</span><br></pre></td></tr></table></figure>

<p><code>treeNode</code>中没有<code>id</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">operateDepts</span> = (<span class="params">type</span>) =&gt; &#123;</span><br><span class="line">   <span class="keyword">if</span> (type === <span class="string">&quot;add&quot;</span>) &#123;</span><br><span class="line">     <span class="comment">// 添加子部门</span></span><br><span class="line">     <span class="title function_">emit</span>(<span class="string">&#x27;addDepts&#x27;</span>,props.<span class="property">treeNode</span>);</span><br></pre></td></tr></table></figure>

<p>当单击<code>添加子部门</code>的时候，触发以上的<code>addDepts</code>自定义事件，同时传递了<code>treeNode</code>这个数据。</p>
<p>当父组件中，在父组件<code>index.vue</code>中，会调用<code>addDepts</code>方法，该方法的实现如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">addDepts</span> = (<span class="params">nodeValue</span>) =&gt; &#123;</span><br><span class="line">  showDialog.<span class="property">value</span> = <span class="literal">true</span>; <span class="comment">// 将showDialog的值修改为true,表示展示窗口</span></span><br><span class="line">  node.<span class="property">value</span> = nodeValue; <span class="comment">// 存储当前单击的部门的信息。</span></span><br><span class="line"> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;nodeValue = &#x27;</span>,node.<span class="property">value</span> );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>把传递过来的值有给了<code>node</code></p>
<p>而最终<code>node</code>传递给了<code>AddDept</code>组件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;AddDept :showDialog=&quot;showDialog&quot; @closeAddDialog=&quot;closeAddDialog&quot; :treeNode=&quot;node&quot;&gt;&lt;/AddDept&gt;</span><br></pre></td></tr></table></figure>

<p>在该组件中，接收<code>treeNode</code>中也就没有<code>id</code></p>
<p>怎样修改呢？</p>
<p>把<code>views/departments/index.vue</code>中给<code>company</code>对象添加一个<code>id</code>属性，并且取值是空字符串就可以了，如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> company=<span class="title function_">ref</span>(&#123;</span><br><span class="line">    <span class="attr">departmentName</span>:<span class="string">&quot;xxx教育集团&quot;</span>,</span><br><span class="line">      <span class="attr">manager</span>:<span class="string">&quot;负责人&quot;</span>,</span><br><span class="line">      <span class="attr">id</span>:<span class="number">0</span></span><br><span class="line"></span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>

<p>为什么传递是0？</p>
<p>原因是：当传递到了<code>add-dept.vue</code>这个组件以后</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">props</span>:&#123;</span><br><span class="line">      <span class="attr">showDialog</span>:&#123;</span><br><span class="line">          <span class="attr">type</span>:<span class="title class_">Boolean</span>,</span><br><span class="line">          <span class="attr">default</span>:<span class="literal">false</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">treeNode</span>:&#123;</span><br><span class="line">          <span class="attr">type</span>:<span class="title class_">Object</span>,</span><br><span class="line">          <span class="attr">default</span>:<span class="literal">null</span></span><br><span class="line">      &#125;</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>

<p><code>treeNode</code>中有<code>id</code>,并且是0</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> isRepeat =  result.<span class="title function_">filter</span>(<span class="function">(<span class="params">item</span>)=&gt;</span>item.<span class="property">parentId</span>===props.<span class="property">treeNode</span>.<span class="property">id</span>).<span class="title function_">some</span>(<span class="function">(<span class="params">item</span>)=&gt;</span>item.<span class="property">departmentName</span>===value); <span class="comment">//这里查找的id是0，表示的是所有的根部门，也就是说单击顶部下拉框添加子部门实际上就是添加的是该公司下的根部门,而根部门也不能出现同名的。</span></span><br><span class="line">       isRepeat?<span class="title function_">callback</span>(<span class="string">`同级部门下已经有<span class="subst">$&#123;value&#125;</span>的部门了`</span>):<span class="title function_">callback</span>();</span><br></pre></td></tr></table></figure>



<h3 id="18、新增部门–填充下拉框"><a href="#18、新增部门–填充下拉框" class="headerlink" title="18、新增部门–填充下拉框"></a>18、新增部门–填充下拉框</h3><p>服务端接口设计</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">HttpGet(<span class="string">&quot;simple&quot;</span>)</span>]</span><br><span class="line">       [<span class="meta">Authorize</span>]</span><br><span class="line">       <span class="function"><span class="keyword">public</span> IActionResult <span class="title">GetSimpleUser</span>()</span> </span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">var</span> userSimpleList = _userInfoService.LoadEntities(u=&gt;<span class="literal">true</span>);</span><br><span class="line">           <span class="keyword">return</span> Ok(<span class="keyword">new</span> ApiResult&lt;List&lt;UserInfo&gt;&gt;() &#123; Success=<span class="literal">true</span>,Message=<span class="string">&quot;获取用户信息成功&quot;</span>,Data=userSimpleList.Select(u=&gt; <span class="keyword">new</span> UserInfo() &#123;Id=u.Id,UserName=u.UserName &#125;).ToList() &#125;);</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>这里只查询了<code>Id,UserName</code>两个属性的值，因为这里我们填充下拉框，只需要使用到这两组数据。</p>
<p><strong>前端实现：</strong></p>
<p>这里首先构建一个<code>api</code>接口来获取员工的信息，</p>
<p>由于是获取员工的信息，所以我们在<code>src/api</code>目录下面创建<code>employees.js</code></p>
<p>文件，该文件中的代码如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> request <span class="keyword">from</span> <span class="string">&quot;@/utils/request&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  获取员工的简单列表(返回的数据中，只包含了员工姓名与编号)</span></span><br><span class="line"><span class="comment"> * **/</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getEmployeeSimple</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">request</span>(&#123;</span><br><span class="line">    <span class="attr">url</span>: <span class="string">&quot;/users/simple&quot;</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回到<code>views/departments/components/add-dept.vue</code>文件中进行代码的修改</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; ref,watch,reactive &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;getDepartments&#125;<span class="keyword">from</span> <span class="string">&#x27;@/api/departments&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; getEmployeeSimple &#125; <span class="keyword">from</span> <span class="string">&quot;@/api/employees&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>在上面的代码中，导入了<code>ref</code>和<code>getEmployeeSimple</code>这个方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">const</span> options =<span class="title function_">ref</span>([]);</span><br><span class="line"><span class="comment">// 检测所添加的部门名称是否有重名的.</span></span><br></pre></td></tr></table></figure>

<p>定义了一个<code>options</code>数组，存储获取到的员工的基本信息</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取员工的基本信息</span></span><br><span class="line">       <span class="keyword">const</span> <span class="title function_">getEmployeeSimplInfo</span> = <span class="keyword">async</span>(<span class="params"></span>)=&gt;&#123;</span><br><span class="line">         <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="title function_">getEmployeeSimple</span>()</span><br><span class="line">         options.<span class="property">value</span> = result;</span><br><span class="line">       &#125;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">       visible,</span><br><span class="line">       closeDialog,</span><br><span class="line">       formData,</span><br><span class="line">       formRules,</span><br><span class="line">       getEmployeeSimplInfo,</span><br><span class="line">       options</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>这里定义了<code>getEmployeeSimpleInfo</code>方法，在该方法中调用了<code>getEmployeeSimple</code>方法发送请求获取员工的基本信息。</p>
<p>将获取到的员工的基本信息存储到了<code>options</code>数组中。</p>
<p>最后，将<code>getEmployeeSimpleInfo</code>方法和<code>options</code>数组返回到模板中。</p>
<p>在模板中调用<code>getEmployeeSimpleInfo</code>方法。</p>
<p>下面修改模板中的代码，如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-form-item label=&quot;部门负责人&quot; prop=&quot;manager&quot;&gt;</span><br><span class="line">        &lt;el-select style=&quot;width: 80%&quot; placeholder=&quot;请选择&quot; v-model=&quot;formData.manager&quot; @focus=&quot;getEmployeeSimplInfo&quot; &gt;</span><br><span class="line">        &lt;el-option v-for=&quot;item in options&quot; :key=&quot;item.id&quot; :label=&quot;item.userName&quot; :value=&quot;item.userName+&#x27;:&#x27;+item.id&quot;&gt;&lt;!----------注意：这里是把负责人的名称与编号拼接在一起，发送给服务端。---------------&gt;</span><br><span class="line">        &lt;/el-option&gt;</span><br><span class="line">  &lt;/el-select&gt; &lt;!---注意:el-option要在el-select里面---&gt;</span><br><span class="line">      &lt;/el-form-item&gt;</span><br></pre></td></tr></table></figure>

<p>在上面的代码中，给<code>el-select</code>组件添加了<code>@focs</code>事件，当用鼠标点击下拉框的时候，下拉框会获取到焦点，从而会触发<code>focus</code>事件。该事件触发以后会调用<code>getEmployeeSimpleInfo</code>方法，获取基本的员工数据。</p>
<p>获取到的员工数据会在<code>options</code>数组中，所以下面开始对该数组进行遍历。</p>
<p>取出来的用户信息放到了<code>el-option</code>中。<code>label</code>表示展示的内容，<code>value</code>表示选中的对应的值。</p>
<p>返回到浏览器中进行测试。</p>
<h3 id="19、新增部门–完成部门添加"><a href="#19、新增部门–完成部门添加" class="headerlink" title="19、新增部门–完成部门添加"></a>19、新增部门–完成部门添加</h3><p><strong>前端代码实现</strong></p>
<p>下面要实现的功能就是当单击<code>确定</code>按钮额时候完成部门的添加。</p>
<p>关于新增部门的<code>api</code>方法定义在<code>src/api/departments.js</code>文件中对应的<code>addDepartments</code>方法，如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  新增部门接口</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * ****/</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">addDepartments</span>(<span class="params">data</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">request</span>(&#123;</span><br><span class="line">      <span class="attr">url</span>: <span class="string">&quot;/departments&quot;</span>,</span><br><span class="line">      <span class="attr">method</span>: <span class="string">&quot;post&quot;</span>,</span><br><span class="line">      data,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>下面修改<code>src/views/departments/components/add-dept.vue</code>文件中的代码</p>
<p>在添加部门前，也要判断表单是否通过校验</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-form label-width=&quot;120px&quot; :model=&quot;formData&quot; :rules=&quot;formRules&quot; ref=&quot;formRef&quot;&gt;</span><br></pre></td></tr></table></figure>

<p>所以这里给<code>el-form</code>添加了<code>ref</code>属性，关联的是<code>formRef</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-button type=&quot;primary&quot; size=&quot;small&quot;  @click=&quot;addOk(formRef)&quot;&gt;确定&lt;/el-button&gt;</span><br></pre></td></tr></table></figure>

<p>给<code>确定</code>按钮注册了单击事件，事件触发以后会执行<code>addOk</code>方法，将表单传递到该方法中</p>
<p>在<code>setup</code>入口函数中定义<code>formRef</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> options =<span class="title function_">ref</span>([]);</span><br><span class="line">  <span class="keyword">const</span> formRef = <span class="title function_">ref</span>(<span class="literal">null</span>); <span class="comment">// 创建formRef对象</span></span><br></pre></td></tr></table></figure>

<p>下面实现<code>addOk</code>方法。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// 新增部门</span></span><br><span class="line">     <span class="comment">// 完成部门添加</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">addOk</span> = (<span class="params">formEl</span>) =&gt; &#123;</span><br><span class="line">  formEl.<span class="title function_">validate</span>(<span class="keyword">async</span> (valid, fields) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (valid) &#123;</span><br><span class="line">     <span class="comment">// console.log(&quot;pid=&quot;,props.treeNode.id );</span></span><br><span class="line">     <span class="keyword">await</span> <span class="title function_">addDepartments</span>(&#123; ...formData, <span class="attr">parentId</span>: props.<span class="property">treeNode</span>.<span class="property">id</span> &#125;); <span class="comment">// 注意这里是将前面定义的formData对象(该对象已经与表单绑定在了一起，同时这里还需要parentId属性，指名当前添加的部门是哪个部门的子部门)</span></span><br><span class="line">      <span class="title function_">emit</span>(<span class="string">&quot;addDepts&quot;</span>);</span><br><span class="line">    &#125; </span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>在上面的代码中实现了<code>addOK</code>方法完成部门的添加，该方法的参数就是传递过来的<code>表单的实例</code></p>
<p>接收传递过来的表单的实例，调用<code>validate</code>方法进行校验，如果<code>valid</code>参数的值为<code>true</code>表示校验通过。然后调用<code>addDepartments</code>方法发送请求。</p>
<p>注意：这里有一个问题：</p>
<p>添加部门，除了要获取表单中用户输入的部门的信息以外，还需要指定所添加的部门是属于哪个部门的子部门。</p>
<p>所以这里我们需要给所添加的部门指定<code>parentId</code>属性，该属性的取值就是所单击的当前部门的<code>id</code>(这里将<code>formData</code>对象中存储的部门信息解构与<code>parentId</code>进行了合并)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; getDepartments, addDepartments &#125; <span class="keyword">from</span> <span class="string">&quot;@/api/departments&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>这里需要导入<code>addDepartments</code>方法。</p>
<p>当添加成功以后，触发自定义的事件<code>addDepts</code>，告诉父组件重新加载树形组件中部门的信息。</p>
<p>下面将<code>formRef</code>和<code>addOk</code>返回</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">        visible,</span><br><span class="line">        closeDialog,</span><br><span class="line">        formData,</span><br><span class="line">        formRules,</span><br><span class="line">        getEmployeeSimplInfo,</span><br><span class="line">        options,</span><br><span class="line">        formRef, <span class="comment">// 这里返回了formRef和addOk</span></span><br><span class="line">        addOk </span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>最后，返回到父组件中，指定自定义事件</p>
<p><code>views/departments/index.vue</code>组件中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;AddDept :showDialog=&quot;showDialog&quot; @closeAddDialog=&quot;closeAddDialog&quot; :treeNode=&quot;node&quot;      @addDepts=&quot;loadDepartments&quot;&gt;&lt;/AddDept&gt;</span><br></pre></td></tr></table></figure>

<p>这里指定了<code>addDepts</code>这个自定义事件，当该事件触发以后会重新调用<code>loadDepartments</code>方法，发送请求重新加载部门信息数据。</p>
<p><strong>服务端接口实现</strong></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">HttpPost</span>]</span><br><span class="line">       [<span class="meta">Authorize</span>]</span><br><span class="line">       [<span class="meta">UnitOfWork(new Type[</span>] &#123; <span class="keyword">typeof</span>(MyDbContext) &#125;)]</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">AddDepartment</span>(<span class="params">[FromBody]Department department</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">          <span class="built_in">string</span>[] strs = department.Manager!.Split(<span class="string">&quot;:&quot;</span>); <span class="comment">//注意前端提交过来的Manager中包含的内容</span></span><br><span class="line">           department.Manager = strs[<span class="number">0</span>];</span><br><span class="line">           department.ManagerId = Convert.ToInt32(strs[<span class="number">1</span>]);</span><br><span class="line">           department.City = <span class="string">&quot;北京&quot;</span>;</span><br><span class="line">           department.CreateTime = DateTime.Now;</span><br><span class="line">           department.UpdateTime = DateTime.Now;</span><br><span class="line">           department.DelFlag =Convert.ToBoolean(DelFlagEnum.Normal);</span><br><span class="line">           <span class="keyword">await</span> _departmentsService.InsertEntityAsync(department);</span><br><span class="line">           <span class="keyword">return</span> Ok(<span class="keyword">new</span> ApiResult&lt;Department&gt;() &#123; Success = <span class="literal">true</span>, Message = <span class="string">&quot;添加成功&quot;</span>, Data = department &#125;);</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>启动项目进行测试。</p>
<h3 id="20、新增部门–关闭新增弹层"><a href="#20、新增部门–关闭新增弹层" class="headerlink" title="20、新增部门–关闭新增弹层"></a>20、新增部门–关闭新增弹层</h3><p>当新增完部门的信息以后，我们要将当前弹出的窗口关闭掉。</p>
<p>关闭窗口其实我们前面也已经实现了。</p>
<p>在<code>add-dept.vue</code>这个组件对应的<code>addOk</code>方法中，我们也要触发<code>closeAddDialog</code>事件就可以了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 新增部门</span></span><br><span class="line">        <span class="comment">// 完成部门添加</span></span><br><span class="line">   <span class="keyword">const</span> <span class="title function_">addOk</span> = (<span class="params">formEl</span>) =&gt; &#123;</span><br><span class="line">     formEl.<span class="title function_">validate</span>(<span class="keyword">async</span> (valid, fields) =&gt; &#123;</span><br><span class="line">       <span class="keyword">if</span> (valid) &#123;</span><br><span class="line">        <span class="comment">// console.log(&quot;pid=&quot;,props.treeNode.id );</span></span><br><span class="line">        <span class="keyword">await</span> <span class="title function_">addDepartments</span>(&#123; ...formData, <span class="attr">parentId</span>: props.<span class="property">treeNode</span>.<span class="property">id</span> &#125;);</span><br><span class="line">         <span class="title function_">emit</span>(<span class="string">&quot;addDepts&quot;</span>);</span><br><span class="line">         <span class="title function_">emit</span>(<span class="string">&quot;closeAddDialog&quot;</span>,<span class="literal">false</span>); <span class="comment">//-------------------触发closeAddDialog事件</span></span><br><span class="line">       &#125; </span><br><span class="line">     &#125;);</span><br></pre></td></tr></table></figure>

<h3 id="21、新增部门–重置状态"><a href="#21、新增部门–重置状态" class="headerlink" title="21、新增部门–重置状态"></a>21、新增部门–重置状态</h3><p>这里有一个问题，在弹出的<code>添加部门</code>窗口中，我们没有在表单中输入任何数据，直接点击<code>添加</code>在，这时候会出现错误的提示。</p>
<p>这时候，单击<code>取消按钮，将窗口关闭，然后再次单击</code>添加子部门<code>，把窗口弹出来，发现错误提示信息还存在，所以这里需要在单击</code>取消&#96;按钮关闭窗口前，先将这些错误的提示状态清除掉。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-button size=&quot;small&quot; @click=&quot;closeDialog(formRef)&quot;&gt;取消&lt;/el-button&gt;</span><br></pre></td></tr></table></figure>

<p>在调用<code>btnCancel</code>方法的时候，将<code>formRef</code>这个表单的实例传递到该方法中。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 关闭窗口</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">closeDialog</span>=(<span class="params">formEl</span>)=&gt;&#123;</span><br><span class="line">    <span class="comment">//console.log(&#x27;hello&#x27;);</span></span><br><span class="line">    <span class="title function_">emit</span>(<span class="string">&#x27;closeAddDialog&#x27;</span>,<span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">if</span>(!formEl) <span class="keyword">return</span>;</span><br><span class="line">    formEl.<span class="title function_">resetFields</span>();</span><br><span class="line">&#125;</span><br><span class="line">      </span><br></pre></td></tr></table></figure>

<p>这里，调用了<code>resetFields</code>方法，重置了对应的状态。</p>
<p>返回到浏览器中进行测试。</p>
<p><strong>当单击窗口右上角的<code>叉号</code>图标的时候，也需要将窗口关闭掉。</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-dialog</span><br><span class="line">    title=&quot;新增部门&quot;</span><br><span class="line">    v-model=&quot;visible&quot;</span><br><span class="line">    :close-on-click-modal=&quot;false&quot;</span><br><span class="line">    @close=&quot;closeDialog&quot;</span><br><span class="line">  &gt;</span><br></pre></td></tr></table></figure>

<h3 id="22、编辑部门–弹出编辑窗口"><a href="#22、编辑部门–弹出编辑窗口" class="headerlink" title="22、编辑部门–弹出编辑窗口"></a>22、编辑部门–弹出编辑窗口</h3><p>编辑部门功能实际上和新增窗体采用的是一个组件，只不过我们需要将新增场景变成编辑场景</p>
<p>当单击<code>操作--编辑部门</code>的时候，记录所单击的节点，然后弹出窗口，把数据填充到表单中。</p>
<p>下面修改<code>views/departments/components/tree-tools.vue</code>组件中的代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">setup</span>(<span class="params">props,&#123;emit&#125;</span>)&#123;</span><br><span class="line">     <span class="keyword">const</span> <span class="title function_">operateDepts</span> = (<span class="params">type</span>) =&gt; &#123;</span><br><span class="line">     <span class="keyword">if</span> (type === <span class="string">&quot;add&quot;</span>) &#123;</span><br><span class="line">       <span class="comment">// 添加子部门</span></span><br><span class="line">       <span class="title function_">emit</span>(<span class="string">&#x27;addDepts&#x27;</span>,props.<span class="property">treeNode</span>);</span><br><span class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type === <span class="string">&quot;edit&quot;</span>) &#123;</span><br><span class="line">          <span class="comment">// 编辑子部门</span></span><br><span class="line">          <span class="title function_">emit</span>(<span class="string">&quot;editDepts&quot;</span>, props.<span class="property">treeNode</span>);</span><br></pre></td></tr></table></figure>

<p>这里触发了<code>editDepts</code> 事件，传递的是所点击的部门的数据。</p>
<p>返回到父组件<code>departments/index.vue</code>组件中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;TreeTools :treeNode=&quot;data&quot; @delDepts=&quot;loadDepartments&quot;     @addDepts=&quot;addDepts&quot;   @editDepts=&quot;editDepts&quot;&gt;&lt;/TreeTools&gt;</span><br><span class="line">         &lt;/template&gt;</span><br></pre></td></tr></table></figure>

<p>这里是给第二个,也就是<code>el-tree</code>中的<code>TreeTools</code>中注册自定义事件<code>editDepts</code>，当该事件触发以后，会调用<code>editDepts</code>方法。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 编辑部门节点</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">editDepts</span> = (<span class="params">node</span>) =&gt; &#123;</span><br><span class="line">      <span class="comment">// 首先打开弹层</span></span><br><span class="line">      showDialog.<span class="property">value</span> = <span class="literal">true</span>;</span><br><span class="line">      node.<span class="property">value</span> = node; <span class="comment">// 赋值操作的节点</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      departs,</span><br><span class="line">      defaultProps,</span><br><span class="line">      company,</span><br><span class="line">      loading,</span><br><span class="line">      loadDepartments,</span><br><span class="line">      showDialog,</span><br><span class="line">      addDepts,</span><br><span class="line">      closeAddDialog,</span><br><span class="line">      node,</span><br><span class="line">      editDepts <span class="comment">// 返回</span></span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>

<p>实现了<code>editDepts</code>方法,将<code>editDepts</code>方法返回，返回到浏览器中进行测试</p>
<h3 id="23、编辑部门–展示编辑部门信息"><a href="#23、编辑部门–展示编辑部门信息" class="headerlink" title="23、编辑部门–展示编辑部门信息"></a>23、编辑部门–展示编辑部门信息</h3><p>前端会将要编辑的部门编号传递到服务端，服务端接收到该编号后，查询出要编辑的部门信息，然后返回到前端。</p>
<p>这里我们先来实现服务端的接口。</p>
<p><strong>服务端接口实现</strong></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">HttpGet(<span class="string">&quot;&#123;id&#125;&quot;</span>)</span>]</span><br><span class="line">       [<span class="meta">Authorize</span>]</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">GetDepartmentById</span>(<span class="params">[FromRoute]<span class="built_in">int</span> id</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">var</span> depart = <span class="keyword">await</span> _departmentsService.LoadEntities(d =&gt; d.Id == id).FirstOrDefaultAsync();</span><br><span class="line">           <span class="keyword">if</span>(depart == <span class="literal">null</span>)</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">return</span> BadRequest(<span class="string">&quot;没有找到部门信息&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> Ok(<span class="keyword">new</span> ApiResult&lt;Department&gt;() &#123; Success=<span class="literal">true</span>, Message =<span class="string">&quot;获取到部门信息&quot;</span>, Data = depart &#125;);</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p><strong>前端实现</strong></p>
<p>现在已经展示出来了编辑部门的窗口</p>
<p>接来下把要编辑的部门信息填充到表单中。</p>
<p>这里先构建一个<code>api</code>接口，请求服务端，获取要编辑的部门信息。</p>
<p>修改<code>src/api/departments.js</code>文件中的代码，增加如下的方法s</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** *</span></span><br><span class="line"><span class="comment"> * 获取部门详情</span></span><br><span class="line"><span class="comment"> * ***/</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getDepartDetail</span>(<span class="params">id</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">request</span>(&#123;</span><br><span class="line">    <span class="attr">url</span>: <span class="string">`/departments/<span class="subst">$&#123;id&#125;</span>`</span>,</span><br><span class="line">    <span class="attr">method</span>:<span class="string">&quot;get&quot;</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面返回到<code>views/departments/components/add-dept.vue</code>组件中进行代码的修改</p>
<p>我们知道在该组件中定义了<code>formData</code>这个响应式对象，而该对象已经与表单元素进行了双向数据绑定，这里只要将服务端返回的要修改的部门数据交给<code>formData</code>,对应的表单中就会展示要编辑的部门信息。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将编辑的部门信息填充到表单中。</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">getDepartDetailInfo</span> = <span class="keyword">async</span> (<span class="params">id</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="title function_">getDepartDetail</span>(id);</span><br><span class="line">    formData.<span class="property">departmentCode</span> = result.<span class="property">departmentCode</span>;</span><br><span class="line">    formData.<span class="property">departmentDescription</span> = result.<span class="property">departmentDescription</span>;</span><br><span class="line">   <span class="comment">// formData.manager = result.manager;</span></span><br><span class="line">        formData.<span class="property">manager</span> = result.<span class="property">manager</span>;</span><br><span class="line">    formData.<span class="property">departmentName</span> = result.<span class="property">departmentName</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">     <span class="keyword">return</span> &#123;</span><br><span class="line">      visible,</span><br><span class="line">      closeDialog,</span><br><span class="line">      formData,</span><br><span class="line">      formRules,</span><br><span class="line">      getEmployeeSimplInfo,</span><br><span class="line">      options,</span><br><span class="line">      formRef,</span><br><span class="line">      addOk,</span><br><span class="line">      getDepartDetailInfo</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>

<p>这里单独的定义了一个<code>getDepartDetailInfo</code>方法，在该方法中调用了<code>getDepartDetail</code>方法，发送请求获取部门信息，交给<code>formData</code>对象中的各个属性。</p>
<p>并且返回</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;getDepartments,addDepartments,getDepartDetail&#125;<span class="keyword">from</span> <span class="string">&#x27;@/api/departments&#x27;</span></span><br></pre></td></tr></table></figure>

<p>这里导入了<code> getDepartDetail</code>方法。</p>
<p>问题：<code>getDepartDetailInfo</code>方法在哪被调用？</p>
<p>在父组件中进行调用(弹出编辑窗口的时候就应该调用该方法，获取要编辑的部门信息，然后填充到表单中)</p>
<p><code>views/departments/index.vue</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;AddDept :showDialog=&quot;showDialog&quot; @closeAddDialog=&quot;closeAddDialog&quot; :treeNode=&quot;node&quot;      @addDepts=&quot;loadDepartments&quot;  ref=&quot;addDept&quot;&gt;&lt;/AddDept&gt;</span><br></pre></td></tr></table></figure>

<p>给<code>AddDept</code>添加了一个<code>ref</code>属性，取值为<code>addDept</code>,也就是关联了一个<code>AddDept</code>对象</p>
<p>在<code>setup</code>入口函数中，定义<code>addDept</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> showDialog = <span class="title function_">ref</span>(<span class="literal">false</span>); <span class="comment">// 控制窗口的弹出与隐藏</span></span><br><span class="line">   <span class="keyword">const</span> node = <span class="title function_">ref</span>(<span class="literal">null</span>);</span><br><span class="line">   <span class="keyword">const</span> addDept = <span class="title function_">ref</span>(<span class="literal">null</span>); <span class="comment">// 定义addDept</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 编辑部门节点</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">editDepts</span> = (<span class="params">node</span>) =&gt; &#123;</span><br><span class="line">    </span><br><span class="line">      <span class="comment">// 首先打开弹层</span></span><br><span class="line">      showDialog.<span class="property">value</span> = <span class="literal">true</span>;</span><br><span class="line">      node.<span class="property">value</span> = node; <span class="comment">// 赋值操作的节点</span></span><br><span class="line">      addDept.<span class="property">value</span>.<span class="title function_">getDepartDetailInfo</span>(node.<span class="property">id</span>);<span class="comment">//----------------- 这里调用了子组件中的getDepartDetailInfo方法</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      departs,</span><br><span class="line">      defaultProps,</span><br><span class="line">      company,</span><br><span class="line">      loading,</span><br><span class="line">      loadDepartments,</span><br><span class="line">      showDialog,</span><br><span class="line">      addDepts,</span><br><span class="line">      closeAddDialog,</span><br><span class="line">      node,</span><br><span class="line">      editDepts,</span><br><span class="line">      addDept <span class="comment">//----------------------------将addDept返回。</span></span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>

<p>在<code>editDepts</code>中通过<code>addDept</code>这个<code>ref</code>对象找到<code>AddDept</code>这个实例对象，然后调用内部的<code>getDepartDetailInfo方法，传递的是所点击的要编辑的部门的</code>编号。</p>
<p>最后补充一个知识点细节问题：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vue3中直接对reactive整个对象赋值检测不到</span></span><br><span class="line"><span class="keyword">let</span> obj = <span class="title function_">reactive</span>(&#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;zhangsan&#x27;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="string">&#x27;18&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line">obj = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;lisi&#x27;</span></span><br><span class="line">    <span class="attr">age</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 上面这样赋值检测不到，因为响应式的是它的属性，而不是它自身</span></span><br><span class="line">             </span><br><span class="line"><span class="comment">// 如需要对 reactive 赋值</span></span><br><span class="line"><span class="comment">// 方法1: 单个赋值</span></span><br><span class="line">obj[<span class="string">&#x27;name&#x27;</span>] = <span class="string">&#x27;lisi&#x27;</span>;</span><br><span class="line">obj[<span class="string">&#x27;age&#x27;</span>] = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="comment">// 方法2：多包一层</span></span><br><span class="line"><span class="keyword">let</span> obj = <span class="title function_">reactive</span>(&#123;</span><br><span class="line">    <span class="attr">data</span>: &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;zhangsan&#x27;</span>,</span><br><span class="line">        <span class="attr">age</span>: <span class="string">&#x27;18&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">obj.<span class="property">data</span> = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;lisi&#x27;</span></span><br><span class="line">    <span class="attr">age</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="24、编辑部门–切换标题"><a href="#24、编辑部门–切换标题" class="headerlink" title="24、编辑部门–切换标题"></a>24、编辑部门–切换标题</h3><p>现在编辑与新增使用一个窗口，对应的标题也需要进行切换。</p>
<p>怎样进行切换呢？</p>
<p>下面修改<code>add-dept.vue</code>这个组件中的代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">const</span> formData = <span class="title function_">reactive</span>(&#123;</span><br><span class="line">    <span class="attr">departmentName</span>: <span class="string">&quot;&quot;</span>, <span class="comment">// 部门名称</span></span><br><span class="line">    <span class="attr">departmentCode</span>: <span class="string">&quot;&quot;</span>, <span class="comment">// 部门编码</span></span><br><span class="line">    <span class="attr">manager</span>: <span class="string">&quot;&quot;</span>, <span class="comment">// 部门管理者</span></span><br><span class="line">    <span class="attr">departmentDescription</span>: <span class="string">&quot;&quot;</span>, <span class="comment">// 部门介绍</span></span><br><span class="line">    <span class="attr">id</span>:<span class="string">&quot;&quot;</span><span class="comment">// ----部门编号</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>在<code>formData</code>对象中又添加了一个<code>id</code>属性，表示部门的编号</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将编辑的部门信息填充到表单中。</span></span><br><span class="line">   <span class="keyword">const</span> <span class="title function_">getDepartDetailInfo</span> = <span class="keyword">async</span> (<span class="params">id</span>) =&gt; &#123;</span><br><span class="line">     <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="title function_">getDepartDetail</span>(id);</span><br><span class="line">     formData.<span class="property">departmentCode</span> = result.<span class="property">departmentCode</span>;</span><br><span class="line">     formData.<span class="property">departmentDescription</span> = result.<span class="property">departmentDescription</span>;</span><br><span class="line">     formData.<span class="property">manager</span> = result.<span class="property">manager</span>;</span><br><span class="line">     formData.<span class="property">departmentName</span> = result.<span class="property">departmentName</span>;</span><br><span class="line">     formData.<span class="property">id</span> = result.<span class="property">id</span>;<span class="comment">// 将服务端返回的部门编号赋值给formData对象中的id属性</span></span><br><span class="line">   &#125;;</span><br></pre></td></tr></table></figure>

<p>在<code>getDepartDetailInfo</code>方法中获取了部门详情数据，这里肯定有部门的编号，将其赋值给<code>formData</code>对象中的<code>id</code>属性。</p>
<p>这就说明了，在编辑的时候该<code>id</code>属性是有值的，而新增的时候是没有值的。</p>
<p>所以当该<code>id</code>属性的 值发生了变化以后，就可以进行判断是编辑还是添加</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> showTitle = <span class="title function_">computed</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">     <span class="keyword">return</span> formData.<span class="property">id</span> ? <span class="string">&quot;编辑部门&quot;</span> : <span class="string">&quot;新增子部门&quot;</span>;</span><br><span class="line">   &#125;);</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">       visible,</span><br><span class="line">       closeDialog,</span><br><span class="line">       formData,</span><br><span class="line">       formRules,</span><br><span class="line">       getEmployeeSimplInfo,</span><br><span class="line">       options,</span><br><span class="line">       formRef,</span><br><span class="line">       addOk,</span><br><span class="line">       getDepartDetailInfo,</span><br><span class="line">       showTitle</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>这里我们添加了一个计算属性，根据<code>id</code>属性的值进行判断。</p>
<p>当然也需要将<code>showTitle</code>进行返回。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; ref,watch,reactive,computed &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>这里也需要从<code>vue</code>中导入<code>computed</code>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 新增部门的弹层 --&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">el-dialog</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">    <span class="attr">:title</span>=<span class="string">&quot;showTitle&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">    <span class="attr">v-model</span>=<span class="string">&quot;visible&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">    <span class="attr">:close-on-click-modal</span>=<span class="string">&quot;false&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">    @<span class="attr">close</span>=<span class="string">&quot;closeDialog&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">  &gt;</span></span></span><br></pre></td></tr></table></figure>

<p>修改了<code>el-dialog</code>中的<code>title</code>属性的值，现在取值是<code>showTitle</code>.</p>
<p>返回到浏览器中进行测试。</p>
<p>在测试的时候，发现了一个问题，</p>
<p>首先单击<code>添加子部门</code>，展示的窗口中显示的标题是<code>添加子部门</code>,然后关闭窗口，再点击<code>编辑部门</code>，在弹出的窗口中展示的<code>标题是编辑部门</code>。</p>
<p>关闭窗口，再单击<code>添加子部门</code>，弹出的窗口的标题还是<code>编辑部门</code>。</p>
<p>原因是：当单击<code>编辑部门</code>弹出窗口后，进行了关闭，会执行如下代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 关闭窗口</span></span><br><span class="line">     <span class="keyword">const</span> <span class="title function_">closeDialog</span>=(<span class="params">formEl</span>)=&gt;&#123;</span><br><span class="line">         <span class="comment">//console.log(&#x27;hello&#x27;);</span></span><br><span class="line">         <span class="title function_">emit</span>(<span class="string">&#x27;closeAddDialog&#x27;</span>,<span class="literal">false</span>);</span><br><span class="line">         <span class="keyword">if</span>(!formEl) <span class="keyword">return</span>;</span><br><span class="line">         formEl.<span class="title function_">resetFields</span>();</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>

<p>这里调用了<code>formEl.resetFields</code>方法，只是将与表单绑定的<code>formData</code>对象中的属性清除了，没有将<code>id</code>进行清除。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 关闭窗口</span></span><br><span class="line">       <span class="keyword">const</span> <span class="title function_">closeDialog</span>=(<span class="params">formEl</span>)=&gt;&#123;</span><br><span class="line">           <span class="comment">//console.log(&#x27;hello&#x27;);</span></span><br><span class="line">           <span class="title function_">emit</span>(<span class="string">&#x27;closeAddDialog&#x27;</span>,<span class="literal">false</span>);</span><br><span class="line">           <span class="keyword">if</span>(!formEl) <span class="keyword">return</span>;</span><br><span class="line">           formEl.<span class="title function_">resetFields</span>();</span><br><span class="line">           formData.<span class="property">id</span> =<span class="string">&quot;&quot;</span>; <span class="comment">// 将id的值清空。</span></span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>这里将<code>formData</code>中的<code>id</code>值清空。</p>
<p>返回到浏览器中进行测试。</p>
<h3 id="25、编辑部门–完成编辑"><a href="#25、编辑部门–完成编辑" class="headerlink" title="25、编辑部门–完成编辑"></a>25、编辑部门–完成编辑</h3><p><strong>前端实现</strong></p>
<p>当单击<code>确定</code>按钮的时候，要区分是添加部门信息还是编辑部门的信息</p>
<p>这里先增加一个更新部门的<code>api</code>接口在<code>api/departments.js</code>文件中添加如下方法：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 编辑部门</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * ***/</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">updateDepartments</span>(<span class="params">data</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">request</span>(&#123;</span><br><span class="line">    <span class="attr">url</span>: <span class="string">`/departments/<span class="subst">$&#123;data.id&#125;</span>`</span>,</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&quot;put&quot;</span>,</span><br><span class="line">    data,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在调用以上方法的时候，会传递过来要更新的部门数据，数据中会有编号。</p>
<p>下面返回到<code>add-dept.vue</code>组件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">addOk</span> = (<span class="params">formEl</span>) =&gt; &#123;</span><br><span class="line">      formEl.<span class="title function_">validate</span>(<span class="keyword">async</span> (valid, fields) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (valid) &#123;</span><br><span class="line">          <span class="keyword">if</span>(formData.<span class="property">id</span>)&#123;</span><br><span class="line">            <span class="comment">// id有值，表示更新的操作</span></span><br><span class="line">            <span class="keyword">await</span> <span class="title function_">updateDepartments</span>(formData);</span><br><span class="line">          &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">await</span> <span class="title function_">addDepartments</span>(&#123; ...formData, <span class="attr">parentId</span>: props.<span class="property">treeNode</span>.<span class="property">id</span> &#125;);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="title function_">emit</span>(<span class="string">&quot;addDepts&quot;</span>);</span><br><span class="line">          <span class="title function_">emit</span>(<span class="string">&quot;closeAddDialog&quot;</span>,<span class="literal">false</span>);</span><br><span class="line">        &#125; </span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>

<p>我们知道，在单击<code>确定</code>按钮的时候，会调用<code>addOk</code>方法。在该方法中判断<code>formData.id</code>是否有值，如果有值调用<code>updateDepartments</code>方法进行数据的更新。</p>
<p>当然更新成功也需要重新加载数据，关闭窗口。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;getDepartments,addDepartments,getDepartDetail,updateDepartments&#125;<span class="keyword">from</span> <span class="string">&#x27;@/api/departments&#x27;</span></span><br></pre></td></tr></table></figure>

<p>这里导入了<code>updateDepartments</code>方法。返回到浏览器中进行测试。</p>
<p>在测试的时候发现了问题，进行编辑的时候，直接单击<code>确定</code>按钮，发现给出了<code>部门名称与部门编码的</code>错误。</p>
<p>为什么会给出这个错误的提示呢？因为这里是更新，而且是直接单击了<code>确定</code>按钮，没有更改<code>部门名称和部门编码</code>所以服务端已经存储了相同名称的部门名称和部门编码。所以才会出现这样的错误。</p>
<p>所以说，在编辑的时候关于业务规则的校验是不能与添加的时候一样的。</p>
<p>继续修改<code>add-dept.vue</code>组件中的代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 检测所添加的部门名称是否有重名的.</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">checkNameRepeat</span>=<span class="keyword">async</span>(<span class="params">rule,value,callback</span>)=&gt;&#123;</span><br><span class="line">            <span class="comment">// value参数中存储的是在文本框中用户输入的部门名称</span></span><br><span class="line">            <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="title function_">getDepartments</span>();</span><br><span class="line">            <span class="keyword">let</span> isRepeat =<span class="literal">false</span>;<span class="comment">//---------------------重新定义了isRepeat变量</span></span><br><span class="line">        <span class="keyword">if</span>(formData.<span class="property">id</span>)&#123; <span class="comment">//-------------------------------------------添加了编辑状态下的判断</span></span><br><span class="line">        </span><br><span class="line">            <span class="comment">// 表示在编辑模式下</span></span><br><span class="line">        <span class="comment">// 要求：同级部门下，不能出现和其它同级部门的名字重复</span></span><br><span class="line">        <span class="comment">// 先查找当前所单击的要编辑的部门的所有同级部门。并且不是自己，然后在看一下新输入的部门名称是否有重名的。</span></span><br><span class="line">        isRepeat = result</span><br><span class="line">          .<span class="title function_">filter</span>(</span><br><span class="line">            <span class="function">(<span class="params">item</span>) =&gt;</span></span><br><span class="line">              item.<span class="property">parentId</span> === formData.<span class="property">parentId</span> &amp;&amp; item.<span class="property">id</span> !== formData.<span class="property">id</span></span><br><span class="line">          )</span><br><span class="line">          .<span class="title function_">some</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> item.<span class="property">departmentName</span> === value);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="comment">// result中存储的是所有的部门</span></span><br><span class="line">                  <span class="comment">// 先通过filter方法找所单击的部门下的所有的子部门</span></span><br><span class="line">          <span class="comment">// 然后再通过some方法查找所有的子部门名称与添加的部门名称是否有重名的，如果名称相同，some方法返回的是true</span></span><br><span class="line">          isRepeat =  result.<span class="title function_">filter</span>(<span class="function">(<span class="params">item</span>)=&gt;</span>item.<span class="property">parentId</span>===props.<span class="property">treeNode</span>.<span class="property">id</span>).<span class="title function_">some</span>(<span class="function">(<span class="params">item</span>)=&gt;</span>item.<span class="property">departmentName</span>===value);</span><br><span class="line">        &#125;</span><br><span class="line">         </span><br><span class="line">          isRepeat?<span class="title function_">callback</span>(<span class="string">`同级部门下已经有<span class="subst">$&#123;value&#125;</span>的部门了`</span>):<span class="title function_">callback</span>();</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 检查编码是否重复</span></span><br><span class="line">        <span class="keyword">const</span> <span class="title function_">checkCodeRepeat</span>=<span class="keyword">async</span>(<span class="params">rule,value,callback</span>)=&gt;&#123;</span><br><span class="line">             <span class="comment">// value参数中存储的是在文本框中用户输入的部门编码</span></span><br><span class="line">             <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="title function_">getDepartments</span>();</span><br><span class="line">             <span class="keyword">let</span> isRepeat =<span class="literal">false</span>;</span><br><span class="line">             <span class="keyword">if</span>(formData.<span class="property">id</span>)&#123;</span><br><span class="line">               <span class="comment">//------------------------- 编辑模式  因为编辑模式下 不能算自己(注意：编号在整个组织架构中是不允许出现重复的)</span></span><br><span class="line">        isRepeat = result.<span class="title function_">some</span>(</span><br><span class="line">          <span class="function">(<span class="params">item</span>) =&gt;</span> item.<span class="property">id</span> !== formData.<span class="property">id</span> &amp;&amp; item.<span class="property">departmentCode</span> === value &amp;&amp; value</span><br><span class="line">        );</span><br><span class="line">         &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">              isRepeat = result.<span class="title function_">some</span>(<span class="function">(<span class="params">item</span>)=&gt;</span>item.<span class="property">departmentCode</span>==value&amp;&amp;value)<span class="comment">// 这里加一个 value不为空 因为我们的部门有可能没有code</span></span><br><span class="line">             &#125;</span><br><span class="line">             </span><br><span class="line">             isRepeat?<span class="title function_">callback</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`组织架构中已经有部门使用<span class="subst">$&#123;value&#125;</span>编码了`</span>)):<span class="title function_">callback</span>()</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>在上面的判断中使用了<code>parentId</code>,所以需要在<code>formData</code>中去定义<code>parentId</code>这个属性。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> formData = <span class="title function_">reactive</span>(&#123;</span><br><span class="line">       <span class="attr">departmentName</span>: <span class="string">&quot;&quot;</span>, <span class="comment">// 部门名称</span></span><br><span class="line">       <span class="attr">departmentCode</span>: <span class="string">&quot;&quot;</span>, <span class="comment">// 部门编码</span></span><br><span class="line">       <span class="attr">manager</span>: <span class="string">&quot;&quot;</span>, <span class="comment">// 部门管理者</span></span><br><span class="line">       <span class="attr">departmentDescription</span>: <span class="string">&quot;&quot;</span>, <span class="comment">// 部门介绍</span></span><br><span class="line">       <span class="attr">id</span>:<span class="string">&quot;&quot;</span>,<span class="comment">// 部门编号</span></span><br><span class="line">      <span class="attr">parentId</span>:<span class="string">&quot;&quot;</span>  <span class="comment">// 父级编号</span></span><br><span class="line">   &#125;);</span><br></pre></td></tr></table></figure>

<p>同时在<code>getDepartDetailInfo</code>方法中给<code>parentId</code>属性赋值。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将编辑的部门信息填充到表单中。</span></span><br><span class="line">   <span class="keyword">const</span> <span class="title function_">getDepartDetailInfo</span> = <span class="keyword">async</span> (<span class="params">id</span>) =&gt; &#123;</span><br><span class="line">     <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="title function_">getDepartDetail</span>(id);</span><br><span class="line">     formData.<span class="property">departmentCode</span> = result.<span class="property">departmentCode</span>;</span><br><span class="line">     formData.<span class="property">departmentDescription</span> = result.<span class="property">departmentDescription</span>;</span><br><span class="line">     formData.<span class="property">manager</span> = result.<span class="property">manager</span>;</span><br><span class="line">     formData.<span class="property">departmentName</span> = result.<span class="property">departmentName</span>;</span><br><span class="line">   formData.<span class="property">parentId</span> =result.<span class="property">parentId</span>;</span><br><span class="line">     formData.<span class="property">id</span> = id;</span><br><span class="line">   &#125;;</span><br></pre></td></tr></table></figure>

<p>在编辑的时候会调用<code>getDepartDetailInfo</code>方法，在该方法中给<code>parentId</code>赋值</p>
<p>返回到浏览器中进行测试。</p>
<p>这里进行部门编辑的时候，可以先不输入任何的数据，然后单击<code>确定</code>按钮看一下</p>
<p>然后在输入新的内容，进行测试，看一下效果。</p>
<p><strong>服务端实现</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[<span class="title class_">HttpPut</span>(<span class="string">&quot;&#123;id&#125;&quot;</span>)]</span><br><span class="line">      [<span class="title class_">UnitOfWork</span>(<span class="keyword">new</span> <span class="title class_">Type</span>[] &#123; <span class="title function_">typeof</span>(<span class="title class_">MyDbContext</span>) &#125;)]</span><br><span class="line">      public <span class="keyword">async</span> <span class="title class_">Task</span>&lt;<span class="title class_">IActionResult</span>&gt; <span class="title class_">UpdateDepartment</span>([<span class="title class_">FromRoute</span>]int id, [<span class="title class_">FromBody</span>]<span class="title class_">Department</span> department)</span><br><span class="line">      &#123;</span><br><span class="line">          <span class="keyword">var</span> dept = <span class="keyword">await</span> _departmentsService.<span class="title class_">LoadEntities</span>(<span class="function"><span class="params">d</span>=&gt;</span>d.<span class="property">Id</span>==id).<span class="title class_">FirstOrDefaultAsync</span>();</span><br><span class="line">         <span class="keyword">if</span>(dept == <span class="literal">null</span>)</span><br><span class="line">          &#123;</span><br><span class="line">              <span class="keyword">return</span> <span class="title class_">BadRequest</span>(<span class="string">&quot;没有找到要更新的部门&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          string[] strs = department.<span class="property">Manager</span>!.<span class="title class_">Split</span>(<span class="string">&quot;:&quot;</span>);</span><br><span class="line">          dept.<span class="property">DepartmentDescription</span> = department.<span class="property">DepartmentDescription</span>;</span><br><span class="line">          dept.<span class="property">DepartmentName</span> = department.<span class="property">DepartmentName</span>;</span><br><span class="line">          dept.<span class="property">DepartmentCode</span>    = department.<span class="property">DepartmentCode</span>;</span><br><span class="line">          dept.<span class="property">Manager</span> = strs[<span class="number">0</span>];</span><br><span class="line">          dept.<span class="property">ManagerId</span> = <span class="title class_">Convert</span>.<span class="title class_">ToInt32</span>(strs[<span class="number">1</span>]);</span><br><span class="line">          dept.<span class="property">UpdateTime</span> = <span class="title class_">DateTime</span>.<span class="property">Now</span>;</span><br><span class="line">          <span class="keyword">return</span> <span class="title class_">Ok</span>(<span class="keyword">new</span> <span class="title class_">ApiResult</span>&lt;<span class="title class_">Department</span>&gt;() &#123; <span class="title class_">Success</span> = <span class="literal">true</span>, <span class="title class_">Message</span> = <span class="string">&quot;获取到部门信息&quot;</span>, <span class="title class_">Data</span> = dept &#125;);</span><br><span class="line"></span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>由于在<code>UpdateDepartment</code>这个方法中，没有使用<code>automapper</code>自动映射，只能自己手动进行映射。</p>
<h2 id="六、员工管理模块"><a href="#六、员工管理模块" class="headerlink" title="六、员工管理模块"></a>六、员工管理模块</h2><h3 id="1、创建通用工具栏组件"><a href="#1、创建通用工具栏组件" class="headerlink" title="1、创建通用工具栏组件"></a>1、创建通用工具栏组件</h3><p>在后续的业务开发中，经常会用到一个类似下图的工具栏，作为公共组件，进行一下封装</p>
<p>在<code>src/components</code>目录下面创建<code>PageTools</code>文件夹，在该文件夹下面创建<code>index.vue</code>组件，该组件中的基本布局代码如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;el-card class=&quot;page-tools&quot;&gt;</span><br><span class="line">      &lt;el-row type=&quot;flex&quot; justify=&quot;space-between&quot; align=&quot;middle&quot;&gt;</span><br><span class="line">        &lt;el-col&gt;</span><br><span class="line">          &lt;div v-if=&quot;showBefore&quot; class=&quot;before&quot;&gt;  &lt;!--如果showBefore为true才展示该div中的内容--&gt;</span><br><span class="line">            &lt;el-icon&gt;&lt;InfoFilled /&gt;&lt;/el-icon&gt;</span><br><span class="line">            &lt;!-- 定义前面得插槽 --&gt;</span><br><span class="line">            &lt;slot name=&quot;before&quot; /&gt;</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line">        &lt;/el-col&gt;</span><br><span class="line">        &lt;el-col&gt;</span><br><span class="line">          &lt;el-row type=&quot;flex&quot; justify=&quot;end&quot;&gt;</span><br><span class="line">            &lt;!-- 定义后面的插槽 --&gt;</span><br><span class="line">            &lt;slot name=&quot;after&quot; /&gt;</span><br><span class="line">          &lt;/el-row&gt;</span><br><span class="line">        &lt;/el-col&gt;</span><br><span class="line">      &lt;/el-row&gt;</span><br><span class="line">    &lt;/el-card&gt;</span><br><span class="line">  &lt;/template&gt;</span><br><span class="line">  </span><br><span class="line">  &lt;script&gt;</span><br><span class="line">  export default &#123;</span><br><span class="line">    name: &quot;PageTools&quot;,</span><br><span class="line">    props: &#123;</span><br><span class="line">      showBefore: &#123;</span><br><span class="line">        type: Boolean,</span><br><span class="line">        default: false,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line">  &lt;/script&gt;</span><br><span class="line">  </span><br><span class="line">  &lt;style lang=&quot;scss&quot;&gt;</span><br><span class="line">  .page-tools &#123;</span><br><span class="line">    margin: 10px 0;</span><br><span class="line">    .before &#123;</span><br><span class="line">      line-height: 34px;</span><br><span class="line">      i &#123;</span><br><span class="line">        margin-right: 5px;</span><br><span class="line">        color: #409eff;</span><br><span class="line">      &#125;</span><br><span class="line">      display: inline-block;</span><br><span class="line">      padding: 0px 10px;</span><br><span class="line">      border-radius: 3px;</span><br><span class="line">      border: 1px solid rgba(145, 213, 255, 1);</span><br><span class="line">      background: rgba(230, 247, 255, 1);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  &lt;/style&gt;</span><br><span class="line">  </span><br></pre></td></tr></table></figure>

<p>下面进行测试。</p>
<p>在<code>views/dashboard/index.vue</code>这个组件中进行测试</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">后台布局</span><br><span class="line">&lt;PageTools :showBefore=&quot;true&quot;&gt; &lt;!--指定showBefore属性为true,表示展示左侧插槽内容--&gt;</span><br><span class="line">    &lt;template v-slot:before&gt; &lt;!--指定before这个插槽展示的内容--&gt;</span><br><span class="line">      &lt;span&gt;Hello&lt;/span&gt;</span><br><span class="line">    &lt;/template&gt;</span><br><span class="line">    &lt;template v-slot:after&gt;&lt;!--指定after这个插槽展示的内容--&gt;</span><br><span class="line">      &lt;el-button  type=&quot;primary&quot;&gt;添加&lt;/el-button&gt;</span><br><span class="line">    &lt;/template&gt;</span><br><span class="line">  &lt;/PageTools&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">import PageTools from &quot;@/components/PageTools&quot;; // 导入`PageTools`组件</span><br><span class="line">  export default&#123;</span><br><span class="line">    name:&#x27;dashboard&#x27;,</span><br><span class="line">    components: &#123;</span><br><span class="line">    PageTools, // 完成`PageTools`组件的注册</span><br><span class="line">  &#125;,</span><br><span class="line">    setup()&#123;</span><br><span class="line">      </span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>返回到浏览器中进行测试。</p>
<p>访问首页查看效果</p>
<h3 id="2、完成公共组件全局注册"><a href="#2、完成公共组件全局注册" class="headerlink" title="2、完成公共组件全局注册"></a>2、完成公共组件全局注册</h3><p>在上一小节中创建的<code>PageTools</code>这个组件是公共组件，在其他的页面中使用该组件的时候，都需要导入与注册。</p>
<p>比较麻烦，这里可以完成全局的注册。</p>
<p>修改<code>src/components/index.js</code>文件中的代码，如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">SvgIcon</span> <span class="keyword">from</span> <span class="string">&quot;@/components/SvgIcon&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">PageTools</span> <span class="keyword">from</span> <span class="string">&quot;@/components/PageTools&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="title function_">install</span>(<span class="params">app</span>) &#123;</span><br><span class="line">    app.<span class="title function_">component</span>(<span class="title class_">SvgIcon</span>.<span class="property">name</span>, <span class="title class_">SvgIcon</span>);</span><br><span class="line">    app.<span class="title function_">component</span>(<span class="title class_">PageTools</span>.<span class="property">name</span>, <span class="title class_">PageTools</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里完成了<code>PageTools</code>组件的全局注册。</p>
<p>返回到<code>views/dashboard/index.vue</code>中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">后台布局</span><br><span class="line">&lt;PageTools :showBefore=&quot;true&quot;&gt; &lt;!--指定showBefore属性为true,表示展示左侧插槽内容--&gt;</span><br><span class="line">    &lt;template v-slot:before&gt; &lt;!--指定before这个插槽展示的内容--&gt;</span><br><span class="line">      &lt;span&gt;Hello&lt;/span&gt;</span><br><span class="line">    &lt;/template&gt;</span><br><span class="line">    &lt;template v-slot:after&gt;&lt;!--指定after这个插槽展示的内容--&gt;</span><br><span class="line">      &lt;el-button  type=&quot;primary&quot;&gt;添加&lt;/el-button&gt;</span><br><span class="line">    &lt;/template&gt;</span><br><span class="line">  &lt;/PageTools&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line"></span><br><span class="line">  export default&#123;</span><br><span class="line">    name:&#x27;dashboard&#x27;,</span><br><span class="line">   </span><br><span class="line">    setup()&#123;</span><br><span class="line">      </span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>这里不需要在导入<code>PageTools</code>组件和进行注册，直接使用</p>
<p>返回到浏览器中查看效果。</p>
<h3 id="3、员工列表页面基本布局"><a href="#3、员工列表页面基本布局" class="headerlink" title="3、员工列表页面基本布局"></a>3、员工列表页面基本布局</h3><p>在这一小节中，先将员工列表的基本布局设计出来。</p>
<p>在<code>views/employees/index.vue</code>这个组件中添加如下的代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">&lt;PageTools :showBefore=&quot;true&quot;&gt; &lt;!--使用了PageTools这个公共组件--&gt;</span><br><span class="line">      &lt;template  #before &gt;共166条记录&lt;/template&gt;   &lt;!--注意插槽在vue3中的应用---&gt;</span><br><span class="line">      &lt;template  #after &gt;</span><br><span class="line">        &lt;el-button size=&quot;small&quot; type=&quot;primary&quot;&gt;新增员工&lt;/el-button&gt;</span><br><span class="line">      &lt;/template&gt;</span><br><span class="line">    &lt;/PageTools&gt;</span><br><span class="line">    &lt;!-- 放置表格和分页 --&gt;</span><br><span class="line">    &lt;el-card&gt;</span><br><span class="line">      &lt;el-table border&gt;</span><br><span class="line">        &lt;el-table-column label=&quot;序号&quot; sortable=&quot;&quot; /&gt;&lt;!--sortable表示可以进行排序---&gt;</span><br><span class="line">        &lt;el-table-column label=&quot;姓名&quot; sortable=&quot;&quot; /&gt;</span><br><span class="line">        &lt;el-table-column label=&quot;手机号&quot; sortable=&quot;&quot; /&gt;</span><br><span class="line">        &lt;el-table-column label=&quot;部门&quot; sortable=&quot;&quot; /&gt;</span><br><span class="line">        &lt;el-table-column label=&quot;入职时间&quot; sortable=&quot;&quot; /&gt;</span><br><span class="line">        &lt;el-table-column label=&quot;操作&quot; sortable=&quot;&quot; fixed=&quot;right&quot; width=&quot;280&quot;&gt;</span><br><span class="line">          &lt;template #default&gt;</span><br><span class="line">            &lt;el-button type=&quot;text&quot; size=&quot;small&quot;&gt;查看&lt;/el-button&gt;</span><br><span class="line">            &lt;el-button type=&quot;text&quot; size=&quot;small&quot;&gt;转正&lt;/el-button&gt;</span><br><span class="line">            &lt;el-button type=&quot;text&quot; size=&quot;small&quot;&gt;调岗&lt;/el-button&gt;</span><br><span class="line">            &lt;el-button type=&quot;text&quot; size=&quot;small&quot;&gt;离职&lt;/el-button&gt;</span><br><span class="line">            &lt;el-button type=&quot;text&quot; size=&quot;small&quot;&gt;编辑&lt;/el-button&gt;</span><br><span class="line">            &lt;el-button type=&quot;text&quot; size=&quot;small&quot;&gt;删除&lt;/el-button&gt;</span><br><span class="line">          &lt;/template&gt;</span><br><span class="line">        &lt;/el-table-column&gt;</span><br><span class="line">      &lt;/el-table&gt;</span><br><span class="line">      &lt;!-- 分页组件 --&gt;</span><br><span class="line">      &lt;el-row</span><br><span class="line">        type=&quot;flex&quot;</span><br><span class="line">        justify=&quot;center&quot;</span><br><span class="line">        align=&quot;middle&quot;</span><br><span class="line">        style=&quot;height: 60px&quot;</span><br><span class="line">      &gt;</span><br><span class="line">        &lt;el-pagination</span><br><span class="line">          layout=&quot;prev, pager, next&quot;</span><br><span class="line">          :total=&quot;10&quot;</span><br><span class="line">          :page-size=&quot;2&quot;</span><br><span class="line">        /&gt;</span><br><span class="line">      &lt;/el-row&gt;</span><br><span class="line">    &lt;/el-card&gt;</span><br></pre></td></tr></table></figure>

<p>在<code>app-container</code>这个<code>div</code>内部添加如上内容。</p>
<p>返回到浏览器中查看效果</p>
<h3 id="4、员工列表数据请求和分页加载"><a href="#4、员工列表数据请求和分页加载" class="headerlink" title="4、员工列表数据请求和分页加载"></a>4、员工列表数据请求和分页加载</h3><h4 id="4-1-服务端接口设计"><a href="#4-1-服务端接口设计" class="headerlink" title="4.1 服务端接口设计"></a>4.1 服务端接口设计</h4><p><strong>第一：首先构建搜索条件。</strong></p>
<p>在<code> Cms.Entity</code>项目中创建一个<code>Search</code>文件夹，在该文件夹中创建<code>UserInfoSearch.cs</code>，代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.Entity.Search</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserInfoSearch</span>:<span class="title">BaseSearch</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? UserName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? UserPhone &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>同时在<code>Search</code>文件夹中创建<code>BaseSearch.cs</code>，代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.Entity.Search</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BaseSearch</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> PageIndex &#123; <span class="keyword">get</span>;<span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> PageSize &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> TotalCount &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">bool</span> Order &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>第二：定义获取员工信息的服务接口与具体实现，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.IService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IUserInfoService</span>:<span class="title">IBaseService</span>&lt;<span class="title">UserInfo</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">IQueryable&lt;UserInfo&gt; <span class="title">LoadSearchEntities</span>(<span class="params">UserInfoSearch userInfoSearch, <span class="built_in">bool</span> delFlag</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IQueryable&lt;UserInfo&gt; <span class="title">LoadSearchEntities</span>(<span class="params">UserInfoSearch userInfoSearch, <span class="built_in">bool</span> delFlag</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">var</span> temp = _userInfoRepository.LoadEntities(u=&gt;u.DelFlag==delFlag);</span><br><span class="line">           <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrWhiteSpace(userInfoSearch.UserName))</span><br><span class="line">           &#123;</span><br><span class="line">               temp = temp.Where&lt;UserInfo&gt;(u =&gt; u.UserName!.Contains(userInfoSearch.UserName));</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrWhiteSpace(userInfoSearch.UserPhone))</span><br><span class="line">           &#123;</span><br><span class="line">               temp = temp.Where&lt;UserInfo&gt;(u =&gt; u.UserPhone!.Contains(userInfoSearch.UserPhone));</span><br><span class="line">           &#125;</span><br><span class="line">           userInfoSearch.TotalCount = temp.Count();</span><br><span class="line">           <span class="keyword">if</span> (userInfoSearch.Order)</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">return</span> temp.OrderBy&lt;UserInfo, <span class="built_in">long</span>&gt;(u =&gt; u.Id).Skip&lt;UserInfo&gt;((userInfoSearch.PageIndex - <span class="number">1</span>) * userInfoSearch.PageSize).Take&lt;UserInfo&gt;(userInfoSearch.PageSize);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">else</span></span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">return</span> temp.OrderByDescending&lt;UserInfo, <span class="built_in">long</span>&gt;(u =&gt; u.Id).Skip&lt;UserInfo&gt;((userInfoSearch.PageIndex - <span class="number">1</span>) * userInfoSearch.PageSize).Take&lt;UserInfo&gt;(userInfoSearch.PageSize);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>第三：控制器(<code>UsersController.cs</code>)中代码实现</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">HttpGet(<span class="string">&quot;pages&quot;</span>)</span>]</span><br><span class="line">       [<span class="meta">Authorize</span>]</span><br><span class="line">       <span class="function"><span class="keyword">public</span> IActionResult <span class="title">GetUsers</span>(<span class="params">[FromQuery] UserParams userParams</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="built_in">int</span> totalCount = <span class="number">0</span>;</span><br><span class="line">            UserInfoSearch  userInfoSearch = <span class="keyword">new</span> UserInfoSearch()</span><br><span class="line">           &#123;</span><br><span class="line"></span><br><span class="line">               UserName = userParams.UserName,</span><br><span class="line">               UserPhone = userParams.UserPhone,</span><br><span class="line">               Order = userParams.Order,</span><br><span class="line">               PageIndex = userParams.PageIndex,</span><br><span class="line">               PageSize = userParams.PageSize,</span><br><span class="line">               TotalCount =totalCount</span><br><span class="line">           &#125;;</span><br><span class="line">           <span class="comment">// 获取所有的员工信息</span></span><br><span class="line">           <span class="keyword">var</span> users = _userInfoService.LoadSearchEntities(userInfoSearch, Convert.ToBoolean(DelFlagEnum.Normal));</span><br><span class="line">           <span class="keyword">if</span> (userInfoSearch.TotalCount &lt;= <span class="number">0</span>)</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">return</span> NotFound(<span class="string">&quot;没有用户信息&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">//关联查询部门信息，获取员工所在的部门。这里只返回部分内容</span></span><br><span class="line">          <span class="keyword">var</span> usersDepments = users.Include(u =&gt; u.Department).Select(u =&gt; <span class="keyword">new</span> &#123;Id=u.Id,UserName=u.UserName, UserPhone=u.UserPhone, CreateTime=u.CreateTime, departmentName=u.Department!.DepartmentName &#125;);</span><br><span class="line">          <span class="comment">//Data中包含了员工信息以及总的记录数，是一个匿名类.</span></span><br><span class="line">           <span class="comment">// 所以ApiResult的泛型类型是object</span></span><br><span class="line">           </span><br><span class="line">           <span class="keyword">return</span> Ok(<span class="keyword">new</span> ApiResult&lt;<span class="built_in">object</span>&gt;() &#123;Success=<span class="literal">true</span>,Message=<span class="string">&quot;获取用户信息成功&quot;</span>,Data =<span class="keyword">new</span> &#123; rows= usersDepments,total=userInfoSearch.TotalCount &#125; &#125;);</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>上面<code>GetUsers</code>方法接收到的参数类型是<code>UserParams</code>类型，在<code>WebApi</code>项目中创建<code>ResourceParams</code>文件夹，在该文件夹中创建<code>UserParams.cs</code>,代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.WebApi.ResourceParams</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserParams</span>:<span class="title">BaseParams</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? UserName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? UserPhone &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>BaseParams.cs</code>中的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.WebApi.ResourceParams</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BaseParams</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> PageIndex &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> PageSize &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">bool</span> Order &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意：这里不包含<code>totalCount</code></p>
<h4 id="4-2前端实现"><a href="#4-2前端实现" class="headerlink" title="4.2前端实现"></a>4.2<strong>前端实现</strong></h4><p>这里先定义获取员工列表数据的接口</p>
<p>在<code>src/api/employees.js</code>文件中进行定义</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取员工的综合列表数据</span></span><br><span class="line"><span class="comment"> * ***/</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getEmployeeList</span>(<span class="params">params</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">request</span>(&#123;</span><br><span class="line">    <span class="attr">url</span>: <span class="string">&quot;/users/pages&quot;</span>,</span><br><span class="line">    params,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面修改<code>views/employees/index.vue</code>这个组件中的代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">  <span class="keyword">import</span> &#123; ref,onMounted&#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line">  <span class="keyword">import</span> &#123; getEmployeeList &#125; <span class="keyword">from</span> <span class="string">&quot;@/api/employees&quot;</span>;</span><br><span class="line">  <span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;Employees&quot;</span>,</span><br><span class="line">    <span class="title function_">setup</span>(<span class="params"></span>)&#123;</span><br><span class="line">      <span class="keyword">const</span> loading = <span class="title function_">ref</span>(<span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">const</span> list = <span class="title function_">ref</span>([]);</span><br><span class="line">    <span class="keyword">const</span> page = <span class="title function_">ref</span>(&#123;</span><br><span class="line">      <span class="title class_">PageIndex</span>: <span class="number">1</span>, <span class="comment">// 当前页码</span></span><br><span class="line">      <span class="title class_">PageSize</span>: <span class="number">2</span>, <span class="comment">// 每页显示的记录数，这里服务端要求是PageSize</span></span><br><span class="line">      <span class="attr">total</span>:<span class="number">0</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="title function_">onMounted</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">loadEmployeeList</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">       <span class="keyword">const</span> <span class="title function_">loadEmployeeList</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">      loading.<span class="property">value</span> = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">const</span> &#123; rows, total &#125; = <span class="keyword">await</span> <span class="title function_">getEmployeeList</span>(page.<span class="property">value</span>);</span><br><span class="line">      page.<span class="property">value</span>.<span class="property">total</span> = total;</span><br><span class="line">      list.<span class="property">value</span> = rows;</span><br><span class="line">      loading.<span class="property">value</span> = <span class="literal">false</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      loading,</span><br><span class="line">      list,</span><br><span class="line">      page,</span><br><span class="line">     </span><br><span class="line">    &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  &lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>下面修改模板中的代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;div class=&quot;app-container&quot;&gt;</span><br><span class="line">        &lt;PageTools :showBefore=&quot;true&quot;&gt; &lt;!--使用了PageTools这个公共组件--&gt;</span><br><span class="line">          &lt;template #before&gt;共&#123;&#123; page.total &#125;&#125;条记录&lt;/template&gt;  &lt;!--注意插槽在vue3中的应用---&gt;</span><br><span class="line">        &lt;template  #after &gt;</span><br><span class="line">          &lt;el-button size=&quot;small&quot; type=&quot;primary&quot;&gt;新增员工&lt;/el-button&gt;</span><br><span class="line">        &lt;/template&gt;</span><br><span class="line">      &lt;/PageTools&gt;</span><br></pre></td></tr></table></figure>

<p>这里展示了<code>page.total</code>属性中存储的总的记录数。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-card v-loading=&quot;loading&quot;&gt;</span><br><span class="line">    &lt;el-table border :data=&quot;list&quot;&gt;</span><br><span class="line">      &lt;el-table-column label=&quot;序号&quot;  type=&quot;index&quot; /&gt;&lt;!--sortable表示可以进行排序---&gt;</span><br><span class="line">      &lt;el-table-column label=&quot;姓名&quot;  prop=&quot;userName&quot; /&gt;</span><br><span class="line">      &lt;el-table-column label=&quot;手机号&quot;  prop=&quot;userPhone&quot; /&gt;</span><br><span class="line">      &lt;el-table-column label=&quot;部门&quot; prop=&quot;departmentName&quot;/&gt;</span><br><span class="line">      &lt;el-table-column label=&quot;入职时间&quot; prop=&quot;createTime&quot;  /&gt;</span><br><span class="line">      &lt;el-table-column label=&quot;操作&quot;  fixed=&quot;right&quot; width=&quot;280&quot;&gt;</span><br><span class="line">        &lt;template #default&gt;</span><br><span class="line">          &lt;el-button size=&quot;small&quot;&gt;查看&lt;/el-button&gt;</span><br><span class="line">          &lt;el-button  size=&quot;small&quot;&gt;转正&lt;/el-button&gt;</span><br><span class="line">          &lt;el-button  size=&quot;small&quot;&gt;调岗&lt;/el-button&gt;</span><br><span class="line">          &lt;el-button size=&quot;small&quot;&gt;离职&lt;/el-button&gt;</span><br><span class="line">          &lt;el-button  size=&quot;small&quot;&gt;编辑&lt;/el-button&gt;</span><br><span class="line">          &lt;el-button  size=&quot;small&quot;&gt;删除&lt;/el-button&gt;</span><br><span class="line">        &lt;/template&gt;</span><br><span class="line">      &lt;/el-table-column&gt;</span><br><span class="line">    &lt;/el-table&gt;</span><br></pre></td></tr></table></figure>

<p>给<code>el-card</code>组件添加了<code>v-loading</code>属性。</p>
<p>同时给<code>el-table</code>添加了<code>data</code>属性关联了<code>list</code>，也就是指定了表格要展示的数据源。</p>
<p>下面给<code>序号列</code>指定了<code>type=index</code></p>
<p>给其它的列指定了<code>prop</code>属性，指定要展示的内容。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 分页组件 --&gt;</span><br><span class="line">      &lt;el-row</span><br><span class="line">        type=&quot;flex&quot;</span><br><span class="line">        justify=&quot;center&quot;</span><br><span class="line">        align=&quot;middle&quot;</span><br><span class="line">        style=&quot;height: 60px&quot;</span><br><span class="line">      &gt;</span><br><span class="line">        &lt;el-pagination</span><br><span class="line">          layout=&quot;prev, pager, next&quot;</span><br><span class="line">          :total=&quot;page.total&quot;</span><br><span class="line">          :page-size=&quot;page.PageSize&quot;</span><br><span class="line">          v-model:currentPage=&quot;page.PageIndex&quot;</span><br><span class="line">          @current-change=&quot;handleCurrentChange&quot;</span><br><span class="line">        /&gt;</span><br><span class="line">      &lt;/el-row&gt;</span><br></pre></td></tr></table></figure>

<p>这里给<code>el-pagination</code>这个分页组件指定了<code>total</code>和<code>page-size</code>属性的值</p>
<p>还要实现分页的功能，也就是实现页码切换的功能。</p>
<p>这里给<code>分页</code>组件绑定了<code>currentPage</code>属性，表示当前页码值。取值是<code>page</code>对象的<code>page</code>属性。</p>
<p>同时指定了<code>current-change</code>事件，当进行页码切换的时候会触发该事件，执行<code>handleCurrentChange</code>这个方法，下面实现该方法：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">handleCurrentChange</span>=(<span class="params">value</span>)=&gt;&#123;</span><br><span class="line">     page.<span class="property">value</span>.<span class="property">PageIndex</span> = value;</span><br><span class="line">     <span class="title function_">loadEmployeeList</span>(); <span class="comment">// 重新加载数据</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> &#123;</span><br><span class="line">     loading,</span><br><span class="line">     list,</span><br><span class="line">     page,</span><br><span class="line">     handleCurrentChange</span><br><span class="line">   &#125;;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>这里将切换后得到的页码值赋值给了<code>page</code>对象中的<code>page</code>属性，然后调用<code>loadEmployeeList</code>方法重新加载员工数据。</p>
<p>最后将<code>handleCurrentChange</code>方法返回。</p>
<p>下面返回到浏览器中进行测试。</p>
<h3 id="5、数据格式处理"><a href="#5、数据格式处理" class="headerlink" title="5、数据格式处理"></a>5、数据格式处理</h3><p>这里是对展示的日期格式进行处理。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-table-column label=&quot;入职时间&quot; prop=&quot;createTime&quot;  :formatter=&quot;formatTimeOfEntry&quot; /&gt;</span><br></pre></td></tr></table></figure>

<p>这里也是给<code>入职时间</code>这一列中添加了<code>formatter</code>属性，该属性的值是<code>formatTimeOfEntry</code>方法。</p>
<p>该方法的定义如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 入职时间格式处理</span></span><br><span class="line">     <span class="keyword">const</span> <span class="title function_">formatTimeOfEntry</span> = (<span class="params">row, column, cellValue, index</span>) =&gt; &#123;</span><br><span class="line">      <span class="comment">// console.log(&quot;cellvalue=&quot;, cellValue);</span></span><br><span class="line">      <span class="keyword">const</span> date = <span class="keyword">new</span> <span class="title class_">Date</span>(cellValue);</span><br><span class="line">      <span class="keyword">return</span> (</span><br><span class="line">        date.<span class="title function_">getFullYear</span>() + <span class="string">&quot;-&quot;</span> + (date.<span class="title function_">getMonth</span>() + <span class="number">1</span>) + <span class="string">&quot;-&quot;</span> + date.<span class="title function_">getDate</span>() <span class="comment">// 注意在计算`date.getMonth() + 1`的时候需要用括号括起来，否则就是字符串的拼接了。</span></span><br><span class="line">      );</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      loading,</span><br><span class="line">      list,</span><br><span class="line">      page,</span><br><span class="line">      handleCurrentChange,</span><br><span class="line">      formatTimeOfEntry  <span class="comment">// 将该方法返回</span></span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>

<p>这里对日期时间做了简单的处理</p>
<p>返回到浏览器中查看效果。</p>
<h3 id="6、新建员工弹出层组件"><a href="#6、新建员工弹出层组件" class="headerlink" title="6、新建员工弹出层组件"></a>6、新建员工弹出层组件</h3><p>在<code>views/employees</code>目录下面创建<code>components</code>目录，在该目录下面创建<code>add-employee.vue</code>组件，该组件中的代码如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;el-dialog title=&quot;新增员工&quot; v-model=&quot;visible&quot;&gt;</span><br><span class="line">      &lt;!-- 表单 --&gt;</span><br><span class="line">      &lt;el-form label-width=&quot;120px&quot;&gt;</span><br><span class="line">        &lt;el-form-item label=&quot;姓名&quot;&gt;</span><br><span class="line">          &lt;el-input style=&quot;width: 50%&quot; placeholder=&quot;请输入姓名&quot; /&gt;</span><br><span class="line">        &lt;/el-form-item&gt;</span><br><span class="line">        &lt;el-form-item label=&quot;手机&quot;&gt;</span><br><span class="line">          &lt;el-input style=&quot;width: 50%&quot; placeholder=&quot;请输入手机号&quot; /&gt;</span><br><span class="line">        &lt;/el-form-item&gt;</span><br><span class="line">        &lt;el-form-item label=&quot;密码&quot;&gt;</span><br><span class="line">          &lt;el-input style=&quot;width: 50%&quot; placeholder=&quot;请输入密码&quot; /&gt;</span><br><span class="line">        &lt;/el-form-item&gt;</span><br><span class="line">        &lt;el-form-item label=&quot;入职时间&quot;&gt;</span><br><span class="line">          &lt;el-date-picker style=&quot;width: 50%&quot; placeholder=&quot;请选择入职时间&quot; /&gt;</span><br><span class="line">        &lt;/el-form-item&gt;</span><br><span class="line">        &lt;el-form-item label=&quot;邮箱&quot;&gt;</span><br><span class="line">          &lt;el-input style=&quot;width: 50%&quot; placeholder=&quot;请输入邮箱&quot; /&gt;</span><br><span class="line">        &lt;/el-form-item&gt;</span><br><span class="line">        &lt;el-form-item label=&quot;部门&quot;&gt;</span><br><span class="line">          &lt;el-input style=&quot;width: 50%&quot; placeholder=&quot;请选择部门&quot; /&gt;</span><br><span class="line">        &lt;/el-form-item&gt;</span><br><span class="line">        &lt;el-form-item label=&quot;转正时间&quot;&gt;</span><br><span class="line">          &lt;el-date-picker style=&quot;width: 50%&quot; placeholder=&quot;请选择转正时间&quot; /&gt;</span><br><span class="line">        &lt;/el-form-item&gt;</span><br><span class="line">        &lt;el-form-item label=&quot;性别&quot;&gt;</span><br><span class="line">          &lt;el-radio-group  class=&quot;ml-4&quot;&gt;</span><br><span class="line">      &lt;el-radio label=&quot;1&quot; size=&quot;large&quot;&gt;男&lt;/el-radio&gt;</span><br><span class="line">      &lt;el-radio label=&quot;0&quot; size=&quot;large&quot;&gt;女&lt;/el-radio&gt;</span><br><span class="line">    &lt;/el-radio-group&gt;</span><br><span class="line">      &lt;/el-form-item&gt;</span><br><span class="line">      &lt;/el-form&gt;</span><br><span class="line">      &lt;!-- footer插槽 --&gt;</span><br><span class="line">      &lt;template #footer&gt;</span><br><span class="line">        &lt;el-row type=&quot;flex&quot; justify=&quot;center&quot;&gt;</span><br><span class="line">          &lt;el-col :span=&quot;6&quot;&gt;</span><br><span class="line">            &lt;el-button size=&quot;small&quot;&gt;取消&lt;/el-button&gt;</span><br><span class="line">            &lt;el-button type=&quot;primary&quot; size=&quot;small&quot;&gt;确定&lt;/el-button&gt;</span><br><span class="line">          &lt;/el-col&gt;</span><br><span class="line">        &lt;/el-row&gt;</span><br><span class="line">      &lt;/template&gt;</span><br><span class="line">    &lt;/el-dialog&gt;</span><br><span class="line">  &lt;/template&gt;</span><br><span class="line">  </span><br><span class="line">&lt;script&gt;</span><br><span class="line">  import &#123;ref&#125; from &#x27;vue&#x27;</span><br><span class="line">  export default &#123;</span><br><span class="line">    name: &quot;AddEmployee&quot;,</span><br><span class="line">    props: &#123;</span><br><span class="line">      showDialog: &#123;</span><br><span class="line">        type: Boolean,</span><br><span class="line">        default: true, // 这里先将默认值修改为`true`，查看效果，后面在将其修改为false</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    setup(props)&#123;</span><br><span class="line">      const visible =ref(false);</span><br><span class="line">      visible.value = props.showDialog;</span><br><span class="line">      return &#123;</span><br><span class="line">        visible</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  &lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>以上通过<code>showDialog</code>属性接收传递过来的值，决定弹出层的展示与隐藏。</p>
<p>下面返回到<code>employees/index.vue</code>组件中使用上面创建出来的添加员工组件。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">AddEmployee</span> <span class="keyword">from</span> <span class="string">&quot;./components/add-employee.vue&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;Employees&quot;</span>,</span><br><span class="line">  <span class="attr">components</span>:&#123;</span><br><span class="line">    <span class="title class_">AddEmployee</span></span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>

<p>导入<code>AddEmployee</code>组件，并且完成注册。</p>
<p>在模板中使用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;/el-row&gt;</span><br><span class="line">   &lt;/el-card&gt;</span><br><span class="line">   &lt;AddEmployee&gt;&lt;/AddEmployee&gt;</span><br><span class="line">   &lt;/div&gt;</span><br><span class="line"> &lt;/div&gt;</span><br></pre></td></tr></table></figure>

<p>返回到浏览器中进行测试。</p>
<h3 id="7、控制弹出层显示"><a href="#7、控制弹出层显示" class="headerlink" title="7、控制弹出层显示"></a>7、控制弹出层显示</h3><p>当单击页面右上角的<code>新增员工</code> 按钮的时候，将添加员工的弹出层展示出来。</p>
<p><code>employees/index.vue</code>组件中修改代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">onMounted</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">loadEmployeeList</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">const</span> showAddDialog = <span class="title function_">ref</span>(<span class="literal">false</span>);</span><br></pre></td></tr></table></figure>

<p>定义了<code>showAddDialog</code>这个状态</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">     loading,</span><br><span class="line">     list,</span><br><span class="line">     page,</span><br><span class="line">     handleCurrentChange,</span><br><span class="line">     formatTimeOfEntry,</span><br><span class="line">     showAddDialog<span class="comment">// 返回</span></span><br><span class="line">   &#125;;</span><br></pre></td></tr></table></figure>

<p>将<code>showAddDialog</code>返回</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-button size=&quot;small&quot; type=&quot;primary&quot; @click=&quot;showAddDialog=true&quot;&gt;新增员工&lt;/el-button&gt;</span><br></pre></td></tr></table></figure>

<p>这里给<code>新增员工</code>的按钮注册点击事件，事件触发以后将<code>showAddDialog</code>设置为<code>true</code></p>
<p>同时传递到添加员工的子组件中。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;AddEmployee :showDialog=&quot;showAddDialog&quot;&gt;&lt;/AddEmployee&gt;</span><br></pre></td></tr></table></figure>

<p>当然，<code>AddEmployee</code>这个组件中的代码还需要修改一下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">setup</span>(<span class="params">props</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> visible =<span class="title function_">ref</span>(<span class="literal">false</span>);</span><br><span class="line">    <span class="comment">// 通过watch 监听props.showDialog数据的变化。</span></span><br><span class="line">    <span class="title function_">watch</span>(<span class="function">()=&gt;</span>props.<span class="property">showDialog</span>,<span class="function">(<span class="params">newValue,oldValue</span>)=&gt;</span>&#123;</span><br><span class="line">      visible.<span class="property">value</span> = newValue;</span><br><span class="line">    &#125;)</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      visible</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>当然，这里需要导入<code>watch</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;ref,watch&#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br></pre></td></tr></table></figure>

<p>返回到浏览器中进行测试。</p>
<h3 id="8、新增员工表单校验"><a href="#8、新增员工表单校验" class="headerlink" title="8、新增员工表单校验"></a>8、新增员工表单校验</h3><p>在这一小节中，将要完成的是<code>新增员工</code>的表单校验。</p>
<p>修改<code>views/employees/components/add-employee.vue</code>组件中的代码，如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">setup</span>(<span class="params">props</span>)&#123;</span><br><span class="line">     <span class="keyword">const</span> visible =<span class="title function_">ref</span>(<span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">const</span> formData = <span class="title function_">ref</span>(&#123;</span><br><span class="line">     <span class="title class_">UserName</span>:<span class="string">&quot;&quot;</span>,</span><br><span class="line">     <span class="title class_">UserPhone</span>:<span class="string">&quot;&quot;</span>,</span><br><span class="line">     <span class="title class_">UserPassword</span>:<span class="string">&quot;&quot;</span>,</span><br><span class="line">     <span class="title class_">UserEmail</span>:<span class="string">&#x27;&#x27;</span>,</span><br><span class="line">     <span class="title class_">Gender</span>:<span class="string">&quot;&quot;</span>,</span><br><span class="line">     <span class="title class_">DepartmentName</span>:<span class="string">&#x27;&#x27;</span>,</span><br><span class="line">     <span class="title class_">CreateTime</span>:<span class="string">&#x27;&#x27;</span>,</span><br><span class="line">     <span class="title class_">UpdateTime</span>:<span class="string">&#x27;&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line">  <span class="comment">// 表单校验</span></span><br><span class="line">  <span class="keyword">const</span> rules = <span class="title function_">reactive</span>(&#123;</span><br><span class="line">   <span class="title class_">UserName</span>: [</span><br><span class="line">       &#123; <span class="attr">required</span>: <span class="literal">true</span>, <span class="attr">message</span>: <span class="string">&quot;用户姓名不能为空&quot;</span>, <span class="attr">trigger</span>: <span class="string">&quot;blur&quot;</span> &#125;,</span><br><span class="line">       &#123;</span><br><span class="line">         <span class="attr">min</span>: <span class="number">1</span>,</span><br><span class="line">         <span class="attr">max</span>: <span class="number">16</span>,</span><br><span class="line">         <span class="attr">message</span>: <span class="string">&quot;用户姓名为1-16位&quot;</span>,</span><br><span class="line">       &#125;,</span><br><span class="line">     ],</span><br><span class="line">     <span class="title class_">UserPhone</span>: [</span><br><span class="line">       &#123; <span class="attr">required</span>: <span class="literal">true</span>, <span class="attr">message</span>: <span class="string">&quot;手机号不能为空&quot;</span>, <span class="attr">trigger</span>: <span class="string">&quot;blur&quot;</span> &#125;,</span><br><span class="line">       &#123;</span><br><span class="line">         <span class="attr">pattern</span>: <span class="regexp">/^1[3-9]\d&#123;9&#125;$/</span>,</span><br><span class="line">         <span class="attr">message</span>: <span class="string">&quot;手机号格式不正确&quot;</span>,</span><br><span class="line">         <span class="attr">trigger</span>: <span class="string">&quot;blur&quot;</span>,</span><br><span class="line">       &#125;,</span><br><span class="line">     ],</span><br><span class="line">     <span class="title class_">UserPassword</span>: [</span><br><span class="line">       &#123; <span class="attr">required</span>: <span class="literal">true</span>, <span class="attr">message</span>: <span class="string">&quot;密码不能为空&quot;</span>, <span class="attr">trigger</span>: <span class="string">&quot;blur&quot;</span> &#125;,</span><br><span class="line">     ],</span><br><span class="line">     <span class="title class_">UserEmail</span>: [</span><br><span class="line">       &#123; <span class="attr">required</span>: <span class="literal">true</span>, <span class="attr">message</span>: <span class="string">&quot;邮箱不能为空&quot;</span>, <span class="attr">trigger</span>: <span class="string">&quot;blur&quot;</span> &#125;,</span><br><span class="line">     ],</span><br><span class="line">     <span class="title class_">DepartmentName</span>: [</span><br><span class="line">       &#123; <span class="attr">required</span>: <span class="literal">true</span>, <span class="attr">message</span>: <span class="string">&quot;部门不能为空&quot;</span>, <span class="attr">trigger</span>: <span class="string">&quot;change&quot;</span> &#125;,</span><br><span class="line">     ],</span><br><span class="line">     <span class="title class_">CreateTime</span>: [&#123; <span class="attr">required</span>: <span class="literal">true</span>, <span class="attr">message</span>: <span class="string">&quot;入职时间&quot;</span>, <span class="attr">trigger</span>: <span class="string">&quot;blur&quot;</span> &#125;],</span><br><span class="line">     <span class="title class_">UpdateTime</span>: [&#123; <span class="attr">required</span>: <span class="literal">true</span>, <span class="attr">message</span>: <span class="string">&quot;转正时间&quot;</span>, <span class="attr">trigger</span>: <span class="string">&quot;blur&quot;</span> &#125;],</span><br><span class="line">   &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">       visible,</span><br><span class="line">       formData,  <span class="comment">// 返回数据对象</span></span><br><span class="line">       rules <span class="comment">// 返回校验的规则对象</span></span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>

<p>在上面的代码中定义了<code>formData</code>对象，该对象中的属性都是与表单进行了双向的绑定。</p>
<p>这些属性都是通过查看接口文档获取到的。</p>
<p>模板中表单中添加相应的属性，如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 表单 --&gt;</span><br><span class="line">     &lt;el-form label-width=&quot;120px&quot; :model=&quot;formData&quot; :rules=&quot;rules&quot;&gt;</span><br><span class="line">       &lt;el-form-item label=&quot;姓名&quot; prop=&quot;UserName&quot;&gt;</span><br><span class="line">         &lt;el-input style=&quot;width: 50%&quot; placeholder=&quot;请输入姓名&quot; v-model=&quot;formData.UserName&quot; /&gt;</span><br><span class="line">       &lt;/el-form-item&gt;</span><br><span class="line">       &lt;el-form-item label=&quot;手机&quot; prop=&quot;UserPhone&quot;&gt;</span><br><span class="line">         &lt;el-input style=&quot;width: 50%&quot; placeholder=&quot;请输入手机号&quot; v-model=&quot;formData.UserPhone&quot; /&gt;</span><br><span class="line">       &lt;/el-form-item&gt;</span><br><span class="line">       &lt;el-form-item label=&quot;密码&quot; prop=&quot;UserPassword&quot;&gt;</span><br><span class="line">         &lt;el-input style=&quot;width: 50%&quot; placeholder=&quot;请输入密码&quot; v-model=&quot;formData.UserPassword&quot; /&gt;</span><br><span class="line">       &lt;/el-form-item&gt;</span><br><span class="line">       &lt;el-form-item label=&quot;入职时间&quot; prop=&quot;CreateTime&quot;&gt;</span><br><span class="line">         &lt;el-date-picker style=&quot;width: 50%&quot; placeholder=&quot;请选择入职时间&quot; v-model=&quot;formData.CreateTime&quot; /&gt;</span><br><span class="line">       &lt;/el-form-item&gt;</span><br><span class="line">       &lt;el-form-item label=&quot;邮箱&quot; prop=&quot;UserEmail&quot;&gt;</span><br><span class="line">         &lt;el-input style=&quot;width: 50%&quot; placeholder=&quot;请输入邮箱&quot;  v-model=&quot;formData.UserEmail&quot;/&gt;</span><br><span class="line">       &lt;/el-form-item&gt;</span><br><span class="line">       &lt;el-form-item label=&quot;部门&quot; prop=&quot;DepartmentName&quot;&gt;</span><br><span class="line">         &lt;el-input style=&quot;width: 50%&quot; placeholder=&quot;请选择部门&quot; v-model=&quot;formData.DepartmentName&quot; /&gt;</span><br><span class="line">       &lt;/el-form-item&gt;</span><br><span class="line">       &lt;el-form-item label=&quot;转正时间&quot; prop=&quot;UpdateTime&quot;&gt;</span><br><span class="line">         &lt;el-date-picker style=&quot;width: 50%&quot; placeholder=&quot;请选择转正时间&quot; v-model=&quot;formData.UpdateTime&quot; /&gt;</span><br><span class="line">       &lt;/el-form-item&gt;</span><br><span class="line">       &lt;el-form-item label=&quot;性别&quot;&gt;</span><br><span class="line">         &lt;el-radio-group  class=&quot;ml-4&quot; v-model=&quot;formData.Gender&quot;&gt;</span><br><span class="line">     &lt;el-radio label=&quot;0&quot; size=&quot;large&quot;&gt;男&lt;/el-radio&gt;</span><br><span class="line">     &lt;el-radio label=&quot;1&quot; size=&quot;large&quot;&gt;女&lt;/el-radio&gt;</span><br><span class="line">   &lt;/el-radio-group&gt;</span><br><span class="line">     &lt;/el-form-item&gt;</span><br><span class="line">     &lt;/el-form&gt;</span><br></pre></td></tr></table></figure>

<p>这里先给<code>el-form</code>组件添加了<code>model，rules</code></p>
<p>同时给<code>el-form-item</code>组件添加<code>prop</code>属性完成校验。</p>
<p>给<code>表单项</code>添加<code>v-model</code>属性完成双向绑定。</p>
<p>返回到浏览器中查看效果。</p>
<h3 id="9、加载部门数据"><a href="#9、加载部门数据" class="headerlink" title="9、加载部门数据"></a>9、加载部门数据</h3><p>在新增员工的表单中有一项是<code>部门</code></p>
<p>员工的部门是从树形部门中选择一个部门</p>
<p>下面看一下怎样获取部门数据，将其转换成一个树形结构，在下拉框中进行展示。</p>
<p>下面修改<code>views/employees/components/add-employee.vue</code>组件中的代码，如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">import</span> &#123;ref,watch,reactive&#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line">  <span class="keyword">import</span> &#123; getDepartments &#125; <span class="keyword">from</span> <span class="string">&quot;@/api/departments&quot;</span>; <span class="comment">// 导入获取部门信息的方法</span></span><br><span class="line"><span class="keyword">import</span> &#123; tranListToTreeData &#125; <span class="keyword">from</span> <span class="string">&quot;@/utils&quot;</span>; <span class="comment">// 导入构建树形结构数据的方法</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> treeData = <span class="title function_">ref</span>([]); <span class="comment">// 存储部门的树形数据</span></span><br><span class="line">   <span class="keyword">const</span> showTree = <span class="title function_">ref</span>(<span class="literal">false</span>); <span class="comment">// 控制树形结构的显示与隐藏</span></span><br><span class="line">   <span class="keyword">const</span> loading = <span class="title function_">ref</span>(<span class="literal">false</span>); <span class="comment">// 控制树形结构中数据加载时的进度条</span></span><br><span class="line">     <span class="keyword">const</span> visible =<span class="title function_">ref</span>(<span class="literal">false</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// 获取部门信息</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">getDepartmentsInfo</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  showTree.<span class="property">value</span> = <span class="literal">true</span>; <span class="comment">// 默认情况下是不展示树形组件的，只有当获取数据后展示</span></span><br><span class="line">  loading.<span class="property">value</span> = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">const</span>  depts  = <span class="keyword">await</span> <span class="title function_">getDepartments</span>(); <span class="comment">// depts是数组但不是树形结构</span></span><br><span class="line">  treeData.<span class="property">value</span> = <span class="title function_">tranListToTreeData</span>(depts,<span class="number">0</span>); <span class="comment">// 将其转换成树形结构</span></span><br><span class="line">  loading.<span class="property">value</span> = <span class="literal">false</span>;</span><br><span class="line">&#125;;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    visible,</span><br><span class="line">    formData,</span><br><span class="line">    rules,</span><br><span class="line">    getDepartmentsInfo,</span><br><span class="line">    treeData,</span><br><span class="line">    showTree,</span><br><span class="line">    loading,</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>定义<code>getDepartmentsInfo</code> 方法，获取部门数据，并且组织成树形结构。</p>
<p>并且将相关的内容返回。</p>
<p>下面修改模板中的代码，如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-form-item label=&quot;部门&quot; prop=&quot;DepartmentName&quot;&gt;</span><br><span class="line">         &lt;el-input style=&quot;width: 50%&quot; placeholder=&quot;请选择部门&quot; v-model=&quot;formData.DepartmentName&quot;  @focus=&quot;getDepartmentsInfo&quot; /&gt;&lt;!--当文本框失去焦点后调用getDepartmentsInfo方法。---&gt;</span><br><span class="line">       &lt;/el-form-item&gt;</span><br><span class="line">      &lt;!-- 放置一个el-tree组件 --&gt;</span><br><span class="line">     &lt;el-tree</span><br><span class="line">       v-if=&quot;showTree&quot;</span><br><span class="line">       v-loading=&quot;loading&quot;</span><br><span class="line">       :data=&quot;treeData&quot;</span><br><span class="line">       :default-expand-all=&quot;true&quot;</span><br><span class="line">       :props=&quot;&#123; label: &#x27;departmentName&#x27; &#125;&quot;</span><br><span class="line">     /&gt;</span><br></pre></td></tr></table></figure>

<p>在部门的<code>el-form-item</code>这个组件下面添加一个树形组件。当<code>showTree</code>属性为<code>true</code>的时候进行展示，通过<code>data</code>指定数据源，<code>default-expand-all</code>属性的值为<code>true</code>表示展示整个树形结构。同时通过<code>props</code>中的<code>label</code>属性指定树形结构中展示的内容是来自<code>name</code>属性。</p>
<p>问题：什么时候调用<code>getDepartmentsInfo</code>方法来获取部门数据？</p>
<p>当<code>el-input</code>这个<code>选择部门</code>的文本框获取到了焦点后来获取部门数据，并且将其转换成树形结构，填充到树形组件中。</p>
<p>所以要给该<code>el-input</code>这个组件添加<code>@focus</code>事件。</p>
<p>返回到浏览器中进行测试，查看效果。</p>
<h3 id="10、选择部门"><a href="#10、选择部门" class="headerlink" title="10、选择部门"></a>10、选择部门</h3><p>接下来要实现的功能是当单击了部门名称以后，将其填充到文本框中，</p>
<p>修改<code>views/employees/components/add-employee.vue</code>组件中的代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 放置一个el-tree组件 --&gt;</span><br><span class="line">&lt;el-tree</span><br><span class="line">  v-if=&quot;showTree&quot;</span><br><span class="line">  v-loading=&quot;loading&quot;</span><br><span class="line">  :data=&quot;treeData&quot;</span><br><span class="line">  :default-expand-all=&quot;true&quot;</span><br><span class="line">  :props=&quot;&#123; label: &#x27;departmentName&#x27; &#125;&quot;</span><br><span class="line">  @node-click=&quot;selectNode&quot;</span><br><span class="line">/&gt;</span><br></pre></td></tr></table></figure>

<p>给<code>el-tree</code>这个组件中添加了<code>node-click</code>事件，当单击了树形结构中的节点的时候，会触发该事件。</p>
<p>调用<code>selectNode</code>这个方法。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取部门树形结构中所单击的部门</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">selectNode</span> = (<span class="params">node</span>) =&gt; &#123;</span><br><span class="line">     <span class="comment">// node 参数中存储的是所单击的部门信息</span></span><br><span class="line">   <span class="comment">// console.log(&quot;node=&quot;, node);</span></span><br><span class="line">     formData.<span class="property">value</span>.<span class="property">DepartmentName</span> = node.<span class="property">departmentName</span>;</span><br><span class="line">   </span><br><span class="line">     showTree.<span class="property">value</span> = <span class="literal">false</span>;</span><br><span class="line">   &#125;;</span><br><span class="line">     <span class="keyword">return</span> &#123;</span><br><span class="line">       visible,</span><br><span class="line">       formData,</span><br><span class="line">       rules,</span><br><span class="line">       getDepartmentsInfo,</span><br><span class="line">       treeData,</span><br><span class="line">       showTree,</span><br><span class="line">       loading,</span><br><span class="line">       selectNode</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>

<p>这里传递给<code>selectNode</code>方法的参数<code>node</code>中存储了所单击的部门的信息。</p>
<p>将其赋值给<code>formData</code>对象中的<code>DepartmentName</code>属性，而该属性已经与部门的文本框进行了绑定，所以所单击的部门的名称会展示到文本框中。</p>
<p>并将树形结构隐藏隐藏掉。</p>
<p>最后将<code>selectNode</code>方法返回。</p>
<p>返回到浏览器中进行测试。</p>
<h3 id="11、完成新增员工"><a href="#11、完成新增员工" class="headerlink" title="11、完成新增员工"></a>11、完成新增员工</h3><h4 id="11-1-前端实现"><a href="#11-1-前端实现" class="headerlink" title="11.1 前端实现"></a>11.1 前端实现</h4><p>在<code>src/api/employees.js</code>文件中添加请求的方法，如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** **</span></span><br><span class="line"><span class="comment"> *  新增员工的接口</span></span><br><span class="line"><span class="comment"> * **/</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">addEmployee</span>(<span class="params">data</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">request</span>(&#123;</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&#x27;post&#x27;</span>,</span><br><span class="line">    <span class="attr">url</span>: <span class="string">&#x27;/users&#x27;</span>,</span><br><span class="line">    data</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改<code>views/employees/components/add-employee.vue</code>组件中的代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; tranListToTreeData &#125; <span class="keyword">from</span> <span class="string">&quot;@/utils&quot;</span>; <span class="comment">// 导入构建树形结构数据的方法</span></span><br><span class="line"><span class="keyword">import</span> &#123; addEmployee &#125; <span class="keyword">from</span> <span class="string">&quot;@/api/employees&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>这里将<code>addEmployee</code>导入进来。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> visible =<span class="title function_">ref</span>(<span class="literal">false</span>);</span><br><span class="line">     <span class="keyword">const</span> formRef = <span class="title function_">ref</span>(<span class="literal">null</span>); <span class="comment">// 关联表单组件</span></span><br></pre></td></tr></table></figure>

<p>创建<code>formRef</code>对象与表单进行关联。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 增加员工</span></span><br><span class="line">   <span class="keyword">const</span> <span class="title function_">btnOk</span> = (<span class="params">formEl</span>) =&gt; &#123;</span><br><span class="line">   formEl.<span class="title function_">validate</span>(<span class="keyword">async</span> (valid, fields) =&gt; &#123;</span><br><span class="line">     <span class="keyword">if</span> (valid) &#123;</span><br><span class="line">       <span class="keyword">await</span> <span class="title function_">addEmployee</span>(formData.<span class="property">value</span>); <span class="comment">// 注意：这里一定要添加value</span></span><br><span class="line">       <span class="title function_">emit</span>(<span class="string">&quot;addEmployee&quot;</span>);</span><br><span class="line">       <span class="title function_">emit</span>(<span class="string">&quot;changedialog&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;);</span><br></pre></td></tr></table></figure>

<p>创建<code>btnOk</code>方法，当单击<code>确定</code>按钮的时候，会调用该方法，同时获取表单中的数据，传递到<code>addEmployee</code>方法中。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">       visible,</span><br><span class="line">       formData,</span><br><span class="line">       rules,</span><br><span class="line">       getDepartmentsInfo,</span><br><span class="line">       treeData,</span><br><span class="line">       showTree,</span><br><span class="line">       loading,</span><br><span class="line">       selectNode,</span><br><span class="line">       btnOk, <span class="comment">// 返回</span></span><br><span class="line">       formRef <span class="comment">// 返回</span></span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>

<p>这里将<code>btnOk</code>和<code>formRef</code>返回。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 表单 --&gt;</span><br><span class="line">     &lt;el-form label-width=&quot;120px&quot; :model=&quot;formData&quot; :rules=&quot;rules&quot;  ref=&quot;formRef&quot;&gt;</span><br></pre></td></tr></table></figure>

<p>这里将<code>formRef</code>对象与<code>el-form</code>表单关联在一起。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- footer插槽 --&gt;</span><br><span class="line">  &lt;template #footer&gt;</span><br><span class="line">    &lt;el-row type=&quot;flex&quot; justify=&quot;center&quot;&gt;</span><br><span class="line">      &lt;el-col :span=&quot;6&quot;&gt;</span><br><span class="line">        &lt;el-button size=&quot;small&quot;&gt;取消&lt;/el-button&gt;</span><br><span class="line">        &lt;el-button type=&quot;primary&quot; size=&quot;small&quot;  @click=&quot;btnOk(formRef)&quot;&gt;确定&lt;/el-button&gt;</span><br><span class="line">      &lt;/el-col&gt;</span><br><span class="line">    &lt;/el-row&gt;</span><br><span class="line">  &lt;/template&gt;</span><br></pre></td></tr></table></figure>

<p>这里给<code>确定</code>按钮添加了<code>click</code>事件，事件触发以后调用<code>btnOk</code>方法，传递了<code>formRef</code>对象。</p>
<p>通过校验以后，在<code>btnOk</code>方法的内部调用了<code>addEmployee</code>方法，发送请求，完成员工信息的添加。</p>
<p>然后触发了以下两个事件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">emit</span>(<span class="string">&quot;addEmployee&quot;</span>); <span class="comment">//  //触发该事件的目的是重新加载父组件中的数据，填充表格</span></span><br><span class="line">         <span class="title function_">emit</span>(<span class="string">&quot;changedialog&quot;</span>, <span class="literal">false</span>); <span class="comment">// 关闭添加窗口</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">setup</span>(<span class="params">props, &#123; emit &#125;</span>) &#123;</span><br></pre></td></tr></table></figure>

<p>这里通过<code>emits</code>声明了两个事件，同时在<code>setup</code>入口函数中，在第二个参数中解构出了<code>emit</code></p>
<p>下面返回到父组件<code>index.vue</code>中。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;AddEmployee :showDialog=&quot;showAddDialog&quot;    @addEmployee=&quot;loadEmployeeList&quot;  @changedialog=&quot;updatedialog&quot;&gt;&lt;/AddEmployee&gt;</span><br></pre></td></tr></table></figure>

<p>给<code>AddEmployee组件添加事件。</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 关闭添加员工的窗口</span></span><br><span class="line">   <span class="keyword">const</span> <span class="title function_">updatedialog</span> = (<span class="params">value</span>) =&gt; &#123;</span><br><span class="line">   showAddDialog.<span class="property">value</span> = value;</span><br><span class="line"> &#125;;</span><br><span class="line"> <span class="keyword">return</span> &#123;</span><br><span class="line">   loading,</span><br><span class="line">   list,</span><br><span class="line">   page,</span><br><span class="line">   handleCurrentChange,</span><br><span class="line">   formatTimeOfEntry,</span><br><span class="line">   showAddDialog,</span><br><span class="line">   updatedialog, <span class="comment">// 返回</span></span><br><span class="line">   loadEmployeeList <span class="comment">// 返回</span></span><br><span class="line"> &#125;;</span><br></pre></td></tr></table></figure>

<p>在<code>updatedialog</code>方法中关闭了窗口。同时将该方法和<code>loadEmployeeList</code>方法返回。</p>
<p>下面是关于<code>取消</code>按钮</p>
<p>返回到<code>add-employee.vue</code>组件中</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 取消</span></span><br><span class="line">     <span class="keyword">const</span> <span class="title function_">btnCanel</span> = (<span class="params">formEl</span>) =&gt; &#123;</span><br><span class="line">      formData.<span class="property">value</span> = &#123;&#125;;</span><br><span class="line">      formEl.<span class="title function_">resetFields</span>();</span><br><span class="line">      <span class="title function_">emit</span>(<span class="string">&quot;changedialog&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        visible,</span><br><span class="line">        formData,</span><br><span class="line">        rules,</span><br><span class="line">        getDepartmentsInfo,</span><br><span class="line">        treeData,</span><br><span class="line">        showTree,</span><br><span class="line">        loading,</span><br><span class="line">        selectNode,</span><br><span class="line">        btnOk,</span><br><span class="line">        formRef,</span><br><span class="line">        btnCanel <span class="comment">// 返回</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这里，创建了取消的方法<code>btnCanel</code>，将该方法返回</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;el-dialog title=&quot;新增员工&quot; v-model=&quot;visible&quot; @close=&quot;btnCanel(formRef)&quot;&gt;</span><br><span class="line">      &lt;!-- 表单 --&gt;</span><br></pre></td></tr></table></figure>

<p>给<code>el-dialog</code>组件添加了<code>@close</code>事件，该事件触发说明了单击了窗口右上角的叉号图标。调用<code>btnCanel</code>方法。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-button size=&quot;small&quot;  @click=&quot;btnCanel(formRef)&quot;&gt;取消&lt;/el-button&gt;</span><br></pre></td></tr></table></figure>

<p>这里给<code>取消</code>按钮也添加了单击事件，事件触发以后调用<code>btnCanel</code>方法。</p>
<p>以上是前端代码的实现。</p>
<h4 id="11-2-服务端接口实现"><a href="#11-2-服务端接口实现" class="headerlink" title="11.2 服务端接口实现"></a>11.2 服务端接口实现</h4><p>在<code>UsersController.cs</code>控制器中，实现新增员工的接口</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">HttpPost</span>]</span><br><span class="line">       [<span class="meta">Authorize</span>]</span><br><span class="line">       [<span class="meta">UnitOfWork(new Type[</span>] &#123; <span class="keyword">typeof</span>(MyDbContext) &#125;)]</span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">async</span> Task &lt;IActionResult&gt; AddUser([FromBody]UserInfoDto userInfoDto)</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="comment">// 根据接收到的部门名称，查询部门</span></span><br><span class="line">           <span class="keyword">var</span> departMent = <span class="keyword">await</span> <span class="keyword">this</span>._departmentService.LoadEntities(d =&gt; d.DepartmentName == userInfoDto.DepartmentName).FirstOrDefaultAsync();</span><br><span class="line"></span><br><span class="line">           UserInfo userInfo = <span class="keyword">new</span> UserInfo() &#123;</span><br><span class="line">           </span><br><span class="line">            PhotoUrl= <span class="string">&quot;/images/f.jpg&quot;</span>, <span class="comment">// 上传大家可以自己实现</span></span><br><span class="line">             UserName = userInfoDto.UserName, </span><br><span class="line">               UserPhone = userInfoDto.UserPhone,</span><br><span class="line">            CreateTime = userInfoDto.CreateTime,</span><br><span class="line">             DelFlag = Convert.ToBoolean(DelFlagEnum.Normal),</span><br><span class="line">              Gender = userInfoDto.Gender,</span><br><span class="line">               UpdateTime = userInfoDto.UpdateTime,</span><br><span class="line">               UserPassword = userInfoDto.UserPassword,</span><br><span class="line">               UserEmail = userInfoDto.UserEmail,</span><br><span class="line">               Department = departMent, <span class="comment">// 将部门信息赋值给UserInfo对象中的Department属性</span></span><br><span class="line">               </span><br><span class="line">           &#125;;</span><br><span class="line">         <span class="keyword">await</span>  _userInfoService.InsertEntityAsync(userInfo);</span><br><span class="line">           <span class="keyword">return</span> Ok(<span class="keyword">new</span> ApiResult&lt;UserInfoDto&gt;() &#123;Success=<span class="literal">true</span>,Message=<span class="string">&quot;添加用户成功&quot;</span>,Data= userInfoDto &#125;); <span class="comment">// 这里返回的是userInfoDto这个数据传输对象</span></span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>接收数据，需要定义<code>UserInfoDto</code>来实现，原因是：原有的<code>UserInfo</code>这个实体类中没有<code>DepartmentName</code>这个部门名称的属性，而我们自己定义<code>UserInfoDto</code>这个数据传输对象，可以添加该属性。</p>
<p>在上面的代码中，我们没有使用自动映射<code>AutoMapper</code>，是我们自己实现了映射，代码稍微有点麻烦，但是大家要理解原理。</p>
<p>在<code>WebApi</code>项目中创建的<code>models</code>目录下面创建<code>UserInfoDto.cs</code>这个数据传输对象，该对象中的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.WebApi.models</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserInfoDto</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? UserName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 密码</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? UserPassword &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 邮箱</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? UserEmail &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 电话</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? UserPhone &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 性别：0表示男，1表示女</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> Gender &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 用户头像，存储头像路径</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? PhotoUrl &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 主键id</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">long</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>  添加数据时间</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> DateTime CreateTime &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 更新数据时间</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> DateTime UpdateTime &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>  软删除</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">bool</span> DelFlag &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? DepartmentName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; <span class="comment">// 注意：这里定义了DepartMentName属性，表示部门的名称，接收前端传递过来的部门名称。</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>启动项目进行测试。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">private</span> IUserInfoService _userInfoService;</span><br><span class="line"><span class="keyword">private</span> IDepartmentService _departmentService;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">UsersController</span>(<span class="params">IUserInfoService userInfoService,IDepartmentService departmentService</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">this</span>._userInfoService = userInfoService;</span><br><span class="line">    <span class="keyword">this</span>._departmentService = departmentService; <span class="comment">// 完成部门服务层的注入</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里还需要完成<code>departmentService</code>注入的操作</p>
<h2 id="七、角色管理模块"><a href="#七、角色管理模块" class="headerlink" title="七、角色管理模块"></a>七、角色管理模块</h2><h3 id="什么是RBAC"><a href="#什么是RBAC" class="headerlink" title="什么是RBAC"></a>什么是<code>RBAC</code></h3><p><code>RBAC</code>(全称是<code>Role-Based Access Control</code>)基于角色的权限访问控制，在<code>RBAC</code>中，权限与角色相关联，用户通过成为合适的角色的成员从而得到这些角色的权限，这样就极大的简化了权限的管理。</p>
<p><code>RBAC</code>是目前公认的解决大型企业的统一资源访问控制的有效方法。</p>
<h3 id="1、创建角色模型"><a href="#1、创建角色模型" class="headerlink" title="1、创建角色模型"></a>1、创建角色模型</h3><p>在<code>Cms.Entity</code>类库项目中创建<code>RoleInfo.cs</code>，代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.Entity</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RoleInfo</span>:<span class="title">BaseEntity</span>&lt;<span class="title">long</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? RoleName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? Remark &#123; <span class="keyword">get</span>; <span class="keyword">set</span>;&#125;</span><br><span class="line">        <span class="comment">// 一个角色属于多个用户</span></span><br><span class="line">        <span class="keyword">public</span> List&lt;UserInfo&gt; UserInfos &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;=<span class="keyword">new</span> List&lt;UserInfo&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用户与角色是多对多的关系。</p>
<p>修改<code>UserInfo.cs</code>实体类中的代码，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span>? PhotoUrl &#123; <span class="keyword">get</span>; <span class="keyword">set</span>;&#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 一个员工只能属于一个部门</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Department? Department &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> -----------------------------一个员工有多个角色</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> List&lt;RoleInfo&gt; RoleInfos &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; = <span class="keyword">new</span> List&lt;RoleInfo&gt;();</span><br></pre></td></tr></table></figure>

<p>在上面的代码中，指定了一个用户有多个角色。</p>
<p>创建<code>RoleInfoConfig.cs</code>，对应的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.Entity</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RoleInfoConfig</span> : <span class="title">IEntityTypeConfiguration</span>&lt;<span class="title">RoleInfo</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">EntityTypeBuilder&lt;RoleInfo&gt; builder</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            builder.ToTable(<span class="string">&quot;T_RoleInfos&quot;</span>);</span><br><span class="line">            builder.Property(x =&gt; x.RoleName).HasMaxLength(<span class="number">20</span>).IsRequired();</span><br><span class="line">            builder.Property(x =&gt; x.Remark).IsRequired();</span><br><span class="line">            <span class="comment">// 配置了多对多的关系 </span></span><br><span class="line">            <span class="comment">//中间表是T_UserInfos_RoleInfos</span></span><br><span class="line">            builder.HasMany&lt;UserInfo&gt;(s =&gt; s.UserInfos).WithMany(s =&gt; s.RoleInfos).UsingEntity(a =&gt; a.ToTable(<span class="string">&quot;T_UserInfos_RoleInfos&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面修改<code>MyDbContext.cs</code>中的代码，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyDbContext</span>:<span class="title">DbContext</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">public</span> DbSet&lt;UserInfo&gt;UserInfos &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="keyword">public</span> DbSet&lt;Department&gt; DepartmentInfos &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment">// 创建了RoleInfos这个DbSet</span></span><br><span class="line">       <span class="keyword">public</span> DbSet&lt;RoleInfo&gt; RoleInfos &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;  </span><br></pre></td></tr></table></figure>

<p>在上面的代码中，创建了<code>RoleInfos</code>这个<code>DbSet</code>.</p>
<p>下面进行数据迁移的操作</p>
<p>在<code>[程序包管理器控制台]</code>中，选择<code>Cms.EntityFrameWorkCore</code></p>
<p>执行如下命令，完成数据的迁移操作。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Add-Migration CreateRoleInfo</span><br><span class="line">Update-database</span><br></pre></td></tr></table></figure>

<h3 id="2、前端角色列表布局实现"><a href="#2、前端角色列表布局实现" class="headerlink" title="2、前端角色列表布局实现"></a>2、前端角色列表布局实现</h3><p>在<code>Views</code>目录下面创建<code>roles</code>文件夹，在该文件夹中创建<code>index.vue</code>组件，该组件中的基本代码如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;div class=&quot;dashboard-container&quot;&gt;</span><br><span class="line">      &lt;div class=&quot;app-container&quot;&gt;</span><br><span class="line">        &lt;el-card&gt;</span><br><span class="line">              &lt;!-- 新增角色按钮 --&gt;</span><br><span class="line">              &lt;el-row style=&quot;height: 60px&quot;&gt;</span><br><span class="line">              &lt;el-button size=&quot;small&quot; type=&quot;primary&quot;&gt;新增角色&lt;/el-button&gt;</span><br><span class="line">            &lt;/el-row&gt;</span><br><span class="line">            &lt;!-- 表格 --&gt;</span><br><span class="line">            &lt;el-table :border=&quot;true&quot;&gt;</span><br><span class="line">              &lt;el-table-column label=&quot;序号&quot; width=&quot;120&quot; /&gt;</span><br><span class="line">              &lt;el-table-column label=&quot;角色名称&quot; width=&quot;240&quot; /&gt;</span><br><span class="line">              &lt;el-table-column label=&quot;描述&quot; /&gt;</span><br><span class="line">              &lt;el-table-column label=&quot;操作&quot;&gt;</span><br><span class="line">                &lt;el-button size=&quot;small&quot; type=&quot;success&quot;&gt;分配权限&lt;/el-button&gt;</span><br><span class="line">                &lt;el-button size=&quot;small&quot; type=&quot;primary&quot;&gt;编辑&lt;/el-button&gt;</span><br><span class="line">                &lt;el-button size=&quot;small&quot; type=&quot;danger&quot;&gt;删除&lt;/el-button&gt;</span><br><span class="line">              &lt;/el-table-column&gt;</span><br><span class="line">            &lt;/el-table&gt;</span><br><span class="line">            &lt;!-- 分页组件 --&gt;</span><br><span class="line">            &lt;el-row type=&quot;flex&quot; justify=&quot;center&quot; style=&quot;height: 60px&quot;&gt;</span><br><span class="line">              &lt;!-- 分页组件 --&gt;</span><br><span class="line">              &lt;el-pagination layout=&quot;prev,pager,next&quot; :total=&quot;100&quot; /&gt;</span><br><span class="line">            &lt;/el-row&gt;</span><br><span class="line">            &lt;/el-card&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>以上是角色列表的基本布局。</p>
<p>下面定义对应的前端角色列表组件对应的路由规则。</p>
<p>在<code>router/modules</code>目录下面创建<code>roleInfo.js</code>，该文件中的代码如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导出角色的路由规则</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Layout</span> <span class="keyword">from</span> <span class="string">&quot;@/layout&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">path</span>: <span class="string">&quot;/roles&quot;</span>, <span class="comment">// 路由地址</span></span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;roles&quot;</span>, <span class="comment">// 给模块的一级路由设置一个name属性，后面设置权限的时候会使用到（注意这里如果只是给父级添加name属性在浏览器的控制台中会给出警告信息，为了解决这个问题，也需要在下面的子路由中添加name，当然这里可以先暂时的将name属性去掉，后面讲解到权限的时候在添加）</span></span><br><span class="line">    <span class="comment">// 都采用了Layout组件中的布局</span></span><br><span class="line">  <span class="attr">component</span>: <span class="title class_">Layout</span>,</span><br><span class="line">  <span class="attr">children</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">path</span>: <span class="string">&quot;&quot;</span>, <span class="comment">// 这里写成一个空字符串，当访问的地址是`/permission`的时候，不但会展示layout布局页面，而会展示下面component中指定的页面</span></span><br><span class="line">      <span class="attr">name</span>:<span class="string">&#x27;rolesChild&#x27;</span>,</span><br><span class="line">      <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&quot;@/views/roles&quot;</span>),</span><br><span class="line">      <span class="comment">// 路由元信息，可以存储任何的数据</span></span><br><span class="line">      <span class="attr">meta</span>: &#123;</span><br><span class="line">        <span class="attr">title</span>: <span class="string">&quot;角色管理&quot;</span>, <span class="comment">// 这里保存的是title,目的：会读取作该属性作为左侧的菜单项。</span></span><br><span class="line">        <span class="attr">icon</span>:<span class="string">&quot;setting&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>对应的<code>router</code>目录下的<code>index.js</code>文件中的代码，如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> employeesRouter <span class="keyword">from</span> <span class="string">&#x27;./modules/employees&#x27;</span></span><br><span class="line"><span class="keyword">import</span> departmentsRouter <span class="keyword">from</span> <span class="string">&#x27;./modules/departments&#x27;</span></span><br><span class="line"><span class="keyword">import</span> roleRouter <span class="keyword">from</span> <span class="string">&#x27;./modules/roleInfo&#x27;</span> <span class="comment">// ---------------导入roleInfo路由规则</span></span><br></pre></td></tr></table></figure>

<p>指定动态路由规则：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 动态路由</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> asyncRoutes =[</span><br><span class="line">  employeesRouter,</span><br><span class="line">  departmentsRouter,</span><br><span class="line">  roleRouter <span class="comment">//---------------指定角色的路由规则</span></span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<p>返回浏览器，查看前端展示效果。</p>
<h3 id="3、角色列表接口定义"><a href="#3、角色列表接口定义" class="headerlink" title="3、角色列表接口定义"></a>3、角色列表接口定义</h3><p>下面先创建数据仓库接口</p>
<p>定义<code>IRoleInfoService.cs</code>，代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.IRepository</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IRoleInfoRepository</span>:<span class="title">IBaseRepository</span>&lt;<span class="title">RoleInfo</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>数据仓储的具体实现，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.Repository</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RoleInfoRepository</span>:<span class="title">BaseRepository</span>&lt;<span class="title">RoleInfo</span>&gt;,<span class="title">IRoleInfoRepository</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">RoleInfoRepository</span>(<span class="params">MyDbContext context</span>) : <span class="title">base</span>(<span class="params">context</span>)</span> &#123; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定义服务的接口</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.IService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IRoleInfoService</span>:<span class="title">IBaseService</span>&lt;<span class="title">RoleInfo</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务的具体实现</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.Service</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RoleInfoService</span>:<span class="title">BaseService</span>&lt;<span class="title">RoleInfo</span>&gt;,<span class="title">IRoleInfoService</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IRoleInfoRepository _roleInfoRepository;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">RoleInfoService</span>(<span class="params">IRoleInfoRepository roleInfoRepository</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">base</span>.repository = roleInfoRepository;</span><br><span class="line">            _roleInfoRepository = roleInfoRepository;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>构建搜索条件，在<code>Cms.Entity</code>项目中的<code>Search</code>文件夹中创建<code>RoleSearch.cs</code>,代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.Entity.Search</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RoleSearch</span>:<span class="title">BaseSearch</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? RoleName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? Remark &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定义服务层中，关于获取角色列表的接口</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.IService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IRoleInfoService</span>:<span class="title">IBaseService</span>&lt;<span class="title">RoleInfo</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">IQueryable&lt;RoleInfo&gt; <span class="title">LoadSearchEntities</span>(<span class="params">RoleSearch roleInfoSearch, <span class="built_in">bool</span> delFlag</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>具体实现如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.Service</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RoleInfoService</span>:<span class="title">BaseService</span>&lt;<span class="title">RoleInfo</span>&gt;,<span class="title">IRoleInfoService</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IRoleInfoRepository _roleInfoRepository;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">RoleInfoService</span>(<span class="params">IRoleInfoRepository roleInfoRepository</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">base</span>.repository = roleInfoRepository;</span><br><span class="line">            _roleInfoRepository = roleInfoRepository;</span><br><span class="line">        &#125;</span><br><span class="line">       <span class="comment">// 实现搜索</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> IQueryable&lt;RoleInfo&gt; <span class="title">LoadSearchEntities</span>(<span class="params">RoleSearch roleInfoSearch, <span class="built_in">bool</span> delFlag</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> temp = _roleInfoRepository.LoadEntities(r =&gt; r.DelFlag == delFlag);</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrWhiteSpace(roleInfoSearch.RoleName))</span><br><span class="line">            &#123;</span><br><span class="line">                temp = temp.Where&lt;RoleInfo&gt;(r=&gt;r.RoleName!.Contains(roleInfoSearch.RoleName));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrWhiteSpace(roleInfoSearch.Remark))</span><br><span class="line">            &#123;</span><br><span class="line">                temp = temp.Where&lt;RoleInfo&gt;(r=&gt;r.Remark!.Contains(roleInfoSearch.Remark));</span><br><span class="line">            &#125;</span><br><span class="line">            roleInfoSearch.TotalCount = temp.Count();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (roleInfoSearch.Order)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> temp.OrderBy&lt;RoleInfo, <span class="built_in">long</span>&gt;(u =&gt; u.Id).Skip&lt;RoleInfo&gt;((roleInfoSearch.PageIndex - <span class="number">1</span>) * roleInfoSearch.PageSize).Take&lt;RoleInfo&gt;(roleInfoSearch.PageSize);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> temp.OrderByDescending&lt;RoleInfo, <span class="built_in">long</span>&gt;(u =&gt; u.Id).Skip&lt;RoleInfo&gt;((roleInfoSearch.PageIndex - <span class="number">1</span>) * roleInfoSearch.PageSize).Take&lt;RoleInfo&gt;(roleInfoSearch.PageSize);</span><br><span class="line">            &#125;</span><br><span class="line">          </span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>构建参数</strong></p>
<p>在<code>WebApi</code>项目中的<code>ResourceParams</code>文件夹中创建<code>RoleParams.cs</code>，代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.WebApi.ResourceParams</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RoleParams</span>:<span class="title">BaseParams</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? RoleName &#123; <span class="keyword">get</span>;<span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? Remark &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>创建<code>RoleInfoController.cs</code>控制器</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.WebApi.Controllers</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">Route(<span class="string">&quot;api/[controller]&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">ApiController</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RolesController</span> : <span class="title">ControllerBase</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IRoleInfoService _roleInfoService;</span><br><span class="line">        <span class="comment">// 完成注入操作</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">RolesController</span>(<span class="params">IRoleInfoService roleInfoService</span>)</span> &#123;</span><br><span class="line">          <span class="keyword">this</span>._roleInfoService = roleInfoService;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 定义具体的方法</span></span><br><span class="line">        [<span class="meta">HttpGet</span>]</span><br><span class="line">       [<span class="meta">Authorize</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> IActionResult <span class="title">GetRoles</span>(<span class="params">[FromQuery]RoleParams roleParams</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">int</span> totalCount = <span class="number">0</span>;</span><br><span class="line">            RoleSearch roleSearch = <span class="keyword">new</span> RoleSearch()</span><br><span class="line">            &#123;</span><br><span class="line">                    Order = roleParams.Order,</span><br><span class="line">                  PageIndex = roleParams.PageIndex,</span><br><span class="line">                   PageSize = roleParams.PageSize,</span><br><span class="line">                   Remark = roleParams.Remark,</span><br><span class="line">                    RoleName = roleParams.RoleName,</span><br><span class="line">                    TotalCount = totalCount</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">var</span> roles = _roleInfoService.LoadSearchEntities(roleSearch, Convert.ToBoolean(DelFlagEnum.Normal));</span><br><span class="line">            <span class="keyword">if</span> (roles.Count() &lt;= <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> BadRequest(<span class="string">&quot;没有角色信息&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> Ok(<span class="keyword">new</span> ApiResult&lt;<span class="built_in">object</span>&gt;() &#123; Success = <span class="literal">true</span>, Message = <span class="string">&quot;获取角色成功&quot;</span>, Data = <span class="keyword">new</span> &#123; rows = roles, total = roleSearch.TotalCount &#125; &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>以上是接口的具体实现。</p>
<h3 id="4、前端角色信息展示"><a href="#4、前端角色信息展示" class="headerlink" title="4、前端角色信息展示"></a>4、前端角色信息展示</h3><p>在这一小节中，我们要实现的是展示角色信息</p>
<p>在<code>src/api/</code>目录下面创建<code>role.js</code>文件，该文件中的代码如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> request <span class="keyword">from</span> <span class="string">&quot;@/utils/request&quot;</span>;</span><br><span class="line"><span class="comment">// 获取角色列表</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getRoleList</span>(<span class="params">params</span>)&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">request</span>(&#123;</span><br><span class="line">    <span class="attr">method</span>:<span class="string">&#x27;get&#x27;</span>,</span><br><span class="line">    <span class="attr">url</span>:<span class="string">&#x27;/roles&#x27;</span>,</span><br><span class="line">    params</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>params是查询参数，里面需要携带分页信息</code></p>
<p>下面修改<code>view/roles/index.vue</code>组件中的代码，如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">import</span> &#123;reactive, ref,onMounted, toRefs&#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; getRoleList &#125; <span class="keyword">from</span> <span class="string">&#x27;@/api/role&#x27;</span>;  <span class="comment">// ---导入getRoleList</span></span><br><span class="line">  <span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    <span class="attr">name</span>:<span class="string">&#x27;Role&#x27;</span>,</span><br><span class="line">    <span class="title function_">setup</span>(<span class="params"></span>)&#123;</span><br><span class="line">      <span class="keyword">const</span> list = <span class="title function_">ref</span>([]);</span><br><span class="line">      <span class="keyword">const</span> page =<span class="title function_">reactive</span>(&#123;</span><br><span class="line">        <span class="attr">params</span>:&#123;</span><br><span class="line">          <span class="title class_">PageIndex</span>:<span class="number">1</span>,</span><br><span class="line">          <span class="title class_">PageSize</span>:<span class="number">2</span>,</span><br><span class="line">          <span class="attr">total</span>:<span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">      <span class="title function_">onMounted</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="title function_">getRoleListInfo</span>();</span><br><span class="line">      &#125;)</span><br><span class="line">      <span class="keyword">const</span> <span class="title function_">getRoleListInfo</span> = <span class="keyword">async</span>(<span class="params"></span>)=&gt;&#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;total,rows&#125; = <span class="keyword">await</span> <span class="title function_">getRoleList</span>(page.<span class="property">params</span>);</span><br><span class="line">                <span class="comment">// total：记录了总的记录数</span></span><br><span class="line">      <span class="comment">// rows: 表示获取到的角色信息</span></span><br><span class="line">        page.<span class="property">params</span>.<span class="property">total</span> = total;</span><br><span class="line">        list.<span class="property">value</span> = rows;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        list,</span><br><span class="line">        ...<span class="title function_">toRefs</span>(page)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>在上面的代码中，导入<code>getRoleList</code>.</p>
<p>同时定义<code>list</code>集合存储服务端返回的角色数据。</p>
<p>定义<code>page</code>对象，对象中的<code>params</code>也是一个对象，其中的<code>PageIndex</code>和<code>PageSize</code>分别表示当前页码和每页显示的记录数。</p>
<p><code>total</code>:表示总的记录数。</p>
<p>在<code>onMounted</code>这个钩子函数中调用了<code>getRoleListInfo</code>方法，在该方法调用了<code>getRoleList</code>方法，发送请求。</p>
<p>服务端返回的数据中包含了<code>total</code>和<code>rows</code>.</p>
<p><code>total</code>：表示总的记录数</p>
<p><code>rows</code>:  表示获取到的角色数据。</p>
<p>下面把数据展示到表格中。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">       list,</span><br><span class="line">       ...<span class="title function_">toRefs</span>(page)</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>

<p>在返回的数据中，将<code>page</code>进行了解构，为了保证解构出的内容还是响应式的，这里通过<code>toRefs</code>函数进行了转换。</p>
<p>下面在表格中展示上面所返回的<code>list</code>中的数据，如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 表格 --&gt;</span><br><span class="line">           &lt;el-table :border=&quot;true&quot; :data=&quot;list&quot;&gt;</span><br><span class="line">             &lt;el-table-column label=&quot;序号&quot; width=&quot;120&quot; type =&quot;index&quot; /&gt;</span><br><span class="line">             &lt;el-table-column label=&quot;角色名称&quot; width=&quot;240&quot; prop =&quot;roleName&quot; /&gt;</span><br><span class="line">             &lt;el-table-column label=&quot;描述&quot; prop=&quot;remark&quot; /&gt;</span><br><span class="line">             &lt;el-table-column label=&quot;操作&quot;&gt;</span><br><span class="line">               &lt;el-button size=&quot;small&quot; type=&quot;success&quot;&gt;分配权限&lt;/el-button&gt;</span><br><span class="line">               &lt;el-button size=&quot;small&quot; type=&quot;primary&quot;&gt;编辑&lt;/el-button&gt;</span><br><span class="line">               &lt;el-button size=&quot;small&quot; type=&quot;danger&quot;&gt;删除&lt;/el-button&gt;</span><br><span class="line">             &lt;/el-table-column&gt;</span><br><span class="line">           &lt;/el-table&gt;</span><br></pre></td></tr></table></figure>

<p>这里给<code>el-table</code>组件添加<code>data</code>属性，绑定<code>list</code>，也就是指定了数据源</p>
<p>同时给第一列添加了<code>type=&#39;index&#39;</code>表示第一列展示序号</p>
<p>然后给其它列通过<code>prop</code>属性指定要展示的数据的属性.</p>
<p>返回到浏览器中查看效果</p>
<p>下面处理分页的问题：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 分页组件 --&gt;</span><br><span class="line">           &lt;el-row type=&quot;flex&quot; justify=&quot;center&quot; style=&quot;height: 60px&quot;&gt;</span><br><span class="line">             &lt;!-- 分页组件 --&gt;</span><br><span class="line">             &lt;el-pagination</span><br><span class="line">               layout=&quot;prev,pager,next&quot;</span><br><span class="line">               :total=&quot;params.total&quot;</span><br><span class="line">               :page-size=&quot;params.PageSize&quot;</span><br><span class="line">               v-model:currentPage=&quot;params.PageIndex&quot;</span><br><span class="line">               @current-change=&quot;handleCurrentChange&quot;</span><br><span class="line">             /&gt;</span><br><span class="line">           &lt;/el-row&gt;</span><br></pre></td></tr></table></figure>

<p>这里给<code>el-pagination</code>组件指定了<code>total,page-size</code>,同时指定了<code>currentPage</code>表示当前页。这里需要注意指定该属性的时候是通过<code>v-model</code>进行了绑定。</p>
<p>并且指定了<code>current-change</code>事件，当进行页码切换的时候，会触发该事件。</p>
<p>从而会执行<code>handleCurrentChange</code>这个处理函数。该函数的实现如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">handleCurrentChange</span> = (<span class="params">value</span>) =&gt; &#123;</span><br><span class="line">     page.<span class="property">params</span>.<span class="property">page</span> = value;</span><br><span class="line">     <span class="title function_">getRoleListInfo</span>();</span><br><span class="line">   &#125;;</span><br><span class="line">     <span class="keyword">return</span> &#123;</span><br><span class="line">       list,</span><br><span class="line">       ...<span class="title function_">toRefs</span>(page),</span><br><span class="line">       handleCurrentChange <span class="comment">// 返回</span></span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>

<p>接收到的<code>value</code>参数中存储的就是当前切换的页码。</p>
<p>然后再次调用了<code>getRoleListInfo</code>方法，根据新的页码值重新发送请求，获取最新的数据。</p>
<p>将<code>handleCurrentChange</code>函数也返回了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; ref, reactive, onMounted, toRefs &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>这里也需要导入<code>toRefs</code>函数</p>
<p>返回到浏览器中进行测试。</p>
<h3 id="5、为用户分配角色"><a href="#5、为用户分配角色" class="headerlink" title="5、为用户分配角色"></a>5、为用户分配角色</h3><p>关于角色的添加，编辑与删除，大家可以自己实现。</p>
<h4 id="5-1-获取用户已经具有角色接口实现"><a href="#5-1-获取用户已经具有角色接口实现" class="headerlink" title="5.1  获取用户已经具有角色接口实现"></a>5.1  获取用户已经具有角色接口实现</h4><p>在<code>UsersController.cs</code>控制器中添加如下方法</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 获取所有角色以及用户具有的角色。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;id&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        [<span class="meta">HttpGet(<span class="string">&quot;&#123;id&#125;/roles&quot;</span>)</span>]</span><br><span class="line">        [<span class="meta">Authorize</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">GetUserRoles</span>(<span class="params">[FromRoute]<span class="built_in">int</span> id</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> userInfo =<span class="keyword">await</span> _userInfoService.LoadEntities(u=&gt;u.Id == id).FirstOrDefaultAsync();</span><br><span class="line">            <span class="keyword">if</span> (userInfo == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> BadRequest(<span class="string">&quot;没有查询到对应的用户&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 获取用户已经具有的角色</span></span><br><span class="line">            <span class="keyword">var</span> userAllRoles =  _userInfoService.LoadEntities(u =&gt; u.Id == id).Select(r=&gt;r.RoleInfos);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 要分配角色的用户以前具有哪些角色(这里只要角色编号)</span></span><br><span class="line">            <span class="keyword">var</span> userRoleIdList = userAllRoles.Select(u=&gt;u.Select(r=&gt;r.Id)</span><br><span class="line">                                                     </span><br><span class="line">                 <span class="comment">//      var userRoles =  userInfoService.LoadEntities(u =&gt; u.Id == id).Include(u =&gt; u.RoleInfos);</span></span><br><span class="line">             <span class="comment">// var userRoleIds =  userRoles.Select(u =&gt; u.RoleInfos.Select(r =&gt; r.Id));                                    </span></span><br><span class="line">                                                     </span><br><span class="line">            <span class="comment">// 获取所有的角色</span></span><br><span class="line">            <span class="keyword">var</span> roleInfoList = _roleInfoService.LoadEntities(r=&gt;r.DelFlag==Convert.ToBoolean(DelFlagEnum.Normal)).ToList();</span><br><span class="line">            <span class="keyword">return</span> Ok(<span class="keyword">new</span> ApiResult&lt;<span class="built_in">object</span>&gt; &#123;Success=<span class="literal">true</span>,Message=<span class="string">&quot;获取成功&quot;</span>, Data=<span class="keyword">new</span> &#123; userRoles=userRoleIdList,allRoles=roleInfoList &#125; &#125;);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-2-展示用户具有的角色-前端实现"><a href="#5-2-展示用户具有的角色-前端实现" class="headerlink" title="5.2  展示用户具有的角色-前端实现"></a>5.2  展示用户具有的角色-前端实现</h4><p>在<code>views/employees/index.vue</code>这个组件中，添加窗口，如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> &lt;AddEmployee :showDialog=&quot;showAddDialog&quot;    @addEmployee=&quot;loadEmployeeList&quot;  @changedialog=&quot;updatedialog&quot;&gt;&lt;/AddEmployee&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">&lt;!--弹出分配角色的窗口--&gt;</span><br><span class="line">      &lt;el-dialog v-model=&quot;showRoleDialog&quot; title=&#x27;为用户分配角色&#x27;&gt;</span><br><span class="line">        hello</span><br><span class="line">      </span><br><span class="line">      &lt;/el-dialog&gt;</span><br></pre></td></tr></table></figure>

<p>这里我们添加了一个<code>el-dialog</code>组件，用来展示为用户分配角色的窗口，当然，这里也可以单独的封装成一个组件也是可以的。</p>
<p>通过<code>v-model</code>的值<code>showRoleDialog</code>，来控制窗口的弹出与因此。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">setup</span>(<span class="params"></span>)&#123;</span><br><span class="line">      <span class="keyword">const</span> loading = <span class="title function_">ref</span>(<span class="literal">false</span>);</span><br><span class="line">      <span class="keyword">const</span> showRoleDialog =<span class="title function_">ref</span>(<span class="literal">false</span>); <span class="comment">// 声明showRoleDialog</span></span><br></pre></td></tr></table></figure>

<p>在上面的代码中声明了<code>showRoleDialog</code>,同时也需要将其返回</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">      loading,</span><br><span class="line">      list,</span><br><span class="line">      page,</span><br><span class="line">      handleCurrentChange,</span><br><span class="line">      formatTimeOfEntry,</span><br><span class="line">      showAddDialog,</span><br><span class="line">      updatedialog,</span><br><span class="line">      loadEmployeeList,</span><br><span class="line">      showRoleDialog, <span class="comment">// 返回</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面在表格中添加一个分配角色的按钮，如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;template #default=&quot;scope&quot;&gt;</span><br><span class="line">            &lt;el-button   size=&quot;small&quot;&gt;查看&lt;/el-button&gt;              </span><br><span class="line">            &lt;el-button type=&quot;primary&quot; size=&quot;small&quot; @click=&quot;btnRole(scope.row)&quot;&gt;分配角色&lt;/el-button&gt;</span><br></pre></td></tr></table></figure>

<p>这里给<code>分配角色</code>的按钮注册了<code>click</code>事件，事件触发以后，调用<code>btnRole</code>这个函数，同时将<code>scope.row</code>也就是要分配角色的用户信息传递该函数中，<code>btnRole</code>函数的定义如下所示;</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 为用户分配角色</span></span><br><span class="line">   <span class="keyword">const</span> <span class="title function_">btnRole</span> = <span class="keyword">async</span>(<span class="params">row</span>)=&gt;&#123;</span><br><span class="line">    showRoleDialog.<span class="property">value</span> = <span class="literal">true</span>; <span class="comment">// 展示窗口</span></span><br><span class="line">    <span class="keyword">const</span> &#123;userRoles,allRoles &#125; = <span class="keyword">await</span> <span class="title function_">getUserRoleList</span>(row.<span class="property">id</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;userRoles=&quot;</span>,userRoles);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;allRoles=&quot;</span>,allRoles);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>通过上面的代码，我们可以看到，这里调用了<code>getUserRoleList</code>这个方法，并且传递了用户的编号。</p>
<p><code>api/employees.js</code>文件中定义该方法，如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取用户具有的角色</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getUserRoleList</span>(<span class="params">id</span>)&#123;</span><br><span class="line">   </span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">request</span>(<span class="string">`/users/<span class="subst">$&#123;id&#125;</span>/roles`</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>views/employees/index.vue</code>这个组件中，导入上面定义的<code>getUserRoleList</code>这个方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; getEmployeeList,getUserRoleList &#125; <span class="keyword">from</span> <span class="string">&quot;@/api/employees&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>最后将<code>btnRole</code>这个方法返回</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">     loading,</span><br><span class="line">     list,</span><br><span class="line">     page,</span><br><span class="line">     handleCurrentChange,</span><br><span class="line">     formatTimeOfEntry,</span><br><span class="line">     showAddDialog,</span><br><span class="line">     updatedialog,</span><br><span class="line">     loadEmployeeList,</span><br><span class="line">     showRoleDialog,</span><br><span class="line">     btnRole <span class="comment">// 返回btnRole</span></span><br><span class="line">   &#125;;</span><br></pre></td></tr></table></figure>

<p>返回到浏览器中进行测试，在控制台中查看服务端返回的结果。</p>
<p>现在已经，获取到了所有的角色，以及用户已经具有的角色，下面要进行展示。</p>
<p>这里我们会给每个角色名称前面添加一个复选框，如果当前分配角色的用户以前已经具有了该角色，则让该复选框选中。</p>
<p>这里我们使用的是复选框<code>CheckBox</code>的多选框组来进行构建：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://element-plus.gitee.io/zh-CN/component/checkbox.html#%E5%A4%9A%E9%80%89%E6%A1%86%E7%BB%84</span><br></pre></td></tr></table></figure>

<p>下面我们先将获取到的角色数据，赋值给一个响应对象</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">const</span> showRoleDialog =<span class="title function_">ref</span>(<span class="literal">false</span>);</span><br><span class="line"><span class="comment">// 定义roles响应对象</span></span><br><span class="line">      <span class="keyword">const</span> roles=<span class="title function_">reactive</span>(&#123;</span><br><span class="line">        <span class="attr">userRoles</span>:[], <span class="comment">// 存储用户已经具有的角色编号</span></span><br><span class="line">        <span class="attr">allRoles</span>:[]  <span class="comment">// 存储所有的角色</span></span><br><span class="line">      &#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 为用户分配角色</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">btnRole</span> = <span class="keyword">async</span>(<span class="params">row</span>)=&gt;&#123;</span><br><span class="line">   showRoleDialog.<span class="property">value</span> = <span class="literal">true</span>;</span><br><span class="line">   <span class="keyword">const</span> &#123;userRoles,allRoles &#125; = <span class="keyword">await</span> <span class="title function_">getUserRoleList</span>(row.<span class="property">id</span>);</span><br><span class="line">   roles.<span class="property">allRoles</span> = allRoles;</span><br><span class="line">   roles.<span class="property">userRoles</span> = userRoles;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>在<code>btnRole</code>方法中，我们将数据分别赋值给了<code>roles</code>这个响应式对象中的<code>allRoles</code>属性和<code>userRoles</code>属性。</p>
<p>最后，需要将<code>roles</code>这个对象返回</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">    loading,</span><br><span class="line">    list,</span><br><span class="line">    page,</span><br><span class="line">    handleCurrentChange,</span><br><span class="line">    formatTimeOfEntry,</span><br><span class="line">    showAddDialog,</span><br><span class="line">    updatedialog,</span><br><span class="line">    loadEmployeeList,</span><br><span class="line">    showRoleDialog,</span><br><span class="line">    btnRole, </span><br><span class="line">    ...<span class="title function_">toRefs</span>(roles), <span class="comment">// 这里将roles解构，然后在通过toRefs转换成响应式对象</span></span><br><span class="line">   </span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>

<p>下面改造<code>dialog</code>窗口中的内容，如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-dialog v-model=&quot;showRoleDialog&quot; :title=&quot;`为用户分配角色`&quot;&gt;</span><br><span class="line">        &lt;el-checkbox-group v-model=&quot;roleIdList&quot;&gt;</span><br><span class="line">          &lt;el-checkbox v-for=&quot;item in allRoles&quot; :label=&quot;item.id&quot; :key=&quot;item.id&quot;&gt;&#123;&#123; item.roleName &#125;&#125;&lt;/el-checkbox&gt;</span><br><span class="line">        &lt;/el-checkbox-group&gt;</span><br><span class="line">     </span><br><span class="line">     &lt;/el-dialog&gt;</span><br></pre></td></tr></table></figure>

<p>在<code>el-dialog</code>窗口中使用了<code>el-checkbox-group </code>,并且为其添加了<code>v-model</code>属性进行双向绑定，这里绑定了<code>roleIdList</code>。</p>
<p>作用是：当我们选中了某些复选框后，选中的复选框的内容，会保存到<code>roleIdList</code>中。</p>
<p>下面在对<code>el-checkbox</code>进行循环，这里展示的是角色的名称，同时<code>label</code>属性的值是角色的编号，也就是说，我们选中了复选框后，要获取选中的复选框的值，而这些值就是角色的编号，当前选中的角色编号会自动的保存到<code>roleIdList</code>中。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> loading = <span class="title function_">ref</span>(<span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">const</span> roleIdList = <span class="title function_">ref</span>([]); <span class="comment">// 定义roleIdList,默认值是一个数组，这里可以通过文档来查看</span></span><br><span class="line">    <span class="keyword">const</span> showRoleDialog =<span class="title function_">ref</span>(<span class="literal">false</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">     loading,</span><br><span class="line">     list,</span><br><span class="line">     page,</span><br><span class="line">     handleCurrentChange,</span><br><span class="line">     formatTimeOfEntry,</span><br><span class="line">     showAddDialog,</span><br><span class="line">     updatedialog,</span><br><span class="line">     loadEmployeeList,</span><br><span class="line">     showRoleDialog,</span><br><span class="line">     btnRole,</span><br><span class="line">     ...<span class="title function_">toRefs</span>(roles),</span><br><span class="line">     username,</span><br><span class="line">     roleIdList <span class="comment">// 返回roleIdList</span></span><br><span class="line">   &#125;;</span><br></pre></td></tr></table></figure>

<p>上面将<code>roleIdList</code>这个数组返回了。</p>
<p>返回到浏览器中查看效果。</p>
<p><strong>下面要实现的就是将用户已经具有的角色选中</strong></p>
<p>这个需求实现起来比较简单</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-checkbox-group v-model=&quot;roleIdList&quot;&gt;</span><br></pre></td></tr></table></figure>

<p>前面，我们给<code>el-checkbox-group</code> 添加了<code>v-model</code>这个属性，实现了双向数据绑定，也就是说我们给<code>roleIdList</code>赋值，对应的复选框也会选中。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 为用户分配角色</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">btnRole</span> = <span class="keyword">async</span>(<span class="params">row</span>)=&gt;&#123;</span><br><span class="line">     username.<span class="property">value</span>=row.<span class="property">userName</span>;</span><br><span class="line">     <span class="keyword">const</span> &#123;userRoles,allRoles &#125; = <span class="keyword">await</span> <span class="title function_">getUserRoleList</span>(row.<span class="property">id</span>);</span><br><span class="line">     roles.<span class="property">allRoles</span> = allRoles;</span><br><span class="line">     roles.<span class="property">userRoles</span> = userRoles;</span><br><span class="line">        <span class="comment">// 给roleIdList赋值，注意：服务端返回的userRoles是一个二维数组，第一个元素也是一个数组，存储用户具有的角色编号</span></span><br><span class="line">     roleIdList.<span class="property">value</span>= roles.<span class="property">userRoles</span>[<span class="number">0</span>];</span><br><span class="line">           showRoleDialog.<span class="property">value</span> = <span class="literal">true</span>; <span class="comment">// 注意：这里将这行代码放在了btnRole方法的最后，原因：先获取数据然后在弹出窗口，否则如果出现了网络比较慢的情况，就会把窗口弹出来了，但是没有数据的情况</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>返回到浏览器中进行查看。</p>
<h4 id="5-3-完成角色分配"><a href="#5-3-完成角色分配" class="headerlink" title="5.3 完成角色分配"></a>5.3 完成角色分配</h4><h5 id="5-3-1-前端实现"><a href="#5-3-1-前端实现" class="headerlink" title="5.3.1 前端实现"></a>5.3.1 前端实现</h5><p>首先在窗口中增加“确定与取消”按钮。</p>
<p>并且给“确定”按钮注册单击事件，如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-dialog v-model=&quot;showRoleDialog&quot; :title=&quot;`为用户分配角色`&quot;&gt;</span><br><span class="line">       &lt;el-checkbox-group v-model=&quot;roleIdList&quot;&gt;</span><br><span class="line">         &lt;el-checkbox v-for=&quot;item in allRoles&quot; :label=&quot;item.id&quot; :key=&quot;item.id&quot;&gt;&#123;&#123; item.roleName &#125;&#125;&lt;/el-checkbox&gt;</span><br><span class="line">       &lt;/el-checkbox-group&gt;</span><br><span class="line">       &lt;!-- ----------------确定取消按钮 --&gt;</span><br><span class="line">       &lt;el-row type=&quot;flex&quot; justify=&quot;center&quot;&gt;</span><br><span class="line">        &lt;el-col :span=&quot;6&quot;&gt;</span><br><span class="line">          &lt;el-button type=&quot;primary&quot; size=&quot;small&quot;   @click=&quot;btnRoleOk&quot;&gt;确定&lt;/el-button&gt;</span><br><span class="line">          &lt;el-button size=&quot;small&quot; @click=&quot;showRoleDialog=false&quot;&gt;取消&lt;/el-button&gt;</span><br><span class="line">        &lt;/el-col&gt;</span><br><span class="line">       &lt;/el-row&gt;</span><br><span class="line">    &lt;/el-dialog&gt;</span><br></pre></td></tr></table></figure>

<p>当单击<code>确定</code>按钮的时候，会执行<code>btnRoleOk</code>这个函数，在该函数中会发送请求。</p>
<p>所以这里我们还需要创建一个发送请求的方法。</p>
<p>在<code>src/api/employees.js</code>文件中，添加如下方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 为用户分配角色</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">setUserRole</span>(<span class="params">id,data</span>)&#123;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">request</span>(&#123;</span><br><span class="line">      <span class="attr">method</span>:<span class="string">&#x27;post&#x27;</span>,</span><br><span class="line">      <span class="attr">url</span>: <span class="string">`/users/<span class="subst">$&#123;id&#125;</span>/roles/<span class="subst">$&#123;data&#125;</span>`</span>,</span><br><span class="line">    &#125;)</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>参数<code>id</code>,表示的是用户的编号，<code>data</code>就是要分配的角色的编号。</p>
<p>这里发送的是<code>post</code>请求，并且是通过<code>url</code>地址的方式传递参数。</p>
<p>返回到<code>views/employee/index.vue</code>这个组件中继续修改代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 完成用户角色的分配</span></span><br><span class="line">   <span class="keyword">const</span> <span class="title function_">btnRoleOk</span>=<span class="keyword">async</span>(<span class="params"></span>)=&gt;&#123;</span><br><span class="line">    <span class="comment">// console.log(&#x27;userId=&#x27;,userId.value);</span></span><br><span class="line">    <span class="comment">// console.log(&quot;roleIdList=&quot;,roleIdList.value.join(&#x27;,&#x27;));</span></span><br><span class="line">    <span class="comment">// 如果为0，表示取消了某个用户所有的角色</span></span><br><span class="line">    <span class="keyword">const</span> ids=roleIdList.<span class="property">value</span>.<span class="property">length</span>&gt;<span class="number">0</span>?roleIdList.<span class="property">value</span>.<span class="title function_">join</span>(<span class="string">&#x27;,&#x27;</span>):<span class="string">&#x27;0&#x27;</span></span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">setUserRole</span>(userId.<span class="property">value</span>,ids);</span><br><span class="line">       <span class="title class_">ElMessage</span>(&#123;</span><br><span class="line">      <span class="attr">message</span>:<span class="string">&quot;分配角色成功&quot;</span>,</span><br><span class="line">      <span class="attr">type</span>:<span class="string">&#x27;success&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line"> </span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>上面的代码实现了<code>btnRoleOk</code>函数，在这函数中首先从<code>roleIdList</code>中获取所选中的角色的编号，<code>roleIdList</code>前面已经绑定了复选框</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-checkbox-group v-model=&quot;roleIdList&quot;&gt;</span><br></pre></td></tr></table></figure>

<p><code>roleIdList</code>是一个数组，当选中了复选框后，所选中的复选框的角色编号会存储在该数组中，</p>
<p>在向服务端发送的时候，将该数组中存储的角色编号都转换成了字符串，然后使用逗号进行分割。</p>
<p>如果，在分配角色的时候，没有选择一个角色，也就是没有选择一个复选框，但是单击了确定按钮，这里会向服务端发送一个0，表示取消用户的角色（以前用户是有角色的，但是这里取消了选择）</p>
<p>问题是：在调用<code>setUserRole</code>方法的时候，需要传递用户的编号，用户的编号怎样获取呢？</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> showRoleDialog =<span class="title function_">ref</span>(<span class="literal">false</span>);</span><br><span class="line">     <span class="keyword">const</span> userId=<span class="title function_">ref</span>(<span class="number">0</span>); <span class="comment">// 存储要分配角色的用户编号</span></span><br></pre></td></tr></table></figure>

<p>这里定义了<code>userId</code>，用来存储要分配角色的用户的编号。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 为用户分配角色</span></span><br><span class="line">   <span class="keyword">const</span> <span class="title function_">btnRole</span> = <span class="keyword">async</span>(<span class="params">row</span>)=&gt;&#123;</span><br><span class="line">    showRoleDialog.<span class="property">value</span> = <span class="literal">true</span>;</span><br><span class="line">    userId.<span class="property">value</span>= row.<span class="property">id</span>; <span class="comment">// -----------------------存储用户的编号 </span></span><br><span class="line">    <span class="keyword">const</span> &#123;userRoles,allRoles &#125; = <span class="keyword">await</span> <span class="title function_">getUserRoleList</span>(row.<span class="property">id</span>);</span><br></pre></td></tr></table></figure>

<p>我们知道，当单击用户列表中的<code>分配角色</code>按钮的时候，会首先调用<code>btnRole</code>方法，在这方法中，传递过来的参数<code>row</code>中存储了要分配角色的用户信息，将其编号存储到了<code>userId</code>中。</p>
<p>所以，在<code>btnRoleOk</code>方法中，就可以通过<code>userId</code>来获取用户的编号。最后通过<code>ElMessage</code>组件给出相应的提示。</p>
<p>当然，这里需要将<code>setUserRole</code>方法导入进来。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; getEmployeeList,getUserRoleList,setUserRole &#125; <span class="keyword">from</span> <span class="string">&quot;@/api/employees&quot;</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">     loading,</span><br><span class="line">     list,</span><br><span class="line">     page,</span><br><span class="line">     handleCurrentChange,</span><br><span class="line">     formatTimeOfEntry,</span><br><span class="line">     showAddDialog,</span><br><span class="line">     updatedialog,</span><br><span class="line">     loadEmployeeList,</span><br><span class="line">     showRoleDialog,</span><br><span class="line">     btnRole,</span><br><span class="line">     ...<span class="title function_">toRefs</span>(roles),</span><br><span class="line">     roleIdList,</span><br><span class="line">     btnRoleOk <span class="comment">// btnRoleOk</span></span><br><span class="line">   &#125;;</span><br></pre></td></tr></table></figure>

<p>最后，返回<code>btnRoleOk</code>函数</p>
<h5 id="5-3-2服务端接口实现"><a href="#5-3-2服务端接口实现" class="headerlink" title="5.3.2服务端接口实现"></a>5.3.2<strong>服务端接口实现</strong></h5><p>第一步：在给某个用户分配角色的时候，我们需要获取该用户以前具有的角色，所以这里我们需要定义一个数据访问的仓储接口。</p>
<p>修改<code>Cms.IRepository</code>项目中的<code>IRoleInfoRepository</code>接口</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.IRepository</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IRoleInfoRepository</span>:<span class="title">IBaseRepository</span>&lt;<span class="title">RoleInfo</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        Task&lt;List&lt;RoleInfo&gt;&gt; GetUserRoles(<span class="built_in">long</span> userId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>IRoleInfoRepository</code>接口中添加了<code>GetUserRoles</code>方法，该方法的作用就是根据用户的编号，查询用户具有的角色信息。</p>
<p>第二：实现<code>GetUserRoles</code>方法</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.Repository</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RoleInfoRepository</span>:<span class="title">BaseRepository</span>&lt;<span class="title">RoleInfo</span>&gt;,<span class="title">IRoleInfoRepository</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">RoleInfoRepository</span>(<span class="params">MyDbContext context</span>) : <span class="title">base</span>(<span class="params">context</span>)</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;List&lt;RoleInfo&gt;&gt; GetUserRoles(<span class="built_in">long</span> userId)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">var</span> userInfo = <span class="keyword">await</span> ctx.UserInfos.Include(r =&gt; r.RoleInfos).Where(u =&gt; u.Id == userId).FirstOrDefaultAsync();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> userInfo!.RoleInfos.ToList();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在上面的代码中，我们通过父类 中注册的<code>DbContext</code>对象<code>ctx</code>来查询用户具有的角色信息，这里使用了<code>include</code>来进行关联的查询。</p>
<p>最后返回的就是用户以前具有的角色信息，这里将其存储到了<code>list</code>集合中返回。</p>
<p>第三：定义实现分配角色的服务接口</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.IService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IUserInfoService</span>:<span class="title">IBaseService</span>&lt;<span class="title">UserInfo</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">IQueryable&lt;UserInfo&gt; <span class="title">LoadSearchEntities</span>(<span class="params">UserInfoSearch userInfoSearch, <span class="built_in">bool</span> delFlag</span>)</span>;</span><br><span class="line">        <span class="comment">// 实现分配用户角色</span></span><br><span class="line">        <span class="function">Task&lt;<span class="built_in">bool</span>&gt; <span class="title">SetUserRoles</span>(<span class="params">UserInfo userInfo, List&lt;<span class="built_in">long</span>&gt; roleIdList</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在上面的代码中，声明了<code>SetUserRoles</code>方法，用来实现给某个用户分配角色。<code>roleIdList</code>中存储的就是要分配的角色的编号。</p>
<p>第四：实现角色的分配业务</p>
<p>在<code>UserInfoService.cs</code>服务类中实现了<code>SetUserRoles</code>方法</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt; <span class="built_in">bool</span>&gt; SetUserRoles(UserInfo userInfo, List&lt;<span class="built_in">long</span>&gt; strIds)</span><br><span class="line">&#123;</span><br><span class="line">            </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">await</span> _roleInfoRepository.GetUserRoles(userInfo.Id);<span class="comment">// 获取用户以前具有的角色</span></span><br><span class="line">   <span class="comment">//  _userInfoRepository.LoadEntities(u=&gt;u.Id== userInfo.Id).Include(u=&gt;u.RoleInfos).ToList(); // 获取用户以前具有的角色</span></span><br><span class="line">    <span class="comment">// 删除用户以前具有的角色信息</span></span><br><span class="line">    userInfo.RoleInfos.Clear();</span><br><span class="line">    <span class="comment">// 如果strIds集合中只有一个元素，并且值是0，表示要删除当前用户所有的角色</span></span><br><span class="line">    <span class="keyword">if</span> (strIds.Count == <span class="number">1</span> &amp;&amp; strIds[<span class="number">0</span>] == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    <span class="comment">// 完成更新操作。（所以这里最好是发送put请求）</span></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">var</span> roleId <span class="keyword">in</span> strIds)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> roleInfo = <span class="keyword">await</span> _roleInfoRepository.LoadEntities(r =&gt; r.Id == roleId).FirstOrDefaultAsync();</span><br><span class="line">        userInfo!.RoleInfos.Add(roleInfo!);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在上面的代码中，根据传递过来的用户编号，调用<code>roleInfoRepository</code>数据仓储中的<code>GetUserRoles</code> 方法，来获取该用户以前具有的角色信息。</p>
<p>在对用户进行分配角色的时候，我们是先将用户以前具有的角色删除。这里通过<code>Clear</code>方法做了删除的标记。</p>
<p>然后，判断一下传递过来的角色编号数量是否是1，并且值是0，如果该条件成立，有两种可能</p>
<p>第一：什么角色也没有选，直接单击了确定按钮（所有的复选框都没有选中）</p>
<p>第二：把用户以前具有的角色都取消了，然后单击了确定按钮。</p>
<p>不管以上那种情况，这里我们都做了删除标记，即使第一种情况，进行删除操作也不会出错。</p>
<p>下面根据传递过来的角色编号，获取到每个角色信息，添加到<code>userInfo.RoleInfos</code>这个集合中。</p>
<p>第五：控制器实现</p>
<p>在<code>UsersController</code>控制器中添加<code>SetUserRoles</code>方法，注意指定的路由规则</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"> [<span class="meta">HttpPost(<span class="string">&quot;&#123;id&#125;/roles/&#123;roleIds&#125;&quot;</span>)</span>]</span><br><span class="line">        [<span class="meta">UnitOfWork(new Type[</span>] &#123; <span class="keyword">typeof</span>(MyDbContext) &#125;)]</span><br><span class="line">        [<span class="meta">Authorize</span>]</span><br><span class="line"><span class="comment">// 通过路由接收传递过来的用户编号与角色编号</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">SetUserRoles</span>(<span class="params">[FromRoute]<span class="built_in">int</span> id, [FromRoute] <span class="built_in">string</span> roleIds</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> userInfo = <span class="keyword">await</span> _userInfoService.LoadEntities(u =&gt; u.Id == id).FirstOrDefaultAsync();</span><br><span class="line">            <span class="keyword">if</span> (userInfo == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> BadRequest(<span class="string">&quot;没有查询到对应的用户&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            List&lt;<span class="built_in">long</span>&gt; list = <span class="keyword">new</span> List&lt;<span class="built_in">long</span>&gt;(); <span class="comment">// </span></span><br><span class="line">           <span class="comment">// roleIds是一个字符串，这里按照字符串进行分割，返回的是一个数组，然后遍历该数组，将其存储的每个角色编号转成成整型。</span></span><br><span class="line">            <span class="keyword">var</span> strIds = roleIds.Split(<span class="string">&#x27;,&#x27;</span>);</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> rId <span class="keyword">in</span> strIds)</span><br><span class="line">            &#123;</span><br><span class="line">                list.Add(Convert.ToInt32(rId));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 调用服务层中的SetUserRoles方法，完成用户角色的分配。</span></span><br><span class="line">            <span class="keyword">await</span> _userInfoService.SetUserRoles(userInfo,list);</span><br><span class="line">            </span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> Ok(<span class="keyword">new</span> ApiResult&lt;<span class="built_in">object</span>&gt; &#123; Success = <span class="literal">true</span>, Message = <span class="string">&quot;获取成功&quot;</span>&#125;);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>启动项目进行测试。</p>
<h2 id="八、权限管理模块"><a href="#八、权限管理模块" class="headerlink" title="八、权限管理模块"></a>八、权限管理模块</h2><p>现在已经为用户分配了角色，接下来需要做的就是给角色分配权限，这样用户就有相应的权限了。</p>
<p>在应用系统中，权限是以什么样的形式展现出来呢？对菜单的访问，页面上按钮的可见性，后端接口的控制，都要进行充分考虑.</p>
<p>前端菜单：根据是否有请求菜单权限进行动态加载</p>
<p>前端按钮（功能权限）：根据是否具有次权限进行按钮的显示与隐藏的控制</p>
<p>后端：前端发送请求到后端的接口，有必要对接口的访问进行权限的验证。</p>
<p>针对以上的需求，在设计中可以将菜单，按钮，后端<code>Api</code>请求作为资源，这样就构成了基于<code>RBAC</code>的另外一种授权模型(用户-角色-权限-资源)</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images%5C%E6%9D%83%E9%99%90%E8%AE%BE%E8%AE%A1.png"></p>
<p>针对以上权限模型，其中权限究竟是属于菜单，按钮，还是<code>API</code>的权限呢？那就需要在设计权限实体模型（数据库权限表）的时候添加类型加以区分，例如权限类型1是菜单，2是功能(按钮)，3是<code>api</code></p>
<h3 id="1、创建权限模型"><a href="#1、创建权限模型" class="headerlink" title="1、创建权限模型"></a>1、创建权限模型</h3><h5 id="1-1-基础模型创建"><a href="#1-1-基础模型创建" class="headerlink" title="1.1 基础模型创建"></a>1.1 基础模型创建</h5><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/images%5C%E6%9D%83%E9%99%90%E6%A8%A1%E5%9E%8B.png"></p>
<p>权限模型与角色模型是多对多的关系</p>
<p>权限模型与菜单权限，功能权限，<code>Api</code>权限都是一对一的关心，这里将不同的权限拆分到不同的模型（数据表）中的目的是为了方便扩展。</p>
<p>在<code>Cms.Entity</code>类库项目中先创建权限模型<code>PermissionInfo.cs</code></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.Entity</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 权限模型</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PermissionInfo</span>:<span class="title">BaseEntity</span>&lt;<span class="title">long</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 权限名称,如果是菜单权限，表示的就是菜单名称, 如果是按钮，表示的就是按钮的名称，如果是API,则表示API的名称</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? PermissionName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 权限类型:1为菜单，2为功能(按钮),3为API</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> PermissionType &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 权限编码，有响应的编码，就表示拥有该权限，这里主要用于前端路由权限的判断</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? PermissionCode &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 权限描述</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? PermissionDescription &#123; <span class="keyword">get</span>; <span class="keyword">set</span>;&#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 权限是有父子关系的，例如当单击某个菜单，呈现一个页面，页面中有按钮，单击按钮的时候会访问某个API</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 这样按钮，API,这些权限都是菜单的子权限。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> ParentId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>Api权限</code></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.Entity</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> API权限</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PermissionApi</span>:<span class="title">BaseEntity</span>&lt;<span class="title">long</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> API的地址</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? ApiUrl &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 请求类型</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? ApiMethod &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>菜单权限</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.Entity</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 菜单权限,菜单名称在PermissionInfo模型中已经声明了</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PermissionMenu</span>:<span class="title">BaseEntity</span>&lt;<span class="title">long</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 菜单图标</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? MenuIcon &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//排序</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? MenunOrder &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>功能权限</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.Entity</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 功能权限，就是对页面中的按钮进行控制</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PermissionPoint</span>:<span class="title">BaseEntity</span>&lt;<span class="title">long</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 按钮的样式</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? PointClass &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 按钮的图标</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? PointIcon &#123; <span class="keyword">get</span>; <span class="keyword">set</span>;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 按钮的状态</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> PointStatus &#123; <span class="keyword">get</span>; <span class="keyword">set</span>;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="1-2-配置权限模型关系"><a href="#1-2-配置权限模型关系" class="headerlink" title="1.2 配置权限模型关系"></a>1.2 配置权限模型关系</h5><p>先配置权限模型与角色模型之间的关系</p>
<p>在<code>PermissionInfo.cs</code>这个模型中添加了<code>RoleInfos</code>,表示一个权限有多个角色</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">string</span>? ParentId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 一个权限有多个角色</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> List&lt;RoleInfo&gt; RoleInfos &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; = <span class="keyword">new</span> List&lt;RoleInfo&gt;();</span><br></pre></td></tr></table></figure>

<p>在<code>RoleInfo.cs</code>中添加了<code>PermissionInfos</code>,表示一个角色有多个权限</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RoleInfo</span>:<span class="title">BaseEntity</span>&lt;<span class="title">long</span>&gt;</span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">string</span>? RoleName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">string</span>? Remark &#123; <span class="keyword">get</span>; <span class="keyword">set</span>;&#125;</span><br><span class="line">       <span class="keyword">public</span> List&lt;UserInfo&gt; UserInfos &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;=<span class="keyword">new</span> List&lt;UserInfo&gt;();</span><br><span class="line">       <span class="comment">//一个角色有多个权限</span></span><br><span class="line">       <span class="keyword">public</span> List&lt;PermissionInfo&gt;PermissionInfos &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; =<span class="keyword">new</span> List&lt;PermissionInfo&gt;();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>下面创建<code>PermissionInfoConfig.cs</code>配置类</p>
<p>代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PermissionInfoConfig</span> : <span class="title">IEntityTypeConfiguration</span>&lt;<span class="title">PermissionInfo</span>&gt;</span><br><span class="line">   &#123;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">EntityTypeBuilder&lt;PermissionInfo&gt; builder</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           builder.ToTable(<span class="string">&quot;T_PermissionInfos&quot;</span>);</span><br><span class="line">           builder.Property(x =&gt; x.PermissionName).HasMaxLength(<span class="number">20</span>).IsRequired();</span><br><span class="line">           builder.Property(x =&gt; x.PermissionCode).HasMaxLength(<span class="number">20</span>).IsRequired();</span><br><span class="line">           builder.Property(x =&gt; x.PermissionDescription).HasMaxLength(<span class="number">500</span>).IsRequired();</span><br><span class="line">           <span class="comment">// 中间表是T_RoleInfos_Permissions</span></span><br><span class="line">           builder.HasMany&lt;RoleInfo&gt;(s =&gt; s.RoleInfos).WithMany(s =&gt; s.PermissionInfos).UsingEntity(a =&gt; a.ToTable(<span class="string">&quot;T_RoleInfos_Permissions&quot;</span>));</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>在<code>MyDbContext</code>中添加<code>PermissionInfos</code>这个<code>DbSet</code></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyDbContext</span>:<span class="title">DbContext</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">public</span> DbSet&lt;UserInfo&gt;UserInfos &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="keyword">public</span> DbSet&lt;Department&gt; DepartmentInfos &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="keyword">public</span> DbSet&lt;RoleInfo&gt; RoleInfos &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;  </span><br><span class="line">    <span class="comment">// 添加了PermissionInfos</span></span><br><span class="line">       <span class="keyword">public</span> DbSet&lt;PermissionInfo&gt; PermissionInfos &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br></pre></td></tr></table></figure>

<p>以上是角色模型与权限模型关系的配置。</p>
<p>下面就是权限模型与菜单权限模型，功能权限模型，<code>Api</code>权限模型的配置。</p>
<p>继续修改<code>PermissionInfo.cs</code>模型中的代码</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">int</span> ParentId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span>----------------------- Api权限</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="keyword">public</span> PermissionApi? PermissionApi &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span>------------------ 菜单权限</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="keyword">public</span> PermissionMenu? PermissionMenu &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> ---------------------功能权限</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="keyword">public</span> PermissionPoint? PermissionPoint &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 一个权限有多个角色</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="keyword">public</span> List&lt;RoleInfo&gt; RoleInfos &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; = <span class="keyword">new</span> List&lt;RoleInfo&gt;();</span><br></pre></td></tr></table></figure>

<p>在上面的代码中添加了<code> Api权限,菜单权限,功能权限</code></p>
<p>修改<code>PermissionApi.cs</code>模型中的代码</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 请求类型</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? ApiMethod &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"><span class="comment">//-----------------添加了PermissionInfo</span></span><br><span class="line">        <span class="keyword">public</span> PermissionInfo? PermissionInfo &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"> <span class="comment">//---------------显式的指定外键</span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">long</span> PermissionId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br></pre></td></tr></table></figure>

<p><code>PermissionPoint.cs</code>模型中的代码</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 按钮的状态</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? PointStatus &#123; <span class="keyword">get</span>; <span class="keyword">set</span>;&#125;</span><br><span class="line"><span class="comment">//-----------------添加了PermissionInfo</span></span><br><span class="line">        <span class="keyword">public</span> PermissionInfo? PermissionInfo &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"> <span class="comment">//---------------显式的指定外键</span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">long</span> PermissionId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br></pre></td></tr></table></figure>

<p><code>PermissionMenu.cs</code>模型中的代码</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">        <span class="comment">//排序</span></span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">string</span>? MenunOrder &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"><span class="comment">//-----------------添加了PermissionInfo</span></span><br><span class="line">        <span class="keyword">public</span> PermissionInfo? PermissionInfo &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"> <span class="comment">//---------------显式的指定外键</span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">long</span> PermissionId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br></pre></td></tr></table></figure>

<p>下面还需要配置<code>PermissionInfoConfig.cs</code>模型，与上面三个模型一对一的关心（当然，在以上三个模型中进行配置也可以）</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">EntityTypeBuilder&lt;PermissionInfo&gt; builder</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            builder.ToTable(<span class="string">&quot;T_PermissionInfos&quot;</span>);</span><br><span class="line">            builder.Property(x =&gt; x.PermissionName).HasMaxLength(<span class="number">20</span>).IsRequired();</span><br><span class="line">            builder.Property(x =&gt; x.PermissionCode).HasMaxLength(<span class="number">20</span>).IsRequired();</span><br><span class="line">            builder.Property(x =&gt; x.PermissionDescription).HasMaxLength(<span class="number">500</span>).IsRequired();</span><br><span class="line">            <span class="comment">// 中间表是T_RoleInfos_Permissions</span></span><br><span class="line">            builder.HasMany&lt;RoleInfo&gt;(s =&gt; s.RoleInfos).WithMany(s =&gt; s.PermissionInfos).UsingEntity(a =&gt; a.ToTable(<span class="string">&quot;T_RoleInfos_Permissions&quot;</span>));</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 配置一对一的关系</span></span><br><span class="line">            builder.HasOne&lt;PermissionApi&gt;(p =&gt; p.PermissionApi).WithOne(p =&gt; p.PermissionInfo).HasForeignKey&lt;PermissionApi&gt;(d =&gt; d.PermissionId);</span><br><span class="line"></span><br><span class="line">            builder.HasOne&lt;PermissionMenu&gt;(p =&gt; p.PermissionMenu).WithOne(p =&gt; p.PermissionInfo).HasForeignKey&lt;PermissionMenu&gt;(d =&gt; d.PermissionId);</span><br><span class="line"></span><br><span class="line">            builder.HasOne&lt;PermissionPoint&gt;(p =&gt; p.PermissionPoint).WithOne(p =&gt; p.PermissionInfo).HasForeignKey&lt;PermissionPoint&gt;(d =&gt; d.PermissionId);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>



<p>下面创建<code>PermissionApiConfig.cs</code></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PermissionApiConfig</span> : <span class="title">IEntityTypeConfiguration</span>&lt;<span class="title">PermissionApi</span>&gt;</span><br><span class="line">   &#123;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">EntityTypeBuilder&lt;PermissionApi&gt; builder</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           builder.ToTable(<span class="string">&quot;T_PermissionApis&quot;</span>);</span><br><span class="line">           builder.Property(x =&gt; x.ApiUrl).HasMaxLength(<span class="number">200</span>).IsRequired();</span><br><span class="line">           builder.Property(x =&gt; x.ApiMethod).HasMaxLength(<span class="number">20</span>).IsRequired();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>下面创建<code>PermissionMenuConfig.cs</code></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PermissionMenuConfig</span> : <span class="title">IEntityTypeConfiguration</span>&lt;<span class="title">PermissionMenu</span>&gt;</span><br><span class="line">   &#123;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">EntityTypeBuilder&lt;PermissionMenu&gt; builder</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           builder.ToTable(<span class="string">&quot;T_PermissionMenus&quot;</span>);</span><br><span class="line">           builder.Property(x =&gt; x.MenuIcon).HasMaxLength(<span class="number">200</span>);</span><br><span class="line">           builder.Property(x =&gt; x.MenunOrder).HasMaxLength(<span class="number">20</span>);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>下面创建<code>PermissionPointConfig.cs</code></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PermissionPointConfig</span> : <span class="title">IEntityTypeConfiguration</span>&lt;<span class="title">PermissionPoint</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">EntityTypeBuilder&lt;PermissionPoint&gt; builder</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            builder.ToTable(<span class="string">&quot;T_PermissionPoints&quot;</span>);</span><br><span class="line">            builder.Property(x =&gt; x.PointClass).HasMaxLength(<span class="number">200</span>);</span><br><span class="line">            builder.Property(x =&gt; x.PointIcon).HasMaxLength(<span class="number">20</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>下面还需要修改<code>MyDbContext.cs</code>文件中的代码</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyDbContext</span>:<span class="title">DbContext</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">public</span> DbSet&lt;UserInfo&gt;UserInfos &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="keyword">public</span> DbSet&lt;Department&gt; DepartmentInfos &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="keyword">public</span> DbSet&lt;RoleInfo&gt; RoleInfos &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;  </span><br><span class="line">       <span class="keyword">public</span> DbSet&lt;PermissionInfo&gt; PermissionInfos &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment">// 添加如下三个对应的Dbset</span></span><br><span class="line">       <span class="keyword">public</span> DbSet&lt;PermissionApi&gt; PermissionApiInfos &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">public</span> DbSet&lt;PermissionMenu&gt; PermissionMenuInfos &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">public</span> DbSet&lt;PermissionPoint&gt; PermissionPointInfos &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br></pre></td></tr></table></figure>



<p>最后进行数据的迁移</p>
<p>在<code>[程序包管理器控制台]</code>中一定要选择<code>[Cms.EntityFrameworkCore]</code>这个项目</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Add-Migration AddPermission</span><br><span class="line">Update-database</span><br></pre></td></tr></table></figure>

<h3 id="2、添加权限"><a href="#2、添加权限" class="headerlink" title="2、添加权限"></a>2、添加权限</h3><h4 id="2-1-添加权限接口创建"><a href="#2-1-添加权限接口创建" class="headerlink" title="2.1   添加权限接口创建"></a>2.1   添加权限接口创建</h4><p> <strong>第一：先实现所有的数据仓储</strong></p>
<p>定义权限数据仓储接口，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.IRepository</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IPermissionInfoRepository</span>:<span class="title">IBaseRepository</span>&lt;<span class="title">PermissionInfo</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定义权限数据仓储实现类，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.Repository</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PermissionInfoRepository</span>:<span class="title">BaseRepository</span>&lt;<span class="title">PermissionInfo</span>&gt;,<span class="title">IPermissionInfoRepository</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">PermissionInfoRepository</span>(<span class="params">MyDbContext context</span>) : <span class="title">base</span>(<span class="params">context</span>)</span> &#123; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>定义<code>菜单权限</code>数据仓储接口，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.IRepository</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IPermissionMenuRepository</span>:<span class="title">IBaseRepository</span>&lt;<span class="title">PermissionMenu</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>菜单权限</code>数据仓储具体实现，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.Repository</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PermissionMenuRepository</span>:<span class="title">BaseRepository</span>&lt;<span class="title">PermissionMenu</span>&gt;,<span class="title">IPermissionMenuRepository</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">PermissionMenuRepository</span>(<span class="params">MyDbContext context</span>) : <span class="title">base</span>(<span class="params">context</span>)</span> &#123; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>Api</code>权限数据仓储接口</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.IRepository</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IPermissionApiRepository</span>:<span class="title">IBaseRepository</span>&lt;<span class="title">PermissionApi</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>Api</code>权限数据仓储具体实现，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.Repository</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PermissionApiRepository</span>:<span class="title">BaseRepository</span>&lt;<span class="title">PermissionApi</span>&gt;, <span class="title">IPermissionApiRepository</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">PermissionApiRepository</span>(<span class="params">MyDbContext context</span>) : <span class="title">base</span>(<span class="params">context</span>)</span> &#123; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>功能</code>权限数据仓储接口实现，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.IRepository</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IPermissionPointRepository</span>:<span class="title">IBaseRepository</span>&lt;<span class="title">PermissionPoint</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>功能权限</code>数据仓储具体实现</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.Repository</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PermissionPointRepository</span>:<span class="title">BaseRepository</span>&lt;<span class="title">PermissionPoint</span>&gt;, <span class="title">IPermissionPointRepository</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">PermissionPointRepository</span>(<span class="params">MyDbContext context</span>) : <span class="title">base</span>(<span class="params">context</span>)</span> &#123; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>第二：权限服务创建</strong></p>
<p>实现权限服务的接口</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.IService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IPermissionInfoService</span>:<span class="title">IBaseService</span>&lt;<span class="title">PermissionInfo</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面是权限服务的具体实现类</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.Service</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PermissionInfoService</span>:<span class="title">BaseService</span>&lt;<span class="title">PermissionInfo</span>&gt;, <span class="title">IPermissionInfoService</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IPermissionInfoRepository _permissionInfoRepository;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">PermissionInfoService</span>(<span class="params">IPermissionInfoRepository permissionInfoRepository</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">base</span>.repository = permissionInfoRepository;</span><br><span class="line">            _permissionInfoRepository = permissionInfoRepository;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>针对其他权限的服务，如果需要再进行创建。</p>
<p>下面来实现具体的业务</p>
<p>在保存权限信息的时候，我们需要对权限的类别进行判断，所以这里需要再创建一个枚举类型。</p>
<p>在<code>Cms.Entity</code>项目的<code>Enum</code>目录下面创建<code>PermissionTypeEnum.cs</code>文件，该文件中的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.Entity.Enum</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">enum</span> PermissionTypeEnum</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 菜单权限</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        PermissionMenu =<span class="number">1</span>,</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 功能权限</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        PermissionPoint =<span class="number">2</span>,</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Api权限</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        PermissionApi =<span class="number">3</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面还需要定义一个保存权限信息的接口，所以需要修改<code>IPermissionInfoService.cs</code>这个业务接口中的代码，需要添加如下方法：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.IService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IPermissionInfoService</span>:<span class="title">IBaseService</span>&lt;<span class="title">PermissionInfo</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">         <span class="function">Task&lt;<span class="built_in">bool</span>&gt; <span class="title">AddPermission</span>(<span class="params">PermissionDto permissionDto</span>)</span>; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里我们需要一个<code>PermissionDto</code>类来接收前端传递过来的权限信息，在<code>Cms.Entity</code>这个类库项目中创建<code>Permission</code>文件夹，在该文件夹中创建<code>PermissionDto.cs</code>类</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.Entity.Permission</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PermissionDto</span>:<span class="title">BaseEntity</span>&lt;<span class="title">long</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 权限名称,如果是菜单权限，表示的就是菜单名称, 如果是按钮，表示的就是按钮的名称，如果是API,则表示API的名称</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? PermissionName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 权限类型:1为菜单，2为功能(按钮),3为API</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> PermissionType &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 权限编码，有响应的编码，就表示拥有该权限，当然，这里也可以使用主键id作为权限编码</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? PermissionCode &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 权限描述</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? PermissionDescription &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 权限是有父子关系的，例如当单击某个菜单，呈现一个页面，页面中有按钮，单击按钮的时候会访问某个API</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 这样按钮，API,这些权限都是菜单的子权限。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> ParentId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> API的地址</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? ApiUrl &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 请求类型</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? ApiMethod &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 菜单图标</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? MenuIcon &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//排序</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? MenunOrder &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 按钮的样式</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? PointClass &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 按钮的图标</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? PointIcon &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 按钮的状态</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span>? PointStatus &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这个类中定义的属性都是需要保存的权限信息。</p>
<p>下面我们要在具体的业务类<code>PermissionInfoService.cs</code>中实现前面接口所以定义的<code>AddPermission</code>这个方法，代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PermissionInfoService</span>:<span class="title">BaseService</span>&lt;<span class="title">PermissionInfo</span>&gt;, <span class="title">IPermissionInfoService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 下面需要注入多个数据仓储来完成不同类别的权限信息的保存</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> IPermissionInfoRepository _permissionInfoRepository;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> IPermissionMenuRepository _permissionMenuRepository;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> IPermissionApiRepository _permissionApiRepository;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> IPermissionPointRepository _permissionPointRepository;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PermissionInfoService</span>(<span class="params">IPermissionInfoRepository permissionInfoRepository, IPermissionMenuRepository permissionMenuRepository, IPermissionApiRepository permissionApiRepository, IPermissionPointRepository permissionPointRepository</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.repository = permissionInfoRepository;</span><br><span class="line">        _permissionInfoRepository = permissionInfoRepository;</span><br><span class="line">        _permissionMenuRepository = permissionMenuRepository;</span><br><span class="line">        _permissionApiRepository = permissionApiRepository;</span><br><span class="line">        _permissionPointRepository = permissionPointRepository;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 添加权限</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;permissionDto&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;NotImplementedException&quot;&gt;</span><span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Task&lt;<span class="built_in">bool</span>&gt; <span class="title">AddPermission</span>(<span class="params">PermissionDto permissionDto</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 创建基础权限模型对象</span></span><br><span class="line">       PermissionInfo permissionInfo = <span class="keyword">new</span> PermissionInfo();</span><br><span class="line">        permissionInfo.ParentId = permissionDto.ParentId;</span><br><span class="line">        permissionInfo.PermissionCode = permissionDto.PermissionCode;</span><br><span class="line">        permissionInfo.PermissionName = permissionDto.PermissionName;</span><br><span class="line">        permissionInfo.PermissionType=permissionDto.PermissionType;</span><br><span class="line">        permissionInfo.PermissionDescription=permissionDto.PermissionDescription;</span><br><span class="line">        permissionInfo.CreateTime=DateTime.Now;</span><br><span class="line">        permissionInfo.UpdateTime=DateTime.Now;</span><br><span class="line">        permissionInfo.DelFlag=Convert.ToBoolean(DelFlagEnum.Normal);</span><br><span class="line">        _permissionInfoRepository.InsertEntityAsync(permissionInfo); <span class="comment">// 注意：这里需要对PermissionInfo这个基础权限模型的信息进行保存</span></span><br><span class="line">        <span class="built_in">bool</span> result = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">switch</span> (permissionInfo.PermissionType)</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="comment">// 判断是否是菜单权限</span></span><br><span class="line">            <span class="keyword">case</span> (<span class="built_in">int</span>)PermissionTypeEnum.PermissionMenu:</span><br><span class="line">                <span class="comment">// 创建菜单权限模型对象</span></span><br><span class="line">                PermissionMenu permissionMenu = <span class="keyword">new</span> PermissionMenu();</span><br><span class="line">                permissionMenu.MenuIcon = permissionDto.MenuIcon;</span><br><span class="line">                permissionMenu.MenunOrder = permissionDto.MenunOrder;</span><br><span class="line">                permissionMenu.CreateTime = DateTime.Now;</span><br><span class="line">                permissionMenu.UpdateTime = DateTime.Now;</span><br><span class="line">                permissionMenu.DelFlag = Convert.ToBoolean(DelFlagEnum.Normal);</span><br><span class="line">                <span class="comment">// 这里需要把基础permissionInfo模型对象赋值给permissionMenu中的PermissionInfo，才能完成一对一的操作</span></span><br><span class="line">                permissionMenu.PermissionInfo = permissionInfo;</span><br><span class="line">                <span class="comment">// 把菜单权限模型对象添加到DbContext中</span></span><br><span class="line">                <span class="keyword">this</span>._permissionMenuRepository.InsertEntityAsync(permissionMenu);</span><br><span class="line">                result = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                <span class="comment">// 功能权限的判断</span></span><br><span class="line">            <span class="keyword">case</span> (<span class="built_in">int</span>)PermissionTypeEnum.PermissionPoint: </span><br><span class="line"><span class="comment">// 创建功能权限模型对象</span></span><br><span class="line">                PermissionPoint point = <span class="keyword">new</span> PermissionPoint();</span><br><span class="line">                point.PointClass=permissionDto.PointClass;</span><br><span class="line">                point.PointIcon=permissionDto.PointIcon;</span><br><span class="line">                point.PointStatus=permissionDto.PointStatus;</span><br><span class="line">                point.CreateTime = DateTime.Now;</span><br><span class="line">                point.UpdateTime = DateTime.Now;   </span><br><span class="line">                point.DelFlag = Convert.ToBoolean(DelFlagEnum.Normal);</span><br><span class="line">                point.PermissionInfo = permissionInfo; <span class="comment">// 注意</span></span><br><span class="line">                <span class="keyword">this</span>._permissionPointRepository.InsertEntityAsync(point); <span class="comment">// 注意</span></span><br><span class="line">                result = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                <span class="comment">// 判断是否是Api权限</span></span><br><span class="line">            <span class="keyword">case</span> (<span class="built_in">int</span>)PermissionTypeEnum.PermissionApi: </span><br><span class="line">                <span class="comment">// 创建Api权限模型对象</span></span><br><span class="line">                PermissionApi permissionApi = <span class="keyword">new</span> PermissionApi();</span><br><span class="line">                permissionApi.ApiMethod = permissionDto.ApiMethod;</span><br><span class="line">                permissionApi.ApiUrl = permissionDto.ApiUrl;</span><br><span class="line">                permissionApi.CreateTime = DateTime.Now;</span><br><span class="line">                permissionApi.UpdateTime = DateTime.Now;</span><br><span class="line">                permissionApi.DelFlag = Convert.ToBoolean(DelFlagEnum.Normal);</span><br><span class="line">                permissionApi.PermissionInfo = permissionInfo;  <span class="comment">// 注意</span></span><br><span class="line">                <span class="keyword">this</span>._permissionApiRepository.InsertEntityAsync(permissionApi); <span class="comment">// 注意</span></span><br><span class="line">                result = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="literal">default</span>:</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Task.FromResult(result);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在以上的操作中，我们没有使用<code>AutoMapper</code>进行自动映射，这里是进行了手动的映射，相对来讲比较麻烦一下，但是需要大家理解整个原理。</p>
<p>下面实现具体的控制。</p>
<p>创建<code>PermissionsController.cs</code>控制器，该控制器中的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[<span class="meta">Route(<span class="string">&quot;api/[controller]&quot;</span>)</span>]</span><br><span class="line">[<span class="meta">ApiController</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PermissionsController</span> : <span class="title">ControllerBase</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//注入权限的服务对象</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> IPermissionInfoService _permissionInfoService;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PermissionsController</span>(<span class="params">IPermissionInfoService permissionInfoService</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">this</span>._permissionInfoService = permissionInfoService;</span><br><span class="line">    &#125;</span><br><span class="line">    [<span class="meta">HttpPost</span>]</span><br><span class="line">    [<span class="meta">Authorize</span>] <span class="comment">// 这里可以先不添加该特性，在swagger/index.html页面中测试该接口</span></span><br><span class="line">    [<span class="meta">UnitOfWork(new Type[</span>] &#123; <span class="keyword">typeof</span>(MyDbContext) &#125;)]</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> <span class="title">Task</span>&lt;<span class="title">IActionResult</span>&gt; <span class="title">AddPermissions</span>(<span class="params">[FromBody]PermissionDto permissionDto</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 调用服务层中的AddPermission方法完成权限信息的保存</span></span><br><span class="line">       <span class="keyword">await</span> <span class="keyword">this</span>._permissionInfoService.AddPermission(permissionDto);</span><br><span class="line">        <span class="keyword">return</span> Ok(<span class="keyword">new</span> ApiResult&lt;<span class="built_in">object</span>&gt;() &#123;Message=<span class="string">&quot;添加权限成功&quot;</span>,Success=<span class="literal">true</span> &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面返回到浏览器中，在<code>swagger/index.html</code>页面中测试该添加权限的接口。</p>
<h3 id="3、权限列表"><a href="#3、权限列表" class="headerlink" title="3、权限列表"></a>3、权限列表</h3><h4 id="3-1-权限列表接口创建"><a href="#3-1-权限列表接口创建" class="headerlink" title="3.1  权限列表接口创建"></a>3.1  权限列表接口创建</h4><p>这里我们先来构建权限列表展示的接口，后面再来考虑前端的设计。</p>
<p>这里也需要对权限的信息进行搜索，所以在<code>Cms.Entity</code>类库项目中的<code>Search</code>文件夹中创建<code>PermissionSearch.cs</code>类，该类中的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.Entity.Search</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PermissionSearch</span>:<span class="title">BaseSearch</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? PermissionName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? PermissionDescription &#123; <span class="keyword">get</span>;<span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>下面在权限业务的接口中定义获取权限列表的方法，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.IService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IPermissionInfoService</span>:<span class="title">IBaseService</span>&lt;<span class="title">PermissionInfo</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">         <span class="function">Task&lt;<span class="built_in">bool</span>&gt; <span class="title">AddPermission</span>(<span class="params">PermissionDto permissionDto</span>)</span>;</span><br><span class="line">        <span class="comment">// 获取权限列表</span></span><br><span class="line">        <span class="function">IQueryable&lt;PermissionInfo&gt; <span class="title">LoadSearchEntities</span>(<span class="params">PermissionSearch permissionSearch, <span class="built_in">bool</span> delFlag</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>下面要实现上面定义的<code>LoadSearchEntities</code>这个方法。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 获取权限列表信息</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;permissionSearch&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;delFlag&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;NotImplementedException&quot;&gt;</span><span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> IQueryable&lt;PermissionInfo&gt; <span class="title">LoadSearchEntities</span>(<span class="params">PermissionSearch permissionSearch, <span class="built_in">bool</span> delFlag</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">                        <span class="comment">// 这里我们要查询的表是T_PermissionPoints，因为该表中保存了权限的基础信息，其他资源权限表这里就不用查询</span></span><br><span class="line">            <span class="keyword">var</span> temp = _permissionInfoRepository.LoadEntities(u =&gt; u.DelFlag == delFlag);</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrWhiteSpace(permissionSearch.PermissionName))</span><br><span class="line">            &#123;</span><br><span class="line">                temp = temp.Where&lt;PermissionInfo&gt;(u =&gt; u.PermissionName!.Contains(permissionSearch.PermissionName));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrWhiteSpace(permissionSearch.PermissionDescription))</span><br><span class="line">            &#123;</span><br><span class="line">                temp = temp.Where&lt;PermissionInfo&gt;(u =&gt; u.PermissionDescription!.Contains(permissionSearch.PermissionDescription));</span><br><span class="line">            &#125;</span><br><span class="line">            permissionSearch.TotalCount = temp.Count();</span><br><span class="line">            <span class="keyword">if</span> (permissionSearch.Order)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> temp.OrderBy&lt;PermissionInfo, <span class="built_in">long</span>&gt;(u =&gt; u.Id).Skip&lt;PermissionInfo&gt;((permissionSearch.PageIndex - <span class="number">1</span>) * permissionSearch.PageSize).Take&lt;PermissionInfo&gt;(permissionSearch.PageSize);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> temp.OrderByDescending&lt;PermissionInfo, <span class="built_in">long</span>&gt;(u =&gt; u.Id).Skip&lt;PermissionInfo&gt;((permissionSearch.PageIndex - <span class="number">1</span>) * permissionSearch.PageSize).Take&lt;PermissionInfo&gt;(permissionSearch.PageSize);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>这里，需要进行搜索，所以在<code>Cms.Entity</code> 这个类库项目中的<code>Search</code>文件夹中，创建<code>PermissionSearch.cs</code>类，该类的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.Entity.Search</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PermissionSearch</span>:<span class="title">BaseSearch</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? PermissionName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? PermissionDescription &#123; <span class="keyword">get</span>;<span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>下面需要控制器<code>PermissionsController.cs</code>中的代码，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">   [<span class="meta">HttpGet</span>]</span><br><span class="line"><span class="comment">// 这里需要构建搜索参数</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> IActionResult <span class="title">GetPermissions</span>(<span class="params">[FromQuery] PermissionParams permissionParams</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">int</span> totalCount = <span class="number">0</span>;</span><br><span class="line">            PermissionSearch permissionSearch = <span class="keyword">new</span> PermissionSearch()</span><br><span class="line">            &#123;</span><br><span class="line">                PermissionName = permissionParams.PermissionName,</span><br><span class="line">                PermissionDescription = permissionParams.PermissionDescription,</span><br><span class="line">            </span><br><span class="line">                Order = permissionParams.Order,</span><br><span class="line">                PageIndex = permissionParams.PageIndex,</span><br><span class="line">                PageSize = permissionParams.PageSize,</span><br><span class="line">                TotalCount = totalCount</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">var</span> permissionsList = _permissionInfoService.LoadSearchEntities(permissionSearch, Convert.ToBoolean(DelFlagEnum.Normal));</span><br><span class="line">            <span class="keyword">if</span> (permissionSearch.TotalCount &lt;= <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> NotFound(<span class="string">&quot;没有权限信息&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 返回前端需要展示的权限信息</span></span><br><span class="line">            <span class="keyword">var</span> permissions = permissionsList.Select(u =&gt; <span class="keyword">new</span> &#123; Id = u.Id, PermissionName = u.PermissionName, PermissionCode = u.PermissionCode, CreateTime = u.CreateTime, PermissionDescription= u.PermissionDescription,ParentId=u.ParentId, PermissionType=u.PermissionType &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> Ok(<span class="keyword">new</span> ApiResult&lt;<span class="built_in">object</span>&gt;() &#123; Success = <span class="literal">true</span>, Message = <span class="string">&quot;获取权限信息成功&quot;</span>, Data = <span class="keyword">new</span> &#123; rows = permissions, total = permissionSearch.TotalCount &#125; &#125;);</span><br><span class="line"></span><br><span class="line">            </span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>这里需要在<code>WebApi</code>项目中<code>ResourceParams</code>文件夹中创建<code>PermissionParams.cs</code>类来来接收搜索和分页的参数</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.WebApi.ResourceParams</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PermissionParams</span>:<span class="title">BaseParams</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? PermissionName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? PermissionDescription &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回到浏览器中对该接口进行测试。</p>
<p>注意：前端展示的时候，只需要展示菜单权限和功能权限的信息就可以了，不需要展示<code>Api</code>的权限，所以在服务的<code>LoadSearchEntities</code>方法中，我们进行过滤的时候，可以在添加如下的过滤条件。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IQueryable&lt;PermissionInfo&gt; <span class="title">LoadSearchEntities</span>(<span class="params">PermissionSearch permissionSearch, <span class="built_in">bool</span> delFlag</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">    <span class="comment">//以下过滤权限的时候，有添加了过滤的条件，注意小括号的使用</span></span><br><span class="line">           <span class="keyword">var</span> temp = _permissionInfoRepository.LoadEntities(u =&gt; u.DelFlag == delFlag&amp;&amp;(u.PermissionType==Convert.ToInt32(PermissionTypeEnum.PermissionMenu) ||u.PermissionType==Convert.ToInt32(PermissionTypeEnum.PermissionPoint)));</span><br></pre></td></tr></table></figure>



<h4 id="3-2-权限列表前端展示"><a href="#3-2-权限列表前端展示" class="headerlink" title="3.2  权限列表前端展示"></a>3.2  权限列表前端展示</h4><p><strong>定义路由规则</strong></p>
<p>在<code>router/modules</code>目录下面创建<code>permission.js</code>文件，该文件中的代码如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导出权限的路由规则</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Layout</span> <span class="keyword">from</span> <span class="string">&quot;@/layout&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">path</span>: <span class="string">&quot;/permissions&quot;</span>, <span class="comment">// 路由地址</span></span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;permissions&quot;</span>, <span class="comment">// 给模块的一级路由设置一个name属性，后面设置权限的时候会使用到（注意这里如果只是给父级添加name属性在浏览器的控制台中会给出警告信息，为了解决这个问题，也需要在下面的子路由中添加name，当然这里可以先暂时的将name属性去掉，后面讲解到权限的时候在添加）</span></span><br><span class="line">    <span class="comment">// 都采用了Layout组件中的布局</span></span><br><span class="line">  <span class="attr">component</span>: <span class="title class_">Layout</span>,</span><br><span class="line">  <span class="attr">children</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">path</span>: <span class="string">&quot;&quot;</span>, <span class="comment">// 这里写成一个空字符串，当访问的地址是`/permission`的时候，不但会展示layout布局页面，而会展示下面component中指定的页面</span></span><br><span class="line">      <span class="attr">name</span>:<span class="string">&#x27;permissionsChild&#x27;</span>,</span><br><span class="line">      <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&quot;@/views/permissions&quot;</span>),</span><br><span class="line">      <span class="comment">// 路由元信息，可以存储任何的数据</span></span><br><span class="line">      <span class="attr">meta</span>: &#123;</span><br><span class="line">        <span class="attr">title</span>: <span class="string">&quot;权限管理&quot;</span>, <span class="comment">// 这里保存的是title,目的：会读取作该属性作为左侧的菜单项。</span></span><br><span class="line">        <span class="attr">icon</span>:<span class="string">&quot;lock&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>在<code>router/index.js</code>文件中，添加以上的路由规则对象。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> roleRouter <span class="keyword">from</span> <span class="string">&#x27;./modules/roleInfo&#x27;</span></span><br><span class="line"><span class="keyword">import</span> permissionRouter <span class="keyword">from</span> <span class="string">&#x27;./modules/permission&#x27;</span> <span class="comment">// 导入permissionRouter</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 动态路由</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> asyncRoutes =[</span><br><span class="line">  employeesRouter,</span><br><span class="line">  departmentsRouter,</span><br><span class="line">  roleRouter,</span><br><span class="line">  permissionRouter <span class="comment">// 添加permissionRouter</span></span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<p>下面在<code>views</code>目录下面创建<code>permissions</code>文件夹，在该文件夹中创建<code>index.vue</code>组件，</p>
<p>该组件的初步代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    权限列表</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>

<p>返回到浏览器中进行查看。</p>
<p>对<code>index.vue</code>这个组件，做一个简单的布局，如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">   &lt;div class=&quot;dashboard-container&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;app-container&quot;&gt;</span><br><span class="line">        &lt;!-- 靠右的按钮 ,这里使用了前面封装的公共组件PageTools--&gt;</span><br><span class="line">        &lt;PageTools&gt;</span><br><span class="line">            &lt;template  #after &gt; &lt;!--使用插槽--&gt;</span><br><span class="line">            &lt;el-button type=&quot;primary&quot; size=&quot;small&quot; &gt;添加权限&lt;/el-button&gt;</span><br><span class="line">            &lt;/template&gt;</span><br><span class="line">        &lt;/PageTools&gt;</span><br><span class="line">        &lt;!-- 表格 --&gt;</span><br><span class="line">        &lt;el-table border&gt;</span><br><span class="line">            &lt;el-table-column align=&quot;center&quot; label=&quot;权限名称&quot;&gt;&lt;/el-table-column&gt;</span><br><span class="line">            &lt;el-table-column align=&quot;center&quot; label=&quot;权限标识&quot;&gt;&lt;/el-table-column&gt;</span><br><span class="line">            &lt;el-table-column align=&quot;center&quot; label=&quot;权限描述&quot;&gt;&lt;/el-table-column&gt;</span><br><span class="line">            &lt;el-table-column align=&quot;center&quot; label=&quot;操作&quot;&gt;</span><br><span class="line">                &lt;template #default=&quot;scope&quot;&gt;</span><br><span class="line">                    &lt;el-button&gt;添加&lt;/el-button&gt;</span><br><span class="line">                    &lt;el-button&gt;编辑&lt;/el-button&gt;</span><br><span class="line">                    &lt;el-button&gt;删除&lt;/el-button&gt;</span><br><span class="line">                &lt;/template&gt;</span><br><span class="line">            &lt;/el-table-column&gt;</span><br><span class="line">        &lt;/el-table&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">   &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>

<p>创建请求的方法。</p>
<p>在<code>src/api</code>目录下面创建<code>permission.js</code>文件，添加如下代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> request <span class="keyword">from</span> <span class="string">&#x27;@/utils/request&#x27;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getPermissionList</span>(<span class="params">params</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">request</span>(&#123;</span><br><span class="line">        <span class="attr">url</span>:<span class="string">&#x27;/permissions&#x27;</span>,</span><br><span class="line">        params</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改<code>views/permissions/index.vue</code>组件中的代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">import</span> &#123;onMounted, ref&#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123;getPermissionList&#125; <span class="keyword">from</span> <span class="string">&#x27;@/api/permission&#x27;</span> <span class="comment">// 导入getPermissionList方法</span></span><br><span class="line"> <span class="keyword">export</span> <span class="keyword">default</span>&#123;</span><br><span class="line">    <span class="attr">name</span>:<span class="string">&#x27;Permission&#x27;</span>,</span><br><span class="line">    <span class="title function_">setup</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> list=<span class="title function_">ref</span>([]);</span><br><span class="line">        <span class="keyword">const</span> loading = <span class="title function_">ref</span>(<span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">const</span> page = <span class="title function_">ref</span>(&#123;</span><br><span class="line">      <span class="title class_">PageIndex</span>: <span class="number">1</span>, <span class="comment">// 当前页码</span></span><br><span class="line">      <span class="title class_">PageSize</span>: <span class="number">12</span>, <span class="comment">// 每页显示的记录数，这里服务端要求是PageSize</span></span><br><span class="line">      <span class="attr">total</span>:<span class="number">0</span></span><br><span class="line">    &#125;);</span><br><span class="line">        <span class="title function_">onMounted</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">            <span class="title function_">loadPermissionsList</span>();</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">const</span> <span class="title function_">loadPermissionsList</span>=<span class="keyword">async</span>(<span class="params"></span>)=&gt;&#123;</span><br><span class="line">            loading.<span class="property">value</span> = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">const</span> &#123; rows, total &#125; = <span class="keyword">await</span> <span class="title function_">getPermissionList</span>(page.<span class="property">value</span>);</span><br><span class="line">            list.<span class="property">value</span> = rows;</span><br><span class="line">            page.<span class="property">value</span>.<span class="property">total</span> = total;</span><br><span class="line">            loading.<span class="property">value</span> = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">          <span class="comment">// 实现分页</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleCurrentChange</span>=(<span class="params">value</span>)=&gt;&#123;</span><br><span class="line">      page.<span class="property">value</span>.<span class="property">PageIndex</span> = value;</span><br><span class="line">      <span class="title function_">loadPermissionsList</span>();</span><br><span class="line">    &#125;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            list,</span><br><span class="line">            page,</span><br><span class="line">            handleCurrentChange</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>继续修改模版中的代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 表格 --&gt;</span><br><span class="line">       &lt;el-table border :data=&quot;list&quot;&gt; &lt;!--把返回的list赋值给data属性，作为表格的数据源--&gt;</span><br><span class="line">           &lt;!--通过prop属性指定要渲染的属性名--&gt;</span><br><span class="line">           &lt;el-table-column align=&quot;center&quot; label=&quot;权限名称&quot; prop=&quot;permissionName&quot;&gt;&lt;/el-table-column&gt;</span><br><span class="line">           &lt;el-table-column align=&quot;center&quot; label=&quot;权限标识&quot; prop=&quot;permissionCode&quot;&gt;&lt;/el-table-column&gt;</span><br><span class="line">           &lt;el-table-column align=&quot;center&quot; label=&quot;权限描述&quot; prop=&quot;permissionDescription&quot;&gt;&lt;/el-table-column&gt;</span><br><span class="line">           &lt;el-table-column align=&quot;center&quot; label=&quot;操作&quot;&gt;</span><br><span class="line">               &lt;template  #default=&quot;scope&quot;&gt;</span><br><span class="line">                   &lt;el-button size=&quot;small&quot;&gt;添加&lt;/el-button&gt;</span><br><span class="line">                   &lt;el-button  size=&quot;small&quot;&gt;编辑&lt;/el-button&gt;</span><br><span class="line">                   &lt;el-button  size=&quot;small&quot;&gt;删除&lt;/el-button&gt;</span><br><span class="line">               &lt;/template&gt;</span><br><span class="line">           &lt;/el-table-column&gt;</span><br><span class="line">       &lt;/el-table&gt;</span><br><span class="line">        &lt;!-- 分页组件 --&gt;</span><br><span class="line">        &lt;el-row</span><br><span class="line">         type=&quot;flex&quot;</span><br><span class="line">         justify=&quot;center&quot;</span><br><span class="line">         align=&quot;middle&quot;</span><br><span class="line">         style=&quot;height: 60px&quot;</span><br><span class="line">       &gt;</span><br><span class="line">         &lt;el-pagination</span><br><span class="line">           layout=&quot;prev, pager, next&quot;</span><br><span class="line">           :total=&quot;page.total&quot;</span><br><span class="line">           :page-size=&quot;page.PageSize&quot;</span><br><span class="line">           v-model:currentPage=&quot;page.PageIndex&quot;</span><br><span class="line">           @current-change=&quot;handleCurrentChange&quot;</span><br><span class="line">         /&gt;</span><br><span class="line">              &lt;/el-row&gt;    </span><br></pre></td></tr></table></figure>

<p>在上面的代码中，给表格指定了数据源，同时也添加了分页组件。</p>
<p>返回到浏览器中查看效果。</p>
<p>虽然，在表格中展示了权限的信息，但是，数据的展示没有呈现出树形结构。</p>
<p>我们知道，权限是有父子关系的，所以再进行展示的时候，最好是通过树形方式来进行展示。</p>
<p>在表格中怎样呈现出树形的结构呢？</p>
<p>参考文档：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://element-plus.gitee.io/zh-CN/component/table.html#%E6%A0%91%E5%BD%A2%E6%95%B0%E6%8D%AE%E4%B8%8E%E6%87%92%E5%8A%A0%E8%BD%BD</span><br></pre></td></tr></table></figure>

<p>通过文档，我们可以看到在使用树形表格的时候，需要注意两点</p>
<p>第一：服务端返回的数据如果包含了<code>children</code>属性，则会被当作树形数据，而我们这里服务端返回的数据中没有<code>children</code>,所以需要前端进行转换</p>
<p>第二：就是<code>table</code>表格中必须添加<code>row-key</code>属性，该属性的值是唯一的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 表格 --&gt;</span><br><span class="line">        &lt;el-table border :data=&quot;list&quot; row-key=&quot;id&quot;&gt;</span><br></pre></td></tr></table></figure>

<p>这里添加了<code>row-key</code>属性，取值是<code>id</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;getPermissionList&#125; <span class="keyword">from</span> <span class="string">&#x27;@/api/permission&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123;tranListToTreeData&#125; <span class="keyword">from</span> <span class="string">&#x27;@/utils/index&#x27;</span> <span class="comment">// 导入tranListToTreeData方法</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">loadPermissionsList</span>=<span class="keyword">async</span>(<span class="params"></span>)=&gt;&#123;</span><br><span class="line">            loading.<span class="property">value</span> = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">const</span> &#123; rows, total &#125; = <span class="keyword">await</span> <span class="title function_">getPermissionList</span>(page.<span class="property">value</span>);</span><br><span class="line">            list.<span class="property">value</span> =<span class="title function_">tranListToTreeData</span>(rows,<span class="number">0</span>); <span class="comment">// 使用tranListToTreeData方法将rows中存储的数据转换成树形结构，0表示的就是根节点的编号</span></span><br><span class="line">            page.<span class="property">value</span>.<span class="property">total</span> = total;</span><br><span class="line">            loading.<span class="property">value</span> = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>返回到浏览器中进行查看。</p>
<p>在这里，权限的展示，我们要求只展示两层，所以在第二层中，就不需要再出现<code>添加</code>按钮了。</p>
<p>修改<code>index.vue</code>组件，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;template  #default=&quot;scope&quot;&gt;</span><br><span class="line">                   &lt;el-button size=&quot;small&quot; v-if=&quot;scope.row.permissionType===1&quot;&gt;添加&lt;/el-button&gt;</span><br></pre></td></tr></table></figure>

<p>这里，我们添加了一个判断，就是判断返回的<code>permissionType</code>的值是否是1，如果是1，表示的就是菜单权限，所以才会出现<code>添加</code>按钮.</p>
<p>也就是说，功能权限不需要再添加对应的子权限了。</p>
<p>而功能权限实际上菜单权限的子权限。</p>
<h3 id="4、创建添加权限的窗口"><a href="#4、创建添加权限的窗口" class="headerlink" title="4、创建添加权限的窗口"></a>4、创建添加权限的窗口</h3><h4 id="4-1-基础表单创建"><a href="#4-1-基础表单创建" class="headerlink" title="4.1  基础表单创建"></a>4.1  基础表单创建</h4><p>修改<code>views/Permission/index.vue</code>这个组件中修改代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"> &lt;!-- 新增窗口 --&gt;</span><br><span class="line">    &lt;el-dialog title=&quot;新增权限&quot; v-model=&quot;showAddDialog&quot;&gt;</span><br><span class="line">      &lt;el-form label-width=&quot;120px&quot;&gt;</span><br><span class="line">        &lt;el-form-item label=&quot;名称&quot;&gt;</span><br><span class="line">          &lt;el-input v-model=&quot;formData.PermissionName&quot; style=&quot;width: 90%;&quot; /&gt;</span><br><span class="line">             &lt;/el-form-item&gt;</span><br><span class="line">      &lt;el-form-item label=&quot;标识&quot;&gt;</span><br><span class="line">        &lt;el-input v-model=&quot;formData.PermissionCode&quot; style=&quot;width: 90%;&quot; /&gt;</span><br><span class="line">      &lt;/el-form-item&gt;   </span><br><span class="line">      &lt;el-form-item label=&quot;描述&quot;&gt;</span><br><span class="line">        &lt;el-input v-model=&quot;formData.PermissionDescription&quot; style=&quot;width: 90%;&quot; /&gt;</span><br><span class="line">      &lt;/el-form-item&gt;  </span><br><span class="line">      &lt;/el-form&gt;</span><br><span class="line">      &lt;template #footer&gt;</span><br><span class="line">        &lt;el-row type=&quot;flex&quot; justify=&quot;center&quot;&gt;</span><br><span class="line">          &lt;el-col :span=&quot;6&quot;&gt;</span><br><span class="line">            &lt;el-button size=&quot;small&quot;&gt;确定&lt;/el-button&gt;</span><br><span class="line">            &lt;el-button type=&quot;primary&quot; size=&quot;small&quot;  @click=&quot;showAddDialog=false&quot;&gt;取消&lt;/el-button&gt;</span><br><span class="line">          &lt;/el-col&gt;</span><br><span class="line">        &lt;/el-row&gt;</span><br><span class="line">      &lt;/template&gt;</span><br><span class="line">    &lt;/el-dialog&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>

<p>这里创建一个<code>dialog</code>窗口，然后添加了<code>v-model</code>属性，该属性的值是<code>showAddDialog</code>，通过<code>shoAddDialog</code>控制窗口的显示与隐藏，</p>
<p>在<code>dialog</code>窗口中添加了<code>el-form</code>表单，表单元素通过<code>v-model</code>双向绑定了<code>formData</code>响应式对象中的相关属性。</p>
<p>在<code>setup</code>入口函数中定义<code>formData,showAddDialog</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> showAddDialog=<span class="title function_">ref</span>(<span class="literal">true</span>); <span class="comment">// 测试完，将该值修改为false,默认情况下窗口不会弹出来。</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> formData=<span class="title function_">reactive</span>(&#123;</span><br><span class="line">        <span class="title class_">PermissionName</span>:<span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="title class_">PermissionCode</span>:<span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="title class_">PermissionDescription</span>:<span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="title class_">PermissionType</span>:<span class="number">1</span>, <span class="comment">// 权限的类型</span></span><br><span class="line">        <span class="title class_">ParentId</span>:<span class="number">0</span>,   <span class="comment">// 因为是树形结构，所以添加的权限属于哪个节点下</span></span><br><span class="line">      &#125;)</span><br></pre></td></tr></table></figure>

<p>同时将其返回</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">           list,</span><br><span class="line">           page,</span><br><span class="line">           handleCurrentChange,</span><br><span class="line">        formData, <span class="comment">// 返回</span></span><br><span class="line">        showAddDialog <span class="comment">// 返回</span></span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>返回到浏览器中进行查看。</p>
<h4 id="4-2-完成权限的添加"><a href="#4-2-完成权限的添加" class="headerlink" title="4.2  完成权限的添加"></a>4.2  完成权限的添加</h4><p>第一步：给<code>添加权限</code>的按钮注册单击事件。</p>
<p>我们知道，权限列表页面的顶部有一个添加权限的按钮，单击该按钮，添加的是<code>菜单权限</code></p>
<p>而单击每一行中的<code>添加权限</code>的按钮，添加的权限是功能权限（按钮权限）</p>
<p>所以，单击不同按钮的时候，在所调用的方法中要进行判断。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;PageTools&gt;</span><br><span class="line">       &lt;template  #after &gt;</span><br><span class="line">       &lt;el-button type=&quot;primary&quot; size=&quot;small&quot; @click=&quot;addPermission(1，0)&quot; &gt;添加权限&lt;/el-button&gt;</span><br><span class="line">       &lt;/template&gt;</span><br><span class="line">   &lt;/PageTools&gt;</span><br></pre></td></tr></table></figure>

<p>以上是顶部按钮，在调用<code>addPermission</code>方法的时候，传递的参数是1，表示将要添加菜单权限。（在服务端我们规定了菜单权限对应的类别就是1），同时这里添加的是根权限，所以第二个参数是0。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;template  #default=&quot;scope&quot;&gt;</span><br><span class="line">                   &lt;el-button size=&quot;small&quot; @click=&quot;addPermission(2,scope.row.id)&quot;  v-if=&quot;scope.row.permissionType===1&quot;&gt;添加&lt;/el-button&gt;</span><br></pre></td></tr></table></figure>

<p>每行中的<code>添加</code>按钮触发后，调用的<code>addPermission</code>方法，传递的参数是2，表示添加的是功能权限。同时第二个参数，表示的是父<code>id</code>,</p>
<p>也就是当前所添加的权限是哪个权限的子权限。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 添加权限</span></span><br><span class="line">     <span class="keyword">const</span> <span class="title function_">addPermission</span>=(<span class="params">type,pid</span>)=&gt;&#123;</span><br><span class="line">         <span class="comment">// 弹出窗口</span></span><br><span class="line">      showAddDialog.<span class="property">value</span> = <span class="literal">true</span>;</span><br><span class="line">      <span class="comment">// 记录当前添加的权限的类型与父编号</span></span><br><span class="line">      formData.<span class="property">PermissionType</span> = type;</span><br><span class="line">      formData.<span class="property">ParentId</span> = pid;</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">            list,</span><br><span class="line">            page,</span><br><span class="line">            handleCurrentChange,</span><br><span class="line">         formData,</span><br><span class="line">         showAddDialog,</span><br><span class="line">         addPermission <span class="comment">// 将addPermission返回</span></span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>以上是<code>addPermission</code>方法的初步定义。（该方法的作用：将窗口弹出，同时记录下权限的类型与父编号）</p>
<p>同时这里还需要注意的一点就是 ：给<code>el-form</code>标签，添加<code>model</code>属性，绑定<code>formData</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 新增窗口 --&gt;</span><br><span class="line"> &lt;el-dialog title=&quot;新增权限&quot; v-model=&quot;showAddDialog&quot;&gt;</span><br><span class="line">   &lt;el-form label-width=&quot;120px&quot; :model=&quot;formData&quot;&gt;</span><br></pre></td></tr></table></figure>

<p>关于表单校验，大家可以自己完善。</p>
<p>当单击了<code>新增权限</code>这个窗口中的<code>确定</code>按钮的时候，才会真正的发送请求，完成权限的添加。</p>
<p>给【确定】按钮注册单击事件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-col :span=&quot;6&quot;&gt;</span><br><span class="line">          &lt;el-button size=&quot;small&quot; @click=&quot;btnOk&quot;&gt;确定&lt;/el-button&gt;</span><br></pre></td></tr></table></figure>

<p>下面看一下<code>btnOk</code>方法的实现</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;getPermissionList,addPermissionInfo&#125; <span class="keyword">from</span> <span class="string">&#x27;@/api/permission&#x27;</span> <span class="comment">// 导入addPermissionInfo方法  </span></span><br><span class="line"><span class="comment">// 完成权限的添加</span></span><br><span class="line">     <span class="keyword">const</span> <span class="title function_">btnOk</span>=<span class="keyword">async</span>(<span class="params"></span>)=&gt;&#123;</span><br><span class="line">      <span class="keyword">await</span> <span class="title function_">addPermissionInfo</span>(formData);<span class="comment">// 调用addPermissionInfo方法，发送请求.formData对象中存储的就是权限数据</span></span><br><span class="line">      <span class="title class_">ElMessage</span>.<span class="title function_">success</span>(<span class="string">&quot;权限添加成功&quot;</span>);</span><br><span class="line">      showAddDialog.<span class="property">value</span> = <span class="literal">false</span>;</span><br><span class="line">      <span class="title function_">loadPermissionsList</span>();<span class="comment">// 重新加载数据</span></span><br><span class="line">     &#125;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            list,</span><br><span class="line">            page,</span><br><span class="line">            handleCurrentChange,</span><br><span class="line">         formData,</span><br><span class="line">         showAddDialog,</span><br><span class="line">         addPermission,</span><br><span class="line">         btnOk<span class="comment">// 返回btnOk方法</span></span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>在<code>src/api/permission.js</code>文件中添加<code>addPermissionInfo</code>方法，如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">addPermissionInfo</span>(<span class="params">data</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">request</span>(&#123;</span><br><span class="line">        <span class="attr">method</span>:<span class="string">&#x27;post&#x27;</span>,</span><br><span class="line">        <span class="attr">url</span>:<span class="string">&#x27;/permissions&#x27;</span>,</span><br><span class="line">        data</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回到浏览器端进行测试。</p>
<p>当然，这里大家可以把新增权限前面做的稍微详细点，我们知道，当添加菜单权限的时候 ，可以添加<code>MenuIcon</code>等值，而添加功能权限的时候，可以添加<code>PointClass</code>等值。</p>
<p>所以在添加的时候，可以根据不同的类型进行判断，展示成不同的输入框。</p>
<h3 id="5、为角色分配权限"><a href="#5、为角色分配权限" class="headerlink" title="5、为角色分配权限"></a>5、为角色分配权限</h3><h4 id="5-1-展示分配权限的窗口"><a href="#5-1-展示分配权限的窗口" class="headerlink" title="5.1 展示分配权限的窗口"></a>5.1 展示分配权限的窗口</h4><p>在角色列表组件中，添加如下布局代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;/el-card&gt;</span><br><span class="line">          &lt;!-- 给角色分配权限的窗口 --&gt;</span><br><span class="line">          &lt;el-dialog title=&quot;分配权限&quot; v-model=&quot;showPermDialog&quot;&gt; &lt;!--showPermDialog控制窗口的显示与隐藏--&gt;</span><br><span class="line">              &lt;!--permData就是要展示的数据--&gt;</span><br><span class="line">              &lt;!--defaultProps：定义显示的字段的名称以及子属性显示的字段的名称--&gt;</span><br><span class="line">             &lt;el-tree :data=&quot;permData&quot; :props=&quot;defaultProps&quot; default-expand-all&gt;&lt;/el-tree&gt;</span><br><span class="line">             &lt;template #footer&gt;</span><br><span class="line">            &lt;el-row type=&quot;flex&quot; justify=&quot;center&quot;&gt;</span><br><span class="line">              &lt;el-col :span=&quot;6&quot;&gt;</span><br><span class="line">                &lt;el-button type=&quot;primary&quot; size=&quot;small&quot;&gt;确定&lt;/el-button&gt;</span><br><span class="line">                &lt;el-button  size=&quot;small&quot;  @click=&quot;showPermDialog=false&quot;&gt;取消&lt;/el-button&gt;</span><br><span class="line">              &lt;/el-col&gt;</span><br><span class="line">            &lt;/el-row&gt;</span><br><span class="line">    &lt;/template&gt;</span><br><span class="line">          &lt;/el-dialog&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;/div&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">const</span> list = <span class="title function_">ref</span>([]);</span><br><span class="line"><span class="comment">// 定义以下属性</span></span><br><span class="line">      <span class="keyword">const</span> showPermDialog=<span class="title function_">ref</span>(<span class="literal">false</span>);</span><br><span class="line">      <span class="keyword">const</span> permData=<span class="title function_">ref</span>([]);</span><br><span class="line">      <span class="keyword">const</span> defaultProps=&#123;&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-table-column label=&quot;操作&quot;&gt;</span><br><span class="line">                &lt;el-button size=&quot;small&quot; type=&quot;success&quot; @click=&quot;setPermission&quot;&gt;分配权限&lt;/el-button&gt;</span><br></pre></td></tr></table></figure>

<p>当单击<code>分配权限</code>按钮的时候，调用<code>setPermission</code>方法，在该方法中需要将以上的窗口弹出</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">setPermission</span>=(<span class="params"></span>)=&gt;&#123;</span><br><span class="line">    showPermDialog.<span class="property">value</span>=<span class="literal">true</span>; <span class="comment">// 展示窗口</span></span><br><span class="line">  &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      list,</span><br><span class="line">      ...<span class="title function_">toRefs</span>(page),</span><br><span class="line">      handleCurrentChange,</span><br><span class="line">      showPermDialog, <span class="comment">// 返回</span></span><br><span class="line">      permData, <span class="comment">// 返回</span></span><br><span class="line">      setPermission, <span class="comment">// 返回</span></span><br><span class="line">      defaultProps <span class="comment">// 返回</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>下面要做的就是发送请求，获取所有的权限数据，将其展示到树形结构中。</p>
<p>在<code>ap/permission.js</code>文件中定义如下方法：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getAllPermissions</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">request</span>(&#123;</span><br><span class="line">        <span class="attr">url</span>:<span class="string">&#x27;/permissions/per&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上代码是发送请求，获取所有的权限。</p>
<p>返回到<code>views/roles/index.vue</code>这个组件中，继续修改代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;getAllPermissions&#125; <span class="keyword">from</span> <span class="string">&#x27;@/api/permission&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123;tranListToTreeData&#125; <span class="keyword">from</span><span class="string">&#x27;@/utils/index&#x27;</span></span><br></pre></td></tr></table></figure>

<p>在上面的代码中，导入了<code>getAllPermissions</code>这个方法和<code>tranListToTreeData</code>方法，这个方法的作用就是将数据转换成树形结构。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取所有的权限</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">setPermission</span>=<span class="keyword">async</span>(<span class="params"></span>)=&gt;&#123;</span><br><span class="line">    showPermDialog.<span class="property">value</span>=<span class="literal">true</span>;</span><br><span class="line">   <span class="keyword">const</span> &#123;rows&#125;= <span class="keyword">await</span> <span class="title function_">getAllPermissions</span>();</span><br><span class="line">   permData.<span class="property">value</span> =<span class="title function_">tranListToTreeData</span>(rows,<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>在上面的代码中，我们调用<code>getAllPermissions</code>方法，获取所有的权限数据，然后传递<code>tranListToTreeData</code>方法进行转换，第二个参数，表示的是根节点的编号是0.</p>
<p>转换好的数据赋值给<code>permData</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-tree :data=&quot;permData&quot; :props=&quot;defaultProps&quot; default-expand-all&gt;&lt;/el-tree&gt;</span><br></pre></td></tr></table></figure>

<p>我们知道<code>permData</code>已经与<code>el-tree</code>组件的<code>data</code>属性关联，<code>data</code>属性表示的就是要展示的数据，</p>
<p>但是还需要注意<code>props</code>属性，该属性关联的是<code>defaultProps</code>,</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">const</span> permData=<span class="title function_">ref</span>([]);</span><br><span class="line"><span class="comment">// 完善了defaultProps的内容</span></span><br><span class="line">      <span class="keyword">const</span> defaultProps=&#123;</span><br><span class="line">        <span class="attr">label</span>:<span class="string">&quot;permissionName&quot;</span>,</span><br><span class="line">        <span class="attr">children</span>:<span class="string">&#x27;children&#x27;</span></span><br><span class="line">      &#125;;</span><br></pre></td></tr></table></figure>

<p>以上完善了<code>defaultProps</code>对象，<code>label</code>属性的取值是<code>permissionName</code>，表示在树形结构中展示的就是权限的名称。</p>
<p><code>children</code>属性的取值是<code>children</code>，表示构建树形结构，就是通过<code>children</code>来完成的。</p>
<p>当然，这里我们调用<code>getAllPermissions</code>发送的获取所有权限请求对应的接口，在服务端还没有创建，服务端以前创建的是分页展示。</p>
<p>而这里我们需要获取到所有的权限数据，而不需要分页的内容。</p>
<p>在<code>PermissionsController.cs</code>控制器中添加如下方法</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">HttpGet(<span class="string">&quot;per&quot;</span>)</span>]</span><br><span class="line">       <span class="function"><span class="keyword">public</span> IActionResult <span class="title">GetAllPermissions</span>()</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">var</span> permissionsList= _permissionInfoService.LoadEntities(p =&gt; <span class="literal">true</span>);</span><br><span class="line">           <span class="keyword">if</span> (permissionsList.Count() &lt;= <span class="number">0</span>)</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">return</span> NotFound(<span class="string">&quot;没有权限信息&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">var</span> permissions = permissionsList.Select(u =&gt; <span class="keyword">new</span> &#123; Id = u.Id, PermissionName = u.PermissionName, PermissionCode = u.PermissionCode, CreateTime = u.CreateTime, PermissionDescription = u.PermissionDescription, ParentId = u.ParentId, PermissionType = u.PermissionType &#125;);</span><br><span class="line"></span><br><span class="line">           <span class="keyword">return</span> Ok(<span class="keyword">new</span> ApiResult&lt;<span class="built_in">object</span>&gt;() &#123; Success = <span class="literal">true</span>, Message = <span class="string">&quot;获取权限信息成功&quot;</span>, Data = <span class="keyword">new</span> &#123; rows = permissions&#125; &#125;);</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>



<p>返回到浏览器中进行测试。</p>
<h4 id="5-2-为角色分配权限前端处理1"><a href="#5-2-为角色分配权限前端处理1" class="headerlink" title="5.2 为角色分配权限前端处理1"></a>5.2 为角色分配权限前端处理1</h4><p>当单击分配角色按钮，在弹出的窗口中可以以树形结构展示权限信息了。</p>
<p>这里，我们还需要在每个权限名称前面添加复选框，方便进行选择。</p>
<p>参考文档：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://element-plus.gitee.io/zh-CN/component/tree.html#%E5%8F%AF%E9%80%89%E6%8B%A9</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 给角色分配权限的窗口 --&gt;</span><br><span class="line">           &lt;el-dialog title=&quot;分配权限&quot; v-model=&quot;showPermDialog&quot;&gt;</span><br><span class="line">              &lt;el-tree :data=&quot;permData&quot; show-checkbox check-strictly :props=&quot;defaultProps&quot; default-expand-all&gt;&lt;/el-tree&gt;</span><br></pre></td></tr></table></figure>

<p>这里修改了<code>views/roles/index.vue</code>这个组件中添加的<code>el-tree</code>组件。</p>
<p>给改组件添加了<code>show-checkbox</code>表示在每个角色名称前面添加复选框</p>
<p><code>check-strictly </code>:如果表示选择了某个根权限，不会选择它下面的子权限。</p>
<p>下面我们要处理的就是，当弹出以上窗口的时候，应该将要分配权限的角色，以前具有的权限选中。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-table-column label=&quot;描述&quot; prop=&quot;remark&quot; /&gt;</span><br><span class="line">            &lt;el-table-column label=&quot;操作&quot;&gt;</span><br><span class="line">              &lt;template   #default=&quot;scope&quot;&gt;&lt;!--添加了默认插槽---&gt;</span><br><span class="line">              &lt;el-button size=&quot;small&quot; type=&quot;success&quot; @click=&quot;setPermission(scope.row.id)&quot;&gt;分配权限&lt;/el-button&gt;</span><br></pre></td></tr></table></figure>

<p>当单击<code>分配权限</code>按钮的时候，会调用前面我们所创建的<code>setPermission</code>这个方法，同时会将要分配权限的角色的编号传递到该方法中。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">setPermission</span>=<span class="keyword">async</span>(<span class="params">id</span>)=&gt;&#123;</span><br><span class="line">     showPermDialog.<span class="property">value</span>=<span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">const</span> &#123;rows&#125;= <span class="keyword">await</span> <span class="title function_">getAllPermissions</span>();</span><br><span class="line">    permData.<span class="property">value</span> =<span class="title function_">tranListToTreeData</span>(rows,<span class="number">0</span>);</span><br><span class="line">    roleId.<span class="property">value</span>=id;<span class="comment">//记录要分配权限的角色的编号。</span></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>在<code>setPermission</code>方法中，我们将传递过来的角色的编号赋值给了一个响应对象<code>roleId</code>进行了保存。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> permData=<span class="title function_">ref</span>([]);</span><br><span class="line">     <span class="comment">// 记录要分配权限的角色编号</span></span><br><span class="line">     <span class="keyword">const</span> roleId = <span class="title function_">ref</span>(<span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<p>所以在上面的代码中，我们创建了<code>roleId</code>这个响应对象。</p>
<p>下面我们要做的就是把<code>角色编号</code>发送到服务端，服务端根据该角色编号，查询一下该角色以前具有哪些权限。</p>
<h4 id="5-3-实现获取角色已经具有权限接口实现"><a href="#5-3-实现获取角色已经具有权限接口实现" class="headerlink" title="5.3  实现获取角色已经具有权限接口实现"></a>5.3  实现获取角色已经具有权限接口实现</h4><p>在<code>PermissionsController.cs</code>控制器中添加如下方法：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取角色已经具有的权限</span></span><br><span class="line">      [<span class="meta">HttpGet(<span class="string">&quot;&#123;id&#125;/roles&quot;</span>)</span>]</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">GetPermissionsByRoleId</span>(<span class="params">[FromRoute]<span class="built_in">int</span> id</span>)</span></span><br><span class="line">      &#123;</span><br><span class="line">         <span class="keyword">var</span> roleInfo = <span class="keyword">await</span> _roleInfoService.LoadEntities(r =&gt; r.Id == id).FirstOrDefaultAsync();</span><br><span class="line">          <span class="keyword">if</span> (roleInfo == <span class="literal">null</span>)</span><br><span class="line">          &#123;</span><br><span class="line">              <span class="keyword">return</span> NotFound(<span class="string">&quot;没有找到对应的角色&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// 获取当前角色已经拥有的权限信息</span></span><br><span class="line">          <span class="keyword">var</span> rolesAllPermissions = _roleInfoService.LoadEntities(r =&gt; r.Id == id).Select(r =&gt; r.PermissionInfos);</span><br><span class="line">          <span class="keyword">var</span> permIdList = rolesAllPermissions.Select(u =&gt; u.Select(r =&gt; r.Id)).ToList();</span><br><span class="line">         <span class="comment">// var permissions = roleInfoService.LoadEntities(r =&gt; r.Id == id).Include(r =&gt; r.PermissionInfos);</span></span><br><span class="line">          <span class="comment">// var permissionIds = permissions.Select(u =&gt; u.PermissionInfos.Select(u =&gt; u.Id));</span></span><br><span class="line">          <span class="keyword">return</span> Ok(<span class="keyword">new</span> ApiResult&lt;<span class="built_in">object</span>&gt;() &#123; Success = <span class="literal">true</span>, Data = permIdList &#125;);</span><br><span class="line"></span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>





<h4 id="5-4-角色分配权限前端处理2"><a href="#5-4-角色分配权限前端处理2" class="headerlink" title="5.4 角色分配权限前端处理2"></a>5.4 角色分配权限前端处理2</h4><p>在上一小节中，我们已经创建好了获取角色已经具有的权限对应的接口。</p>
<p>在前端的<code>api/permission.js</code>文件中应该创建一个方法请求该接口。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取角色已经具有的权限编号</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getRolePermissionIdList</span>(<span class="params">id</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">request</span>(&#123;</span><br><span class="line">        <span class="attr">url</span>:<span class="string">`/permissions/<span class="subst">$&#123;id&#125;</span>/roles`</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>返回到<code>views/roles/index.vue</code>这个组件中</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;getAllPermissions,getRolePermissionIdList&#125; <span class="keyword">from</span> <span class="string">&#x27;@/api/permission&#x27;</span> <span class="comment">// 导入getRolePermissionIdList方法</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取所有的权限</span></span><br><span class="line">   <span class="keyword">const</span> <span class="title function_">setPermission</span>=<span class="keyword">async</span>(<span class="params">id</span>)=&gt;&#123;</span><br><span class="line">     showPermDialog.<span class="property">value</span>=<span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">const</span> &#123;rows&#125;= <span class="keyword">await</span> <span class="title function_">getAllPermissions</span>();</span><br><span class="line">    permData.<span class="property">value</span> =<span class="title function_">tranListToTreeData</span>(rows,<span class="number">0</span>);</span><br><span class="line">    roleId.<span class="property">value</span>=id;<span class="comment">//记录要分配权限的角色的编号。</span></span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="title function_">getRolePermissionIdList</span>(id) <span class="comment">// 调用getRolePermissionIdList方法</span></span><br><span class="line">    selectCheck.<span class="property">value</span>=result[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>在<code>setPermission</code>方法中，调用了我们刚刚封装好的<code>getRolePermissionIdList</code>方法，传递了角色的编号，发送请求，获取了当前这个角色已经具有的权限信息。当然这里服务端返回的都是权限的编号。</p>
<p>而且，返回的是一个二维数组，二维数组中的第一个元素也是一个数组，里面存储的都是当前角色已经具有的权限编号。</p>
<p>然后赋值给了响应对象<code>selectCheck</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> roleId = <span class="title function_">ref</span>(<span class="number">0</span>);</span><br><span class="line">   <span class="keyword">const</span> selectCheck =<span class="title function_">ref</span>([]); </span><br></pre></td></tr></table></figure>

<p>这里我们定义了<code>selectCheck</code>这个响应对象，并且将其返回</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">       list,</span><br><span class="line">       ...<span class="title function_">toRefs</span>(page),</span><br><span class="line">       handleCurrentChange,</span><br><span class="line">       showPermDialog,</span><br><span class="line">       permData,</span><br><span class="line">       setPermission,</span><br><span class="line">       defaultProps,</span><br><span class="line">       selectCheck <span class="comment">// 返回</span></span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>

<p>下面需要给树形组件添加属性。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> &lt;!-- 给角色分配权限的窗口 --&gt;</span><br><span class="line">            <span class="language-xml"><span class="tag">&lt;<span class="name">el-dialog</span> <span class="attr">title</span>=<span class="string">&quot;分配权限&quot;</span> <span class="attr">v-model</span>=<span class="string">&quot;showPermDialog&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">               <span class="tag">&lt;<span class="name">el-tree</span> <span class="attr">:data</span>=<span class="string">&quot;permData&quot;</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">               <span class="attr">show-checkbox</span> <span class="attr">check-strictly</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">               <span class="attr">:props</span>=<span class="string">&quot;defaultProps&quot;</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">// <span class="attr">添加了default-checked-keys</span> <span class="attr">和node-key</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">               <span class="attr">default-expand-all</span> <span class="attr">:default-checked-keys</span>=<span class="string">&quot;selectCheck&quot;</span> <span class="attr">node-key</span>=<span class="string">&quot;id&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;/<span class="name">el-tree</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>在上面的<code>el-tree</code>这个组件中，添加了<code>default-checked-keys</code>属性，该属性关联的值就是<code>selectCheck</code>, 也就是，树形中的复选框要想选中，需要根据<code>selectCheck</code>这个数组来确定。问题是，需要根据<code>selectCheck</code>这个数组中存储的<code>id</code>值来选中对应的复选框，所以这里又添加了<code>node-key</code>这个属性，取值是<code>id</code>，来作为唯一的标识。</p>
<p>返回到浏览器中进行测试(可以现在数据库中输入数据，方便进行测试)</p>
<h4 id="5-5-完成角色权限的分配"><a href="#5-5-完成角色权限的分配" class="headerlink" title="5.5 完成角色权限的分配"></a>5.5 完成角色权限的分配</h4><p>下面我们首先要获取的就是所选中的权限的编号。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-tree :data=&quot;permData&quot; </span><br><span class="line">              show-checkbox check-strictly </span><br><span class="line">              :props=&quot;defaultProps&quot; </span><br><span class="line">              ref=&quot;permTree&quot;</span><br><span class="line">              default-expand-all :default-checked-keys=&quot;selectCheck&quot; node-key=&quot;id&quot;&gt;</span><br><span class="line">             &lt;/el-tree&gt;</span><br></pre></td></tr></table></figure>

<p>这里，给<code>el-tree</code>这个组件，添加了<code>ref</code>属性，关联了<code>permTree</code>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 关联el-tree组件</span></span><br><span class="line">     <span class="keyword">const</span> permTree =<span class="title function_">ref</span>(<span class="literal">null</span>);</span><br></pre></td></tr></table></figure>

<p>当单击<code>分配权限</code>窗口中的<code>确定</code>按钮以后，会触发<code>click</code>事件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-button type=&quot;primary&quot; size=&quot;small&quot; @click=&quot;setPermissionOk&quot;&gt;确定&lt;/el-button&gt;</span><br></pre></td></tr></table></figure>

<p>调用<code>setPermissionOk</code>方法。在该方法中，会通过<code>permTree</code>获取到<code>el-tree</code>组件。</p>
<p>然后获取到所选中的权限的编号。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 给角色分配权限</span></span><br><span class="line">   <span class="keyword">const</span> <span class="title function_">setPermissionOk</span>=(<span class="params"></span>)=&gt;&#123;</span><br><span class="line">     <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;keys=&quot;</span>,permTree.<span class="property">value</span>.<span class="title function_">getCheckedKeys</span>());<span class="comment">//通过getCheckedKeys方法获取选中的权限编号</span></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>最终是调用了<code>el-tree</code>组件中的<code>getCheckedKeys</code>方法获取了所选中的权限编号。</p>
<p>最后返回</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">      list,</span><br><span class="line">      ...<span class="title function_">toRefs</span>(page),</span><br><span class="line">      handleCurrentChange,</span><br><span class="line">      showPermDialog,</span><br><span class="line">      permData,</span><br><span class="line">      setPermission,</span><br><span class="line">      defaultProps,</span><br><span class="line">      selectCheck,</span><br><span class="line">      permTree,  <span class="comment">// 返回</span></span><br><span class="line">      setPermissionOk <span class="comment">// 返回</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>可以返回到浏览器中，看一下控制台中的打印。</p>
<h5 id="5-5-2-服务端接口实现"><a href="#5-5-2-服务端接口实现" class="headerlink" title="5.5.2 服务端接口实现"></a>5.5.2 服务端接口实现</h5><p>第一：在<code>Cms.IRepository</code>类库项目中的<code>IPermissionInfoRepository</code>接口中声明一个用来获取角色已有权限的方法，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.IRepository</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IPermissionInfoRepository</span>:<span class="title">IBaseRepository</span>&lt;<span class="title">PermissionInfo</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        Task&lt;List&lt;PermissionInfo&gt;&gt; GetRolePermissions(<span class="built_in">long</span> roleId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>第二：在<code>Cms.Repository</code>类库项目中的<code>PermissionInfoRepository.cs</code>数据仓储中实现上面的方法，如下代码所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PermissionInfoRepository</span>:<span class="title">BaseRepository</span>&lt;<span class="title">PermissionInfo</span>&gt;,<span class="title">IPermissionInfoRepository</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="title">PermissionInfoRepository</span>(<span class="params">MyDbContext context</span>) : <span class="title">base</span>(<span class="params">context</span>)</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;List&lt;PermissionInfo&gt;&gt; GetRolePermissions(<span class="built_in">long</span> roleId)</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">var</span> roleInfo = <span class="keyword">await</span> ctx.RoleInfos.Include(r =&gt; r.PermissionInfos).Where(u =&gt; u.Id == roleId).FirstOrDefaultAsync();</span><br><span class="line">	<span class="comment">// 获取指定角色对应的权限信息</span></span><br><span class="line">           <span class="keyword">return</span> roleInfo!.PermissionInfos.ToList();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>第三：在<code>IPermissionInfoService.cs</code>这个服务接口中声明一个用来完成给角色分配权限的方法，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IPermissionInfoService</span>:<span class="title">IBaseService</span>&lt;<span class="title">PermissionInfo</span>&gt;</span><br><span class="line">   &#123;</span><br><span class="line">        <span class="function">Task&lt;<span class="built_in">bool</span>&gt; <span class="title">AddPermission</span>(<span class="params">PermissionDto permissionDto</span>)</span>;</span><br><span class="line">       <span class="function">IQueryable&lt;PermissionInfo&gt; <span class="title">LoadSearchEntities</span>(<span class="params">PermissionSearch permissionSearch, <span class="built_in">bool</span> delFlag</span>)</span>;</span><br><span class="line">	<span class="comment">// 声明一个给指定角色分配权限的方法	</span></span><br><span class="line">       <span class="function">Task&lt;<span class="built_in">bool</span>&gt; <span class="title">SetRolePermission</span>(<span class="params">RoleInfo roleInfo, List&lt;<span class="built_in">long</span>&gt; permissionIdList</span>)</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>第四：在<code>PermissionInfoService.cs</code>中实现上面所声明的<code>SetRolePermission</code>方法，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 完成给角色分配权限</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;<span class="built_in">bool</span>&gt; <span class="title">SetRolePermission</span>(<span class="params">RoleInfo roleInfo, List&lt;<span class="built_in">long</span>&gt; permissionIdList</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="comment">// 获取角色已经具有的权限</span></span><br><span class="line">          <span class="keyword">await</span> _permissionInfoRepository.GetRolePermissions(roleInfo.Id);</span><br><span class="line">           <span class="comment">//  _roleInfoRepository.LoadEntities(p=&gt;p.Id == roleInfo.Id).Include(r=&gt;r.PermissionInfos).ToList();</span></span><br><span class="line">           <span class="comment">// 删除角色已经具有的权限</span></span><br><span class="line">           roleInfo.PermissionInfos.Clear();</span><br><span class="line">           <span class="keyword">if</span> (permissionIdList.Count == <span class="number">1</span> &amp;&amp; permissionIdList[<span class="number">0</span>] == <span class="number">0</span>)</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">foreach</span>(<span class="keyword">var</span> pId <span class="keyword">in</span> permissionIdList)</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">var</span> permissionInfo =<span class="keyword">await</span> _permissionInfoRepository.LoadEntities(p =&gt; p.Id == pId).FirstOrDefaultAsync();</span><br><span class="line">               roleInfo.PermissionInfos.Add(permissionInfo!);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>第五：<code>PermissionsController.cs</code>控制器中的实现</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 给角色分配权限</span></span><br><span class="line">        [<span class="meta">HttpPost(<span class="string">&quot;&#123;id&#125;/roles/&#123;permissionId&#125;&quot;</span>)</span>]</span><br><span class="line">        [<span class="meta">UnitOfWork(new Type[</span>] &#123; <span class="keyword">typeof</span>(MyDbContext) &#125;)]</span><br><span class="line">        [<span class="meta">Authorize</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">SetRolePermissions</span>(<span class="params">[FromRoute]<span class="built_in">int</span> id, [FromRoute]<span class="built_in">string</span> permissionId</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">           <span class="keyword">var</span> roleInfo = <span class="keyword">await</span> _roleInfoService.LoadEntities(r=&gt;r.Id==id).FirstOrDefaultAsync();</span><br><span class="line">            <span class="keyword">if</span>(roleInfo == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> NotFound(<span class="string">&quot;没有找到对应的角色信息&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            List&lt;<span class="built_in">long</span>&gt; list = <span class="keyword">new</span> List&lt;<span class="built_in">long</span>&gt;(); <span class="comment">// 注意这里的list一定是long类型因为下面要进行并集运算，类型必须要统一</span></span><br><span class="line">            <span class="keyword">var</span> strIds = permissionId.Split(<span class="string">&#x27;,&#x27;</span>);</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> pId <span class="keyword">in</span> strIds)</span><br><span class="line">            &#123;</span><br><span class="line">                list.Add(Convert.ToInt32(pId));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">await</span> _permissionInfoService.SetRolePermission(roleInfo,list);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> Ok(<span class="keyword">new</span> ApiResult&lt;<span class="built_in">object</span>&gt; &#123; Success = <span class="literal">true</span>, Message = <span class="string">&quot;获取成功&quot;</span>&#125;);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h5 id="5-5-3-前端实现"><a href="#5-5-3-前端实现" class="headerlink" title="5.5.3  前端实现"></a>5.5.3  前端实现</h5><p>在<code>src/api/permission.js</code>文件中，添加如下方法：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 给角色分配权限</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">setRolePermissions</span>(<span class="params">id,data</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">request</span>(&#123;</span><br><span class="line">        <span class="attr">method</span>:<span class="string">&#x27;post&#x27;</span>,</span><br><span class="line">        <span class="attr">url</span>:<span class="string">`/permissions/<span class="subst">$&#123;id&#125;</span>/roles/<span class="subst">$&#123;data&#125;</span>`</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回到<code>Views/roles/index.vue</code>组件，继续修改代码，如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;getAllPermissions,getRolePermissionIdList,setRolePermissions&#125; <span class="keyword">from</span> <span class="string">&#x27;@/api/permission&#x27;</span></span><br></pre></td></tr></table></figure>

<p>在上面的代码中，导入<code>setRolePermissions</code>方法</p>
<p>修改<code>setPermissionOk</code>方法中的代码，如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 给角色分配权限</span></span><br><span class="line">   <span class="keyword">const</span> <span class="title function_">setPermissionOk</span>=<span class="keyword">async</span>(<span class="params"></span>)=&gt;&#123;</span><br><span class="line">    <span class="comment">// console.log(&quot;keys=&quot;,permTree.value.getCheckedKeys());</span></span><br><span class="line">       <span class="comment">// 获取到选中的权限的编号，然后转换成字符串</span></span><br><span class="line">    <span class="keyword">const</span> ids = permTree.<span class="property">value</span>.<span class="title function_">getCheckedKeys</span>().<span class="property">length</span>&gt;<span class="number">0</span>? permTree.<span class="property">value</span>.<span class="title function_">getCheckedKeys</span>().<span class="title function_">join</span>(<span class="string">&#x27;,&#x27;</span>):<span class="string">&quot;0&quot;</span>;</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">setRolePermissions</span>(roleId.<span class="property">value</span>,ids); <span class="comment">// 把角色编号以及权限编号发送到服务端</span></span><br><span class="line">    <span class="title class_">ElMessage</span>(&#123;</span><br><span class="line">     <span class="attr">message</span>:<span class="string">&quot;分配权限成功&quot;</span>,</span><br><span class="line">       <span class="attr">type</span>:<span class="string">&#x27;success&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line">    showPermDialog.<span class="property">value</span>= <span class="literal">false</span>;<span class="comment">// 关闭窗口</span></span><br><span class="line">    selectCheck.<span class="property">value</span> =[]<span class="comment">// ------------注意：这里一定要清空数据</span></span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>返回到浏览器中进行测试。</p>
<h2 id="九、权限过滤"><a href="#九、权限过滤" class="headerlink" title="九、权限过滤"></a>九、权限过滤</h2><h4 id="1、前端权限实现思路"><a href="#1、前端权限实现思路" class="headerlink" title="1、前端权限实现思路"></a>1、前端权限实现思路</h4><p>在权限管理页面中，我们设置了一个标识，这个标识可以和我们的路由模块进行关联，也就是说，如果用户拥有了这个标识，那么用户就可以拥有这个路由模块，如果没有这个标识，就不能访问路由模块。</p>
<p>怎样动态的添加路由呢？</p>
<p>在<code>vue-router</code>中提供了一个叫做<code>addRoutes</code>的方法，这个方法的含义是：<code>动态添加路由规则</code>。</p>
<p>思路如下：</p>
<p>用户登录—-获取标识—标识和路由进行关联，筛选出具有权限的路由—通过<code>addRoutes</code>添加。</p>
<h4 id="2、通过Vuex管理权限模块"><a href="#2、通过Vuex管理权限模块" class="headerlink" title="2、通过Vuex管理权限模块"></a>2、通过<code>Vuex</code>管理权限模块</h4><p>在<code>src/store/modules</code>目录下面创建一个<code>permission.js</code>文件，该文件的初步代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 处理权限路由模块</span></span><br><span class="line"><span class="keyword">const</span> state = &#123;&#125;</span><br><span class="line"><span class="keyword">const</span> mutations = &#123;&#125;</span><br><span class="line"><span class="keyword">const</span> actions = &#123;&#125;;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    <span class="attr">namespaced</span>:<span class="literal">true</span>,</span><br><span class="line">    state,</span><br><span class="line">    mutations,</span><br><span class="line">    actions,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个<code>Vuex</code>模块，专门就是用来权限路由的。</p>
<p>当然，需要把该模块添加到<code>Vuex</code>的容器中。修改<code>src/store/index.js</code>文件中，对代码进行修改，如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createStore &#125; <span class="keyword">from</span> <span class="string">&#x27;vuex&#x27;</span></span><br><span class="line"><span class="keyword">import</span> user <span class="keyword">from</span> <span class="string">&#x27;./modules/user&#x27;</span></span><br><span class="line"><span class="keyword">import</span> getters <span class="keyword">from</span> <span class="string">&quot;./getters&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> permission <span class="keyword">from</span> <span class="string">&#x27;./modules/permission&#x27;</span>; <span class="comment">// 导入permission模块</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">createStore</span>(&#123;</span><br><span class="line"> </span><br><span class="line">  <span class="attr">modules</span>: &#123;</span><br><span class="line">    user,</span><br><span class="line">    permission <span class="comment">// 将permission模块添加到Store容器中</span></span><br><span class="line">  &#125;,</span><br><span class="line">  getters</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>返回到<code>permisson</code>模块中，继续修改代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 处理权限路由模块</span></span><br><span class="line"><span class="keyword">import</span> &#123;constantRoutes&#125;  <span class="keyword">from</span> <span class="string">&#x27;@/router&#x27;</span></span><br><span class="line"><span class="keyword">const</span> state = &#123;</span><br><span class="line">   <span class="comment">// 最开始，用户一定会拥有静态路由的权限(例如登录的路由，首页的路由)</span></span><br><span class="line">   <span class="attr">routes</span>:constantRoutes <span class="comment">// routes：表示的是路由表，当前用户所拥有的所有路由的数组。</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> mutations = &#123;&#125;</span><br><span class="line"><span class="keyword">const</span> actions = &#123;&#125;;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    <span class="attr">namespaced</span>:<span class="literal">true</span>,</span><br><span class="line">    state,</span><br><span class="line">    mutations,</span><br><span class="line">    actions,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>state</code>这个状态对象中添加了一个属性<code>routes</code>,表示的是路由表，当前用户所拥有的所有路由都会存储在该数组中。</p>
<p>而我们也知道，用户默认是拥有静态路由的，例如：登录，首页等。所以这里导入进来，然后赋值给<code>routes</code>属性。</p>
<p>当然，这里我们把静态路由的名字修改成了<code>constantRoutes</code>，所以在<code>router/index.js</code>文件中，修改一下静态路由的名字，如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span>  <span class="keyword">const</span> constantRoutes = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">    <span class="attr">redirect</span>:<span class="string">&#x27;/dashboard&#x27;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="title class_">Layout</span>,</span><br><span class="line">    <span class="attr">children</span>:[</span><br></pre></td></tr></table></figure>

<p>上面把名字修改成了<code>constantRoutes</code>，同时，在创建路由对象<code>router</code>的时候也需要修改一下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> router = <span class="title function_">createRouter</span>(&#123;</span><br><span class="line">  <span class="attr">history</span>: <span class="title function_">createWebHashHistory</span>(),</span><br><span class="line">  <span class="attr">routes</span>:[...constantRoutes,...asyncRoutes] <span class="comment">// 这把静态路由的名字修改成了constantRoutes</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>下面继续修改<code>store/modules/permission.js</code>模块中的代码，如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 处理权限路由模块</span></span><br><span class="line"><span class="keyword">import</span> &#123;constantRoutes&#125;  <span class="keyword">from</span> <span class="string">&#x27;@/router&#x27;</span></span><br><span class="line"><span class="keyword">const</span> state = &#123;</span><br><span class="line">   <span class="comment">// 最开始，用户一定会拥有静态路由的权限(例如登录的路由，首页的路由)</span></span><br><span class="line">   <span class="attr">routes</span>:constantRoutes <span class="comment">// routes：表示的是路由表，当前用户所拥有的所有路由的数组。</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> mutations = &#123;</span><br><span class="line">    <span class="comment">// newRoutes:用户登录成功后需要添加的路由</span></span><br><span class="line">    <span class="title function_">setRoutes</span>(<span class="params">state,newRoutes</span>)&#123;</span><br><span class="line">        <span class="comment">// 当用户登录成功后，state对象中的routes属性中存储的就是登录用户具有的静态路由，以及其他的动态路由。</span></span><br><span class="line">        state.<span class="property">routes</span>=[...constantRoutes,...newRoutes]</span><br><span class="line">        <span class="comment">// 注意以下写法，从业务的角度来讲是不正确的.</span></span><br><span class="line">        <span class="comment">//state.routes=[...state.routes,...newRoutes]</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> actions = &#123;&#125;;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    <span class="attr">namespaced</span>:<span class="literal">true</span>,</span><br><span class="line">    state,</span><br><span class="line">    mutations,</span><br><span class="line">    actions,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果我们想修改<code>state</code>中的<code>routes</code>这个状态，需要再<code>mutations</code>中创建一个方法来完成修改。</p>
<p>这里我们创建了<code>setRoutes</code>方法：该方法的作用就是修改<code>routes</code>这个状态值。</p>
<p>每次用户登录以后，我们都是将静态路由和该用户拥有的动态路由合并以后，重新赋值给<code>rotues</code>这个状态。</p>
<p>这里需要注意的一点，就是如下写法，在当前的场景中不符合业务的要求：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">state.<span class="property">routes</span>=[...state.<span class="property">routes</span>,...newRoutes]</span><br></pre></td></tr></table></figure>

<p>在以上的写法中，是将新的路由规则，与<code>state.routes</code>中存储的原有的路由规则进行合并。</p>
<p>这样会导致出现一种情况：一个用户登录以后，含有了静态路由和动态路由，这时候他退出了，另外一个用户登录以后，就有可能获取到第一个用户的动态路由（静态路由大家都是一样的,而且是在一台电脑中进行登录的，并且浏览器没有关闭。）。</p>
<h4 id="3、Vuex筛选权限路由"><a href="#3、Vuex筛选权限路由" class="headerlink" title="3、Vuex筛选权限路由"></a>3、<code>Vuex</code>筛选权限路由</h4><h5 id="3-1-获取用户具有的权限编码–接口实现"><a href="#3-1-获取用户具有的权限编码–接口实现" class="headerlink" title="3.1 获取用户具有的权限编码–接口实现"></a>3.1 获取用户具有的权限编码–接口实现</h5><p>在前面我们讲解过，当用户登录以后，我们要获取权限的标识，然后与路由进行关联。</p>
<p>怎样获取标识呢？</p>
<p>在<code>src/permission.js</code>这个文件中，我们前面实现了前置的路由守卫，当用户登录成功以后，我们又执行了如下代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!store.<span class="property">state</span>.<span class="property">user</span>.<span class="property">userInfo</span>.<span class="property">Id</span>)&#123;</span><br><span class="line">        <span class="keyword">await</span> store.<span class="title function_">dispatch</span>(<span class="string">&quot;user/getUserInfo&quot;</span>);</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>这里执行了<code>store/modules/user.js</code>中的<code>actions</code>中的<code>getUserInfo</code>方法来获取用户的信息。而这时候，服务端是可以将该用户具有的权限标识返回过来的。</p>
<p>当然，目前服务端接口中，还没有返回该用户具有的权限标识，所以这里我们需要完善一下该接口。</p>
<p>修改<code>IUserInfoService.cs</code>服务端接口中的代码，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IUserInfoService</span>:<span class="title">IBaseService</span>&lt;<span class="title">UserInfo</span>&gt;</span><br><span class="line">   &#123;</span><br><span class="line">       <span class="function">IQueryable&lt;UserInfo&gt; <span class="title">LoadSearchEntities</span>(<span class="params">UserInfoSearch userInfoSearch, <span class="built_in">bool</span> delFlag</span>)</span>;</span><br><span class="line">       <span class="function">Task&lt;<span class="built_in">bool</span>&gt; <span class="title">SetUserRoles</span>(<span class="params">UserInfo userInfo, List&lt;<span class="built_in">long</span>&gt; roleIdList</span>)</span>;</span><br><span class="line">    <span class="comment">// 获取用户具有的权限编码</span></span><br><span class="line">       Task&lt;Dictionary&lt;<span class="built_in">string</span>, List&lt;<span class="built_in">string</span>&gt;&gt;&gt; GetUserPermissionCodes(<span class="built_in">long</span> userId);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>在上面的代码中，声明了<code>GetUserPermissionCodes</code>方法，用来获取用户具有的权限编码，该方法返回的数据类型是<code>Dictionary</code>字典类型、<code>key</code>是字符串，值是一个<code>list</code>集合。</p>
<p>定义字典集合的原因是，最终返回的用户具有的权限编码的格式是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&quot;menus&quot;: [</span><br><span class="line">      &quot;UserManager&quot;,</span><br><span class="line">      &quot;DepartmentManager&quot;,</span><br><span class="line">      &quot;RoleManager&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;points&quot;: [</span><br><span class="line">      &quot;UserAdd&quot;,</span><br><span class="line">      &quot;DepartmentAdd&quot;,</span><br><span class="line">      &quot;RoleAdd&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;apis&quot;: []</span><br></pre></td></tr></table></figure>

<p>下面返回到<code>UserInfoService.cs</code>这个服务类中，实现上面接口中所声明的<code>GetUserPermissionCodes</code>方法，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 获取登录用户具有的权限标识</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;userId&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;NotImplementedException&quot;&gt;</span><span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;Dictionary&lt;<span class="built_in">string</span>,List&lt;<span class="built_in">string</span>&gt;&gt;&gt; GetUserPermissionCodes(<span class="built_in">long</span> userId)<span class="comment">// UserInfo userInfo</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="comment">//  _userInfoRepository.LoadEntities(u =&gt; u.Id == userInfo.Id).Include(u =&gt; u.RoleInfos).ToList();</span></span><br><span class="line">          <span class="comment">// var userRoles = userInfo.RoleInfos;</span></span><br><span class="line">          <span class="keyword">var</span> userRoles  = <span class="keyword">await</span> _roleInfoRepository.GetUserRoles(userId);<span class="comment">// 获取用户具有的角色</span></span><br><span class="line"></span><br><span class="line">           List&lt;<span class="built_in">string</span>&gt; menus = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;(); <span class="comment">// 存储菜单权限的编码</span></span><br><span class="line">           List&lt;<span class="built_in">string</span>&gt; points = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;(); <span class="comment">// 存储功能权限的编码</span></span><br><span class="line">           List&lt;<span class="built_in">string</span>&gt; apis = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;(); <span class="comment">// 存储api权限的编码</span></span><br><span class="line">           <span class="keyword">foreach</span> (<span class="keyword">var</span> role <span class="keyword">in</span> userRoles)</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="comment">// 获取每个角色具有的权限信息</span></span><br><span class="line">              <span class="keyword">var</span> rolePermissions = <span class="keyword">await</span> _permissionInfoRepository.GetRolePermissions(role.Id);</span><br><span class="line">               <span class="comment">//也可以采用如下方法，更加的简单</span></span><br><span class="line">                 <span class="comment">//  roleInfoRepository.LoadEntities(r =&gt; r.Id == role.Id).Include(r =&gt; r.PermissionInfos).ToList();</span></span><br><span class="line">                <span class="comment">// var rolePermissions = role.PermissionInfos;</span></span><br><span class="line">               </span><br><span class="line">               <span class="comment">// 对获取到的权限的信息进行遍历，然后判断对应的类型，添加到相应的list集合中。</span></span><br><span class="line">               <span class="keyword">foreach</span> (<span class="keyword">var</span> permission <span class="keyword">in</span> rolePermissions)</span><br><span class="line">               &#123;</span><br><span class="line">                   <span class="keyword">if</span> (permission.PermissionType == (<span class="built_in">int</span>)PermissionTypeEnum.PermissionMenu)</span><br><span class="line">                   &#123;</span><br><span class="line">                       menus.Add(permission.PermissionCode!);</span><br><span class="line">                   &#125;<span class="keyword">else</span> <span class="keyword">if</span> (permission.PermissionType == (<span class="built_in">int</span>)PermissionTypeEnum.PermissionPoint)</span><br><span class="line">                   &#123;</span><br><span class="line">                       points.Add(permission.PermissionCode!);</span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="keyword">else</span></span><br><span class="line">                   &#123;</span><br><span class="line">                       apis.Add(permission.PermissionCode!);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           Dictionary&lt;<span class="built_in">string</span>,List&lt;<span class="built_in">string</span>&gt;&gt;dict =<span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>,List&lt;<span class="built_in">string</span>&gt;&gt;();</span><br><span class="line">           dict.Add(<span class="string">&quot;menus&quot;</span>, menus);</span><br><span class="line">           dict.Add(<span class="string">&quot;points&quot;</span>, points);</span><br><span class="line">           dict.Add(<span class="string">&quot;apis&quot;</span>,apis);</span><br><span class="line"></span><br><span class="line">           <span class="keyword">return</span> dict;  <span class="comment">// dict</span></span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">private</span> <span class="keyword">readonly</span> IUserInfoRepository _userInfoRepository;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IRoleInfoRepository _roleInfoRepository;</span><br><span class="line"><span class="comment">//这里需要注入权限的数据仓储</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IPermissionInfoRepository _permissionInfoRepository;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">UserInfoService</span>(<span class="params">IUserInfoRepository userInfoRepository,IRoleInfoRepository roleInfoRepository,IPermissionInfoRepository permissionInfoRepository</span>)</span> &#123; </span><br><span class="line">           <span class="keyword">base</span>.repository = userInfoRepository;</span><br><span class="line">            _userInfoRepository = userInfoRepository;</span><br><span class="line">            _roleInfoRepository = roleInfoRepository;</span><br><span class="line">            _permissionInfoRepository = permissionInfoRepository;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>



<p>下面看一下<code>UsersController.cs</code>控制器的具体实现。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">HttpGet</span>]</span><br><span class="line">     <span class="comment">/* [Authorize]*/</span> <span class="comment">// 可以先注释该特性，方便进行接口的测试</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">GetUserInfo</span>(<span class="params">[FromQuery]<span class="built_in">string</span> userPhone</span>)</span></span><br><span class="line">      &#123;</span><br><span class="line">          <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrWhiteSpace(userPhone))</span><br><span class="line">          &#123;</span><br><span class="line">              <span class="keyword">return</span> BadRequest(<span class="string">&quot;手机号不能为空&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        <span class="keyword">var</span> user = <span class="keyword">await</span>  _userInfoService.LoadEntities(u =&gt; u.UserPhone == userPhone).FirstOrDefaultAsync();</span><br><span class="line">          <span class="keyword">if</span>(user == <span class="literal">null</span>)</span><br><span class="line">          &#123;</span><br><span class="line">              <span class="keyword">return</span> BadRequest(<span class="string">&quot;没有查找到对应用户&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// ---------------------这里还需要查询该用户具有的权限信息。</span></span><br><span class="line">         <span class="keyword">var</span> dirct = <span class="keyword">await</span> _userInfoService.GetUserPermissionCodes(user.Id);</span><br><span class="line">          </span><br><span class="line">		<span class="comment">//------------------返回的具体的data数据中包含了用户的信息，以及权限编号的信息.</span></span><br><span class="line">          <span class="comment">// 当然用户信息，这里我们只是根据需要返回了用户的编号，用户名和手机号，头像地址</span></span><br><span class="line"></span><br><span class="line">          <span class="keyword">return</span> Ok(<span class="keyword">new</span> ApiResult&lt;<span class="built_in">object</span>&gt;() &#123; Success = <span class="literal">true</span>, Message = <span class="string">&quot;获取用户成功&quot;</span>, Data = <span class="keyword">new</span> &#123; user = <span class="keyword">new</span> &#123;Id=user.Id,UserName = user.UserName,UserPhone=user.UserPhone，PhotoUrl=user.PhotoUrl&#125;, roles = dirct &#125; &#125;);</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>下面可以进行接口的测试。</p>
<p>当然，前面我们讲过，是在前端项目的<code>store/modules/user.js</code>文件中发送的请求，请求以上接口的，现在该接口中返回的数据内容和格式发生了变化，所以我们也需要对前端做进一步的修改处理。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取用户资料信息(该方法中代码不需要修改，修改的是mutations中的setUserInfo方法)</span></span><br><span class="line">   <span class="keyword">async</span> <span class="title function_">getUserInfo</span>(<span class="params">context</span>)&#123;</span><br><span class="line">     <span class="keyword">const</span> userPhone =<span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">&quot;userPhone&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="title function_">getUserInfo</span>(userPhone);</span><br><span class="line">  <span class="comment">//  console.log(&#x27;result =&#x27;,result);</span></span><br><span class="line">     context.<span class="title function_">commit</span>(<span class="string">&quot;setUserInfo&quot;</span>,result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">   &#125;,</span><br></pre></td></tr></table></figure>

<p>我们知道，在以上的<code>actions</code>中所定义的<code>getUserInfo</code>这个方法中，向服务端发送了请求，并且传递了的数据是手机号，服务端返回的数据通过<code>commit</code>方法，提交到了<code>mutations</code>中，来根据服务端返回的数据修改<code>state</code>的状态，下面我们来看一下再<code>mutations</code>中定义的<code>setUserInfo</code>这个方法，</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">setUserInfo</span>(<span class="params">state,payload</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;user,roles &#125; =payload <span class="comment">// 解构出服务端返回的数据。</span></span><br><span class="line">      state.<span class="property">userInfo</span> = user;</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure>

<p>在<code>setUserInfo</code>这个<code>Mutations</code>方法中，把服务端返回的数据进行解构，然后把用户数据重新赋值给了<code>state</code>状态中的<code>userInfo</code>属性。</p>
<p>通过浏览器查看前端页面，可以看到页面中可以照常展示用户名和用户的头像。</p>
<h5 id="3-2-前端路由筛选——"><a href="#3-2-前端路由筛选——" class="headerlink" title="3.2 前端路由筛选——-"></a>3.2 前端路由筛选——-</h5><p>我们现在已经能够从服务端获取到权限的编码了，下面我们要做的就是把服务端返回的这些权限的编码与路由规则进行绑定。</p>
<p>怎样绑定呢？就是将动态路由中的<code>name</code>属性与权限编码一致就可以了。</p>
<p>例如，员工管理的权限编码是<code>UserManager</code>，而当前登录用户有该权限编码，说明当前登录用户具有员工管理的权限，同时就应该能够访问<code>员工管理</code>菜单，怎样能够访问呢？就是让员工管理对应的路由规则的<code>name</code>属性值也是<code>UserManager</code>就可以了。</p>
<p>这里，我们需要进行路由的筛选，筛选出与这些服务端返回的权限的标识一样的<code>name</code>属性值相同的动态路由。</p>
<p>在哪里筛选呢？—</p>
<p>这里，我们需要在<code>store/modules/permission.js</code>文件中进行筛选，这里定义一个<code>actions</code>方法，如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> actions = &#123;</span><br><span class="line">    <span class="comment">// 筛选路由</span></span><br><span class="line">    <span class="comment">// 第二个参数为当前用户所拥有的菜单权限(也是服务端返回的菜单权限的标识)</span></span><br><span class="line">    <span class="title function_">filterRoutes</span>(<span class="params">context,menus</span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> routes=[];</span><br><span class="line">        <span class="comment">// 筛选出动态路由中能够和menus匹配上的路由</span></span><br><span class="line">        menus.<span class="title function_">forEach</span>(<span class="function"><span class="params">key</span>=&gt;</span>&#123;</span><br><span class="line">            <span class="comment">// key：就是菜单权限标识</span></span><br><span class="line">            <span class="comment">// asyncRoutes就是定义了`router/index.js`文件中的动态路由的数组</span></span><br><span class="line">            <span class="comment">// 这里就是查找在`asyncRoutes`数组中的动态路由对象的name属性值是否与key相同，如果相同，就筛选出来，也就是表示当前用户拥有该路由权限，</span></span><br><span class="line">            <span class="comment">// filter返回的是一个数组，这里是将其解构后，把成员都添加到了routes数组中。routes数组中存储的就是满足权限要求的路由数组。也就是当前用户所拥有的动态路由的权限。</span></span><br><span class="line">            routes.<span class="title function_">push</span>(...asyncRoutes.<span class="title function_">filter</span>(<span class="function"><span class="params">item</span>=&gt;</span>item.<span class="property">name</span>===key));</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">// 将用户拥有的动态路由提到到mutations中,然后更新state状态</span></span><br><span class="line">        <span class="comment">// 后面，我们就可以把state中的动态路由信息取出来，然后来控制左侧菜单的显示</span></span><br><span class="line">        context.<span class="title function_">commit</span>(<span class="string">&#x27;setRoutes&#x27;</span>,routes);</span><br><span class="line">        <span class="keyword">return</span> routes;<span class="comment">// 这里返回routes动态路由数组的原因是为`addRoutes`使用的，因为我们要将这些动态路由添加到路由对象中，这样单击菜单的时候才可以展示。</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>注意：这里需要导入<code>asyncRoutes</code>这个动态路由</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 处理权限路由模块</span></span><br><span class="line"><span class="keyword">import</span> &#123;asyncRoutes, constantRoutes&#125;  <span class="keyword">from</span> <span class="string">&#x27;@/router&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="4、在权限拦截处调用筛选权限的Action"><a href="#4、在权限拦截处调用筛选权限的Action" class="headerlink" title="4、在权限拦截处调用筛选权限的Action"></a>4、在权限拦截处调用筛选权限的<code>Action</code></h3><p>在上一小节中，我们已经在<code>Vuex</code>中定义了一个<code>action</code>的方法叫做<code>filterRoutes</code>，用来进行路由的筛选。</p>
<p>问题是：在哪调用<code>filterRoutes</code>这个方法呢？</p>
<p>我们知道<code>filterRoutes</code>这个方法的第二个参数，是当前登录用户具有的菜单权限，也就是对应的菜单权限的标识。</p>
<p>所以说，我们肯定是在获取了用户的信息以后调用<code>filterRoutes</code>这个方法的。</p>
<p>所以这里修改<code>src/permission.js</code>文件中的代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_">beforeEach</span>(<span class="title function_">async</span>(to,<span class="keyword">from</span>,next)=&gt;&#123;</span><br><span class="line">    <span class="title class_">NProgress</span>.<span class="title function_">start</span>(); <span class="comment">// 开启进度条</span></span><br><span class="line">  <span class="comment">// 通过keys获取对象中的属性，返回值是一个数组，如果length大于0，表示对象中有属性，而不是一个空对象。</span></span><br><span class="line">  <span class="keyword">if</span> (store.<span class="property">getters</span>.<span class="property">token</span>!=<span class="literal">null</span>&amp;&amp; <span class="title class_">Object</span>.<span class="title function_">keys</span>(store.<span class="property">getters</span>.<span class="property">token</span>).<span class="property">length</span>) &#123;</span><br><span class="line">    <span class="comment">// 如果有token</span></span><br><span class="line">    <span class="keyword">if</span> (to.<span class="property">path</span> === <span class="string">&quot;/login&quot;</span>) &#123;</span><br><span class="line">      <span class="comment">// 如果访问的是登录页面，跳转到主页</span></span><br><span class="line">      <span class="title function_">next</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span>(!store.<span class="property">state</span>.<span class="property">user</span>.<span class="property">userInfo</span>.<span class="property">Id</span>)&#123;</span><br><span class="line">          <span class="comment">//-------------------------这里会调用`vuex`中的user模块中的`getUserInfo`方法，该方法会返回获取到的用户信息，而返回的用户信息中的roles属性中保存了当前登录用户具有的权限的标识。并且getUserInfo方法将得到的用户信息返回了，所以这里我们可以进行接收，并且将返回的用户信息中的roles给解构出来</span></span><br><span class="line">       <span class="keyword">const</span> &#123;roles&#125; =<span class="keyword">await</span> store.<span class="title function_">dispatch</span>(<span class="string">&quot;user/getUserInfo&quot;</span>);</span><br><span class="line">    <span class="comment">//   console.log(&#x27;roles===&#x27;,roles.menus)</span></span><br><span class="line">       <span class="comment">// ------------筛选用户的可用路由</span></span><br><span class="line"> 		<span class="comment">//---------------------- 这里调用了vuex中的permission模块中的filterRoutes方法，来筛选用户的可用路由，需要将当前登录用户的菜单权限标识传递到该方法中。该方法最后也将筛选出的路由返回了，所以这里可以进行接收，然后打印到浏览器的控制台中。   </span></span><br><span class="line">        <span class="keyword">const</span> routes = <span class="keyword">await</span> store.<span class="title function_">dispatch</span>(<span class="string">&#x27;permission/filterRoutes&#x27;</span>,roles.<span class="property">menus</span>);</span><br><span class="line">       <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;routes===&#x27;</span>,routes);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="title function_">next</span>(); <span class="comment">// 放行</span></span><br></pre></td></tr></table></figure>

<p>我们返回到浏览器中，刷新页面，可以看到当前打印的<code>routes</code>的值是空值。</p>
<p>原因是：</p>
<p>我们定义的动态路由规则的<code>name</code>属性的值没有修改。</p>
<p>所以下面我们修改一下</p>
<p>修改<code>router/departments.js</code>文件，该文件中定义的是部门管理的动态路由规则</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导出部门的路由规则</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Layout</span> <span class="keyword">from</span> <span class="string">&quot;@/layout&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">path</span>: <span class="string">&quot;/departments&quot;</span>, <span class="comment">// 路由地址</span></span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;DepartmentManager&quot;</span>, <span class="comment">//  --------------注意:这里的name属性的取值一定要与服务端返回的菜单权限的标识名称一致</span></span><br></pre></td></tr></table></figure>

<p><code>router/employees.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导出员工的路由规则</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Layout</span> <span class="keyword">from</span> <span class="string">&quot;@/layout&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">path</span>: <span class="string">&quot;/employees&quot;</span>, <span class="comment">// 路由地址</span></span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;UserManager&quot;</span>, <span class="comment">// --------------注意:这里的name属性的取值一定要与服务端返回的菜单权限的标识名称一致</span></span><br></pre></td></tr></table></figure>

<p><code>router/permission.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导出权限的路由规则</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Layout</span> <span class="keyword">from</span> <span class="string">&quot;@/layout&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">path</span>: <span class="string">&quot;/permissions&quot;</span>, <span class="comment">// 路由地址</span></span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;PermissionsManager&quot;</span>, <span class="comment">// --------------注意:这里的name属性的取值一定要与服务端返回的菜单权限的标识名称一致</span></span><br></pre></td></tr></table></figure>

<p><code>router/roleInfo.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导出角色的路由规则</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Layout</span> <span class="keyword">from</span> <span class="string">&quot;@/layout&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">path</span>: <span class="string">&quot;/roles&quot;</span>, <span class="comment">// 路由地址</span></span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;RoleManager&quot;</span>, <span class="comment">// --------------注意:这里的name属性的取值一定要与服务端返回的菜单权限的标识名称一致</span></span><br></pre></td></tr></table></figure>

<p>当然，在<code>系统中</code>也要把这些菜单权限都添加到系统中，然后给<code>某个角色</code>分配好，在把该角色分配给某个用户。</p>
<p>当用户登录以后，可以看到浏览器的控制台中打印了<code>routes</code>的内容。</p>
<p>在上面的<code>src/permission.js</code>文件中，我们已经能够获取到<code>筛选出来的动态路由了</code>。</p>
<p>下面要做的就是，把获取到的动态路由添加到路由表中。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!store.<span class="property">state</span>.<span class="property">user</span>.<span class="property">userInfo</span>.<span class="property">Id</span>)&#123;</span><br><span class="line">      <span class="keyword">const</span> &#123;roles&#125; =<span class="keyword">await</span> store.<span class="title function_">dispatch</span>(<span class="string">&quot;user/getUserInfo&quot;</span>);</span><br><span class="line">   <span class="comment">//   console.log(&#x27;roles===&#x27;,roles.menus)</span></span><br><span class="line">      <span class="comment">// 筛选用户的可用路由</span></span><br><span class="line">      <span class="keyword">const</span> routes = <span class="keyword">await</span> store.<span class="title function_">dispatch</span>(<span class="string">&#x27;permission/filterRoutes&#x27;</span>,roles.<span class="property">menus</span>);</span><br><span class="line">     <span class="comment">//  console.log(&#x27;routes===&#x27;,routes);</span></span><br><span class="line">     <span class="comment">// ----------------------------将动态路由添加到路由表中，路由表中默认情况下只有静态路由，没有动态路由。</span></span><br><span class="line">      <span class="comment">//router.addRoutes(routes);</span></span><br><span class="line">      routes.<span class="title function_">forEach</span>(<span class="function">(<span class="params">route</span>)=&gt;</span>&#123;</span><br><span class="line">       router.<span class="title function_">addRoute</span>(route);</span><br><span class="line">      &#125;)</span><br><span class="line">     <span class="comment">// next(to.path)</span></span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>

<h3 id="5、静态路由与动态路由解除合并"><a href="#5、静态路由与动态路由解除合并" class="headerlink" title="5、静态路由与动态路由解除合并"></a>5、静态路由与动态路由解除合并</h3><p>在上一小节中，我们调用了<code>addRoute</code>这个方法，进行了动态路由的添加，这样我们原来临时添加的动态路由就需要删除掉。</p>
<p>这里我们需要修改<code>src/router/index.js</code>文件中的代码，</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> router = <span class="title function_">createRouter</span>(&#123;</span><br><span class="line">  <span class="attr">history</span>: <span class="title function_">createWebHashHistory</span>(),</span><br><span class="line">  <span class="attr">routes</span>:[...constantRoutes,...asyncRoutes]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>在上面的代码中，我们将静态路由与动态路由进行了临时的合并。现在要把动态路由删除掉。</p>
<p>如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> router = <span class="title function_">createRouter</span>(&#123;</span><br><span class="line">  <span class="attr">history</span>: <span class="title function_">createWebHashHistory</span>(),</span><br><span class="line">  <span class="attr">routes</span>:[...constantRoutes]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里只有静态的路由，没有动态路由了。</p>
<p>返回到浏览器中进行刷新，发现左侧菜单只有首页了,即使我们当前登录的用户<code>zhangsan</code>有其他的菜单权限，但是在左侧也没有进行展示。</p>
<p>原因是什么呢？</p>
<p>我们首先来看一下左侧菜单的构建</p>
<p>左侧菜单的构建是在<code>src/layout/index.vue</code>这个组件中，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;template v-for=&quot;route in routes&quot; &gt;</span><br><span class="line">           &lt;el-menu-item v-if=&quot;!route.hidden &amp;&amp; route.children&quot; :index=&quot;route.path&quot; &gt;</span><br><span class="line">             &lt;el-icon&gt;&lt;SvgIcon :iconClass=&quot;route.children[0].meta.icon&quot;</span><br></pre></td></tr></table></figure>

<p>我们可以看到，这里通过循环的<code>routes</code>,来构建菜单。</p>
<p><code>routes</code>的定义如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">routes = <span class="title function_">computed</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">      <span class="keyword">return</span> router.<span class="property">options</span>.<span class="property">routes</span>;</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>

<p>现在的问题就是，前面我们通过调用<code>addRoute</code>方法动态添加的路由，这里并不会进行响应式的变化。</p>
<p>所以说，在通过调用了<code>addRoute</code>方法动态添加了路由以后，左侧菜单没有展示相应的内容。</p>
<p>怎样进行处理呢？</p>
<p>我们前面也讲过，当我们执行<code>src/store/modules/permission.js</code>文件中的<code>filterRoutes</code>方法进行路由过滤的时候，我们将过滤出来的动态路由保存到了<code>state</code>中的<code>routes</code>这个状态中了。保存到该状态中的目的就是给左侧菜单使用的。</p>
<p>问题是在<code>src/layout/index.vue</code>中怎样获取这个状态数据呢？</p>
<p>我们可以在<code>src/store/getters.js</code>文件中建立对应的快捷访问的方式：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> getters = &#123;</span><br><span class="line">    <span class="attr">token</span>: <span class="function">(<span class="params">state</span>) =&gt;</span> state.<span class="property">user</span>.<span class="property">token</span>,</span><br><span class="line">    <span class="attr">name</span>:<span class="function">(<span class="params">state</span>)=&gt;</span>state.<span class="property">user</span>.<span class="property">userInfo</span>.<span class="property">userName</span>,</span><br><span class="line">    <span class="attr">photoUrl</span>:<span class="function">(<span class="params">state</span>)=&gt;</span>state.<span class="property">user</span>.<span class="property">userInfo</span>.<span class="property">photoUrl</span>,</span><br><span class="line">    <span class="attr">routes</span>:<span class="function"><span class="params">state</span>=&gt;</span>state.<span class="property">permission</span>.<span class="property">routes</span><span class="comment">// 访问permission模块下的routes这个state状态数据</span></span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">export</span> <span class="keyword">default</span> getters;</span><br><span class="line">  </span><br></pre></td></tr></table></figure>

<p>上面代码建立了针对<code>routes</code>这个状态的快捷访问的方式。</p>
<p>下面返回到<code>src/layout/index.vue</code>组件中继续修改代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">routes = <span class="title function_">computed</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">     <span class="comment">//return router.options.routes;</span></span><br><span class="line">     <span class="keyword">return</span> store.<span class="property">getters</span>.<span class="property">routes</span>;</span><br><span class="line">   &#125;)</span><br></pre></td></tr></table></figure>

<p>这里是从<code>store</code>仓库的<code>getters</code>中的<code>routes</code>来获取动态的路由。</p>
<p>返回到浏览器中进行刷新。可以看到对应的效果</p>
<p>这样就完成了菜单权限的过滤。</p>
<p>这里可以登录具有不同角色的用户进行测试。</p>
<p>当然，在测试的时候，可以给不同不同的角色分配相同的权限，例如给经理和组长两个角色都分配员工管理的权限</p>
<p>然后给王五这个用户都分配经理和组长两个角色。</p>
<p>当以王五这个账号进行登录的时候，发现左侧菜单中显示了两个<code>员工管理</code>菜单。</p>
<p>造成这种情况的问题是：服务端在根据角色获取权限的标识的时候没有进行去重的操作。</p>
<p>所以在<code>UserInfoService.cs</code>这个服务类中的<code>GetUserPermissionCodes</code>方法中，</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Dictionary&lt;<span class="built_in">string</span>,List&lt;<span class="built_in">string</span>&gt;&gt;dict =<span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>,List&lt;<span class="built_in">string</span>&gt;&gt;();</span><br><span class="line">           dict.Add(<span class="string">&quot;menus&quot;</span>, menus.Distinct().ToList()); <span class="comment">// 对menus这个list集合进行去重。以下也是一样的</span></span><br><span class="line">           dict.Add(<span class="string">&quot;points&quot;</span>, points.Distinct().ToList());</span><br><span class="line">           dict.Add(<span class="string">&quot;apis&quot;</span>,apis.Distinct().ToList());</span><br></pre></td></tr></table></figure>

<p>对相关的数据进行去重的操作。</p>
<p>重新返回到浏览器中进行测试。</p>
<p>当然，现在遇到了另外一个问题，就是刷新浏览器的时候，会出现404的情况，关于这个问题我们后面再来解决。</p>
<h3 id="6、退出登录重置路由权限与404问题"><a href="#6、退出登录重置路由权限与404问题" class="headerlink" title="6、退出登录重置路由权限与404问题"></a>6、退出登录重置路由权限与404问题</h3><h5 id="6-1-退出登录重置路由"><a href="#6-1-退出登录重置路由" class="headerlink" title="6.1  退出登录重置路由"></a>6.1  退出登录重置路由</h5><p>在解决404问题之前，我们先来看一下关于退出登录后重置路由权限的问题。</p>
<p>我们知道用户登录的时候，会执行前端项目中的<code>src/permission.js</code>文件中的如下代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将动态路由添加到路由表中，路由表中默认情况下只有静态路由，没有动态路由。</span></span><br><span class="line">       <span class="comment">//router.addRoutes(routes);</span></span><br><span class="line">       routes.<span class="title function_">forEach</span>(<span class="function">(<span class="params">route</span>)=&gt;</span>&#123;</span><br><span class="line">        router.<span class="title function_">addRoute</span>(route);</span><br><span class="line">       &#125;)</span><br></pre></td></tr></table></figure>

<p>也就是调用<code>addRoute</code>这个方法动态的添加路由，但是问题时，用户退出登录的时候，没有移除所添加的动态路由。</p>
<p>下面首先修改<code>router/index.js</code>文件中的代码，如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 重置路由</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">resetRouter</span>(<span class="params"></span>)&#123;</span><br><span class="line">   <span class="keyword">const</span> newRouter = <span class="title function_">createRouter</span>(&#123;</span><br><span class="line">     <span class="attr">history</span>: <span class="title function_">createWebHashHistory</span>(),</span><br><span class="line">    <span class="attr">routes</span>:[...constantRoutes]&#125;</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// matcher就是路由表的数据</span></span><br><span class="line">    <span class="comment">// 这里是将新路由的数据赋值给了整个原有router,也就是把路由数据还原成最初的状态。</span></span><br><span class="line">    <span class="comment">// 路由的最初状态只有静态路由。</span></span><br><span class="line">    router.<span class="property">matcher</span> = newRouter.<span class="property">matcher</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router</span><br></pre></td></tr></table></figure>

<p>这里我们创建了一个<code>resetRouter</code>方法，在该方法中通过<code>createRouter</code>方法又重新创建了一个路由对象，然后将新路由对象中的信息重新赋值给了原有<code>router</code>路由对象。完成了路由信息的重置操作。</p>
<p>问题：在哪调用该<code>resetRouter</code>方法呢？</p>
<p>在退出登录的时候调用</p>
<p>下面修改<code>store/modules/user.js</code>文件中的代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 用户退出</span></span><br><span class="line">   <span class="title function_">logout</span>(<span class="params">context</span>)&#123;</span><br><span class="line">     <span class="comment">// 删除token信息</span></span><br><span class="line">     context.<span class="title function_">commit</span>(<span class="string">&quot;removeToken&quot;</span>);</span><br><span class="line">     <span class="comment">// 删除用户信息</span></span><br><span class="line">     context.<span class="title function_">commit</span>(<span class="string">&quot;removeUserInfo&quot;</span>);</span><br><span class="line">     <span class="comment">// 删除本地存储的手机号</span></span><br><span class="line">     <span class="variable language_">localStorage</span>.<span class="title function_">removeItem</span>(<span class="string">&quot;userPhone&quot;</span>);</span><br><span class="line">     <span class="comment">// 重置路由</span></span><br><span class="line">     <span class="title function_">resetRouter</span>();</span><br></pre></td></tr></table></figure>

<p>在<code>user.js</code>这个模块中，我们实现了<code>logout</code>这个<code>actions</code>方法，该方法在单击<code>退出</code>按钮的时候，会被调用。</p>
<p>所以在这<code>logout</code>方法中完成对<code>resetRouter</code>方法的调用。</p>
<p>重置了路由的信息以后，还有一个问题：</p>
<p>这里还需要将<code>store/permission.js</code>模块中，用来保存路由信息的routes这个state状态还需要清空.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 用户退出</span></span><br><span class="line">   <span class="title function_">logout</span>(<span class="params">context</span>)&#123;</span><br><span class="line">     <span class="comment">// 删除token信息</span></span><br><span class="line">     context.<span class="title function_">commit</span>(<span class="string">&quot;removeToken&quot;</span>);</span><br><span class="line">     <span class="comment">// 删除用户信息</span></span><br><span class="line">     context.<span class="title function_">commit</span>(<span class="string">&quot;removeUserInfo&quot;</span>);</span><br><span class="line">     <span class="comment">// 删除本地存储的手机号</span></span><br><span class="line">     <span class="variable language_">localStorage</span>.<span class="title function_">removeItem</span>(<span class="string">&quot;userPhone&quot;</span>);</span><br><span class="line">     <span class="comment">// 重置路由</span></span><br><span class="line">     <span class="title function_">resetRouter</span>();</span><br><span class="line">     <span class="comment">// 这里还需要将`store/permission.js`模块中，用来保存路由信息的routes这个state状态还需要清空.</span></span><br><span class="line">     <span class="comment">// 问题是：Vuex某个子模块怎样去调用其他子模块中的`action`或者是mutations方法呢？</span></span><br><span class="line">     <span class="comment">// 如果模块都没有添加命名空间，所有的mutations和action都是挂在全局上的，所以可以直接调用</span></span><br><span class="line">     <span class="comment">// 但是子模块添加了命名空间以后，怎样调用另外一个添加了命名空间的子模块的mutations或者是actions.</span></span><br><span class="line">     <span class="comment">// 添加了命名空间以后，context对象指的不是全局的context对象,而是当前的模块的context对象。</span></span><br><span class="line">     <span class="comment">// 这里我们添加了第三个参数，第三个参数是一个对象，表示返回到根模块，也就是返回到了`store/index`</span></span><br><span class="line">     <span class="comment">// 在根模块中可以调用对应的`mutaionts`或者是action方法，但是在根下面没有setRoutes这个方法，所以前面要加上对应的模块名称，也就说，这里我们先返回到根模块，然后找到根模块中所引入的permission模块，调用permission这个子模块中的setRoutes方法，给该方法传递的参数是空数组，从而将permission这个子模块中的routes这个state状态的值设置为空数组，从而完成了`routes`的清空操作。</span></span><br><span class="line">     context.<span class="title function_">commit</span>(<span class="string">&#x27;permission/setRoutes&#x27;</span>,[],&#123;<span class="attr">root</span>:<span class="literal">true</span>&#125;);</span><br><span class="line">    </span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>在调用完了<code>resetRouter</code>方法以后，需要调用<code>permission</code>这个模块中的<code>setRoutes</code>这个<code>mutations</code>方法，完成<code>routes</code>这个<code>state</code>状态数据的清空操作。</p>
<h5 id="6-2-解决404问题"><a href="#6-2-解决404问题" class="headerlink" title="6.2  解决404问题"></a>6.2  解决404问题</h5><p>在前面我们也提到过，当登录成功以后，刷新浏览器会出现404的问题。在这一小节中，我们来看一下怎样解决404的问题。</p>
<p>我们知道关于404,是我们在路由中进行了如下的配置。</p>
<p>查看<code>router/index.js</code>文件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">path</span>: <span class="string">&quot;/:pathMatch(.*)*&quot;</span>, <span class="comment">// 没有其他的路由规则相匹配</span></span><br><span class="line">   <span class="attr">redirect</span>: <span class="string">&quot;/404&quot;</span>,</span><br><span class="line"> &#125;,</span><br></pre></td></tr></table></figure>

<p>如果没有其他的路由规则进行匹配，会跳转到<code>/404</code>.</p>
<p>但是，问题是，以上配置必须放在所有路由规则的最后。</p>
<p>我们看到，以上路由规则并没有放在其他路由规则的最后，后面还有一个<code>about</code>的路由规则，当然<code>about</code>这个路由规则这里我们使用不到，可以删除。</p>
<p>但是删除以后，单击了某个菜单项以后，重新刷新浏览器还是不行。</p>
<p>原因是：这里我们添加的以上404的路由规则是在整个路由规则的最后吗？</p>
<p>不是的，因为以上添加的404路由规则是在静态路由规则的最后，但是不是在动态路由规则的最后。</p>
<p>所以这里我们需要修改<code>src/permission.js</code>文件中的代码，如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">routes.<span class="title function_">forEach</span>(<span class="function">(<span class="params">route</span>)=&gt;</span></span><br><span class="line">      &#123;</span><br><span class="line">         router.<span class="title function_">addRoute</span>(route);</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      router.<span class="title function_">addRoute</span>( &#123;</span><br><span class="line">       <span class="attr">path</span>: <span class="string">&quot;/:pathMatch(.*)*&quot;</span>, <span class="comment">// 没有其他的路由规则相匹配</span></span><br><span class="line">       <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&quot;@/views/404.vue&quot;</span>),</span><br><span class="line">     &#125;);</span><br></pre></td></tr></table></figure>

<p>在上面的代码中，我们是将其他的动态路由添加完毕以后，再去添加<code>404</code>对应的路由规则。</p>
<p>这时候，我们需要把<code>router/index.js</code>文件中定义的<code>404</code>路由规则注释掉。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!store.<span class="property">state</span>.<span class="property">user</span>.<span class="property">userInfo</span>.<span class="property">id</span>)&#123; <span class="comment">// --------------------------注意,这里的id是小写的，前面我们写错了，这里需要改正</span></span><br><span class="line">      </span><br><span class="line">              <span class="keyword">const</span> &#123;roles&#125; =<span class="keyword">await</span> store.<span class="title function_">dispatch</span>(<span class="string">&quot;user/getUserInfo&quot;</span>);</span><br><span class="line">             </span><br><span class="line">   </span><br><span class="line">       <span class="comment">// 筛选用户的可用路由</span></span><br><span class="line">       <span class="keyword">const</span> routes = <span class="keyword">await</span> store.<span class="title function_">dispatch</span>(<span class="string">&#x27;permission/filterRoutes&#x27;</span>,roles.<span class="property">menus</span>);</span><br><span class="line"> </span><br><span class="line">      <span class="comment">// 将动态路由添加到路由表中，路由表中默认情况下只有静态路由，没有动态路由。</span></span><br><span class="line">       <span class="comment">//router.addRoutes(routes);</span></span><br><span class="line">       routes.<span class="title function_">forEach</span>(<span class="function">(<span class="params">route</span>)=&gt;</span></span><br><span class="line">       &#123;</span><br><span class="line">          router.<span class="title function_">addRoute</span>(route);</span><br><span class="line">       &#125;)</span><br><span class="line"> </span><br><span class="line">       router.<span class="title function_">addRoute</span>( &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&quot;/:pathMatch(.*)*&quot;</span>, <span class="comment">// 没有其他的路由规则相匹配</span></span><br><span class="line">        <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&quot;@/views/404.vue&quot;</span>),</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="title function_">next</span>(to.<span class="property">path</span>); <span class="comment">//----------------------------------------跳转到对应的地址</span></span><br><span class="line">      <span class="comment">// next(&#123;</span></span><br><span class="line">      <span class="comment">//   path:`$&#123;to.path&#125;`</span></span><br><span class="line">      <span class="comment">// &#125;);</span></span><br><span class="line">     </span><br><span class="line">      <span class="comment">// next(to.path)</span></span><br><span class="line">      &#125;<span class="keyword">else</span>&#123; <span class="comment">//--------------------------------这里添加了elese</span></span><br><span class="line">        <span class="title function_">next</span>(); <span class="comment">// 放行</span></span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>在上面的代码中，我们修改了判断条件,原来是对<code>Id</code>进行判断的，但是这里应该是<code>id</code>，注意大小写。</p>
<p>同时，在添加了404的路由规则以后，直接通过<code>next(to.path)</code>跳转到对应的页面，否则（这里添加了<code>else</code>）直接放行，也就是说有用户数据了直接放行，不需要在重新请求服务端获取用户数据。</p>
<p>这里将其逻辑结构做了一定的调整。</p>
<h3 id="7、功能权限判断"><a href="#7、功能权限判断" class="headerlink" title="7、功能权限判断"></a>7、功能权限判断</h3><p>在服务端返回的<code>roles</code>数据中，有一个<code>points</code>属性，该属性中存储的标识，表示的就是登录用户具有的功能权限，也就是按钮权限。</p>
<p>下面我们看一下怎样使用<code>points</code>属性中的数据来进行功能权限的判断。</p>
<p>这里我们先来修改<code>store/modules/user.js</code>文件中的代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">setUserInfo</span>(<span class="params">state,payload</span>)&#123;</span><br><span class="line">   <span class="keyword">const</span> &#123;user,roles &#125; =payload</span><br><span class="line"> </span><br><span class="line">     state.<span class="property">userInfo</span> = user;</span><br><span class="line">     state.<span class="property">userPermission</span> =roles;</span><br><span class="line">   &#125;,</span><br></pre></td></tr></table></figure>

<p>在<code>setUserInfo</code>这个<code>mutations</code>方法中，我们已经将服务端返回的<code>user</code>和<code>roles</code>数据给解构出来了。</p>
<p>我们知道<code>roles</code>中存储了对应的<code>points</code>，这里将<code>roles</code>直接赋值给了<code>userPermission</code>这个状态属性。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">state</span>(<span class="params"></span>) &#123;</span><br><span class="line">   <span class="keyword">return</span> &#123;</span><br><span class="line">     <span class="attr">token</span>: <span class="title function_">getTokenInfo</span>(), <span class="comment">// 获取token信息，初始化vuex</span></span><br><span class="line">     <span class="attr">userInfo</span>:&#123;&#125;,</span><br><span class="line">     <span class="attr">userPermission</span>:&#123;&#125; <span class="comment">// --------------这里定义了userPermission这个状态属性</span></span><br><span class="line">   &#125;;</span><br></pre></td></tr></table></figure>

<p>然后在<code>src</code>目录下面创建<code>checkPermission</code>文件夹，在该文件夹中创建<code>index.js</code>文件，该文件中的代码如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> store <span class="keyword">from</span> <span class="string">&#x27;@/store&#x27;</span></span><br><span class="line"><span class="comment">// 参数key就是权限的标识</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">checkPermission</span>(<span class="params">key</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;userPermission&#125; = store.<span class="property">state</span>.<span class="property">user</span>;</span><br><span class="line">    <span class="comment">// console.log(&quot;userInfo=&quot;,userPermission);</span></span><br><span class="line">    <span class="keyword">if</span>(userPermission.<span class="property">points</span>&amp;&amp;userPermission.<span class="property">points</span>.<span class="property">length</span>&gt;<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> result = userPermission.<span class="property">points</span>.<span class="title function_">some</span>(<span class="function"><span class="params">item</span>=&gt;</span>item === key);</span><br><span class="line">       <span class="comment">// console.log(&#x27;resultaaaa=&#x27;,result);</span></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// 如果没有points数组，或者是该数组中是空，直接返回false.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里创建了<code>checkPermission</code>方法，当调用该方法的时候，会传递一个参数<code>key</code>，表示的就是登录用户所具有的功能权限的标识。</p>
<p>然后看一下是否在<code>userPermission</code>状态中的<code>points</code>数组中存在，如果存在返回<code>true</code>，否则返回的是<code>false</code>.</p>
<p>下面我们就可以在组件中调用<code>checkPermission</code>方法来进行功能权限的校验。</p>
<p>例如，我们在<code>views/employees/index.vue</code>这个组件中进行测试</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">AddEmployee</span> <span class="keyword">from</span> <span class="string">&quot;./components/add-employee.vue&quot;</span>;</span><br><span class="line">  <span class="keyword">import</span> &#123;checkPermission &#125; <span class="keyword">from</span> <span class="string">&#x27;@/checkPermission/index&#x27;</span> <span class="comment">// 导入</span></span><br></pre></td></tr></table></figure>

<p>这里导入了<code>checkPermission</code>这个方法，</p>
<p>当然，也需要返回。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">     loading,</span><br><span class="line">     list,</span><br><span class="line">     page,</span><br><span class="line">     handleCurrentChange,</span><br><span class="line">     formatTimeOfEntry,</span><br><span class="line">     showAddDialog,</span><br><span class="line">     updatedialog,</span><br><span class="line">     loadEmployeeList,</span><br><span class="line">     showRoleDialog,</span><br><span class="line">     btnRole,</span><br><span class="line">     ...<span class="title function_">toRefs</span>(roles),</span><br><span class="line">     roleIdList,</span><br><span class="line">     btnRoleOk,</span><br><span class="line">     checkPermission <span class="comment">// 返回checkPermission方法</span></span><br><span class="line">   &#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;template  #after &gt;</span><br><span class="line">       <span class="language-xml"><span class="tag">&lt;<span class="name">el-button</span> <span class="attr">size</span>=<span class="string">&quot;small&quot;</span> <span class="attr">type</span>=<span class="string">&quot;primary&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;showAddDialog=true&quot;</span> <span class="attr">:disabled</span>=<span class="string">&quot;!checkPermission(&#x27;UserAdd&#x27;)&quot;</span>&gt;</span>新增员工<span class="tag">&lt;/<span class="name">el-button</span>&gt;</span></span></span><br><span class="line">     &lt;/template&gt;</span><br></pre></td></tr></table></figure>

<p>这里在模版中，找到<code>新增员工</code>这个按钮，给其添加了<code>disabled</code>属性（这里由于使用了<code>elementplus</code>组件，所以要查看一下文档不同组件禁用的属性是哪一个），该属性的取值如果是<code>true</code>会禁用按钮，所以这里该属性的值就是<code>checkPermission</code>方法返回的值，当然需要取反。</p>
<p>同时在调用<code>checkPermission</code>方法的时候，需要传递<code>UserAdd</code>这个标识，具有这个标识表示的就是登录的用户具有添加员工的权限。</p>
<p><code>UserAdd</code>这个标识，可以从服务端返回的数据中查看到</p>
<p>首先以管理员登录，然后给某个用户分配角色，在给改角色分配指定的<code>员工管理</code>这个菜单权限，然后在分配<code>添加员工</code>这个功能权限，最后以该用户进行登录，查看（后面再禁用<code>添加员工</code>这个功能权限，在让该用户进行登录来查看一下效果）。</p>
<p>后面可以在其他所有的组件中，给对应的按钮指定<code>checkPermission</code>方法，当然，在调用该方法的时候，注意一定要传递正确的功能权限的标识。</p>
<h3 id="8、api权限校验"><a href="#8、api权限校验" class="headerlink" title="8、api权限校验"></a>8、<code>api</code>权限校验</h3><p>前面我们已经实现了菜单权限，功能权限的过滤，在这一小节中，我们来看一下<code>api</code>权限的校验。</p>
<p>这里我们列举一个场景：</p>
<p>例如：用户添加,假如某个登录用户没有这个权限，对应的该按钮是不可用，或者是隐藏的。</p>
<p>但是该用户如果知道了，用户添加的访问接口地址，是不是就可以直接访问了，所以这里我们也需要对<code>api</code>接口进行权限的校验。</p>
<p>怎样对<code>api</code>接口的权限进行校验呢？</p>
<p>这里需要使用到<code>Filter</code>过滤器。</p>
<p>我们可以实现<code>ActionFilter</code>，这样就可以保证，在请求服务端的接口，执行具体的<code>api</code>方法之前，先执行该改过滤器，在该改过滤器中，判断用户是否具有访问<code>api</code>接口的权限。</p>
<p>在<code>Cms.WebApi</code>这个项目中的<code>Filters</code>文件夹中，创建<code>ApiPermissionCheckFilter.cs</code>这个类，该类中的代码如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Cms.IService;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc.Filters;</span><br><span class="line"><span class="keyword">using</span> System.IdentityModel.Tokens.Jwt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Cms.WebApi.Filters</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ApiPermissionCheckFilter</span>: <span class="title">IAsyncActionFilter</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 通过`ApiPermissionCheckFilter`构造方法实现对`IUserInfoService`用户服务的注入</span></span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">readonly</span>  IUserInfoService _userInfoService;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ApiPermissionCheckFilter</span>(<span class="params">IUserInfoService userInfoService</span>)</span> &#123; </span><br><span class="line">          <span class="keyword">this</span>._userInfoService = userInfoService;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">OnActionExecutionAsync</span>(<span class="params">ActionExecutingContext context, ActionExecutionDelegate next</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 这里通过HttpContext接收前端发送过来的请求头中的Authorization信息。</span></span><br><span class="line">            <span class="comment">// 我们知道Authorization中保存了token信息，而token信息中含有用户的编号，这里根据用户的编号查询用户，然后查询用户具有的角色，在通过角色查询用户具有的api权限，查询出用户具有的api权限以后，判断用户当前请求的api接口是否在用户所具有的api权限中，如果在则允许访问，否则给出相应的错误提示。</span></span><br><span class="line">           <span class="keyword">var</span> authorization = context.HttpContext.Request.Headers[<span class="string">&quot;Authorization&quot;</span>];</span><br><span class="line">            <span class="keyword">if</span> (authorization.Count&gt;<span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 这里需要注意的是，我们前面约定了token信息中包含Bearer （这里是空格）前缀，所以这里需要进行分割，获取真正的token数据。</span></span><br><span class="line">              <span class="keyword">var</span> token =  authorization[<span class="number">0</span>]!.ToString().Split(<span class="string">&quot;Bearer &quot;</span>);</span><br><span class="line">                <span class="comment">// 这里读取token信息（可以打上断点，查看具体的值）</span></span><br><span class="line">                <span class="keyword">var</span> tokenInfo = <span class="keyword">new</span> JwtSecurityTokenHandler().ReadJwtToken(token[<span class="number">1</span>]);</span><br><span class="line">                <span class="comment">// Claims中存储的第一个就是用户的编号</span></span><br><span class="line">               <span class="keyword">var</span> info = tokenInfo.Claims.FirstOrDefault();</span><br><span class="line">               <span class="keyword">var</span> userInfo = _userInfoService.LoadEntities(u=&gt;u.Id.ToString()==info!.Value).include().toList();</span><br><span class="line">                userInfo.RoleInfos</span><br><span class="line">                <span class="comment">// 根据用户查询角色，角色找权限，权限表找api权限。List</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 根据请求的地址和请求的方式，查询api权限表，可以找到具体的记录，然后看一下该记录是否在上面的list集合中存在，如果存在，放行。</span></span><br><span class="line">                <span class="keyword">var</span> url = context.HttpContext.Request.Path; <span class="comment">// 获取用户请求的接口地址</span></span><br><span class="line">                <span class="keyword">var</span> method = context.HttpContext.Request.Method; <span class="comment">// 获取接口请求的方式</span></span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">             </span><br><span class="line"></span><br><span class="line">            <span class="keyword">await</span> next();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在上面的代码中，我们没有实现完整的代码，但是实现思路已经理清楚了，大家可以自己实现代码。</p>
<p>其实代码我们前面也已经讲过。</p>
<p>当然，我们还需要注入该<code>Filter</code>.</p>
<p>修改<code>Program.cs</code>文件中的代码，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 完成Filter的注册</span></span><br><span class="line">builder.Services.Configure&lt;MvcOptions&gt;(c =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    c.Filters.Add&lt;ApiPermissionCheckFilter&gt;(); <span class="comment">// 这里注册了ApiPermissionCheckFilter</span></span><br><span class="line">    c.Filters.Add&lt;UnitOfWorkFilter&gt;();</span><br><span class="line">   </span><br></pre></td></tr></table></figure>

<p>关于<code>api</code>权限的存储问题，在数据库中我们单独的创建了一张表来存储<code>api</code>权限。</p>
<p>问题：怎样向该表中添加<code>api</code>权限呢？</p>
<p>我们在前端没有提供添加<code>api</code>权限的表单，当然，这里可以提供。</p>
<p>或者是，我们可以将<code>api</code>权限（<code>api</code>地址）写到一个<code>Excel</code>表格中，最后读取该<code>Excel</code>文件，批量进行导入。</p>
<p><code>.net core</code>读取<code>Excel</code> 文件，参考：<code>EPPlus</code>开源组件，</p>
<p>同时还要注意：一些<code>api</code>接口的权限是所有用户都具有的，例如:登录，所以需要进行判断。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://www.kilgour.top">kilgour</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://www.kilgour.top/2024/08/02/%E8%80%81%E7%8E%8B-20%E3%80%81%E4%BA%BA%E5%8A%9B%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E9%A1%B9%E7%9B%AE/">http://www.kilgour.top/2024/08/02/%E8%80%81%E7%8E%8B-20%E3%80%81%E4%BA%BA%E5%8A%9B%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E9%A1%B9%E7%9B%AE/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://www.kilgour.top" target="_blank">Kilgour Notes</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://raw.githubusercontent.com/kilg0ur/picture/master/picture/cover8.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/08/10/%E6%8A%80%E6%9C%AF%E6%A0%88/" title=""><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/kilg0ur/picture/master/picture/cover3.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info"></div></div></a></div><div class="next-post pull-right"><a href="/2024/07/27/%E8%80%81%E7%8E%8B-19%E3%80%81Vue-%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF/" title=""><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/kilg0ur/picture/master/picture/cover17.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info"></div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/5.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">kilgour</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">35</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/kilg0ur"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">欢迎来到我的博客！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%BA%E5%8A%9B%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E9%A1%B9%E7%9B%AE"><span class="toc-number">1.</span> <span class="toc-text">人力资源管理项目</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE%E6%90%AD%E5%BB%BA"><span class="toc-number">1.1.</span> <span class="toc-text">一、前端项目搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E6%90%AD%E5%BB%BA%E9%A1%B9%E7%9B%AE%E5%89%8D%E7%9A%84%E4%B8%80%E4%BA%9B%E5%9F%BA%E6%9C%AC%E5%87%86%E5%A4%87"><span class="toc-number">1.2.</span> <span class="toc-text">1、搭建项目前的一些基本准备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E4%BD%BF%E7%94%A8%E8%84%9A%E6%89%8B%E6%9E%B6%E6%90%AD%E5%BB%BAVue3%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83"><span class="toc-number">1.3.</span> <span class="toc-text">2、使用脚手架搭建Vue3开发环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81API%E6%A8%A1%E5%9D%97%E5%92%8C%E8%AF%B7%E6%B1%82%E5%B0%81%E8%A3%85%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.4.</span> <span class="toc-text">3、API模块和请求封装模块介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97"><span class="toc-number">1.5.</span> <span class="toc-text">二、登录模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E7%99%BB%E5%BD%95%E5%B8%83%E5%B1%80%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.5.1.</span> <span class="toc-text">1、登录布局实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E8%A1%A8%E5%8D%95%E6%A0%A1%E9%AA%8C"><span class="toc-number">1.5.2.</span> <span class="toc-text">2、表单校验</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">1.5.3.</span> <span class="toc-text">3、服务端环境搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%99%BB%E5%BD%95%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91"><span class="toc-number">1.5.4.</span> <span class="toc-text">4、服务端登录接口开发</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81%E5%89%8D%E7%AB%AF%E2%80%93%E5%B0%81%E8%A3%85%E5%8D%95%E7%8B%AC%E7%9A%84%E7%99%BB%E5%BD%95%E6%8E%A5%E5%8F%A3"><span class="toc-number">1.5.5.</span> <span class="toc-text">5、前端–封装单独的登录接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81Vuex%E4%B8%AD%E5%AF%B9token%E8%BF%9B%E8%A1%8C%E7%AE%A1%E7%90%86"><span class="toc-number">1.5.6.</span> <span class="toc-text">6、Vuex中对token进行管理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7%E3%80%81%E5%88%9B%E5%BB%BA%E7%99%BB%E5%BD%95%E7%9A%84Action"><span class="toc-number">1.5.7.</span> <span class="toc-text">7、创建登录的Action</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8%E3%80%81%E5%AE%8C%E5%96%84axios%E9%85%8D%E7%BD%AE"><span class="toc-number">1.5.8.</span> <span class="toc-text">8、完善axios配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#8-1-%E5%8C%BA%E5%88%86axios%E5%9C%A8%E4%B8%8D%E5%90%8C%E7%8E%AF%E5%A2%83%E4%B8%AD%E7%9A%84%E8%AF%B7%E6%B1%82%E5%9C%B0%E5%9D%80"><span class="toc-number">1.5.8.1.</span> <span class="toc-text">8.1  区分axios在不同环境中的请求地址</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-2-%E5%93%8D%E5%BA%94%E6%8B%A6%E6%88%AA%E5%99%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">1.5.8.2.</span> <span class="toc-text">8.2 响应拦截器配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9%E3%80%81%E5%AE%9E%E7%8E%B0%E7%99%BB%E5%BD%95"><span class="toc-number">1.5.9.</span> <span class="toc-text">9、实现登录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10%E3%80%81%E8%B7%A8%E5%9F%9F"><span class="toc-number">1.5.10.</span> <span class="toc-text">10、跨域</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11%E3%80%81Loading%E6%95%88%E6%9E%9C%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.5.11.</span> <span class="toc-text">11、Loading效果实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E4%B8%BB%E9%A1%B5%E6%A8%A1%E5%9D%97"><span class="toc-number">1.6.</span> <span class="toc-text">三、主页模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E4%B8%BB%E9%A1%B5%E7%9A%84token%E6%8B%A6%E6%88%AA%E5%A4%84%E7%90%86"><span class="toc-number">1.6.1.</span> <span class="toc-text">1、主页的token拦截处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E4%B8%BB%E9%A1%B5%E5%B8%83%E5%B1%80%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.6.2.</span> <span class="toc-text">2、主页布局实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E8%B5%84%E6%96%99%E4%BF%A1%E6%81%AF-%E5%89%8D%E7%AB%AF%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.6.3.</span> <span class="toc-text">3、获取用户资料信息-前端实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E8%B5%84%E6%96%99%E4%BF%A1%E6%81%AF2-%E5%89%8D%E7%AB%AF%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.6.4.</span> <span class="toc-text">4、获取用户资料信息2-前端实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E8%B5%84%E6%96%99%E4%BF%A1%E6%81%AF3%E2%80%93%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%8E%A5%E5%8F%A3%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.6.5.</span> <span class="toc-text">5、获取用户资料信息3–服务端接口实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81%E5%B1%95%E7%A4%BA%E7%94%A8%E6%88%B7%E5%A4%B4%E5%83%8F"><span class="toc-number">1.6.6.</span> <span class="toc-text">6、展示用户头像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7%E3%80%81%E7%94%A8%E6%88%B7%E9%80%80%E5%87%BA%E7%99%BB%E5%BD%95"><span class="toc-number">1.6.7.</span> <span class="toc-text">7、用户退出登录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8%E3%80%81Token%E5%A4%B1%E6%95%88%E7%9A%84%E5%A4%84%E7%90%86"><span class="toc-number">1.6.8.</span> <span class="toc-text">8、Token失效的处理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E8%B7%AF%E7%94%B1%E4%B8%8E%E8%8F%9C%E5%8D%95%E6%A8%A1%E5%9D%97"><span class="toc-number">1.7.</span> <span class="toc-text">四、路由与菜单模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E8%B7%AF%E7%94%B1%E8%AF%B4%E6%98%8E"><span class="toc-number">1.7.1.</span> <span class="toc-text">1、路由说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE%E6%A8%A1%E5%9D%97%E8%AF%B4%E6%98%8E"><span class="toc-number">1.7.2.</span> <span class="toc-text">2、前端项目模块说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E8%AE%BE%E7%BD%AE%E6%AF%8F%E4%B8%AA%E6%A8%A1%E5%9D%97%E7%9A%84%E8%B7%AF%E7%94%B1%E8%A7%84%E5%88%99"><span class="toc-number">1.7.3.</span> <span class="toc-text">3、设置每个模块的路由规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E8%B7%AF%E7%94%B1%E5%90%88%E5%B9%B6"><span class="toc-number">1.7.4.</span> <span class="toc-text">4、路由合并</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81%E8%8F%9C%E5%8D%95%E5%B1%95%E7%A4%BA"><span class="toc-number">1.7.5.</span> <span class="toc-text">5、菜单展示</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81%E8%8F%9C%E5%8D%95%E5%9B%BE%E6%A0%87%E5%A4%84%E7%90%86"><span class="toc-number">1.7.6.</span> <span class="toc-text">6、菜单图标处理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E7%BB%84%E7%BB%87%E6%9E%B6%E6%9E%84%E6%A8%A1%E5%9D%97"><span class="toc-number">1.8.</span> <span class="toc-text">五、组织架构模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E7%BB%84%E7%BB%87%E6%9E%B6%E6%9E%84%E7%AE%80%E4%BB%8B"><span class="toc-number">1.8.1.</span> <span class="toc-text">1、组织架构简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E7%BB%84%E7%BB%87%E6%9E%B6%E6%9E%84%E5%A4%B4%E9%83%A8%E5%B8%83%E5%B1%80"><span class="toc-number">1.8.2.</span> <span class="toc-text">2、组织架构头部布局</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E6%A0%91%E5%BD%A2%E7%BB%84%E4%BB%B6%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="toc-number">1.8.3.</span> <span class="toc-text">3、树形组件基本使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E6%A0%91%E5%BD%A2%E7%BB%84%E4%BB%B6%E6%9E%84%E5%BB%BA%E7%BB%84%E7%BB%87%E6%9E%B6%E6%9E%84"><span class="toc-number">1.8.4.</span> <span class="toc-text">4、树形组件构建组织架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81%E5%B0%86%E6%A0%91%E5%BD%A2%E7%BB%93%E6%9E%84%E5%8D%95%E7%8B%AC%E5%B0%81%E8%A3%85%E6%88%90%E7%BB%84%E4%BB%B6"><span class="toc-number">1.8.5.</span> <span class="toc-text">5、将树形结构单独封装成组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81%E9%83%A8%E9%97%A8%E6%A8%A1%E5%9E%8B%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.8.6.</span> <span class="toc-text">6、部门模型设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7%E3%80%81%E8%8E%B7%E5%8F%96%E9%83%A8%E9%97%A8%E4%BF%A1%E6%81%AF%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.8.7.</span> <span class="toc-text">7、获取部门信息接口设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8%E3%80%81%E5%89%8D%E7%AB%AF%E8%8E%B7%E5%8F%96%E7%BB%84%E7%BB%87%E6%9E%B6%E6%9E%84%E6%95%B0%E6%8D%AE"><span class="toc-number">1.8.8.</span> <span class="toc-text">8、前端获取组织架构数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9%E3%80%81%E5%B0%86%E6%95%B0%E7%BB%84%E8%BD%AC%E6%8D%A2%E6%88%90%E6%A0%91%E5%BD%A2%E7%BB%93%E6%9E%84"><span class="toc-number">1.8.9.</span> <span class="toc-text">9、将数组转换成树形结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10%E3%80%81%E5%88%A0%E9%99%A4%E9%83%A8%E9%97%A8%E4%BF%A1%E6%81%AF%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.8.10.</span> <span class="toc-text">10、删除部门信息接口设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11%E3%80%81%E5%88%A0%E9%99%A4%E9%83%A8%E9%97%A8%E5%8A%9F%E8%83%BD%E2%80%93%E5%89%8D%E7%AB%AF%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.8.11.</span> <span class="toc-text">11、删除部门功能–前端实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12%E3%80%81%E5%88%A0%E9%99%A4%E9%83%A8%E9%97%A8%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0%E2%80%93%E5%89%8D%E7%AB%AF%E5%AE%9E%E7%8E%B02"><span class="toc-number">1.8.12.</span> <span class="toc-text">12、删除部门功能实现–前端实现2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13%E3%80%81%E6%96%B0%E5%A2%9E%E9%83%A8%E9%97%A8%E2%80%93%E5%B1%95%E7%A4%BA%E5%BC%B9%E5%87%BA%E5%B1%82"><span class="toc-number">1.8.13.</span> <span class="toc-text">13、新增部门–展示弹出层</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#14%E3%80%81%E6%96%B0%E5%A2%9E%E9%83%A8%E9%97%A8%E2%80%93%E6%8E%A7%E5%88%B6%E5%BC%B9%E5%87%BA%E5%B1%82%E6%98%BE%E7%A4%BA%E4%B8%8E%E9%9A%90%E8%97%8F"><span class="toc-number">1.8.14.</span> <span class="toc-text">14、新增部门–控制弹出层显示与隐藏</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15%E3%80%81%E6%96%B0%E5%A2%9E%E9%83%A8%E9%97%A8%E2%80%93%E8%A1%A8%E5%8D%95%E5%9F%BA%E6%9C%AC%E6%A0%A1%E9%AA%8C%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.8.15.</span> <span class="toc-text">15、新增部门–表单基本校验实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#16%E3%80%81%E6%96%B0%E5%A2%9E%E9%83%A8%E9%97%A8%E2%80%93%E8%87%AA%E5%AE%9A%E4%B9%89%E6%A0%A1%E9%AA%8C"><span class="toc-number">1.8.16.</span> <span class="toc-text">16、新增部门–自定义校验</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#17%E3%80%81%E6%96%B0%E5%A2%9E%E9%83%A8%E9%97%A8%E2%80%93%E8%87%AA%E5%AE%9A%E4%B9%89%E6%A0%A1%E9%AA%8C%E9%97%AE%E9%A2%98"><span class="toc-number">1.8.17.</span> <span class="toc-text">17、新增部门–自定义校验问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#18%E3%80%81%E6%96%B0%E5%A2%9E%E9%83%A8%E9%97%A8%E2%80%93%E5%A1%AB%E5%85%85%E4%B8%8B%E6%8B%89%E6%A1%86"><span class="toc-number">1.8.18.</span> <span class="toc-text">18、新增部门–填充下拉框</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#19%E3%80%81%E6%96%B0%E5%A2%9E%E9%83%A8%E9%97%A8%E2%80%93%E5%AE%8C%E6%88%90%E9%83%A8%E9%97%A8%E6%B7%BB%E5%8A%A0"><span class="toc-number">1.8.19.</span> <span class="toc-text">19、新增部门–完成部门添加</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#20%E3%80%81%E6%96%B0%E5%A2%9E%E9%83%A8%E9%97%A8%E2%80%93%E5%85%B3%E9%97%AD%E6%96%B0%E5%A2%9E%E5%BC%B9%E5%B1%82"><span class="toc-number">1.8.20.</span> <span class="toc-text">20、新增部门–关闭新增弹层</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#21%E3%80%81%E6%96%B0%E5%A2%9E%E9%83%A8%E9%97%A8%E2%80%93%E9%87%8D%E7%BD%AE%E7%8A%B6%E6%80%81"><span class="toc-number">1.8.21.</span> <span class="toc-text">21、新增部门–重置状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#22%E3%80%81%E7%BC%96%E8%BE%91%E9%83%A8%E9%97%A8%E2%80%93%E5%BC%B9%E5%87%BA%E7%BC%96%E8%BE%91%E7%AA%97%E5%8F%A3"><span class="toc-number">1.8.22.</span> <span class="toc-text">22、编辑部门–弹出编辑窗口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#23%E3%80%81%E7%BC%96%E8%BE%91%E9%83%A8%E9%97%A8%E2%80%93%E5%B1%95%E7%A4%BA%E7%BC%96%E8%BE%91%E9%83%A8%E9%97%A8%E4%BF%A1%E6%81%AF"><span class="toc-number">1.8.23.</span> <span class="toc-text">23、编辑部门–展示编辑部门信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#24%E3%80%81%E7%BC%96%E8%BE%91%E9%83%A8%E9%97%A8%E2%80%93%E5%88%87%E6%8D%A2%E6%A0%87%E9%A2%98"><span class="toc-number">1.8.24.</span> <span class="toc-text">24、编辑部门–切换标题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#25%E3%80%81%E7%BC%96%E8%BE%91%E9%83%A8%E9%97%A8%E2%80%93%E5%AE%8C%E6%88%90%E7%BC%96%E8%BE%91"><span class="toc-number">1.8.25.</span> <span class="toc-text">25、编辑部门–完成编辑</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97"><span class="toc-number">1.9.</span> <span class="toc-text">六、员工管理模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E5%88%9B%E5%BB%BA%E9%80%9A%E7%94%A8%E5%B7%A5%E5%85%B7%E6%A0%8F%E7%BB%84%E4%BB%B6"><span class="toc-number">1.9.1.</span> <span class="toc-text">1、创建通用工具栏组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E5%AE%8C%E6%88%90%E5%85%AC%E5%85%B1%E7%BB%84%E4%BB%B6%E5%85%A8%E5%B1%80%E6%B3%A8%E5%86%8C"><span class="toc-number">1.9.2.</span> <span class="toc-text">2、完成公共组件全局注册</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E5%91%98%E5%B7%A5%E5%88%97%E8%A1%A8%E9%A1%B5%E9%9D%A2%E5%9F%BA%E6%9C%AC%E5%B8%83%E5%B1%80"><span class="toc-number">1.9.3.</span> <span class="toc-text">3、员工列表页面基本布局</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E5%91%98%E5%B7%A5%E5%88%97%E8%A1%A8%E6%95%B0%E6%8D%AE%E8%AF%B7%E6%B1%82%E5%92%8C%E5%88%86%E9%A1%B5%E5%8A%A0%E8%BD%BD"><span class="toc-number">1.9.4.</span> <span class="toc-text">4、员工列表数据请求和分页加载</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.9.4.1.</span> <span class="toc-text">4.1 服务端接口设计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2%E5%89%8D%E7%AB%AF%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.9.4.2.</span> <span class="toc-text">4.2前端实现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F%E5%A4%84%E7%90%86"><span class="toc-number">1.9.5.</span> <span class="toc-text">5、数据格式处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81%E6%96%B0%E5%BB%BA%E5%91%98%E5%B7%A5%E5%BC%B9%E5%87%BA%E5%B1%82%E7%BB%84%E4%BB%B6"><span class="toc-number">1.9.6.</span> <span class="toc-text">6、新建员工弹出层组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7%E3%80%81%E6%8E%A7%E5%88%B6%E5%BC%B9%E5%87%BA%E5%B1%82%E6%98%BE%E7%A4%BA"><span class="toc-number">1.9.7.</span> <span class="toc-text">7、控制弹出层显示</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8%E3%80%81%E6%96%B0%E5%A2%9E%E5%91%98%E5%B7%A5%E8%A1%A8%E5%8D%95%E6%A0%A1%E9%AA%8C"><span class="toc-number">1.9.8.</span> <span class="toc-text">8、新增员工表单校验</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9%E3%80%81%E5%8A%A0%E8%BD%BD%E9%83%A8%E9%97%A8%E6%95%B0%E6%8D%AE"><span class="toc-number">1.9.9.</span> <span class="toc-text">9、加载部门数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10%E3%80%81%E9%80%89%E6%8B%A9%E9%83%A8%E9%97%A8"><span class="toc-number">1.9.10.</span> <span class="toc-text">10、选择部门</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11%E3%80%81%E5%AE%8C%E6%88%90%E6%96%B0%E5%A2%9E%E5%91%98%E5%B7%A5"><span class="toc-number">1.9.11.</span> <span class="toc-text">11、完成新增员工</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#11-1-%E5%89%8D%E7%AB%AF%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.9.11.1.</span> <span class="toc-text">11.1 前端实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#11-2-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%8E%A5%E5%8F%A3%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.9.11.2.</span> <span class="toc-text">11.2 服务端接口实现</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E8%A7%92%E8%89%B2%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97"><span class="toc-number">1.10.</span> <span class="toc-text">七、角色管理模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFRBAC"><span class="toc-number">1.10.1.</span> <span class="toc-text">什么是RBAC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E5%88%9B%E5%BB%BA%E8%A7%92%E8%89%B2%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.10.2.</span> <span class="toc-text">1、创建角色模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E5%89%8D%E7%AB%AF%E8%A7%92%E8%89%B2%E5%88%97%E8%A1%A8%E5%B8%83%E5%B1%80%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.10.3.</span> <span class="toc-text">2、前端角色列表布局实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E8%A7%92%E8%89%B2%E5%88%97%E8%A1%A8%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="toc-number">1.10.4.</span> <span class="toc-text">3、角色列表接口定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E5%89%8D%E7%AB%AF%E8%A7%92%E8%89%B2%E4%BF%A1%E6%81%AF%E5%B1%95%E7%A4%BA"><span class="toc-number">1.10.5.</span> <span class="toc-text">4、前端角色信息展示</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81%E4%B8%BA%E7%94%A8%E6%88%B7%E5%88%86%E9%85%8D%E8%A7%92%E8%89%B2"><span class="toc-number">1.10.6.</span> <span class="toc-text">5、为用户分配角色</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E5%B7%B2%E7%BB%8F%E5%85%B7%E6%9C%89%E8%A7%92%E8%89%B2%E6%8E%A5%E5%8F%A3%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.10.6.1.</span> <span class="toc-text">5.1  获取用户已经具有角色接口实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-%E5%B1%95%E7%A4%BA%E7%94%A8%E6%88%B7%E5%85%B7%E6%9C%89%E7%9A%84%E8%A7%92%E8%89%B2-%E5%89%8D%E7%AB%AF%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.10.6.2.</span> <span class="toc-text">5.2  展示用户具有的角色-前端实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-%E5%AE%8C%E6%88%90%E8%A7%92%E8%89%B2%E5%88%86%E9%85%8D"><span class="toc-number">1.10.6.3.</span> <span class="toc-text">5.3 完成角色分配</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#5-3-1-%E5%89%8D%E7%AB%AF%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.10.6.3.1.</span> <span class="toc-text">5.3.1 前端实现</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-3-2%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%8E%A5%E5%8F%A3%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.10.6.3.2.</span> <span class="toc-text">5.3.2服务端接口实现</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB%E3%80%81%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97"><span class="toc-number">1.11.</span> <span class="toc-text">八、权限管理模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E5%88%9B%E5%BB%BA%E6%9D%83%E9%99%90%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.11.1.</span> <span class="toc-text">1、创建权限模型</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1-%E5%9F%BA%E7%A1%80%E6%A8%A1%E5%9E%8B%E5%88%9B%E5%BB%BA"><span class="toc-number">1.11.1.0.1.</span> <span class="toc-text">1.1 基础模型创建</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-%E9%85%8D%E7%BD%AE%E6%9D%83%E9%99%90%E6%A8%A1%E5%9E%8B%E5%85%B3%E7%B3%BB"><span class="toc-number">1.11.1.0.2.</span> <span class="toc-text">1.2 配置权限模型关系</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E6%B7%BB%E5%8A%A0%E6%9D%83%E9%99%90"><span class="toc-number">1.11.2.</span> <span class="toc-text">2、添加权限</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E6%B7%BB%E5%8A%A0%E6%9D%83%E9%99%90%E6%8E%A5%E5%8F%A3%E5%88%9B%E5%BB%BA"><span class="toc-number">1.11.2.1.</span> <span class="toc-text">2.1   添加权限接口创建</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E6%9D%83%E9%99%90%E5%88%97%E8%A1%A8"><span class="toc-number">1.11.3.</span> <span class="toc-text">3、权限列表</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-%E6%9D%83%E9%99%90%E5%88%97%E8%A1%A8%E6%8E%A5%E5%8F%A3%E5%88%9B%E5%BB%BA"><span class="toc-number">1.11.3.1.</span> <span class="toc-text">3.1  权限列表接口创建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-%E6%9D%83%E9%99%90%E5%88%97%E8%A1%A8%E5%89%8D%E7%AB%AF%E5%B1%95%E7%A4%BA"><span class="toc-number">1.11.3.2.</span> <span class="toc-text">3.2  权限列表前端展示</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E5%88%9B%E5%BB%BA%E6%B7%BB%E5%8A%A0%E6%9D%83%E9%99%90%E7%9A%84%E7%AA%97%E5%8F%A3"><span class="toc-number">1.11.4.</span> <span class="toc-text">4、创建添加权限的窗口</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-%E5%9F%BA%E7%A1%80%E8%A1%A8%E5%8D%95%E5%88%9B%E5%BB%BA"><span class="toc-number">1.11.4.1.</span> <span class="toc-text">4.1  基础表单创建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-%E5%AE%8C%E6%88%90%E6%9D%83%E9%99%90%E7%9A%84%E6%B7%BB%E5%8A%A0"><span class="toc-number">1.11.4.2.</span> <span class="toc-text">4.2  完成权限的添加</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81%E4%B8%BA%E8%A7%92%E8%89%B2%E5%88%86%E9%85%8D%E6%9D%83%E9%99%90"><span class="toc-number">1.11.5.</span> <span class="toc-text">5、为角色分配权限</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-%E5%B1%95%E7%A4%BA%E5%88%86%E9%85%8D%E6%9D%83%E9%99%90%E7%9A%84%E7%AA%97%E5%8F%A3"><span class="toc-number">1.11.5.1.</span> <span class="toc-text">5.1 展示分配权限的窗口</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-%E4%B8%BA%E8%A7%92%E8%89%B2%E5%88%86%E9%85%8D%E6%9D%83%E9%99%90%E5%89%8D%E7%AB%AF%E5%A4%84%E7%90%861"><span class="toc-number">1.11.5.2.</span> <span class="toc-text">5.2 为角色分配权限前端处理1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-%E5%AE%9E%E7%8E%B0%E8%8E%B7%E5%8F%96%E8%A7%92%E8%89%B2%E5%B7%B2%E7%BB%8F%E5%85%B7%E6%9C%89%E6%9D%83%E9%99%90%E6%8E%A5%E5%8F%A3%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.11.5.3.</span> <span class="toc-text">5.3  实现获取角色已经具有权限接口实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-%E8%A7%92%E8%89%B2%E5%88%86%E9%85%8D%E6%9D%83%E9%99%90%E5%89%8D%E7%AB%AF%E5%A4%84%E7%90%862"><span class="toc-number">1.11.5.4.</span> <span class="toc-text">5.4 角色分配权限前端处理2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-5-%E5%AE%8C%E6%88%90%E8%A7%92%E8%89%B2%E6%9D%83%E9%99%90%E7%9A%84%E5%88%86%E9%85%8D"><span class="toc-number">1.11.5.5.</span> <span class="toc-text">5.5 完成角色权限的分配</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#5-5-2-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%8E%A5%E5%8F%A3%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.11.5.5.1.</span> <span class="toc-text">5.5.2 服务端接口实现</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-5-3-%E5%89%8D%E7%AB%AF%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.11.5.5.2.</span> <span class="toc-text">5.5.3  前端实现</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B9%9D%E3%80%81%E6%9D%83%E9%99%90%E8%BF%87%E6%BB%A4"><span class="toc-number">1.12.</span> <span class="toc-text">九、权限过滤</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81%E5%89%8D%E7%AB%AF%E6%9D%83%E9%99%90%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF"><span class="toc-number">1.12.0.1.</span> <span class="toc-text">1、前端权限实现思路</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81%E9%80%9A%E8%BF%87Vuex%E7%AE%A1%E7%90%86%E6%9D%83%E9%99%90%E6%A8%A1%E5%9D%97"><span class="toc-number">1.12.0.2.</span> <span class="toc-text">2、通过Vuex管理权限模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%E3%80%81Vuex%E7%AD%9B%E9%80%89%E6%9D%83%E9%99%90%E8%B7%AF%E7%94%B1"><span class="toc-number">1.12.0.3.</span> <span class="toc-text">3、Vuex筛选权限路由</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E5%85%B7%E6%9C%89%E7%9A%84%E6%9D%83%E9%99%90%E7%BC%96%E7%A0%81%E2%80%93%E6%8E%A5%E5%8F%A3%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.12.0.3.1.</span> <span class="toc-text">3.1 获取用户具有的权限编码–接口实现</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2-%E5%89%8D%E7%AB%AF%E8%B7%AF%E7%94%B1%E7%AD%9B%E9%80%89%E2%80%94%E2%80%94"><span class="toc-number">1.12.0.3.2.</span> <span class="toc-text">3.2 前端路由筛选——-</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E5%9C%A8%E6%9D%83%E9%99%90%E6%8B%A6%E6%88%AA%E5%A4%84%E8%B0%83%E7%94%A8%E7%AD%9B%E9%80%89%E6%9D%83%E9%99%90%E7%9A%84Action"><span class="toc-number">1.12.1.</span> <span class="toc-text">4、在权限拦截处调用筛选权限的Action</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81%E9%9D%99%E6%80%81%E8%B7%AF%E7%94%B1%E4%B8%8E%E5%8A%A8%E6%80%81%E8%B7%AF%E7%94%B1%E8%A7%A3%E9%99%A4%E5%90%88%E5%B9%B6"><span class="toc-number">1.12.2.</span> <span class="toc-text">5、静态路由与动态路由解除合并</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81%E9%80%80%E5%87%BA%E7%99%BB%E5%BD%95%E9%87%8D%E7%BD%AE%E8%B7%AF%E7%94%B1%E6%9D%83%E9%99%90%E4%B8%8E404%E9%97%AE%E9%A2%98"><span class="toc-number">1.12.3.</span> <span class="toc-text">6、退出登录重置路由权限与404问题</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#6-1-%E9%80%80%E5%87%BA%E7%99%BB%E5%BD%95%E9%87%8D%E7%BD%AE%E8%B7%AF%E7%94%B1"><span class="toc-number">1.12.3.0.1.</span> <span class="toc-text">6.1  退出登录重置路由</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-2-%E8%A7%A3%E5%86%B3404%E9%97%AE%E9%A2%98"><span class="toc-number">1.12.3.0.2.</span> <span class="toc-text">6.2  解决404问题</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7%E3%80%81%E5%8A%9F%E8%83%BD%E6%9D%83%E9%99%90%E5%88%A4%E6%96%AD"><span class="toc-number">1.12.4.</span> <span class="toc-text">7、功能权限判断</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8%E3%80%81api%E6%9D%83%E9%99%90%E6%A0%A1%E9%AA%8C"><span class="toc-number">1.12.5.</span> <span class="toc-text">8、api权限校验</span></a></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2025 By kilgour</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">2</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --><script data-pjax>
  function butterfly_footer_beautify_injector_config(){
    var parent_div_git = document.getElementById('footer-wrap');
    var item_html = '<div id="workboard"></div>';
    console.log('已挂载butterfly_footer_beautify')
    parent_div_git.insertAdjacentHTML("beforeend",item_html)
    }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_footer_beautify_injector_config();
  }
  else if (epage === cpage){
    butterfly_footer_beautify_injector_config();
  }
  </script><script async src="/js/runtime.js"></script><!-- hexo injector body_end end --></body></html>